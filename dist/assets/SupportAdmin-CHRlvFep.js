import{d as p,u as ne,b as le,j as e}from"./index-FuU3jBZc.js";import{r}from"./vendor-react-C_wfuX_s.js";import{k as E,j as ie,u as H,z as h,q as Y,F as Z,m as D,n as ee,y as se,x as de}from"./vendor-firebase-Co4MdP0H.js";import{P as v}from"./index-D6ulfRl4.js";import{L as U,H as ce,v as oe,ag as _,e as xe,f as ue,K as me,U as B,S as ge,T as pe,aR as he,aN as be,aI as te}from"./vendor-icons-Dyg7S3Xx.js";async function fe(o,i,b,I,n){var C,S,k,R;const t=E(p,i==="restaurant"?"restaurants":"couriers",o),w=await ie(t);if(!w.exists())return{success:!1,newPoints:0,isSuspended:!1,isWarning:!1,message:"المستخدم غير موجود"};const f=w.data(),O=((C=f.points)==null?void 0:C.currentPoints)??v.STARTING_POINTS,M=((S=f.points)==null?void 0:S.totalDeductions)??0,L=((k=f.points)==null?void 0:k.warningCount)??0,N=((R=f.points)==null?void 0:R.pointsHistory)??[],d=Math.max(0,O-b),y={id:`deduct_${Date.now()}`,type:"deduction",amount:-b,reason:I,orderId:n==null?void 0:n.orderId,ticketId:n==null?void 0:n.ticketId,adminId:n==null?void 0:n.adminId,createdAt:new Date},x=d<v.SUSPENSION_THRESHOLD,j=!x&&d<v.WARNING_THRESHOLD,c={"points.currentPoints":d,"points.totalDeductions":M+b,"points.pointsHistory":[...N,y],updatedAt:h()};x&&(c["points.isSuspended"]=!0,c["points.suspendedAt"]=h(),c["points.suspendedReason"]=`إيقاف تلقائي - النقاط أقل من ${v.SUSPENSION_THRESHOLD}`,c.isOpen=!1,c.isAvailable=!1),j&&(c["points.warningCount"]=L+1,c["points.lastWarningAt"]=h()),await H(t,c);let u=`تم خصم ${b} نقطة. النقاط الحالية: ${d}`;return x?u=`⛔ تم إيقاف الحساب تلقائياً! النقاط وصلت إلى ${d}`:j&&(u=`⚠️ تنبيه! النقاط منخفضة: ${d}. قد يتم الإيقاف عند ${v.SUSPENSION_THRESHOLD}`),{success:!0,newPoints:d,isSuspended:x,isWarning:j,message:u}}const ye={waiting:{label:"جديدة",color:"amber",icon:me},active:{label:"نشطة",color:"green",icon:_},resolved:{label:"محلولة",color:"blue",icon:ue},closed:{label:"مغلقة",color:"gray",icon:xe}},ke=()=>{const{user:o}=ne(),i=le(),b=r.useRef(null),I=r.useRef(null),[n,F]=r.useState([]),[t,w]=r.useState(null),[f,O]=r.useState([]),[M,L]=r.useState(!0),[N,d]=r.useState(!1),[y,x]=r.useState(""),[j,c]=r.useState("all"),[u,C]=r.useState("");r.useEffect(()=>{const s=Y(D(p,"supportChats"),Z("lastMessageAt","desc")),a=ee(s,l=>{const m=l.docs.map(g=>({id:g.id,...g.data()}));F(m),L(!1)});return()=>a()},[]),r.useEffect(()=>{if(!(t!=null&&t.id))return;const s=Y(D(p,"supportChats",t.id,"messages"),Z("createdAt","asc")),a=ee(s,l=>{const m=l.docs.map(g=>({id:g.id,...g.data()}));O(m),t.unreadBySupport&&t.unreadBySupport>0&&H(E(p,"supportChats",t.id),{unreadBySupport:0})});return setTimeout(()=>{var l;return(l=I.current)==null?void 0:l.focus()},100),()=>a()},[t==null?void 0:t.id]),r.useEffect(()=>{var s;(s=b.current)==null||s.scrollIntoView({behavior:"smooth"})},[f]);const S=async()=>{if(!(!y.trim()||!(t!=null&&t.id)||N)){d(!0);try{await se(D(p,"supportChats",t.id,"messages"),{chatId:t.id,senderId:o==null?void 0:o.uid,senderName:"فريق الدعم",senderRole:"support",message:y.trim(),createdAt:h()}),await H(E(p,"supportChats",t.id),{status:"active",lastMessage:y.trim(),lastMessageAt:h(),updatedAt:h(),unreadByUser:de(1)}),x(""),i.success("تم إرسال الرد")}catch{i.error("فشل إرسال الرد")}finally{d(!1)}}},k=async s=>{t!=null&&t.id&&(await H(E(p,"supportChats",t.id),{status:s,updatedAt:h()}),w({...t,status:s}),i.success("تم تحديث الحالة"))},[R,T]=r.useState(!1),[W,G]=r.useState("restaurant"),[A,ae]=r.useState(""),[q,z]=r.useState(""),[P,K]=r.useState(10),[$,Q]=r.useState(""),[V,X]=r.useState(!1),re=async()=>{if(!A||!$||P<=0){i.error("يرجى ملء جميع البيانات");return}X(!0);try{const s=await fe(A,W,P,$,{ticketId:t==null?void 0:t.id,adminId:o==null?void 0:o.uid});s.success?(t!=null&&t.id&&await se(D(p,"supportChats",t.id,"messages"),{chatId:t.id,senderId:"system",senderName:"النظام",senderRole:"bot",message:`✅ تم تأكيد الشكوى وخصم ${P} نقطة من ${W==="restaurant"?"الأسرة":"المندوب"}.

${s.isSuspended?"⛔ تم إيقاف الحساب تلقائياً!":s.isWarning?"⚠️ تنبيه: النقاط منخفضة!":""}`,createdAt:h()}),i.success(s.message),s.isSuspended&&i.error("⛔ تم إيقاف الحساب تلقائياً!"),T(!1),Q(""),K(10)):i.error(s.message)}catch{i.error("حدث خطأ في خصم النقاط")}finally{X(!1)}},J=n.filter(s=>{var a;return!(j==="waiting"&&s.status!=="waiting"||j==="active"&&s.status!=="active"||u&&!s.userName.includes(u)&&!((a=s.subject)!=null&&a.includes(u)))});return M?e.jsx("div",{className:"flex items-center justify-center min-h-[60vh]",children:e.jsx(U,{className:"w-8 h-8 animate-spin text-sky-500"})}):e.jsxs("div",{className:"max-w-6xl mx-auto",children:[e.jsxs("h1",{className:"text-2xl font-bold text-gray-800 mb-6 flex items-center gap-3",children:[e.jsx(ce,{className:"w-8 h-8 text-sky-500"}),"إدارة الدعم الفني"]}),e.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-3 gap-6",children:[e.jsxs("div",{className:"lg:col-span-1 bg-white rounded-2xl shadow-lg overflow-hidden",children:[e.jsxs("div",{className:"p-4 border-b border-gray-100 space-y-3",children:[e.jsxs("div",{className:"relative",children:[e.jsx(oe,{className:"w-5 h-5 text-gray-400 absolute right-3 top-1/2 -translate-y-1/2"}),e.jsx("input",{type:"text",value:u,onChange:s=>C(s.target.value),placeholder:"بحث...",className:"w-full pr-10 pl-4 py-2 bg-gray-100 rounded-xl focus:outline-none focus:ring-2 focus:ring-sky-300"})]}),e.jsx("div",{className:"flex gap-2",children:["all","waiting","active"].map(s=>e.jsxs("button",{onClick:()=>c(s),className:`px-3 py-1 rounded-lg text-sm font-medium transition ${j===s?"bg-sky-100 text-sky-700":"text-gray-500 hover:bg-gray-100"}`,children:[s==="all"?"الكل":s==="waiting"?"جديدة":"نشطة",s==="waiting"&&e.jsx("span",{className:"mr-1 px-1.5 py-0.5 bg-amber-500 text-white rounded-full text-xs",children:n.filter(a=>a.status==="waiting").length})]},s))})]}),e.jsx("div",{className:"max-h-[500px] overflow-y-auto divide-y divide-gray-100",children:J.length===0?e.jsxs("div",{className:"p-8 text-center text-gray-500",children:[e.jsx(_,{className:"w-12 h-12 mx-auto mb-2 opacity-30"}),e.jsx("p",{children:"لا توجد محادثات"})]}):J.map(s=>{var m,g;const a=ye[s.status],l=a.icon;return e.jsxs("button",{onClick:()=>w(s),className:`w-full p-4 text-right hover:bg-gray-50 transition ${(t==null?void 0:t.id)===s.id?"bg-sky-50":""}`,children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(B,{className:"w-5 h-5 text-gray-400"}),e.jsx("span",{className:"font-bold text-gray-800",children:s.userName})]}),s.unreadBySupport?e.jsx("span",{className:"px-2 py-0.5 bg-red-500 text-white text-xs rounded-full",children:s.unreadBySupport}):null]}),e.jsx("p",{className:"text-sm text-gray-500 truncate mb-2",children:s.lastMessage||s.subject}),e.jsxs("div",{className:"flex items-center justify-between text-xs",children:[e.jsxs("span",{className:`inline-flex items-center gap-1 px-2 py-0.5 rounded-full
                        ${a.color==="amber"?"bg-amber-100 text-amber-700":""}
                        ${a.color==="green"?"bg-green-100 text-green-700":""}
                        ${a.color==="blue"?"bg-blue-100 text-blue-700":""}
                        ${a.color==="gray"?"bg-gray-100 text-gray-700":""}
                      `,children:[e.jsx(l,{className:"w-3 h-3"}),a.label]}),e.jsx("span",{className:"text-gray-400",children:((g=(m=s.lastMessageAt)==null?void 0:m.toDate)==null?void 0:g.call(m).toLocaleTimeString("ar-SA",{hour:"2-digit",minute:"2-digit"}))||""})]})]},s.id)})})]}),e.jsx("div",{className:"lg:col-span-2 bg-white rounded-2xl shadow-lg overflow-hidden flex flex-col",style:{minHeight:"600px"},children:t?e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"p-4 border-b border-gray-100 bg-gray-50",children:[e.jsxs("div",{className:"flex items-center justify-between mb-3",children:[e.jsxs("div",{children:[e.jsxs("h3",{className:"font-bold text-gray-800 flex items-center gap-2",children:[e.jsx(B,{className:"w-5 h-5"}),t.userName]}),e.jsx("p",{className:"text-sm text-gray-500",children:t.subject})]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx("button",{onClick:()=>k("resolved"),className:"px-3 py-1.5 bg-green-100 text-green-700 rounded-lg text-sm font-medium hover:bg-green-200 transition",children:"✅ تم الحل"}),e.jsx("button",{onClick:()=>k("closed"),className:"px-3 py-1.5 bg-gray-100 text-gray-700 rounded-lg text-sm font-medium hover:bg-gray-200 transition",children:"إغلاق"})]})]}),e.jsxs("div",{className:"flex gap-2 pt-3 border-t border-gray-200",children:[e.jsxs("button",{onClick:()=>{G("restaurant"),z("الأسرة"),T(!0)},className:"flex items-center gap-2 px-3 py-2 bg-red-100 text-red-700 rounded-lg text-sm font-medium hover:bg-red-200 transition",children:[e.jsx(ge,{className:"w-4 h-4"}),"خصم من الأسرة ⛔"]}),e.jsxs("button",{onClick:()=>{G("courier"),z("المندوب"),T(!0)},className:"flex items-center gap-2 px-3 py-2 bg-orange-100 text-orange-700 rounded-lg text-sm font-medium hover:bg-orange-200 transition",children:[e.jsx(pe,{className:"w-4 h-4"}),"خصم من المندوب ⛔"]})]})]}),e.jsxs("div",{className:"flex-1 overflow-y-auto p-4 space-y-4 bg-gray-50",children:[f.map(s=>{var a,l;return e.jsx("div",{className:`flex ${s.senderRole==="support"?"justify-end":"justify-start"}`,children:e.jsxs("div",{className:"max-w-[80%]",children:[s.senderRole!=="support"&&e.jsxs("div",{className:"flex items-center gap-2 mb-1",children:[e.jsx("div",{className:`w-6 h-6 rounded-full flex items-center justify-center ${s.senderRole==="bot"?"bg-purple-100":"bg-gray-200"}`,children:s.senderRole==="bot"?e.jsx(he,{className:"w-4 h-4 text-purple-600"}):e.jsx(B,{className:"w-4 h-4 text-gray-600"})}),e.jsx("span",{className:"text-xs text-gray-500",children:s.senderName})]}),e.jsx("div",{className:`rounded-2xl px-4 py-3 ${s.senderRole==="support"?"bg-sky-500 text-white rounded-bl-md":s.senderRole==="bot"?"bg-purple-50 text-gray-800 border border-purple-100 rounded-br-md":"bg-white text-gray-800 border border-gray-200 rounded-br-md"}`,children:e.jsx("p",{className:"whitespace-pre-wrap text-sm",children:s.message})}),e.jsx("p",{className:`text-xs text-gray-400 mt-1 ${s.senderRole==="support"?"text-left":"text-right"}`,children:((l=(a=s.createdAt)==null?void 0:a.toDate)==null?void 0:l.call(a).toLocaleTimeString("ar-SA",{hour:"2-digit",minute:"2-digit"}))||""})]})},s.id)}),e.jsx("div",{ref:b})]}),e.jsxs("div",{className:"p-4 border-t border-gray-100",children:[e.jsxs("div",{className:"flex gap-3",children:[e.jsx("input",{ref:I,type:"text",value:y,onChange:s=>x(s.target.value),onKeyPress:s=>s.key==="Enter"&&S(),placeholder:"اكتب ردك هنا...",className:"flex-1 px-4 py-3 bg-gray-100 rounded-xl focus:outline-none focus:ring-2 focus:ring-sky-300",disabled:N}),e.jsx("button",{onClick:S,disabled:!y.trim()||N,className:"px-6 py-3 bg-sky-500 hover:bg-sky-600 text-white rounded-xl font-medium transition disabled:opacity-50",children:N?e.jsx(U,{className:"w-5 h-5 animate-spin"}):e.jsx(be,{className:"w-5 h-5"})})]}),e.jsx("div",{className:"flex gap-2 mt-3 flex-wrap",children:["شكراً لتواصلك معنا","سنتحقق من الموضوع","تم حل المشكلة","يرجى مشاركة المزيد من التفاصيل"].map((s,a)=>e.jsx("button",{onClick:()=>x(s),className:"px-3 py-1.5 bg-gray-100 hover:bg-sky-100 text-gray-600 hover:text-sky-700 rounded-full text-sm transition",children:s},a))})]})]}):e.jsx("div",{className:"flex-1 flex items-center justify-center text-gray-500",children:e.jsxs("div",{className:"text-center",children:[e.jsx(_,{className:"w-16 h-16 mx-auto mb-4 opacity-30"}),e.jsx("p",{children:"اختر محادثة للرد عليها"})]})})})]}),e.jsxs("div",{className:"mt-6 grid grid-cols-2 md:grid-cols-4 gap-4",children:[e.jsxs("div",{className:"bg-amber-50 rounded-xl p-4 text-center",children:[e.jsx("p",{className:"text-3xl font-bold text-amber-600",children:n.filter(s=>s.status==="waiting").length}),e.jsx("p",{className:"text-sm text-amber-700",children:"بانتظار الرد"})]}),e.jsxs("div",{className:"bg-green-50 rounded-xl p-4 text-center",children:[e.jsx("p",{className:"text-3xl font-bold text-green-600",children:n.filter(s=>s.status==="active").length}),e.jsx("p",{className:"text-sm text-green-700",children:"نشطة"})]}),e.jsxs("div",{className:"bg-blue-50 rounded-xl p-4 text-center",children:[e.jsx("p",{className:"text-3xl font-bold text-blue-600",children:n.filter(s=>s.status==="resolved").length}),e.jsx("p",{className:"text-sm text-blue-700",children:"محلولة"})]}),e.jsxs("div",{className:"bg-gray-50 rounded-xl p-4 text-center",children:[e.jsx("p",{className:"text-3xl font-bold text-gray-600",children:n.length}),e.jsx("p",{className:"text-sm text-gray-700",children:"إجمالي"})]})]}),R&&e.jsx("div",{className:"fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4",children:e.jsxs("div",{className:"bg-white rounded-2xl shadow-2xl max-w-md w-full p-6",children:[e.jsxs("div",{className:"flex items-center gap-3 mb-6",children:[e.jsx("div",{className:"w-12 h-12 bg-red-100 rounded-full flex items-center justify-center",children:e.jsx(te,{className:"w-6 h-6 text-red-600"})}),e.jsxs("div",{children:[e.jsx("h3",{className:"text-lg font-bold text-gray-800",children:"تأكيد الشكوى وخصم النقاط"}),e.jsxs("p",{className:"text-sm text-gray-500",children:["خصم نقاط من ",q]})]})]}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsxs("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:["معرف ",q," (UID)"]}),e.jsx("input",{type:"text",value:A,onChange:s=>ae(s.target.value),placeholder:"أدخل UID...",className:"w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:border-red-400 focus:outline-none"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"عدد النقاط المخصومة"}),e.jsx("div",{className:"flex gap-2",children:[5,10,15,20].map(s=>e.jsxs("button",{onClick:()=>K(s),className:`flex-1 py-2 rounded-lg font-bold transition ${P===s?"bg-red-500 text-white":"bg-gray-100 text-gray-600 hover:bg-gray-200"}`,children:["-",s]},s))})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"سبب الخصم"}),e.jsxs("select",{value:$,onChange:s=>Q(s.target.value),className:"w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:border-red-400 focus:outline-none",children:[e.jsx("option",{value:"",children:"اختر السبب..."}),e.jsx("option",{value:"جودة الطعام سيئة",children:"جودة الطعام سيئة"}),e.jsx("option",{value:"تأخير في التسليم",children:"تأخير في التسليم"}),e.jsx("option",{value:"سوء الخدمة",children:"سوء الخدمة"}),e.jsx("option",{value:"طلب خاطئ",children:"طلب خاطئ"}),e.jsx("option",{value:"سوء التغليف",children:"سوء التغليف"}),e.jsx("option",{value:"مشكلة نظافة",children:"مشكلة نظافة"}),e.jsx("option",{value:"عدم الحضور",children:"عدم الحضور"}),e.jsx("option",{value:"سوء التعامل",children:"سوء التعامل"}),e.jsx("option",{value:"شكوى أخرى",children:"شكوى أخرى"})]})]}),e.jsx("div",{className:"bg-amber-50 border border-amber-200 rounded-xl p-3",children:e.jsxs("p",{className:"text-sm text-amber-800",children:["⚠️ ",e.jsx("strong",{children:"تنبيه:"})," إذا وصلت النقاط أقل من ",v.SUSPENSION_THRESHOLD," سيتم إيقاف الحساب تلقائياً!"]})}),e.jsxs("div",{className:"flex gap-3 pt-2",children:[e.jsx("button",{onClick:re,disabled:V||!A||!$,className:"flex-1 py-3 bg-red-500 hover:bg-red-600 text-white rounded-xl font-bold transition disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center gap-2",children:V?e.jsx(U,{className:"w-5 h-5 animate-spin"}):e.jsxs(e.Fragment,{children:[e.jsx(te,{className:"w-5 h-5"}),"تأكيد وخصم النقاط"]})}),e.jsx("button",{onClick:()=>T(!1),className:"px-6 py-3 bg-gray-100 hover:bg-gray-200 text-gray-700 rounded-xl font-medium transition",children:"إلغاء"})]})]})]})})]})};export{ke as SupportAdmin,ke as default};
