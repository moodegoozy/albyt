import{u as q,b as B,c as K,d as j,j as e,s as V}from"./index-FuU3jBZc.js";import{r as m,L as W}from"./vendor-react-C_wfuX_s.js";import{q as J,m as D,w as X,t as Y,H as G,K as Q,J as Z,y as ee,z as R,T as te,p as se,k as ae}from"./vendor-firebase-Co4MdP0H.js";import{ac as S,z as w,i as T,Y as re,a2 as le,av as ie,aD as ne,e as U,aA as ce,f as oe,K as de,as as xe,h as me,A as pe}from"./vendor-icons-Dyg7S3Xx.js";const N=5,f=24,ye=()=>{const{user:x}=q(),c=B(),I=K(),[v,O]=m.useState([]),[$,L]=m.useState(!0),[k,g]=m.useState(!1),[y,A]=m.useState(!1),[P,C]=m.useState(0),p=m.useRef(null),[s,o]=m.useState({type:"text",title:"",description:"",mediaFile:null,mediaPreview:""});m.useEffect(()=>{x&&b()},[x]);const b=async()=>{if(x)try{const t=J(D(j,"promotions"),X("ownerId","==",x.uid)),d=(await Y(t)).docs.map(r=>{var l,i,n,h;return{id:r.id,...r.data(),expiresAt:(i=(l=r.data().expiresAt)==null?void 0:l.toDate)==null?void 0:i.call(l),createdAt:(h=(n=r.data().createdAt)==null?void 0:n.toDate)==null?void 0:h.call(n)}});d.sort((r,l)=>{var i,n;return(((i=l.createdAt)==null?void 0:i.getTime())||0)-(((n=r.createdAt)==null?void 0:n.getTime())||0)}),O(d)}catch(t){c.error("خطأ في تحميل الإعلانات"),console.error(t)}finally{L(!1)}},u=t=>t.expiresAt?new Date>new Date(t.expiresAt):!1,_=t=>{var i;const a=(i=t.target.files)==null?void 0:i[0];if(!a)return;const d=a.type.startsWith("image/"),r=a.type.startsWith("video/");if(!d&&!r){c.warning("يرجى اختيار صورة أو فيديو");return}const l=r?50*1024*1024:10*1024*1024;if(a.size>l){c.warning(r?"حجم الفيديو يجب أن يكون أقل من 50 ميجا":"حجم الصورة يجب أن يكون أقل من 10 ميجا");return}o({...s,type:r?"video":"image",mediaFile:a,mediaPreview:URL.createObjectURL(a)})},E=async t=>{if(t.preventDefault(),!!x){if(s.type!=="text"&&!s.mediaFile){c.warning("يرجى اختيار صورة أو فيديو");return}if(!s.title.trim()&&!s.description.trim()&&!s.mediaFile){c.warning("يرجى إضافة محتوى للإعلان");return}try{A(!0);let a="";if(s.mediaFile){const r=s.mediaFile.name.replace(/\s+/g,"_").slice(-60),l=`promotions/${x.uid}_${Date.now()}_${r}`,i=G(V,l),n=Q(i,s.mediaFile);await new Promise((h,H)=>{n.on("state_changed",F=>{const M=Math.round(F.bytesTransferred/F.totalBytes*100);C(M)},H,async()=>{a=await Z(n.snapshot.ref),h()})})}const d=new Date;d.setHours(d.getHours()+f),await ee(D(j,"promotions"),{ownerId:x.uid,restaurantId:x.uid,type:s.type,title:s.title.trim(),description:s.description.trim(),mediaUrl:a,isActive:!0,isPaid:!0,price:N,duration:f,viewsCount:0,expiresAt:te.fromDate(d),createdAt:R(),updatedAt:R()}),c.success(`تم نشر إعلانك! ✨ سيظهر لمدة ${f} ساعة`),o({type:"text",title:"",description:"",mediaFile:null,mediaPreview:""}),g(!1),C(0),b()}catch(a){c.error("حدث خطأ في نشر الإعلان"),console.error(a)}finally{A(!1)}}},z=async t=>{if(await I.confirm("هل تريد حذف هذا الإعلان؟",{dangerous:!0}))try{await se(ae(j,"promotions",t)),c.success("تم حذف الإعلان"),b()}catch{c.error("حدث خطأ")}};return $?e.jsxs("div",{className:"flex items-center justify-center h-96",children:[e.jsx(S,{className:"w-6 h-6 animate-spin ml-2"}),"جارِ التحميل..."]}):e.jsxs("div",{className:"max-w-2xl mx-auto py-8 px-4 space-y-6",children:[e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"w-16 h-16 bg-gradient-to-br from-purple-500 to-pink-500 rounded-2xl flex items-center justify-center mx-auto mb-4 shadow-lg",children:e.jsx(w,{className:"w-8 h-8 text-white"})}),e.jsx("h1",{className:"text-2xl font-bold text-gray-800",children:"الإعلانات الممولة"}),e.jsx("p",{className:"text-gray-500 mt-2",children:"أنشئ إعلانك وسيظهر للعملاء في صفحة أسرتك"})]}),e.jsxs("div",{className:"bg-gradient-to-r from-purple-50 to-pink-50 border border-purple-200 rounded-2xl p-4 text-center",children:[e.jsxs("div",{className:"flex items-center justify-center gap-3",children:[e.jsx(T,{className:"w-5 h-5 text-purple-500"}),e.jsxs("span",{className:"text-lg font-bold text-purple-700",children:[N," ر.س فقط لمدة ",f," ساعة"]}),e.jsx(T,{className:"w-5 h-5 text-purple-500"})]}),e.jsx("p",{className:"text-sm text-purple-600 mt-1",children:"أضف صورة أو فيديو أو نص ترويجي لأسرتك"})]}),!k&&e.jsxs("button",{onClick:()=>g(!0),className:"w-full py-4 rounded-2xl bg-gradient-to-r from-purple-500 to-pink-500 text-white font-bold shadow-lg hover:shadow-xl transition flex items-center justify-center gap-3",children:[e.jsx(re,{className:"w-6 h-6"}),"إنشاء إعلان جديد"]}),k&&e.jsxs("form",{onSubmit:E,className:"bg-white rounded-2xl shadow-xl p-6 space-y-4",children:[e.jsx("h2",{className:"font-bold text-lg text-gray-800 mb-4",children:"إنشاء إعلان جديد"}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-semibold text-gray-700 mb-2",children:"نوع الإعلان"}),e.jsxs("div",{className:"grid grid-cols-3 gap-2",children:[e.jsxs("button",{type:"button",onClick:()=>o({...s,type:"text",mediaFile:null,mediaPreview:""}),className:`p-3 rounded-xl border-2 transition flex flex-col items-center gap-1 ${s.type==="text"?"border-purple-500 bg-purple-50":"border-gray-200"}`,children:[e.jsx(le,{className:"w-5 h-5"}),e.jsx("span",{className:"text-sm",children:"نص"})]}),e.jsxs("button",{type:"button",onClick:()=>{var t;o({...s,type:"image"}),(t=p.current)==null||t.click()},className:`p-3 rounded-xl border-2 transition flex flex-col items-center gap-1 ${s.type==="image"?"border-purple-500 bg-purple-50":"border-gray-200"}`,children:[e.jsx(ie,{className:"w-5 h-5"}),e.jsx("span",{className:"text-sm",children:"صورة"})]}),e.jsxs("button",{type:"button",onClick:()=>{var t;o({...s,type:"video"}),(t=p.current)==null||t.click()},className:`p-3 rounded-xl border-2 transition flex flex-col items-center gap-1 ${s.type==="video"?"border-purple-500 bg-purple-50":"border-gray-200"}`,children:[e.jsx(ne,{className:"w-5 h-5"}),e.jsx("span",{className:"text-sm",children:"فيديو"})]})]})]}),e.jsx("input",{type:"file",ref:p,accept:"image/*,video/*",onChange:_,className:"hidden"}),s.mediaPreview&&e.jsxs("div",{className:"relative",children:[s.type==="video"?e.jsx("video",{src:s.mediaPreview,controls:!0,className:"w-full h-48 object-cover rounded-xl"}):e.jsx("img",{src:s.mediaPreview,alt:"معاينة",className:"w-full h-48 object-cover rounded-xl"}),e.jsx("button",{type:"button",onClick:()=>o({...s,mediaFile:null,mediaPreview:"",type:"text"}),className:"absolute top-2 left-2 p-2 bg-red-500 text-white rounded-full",children:e.jsx(U,{className:"w-4 h-4"})})]}),s.type!=="text"&&!s.mediaPreview&&e.jsxs("button",{type:"button",onClick:()=>{var t;return(t=p.current)==null?void 0:t.click()},className:"w-full py-4 border-2 border-dashed border-gray-300 rounded-xl text-gray-500 hover:border-purple-400 transition flex items-center justify-center gap-2",children:[e.jsx(ce,{className:"w-5 h-5"}),"اختر ",s.type==="video"?"فيديو":"صورة"]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-semibold text-gray-700 mb-1",children:"العنوان (اختياري)"}),e.jsx("input",{type:"text",value:s.title,onChange:t=>o({...s,title:t.target.value}),placeholder:"مثال: عرض خاص اليوم!",className:"w-full border-2 border-gray-200 rounded-xl p-3 focus:border-purple-400 focus:outline-none"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-semibold text-gray-700 mb-1",children:"الشرح أو الوصف"}),e.jsx("textarea",{value:s.description,onChange:t=>o({...s,description:t.target.value}),placeholder:"اكتب تفاصيل إعلانك هنا...",rows:3,className:"w-full border-2 border-gray-200 rounded-xl p-3 focus:border-purple-400 focus:outline-none"})]}),y&&P>0&&e.jsx("div",{className:"bg-gray-200 rounded-full h-2 overflow-hidden",children:e.jsx("div",{className:"bg-purple-500 h-full transition-all",style:{width:`${P}%`}})}),e.jsxs("div",{className:"flex gap-3",children:[e.jsx("button",{type:"submit",disabled:y,className:"flex-1 py-3 rounded-xl bg-gradient-to-r from-purple-500 to-pink-500 text-white font-bold disabled:opacity-50 flex items-center justify-center gap-2",children:y?e.jsxs(e.Fragment,{children:[e.jsx(S,{className:"w-5 h-5 animate-spin"}),"جارِ النشر..."]}):e.jsxs(e.Fragment,{children:[e.jsx(w,{className:"w-5 h-5"}),"نشر الإعلان (",N," ر.س)"]})}),e.jsx("button",{type:"button",onClick:()=>{g(!1),o({type:"text",title:"",description:"",mediaFile:null,mediaPreview:""})},className:"px-4 py-3 rounded-xl border-2 border-gray-200 text-gray-600 font-medium",children:"إلغاء"})]})]}),e.jsxs("div",{className:"space-y-4",children:[e.jsx("h2",{className:"font-bold text-lg text-gray-800",children:"إعلاناتك"}),v.length===0?e.jsxs("div",{className:"text-center py-10 text-gray-400",children:[e.jsx(w,{className:"w-12 h-12 mx-auto mb-3 opacity-50"}),e.jsx("p",{children:"لم تنشئ أي إعلانات بعد"})]}):v.map(t=>e.jsxs("div",{className:`bg-white rounded-2xl shadow-lg overflow-hidden ${u(t)?"opacity-60":""}`,children:[t.mediaUrl&&(t.type==="video"?e.jsx("video",{src:t.mediaUrl,controls:!0,className:"w-full h-48 object-cover"}):e.jsx("img",{src:t.mediaUrl,alt:t.title,className:"w-full h-48 object-cover"})),e.jsxs("div",{className:"p-4",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-2",children:[u(t)?e.jsxs("span",{className:"inline-flex items-center gap-1 px-2 py-1 bg-gray-100 text-gray-500 text-xs font-medium rounded-full",children:[e.jsx(U,{className:"w-3 h-3"})," منتهي"]}):t.isActive?e.jsxs("span",{className:"inline-flex items-center gap-1 px-2 py-1 bg-green-100 text-green-600 text-xs font-medium rounded-full",children:[e.jsx(oe,{className:"w-3 h-3"})," نشط"]}):e.jsxs("span",{className:"inline-flex items-center gap-1 px-2 py-1 bg-yellow-100 text-yellow-600 text-xs font-medium rounded-full",children:[e.jsx(de,{className:"w-3 h-3"})," في الانتظار"]}),e.jsxs("span",{className:"inline-flex items-center gap-1 px-2 py-1 bg-purple-100 text-purple-600 text-xs font-medium rounded-full",children:[e.jsx(xe,{className:"w-3 h-3"})," ",t.viewsCount," مشاهدة"]})]}),t.title&&e.jsx("h3",{className:"font-bold text-gray-800",children:t.title}),t.description&&e.jsx("p",{className:"text-gray-600 text-sm mt-1",children:t.description}),e.jsxs("div",{className:"flex items-center justify-between mt-3 pt-3 border-t",children:[e.jsxs("span",{className:"text-xs text-gray-400",children:[t.expiresAt&&!u(t)&&e.jsxs(e.Fragment,{children:["ينتهي: ",new Date(t.expiresAt).toLocaleString("ar-SA")]}),u(t)&&"انتهت صلاحية الإعلان"]}),e.jsx("button",{onClick:()=>z(t.id),className:"p-2 text-red-500 hover:bg-red-50 rounded-lg transition",children:e.jsx(me,{className:"w-4 h-4"})})]})]})]},t.id))]}),e.jsxs(W,{to:"/owner",className:"flex items-center justify-center gap-2 text-sky-600 hover:text-sky-700 py-4",children:[e.jsx(pe,{className:"w-5 h-5"}),"العودة للوحة التحكم"]})]})};export{ye as PromotionPage};
