سُفرة البيت (Sofra Al-Bayt) — Source Codes Bundle
Generated for IP submission.
NOTE: This bundle excludes standalone HTML/CSS files.


==========================================================================================
FILE: firestore.rules
==========================================================================================
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    function signedIn() {
      return request.auth != null;
    }

    function myRole() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role;
    }

    function isOwner() {
      return signedIn() && myRole() == 'owner';
    }

    function isCourier() {
      return signedIn() && myRole() == 'courier';
    }

    function isCustomer() {
      return signedIn() && myRole() == 'customer';
    }

    function isAdmin() {
      return signedIn() && myRole() == 'admin';
    }

    function isDeveloper() {
      return signedIn() && myRole() == 'developer';
    }

    /* ===== users ===== */
    match /users/{uid} {
      allow read: if isOwner() || isAdmin() || isDeveloper() || (signedIn() && request.auth.uid == uid);
      allow create: if signedIn() && request.auth.uid == uid;
      allow update: if signedIn() && request.auth.uid == uid || isDeveloper();
      allow delete: if isDeveloper();
    }

    /* ===== couriers (ملفات المناديب الشخصية) ===== */
    match /couriers/{courierId} {
      // القراءة: المندوب نفسه أو المطور
      allow read: if isDeveloper() || (isCourier() && request.auth.uid == courierId);
      
      // الإنشاء: المندوب لملفه الشخصي
      allow create: if isCourier() && request.auth.uid == courierId;
      
      // التحديث: المندوب نفسه أو المطور
      allow update: if isDeveloper() || (isCourier() && request.auth.uid == courierId);
      
      // الحذف: المطور فقط
      allow delete: if isDeveloper();
    }

    /* ===== restaurants ===== */
    match /restaurants/{ownerId} {
      allow read: if true;
      allow create: if isOwner() && request.auth.uid == ownerId || isAdmin() || isDeveloper();
      allow update: if isOwner() && request.auth.uid == ownerId || isAdmin() || isDeveloper();
      allow delete: if isDeveloper();
    }

    /* ===== بيانات البنك الحساسة للمطاعم ===== */
    match /restaurants/{ownerId}/private/bankInfo {
      // القراءة: صاحب المطعم فقط أو المطور أو العميل (لإتمام الدفع)
      allow read: if isDeveloper() 
                  || (isOwner() && request.auth.uid == ownerId)
                  || isCustomer();
      // الكتابة: صاحب المطعم فقط أو المطور
      allow create, update: if isDeveloper() || (isOwner() && request.auth.uid == ownerId);
      allow delete: if isDeveloper();
    }

    /* ===== menu ===== */
    match /menuItems/{itemId} {
      allow read: if true;
      allow create: if isOwner() && request.resource.data.ownerId == request.auth.uid || isAdmin() || isDeveloper();
      allow update: if isOwner() 
                    && resource.data.ownerId == request.auth.uid
                    && request.resource.data.ownerId == request.auth.uid
                    || isAdmin()
                    || isDeveloper();
      allow delete: if isDeveloper();
    }

    /* ===== orders ===== */
    match /orders/{orderId} {
      allow read: if isOwner()
                  || (isCourier() && (resource.data.courierId == request.auth.uid || resource.data.status in ['ready', 'out_for_delivery']))
                  || (isCustomer() && resource.data.customerId == request.auth.uid)
                  || isAdmin()
                  || isDeveloper();

      allow create: if (isCustomer() && request.resource.data.customerId == request.auth.uid)
                    || (isAdmin() && request.resource.data.customerId == request.auth.uid);

      allow update: if isOwner()
                    || (isCourier() && resource.data.courierId == request.auth.uid)
                    || isAdmin()
                    || isDeveloper();
      allow delete: if isDeveloper();
    }

    /* ===== wallets (for admins and app) ===== */
    match /wallets/{walletId} {
      // القراءة: المطور أو صاحب المحفظة (المشرف)
      allow read: if isDeveloper() || (isAdmin() && request.auth.uid == walletId);
      
      // الإنشاء: المشرف لمحفظته + المطور + العملاء (لإنشاء محفظة المشرف عند الطلب)
      allow create: if isDeveloper() 
                    || (isAdmin() && request.auth.uid == walletId)
                    || (isCustomer() && walletId != request.auth.uid); // العميل يمكنه إنشاء محفظة المشرف
      
      // التحديث: المطور أو العملاء (لتحديث محفظة المشرف عند الطلب)
      allow update: if isDeveloper() 
                    || (isCustomer() && walletId != request.auth.uid); // العميل يمكنه تحديث محفظة المشرف
      
      allow delete: if isDeveloper();
    }

    /* ===== settings (single doc like settings/general) ===== */
    match /settings/{doc} {
      allow read: if true;
      allow create, update, delete: if isOwner() || isDeveloper();
    }

    /* ===== packageRequests (طلبات الاشتراك في الباقات) ===== */
    match /packageRequests/{requestId} {
      // القراءة: المطور أو صاحب الطلب
      allow read: if isDeveloper() || (isOwner() && resource.data.restaurantId == request.auth.uid);
      
      // الإنشاء: صاحب المطعم فقط
      allow create: if isOwner() && request.resource.data.restaurantId == request.auth.uid;
      
      // التحديث: المطور (لإرسال البنك/القبول/الرفض) أو صاحب المطعم (لإرسال إثبات التحويل)
      allow update: if isDeveloper() 
                    || (isOwner() && resource.data.restaurantId == request.auth.uid);
      
      // الحذف: المطور فقط
      allow delete: if isDeveloper();
    }

    /* ===== tasks (مهام المشرفين) ===== */
    match /tasks/{taskId} {
      // القراءة: المطور أو المشرف المسندة إليه المهمة
      allow read: if isDeveloper() || (isAdmin() && resource.data.assignedTo == request.auth.uid);
      
      // الإنشاء: المطور فقط
      allow create: if isDeveloper();
      
      // التحديث: المطور أو المشرف المسندة إليه المهمة (لتحديث الحالة)
      allow update: if isDeveloper() || (isAdmin() && resource.data.assignedTo == request.auth.uid);
      
      // الحذف: المطور فقط
      allow delete: if isDeveloper();
    }

    /* ===== messages (رسائل المحادثة بين العميل والمندوب/المطعم) ===== */
    match /orders/{orderId}/messages/{messageId} {
      // الحصول على بيانات الطلب
      function getOrder() {
        return get(/databases/$(database)/documents/orders/$(orderId)).data;
      }
      
      // التحقق من أن المستخدم مرتبط بالطلب
      function isOrderParticipant() {
        let order = getOrder();
        return request.auth.uid == order.customerId 
            || request.auth.uid == order.courierId 
            || request.auth.uid == order.restaurantId;
      }
      
      // القراءة: العميل أو المندوب أو صاحب المطعم المرتبطين بالطلب أو المطور
      allow read: if isDeveloper() || (signedIn() && isOrderParticipant());
      
      // الإنشاء: العميل أو المندوب أو صاحب المطعم المرتبطين بالطلب
      allow create: if signedIn() && isOrderParticipant();
      
      // لا يسمح بالتعديل أو الحذف
      allow update, delete: if isDeveloper();
    }

    /* ===== hiringRequests (طلبات توظيف المندوبين) ===== */
    match /hiringRequests/{requestId} {
      // القراءة: المندوب صاحب الطلب أو صاحب المطعم المستهدف أو المطور
      allow read: if isDeveloper() 
                  || (isCourier() && resource.data.courierId == request.auth.uid)
                  || (isOwner() && resource.data.restaurantId == request.auth.uid);
      
      // الإنشاء: المندوب فقط (لإرسال طلب توظيف)
      allow create: if isCourier() && request.resource.data.courierId == request.auth.uid;
      
      // التحديث: صاحب المطعم (للقبول/الرفض) أو المطور
      allow update: if isDeveloper() 
                    || (isOwner() && resource.data.restaurantId == request.auth.uid);
      
      // الحذف: المطور فقط
      allow delete: if isDeveloper();
    }

    /* ===== notifications (إشعارات النظام) ===== */
    match /notifications/{notificationId} {
      // القراءة: المستلم أو المطور
      allow read: if isDeveloper() || (signedIn() && resource.data.recipientId == request.auth.uid);
      
      // الإنشاء: المطور أو أي مستخدم مسجل (لإرسال إشعارات للمطور/المشرف)
      allow create: if signedIn();
      
      // التحديث: المستلم (لتحديث حالة القراءة) أو المطور
      allow update: if isDeveloper() || (signedIn() && resource.data.recipientId == request.auth.uid);
      
      // الحذف: المطور أو المستلم
      allow delete: if isDeveloper() || (signedIn() && resource.data.recipientId == request.auth.uid);
    }

    /* ===== supportTickets (تذاكر الدعم الفني والشكاوى) ===== */
    match /supportTickets/{ticketId} {
      // القراءة: صاحب التذكرة أو المطور
      allow read: if isDeveloper() || (signedIn() && resource.data.userId == request.auth.uid);
      
      // الإنشاء: أي مستخدم مسجل
      allow create: if signedIn() && request.resource.data.userId == request.auth.uid;
      
      // التحديث: المطور فقط (للرد وتغيير الحالة)
      allow update: if isDeveloper();
      
      // الحذف: المطور فقط
      allow delete: if isDeveloper();
    }

    /* ===== supportTickets/messages (رسائل تذاكر الدعم) ===== */
    match /supportTickets/{ticketId}/messages/{messageId} {
      // الحصول على بيانات التذكرة
      function getTicket() {
        return get(/databases/$(database)/documents/supportTickets/$(ticketId)).data;
      }
      
      // القراءة: صاحب التذكرة أو المطور
      allow read: if isDeveloper() || (signedIn() && getTicket().userId == request.auth.uid);
      
      // الإنشاء: صاحب التذكرة أو المطور
      allow create: if signedIn() && (isDeveloper() || getTicket().userId == request.auth.uid);
      
      // لا يسمح بالتعديل أو الحذف
      allow update, delete: if isDeveloper();
    }

    /* ===== supportChats (محادثات الدعم الفني المباشر) ===== */
    match /supportChats/{chatId} {
      // القراءة: صاحب المحادثة أو المطور
      allow read: if isDeveloper() || (signedIn() && resource.data.userId == request.auth.uid);
      
      // الإنشاء: أي مستخدم مسجل
      allow create: if signedIn() && request.resource.data.userId == request.auth.uid;
      
      // التحديث: صاحب المحادثة أو المطور
      allow update: if isDeveloper() || (signedIn() && resource.data.userId == request.auth.uid);
      
      // الحذف: المطور فقط
      allow delete: if isDeveloper();
    }

    /* ===== supportChats/messages (رسائل الدعم المباشر) ===== */
    match /supportChats/{chatId}/messages/{messageId} {
      // الحصول على بيانات المحادثة
      function getChat() {
        return get(/databases/$(database)/documents/supportChats/$(chatId)).data;
      }
      
      // القراءة: صاحب المحادثة أو المطور
      allow read: if isDeveloper() || (signedIn() && getChat().userId == request.auth.uid);
      
      // الإنشاء: صاحب المحادثة أو المطور أو البوت
      allow create: if signedIn() && (isDeveloper() || getChat().userId == request.auth.uid);
      
      // لا يسمح بالتعديل أو الحذف
      allow update, delete: if isDeveloper();
    }

    /* ===== promotions (الإعلانات الممولة للأسر المنتجة) ===== */
    match /promotions/{promotionId} {
      // القراءة: الجميع (لعرض الإعلانات للعملاء)
      allow read: if true;
      
      // الإنشاء: صاحب الأسرة فقط (لإنشاء إعلان)
      allow create: if isOwner() && request.resource.data.ownerId == request.auth.uid;
      
      // التحديث: صاحب الأسرة (لتعديل إعلانه) أو أي مستخدم (لزيادة المشاهدات) أو المطور
      allow update: if isDeveloper() 
                    || (isOwner() && resource.data.ownerId == request.auth.uid)
                    || (signedIn() && request.resource.data.diff(resource.data).affectedKeys().hasOnly(['viewsCount']));
      
      // الحذف: صاحب الأسرة (لحذف إعلانه) أو المطور
      allow delete: if isDeveloper() || (isOwner() && resource.data.ownerId == request.auth.uid);
    }

    /* ===== restaurantStats (إحصائيات المطاعم/الأسر المنتجة) ===== */
    match /restaurantStats/{restaurantId} {
      // القراءة: صاحب المطعم أو المطور
      allow read: if isDeveloper() || (isOwner() && request.auth.uid == restaurantId);
      
      // الإنشاء والتحديث: المطور أو أي مستخدم (لتحديث الإحصائيات عند الزيارة)
      allow create: if signedIn() || isDeveloper();
      allow update: if signedIn() || isDeveloper();
      
      // الحذف: المطور فقط
      allow delete: if isDeveloper();
    }

    /* ===== visitLogs (سجلات الزيارات) ===== */
    match /visitLogs/{logId} {
      // القراءة: صاحب المطعم (زياراته فقط) أو المطور
      allow read: if isDeveloper() || (isOwner() && resource.data.restaurantId == request.auth.uid);
      
      // الإنشاء: أي شخص (لتسجيل الزيارة)
      allow create: if true;
      
      // لا يسمح بالتعديل أو الحذف إلا للمطور
      allow update, delete: if isDeveloper();
    }

    /* ===== customerRegistrations (تسجيلات العملاء عبر روابط الأسر) ===== */
    match /customerRegistrations/{regId} {
      // القراءة: صاحب المطعم (تسجيلاته فقط) أو المطور
      allow read: if isDeveloper() || (isOwner() && resource.data.restaurantId == request.auth.uid);
      
      // الإنشاء: العميل عند التسجيل أو المطور
      allow create: if signedIn() || isDeveloper();
      
      // لا يسمح بالتعديل أو الحذف إلا للمطور
      allow update, delete: if isDeveloper();
    }

    /* ===== storeFollowers (متابعو المتاجر) ===== */
    match /storeFollowers/{followId} {
      // القراءة: صاحب المطعم (متابعيه فقط) أو المتابع نفسه أو المطور
      allow read: if isDeveloper() 
                  || (isOwner() && resource.data.restaurantId == request.auth.uid)
                  || (signedIn() && resource.data.followerId == request.auth.uid);
      
      // الإنشاء: أي مستخدم مسجل
      allow create: if signedIn() && request.resource.data.followerId == request.auth.uid;
      
      // الحذف: المتابع نفسه أو المطور (إلغاء المتابعة)
      allow delete: if isDeveloper() || (signedIn() && resource.data.followerId == request.auth.uid);
      
      // لا يسمح بالتعديل إلا للمطور
      allow update: if isDeveloper();
    }
  }
}



==========================================================================================
FILE: src/firebase.ts
==========================================================================================
// src/firebase.ts
import { initializeApp, getApps, getApp } from "firebase/app"
import { getAuth, indexedDBLocalPersistence, browserLocalPersistence, initializeAuth } from "firebase/auth"
import { getFirestore } from "firebase/firestore"
import { getStorage } from "firebase/storage"

const firebaseConfig = {
  apiKey: "AIzaSyC1iM3g3gGfu23GKLpDRQplBuHidPniFIk",
  authDomain: "albayt-sofra.firebaseapp.com",
  projectId: "albayt-sofra",
  storageBucket: "albayt-sofra.firebasestorage.app",
  messagingSenderId: "895117143740",
  appId: "1:895117143740:web:239cfccc93d101c1f36ab9",
  measurementId: "G-FK3746ERH8",
}

export const app = getApps().length ? getApp() : initializeApp(firebaseConfig)

// ✅ تهيئة Auth مع persistence محلي (IndexedDB أولاً ثم localStorage)
// هذا يضمن حفظ الجلسة حتى بعد إغلاق التطبيق على الجوال
export const auth = getApps().length > 0 
  ? getAuth(app)
  : initializeAuth(app, {
      persistence: [indexedDBLocalPersistence, browserLocalPersistence]
    })

export const db = getFirestore(app)
export const storage = getStorage(app)

==========================================================================================
FILE: src/hooks/useCart.ts
==========================================================================================
import { useCallback, useEffect, useMemo, useState } from 'react'

export type CartItem = {
  id: string
  name: string
  price: number
  qty: number
  ownerId?: string   // ✅ أضفنا خاصية المطعم
}

const KEY = 'broast_cart'

export function useCart() {
  const [items, setItems] = useState<CartItem[]>(() => {
    try {
      const raw = localStorage.getItem(KEY)
      return raw ? JSON.parse(raw) : []
    } catch { 
      return [] 
    }
  })

  useEffect(() => {
    localStorage.setItem(KEY, JSON.stringify(items))
  }, [items])

  // ✅ استخدام useCallback لمنع إعادة إنشاء الدوال في كل render
  const add = useCallback((it: Omit<CartItem, 'qty'>, qty = 1) => {
    setItems(prev => {
      const idx = prev.findIndex(p => p.id === it.id)
      if (idx >= 0) {
        const copy = [...prev]
        copy[idx] = { 
          ...copy[idx], 
          qty: copy[idx].qty + qty,
          ownerId: it.ownerId ?? copy[idx].ownerId  // ✅ نحافظ على ownerId
        }
        return copy
      }
      return [...prev, { ...it, qty }]
    })
  }, [])

  const remove = useCallback((id: string) => 
    setItems(prev => prev.filter(p => p.id !== id)), [])

  const changeQty = useCallback((id: string, qty: number) => 
    setItems(prev => prev.map(p => p.id === id ? { ...p, qty } : p)), [])

  const clear = useCallback(() => setItems([]), [])

  // ✅ استخدام useMemo لحساب المجموع فقط عند تغيير items
  const subtotal = useMemo(() => 
    items.reduce((s, it) => s + it.price * it.qty, 0), [items])

  return { items, add, remove, changeQty, clear, subtotal }
}

==========================================================================================
FILE: src/types/index.ts
==========================================================================================
/**
 * Type definitions for the Broast Al-Qaryah application
 * Centralized types to avoid redundant definitions and ensure consistency
 */

/**
 * Support Ticket - تذكرة دعم فني أو شكوى
 */
export interface SupportTicket {
  id: string;
  ticketNumber: string; // رقم التذكرة (مثل: TKT-2024-001)
  type: 'complaint' | 'support' | 'suggestion' | 'refund'; // نوع التذكرة
  subject: string; // عنوان الشكوى
  description: string; // وصف المشكلة
  // بيانات صاحب التذكرة
  userId: string;
  userName?: string;
  userEmail?: string;
  userPhone?: string;
  userRole: 'customer' | 'owner' | 'courier' | 'admin';
  // بيانات الطلب المرتبط (إن وجد)
  orderId?: string;
  orderNumber?: string;
  // بيانات الأسرة المشتكى عليها (إن وجد)
  againstRestaurantId?: string;
  againstRestaurantName?: string;
  // بيانات المندوب المشتكى عليه (إن وجد)
  againstCourierId?: string;
  againstCourierName?: string;
  // حالة التذكرة
  status: TicketStatus;
  priority: 'low' | 'medium' | 'high' | 'urgent';
  // المرفقات (صور الإثبات)
  attachments?: string[];
  // الرد والحل
  adminResponse?: string;
  adminId?: string;
  adminName?: string;
  resolution?: string; // كيف تم حل المشكلة
  // التواريخ
  createdAt?: Date;
  updatedAt?: Date;
  resolvedAt?: Date;
  closedAt?: Date;
}

/**
 * حالات تذكرة الدعم
 */
export type TicketStatus = 
  | 'open'              // جديدة
  | 'in_progress'       // قيد المعالجة
  | 'waiting_customer'  // بانتظار رد العميل
  | 'waiting_restaurant'// بانتظار رد الأسرة
  | 'resolved'          // تم الحل
  | 'closed';           // مغلقة

/**
 * نظام النقاط - للأسر والمندوبين
 * كل مستخدم يبدأ بـ 100 نقطة
 * الشكوى المؤكدة = خصم نقاط
 * أقل من 30 نقطة = إيقاف تلقائي
 */
export interface PointsSystem {
  currentPoints: number; // النقاط الحالية (تبدأ من 100)
  totalDeductions: number; // إجمالي النقاط المخصومة
  suspendedAt?: Date; // تاريخ الإيقاف (إن وجد)
  suspendedReason?: string; // سبب الإيقاف
  isSuspended: boolean; // هل الحساب موقوف؟
  warningCount: number; // عدد التنبيهات
  lastWarningAt?: Date; // تاريخ آخر تنبيه
  pointsHistory: PointsHistoryItem[]; // سجل النقاط
}

/**
 * سجل تاريخ النقاط
 */
export interface PointsHistoryItem {
  id: string;
  type: 'deduction' | 'bonus' | 'reset'; // نوع العملية
  amount: number; // عدد النقاط (سالب للخصم، موجب للمكافأة)
  reason: string; // سبب الخصم/المكافأة
  orderId?: string; // رقم الطلب المرتبط
  ticketId?: string; // رقم التذكرة المرتبطة
  adminId?: string; // المسؤول الذي أجرى العملية
  createdAt: Date;
}

/**
 * إعدادات نظام النقاط
 */
export const POINTS_CONFIG = {
  STARTING_POINTS: 100, // نقاط البداية
  SUSPENSION_THRESHOLD: 30, // الحد الأدنى للإيقاف
  WARNING_THRESHOLD: 50, // حد التنبيه
  // خصومات الشكاوى حسب النوع
  DEDUCTIONS: {
    FOOD_QUALITY: 15, // جودة الطعام
    LATE_DELIVERY: 10, // تأخير التسليم
    BAD_SERVICE: 10, // سوء الخدمة
    WRONG_ORDER: 12, // طلب خاطئ
    PACKAGING: 8, // سوء التغليف
    HYGIENE: 20, // نظافة
    NO_SHOW: 15, // عدم الحضور (للمندوب)
    RUDE_BEHAVIOR: 15, // سوء التعامل
    LOW_RATING: 5, // تقييم منخفض متكرر
  },
  // مكافآت
  BONUSES: {
    MONTHLY_EXCELLENT: 10, // أداء ممتاز شهري
    NO_COMPLAINTS_WEEK: 5, // أسبوع بدون شكاوى
  }
};

/**
 * إعدادات عداد الوقت للطلبات (بالدقائق)
 * تجاوز الوقت = تنبيه تلقائي
 */
export const ORDER_TIME_LIMITS = {
  // وقت تجهيز الأسرة (من القبول حتى الجاهزية)
  PREPARATION_TIME: 30, // 30 دقيقة
  // وقت استلام المندوب (من الجاهزية حتى الاستلام)
  COURIER_PICKUP_TIME: 15, // 15 دقيقة
  // وقت التوصيل (من الاستلام حتى التسليم)
  DELIVERY_TIME: 30, // 30 دقيقة
  // ألوان التحذير
  WARNING_THRESHOLD: 0.75, // تحذير عند 75% من الوقت
};

/**
 * حالة عداد الوقت
 */
export type TimerStatus = 'normal' | 'warning' | 'exceeded';

/**
 * أوقات الطلب - timestamps لكل مرحلة
 */
export interface OrderTimestamps {
  acceptedAt?: Date; // وقت قبول الطلب (بداية التجهيز)
  readyAt?: Date; // وقت جهوزية الطلب (بداية انتظار المندوب)
  pickedUpAt?: Date; // وقت استلام المندوب (بداية التوصيل)
  deliveredAt?: Date; // وقت التسليم (النهاية)
}

/**
 * تنبيهات تجاوز الوقت
 */
export interface TimeAlert {
  id: string;
  orderId: string;
  orderNumber?: string;
  type: 'preparation' | 'pickup' | 'delivery';
  exceededBy: number; // كم دقيقة تجاوز
  targetId: string; // UID الأسرة أو المندوب
  targetType: 'restaurant' | 'courier';
  createdAt?: Date;
  acknowledged?: boolean; // هل تم التنبيه؟
}

/**
 * TicketMessage - رسالة في تذكرة الدعم
 */
export interface TicketMessage {
  id: string;
  ticketId: string;
  senderId: string;
  senderName?: string;
  senderRole: 'user' | 'admin' | 'system';
  message: string;
  attachments?: string[];
  createdAt?: Date;
}

/**
 * Menu Item - Product sold by a restaurant
 */
export interface MenuItem {
  id: string;
  name: string;
  desc?: string;
  price: number;
  imageUrl?: string;
  available: boolean;
  categoryId?: string;
  ownerId: string; // Links to restaurants/{ownerId}
  // نظام الخصومات
  discountPercent?: number; // نسبة الخصم (مثال: 20 تعني 20%)
  discountExpiresAt?: Date | any; // تاريخ انتهاء الخصم
  createdAt?: Date;
  updatedAt?: Date;
}

/**
 * Restaurant - Owner's restaurant profile
 */
export interface Restaurant {
  id: string; // doc ID = ownerId
  name: string;
  ownerId: string;
  email?: string;
  phone?: string;
  city?: string;
  location?: string; // Address or description
  logoUrl?: string;
  // حالة المتجر
  isOpen?: boolean; // هل المتجر مفتوح للطلبات؟ (true = متاح، false = مغلق)
  // خيارات التوصيل والاستلام
  allowDelivery?: boolean; // السماح بالتوصيل للعملاء
  allowPickup?: boolean; // السماح بالاستلام من موقع المطعم
  // التراخيص
  commercialLicenseUrl?: string; // صورة الرخصة التجارية / السجل التجاري
  licenseStatus?: 'pending' | 'approved' | 'rejected'; // حالة مراجعة التراخيص
  licenseNotes?: string; // ملاحظات المراجعة
  referredBy?: string; // UID المشرف الذي أضاف المطعم (admin) - إذا كان فارغ = مسجل من المطور
  referrerType?: 'admin' | 'developer'; // نوع من أضاف المطعم
  // باقات سفرة البيت
  packageType?: 'free' | 'premium'; // نوع الباقة الحالية
  packageRequest?: 'premium'; // طلب ترقية للباقة
  packageRequestedAt?: Date; // تاريخ طلب الترقية
  packageSubscribedAt?: Date; // تاريخ الاشتراك في الباقة المدفوعة
  packageExpiresAt?: Date; // تاريخ انتهاء الباقة المدفوعة
  // نظام التوثيق والتصنيف
  isVerified?: boolean; // هل الأسرة موثقة؟
  verifiedAt?: Date; // تاريخ التوثيق
  sellerTier?: 'bronze' | 'silver' | 'gold'; // تصنيف البائع
  tierUpdatedAt?: Date; // تاريخ آخر تحديث للتصنيف
  // إحصائيات للتصنيف
  totalOrders?: number; // إجمالي الطلبات
  averageRating?: number; // متوسط التقييم
  onTimeDeliveryRate?: number; // نسبة الالتزام بالوقت
  complaintsCount?: number; // عدد الشكاوى
  // بيانات الحساب البنكي للتحويل
  bankName?: string; // اسم البنك
  bankAccountName?: string; // اسم صاحب الحساب
  bankAccountNumber?: string; // رقم الآيبان أو الحساب
  // بيانات التوظيف
  isHiring?: boolean; // هل الأسرة تبحث عن موظفات؟
  hiringDescription?: string; // وصف الوظيفة المطلوبة
  hiringContact?: string; // رقم التواصل للتوظيف
  createdAt?: Date;
  updatedAt?: Date;
}

/**
 * Seller Tier Levels
 * Bronze: المستوى الأساسي (افتراضي)
 * Silver: أداء جيد (تقييم 4+، التزام 85%+، شكاوى أقل من 5)
 * Gold: أداء ممتاز (تقييم 4.5+، التزام 95%+، شكاوى أقل من 2)
 */
export type SellerTier = 'bronze' | 'silver' | 'gold';

/**
 * Order - Customer purchase record
 */
export interface Order {
  id: string;
  customerId: string; // Links to users/{customerId}
  items: OrderItem[];
  subtotal: number;
  deliveryFee: number; // رسوم التوصيل (يحددها المندوب أو الأسرة)
  deliveryFeeSetBy?: 'owner' | 'courier'; // من حدد رسوم التوصيل
  deliveryFeeSetAt?: Date; // متى تم تحديد رسوم التوصيل
  total: number;
  status: OrderStatus;
  address: string;
  deliveryType?: 'delivery' | 'pickup'; // نوع التسليم: توصيل أو استلام من المطعم
  courierId?: string; // Links to users/{courierId} if assigned
  notes?: string;
  restaurantName?: string; // Denormalized for display convenience
  restaurantId?: string; // Links to restaurants/{id}
  // نظام العمولات والرسوم
  platformFee?: number; // رسوم المنصة الثابتة (3.75 ريال لكل طلب) - على المندوب
  adminCommission?: number; // عمولة المشرف (0.5 ريال إذا المطعم مسجل عن طريقه)
  courierPlatformFee?: number; // رسوم المنصة المخصومة من المندوب (3.75 ريال)
  referredBy?: string; // UID المشرف الذي أضاف المطعم
  // نظام التقييم الإجباري
  ratings?: OrderRatings; // التقييمات للطلب
  ratingCompleted?: boolean; // هل اكتمل التقييم؟
  // عداد الوقت - timestamps لكل مرحلة
  timestamps?: OrderTimestamps;
  // تنبيهات تجاوز الوقت
  timeAlerts?: {
    preparationExceeded?: boolean;
    pickupExceeded?: boolean;
    deliveryExceeded?: boolean;
  };
  createdAt?: Date;
  updatedAt?: Date;
}

/**
 * OrderRatings - تقييمات الطلب
 */
export interface OrderRatings {
  // تقييم العميل للأسرة
  customerToRestaurant?: Rating;
  // تقييم العميل للمندوب
  customerToCourier?: Rating;
  // تقييم الأسرة للعميل
  restaurantToCustomer?: Rating;
  // تقييم المندوب للعميل
  courierToCustomer?: Rating;
}

/**
 * Rating - تقييم فردي
 */
export interface Rating {
  stars: number; // 1-5 نجوم
  comment?: string; // تعليق اختياري
  createdAt?: Date;
}

/**
 * Order Item - Line item in an order
 */
export interface OrderItem {
  id: string; // menuItems/{id}
  name: string;
  price: number;
  qty: number;
  ownerId?: string; // Restaurant ID for multi-restaurant support
}

/**
 * Order Status - Lifecycle states of an order
 */
export type OrderStatus = 
  | 'pending'           // Just created, awaiting owner acceptance
  | 'accepted'          // Owner accepted the order
  | 'preparing'         // Kitchen is preparing
  | 'ready'             // Ready for pickup/delivery
  | 'out_for_delivery'  // Courier is delivering
  | 'delivered'         // Successfully delivered
  | 'cancelled';        // Order cancelled

/**
 * User - Application user record
 */
export interface User {
  uid: string;
  email: string;
  name?: string;
  phone?: string;
  city?: string;
  address?: string;
  role: UserRole;
  // الموقع المحفوظ للتوصيل
  savedLocation?: {
    lat: number;
    lng: number;
    address: string;
  };
  createdAt?: Date;
  updatedAt?: Date;
}

/**
 * User Role - Authorization levels in the app
 */
export type UserRole = 'customer' | 'courier' | 'owner' | 'admin' | 'developer';

/**
 * Admin Role (المشرف):
 * - إضافة/إدارة المطاعم
 * - مراقبة الطلبات للمطاعم المضافة (بدون تعديل)
 * - إدارة المحفظة والمكافآت
 * - يمكنه الطلب كعميل
 */

/**
 * Developer Role (المطور):
 * - جميع الصلاحيات الكاملة
 * - إدارة المستخدمين (إضافة/حذف)
 * - إدارة المطاعم (إضافة/حذف/تعديل)
 * - إدارة الطلبات
 * - إدارة الإعدادات العامة
 */

/**
 * Settings - Global app configuration
 */
export interface AppSettings {
  deliveryFee?: number;
  minOrderAmount?: number;
  operatingHours?: {
    open: string;
    close: string;
  };
  platformFee?: number; // رسوم التطبيق الثابتة (1.5 ريال)
  adminCommissionRate?: number; // نسبة المشرف (0.5 ريال)
  [key: string]: any;
}

/**
 * Wallet - محفظة المشرف أو المطور
 */
export interface Wallet {
  id: string; // = user UID
  balance: number; // الرصيد الحالي
  totalEarnings: number; // إجمالي الأرباح
  totalWithdrawn: number; // إجمالي المسحوب
  transactions: WalletTransaction[];
  updatedAt?: Date;
}

/**
 * WalletTransaction - معاملة في المحفظة
 */
export interface WalletTransaction {
  id: string;
  type: 'credit' | 'debit'; // إيداع أو سحب
  amount: number;
  description: string;
  orderId?: string; // رقم الطلب المرتبط
  restaurantId?: string;
  createdAt: Date;
}

/**
 * Promotion - الإعلان الممول للأسرة المنتجة (حالة/ستوري)
 */
export interface Promotion {
  id: string;
  ownerId: string; // صاحب الأسرة
  restaurantId: string; // المطعم/الأسرة
  type: 'text' | 'image' | 'video'; // نوع الإعلان
  title?: string; // عنوان الإعلان
  description?: string; // الوصف أو الشرح
  mediaUrl?: string; // رابط الصورة أو الفيديو
  isActive: boolean; // هل الإعلان نشط؟
  isPaid: boolean; // هل تم الدفع؟
  price: number; // سعر الإعلان
  duration: number; // مدة الإعلان بالساعات (24 ساعة افتراضي)
  viewsCount: number; // عدد المشاهدات
  expiresAt?: Date; // تاريخ انتهاء الإعلان
  createdAt?: Date;
  updatedAt?: Date;
}

/**
 * PackageSubscriptionRequest - طلب اشتراك في باقة التميز
 */
export interface PackageSubscriptionRequest {
  id: string;
  restaurantId: string; // معرف المطعم/الأسرة
  restaurantName: string; // اسم الأسرة
  ownerName?: string; // اسم صاحب الأسرة
  ownerPhone?: string; // رقم الجوال
  status: PackageRequestStatus;
  // بيانات الدفع
  bankAccountImageUrl?: string; // صورة الحساب البنكي من المطور
  paymentProofImageUrl?: string; // صورة إثبات التحويل من الأسرة
  subscriptionAmount: number; // مبلغ الاشتراك
  subscriptionDuration: number; // مدة الاشتراك بالأيام (30 يوم مثلاً)
  // ملاحظات
  developerNotes?: string; // ملاحظات المطور
  ownerNotes?: string; // ملاحظات الأسرة
  // تواريخ
  requestedAt?: Date;
  bankSentAt?: Date; // تاريخ إرسال صورة البنك
  paymentSentAt?: Date; // تاريخ إرسال إثبات التحويل
  approvedAt?: Date;
  rejectedAt?: Date;
  expiresAt?: Date; // تاريخ انتهاء الاشتراك
  createdAt?: Date;
  updatedAt?: Date;
}

/**
 * حالات طلب الاشتراك في الباقة
 */
export type PackageRequestStatus = 
  | 'pending'           // طلب جديد بانتظار المطور
  | 'bank_sent'         // المطور أرسل صورة الحساب البنكي
  | 'payment_sent'      // الأسرة أرسلت إثبات التحويل
  | 'approved'          // تم القبول وتفعيل الباقة
  | 'rejected'          // مرفوض
  | 'expired';          // منتهي الصلاحية

/**
 * RestaurantStats - إحصائيات المطعم/الأسرة المنتجة
 */
export interface RestaurantStats {
  id: string; // = restaurant ID
  // إحصائيات الزيارات
  totalProfileViews: number; // عدد مشاهدات الملف التعريفي
  totalMenuViews: number; // عدد مشاهدات صفحة القائمة
  totalItemViews: number; // عدد مشاهدات الأصناف
  // إحصائيات المشاركة
  totalShareClicks: number; // عدد مرات الضغط على زر المشاركة
  whatsappShareCount: number; // عدد مرات المشاركة عبر واتساب
  // إحصائيات التسجيل
  registeredCustomers: number; // عدد العملاء المسجلين عبر رابط الأسرة
  appDownloads: number; // عدد تحميلات التطبيق عبر رابط الأسرة
  followersCount: number; // عدد متابعي المتجر
  // تفاصيل الزيارات
  dailyViews: Record<string, number>; // عدد الزيارات اليومية { "2024-01-22": 50 }
  // آخر تحديث
  updatedAt?: Date;
}

/**
 * VisitLog - سجل زيارة لتتبع زيارات العملاء
 */
export interface VisitLog {
  id: string;
  restaurantId: string; // معرف المطعم
  visitorId?: string; // معرف الزائر (إذا مسجل)
  visitorType: 'anonymous' | 'customer' | 'registered_via_link';
  source: 'direct' | 'whatsapp_share' | 'social_share' | 'referral';
  page: 'menu' | 'profile' | 'item';
  itemId?: string; // معرف الصنف (إذا كانت زيارة صنف)
  referralCode?: string; // كود الإحالة
  createdAt?: Date;
}

/**
 * CustomerRegistration - تسجيل عميل عبر رابط الأسرة
 */
export interface CustomerRegistration {
  id: string;
  customerId: string; // معرف العميل
  restaurantId: string; // معرف الأسرة التي سجل عبرها
  registrationType: 'website' | 'app';
  referralCode?: string;
  createdAt?: Date;
}

/**
 * StoreFollower - متابع للمتجر
 */
export interface StoreFollower {
  id: string;
  followerId: string; // معرف العميل المتابع
  followerName?: string; // اسم المتابع
  restaurantId: string; // معرف المتجر المتابَع
  createdAt?: Date;
}

/**
 * PackageSettings - إعدادات الباقات (تُخزن في settings/packages)
 */
export interface PackageSettings {
  // إعدادات باقة التميز (Premium)
  premium: PackageConfig;
  // إعدادات الباقة المجانية
  free: PackageConfig;
  // الباقة النشطة افتراضياً للمطاعم الجديدة
  defaultPackage: 'free' | 'premium';
  // آخر تحديث
  updatedAt?: Date;
}

/**
 * PackageConfig - إعدادات باقة واحدة
 */
export interface PackageConfig {
  // الاسم المعروض للباقة
  displayName: string;
  // الوصف
  description?: string;
  // هل الباقة مفعّلة (يمكن للأسر الاشتراك فيها)
  isEnabled: boolean;
  // السعر الأصلي بالريال
  originalPrice: number;
  // السعر الحالي بالريال (بعد الخصم إن وجد)
  currentPrice: number;
  // مدة الاشتراك بالأيام
  durationDays: number;
  // إعدادات الخصم
  discount?: PackageDiscount;
}

/**
 * PackageDiscount - خصم على الباقة
 */
export interface PackageDiscount {
  // هل الخصم مفعّل
  isActive: boolean;
  // نوع الخصم: نسبة مئوية أو مبلغ ثابت
  type: 'percentage' | 'fixed';
  // قيمة الخصم (نسبة أو مبلغ)
  value: number;
  // تاريخ بداية الخصم
  startDate?: Date | any;
  // تاريخ نهاية الخصم
  endDate?: Date | any;
  // سبب أو وصف الخصم (للعرض)
  label?: string;
}

==========================================================================================
FILE: src/utils/cities.ts
==========================================================================================
// src/utils/cities.ts
// قائمة المدن السعودية الرئيسية

export const SAUDI_CITIES = [
  'الرياض',
  'جدة',
  'مكة المكرمة',
  'المدينة المنورة',
  'الدمام',
  'الخبر',
  'الظهران',
  'الأحساء',
  'القطيف',
  'الطائف',
  'تبوك',
  'بريدة',
  'عنيزة',
  'حائل',
  'خميس مشيط',
  'أبها',
  'نجران',
  'جازان',
  'ينبع',
  'الجبيل',
  'حفر الباطن',
  'الخرج',
  'أملج',
  'العلا',
  'رابغ',
  'القنفذة',
  'بيشة',
  'صبيا',
  'الباحة',
  'عرعر',
  'سكاكا',
  'الدوادمي',
  'المجمعة',
  'الزلفي',
  'شقراء',
  'وادي الدواسر',
  'رفحاء',
  'طريف',
  'القريات',
  'أخرى',
] as const

export type SaudiCity = typeof SAUDI_CITIES[number]

==========================================================================================
FILE: src/utils/config.ts
==========================================================================================
/**
 * App Configuration & Utilities
 * Centralized place for app-level settings and configuration
 */

import { db } from '@/firebase'
import { doc, getDoc } from 'firebase/firestore'
import { AppSettings } from '@/types'

const DEFAULT_DELIVERY_FEE = 7
const SETTINGS_DOC_ID = 'general'

/**
 * Get delivery fee from app settings, with fallback to default
 * Should be cached or called once during app initialization
 */
export async function getDeliveryFee(): Promise<number> {
  try {
    const snap = await getDoc(doc(db, 'settings', SETTINGS_DOC_ID))
    if (snap.exists()) {
      const data = snap.data() as AppSettings
      return data.deliveryFee ?? DEFAULT_DELIVERY_FEE
    }
  } catch (err) {
    console.warn('Failed to fetch delivery fee from settings:', err)
  }
  return DEFAULT_DELIVERY_FEE
}

/**
 * Get all app settings with fallbacks
 */
export async function getAppSettings(): Promise<AppSettings> {
  try {
    const snap = await getDoc(doc(db, 'settings', SETTINGS_DOC_ID))
    if (snap.exists()) {
      return snap.data() as AppSettings
    }
  } catch (err) {
    console.warn('Failed to fetch app settings:', err)
  }
  return {
    deliveryFee: DEFAULT_DELIVERY_FEE,
  }
}

==========================================================================================
FILE: src/utils/distance.ts
==========================================================================================
// src/utils/distance.ts
// دالة حساب المسافة بين نقطتين باستخدام صيغة Haversine

export type GeoLocation = {
  lat: number
  lng: number
}

/**
 * حساب المسافة بين نقطتين بالكيلومتر
 * @param point1 النقطة الأولى
 * @param point2 النقطة الثانية
 * @returns المسافة بالكيلومتر
 */
export function calculateDistance(point1: GeoLocation, point2: GeoLocation): number {
  const R = 6371 // نصف قطر الأرض بالكيلومتر
  
  const dLat = toRad(point2.lat - point1.lat)
  const dLng = toRad(point2.lng - point1.lng)
  
  const a = 
    Math.sin(dLat / 2) * Math.sin(dLat / 2) +
    Math.cos(toRad(point1.lat)) * Math.cos(toRad(point2.lat)) *
    Math.sin(dLng / 2) * Math.sin(dLng / 2)
  
  const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a))
  
  return R * c
}

function toRad(deg: number): number {
  return deg * (Math.PI / 180)
}

/**
 * التحقق من أن المسافة ضمن النطاق المحدد
 * @param point1 النقطة الأولى
 * @param point2 النقطة الثانية
 * @param maxDistance أقصى مسافة بالكيلومتر
 * @returns true إذا كانت المسافة ضمن النطاق
 */
export function isWithinDistance(point1: GeoLocation, point2: GeoLocation, maxDistance: number): boolean {
  return calculateDistance(point1, point2) <= maxDistance
}

// أقصى مسافة للتوصيل (15 كيلو)
export const MAX_DELIVERY_DISTANCE = 15

==========================================================================================
FILE: src/utils/pointsService.ts
==========================================================================================
// src/utils/pointsService.ts
// خدمة إدارة نظام النقاط للأسر والمندوبين
import { doc, getDoc, updateDoc, serverTimestamp, arrayUnion } from 'firebase/firestore'
import { db } from '@/firebase'
import { POINTS_CONFIG, PointsHistoryItem } from '@/types'

/**
 * الحصول على نقاط مستخدم (أسرة أو مندوب)
 */
export async function getUserPoints(
  userId: string, 
  userType: 'restaurant' | 'courier'
): Promise<number> {
  const collection = userType === 'restaurant' ? 'restaurants' : 'couriers'
  const docRef = doc(db, collection, userId)
  const snap = await getDoc(docRef)
  
  if (!snap.exists()) return POINTS_CONFIG.STARTING_POINTS
  
  const data = snap.data()
  return data.points?.currentPoints ?? POINTS_CONFIG.STARTING_POINTS
}

/**
 * التحقق إذا كان المستخدم موقوفاً
 */
export async function isUserSuspended(
  userId: string, 
  userType: 'restaurant' | 'courier'
): Promise<boolean> {
  const collection = userType === 'restaurant' ? 'restaurants' : 'couriers'
  const docRef = doc(db, collection, userId)
  const snap = await getDoc(docRef)
  
  if (!snap.exists()) return false
  
  const data = snap.data()
  return data.points?.isSuspended === true
}

/**
 * خصم نقاط من مستخدم
 */
export async function deductPoints(
  userId: string,
  userType: 'restaurant' | 'courier',
  amount: number,
  reason: string,
  options?: {
    orderId?: string
    ticketId?: string
    adminId?: string
  }
): Promise<{
  success: boolean
  newPoints: number
  isSuspended: boolean
  isWarning: boolean
  message: string
}> {
  const collection = userType === 'restaurant' ? 'restaurants' : 'couriers'
  const docRef = doc(db, collection, userId)
  const snap = await getDoc(docRef)
  
  if (!snap.exists()) {
    return {
      success: false,
      newPoints: 0,
      isSuspended: false,
      isWarning: false,
      message: 'المستخدم غير موجود'
    }
  }
  
  const data = snap.data()
  const currentPoints = data.points?.currentPoints ?? POINTS_CONFIG.STARTING_POINTS
  const totalDeductions = data.points?.totalDeductions ?? 0
  const warningCount = data.points?.warningCount ?? 0
  const pointsHistory = data.points?.pointsHistory ?? []
  
  // حساب النقاط الجديدة
  const newPoints = Math.max(0, currentPoints - amount)
  
  // إنشاء سجل الخصم
  const historyItem: PointsHistoryItem = {
    id: `deduct_${Date.now()}`,
    type: 'deduction',
    amount: -amount,
    reason,
    orderId: options?.orderId,
    ticketId: options?.ticketId,
    adminId: options?.adminId,
    createdAt: new Date()
  }
  
  // التحقق من الإيقاف
  const shouldSuspend = newPoints < POINTS_CONFIG.SUSPENSION_THRESHOLD
  
  // التحقق من التنبيه
  const shouldWarn = !shouldSuspend && newPoints < POINTS_CONFIG.WARNING_THRESHOLD
  
  // تحديث البيانات
  const updates: any = {
    'points.currentPoints': newPoints,
    'points.totalDeductions': totalDeductions + amount,
    'points.pointsHistory': [...pointsHistory, historyItem],
    updatedAt: serverTimestamp()
  }
  
  if (shouldSuspend) {
    updates['points.isSuspended'] = true
    updates['points.suspendedAt'] = serverTimestamp()
    updates['points.suspendedReason'] = `إيقاف تلقائي - النقاط أقل من ${POINTS_CONFIG.SUSPENSION_THRESHOLD}`
    updates['isOpen'] = false // إغلاق المتجر
    updates['isAvailable'] = false // للمندوب
  }
  
  if (shouldWarn) {
    updates['points.warningCount'] = warningCount + 1
    updates['points.lastWarningAt'] = serverTimestamp()
  }
  
  await updateDoc(docRef, updates)
  
  let message = `تم خصم ${amount} نقطة. النقاط الحالية: ${newPoints}`
  if (shouldSuspend) {
    message = `⛔ تم إيقاف الحساب تلقائياً! النقاط وصلت إلى ${newPoints}`
  } else if (shouldWarn) {
    message = `⚠️ تنبيه! النقاط منخفضة: ${newPoints}. قد يتم الإيقاف عند ${POINTS_CONFIG.SUSPENSION_THRESHOLD}`
  }
  
  return {
    success: true,
    newPoints,
    isSuspended: shouldSuspend,
    isWarning: shouldWarn,
    message
  }
}

/**
 * إضافة نقاط مكافأة
 */
export async function addBonusPoints(
  userId: string,
  userType: 'restaurant' | 'courier',
  amount: number,
  reason: string,
  adminId?: string
): Promise<{ success: boolean; newPoints: number; message: string }> {
  const collection = userType === 'restaurant' ? 'restaurants' : 'couriers'
  const docRef = doc(db, collection, userId)
  const snap = await getDoc(docRef)
  
  if (!snap.exists()) {
    return { success: false, newPoints: 0, message: 'المستخدم غير موجود' }
  }
  
  const data = snap.data()
  const currentPoints = data.points?.currentPoints ?? POINTS_CONFIG.STARTING_POINTS
  const pointsHistory = data.points?.pointsHistory ?? []
  
  const newPoints = Math.min(100, currentPoints + amount) // الحد الأقصى 100
  
  const historyItem: PointsHistoryItem = {
    id: `bonus_${Date.now()}`,
    type: 'bonus',
    amount: amount,
    reason,
    adminId,
    createdAt: new Date()
  }
  
  await updateDoc(docRef, {
    'points.currentPoints': newPoints,
    'points.pointsHistory': [...pointsHistory, historyItem],
    updatedAt: serverTimestamp()
  })
  
  return {
    success: true,
    newPoints,
    message: `تم إضافة ${amount} نقطة. النقاط الحالية: ${newPoints}`
  }
}

/**
 * إعادة تعيين النقاط (بعد المراجعة)
 */
export async function resetPoints(
  userId: string,
  userType: 'restaurant' | 'courier',
  reason: string,
  adminId: string
): Promise<{ success: boolean; message: string }> {
  const collection = userType === 'restaurant' ? 'restaurants' : 'couriers'
  const docRef = doc(db, collection, userId)
  const snap = await getDoc(docRef)
  
  if (!snap.exists()) {
    return { success: false, message: 'المستخدم غير موجود' }
  }
  
  const data = snap.data()
  const pointsHistory = data.points?.pointsHistory ?? []
  
  const historyItem: PointsHistoryItem = {
    id: `reset_${Date.now()}`,
    type: 'reset',
    amount: POINTS_CONFIG.STARTING_POINTS,
    reason,
    adminId,
    createdAt: new Date()
  }
  
  await updateDoc(docRef, {
    'points.currentPoints': POINTS_CONFIG.STARTING_POINTS,
    'points.isSuspended': false,
    'points.suspendedAt': null,
    'points.suspendedReason': null,
    'points.warningCount': 0,
    'points.pointsHistory': [...pointsHistory, historyItem],
    'isOpen': true, // إعادة فتح المتجر
    'isAvailable': true, // للمندوب
    updatedAt: serverTimestamp()
  })
  
  return {
    success: true,
    message: `تم إعادة تعيين النقاط إلى ${POINTS_CONFIG.STARTING_POINTS}`
  }
}

/**
 * الحصول على سجل النقاط
 */
export async function getPointsHistory(
  userId: string,
  userType: 'restaurant' | 'courier'
): Promise<PointsHistoryItem[]> {
  const collection = userType === 'restaurant' ? 'restaurants' : 'couriers'
  const docRef = doc(db, collection, userId)
  const snap = await getDoc(docRef)
  
  if (!snap.exists()) return []
  
  const data = snap.data()
  return data.points?.pointsHistory ?? []
}

/**
 * تهيئة نظام النقاط لمستخدم جديد
 */
export async function initializePoints(
  userId: string,
  userType: 'restaurant' | 'courier'
): Promise<void> {
  const collection = userType === 'restaurant' ? 'restaurants' : 'couriers'
  const docRef = doc(db, collection, userId)
  
  await updateDoc(docRef, {
    points: {
      currentPoints: POINTS_CONFIG.STARTING_POINTS,
      totalDeductions: 0,
      isSuspended: false,
      warningCount: 0,
      pointsHistory: []
    }
  })
}

==========================================================================================
FILE: storage.rules
==========================================================================================
rules_version = '2';
service firebase.storage {
  match /b/{bucket}/o {
    // السماح بالقراءة للجميع (الصور عامة)
    match /{allPaths=**} {
      allow read: if true;
    }
    
    // صور القائمة - يمكن لأي مستخدم مسجل رفعها
    match /menuImages/{allImages} {
      allow write: if request.auth != null
                   && request.resource.size < 5 * 1024 * 1024  // 5MB max
                   && request.resource.contentType.matches('image/.*');
    }
    
    // صور المطاعم (الشعارات) - يمكن لأي مستخدم مسجل رفعها
    match /restaurants/{ownerId}/{allImages} {
      allow write: if request.auth != null
                   && request.resource.size < 5 * 1024 * 1024  // 5MB max
                   && request.resource.contentType.matches('image/.*');
    }
    
    // تراخيص المطاعم (صور أو PDF) - مسار فرعي licenses
    match /restaurants/{ownerId}/licenses/{fileName} {
      allow write: if request.auth != null
                   && request.resource.size < 5 * 1024 * 1024  // 5MB max
                   && (request.resource.contentType.matches('image/.*') 
                       || request.resource.contentType == 'application/pdf');
    }
    
    // مجلد عام للصور (للأدمن والمطور)
    match /uploads/{allImages} {
      allow write: if request.auth != null
                   && request.resource.size < 5 * 1024 * 1024
                   && request.resource.contentType.matches('image/.*');
    }
    
    // إعلانات الأسر المنتجة (صور وفيديو)
    match /promotions/{fileName} {
      allow write: if request.auth != null
                   && request.resource.size < 50 * 1024 * 1024  // 50MB max للفيديو
                   && (request.resource.contentType.matches('image/.*') 
                       || request.resource.contentType.matches('video/.*'));
    }
    
    // صور الحسابات البنكية (للمطور فقط)
    match /bankAccounts/{fileName} {
      allow write: if request.auth != null
                   && request.resource.size < 5 * 1024 * 1024  // 5MB max
                   && request.resource.contentType.matches('image/.*');
    }
    
    // إثباتات التحويل (للمطاعم)
    match /paymentProofs/{fileName} {
      allow write: if request.auth != null
                   && request.resource.size < 5 * 1024 * 1024  // 5MB max
                   && request.resource.contentType.matches('image/.*');
    }
    
    // مستندات المناديب (الهوية، رخصة القيادة، استمارة السيارة)
    match /couriers/{courierId}/{fileName} {
      allow write: if request.auth != null
                   && request.auth.uid == courierId
                   && request.resource.size < 5 * 1024 * 1024  // 5MB max
                   && request.resource.contentType.matches('image/.*');
    }
  }
}

==========================================================================================
FILE: vite.config.ts
==========================================================================================
import { defineConfig } from 'vite'
import react from '@vitejs/plugin-react'
import path from 'path'

export default defineConfig({
  plugins: [react()],
  resolve: {
    alias: {
      '@': path.resolve(__dirname, './src'),
    },
  },
})
