سُفرة البيت (Sofra Al-Bayt) — Source Codes Bundle
Generated for IP submission.
NOTE: This bundle excludes standalone HTML/CSS files.
NOTE: Image data/URLs/SVG blocks/extensions were redacted.


==========================================================================================
FILE: firestore.rules
==========================================================================================
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    function signedIn() {
      return request.auth != null;
    }

    function myRole() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role;
    }

    function isOwner() {
      return signedIn() && myRole() == 'owner';
    }

    function isCourier() {
      return signedIn() && myRole() == 'courier';
    }

    function isCustomer() {
      return signedIn() && myRole() == 'customer';
    }

    function isAdmin() {
      return signedIn() && myRole() == 'admin';
    }

    function isDeveloper() {
      return signedIn() && myRole() == 'developer';
    }

    /* ===== users ===== */
    match /users/{uid} {
      allow read: if isOwner() || isAdmin() || isDeveloper() || (signedIn() && request.auth.uid == uid);
      allow create: if signedIn() && request.auth.uid == uid;
      allow update: if signedIn() && request.auth.uid == uid || isDeveloper();
      allow delete: if isDeveloper();
    }

    /* ===== couriers (ملفات المناديب الشخصية) ===== */
    match /couriers/{courierId} {
      // القراءة: المندوب نفسه أو المطور
      allow read: if isDeveloper() || (isCourier() && request.auth.uid == courierId);
      
      // الإنشاء: المندوب لملفه الشخصي
      allow create: if isCourier() && request.auth.uid == courierId;
      
      // التحديث: المندوب نفسه أو المطور
      allow update: if isDeveloper() || (isCourier() && request.auth.uid == courierId);
      
      // الحذف: المطور فقط
      allow delete: if isDeveloper();
    }

    /* ===== restaurants ===== */
    match /restaurants/{ownerId} {
      allow read: if true;
      allow create: if isOwner() && request.auth.uid == ownerId || isAdmin() || isDeveloper();
      allow update: if isOwner() && request.auth.uid == ownerId || isAdmin() || isDeveloper();
      allow delete: if isDeveloper();
    }

    /* ===== بيانات البنك الحساسة للمطاعم ===== */
    match /restaurants/{ownerId}/private/bankInfo {
      // القراءة: صاحب المطعم فقط أو المطور أو العميل (لإتمام الدفع)
      allow read: if isDeveloper() 
                  || (isOwner() && request.auth.uid == ownerId)
                  || isCustomer();
      // الكتابة: صاحب المطعم فقط أو المطور
      allow create, update: if isDeveloper() || (isOwner() && request.auth.uid == ownerId);
      allow delete: if isDeveloper();
    }

    /* ===== menu ===== */
    match /menuItems/{itemId} {
      allow read: if true;
      allow create: if isOwner() && request.resource.data.ownerId == request.auth.uid || isAdmin() || isDeveloper();
      allow update: if isOwner() 
                    && resource.data.ownerId == request.auth.uid
                    && request.resource.data.ownerId == request.auth.uid
                    || isAdmin()
                    || isDeveloper();
      allow delete: if isDeveloper();
    }

    /* ===== orders ===== */
    match /orders/{orderId} {
      allow read: if isOwner()
                  || (isCourier() && (resource.data.courierId == request.auth.uid || resource.data.status in ['ready', 'out_for_delivery']))
                  || (isCustomer() && resource.data.customerId == request.auth.uid)
                  || isAdmin()
                  || isDeveloper();

      allow create: if (isCustomer() && request.resource.data.customerId == request.auth.uid)
                    || (isAdmin() && request.resource.data.customerId == request.auth.uid);

      allow update: if isOwner()
                    || (isCourier() && resource.data.courierId == request.auth.uid)
                    || isAdmin()
                    || isDeveloper();
      allow delete: if isDeveloper();
    }

    /* ===== wallets (for admins and app) ===== */
    match /wallets/{walletId} {
      // القراءة: المطور أو صاحب المحفظة (المشرف)
      allow read: if isDeveloper() || (isAdmin() && request.auth.uid == walletId);
      
      // الإنشاء: المشرف لمحفظته + المطور + العملاء (لإنشاء محفظة المشرف عند الطلب)
      allow create: if isDeveloper() 
                    || (isAdmin() && request.auth.uid == walletId)
                    || (isCustomer() && walletId != request.auth.uid); // العميل يمكنه إنشاء محفظة المشرف
      
      // التحديث: المطور أو العملاء (لتحديث محفظة المشرف عند الطلب)
      allow update: if isDeveloper() 
                    || (isCustomer() && walletId != request.auth.uid); // العميل يمكنه تحديث محفظة المشرف
      
      allow delete: if isDeveloper();
    }

    /* ===== settings (single doc like settings/general) ===== */
    match /settings/{doc} {
      allow read: if true;
      allow create, update, delete: if isOwner() || isDeveloper();
    }

    /* ===== packageRequests (طلبات الاشتراك في الباقات) ===== */
    match /packageRequests/{requestId} {
      // القراءة: المطور أو صاحب الطلب
      allow read: if isDeveloper() || (isOwner() && resource.data.restaurantId == request.auth.uid);
      
      // الإنشاء: صاحب المطعم فقط
      allow create: if isOwner() && request.resource.data.restaurantId == request.auth.uid;
      
      // التحديث: المطور (لإرسال البنك/القبول/الرفض) أو صاحب المطعم (لإرسال إثبات التحويل)
      allow update: if isDeveloper() 
                    || (isOwner() && resource.data.restaurantId == request.auth.uid);
      
      // الحذف: المطور فقط
      allow delete: if isDeveloper();
    }

    /* ===== tasks (مهام المشرفين) ===== */
    match /tasks/{taskId} {
      // القراءة: المطور أو المشرف المسندة إليه المهمة
      allow read: if isDeveloper() || (isAdmin() && resource.data.assignedTo == request.auth.uid);
      
      // الإنشاء: المطور فقط
      allow create: if isDeveloper();
      
      // التحديث: المطور أو المشرف المسندة إليه المهمة (لتحديث الحالة)
      allow update: if isDeveloper() || (isAdmin() && resource.data.assignedTo == request.auth.uid);
      
      // الحذف: المطور فقط
      allow delete: if isDeveloper();
    }

    /* ===== messages (رسائل المحادثة بين العميل والمندوب/المطعم) ===== */
    match /orders/{orderId}/messages/{messageId} {
      // الحصول على بيانات الطلب
      function getOrder() {
        return get(/databases/$(database)/documents/orders/$(orderId)).data;
      }
      
      // التحقق من أن المستخدم مرتبط بالطلب
      function isOrderParticipant() {
        let order = getOrder();
        return request.auth.uid == order.customerId 
            || request.auth.uid == order.courierId 
            || request.auth.uid == order.restaurantId;
      }
      
      // القراءة: العميل أو المندوب أو صاحب المطعم المرتبطين بالطلب أو المطور
      allow read: if isDeveloper() || (signedIn() && isOrderParticipant());
      
      // الإنشاء: العميل أو المندوب أو صاحب المطعم المرتبطين بالطلب
      allow create: if signedIn() && isOrderParticipant();
      
      // لا يسمح بالتعديل أو الحذف
      allow update, delete: if isDeveloper();
    }

    /* ===== hiringRequests (طلبات توظيف المندوبين) ===== */
    match /hiringRequests/{requestId} {
      // القراءة: المندوب صاحب الطلب أو صاحب المطعم المستهدف أو المطور
      allow read: if isDeveloper() 
                  || (isCourier() && resource.data.courierId == request.auth.uid)
                  || (isOwner() && resource.data.restaurantId == request.auth.uid);
      
      // الإنشاء: المندوب فقط (لإرسال طلب توظيف)
      allow create: if isCourier() && request.resource.data.courierId == request.auth.uid;
      
      // التحديث: صاحب المطعم (للقبول/الرفض) أو المطور
      allow update: if isDeveloper() 
                    || (isOwner() && resource.data.restaurantId == request.auth.uid);
      
      // الحذف: المطور فقط
      allow delete: if isDeveloper();
    }

    /* ===== notifications (إشعارات النظام) ===== */
    match /notifications/{notificationId} {
      // القراءة: المستلم أو المطور
      allow read: if isDeveloper() || (signedIn() && resource.data.recipientId == request.auth.uid);
      
      // الإنشاء: المطور أو أي مستخدم مسجل (لإرسال إشعارات للمطور/المشرف)
      allow create: if signedIn();
      
      // التحديث: المستلم (لتحديث حالة القراءة) أو المطور
      allow update: if isDeveloper() || (signedIn() && resource.data.recipientId == request.auth.uid);
      
      // الحذف: المطور أو المستلم
      allow delete: if isDeveloper() || (signedIn() && resource.data.recipientId == request.auth.uid);
    }

    /* ===== supportTickets (تذاكر الدعم الفني والشكاوى) ===== */
    match /supportTickets/{ticketId} {
      // القراءة: صاحب التذكرة أو المطور
      allow read: if isDeveloper() || (signedIn() && resource.data.userId == request.auth.uid);
      
      // الإنشاء: أي مستخدم مسجل
      allow create: if signedIn() && request.resource.data.userId == request.auth.uid;
      
      // التحديث: المطور فقط (للرد وتغيير الحالة)
      allow update: if isDeveloper();
      
      // الحذف: المطور فقط
      allow delete: if isDeveloper();
    }

    /* ===== supportTickets/messages (رسائل تذاكر الدعم) ===== */
    match /supportTickets/{ticketId}/messages/{messageId} {
      // الحصول على بيانات التذكرة
      function getTicket() {
        return get(/databases/$(database)/documents/supportTickets/$(ticketId)).data;
      }
      
      // القراءة: صاحب التذكرة أو المطور
      allow read: if isDeveloper() || (signedIn() && getTicket().userId == request.auth.uid);
      
      // الإنشاء: صاحب التذكرة أو المطور
      allow create: if signedIn() && (isDeveloper() || getTicket().userId == request.auth.uid);
      
      // لا يسمح بالتعديل أو الحذف
      allow update, delete: if isDeveloper();
    }

    /* ===== supportChats (محادثات الدعم الفني المباشر) ===== */
    match /supportChats/{chatId} {
      // القراءة: صاحب المحادثة أو المطور
      allow read: if isDeveloper() || (signedIn() && resource.data.userId == request.auth.uid);
      
      // الإنشاء: أي مستخدم مسجل
      allow create: if signedIn() && request.resource.data.userId == request.auth.uid;
      
      // التحديث: صاحب المحادثة أو المطور
      allow update: if isDeveloper() || (signedIn() && resource.data.userId == request.auth.uid);
      
      // الحذف: المطور فقط
      allow delete: if isDeveloper();
    }

    /* ===== supportChats/messages (رسائل الدعم المباشر) ===== */
    match /supportChats/{chatId}/messages/{messageId} {
      // الحصول على بيانات المحادثة
      function getChat() {
        return get(/databases/$(database)/documents/supportChats/$(chatId)).data;
      }
      
      // القراءة: صاحب المحادثة أو المطور
      allow read: if isDeveloper() || (signedIn() && getChat().userId == request.auth.uid);
      
      // الإنشاء: صاحب المحادثة أو المطور أو البوت
      allow create: if signedIn() && (isDeveloper() || getChat().userId == request.auth.uid);
      
      // لا يسمح بالتعديل أو الحذف
      allow update, delete: if isDeveloper();
    }

    /* ===== promotions (الإعلانات الممولة للأسر المنتجة) ===== */
    match /promotions/{promotionId} {
      // القراءة: الجميع (لعرض الإعلانات للعملاء)
      allow read: if true;
      
      // الإنشاء: صاحب الأسرة فقط (لإنشاء إعلان)
      allow create: if isOwner() && request.resource.data.ownerId == request.auth.uid;
      
      // التحديث: صاحب الأسرة (لتعديل إعلانه) أو أي مستخدم (لزيادة المشاهدات) أو المطور
      allow update: if isDeveloper() 
                    || (isOwner() && resource.data.ownerId == request.auth.uid)
                    || (signedIn() && request.resource.data.diff(resource.data).affectedKeys().hasOnly(['viewsCount']));
      
      // الحذف: صاحب الأسرة (لحذف إعلانه) أو المطور
      allow delete: if isDeveloper() || (isOwner() && resource.data.ownerId == request.auth.uid);
    }

    /* ===== restaurantStats (إحصائيات المطاعم/الأسر المنتجة) ===== */
    match /restaurantStats/{restaurantId} {
      // القراءة: صاحب المطعم أو المطور
      allow read: if isDeveloper() || (isOwner() && request.auth.uid == restaurantId);
      
      // الإنشاء والتحديث: المطور أو أي مستخدم (لتحديث الإحصائيات عند الزيارة)
      allow create: if signedIn() || isDeveloper();
      allow update: if signedIn() || isDeveloper();
      
      // الحذف: المطور فقط
      allow delete: if isDeveloper();
    }

    /* ===== visitLogs (سجلات الزيارات) ===== */
    match /visitLogs/{logId} {
      // القراءة: صاحب المطعم (زياراته فقط) أو المطور
      allow read: if isDeveloper() || (isOwner() && resource.data.restaurantId == request.auth.uid);
      
      // الإنشاء: أي شخص (لتسجيل الزيارة)
      allow create: if true;
      
      // لا يسمح بالتعديل أو الحذف إلا للمطور
      allow update, delete: if isDeveloper();
    }

    /* ===== customerRegistrations (تسجيلات العملاء عبر روابط الأسر) ===== */
    match /customerRegistrations/{regId} {
      // القراءة: صاحب المطعم (تسجيلاته فقط) أو المطور
      allow read: if isDeveloper() || (isOwner() && resource.data.restaurantId == request.auth.uid);
      
      // الإنشاء: العميل عند التسجيل أو المطور
      allow create: if signedIn() || isDeveloper();
      
      // لا يسمح بالتعديل أو الحذف إلا للمطور
      allow update, delete: if isDeveloper();
    }

    /* ===== storeFollowers (متابعو المتاجر) ===== */
    match /storeFollowers/{followId} {
      // القراءة: صاحب المطعم (متابعيه فقط) أو المتابع نفسه أو المطور
      allow read: if isDeveloper() 
                  || (isOwner() && resource.data.restaurantId == request.auth.uid)
                  || (signedIn() && resource.data.followerId == request.auth.uid);
      
      // الإنشاء: أي مستخدم مسجل
      allow create: if signedIn() && request.resource.data.followerId == request.auth.uid;
      
      // الحذف: المتابع نفسه أو المطور (إلغاء المتابعة)
      allow delete: if isDeveloper() || (signedIn() && resource.data.followerId == request.auth.uid);
      
      // لا يسمح بالتعديل إلا للمطور
      allow update: if isDeveloper();
    }
  }
}



==========================================================================================
FILE: src/App.tsx
==========================================================================================
import React from 'react'
import { Routes, Route, Navigate } from 'react-router-dom'
import { Header } from './components/Header'
import { Footer } from './components/Footer'
import { TopBar } from './components/TopBar'
import { BetaBanner } from './components/BetaBanner'
import { LocationRequired } from './components/LocationRequired'
import { useAuth } from './auth'

// صفحات المستخدم
import { Landing } from './pages/Landing'
import { RestaurantsPage } from './pages/RestaurantsPage'
import { MenuPage } from './pages/MenuPage'
import { CartPage } from './pages/CartPage'
import { Login } from './pages/Login'
import { Register } from './pages/Register'
import { CustomerLogin } from './pages/CustomerLogin'
import PrivacyPolicy from './pages/PrivacyPolicy'
import AccountDeleted from './pages/AccountDeleted'

// صفحات العميل
import { CheckoutPage } from './pages/CheckoutPage'
import { TrackOrders } from './pages/TrackOrders'
import { ProfileEdit } from './pages/ProfileEdit'

// صفحات صاحب المطعم
import { OwnerDashboard } from './pages/OwnerDashboard'
import { ManageMenu } from './pages/ManageMenu'
import { OrdersAdmin } from './pages/OrdersAdmin'
import { EditRestaurant } from './pages/EditRestaurant'
import { CourierRequests } from './pages/CourierRequests'
import { PackagesPage } from './pages/PackagesPage'
import { PromotionPage } from './pages/PromotionPage'

// صفحات المندوب
import { CourierApp } from './pages/CourierApp'
import { CourierHiring } from './pages/CourierHiring'
import { ChatPage } from './pages/ChatPage'

// صفحة الإشعارات
import { NotificationsPage } from './pages/NotificationsPage'

// صفحة الدعم الفني المباشر
import { LiveSupportPage } from './pages/LiveSupportPage'

// صفحات الإدمن والمطور
import { AdminDashboard } from './pages/AdminDashboard'
import { AdminRestaurants } from './pages/AdminRestaurants'
import { AdminOrders } from './pages/AdminOrders'
import { Developer } from './pages/Developer'
import { SetupDeveloper } from './pages/SetupDeveloper'
import { SupportAdmin } from './pages/SupportAdmin'
import { ProblemsAdmin } from './pages/ProblemsAdmin'

// مسارات محمية
import { ProtectedRoute } from './routes/ProtectedRoute'
import { RoleGate } from './routes/RoleGate'

// صفحة تصحيح الطلبات
import { DebugOrders } from './pages/DebugOrders'

export default function App() {
  const { locationRequired, refreshUserData, loading } = useAuth()

  // إذا كان الموقع مطلوب، نعرض صفحة تحديد الموقع
  if (!loading && locationRequired) {
    return <LocationRequired onLocationSaved={refreshUserData} />
  }

  return (
    <div className="min-h-screen flex flex-col bg-gradient-to-b from-sky-50 via-white to-sky-50 text-sky-900">
      {/* الشريط العلوي + رأس الصفحة - ثابتين في أعلى الشاشة تماماً */}
      <div className="fixed top-0 left-0 right-0 z-50">
        <BetaBanner />
        <TopBar />
        <Header />
      </div>

      {/* مسافة فارغة بحجم الهيدر */}
      <div className="h-[130px] sm:h-[150px]" />

      {/* المحتوى الرئيسي */}
      <main className="flex-1 max-w-6xl mx-auto w-full px-4 py-8">
        <Routes>
          {/* الصفحة الرئيسية */}
          <Route path="/" element={<Landing />} />

          {/* صفحات المطاعم */}
          <Route path="/restaurants" element={<RestaurantsPage />} />
          <Route path="/menu" element={<MenuPage />} />
          <Route path="/cart" element={<CartPage />} />
          <Route path="/login" element={<Login />} />
          <Route path="/customer-login" element={<CustomerLogin />} />
          <Route path="/register" element={<Register />} />
          <Route path="/privacy-policy" element={<PrivacyPolicy />} />
          <Route path="/account-deleted" element={<AccountDeleted />} />
          <Route path="/setup-dev" element={<SetupDeveloper />} />

          {/* صفحة المحادثة */}
          <Route
            path="/chat"
            element={
              <ProtectedRoute>
                <RoleGate allow={['customer', 'courier', 'owner', 'admin', 'developer']}>
                  <ChatPage />
                </RoleGate>
              </ProtectedRoute>
            }
          />

          {/* صفحة الإشعارات */}
          <Route
            path="/notifications"
            element={
              <ProtectedRoute>
                <RoleGate allow={['customer', 'courier', 'owner', 'admin', 'developer']}>
                  <NotificationsPage />
                </RoleGate>
              </ProtectedRoute>
            }
          />

          {/* صفحة الدعم الفني المباشر */}
          <Route
            path="/support"
            element={
              <ProtectedRoute>
                <RoleGate allow={['customer', 'courier', 'owner', 'admin', 'developer']}>
                  <LiveSupportPage />
                </RoleGate>
              </ProtectedRoute>
            }
          />

          {/* صفحات العميل */}
          <Route
            path="/checkout"
            element={
              <ProtectedRoute>
                <RoleGate allow={['customer', 'admin', 'developer']}>
                  <CheckoutPage />
                </RoleGate>
              </ProtectedRoute>
            }
          />
          <Route
            path="/orders"
            element={
              <ProtectedRoute>
                <RoleGate allow={['customer', 'admin', 'developer']}>
                  <TrackOrders />
                </RoleGate>
              </ProtectedRoute>
            }
          />
          <Route
            path="/profile"
            element={
              <ProtectedRoute>
                <RoleGate allow={['customer', 'courier', 'owner', 'admin', 'developer']}>
                  <ProfileEdit />
                </RoleGate>
              </ProtectedRoute>
            }
          />

          {/* صفحات صاحب المطعم */}
          <Route
            path="/owner"
            element={
              <ProtectedRoute>
                <RoleGate allow={['owner', 'developer']}>
                  <OwnerDashboard />
                </RoleGate>
              </ProtectedRoute>
            }
          />
          <Route
            path="/owner/menu"
            element={
              <ProtectedRoute>
                <RoleGate allow={['owner', 'developer']}>
                  <ManageMenu />
                </RoleGate>
              </ProtectedRoute>
            }
          />
          <Route
            path="/owner/orders"
            element={
              <ProtectedRoute>
                <RoleGate allow={['owner', 'developer']}>
                  <OrdersAdmin />
                </RoleGate>
              </ProtectedRoute>
            }
          />
          <Route
            path="/owner/edit"
            element={
              <ProtectedRoute>
                <RoleGate allow={['owner', 'developer']}>
                  <EditRestaurant />
                </RoleGate>
              </ProtectedRoute>
            }
          />
          <Route
            path="/owner/courier-requests"
            element={
              <ProtectedRoute>
                <RoleGate allow={['owner', 'developer']}>
                  <CourierRequests />
                </RoleGate>
              </ProtectedRoute>
            }
          />
          <Route
            path="/owner/packages"
            element={
              <ProtectedRoute>
                <RoleGate allow={['owner', 'developer']}>
                  <PackagesPage />
                </RoleGate>
              </ProtectedRoute>
            }
          />
          <Route
            path="/owner/promotion"
            element={
              <ProtectedRoute>
                <RoleGate allow={['owner', 'developer']}>
                  <PromotionPage />
                </RoleGate>
              </ProtectedRoute>
            }
          />

          {/* صفحات المندوب */}
          <Route
            path="/courier"
            element={
              <ProtectedRoute>
                <RoleGate allow={['courier', 'developer']}>
                  <CourierApp />
                </RoleGate>
              </ProtectedRoute>
            }
          />
          <Route
            path="/courier/hiring"
            element={
              <ProtectedRoute>
                <RoleGate allow={['courier', 'developer']}>
                  <CourierHiring />
                </RoleGate>
              </ProtectedRoute>
            }
          />

          {/* صفحات الإدمن (المشرف) */}
          <Route
            path="/admin"
            element={
              <ProtectedRoute>
                <RoleGate allow={['admin', 'developer']}>
                  <AdminDashboard />
                </RoleGate>
              </ProtectedRoute>
            }
          />
          <Route
            path="/admin/restaurants"
            element={
              <ProtectedRoute>
                <RoleGate allow={['admin', 'developer']}>
                  <AdminRestaurants />
                </RoleGate>
              </ProtectedRoute>
            }
          />
          <Route
            path="/admin/orders"
            element={
              <ProtectedRoute>
                <RoleGate allow={['admin', 'developer']}>
                  <AdminOrders />
                </RoleGate>
              </ProtectedRoute>
            }
          />

          {/* صفحة المطور */}
          <Route
            path="/developer"
            element={
              <ProtectedRoute>
                <RoleGate allow={['developer', 'admin']}>
                  <Developer />
                </RoleGate>
              </ProtectedRoute>
            }
          />

          {/* إدارة الدعم الفني */}
          <Route
            path="/support-admin"
            element={
              <ProtectedRoute>
                <RoleGate allow={['developer']}>
                  <SupportAdmin />
                </RoleGate>
              </ProtectedRoute>
            }
          />

          {/* مركز مراقبة المشاكل */}
          <Route
            path="/problems-admin"
            element={
              <ProtectedRoute>
                <RoleGate allow={['developer']}>
                  <ProblemsAdmin />
                </RoleGate>
              </ProtectedRoute>
            }
          />

          {/* صفحة تصحيح الطلبات */}
          <Route path="/__debug_orders" element={<DebugOrders />} />

          {/* صفحة 404 */}
          <Route path="*" element={<Navigate to="/" replace />} />
        </Routes>
      </main>

      {/* الفوتر */}
      <Footer />
    </div>
  )
}

==========================================================================================
FILE: src/auth.tsx
==========================================================================================
import React, { createContext, useContext, useEffect, useState } from 'react'
import { onAuthStateChanged, signOut, User } from 'firebase/auth'
import { auth, db } from './firebase'
import { doc, getDoc, setDoc, updateDoc } from 'firebase/firestore'

type Role = 'owner' | 'courier' | 'customer' | 'admin' | 'developer'
type GeoLocation = { lat: number; lng: number }

// مفتاح للتحقق من تحديد الموقع في هذه الجلسة
const SESSION_LOCATION_KEY = 'broast_session_location'

type AuthContextType = {
  user: User | null,
  role: Role | null,
  loading: boolean,
  logout: () => Promise<void>,
  userLocation: GeoLocation | null,
  locationRequired: boolean,
  refreshUserData: () => Promise<void>,
}

const AuthContext = createContext<AuthContextType>({
  user: null,
  role: null,
  loading: true,
  logout: async () => {},
  userLocation: null,
  locationRequired: false,
  refreshUserData: async () => {},
})

export const AuthProvider: React.FC<{children: React.ReactNode}> = ({ children }) => {
  const [user, setUser] = useState<User | null>(null)
  const [role, setRole] = useState<Role | null>(null)
  const [loading, setLoading] = useState(true)
  const [userLocation, setUserLocation] = useState<GeoLocation | null>(null)
  const [locationRequired, setLocationRequired] = useState(false)

  // دالة لتحديث بيانات المستخدم (تُستدعى بعد حفظ الموقع)
  const refreshUserData = async () => {
    if (!user) return
    const snap = await getDoc(doc(db, 'users', user.uid))
    if (snap.exists()) {
      const data = snap.data()
      const r = data?.role as Role | undefined
      const loc = data?.location as GeoLocation | undefined
      const customerSavedLoc = data?.savedLocation as { lat: number; lng: number; address: string } | undefined
      
      // للعميل: استخدام savedLocation، لغيرهم: location
      if (r === 'customer' || r === 'admin') {
        const customerLoc = customerSavedLoc 
          ? { lat: customerSavedLoc.lat, lng: customerSavedLoc.lng }
          : loc || null
        setUserLocation(customerLoc)
        if (customerLoc) {
          sessionStorage.setItem(SESSION_LOCATION_KEY, JSON.stringify(customerLoc))
        }
      } else {
        setUserLocation(loc || null)
        if (loc) {
          sessionStorage.setItem(SESSION_LOCATION_KEY, JSON.stringify(loc))
        }
      }
      setLocationRequired(false)
    }
  }

  useEffect(() => {
    const unsub = onAuthStateChanged(auth, async (u) => {
      setUser(u)
      if (u) {
        const snap = await getDoc(doc(db, 'users', u.uid))
        const data = snap.data()
        const r = snap.exists() ? (data?.role as Role) : null
        setRole(r)
        
        // التحقق من الموقع - للعميل نستخدم savedLocation، لغيرهم location
        const savedLoc = data?.location as GeoLocation | undefined
        const customerSavedLoc = data?.savedLocation as { lat: number; lng: number; address: string } | undefined
        
        // التحقق من موقع الجلسة الحالية
        const sessionLocStr = sessionStorage.getItem(SESSION_LOCATION_KEY)
        const sessionLoc = sessionLocStr ? JSON.parse(sessionLocStr) as GeoLocation : null
        
        // للعميل: استخدام savedLocation المحفوظ في الملف الشخصي
        // لغيرهم: استخدام location العادي
        let currentLoc: GeoLocation | null = null
        if (r === 'customer' || r === 'admin') {
          // العميل/المشرف: الأولوية للموقع المحفوظ في الحساب
          currentLoc = customerSavedLoc 
            ? { lat: customerSavedLoc.lat, lng: customerSavedLoc.lng }
            : sessionLoc || savedLoc || null
        } else {
          currentLoc = sessionLoc || savedLoc || null
        }
        setUserLocation(currentLoc)
        
        // تحديد ما إذا كان الموقع مطلوباً
        if (r === 'customer' || r === 'admin') {
          // العميل/المشرف: لا يُطلب الموقع إذا كان محفوظاً في حسابه أو في الجلسة
          const hasLocation = !!customerSavedLoc || !!sessionLoc
          
          //  إذا لم يكن هناك موقع، نحاول تحديده تلقائياً
          if (!hasLocation && navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(
              async (pos) => {
                const autoLocation = {
                  lat: pos.coords.latitude,
                  lng: pos.coords.longitude,
                  address: 'موقعي الحالي (تلقائي)'
                }
                // حفظ الموقع في الحساب
                try {
                  await updateDoc(doc(db, 'users', u.uid), {
                    savedLocation: autoLocation,
                    location: { lat: autoLocation.lat, lng: autoLocation.lng }
                  })
                  // تحديث الحالة المحلية
                  setUserLocation({ lat: autoLocation.lat, lng: autoLocation.lng })
                  sessionStorage.setItem(SESSION_LOCATION_KEY, JSON.stringify({ lat: autoLocation.lat, lng: autoLocation.lng }))
                  setLocationRequired(false)
                } catch (err) {
                  console.warn('تعذر حفظ الموقع التلقائي:', err)
                }
              },
              (err) => {
                console.warn('تعذر تحديد الموقع تلقائياً:', err)
                // لم نتمكن من تحديد الموقع، نطلبه يدوياً
                setLocationRequired(true)
              },
              { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 }
            )
          } else {
            setLocationRequired(!hasLocation)
          }
          
          // إذا كان عنده موقع محفوظ، نحفظه في sessionStorage للاستخدام السريع
          if (customerSavedLoc && !sessionLoc) {
            sessionStorage.setItem(SESSION_LOCATION_KEY, JSON.stringify({ lat: customerSavedLoc.lat, lng: customerSavedLoc.lng }))
          }
        } else if (r === 'owner' || r === 'courier') {
          // المندوب وصاحب المطعم: يطلب الموقع فقط إذا لم يحفظ من قبل
          setLocationRequired(!savedLoc)
        } else {
          setLocationRequired(false)
        }

        // تأكد من وجود مستند المطعم لأصحاب المطاعم
        if (r === 'owner') {
          try {
            const restRef = doc(db, 'restaurants', u.uid)
            const restSnap = await getDoc(restRef)
            if (!restSnap.exists()) {
              await setDoc(restRef, {
                name: data?.restaurantName || data?.name || 'مطعم جديد',
                ownerId: u.uid,
                email: data?.email || u.email || '',
                phone: '',
                city: '',
                location: '',
                logoUrl: '',
              }, { merge: true })
            }
          } catch (err) {
            console.warn('تعذر إنشاء مستند المطعم للمالك', err)
          }
        }
      } else {
        setRole(null)
        setUserLocation(null)
        setLocationRequired(false)
      }
      setLoading(false)
    })
    return () => unsub()
  }, [])

  const logout = async () => { await signOut(auth) }

  return (
    <AuthContext.Provider value={{ user, role, loading, logout, userLocation, locationRequired, refreshUserData }}>
      {children}
    </AuthContext.Provider>
  )
}

export const useAuth = () => useContext(AuthContext)

==========================================================================================
FILE: src/components/BetaBanner.tsx
==========================================================================================
// src/components/BetaBanner.tsx
import React from 'react'
import { FlaskConical } from 'lucide-react'

export const BetaBanner: React.FC = () => {
  return (
    <div className="w-full bg-gradient-to-r from-amber-500 via-orange-500 to-amber-500 text-white py-1.5 overflow-hidden">
      <div className="flex items-center justify-center gap-2">
        <FlaskConical className="w-4 h-4 text-white animate-pulse flex-shrink-0" />
        <div className="beta-marquee whitespace-nowrap font-bold text-xs tracking-wide">
           التطبيق في المرحلة التجريبية (Beta) — نعمل على تحسينه باستمرار! 
        </div>
        <FlaskConical className="w-4 h-4 text-white animate-pulse flex-shrink-0" />
      </div>
    </div>
  )
}

==========================================================================================
FILE: src/components/Button.tsx
==========================================================================================
// src/components/Button.tsx
import React from "react"

type ButtonProps = {
  children: React.ReactNode
  onClick?: () => void
  type?: "button" | "submit" | "reset"
  disabled?: boolean
  className?: string
}

export const Button: React.FC<ButtonProps> = ({
  children,
  onClick,
  type = "button",
  disabled = false,
  className = "",
}) => {
  return (
    <button
      type={type}
      onClick={onClick}
      disabled={disabled}
      className={`
        bg-yellow-500 hover:bg-yellow-600 text-black font-bold px-4 py-2 
        rounded-xl shadow-md transition transform hover:scale-105
        disabled:opacity-50 disabled:cursor-not-allowed
        ${className}
      `}
    >
      {children}
    </button>
  )
}

==========================================================================================
FILE: src/components/Footer.tsx
==========================================================================================
import React from "react";
import { Link, useNavigate } from "react-router-dom";
import { auth, db } from "@/firebase";
import { deleteUser } from "firebase/auth";
import { doc, deleteDoc } from "firebase/firestore";
import { useAuth } from "@/auth";
import { Heart, Shield, Trash2, Code2 } from "lucide-react";
import { useDialog } from "@/components/ui/ConfirmDialog";

export const Footer: React.FC = () => {
  const { user } = useAuth();
  const navigate = useNavigate();
  const dialog = useDialog();

  const handleDeleteAccount = async () => {
    if (!user) return;

    const confirmDelete = await dialog.confirm(
      'هذا الإجراء لا يمكن التراجع عنه. سيتم حذف جميع بياناتك نهائيًا.',
      { title: 'حذف الحساب نهائيًا؟', dangerous: true, confirmText: 'نعم، احذف حسابي', cancelText: 'إلغاء' }
    );
    if (!confirmDelete) return;

    try {
      await deleteDoc(doc(db, "users", user.uid));
      await deleteUser(auth.currentUser!);

      dialog.success('تم حذف حسابك بنجاح');
      navigate("/account-deleted");
    } catch (error: any) {
      console.error("Error deleting account:", error);
      dialog.error('حدث خطأ أثناء حذف الحساب. يرجى المحاولة لاحقًا.');
    }
  };

  return (
    <footer className="bg-gradient-to-b from-sky-600 to-sky-700 text-white text-center py-8 sm:py-10 mt-12 sm:mt-16 shadow-[0_-10px_40px_rgba(14,165,233,0.2)]">
      <div className="max-w-4xl mx-auto flex flex-col items-center gap-4 sm:gap-6 px-4">
        
        {/* الشعار */}
        <div className="flex items-center gap-2 sm:gap-3">
          <div className="w-10 h-10 sm:w-12 sm:h-12 bg-white rounded-xl sm:rounded-2xl flex items-center justify-center shadow-lg">
            <span className="text-2xl sm:text-3xl"></span>
          </div>
          <span className="text-xl sm:text-2xl font-black">سفرة البيت</span>
        </div>

        {/* النص الرئيسي */}
        <p className="text-xs sm:text-sm md:text-base font-medium text-sky-100 flex items-center gap-2">
          صنع بـ <Heart className="w-3 h-3 sm:w-4 sm:h-4 text-red-400 fill-red-400" /> في السعودية  {new Date().getFullYear()}
        </p>

        {/* الأزرار */}
        <div className="flex flex-wrap justify-center items-center gap-2 sm:gap-3">
          {/* سياسة الخصوصية */}
          <Link
            to="/privacy-policy"
            className="flex items-center gap-1.5 sm:gap-2 bg-white/20 backdrop-blur-sm text-white font-semibold px-3 sm:px-5 py-2 sm:py-2.5 rounded-xl sm:rounded-2xl hover:bg-white/30 hover:scale-105 transition-all duration-300 text-xs sm:text-sm"
          >
            <Shield className="w-3 h-3 sm:w-4 sm:h-4" />
            الخصوصية
          </Link>

          {/* المطور */}
          <Link
            to="/developer"
            className="flex items-center gap-1.5 sm:gap-2 bg-white/20 backdrop-blur-sm text-white font-semibold px-3 sm:px-5 py-2 sm:py-2.5 rounded-xl sm:rounded-2xl hover:bg-white/30 hover:scale-105 transition-all duration-300 text-xs sm:text-sm"
          >
            <Code2 className="w-3 h-3 sm:w-4 sm:h-4" />
            المطور
          </Link>

          {/* حذف الحساب */}
          {user && (
            <button
              onClick={handleDeleteAccount}
              className="flex items-center gap-1.5 sm:gap-2 bg-red-500/80 backdrop-blur-sm text-white font-semibold px-3 sm:px-5 py-2 sm:py-2.5 rounded-xl sm:rounded-2xl hover:bg-red-500 hover:scale-105 transition-all duration-300 text-xs sm:text-sm"
            >
              <Trash2 className="w-3 h-3 sm:w-4 sm:h-4" />
              حذف حسابي
            </button>
          )}
        </div>

        {/* خط فاصل */}
        <div className="w-24 sm:w-32 h-1 bg-white/20 rounded-full"></div>

        {/* حقوق النشر */}
        <p className="text-[10px] sm:text-xs text-sky-200">
          جميع الحقوق محفوظة لـ سفرة البيت
        </p>
      </div>
    </footer>
  );
};

==========================================================================================
FILE: src/components/Header.tsx
==========================================================================================
// src/components/Header.tsx
import React, { useState, useEffect } from "react";
import { Link, useLocation, useNavigate } from "react-router-dom";
import { useAuth } from "@/auth";
import { Menu, X, Home, ShoppingCart, Package, Store, Truck, Shield, Code2, ArrowRight, User, Bell, Headphones } from "lucide-react";
import { db } from "@/firebase";
import { collection, query, where, onSnapshot } from "firebase/firestore";

const NavLink: React.FC<{ to: string; label: string; icon?: React.ReactNode; onClick?: () => void }> = ({
  to,
  label,
  icon,
  onClick,
}) => {
  const { pathname } = useLocation();
  const active = pathname === to;
  return (
    <Link
      to={to}
      onClick={onClick}
      className={
        "flex items-center gap-2 px-4 py-3 sm:py-2.5 rounded-2xl text-sm font-bold transition-all duration-300 " +
        (active
          ? "bg-white text-sky-600 shadow-lg shadow-sky-200/50 scale-105"
          : "text-white/90 hover:text-white hover:bg-white/20 backdrop-blur-sm")
      }
    >
      {icon}
      <span>{label}</span>
    </Link>
  );
};

export const Header: React.FC = () => {
  const { user, role, logout } = useAuth();
  const [open, setOpen] = useState(false);
  const [unreadCount, setUnreadCount] = useState(0);
  const location = useLocation();
  const navigate = useNavigate();

  // هل نحن في الصفحة الرئيسية؟
  const isHome = location.pathname === '/';

  // إغلاق القائمة عند تغيير الصفحة
  useEffect(() => {
    setOpen(false);
  }, [location.pathname]);

  // منع التمرير عند فتح القائمة
  useEffect(() => {
    if (open) {
      document.body.style.overflow = 'hidden';
    } else {
      document.body.style.overflow = '';
    }
    return () => { document.body.style.overflow = ''; };
  }, [open]);

  // مراقبة عدد الإشعارات غير المقروءة
  useEffect(() => {
    if (!user?.uid) {
      setUnreadCount(0);
      return;
    }

    const q = query(
      collection(db, 'notifications'),
      where('recipientId', '==', user.uid),
      where('read', '==', false)
    );

    const unsub = onSnapshot(q, (snap) => {
      setUnreadCount(snap.size);
    }, (error) => {
      console.warn('Notifications listener error:', error);
      setUnreadCount(0);
    });

    return () => unsub();
  }, [user?.uid]); //  استخدم user.uid بدلاً من user object

  return (
    <header className="bg-gradient-to-r from-sky-600/95 via-sky-500/95 to-sky-600/95 backdrop-blur-lg shadow-xl shadow-sky-200/30">
      <div className="max-w-6xl mx-auto px-3 sm:px-4 py-3 sm:py-4 flex items-center justify-between">
        {/* زر الرجوع + شعار */}
        <div className="flex items-center gap-2">
          {/* زر الرجوع - يظهر فقط إذا لم نكن في الصفحة الرئيسية */}
          {!isHome && (
            <button
              onClick={() => navigate(-1)}
              className="w-9 h-9 sm:w-10 sm:h-10 bg-white/20 hover:bg-white/30 rounded-xl flex items-center justify-center text-white transition-all"
              aria-label="رجوع"
            >
              <ArrowRight className="w-5 h-5" />
            </button>
          )}
          
          <button
            onClick={() => window.location.href = '/'}
            className="text-xl sm:text-2xl font-black text-white flex items-center gap-2 sm:gap-3 hover:scale-105 transition-transform drop-shadow-lg"
          >
            <div className="w-9 h-9 sm:w-10 sm:h-10 bg-white rounded-xl sm:rounded-2xl flex items-center justify-center shadow-lg">
              <span className="text-xl sm:text-2xl"></span>
            </div>
            <span className="text-lg sm:text-2xl">سفرة البيت</span>
          </button>
        </div>

        {/* أزرار الديسكتوب */}
        <nav className="hidden md:flex items-center gap-1 lg:gap-2">
          <NavLink to="/restaurants" label="المطاعم" icon={<Store className="w-4 h-4" />} />

          {/*  العميل فقط */}
          {role === "customer" && (
            <>
              <NavLink to="/cart" label=" السلة" />
              <NavLink to="/orders" label="طلباتي" />
              <NavLink to="/profile" label="بياناتي" icon={<User className="w-4 h-4" />} />
            </>
          )}

          {/*  صاحب المطعم */}
          {role === "owner" && (
            <>
              <NavLink to="/owner" label="لوحة المطعم" />
              <NavLink to="/owner/orders" label="طلبات المطعم" />
              <NavLink to="/owner/courier-requests" label="المندوبين" />
            </>
          )}

          {/*  المندوب */}
          {role === "courier" && (
            <>
              <NavLink to="/courier" label="واجهة المندوب" />
              <NavLink to="/courier/hiring" label="التوظيف" />
            </>
          )}

          {/*  الإدمن */}
          {role === "admin" && (
            <NavLink to="/admin" label="لوحة الإدارة" />
          )}

          {/*  المطور */}
          {role === "developer" && (
            <NavLink to="/developer" label="لوحة المطور" />
          )}

          {/*  زر الإشعارات */}
          {user && (
            <Link
              to="/notifications"
              className="relative p-2.5 rounded-xl bg-white/20 hover:bg-white/30 transition text-white"
              title="الإشعارات"
            >
              <Bell className="w-5 h-5" />
              {unreadCount > 0 && (
                <span className="absolute -top-1 -right-1 w-5 h-5 bg-red-500 text-white text-xs rounded-full flex items-center justify-center font-bold animate-pulse">
                  {unreadCount > 9 ? '9+' : unreadCount}
                </span>
              )}
            </Link>
          )}

          {/*  زر الدعم الفني */}
          {user && (
            <Link
              to="/support"
              className="p-2.5 rounded-xl bg-white/20 hover:bg-white/30 transition text-white"
              title="الدعم الفني / شكوى"
            >
              <Headphones className="w-5 h-5" />
            </Link>
          )}

          {/* دخول/خروج */}
          {user ? (
            <button
              onClick={logout}
              className="px-5 py-2.5 rounded-2xl text-sm font-bold text-sky-600 bg-white shadow-lg hover:shadow-xl hover:scale-105 transition-all duration-300"
            >
              خروج
            </button>
          ) : (
            <NavLink to="/login" label="دخول" />
          )}
        </nav>

        {/* زر المينيو للجوال */}
        <button
          className="md:hidden p-2.5 rounded-2xl bg-white/20 hover:bg-white/30 transition backdrop-blur-sm"
          onClick={() => setOpen(!open)}
        >
          {open ? (
            <X className="w-6 h-6 text-white" />
          ) : (
            <Menu className="w-6 h-6 text-white" />
          )}
        </button>
      </div>

      {/* overlay خلفية */}
      {open && (
        <div 
          className="fixed inset-0 bg-black/50 z-40 md:hidden backdrop-blur-sm"
          onClick={() => setOpen(false)}
        />
      )}

      {/* قائمة الجوال المنزلقة */}
      <div className={`
        fixed top-0 right-0 h-full w-72 max-w-[80vw] bg-gradient-to-b from-sky-500 to-sky-700 
        z-50 md:hidden transform transition-transform duration-300 ease-out shadow-2xl
        ${open ? 'translate-x-0' : 'translate-x-full'}
      `}>
        {/* رأس القائمة */}
        <div className="flex items-center justify-between p-4 border-b border-white/20">
          <span className="text-white font-bold text-lg">القائمة</span>
          <button 
            onClick={() => setOpen(false)}
            className="p-2 rounded-xl bg-white/20 hover:bg-white/30 transition"
          >
            <X className="w-5 h-5 text-white" />
          </button>
        </div>

        {/* روابط القائمة */}
        <div className="p-4 flex flex-col gap-2 overflow-y-auto max-h-[calc(100vh-80px)]">
          <NavLink
            to="/restaurants"
            label="المطاعم"
            icon={<Store className="w-5 h-5" />}
            onClick={() => setOpen(false)}
          />

          {/*  العميل فقط */}
          {role === "customer" && (
            <>
              <NavLink
                to="/cart"
                label="السلة"
                icon={<ShoppingCart className="w-5 h-5" />}
                onClick={() => setOpen(false)}
              />
              <NavLink
                to="/orders"
                label="طلباتي"
                icon={<Package className="w-5 h-5" />}
                onClick={() => setOpen(false)}
              />
              <NavLink
                to="/profile"
                label="بياناتي"
                icon={<User className="w-5 h-5" />}
                onClick={() => setOpen(false)}
              />
            </>
          )}

          {/*  صاحب المطعم */}
          {role === "owner" && (
            <>
              <NavLink
                to="/owner"
                label="لوحة المطعم"
                icon={<Home className="w-5 h-5" />}
                onClick={() => setOpen(false)}
              />
              <NavLink
                to="/owner/orders"
                label="طلبات المطعم"
                icon={<Package className="w-5 h-5" />}
                onClick={() => setOpen(false)}
              />
              <NavLink
                to="/owner/courier-requests"
                label="المندوبين"
                icon={<Truck className="w-5 h-5" />}
                onClick={() => setOpen(false)}
              />
            </>
          )}

          {/*  المندوب */}
          {role === "courier" && (
            <>
              <NavLink
                to="/courier"
                label="واجهة المندوب"
                icon={<Truck className="w-5 h-5" />}
                onClick={() => setOpen(false)}
              />
              <NavLink
                to="/courier/hiring"
                label="التوظيف"
                icon={<Package className="w-5 h-5" />}
                onClick={() => setOpen(false)}
              />
            </>
          )}

          {/*  الإدمن */}
          {role === "admin" && (
            <NavLink 
              to="/admin" 
              label="لوحة الإدارة" 
              icon={<Shield className="w-5 h-5" />}
              onClick={() => setOpen(false)} 
            />
          )}

          {/*  المطور */}
          {role === "developer" && (
            <NavLink 
              to="/developer" 
              label="لوحة المطور" 
              icon={<Code2 className="w-5 h-5" />}
              onClick={() => setOpen(false)} 
            />
          )}

          {/*  الإشعارات */}
          {user && (
            <NavLink 
              to="/notifications" 
              label={`الإشعارات ${unreadCount > 0 ? `(${unreadCount})` : ''}`}
              icon={<Bell className="w-5 h-5" />}
              onClick={() => setOpen(false)} 
            />
          )}

          {/*  الدعم الفني */}
          {user && (
            <NavLink 
              to="/support" 
              label="الدعم الفني / شكوى"
              icon={<Headphones className="w-5 h-5" />}
              onClick={() => setOpen(false)} 
            />
          )}

          {/* فاصل */}
          <div className="h-px bg-white/20 my-2"></div>

          {user ? (
            <button
              onClick={() => {
                logout();
                setOpen(false);
              }}
              className="w-full mt-2 px-5 py-3 rounded-2xl text-sm font-bold text-sky-600 bg-white shadow-lg hover:scale-105 transition-all duration-300 text-center"
            >
               تسجيل الخروج
            </button>
          ) : (
            <NavLink
              to="/login"
              label="تسجيل الدخول"
              icon={<Home className="w-5 h-5" />}
              onClick={() => setOpen(false)}
            />
          )}
        </div>
      </div>
    </header>
  );
};

==========================================================================================
FILE: src/components/LocationPicker.tsx
==========================================================================================
// src/components/LocationPicker.tsx
import React, { useState, useEffect, useCallback } from 'react'
import { MapPin, Navigation, Check, X, Loader2, Target, Smartphone, Search, PenLine, Map } from 'lucide-react'

type Location = { lat: number; lng: number }

type SearchResult = {
  display_name: string
  lat: string
  lon: string
}

type Props = {
  isOpen: boolean
  onClose: () => void
  onConfirm: (location: Location, address: string) => void
  initialLocation?: Location | null
}

export const LocationPicker: React.FC<Props> = ({ isOpen, onClose, onConfirm, initialLocation }) => {
  const [location, setLocation] = useState<Location | null>(initialLocation || null)
  const [address, setAddress] = useState('')
  const [loading, setLoading] = useState(false)
  const [gpsLoading, setGpsLoading] = useState(false)
  const [error, setError] = useState<string | null>(null)
  const [mapReady, setMapReady] = useState(false)
  const [searchQuery, setSearchQuery] = useState('')
  const [searchResults, setSearchResults] = useState<SearchResult[]>([])
  const [searchLoading, setSearchLoading] = useState(false)
  const [showResults, setShowResults] = useState(false)
  // وضع الإدخال: الخريطة أو يدوي
  const [inputMode, setInputMode] = useState<'map' | 'manual'>('map')

  //  موقع افتراضي (الرياض)
  const defaultLocation: Location = { lat: 24.7136, lng: 46.6753 }

  //  البحث عن المناطق
  const searchPlaces = useCallback(async (query: string) => {
    if (!query.trim() || query.length < 2) {
      setSearchResults([])
      setShowResults(false)
      return
    }

    setSearchLoading(true)
    try {
      // إضافة "السعودية" للبحث لتحسين النتائج
      const searchTerm = query.includes('السعودية') ? query : `${query}, السعودية`
      const response = await fetch(
        `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(searchTerm)}&limit=5&accept-language=ar`,
        {
          headers: {
            'Accept': 'application/json',
          }
        }
      )
      const data = await response.json()
      setSearchResults(data)
      setShowResults(data.length > 0)
    } catch (err) {
      console.error('خطأ في البحث:', err)
      setSearchResults([])
    } finally {
      setSearchLoading(false)
    }
  }, [])

  //  اختيار نتيجة بحث
  const selectSearchResult = useCallback((result: SearchResult) => {
    const newLoc = { lat: parseFloat(result.lat), lng: parseFloat(result.lon) }
    setLocation(newLoc)
    setSearchQuery('')
    setSearchResults([])
    setShowResults(false)
    
    // تحريك الخريطة للموقع المختار
    if ((window as any).leafletMap) {
      (window as any).leafletMap.setView([newLoc.lat, newLoc.lng], 16, {
        animate: true,
        duration: 0.5
      })
      if ((window as any).leafletMarker) {
        (window as any).leafletMarker.setLatLng([newLoc.lat, newLoc.lng])
      }
    }
    
    // استخدام اسم المكان كجزء من العنوان
    const shortName = result.display_name.split(',').slice(0, 3).join('،')
    setAddress(shortName)
  }, [])

  //  تحديد الموقع عبر GPS
  const getGPSLocation = useCallback(() => {
    if (!navigator.geolocation) {
      setError('المتصفح لا يدعم تحديد الموقع')
      return
    }

    setGpsLoading(true)
    setError(null)

    navigator.geolocation.getCurrentPosition(
      (pos) => {
        const newLoc = { lat: pos.coords.latitude, lng: pos.coords.longitude }
        setLocation(newLoc)
        setGpsLoading(false)
        // تحديث الخريطة
        if ((window as any).leafletMap) {
          (window as any).leafletMap.setView([newLoc.lat, newLoc.lng], 17)
          if ((window as any).leafletMarker) {
            (window as any).leafletMarker.setLatLng([newLoc.lat, newLoc.lng])
          }
        }
      },
      (err) => {
        setGpsLoading(false)
        if (err.code === 1) {
          setError('تم رفض إذن الموقع. فعّل الموقع من إعدادات المتصفح')
        } else if (err.code === 2) {
          setError('تعذر تحديد الموقع. تأكد من تفعيل GPS')
        } else {
          setError('انتهت مهلة تحديد الموقع. حاول مرة أخرى')
        }
      },
      { 
        enableHighAccuracy: true, 
        timeout: 15000,
        maximumAge: 0 
      }
    )
  }, [])

  //  تحميل Leaflet
  useEffect(() => {
    if (!isOpen) return

    // تحميل CSS
    if (!document.getElementById('leaflet-css')) {
      const link = document.createElement('link')
      link.id = 'leaflet-css'
      link.rel = 'stylesheet'
      link.href = 'https://unpkg.com/leaflet@1.9.4/dist/leaflet.css'
      document.head.appendChild(link)
    }

    // تحميل JS
    if (!(window as any).L) {
      const script = document.createElement('script')
      script.src = 'https://unpkg.com/leaflet@1.9.4/dist/leaflet.js'
      script.onload = () => setMapReady(true)
      document.body.appendChild(script)
    } else {
      setMapReady(true)
    }
  }, [isOpen])

  //  إنشاء الخريطة
  useEffect(() => {
    if (!isOpen || !mapReady || !(window as any).L) return

    const L = (window as any).L
    const container = document.getElementById('location-map')
    if (!container) return

    // إزالة خريطة قديمة إن وجدت
    if ((window as any).leafletMap) {
      (window as any).leafletMap.remove()
    }

    const startLoc = location || defaultLocation

    // إنشاء الخريطة
    const map = L.map('location-map', {
      zoomControl: false,
      attributionControl: false,
    }).setView([startLoc.lat, startLoc.lng], location ? 17 : 12)

    // إضافة طبقة الخريطة (OpenStreetMap خفيف وسريع)
    L.tileLayer('[REDACTED_IMAGE_URL]', {
      maxZoom: 19,
    }).addTo(map)

    // أيقونة مخصصة للماركر
    const customIcon = L.divIcon({
      className: 'custom-marker',
      html: `
        <div style="
          width: 50px; 
          height: 50px; 
          background: linear-gradient(135deg, #0EA5E9, #0284C7);
          border-radius: 50% 50% 50% 0;
          transform: rotate(-45deg);
          display: flex;
          align-items: center;
          justify-content: center;
          box-shadow: 0 4px 20px rgba(14, 165, 233, 0.5);
          border: 3px solid white;
        ">
          <div style="transform: rotate(45deg); color: white; font-size: 20px;"></div>
        </div>
      `,
      iconSize: [50, 50],
      iconAnchor: [25, 50],
    })

    // إضافة الماركر
    const marker = L.marker([startLoc.lat, startLoc.lng], { 
      icon: customIcon,
      draggable: true 
    }).addTo(map)

    // تحديث الموقع عند سحب الماركر
    marker.on('dragend', () => {
      const pos = marker.getLatLng()
      setLocation({ lat: pos.lat, lng: pos.lng })
    })

    // تحديث الموقع عند النقر على الخريطة
    map.on('click', (e: any) => {
      const { lat, lng } = e.latlng
      marker.setLatLng([lat, lng])
      setLocation({ lat, lng })
    })

    // حفظ المراجع
    ;(window as any).leafletMap = map
    ;(window as any).leafletMarker = marker

    // تحديث الموقع إذا كان موجود
    if (location) {
      setLocation(location)
    }

    return () => {
      if ((window as any).leafletMap) {
        (window as any).leafletMap.remove()
        ;(window as any).leafletMap = null
        ;(window as any).leafletMarker = null
      }
    }
  }, [isOpen, mapReady])

  //  تمركز على الموقع الحالي
  const centerOnLocation = () => {
    if (location && (window as any).leafletMap) {
      (window as any).leafletMap.setView([location.lat, location.lng], 17, {
        animate: true,
        duration: 0.5
      })
    }
  }

  //  تأكيد الموقع
  const handleConfirm = () => {
    // في الوضع اليدوي، لا نحتاج إحداثيات
    if (inputMode === 'manual') {
      if (!address.trim()) {
        setError('أدخل العنوان التفصيلي')
        return
      }
      // استخدام إحداثيات افتراضية (الرياض) للعنوان اليدوي
      onConfirm({ lat: 24.7136, lng: 46.6753 }, address)
      return
    }
    
    // في وضع الخريطة
    if (!location) {
      setError('حدد موقعك أولاً')
      return
    }
    if (!address.trim()) {
      setError('أدخل وصف العنوان')
      return
    }
    onConfirm(location, address)
  }

  if (!isOpen) return null

  return (
    <div className="fixed inset-0 z-[9999] flex items-center justify-center">
      {/* خلفية معتمة */}
      <div 
        className="absolute inset-0 bg-black/60 backdrop-blur-sm"
        onClick={onClose}
      />

      {/* المحتوى الرئيسي */}
      <div className="relative w-full h-full sm:w-[95%] sm:h-[90%] sm:max-w-2xl sm:rounded-3xl overflow-hidden bg-white shadow-2xl flex flex-col">
        
        {/* الهيدر */}
        <div className="bg-gradient-to-r from-sky-500 to-sky-600 text-white p-4">
          <div className="flex items-center justify-between mb-3">
            <div className="flex items-center gap-3">
              <div className="w-10 h-10 bg-white/20 rounded-xl flex items-center justify-center">
                <MapPin className="w-5 h-5" />
              </div>
              <div>
                <h2 className="font-bold text-lg">تحديد موقع التوصيل</h2>
                <p className="text-sm text-white/80">
                  {inputMode === 'map' ? 'ابحث أو اسحب الدبوس' : 'اكتب عنوانك يدوياً'}
                </p>
              </div>
            </div>
            <button 
              onClick={onClose}
              className="w-10 h-10 bg-white/20 hover:bg-white/30 rounded-xl flex items-center justify-center transition"
            >
              <X className="w-5 h-5" />
            </button>
          </div>
          
          {/*  تبديل الوضع: خريطة / يدوي */}
          <div className="flex gap-2 mb-3">
            <button
              onClick={() => setInputMode('map')}
              className={`flex-1 py-2.5 rounded-xl font-semibold text-sm flex items-center justify-center gap-2 transition ${
                inputMode === 'map' 
                  ? 'bg-white text-sky-600' 
                  : 'bg-white/20 text-white hover:bg-white/30'
              }`}
            >
              <Map className="w-4 h-4" />
              الخريطة
            </button>
            <button
              onClick={() => setInputMode('manual')}
              className={`flex-1 py-2.5 rounded-xl font-semibold text-sm flex items-center justify-center gap-2 transition ${
                inputMode === 'manual' 
                  ? 'bg-white text-sky-600' 
                  : 'bg-white/20 text-white hover:bg-white/30'
              }`}
            >
              <PenLine className="w-4 h-4" />
              إدخال يدوي
            </button>
          </div>
          
          {/*  حقل البحث - فقط في وضع الخريطة */}
          {inputMode === 'map' && (
            <div className="relative">
              <Search className="absolute right-3 top-1/2 -translate-y-1/2 w-5 h-5 text-gray-400" />
              <input
                type="text"
                value={searchQuery}
                onChange={(e) => {
                  setSearchQuery(e.target.value)
                  searchPlaces(e.target.value)
                }}
                onFocus={() => searchResults.length > 0 && setShowResults(true)}
                placeholder="ابحث عن حي، شارع، أو مكان..."
                className="w-full bg-white/95 text-gray-800 rounded-xl p-3 pr-10 pl-10 focus:outline-none focus:ring-2 focus:ring-white/50 transition placeholder:text-gray-400"
              />
              {searchLoading && (
                <Loader2 className="absolute left-3 top-1/2 -translate-y-1/2 w-5 h-5 text-sky-500 animate-spin" />
              )}
              
              {/* نتائج البحث */}
              {showResults && searchResults.length > 0 && (
                <div className="absolute top-full left-0 right-0 mt-2 bg-white rounded-xl shadow-2xl overflow-hidden z-[1001] max-h-60 overflow-y-auto">
                  {searchResults.map((result, index) => (
                    <button
                      key={index}
                      onClick={() => selectSearchResult(result)}
                      className="w-full p-3 text-right hover:bg-sky-50 border-b border-gray-100 last:border-0 transition flex items-start gap-3"
                    >
                      <MapPin className="w-5 h-5 text-sky-500 flex-shrink-0 mt-0.5" />
                      <span className="text-gray-700 text-sm leading-relaxed">
                        {result.display_name}
                      </span>
                    </button>
                  ))}
                </div>
              )}
            </div>
          )}
        </div>

        {/* الخريطة - فقط في وضع الخريطة */}
        {inputMode === 'map' && (
          <div className="flex-1 relative">
            {!mapReady && (
              <div className="absolute inset-0 flex items-center justify-center bg-sky-50">
                <div className="text-center">
                  <Loader2 className="w-12 h-12 text-sky-500 animate-spin mx-auto mb-3" />
                  <p className="text-sky-600 font-medium">جارِ تحميل الخريطة...</p>
                </div>
              </div>
            )}
            <div id="location-map" className="w-full h-full" />

            {/* أزرار التحكم */}
            <div className="absolute left-4 top-4 flex flex-col gap-2 z-[1000]">
              {/* زر GPS */}
              <button
                onClick={getGPSLocation}
                disabled={gpsLoading}
                className="w-12 h-12 bg-white rounded-xl shadow-lg flex items-center justify-center hover:bg-sky-50 transition disabled:opacity-50"
                title="موقعي الحالي"
              >
                {gpsLoading ? (
                  <Loader2 className="w-5 h-5 text-sky-500 animate-spin" />
                ) : (
                  <Navigation className="w-5 h-5 text-sky-500" />
                )}
              </button>

              {/* زر التمركز */}
              {location && (
                <button
                  onClick={centerOnLocation}
                  className="w-12 h-12 bg-white rounded-xl shadow-lg flex items-center justify-center hover:bg-sky-50 transition"
                  title="تمركز"
                >
                  <Target className="w-5 h-5 text-gray-600" />
                </button>
              )}
            </div>

            {/* مؤشر الموقع */}
            {location && (
              <div className="absolute right-4 top-4 bg-white/95 backdrop-blur-sm rounded-xl shadow-lg p-3 z-[1000] max-w-[200px]">
                <div className="flex items-center gap-2 text-green-600 mb-1">
                  <Check className="w-4 h-4" />
                  <span className="text-sm font-medium">تم تحديد الموقع</span>
                </div>
                <p className="text-xs text-gray-500 font-mono">
                  {location.lat.toFixed(6)}, {location.lng.toFixed(6)}
                </p>
              </div>
            )}
          </div>
        )}

        {/* محتوى الإدخال اليدوي */}
        {inputMode === 'manual' && (
          <div className="flex-1 p-6 overflow-y-auto bg-gray-50">
            <div className="max-w-md mx-auto space-y-4">
              {/* أيقونة */}
              <div className="text-center py-4">
                <div className="w-20 h-20 bg-sky-100 rounded-2xl flex items-center justify-center mx-auto mb-4">
                  <PenLine className="w-10 h-10 text-sky-500" />
                </div>
                <h3 className="text-lg font-bold text-gray-800">أدخل عنوانك يدوياً</h3>
                <p className="text-sm text-gray-500 mt-1">اكتب تفاصيل العنوان بدقة ليصلك الطلب</p>
              </div>

              {/* المدينة */}
              <div>
                <label className="block text-sm font-semibold text-gray-700 mb-2">المدينة</label>
                <select
                  className="w-full border-2 border-gray-200 rounded-xl p-3 bg-white focus:border-sky-400 focus:outline-none"
                  onChange={(e) => setAddress(prev => {
                    const parts = prev.split('،').slice(1)
                    return e.target.value + (parts.length ? '،' + parts.join('،') : '')
                  })}
                >
                  <option value="">اختر المدينة</option>
                  <option value="الرياض">الرياض</option>
                  <option value="جدة">جدة</option>
                  <option value="مكة المكرمة">مكة المكرمة</option>
                  <option value="المدينة المنورة">المدينة المنورة</option>
                  <option value="الدمام">الدمام</option>
                  <option value="الخبر">الخبر</option>
                  <option value="الأحساء">الأحساء</option>
                  <option value="الطائف">الطائف</option>
                  <option value="تبوك">تبوك</option>
                  <option value="بريدة">بريدة</option>
                  <option value="خميس مشيط">خميس مشيط</option>
                  <option value="أبها">أبها</option>
                  <option value="القطيف">القطيف</option>
                  <option value="نجران">نجران</option>
                  <option value="جازان">جازان</option>
                  <option value="ينبع">ينبع</option>
                  <option value="حائل">حائل</option>
                </select>
              </div>

              {/* الحي */}
              <div>
                <label className="block text-sm font-semibold text-gray-700 mb-2">الحي</label>
                <input
                  type="text"
                  placeholder="مثال: حي النرجس"
                  className="w-full border-2 border-gray-200 rounded-xl p-3 focus:border-sky-400 focus:outline-none"
                  onChange={(e) => setAddress(prev => {
                    const city = prev.split('،')[0] || ''
                    return city + (e.target.value ? '، ' + e.target.value : '')
                  })}
                />
              </div>

              {/* الشارع */}
              <div>
                <label className="block text-sm font-semibold text-gray-700 mb-2">الشارع</label>
                <input
                  type="text"
                  placeholder="مثال: شارع الملك عبدالعزيز"
                  className="w-full border-2 border-gray-200 rounded-xl p-3 focus:border-sky-400 focus:outline-none"
                  onChange={(e) => setAddress(prev => {
                    const parts = prev.split('،').slice(0, 2)
                    return parts.join('،') + (e.target.value ? '، ' + e.target.value : '')
                  })}
                />
              </div>

              {/* تفاصيل إضافية */}
              <div>
                <label className="block text-sm font-semibold text-gray-700 mb-2">تفاصيل إضافية</label>
                <textarea
                  placeholder="رقم المبنى، الدور، علامة مميزة..."
                  rows={3}
                  className="w-full border-2 border-gray-200 rounded-xl p-3 focus:border-sky-400 focus:outline-none resize-none"
                  onChange={(e) => setAddress(prev => {
                    const parts = prev.split('،').slice(0, 3)
                    return parts.join('،') + (e.target.value ? '، ' + e.target.value : '')
                  })}
                />
              </div>

              {/* العنوان النهائي */}
              {address && (
                <div className="bg-green-50 border-2 border-green-200 rounded-xl p-4">
                  <div className="flex items-center gap-2 text-green-600 mb-2">
                    <Check className="w-5 h-5" />
                    <span className="font-semibold">العنوان:</span>
                  </div>
                  <p className="text-gray-700">{address}</p>
                </div>
              )}
            </div>
          </div>
        )}

        {/* قسم العنوان والتأكيد */}
        <div className="bg-white border-t p-4 space-y-3">
          {/* رسالة الخطأ */}
          {error && (
            <div className="bg-red-50 border border-red-200 text-red-600 rounded-xl p-3 text-sm flex items-center gap-2">
              <X className="w-4 h-4 flex-shrink-0" />
              {error}
            </div>
          )}

          {/* حقل العنوان - فقط في وضع الخريطة */}
          {inputMode === 'map' && (
            <>
              <div className="relative">
                <Smartphone className="absolute right-3 top-1/2 -translate-y-1/2 w-5 h-5 text-gray-400" />
                <input
                  type="text"
                  value={address}
                  onChange={(e) => setAddress(e.target.value)}
                  placeholder="وصف العنوان (مثال: حي النرجس، شارع الملك عبدالعزيز، بجانب مسجد...)"
                  className="w-full border-2 border-gray-200 rounded-xl p-3 pr-10 focus:border-sky-400 focus:outline-none transition text-gray-800"
                />
              </div>

              {/* نصيحة */}
              <p className="text-xs text-gray-500 text-center">
                 أضف تفاصيل واضحة ليصلك الطلب بسرعة
              </p>
            </>
          )}

          {/* أزرار */}
          <div className="flex gap-3">
            <button
              onClick={onClose}
              className="flex-1 py-3 px-4 rounded-xl border-2 border-gray-200 text-gray-600 font-semibold hover:bg-gray-50 transition"
            >
              إلغاء
            </button>
            <button
              onClick={handleConfirm}
              disabled={inputMode === 'map' && !location}
              className="flex-1 py-3 px-4 rounded-xl bg-gradient-to-r from-green-500 to-green-600 text-white font-bold shadow-lg hover:shadow-xl disabled:opacity-50 disabled:cursor-not-allowed transition flex items-center justify-center gap-2"
            >
              <Check className="w-5 h-5" />
              تأكيد الموقع
            </button>
          </div>
        </div>
      </div>

      {/* أنماط CSS للماركر */}
      <style>{`
        .custom-marker {
          background: transparent !important;
          border: none !important;
        }
        .leaflet-container {
          font-family: inherit;
        }
        .leaflet-control-zoom {
          display: none;
        }
        #location-map {
          background: #f0f9ff;
        }
      `}</style>
    </div>
  )
}

==========================================================================================
FILE: src/components/LocationRequired.tsx
==========================================================================================
// src/components/LocationRequired.tsx
// مكون يظهر عندما يكون تحديد الموقع إلزامياً

import React, { useState, useEffect, useCallback } from 'react'
import { MapPin, Navigation, Loader2, AlertTriangle, CheckCircle } from 'lucide-react'
import { doc, updateDoc } from 'firebase/firestore'
import { db } from '@/firebase'
import { useAuth } from '@/auth'

type Location = { lat: number; lng: number }

type Props = {
  onLocationSaved: () => void
}

export const LocationRequired: React.FC<Props> = ({ onLocationSaved }) => {
  const { user, role } = useAuth()
  const [location, setLocation] = useState<Location | null>(null)
  const [loading, setLoading] = useState(false)
  const [gpsLoading, setGpsLoading] = useState(false)
  const [error, setError] = useState<string | null>(null)
  const [mapReady, setMapReady] = useState(false)
  const [saving, setSaving] = useState(false)

  // موقع افتراضي (الرياض)
  const defaultLocation: Location = { lat: 24.7136, lng: 46.6753 }

  // تحديد الموقع عبر GPS
  const getGPSLocation = useCallback(() => {
    if (!navigator.geolocation) {
      setError('المتصفح لا يدعم تحديد الموقع')
      return
    }

    setGpsLoading(true)
    setError(null)

    navigator.geolocation.getCurrentPosition(
      (pos) => {
        const newLoc = { lat: pos.coords.latitude, lng: pos.coords.longitude }
        setLocation(newLoc)
        setGpsLoading(false)
        
        // تحديث الخريطة
        if ((window as any).locationRequiredMap) {
          (window as any).locationRequiredMap.setView([newLoc.lat, newLoc.lng], 17)
          if ((window as any).locationRequiredMarker) {
            (window as any).locationRequiredMarker.setLatLng([newLoc.lat, newLoc.lng])
          }
        }
      },
      (err) => {
        setGpsLoading(false)
        if (err.code === 1) {
          setError('تم رفض إذن الموقع. فعّل الموقع من إعدادات المتصفح')
        } else if (err.code === 2) {
          setError('تعذر تحديد الموقع. تأكد من تفعيل GPS')
        } else {
          setError('انتهت مهلة تحديد الموقع. حاول مرة أخرى')
        }
      },
      { 
        enableHighAccuracy: true, 
        timeout: 15000,
        maximumAge: 0 
      }
    )
  }, [])

  // تحميل Leaflet
  useEffect(() => {
    // تحميل CSS
    if (!document.getElementById('leaflet-css')) {
      const link = document.createElement('link')
      link.id = 'leaflet-css'
      link.rel = 'stylesheet'
      link.href = 'https://unpkg.com/leaflet@1.9.4/dist/leaflet.css'
      document.head.appendChild(link)
    }

    // تحميل JS
    if (!(window as any).L) {
      const script = document.createElement('script')
      script.src = 'https://unpkg.com/leaflet@1.9.4/dist/leaflet.js'
      script.onload = () => setMapReady(true)
      document.body.appendChild(script)
    } else {
      setMapReady(true)
    }
  }, [])

  // إنشاء الخريطة
  useEffect(() => {
    if (!mapReady || !(window as any).L) return

    const L = (window as any).L
    const container = document.getElementById('location-required-map')
    if (!container) return

    // إزالة خريطة قديمة إن وجدت
    if ((window as any).locationRequiredMap) {
      (window as any).locationRequiredMap.remove()
    }

    const startLoc = location || defaultLocation

    // إنشاء الخريطة
    const map = L.map('location-required-map', {
      zoomControl: true,
      attributionControl: false,
    }).setView([startLoc.lat, startLoc.lng], 12)

    // إضافة طبقة الخريطة
    L.tileLayer('[REDACTED_IMAGE_URL]', {
      maxZoom: 19,
    }).addTo(map)

    // أيقونة مخصصة للماركر
    const customIcon = L.divIcon({
      className: 'custom-marker',
      html: `
        <div style="
          width: 50px; 
          height: 50px; 
          background: linear-gradient(135deg, #0EA5E9, #0284C7);
          border-radius: 50% 50% 50% 0;
          transform: rotate(-45deg);
          display: flex;
          align-items: center;
          justify-content: center;
          box-shadow: 0 4px 20px rgba(14, 165, 233, 0.5);
          border: 3px solid white;
        ">
          <div style="transform: rotate(45deg); color: white; font-size: 20px;"></div>
        </div>
      `,
      iconSize: [50, 50],
      iconAnchor: [25, 50],
    })

    // إضافة الماركر
    const marker = L.marker([startLoc.lat, startLoc.lng], { 
      icon: customIcon,
      draggable: true 
    }).addTo(map)

    // تحديث الموقع عند سحب الماركر
    marker.on('dragend', () => {
      const pos = marker.getLatLng()
      setLocation({ lat: pos.lat, lng: pos.lng })
    })

    // تحديث الموقع عند النقر على الخريطة
    map.on('click', (e: any) => {
      const { lat, lng } = e.latlng
      setLocation({ lat, lng })
      marker.setLatLng([lat, lng])
    })

    // حفظ المراجع
    ;(window as any).locationRequiredMap = map
    ;(window as any).locationRequiredMarker = marker

    return () => {
      if ((window as any).locationRequiredMap) {
        (window as any).locationRequiredMap.remove()
        ;(window as any).locationRequiredMap = null
        ;(window as any).locationRequiredMarker = null
      }
    }
  }, [mapReady])

  // حفظ الموقع
  const saveLocation = async () => {
    if (!location || !user) return

    setSaving(true)
    try {
      // حفظ في مستند المستخدم
      await updateDoc(doc(db, 'users', user.uid), {
        location: location,
        locationUpdatedAt: new Date()
      })

      // إذا كان صاحب مطعم، حفظ في مستند المطعم أيضاً
      if (role === 'owner') {
        try {
          await updateDoc(doc(db, 'restaurants', user.uid), {
            geoLocation: location,
            locationUpdatedAt: new Date()
          })
        } catch (err) {
          console.warn('تعذر تحديث موقع المطعم:', err)
        }
      }

      onLocationSaved()
    } catch (err) {
      setError('فشل في حفظ الموقع. حاول مرة أخرى')
    } finally {
      setSaving(false)
    }
  }

  const getRoleText = () => {
    switch (role) {
      case 'owner': return 'مطعمك'
      case 'courier': return 'موقعك الحالي'
      default: return 'موقعك'
    }
  }

  return (
    <div className="fixed inset-0 z-50 bg-gradient-to-br from-sky-50 via-white to-sky-100 flex items-center justify-center p-4">
      <div className="bg-white rounded-3xl shadow-2xl max-w-lg w-full overflow-hidden">
        {/* الهيدر */}
        <div className="bg-gradient-to-r from-sky-500 to-sky-600 p-6 text-white text-center">
          <div className="w-20 h-20 bg-white/20 rounded-full flex items-center justify-center mx-auto mb-4">
            <MapPin className="w-10 h-10" />
          </div>
          <h1 className="text-2xl font-bold mb-2">حدد موقع {getRoleText()}</h1>
          <p className="text-sky-100 text-sm">
            {role === 'owner' 
              ? 'لعرض مطعمك للعملاء القريبين منك'
              : 'لنعرض لك المطاعم القريبة منك (15 كم)'}
          </p>
        </div>

        {/* المحتوى */}
        <div className="p-6 space-y-4">
          {/* رسالة الخطأ */}
          {error && (
            <div className="bg-red-50 border border-red-200 rounded-xl p-3 flex items-center gap-3 text-red-700">
              <AlertTriangle className="w-5 h-5 flex-shrink-0" />
              <p className="text-sm">{error}</p>
            </div>
          )}

          {/* زر تحديد الموقع GPS */}
          <button
            onClick={getGPSLocation}
            disabled={gpsLoading}
            className="w-full flex items-center justify-center gap-3 bg-gradient-to-r from-green-500 to-emerald-600 hover:from-green-600 hover:to-emerald-700 text-white font-bold p-4 rounded-xl shadow-lg transition disabled:opacity-50"
          >
            {gpsLoading ? (
              <>
                <Loader2 className="w-5 h-5 animate-spin" />
                جارِ تحديد موقعك...
              </>
            ) : (
              <>
                <Navigation className="w-5 h-5" />
                 حدد موقعي تلقائياً
              </>
            )}
          </button>

          {/* الخريطة */}
          <div className="relative">
            <p className="text-sm text-gray-500 mb-2 text-center">
              أو اضغط على الخريطة لتحديد الموقع يدوياً
            </p>
            <div 
              id="location-required-map" 
              className="h-64 rounded-xl overflow-hidden border-2 border-gray-200"
              style={{ background: '#f0f9ff' }}
            />
            {!mapReady && (
              <div className="absolute inset-0 flex items-center justify-center bg-sky-50">
                <Loader2 className="w-8 h-8 animate-spin text-sky-500" />
              </div>
            )}
          </div>

          {/* حالة الموقع */}
          {location && (
            <div className="bg-green-50 border border-green-200 rounded-xl p-3 flex items-center gap-3 text-green-700">
              <CheckCircle className="w-5 h-5 flex-shrink-0" />
              <div className="text-sm">
                <p className="font-semibold">تم تحديد الموقع </p>
                <p className="text-xs text-green-600">
                  {location.lat.toFixed(6)}, {location.lng.toFixed(6)}
                </p>
              </div>
            </div>
          )}

          {/* زر الحفظ */}
          <button
            onClick={saveLocation}
            disabled={!location || saving}
            className="w-full flex items-center justify-center gap-3 bg-gradient-to-r from-sky-500 to-sky-600 hover:from-sky-600 hover:to-sky-700 text-white font-bold p-4 rounded-xl shadow-lg transition disabled:opacity-50 disabled:cursor-not-allowed"
          >
            {saving ? (
              <>
                <Loader2 className="w-5 h-5 animate-spin" />
                جارِ الحفظ...
              </>
            ) : (
              <>
                <CheckCircle className="w-5 h-5" />
                تأكيد الموقع والمتابعة
              </>
            )}
          </button>

          <p className="text-xs text-gray-400 text-center">
             يمكنك تغيير موقعك لاحقاً من صفحة البروفايل
          </p>
        </div>
      </div>
    </div>
  )
}

==========================================================================================
FILE: src/components/OrderTimer.tsx
==========================================================================================
// src/components/OrderTimer.tsx
// مكون عداد الوقت للطلبات - يعرض الوقت المتبقي مع تنبيهات تلقائية
import React, { useEffect, useState } from 'react'
import { Clock, AlertTriangle, CheckCircle } from 'lucide-react'
import { ORDER_TIME_LIMITS, TimerStatus, Order } from '@/types'

interface OrderTimerProps {
  order: Order;
  type: 'preparation' | 'pickup' | 'delivery';
  showLabel?: boolean;
  compact?: boolean;
}

// حساب الوقت المنقضي والمتبقي
const calculateTime = (startTime: Date | undefined, limitMinutes: number) => {
  if (!startTime) return { elapsed: 0, remaining: limitMinutes, percentage: 0 }
  
  const start = startTime instanceof Date ? startTime : new Date(startTime)
  const now = new Date()
  const elapsedMs = now.getTime() - start.getTime()
  const elapsedMinutes = Math.floor(elapsedMs / 60000)
  const remaining = limitMinutes - elapsedMinutes
  const percentage = Math.min((elapsedMinutes / limitMinutes) * 100, 100)
  
  return { elapsed: elapsedMinutes, remaining, percentage }
}

// تحديد حالة العداد
const getTimerStatus = (percentage: number): TimerStatus => {
  if (percentage >= 100) return 'exceeded'
  if (percentage >= ORDER_TIME_LIMITS.WARNING_THRESHOLD * 100) return 'warning'
  return 'normal'
}

// تحويل الدقائق إلى نص
const formatTime = (minutes: number): string => {
  const absMinutes = Math.abs(minutes)
  if (absMinutes < 60) {
    return `${absMinutes} دقيقة`
  }
  const hours = Math.floor(absMinutes / 60)
  const mins = absMinutes % 60
  return `${hours}س ${mins}د`
}

// الحصول على اسم المرحلة
const getStageLabel = (type: 'preparation' | 'pickup' | 'delivery'): string => {
  switch (type) {
    case 'preparation': return 'التجهيز'
    case 'pickup': return 'الاستلام'
    case 'delivery': return 'التوصيل'
  }
}

// الحصول على الوقت المحدد لكل مرحلة
const getTimeLimit = (type: 'preparation' | 'pickup' | 'delivery'): number => {
  switch (type) {
    case 'preparation': return ORDER_TIME_LIMITS.PREPARATION_TIME
    case 'pickup': return ORDER_TIME_LIMITS.COURIER_PICKUP_TIME
    case 'delivery': return ORDER_TIME_LIMITS.DELIVERY_TIME
  }
}

// الحصول على وقت بداية المرحلة
const getStartTime = (order: Order, type: 'preparation' | 'pickup' | 'delivery'): Date | undefined => {
  if (!order.timestamps) return undefined
  switch (type) {
    case 'preparation': return order.timestamps.acceptedAt
    case 'pickup': return order.timestamps.readyAt
    case 'delivery': return order.timestamps.pickedUpAt
  }
}

// التحقق من اكتمال المرحلة
const isStageComplete = (order: Order, type: 'preparation' | 'pickup' | 'delivery'): boolean => {
  switch (type) {
    case 'preparation':
      return order.status === 'ready' || order.status === 'out_for_delivery' || order.status === 'delivered'
    case 'pickup':
      return order.status === 'out_for_delivery' || order.status === 'delivered'
    case 'delivery':
      return order.status === 'delivered'
  }
}

// التحقق من نشاط المرحلة
const isStageActive = (order: Order, type: 'preparation' | 'pickup' | 'delivery'): boolean => {
  switch (type) {
    case 'preparation':
      return order.status === 'accepted' || order.status === 'preparing'
    case 'pickup':
      return order.status === 'ready'
    case 'delivery':
      return order.status === 'out_for_delivery'
  }
}

export const OrderTimer: React.FC<OrderTimerProps> = ({ 
  order, 
  type, 
  showLabel = true,
  compact = false 
}) => {
  const [timeInfo, setTimeInfo] = useState({ elapsed: 0, remaining: 0, percentage: 0 })
  const [status, setStatus] = useState<TimerStatus>('normal')

  const limit = getTimeLimit(type)
  const startTime = getStartTime(order, type)
  const isComplete = isStageComplete(order, type)
  const isActive = isStageActive(order, type)

  useEffect(() => {
    if (!isActive || isComplete || !startTime) return

    const updateTimer = () => {
      const info = calculateTime(startTime, limit)
      setTimeInfo(info)
      setStatus(getTimerStatus(info.percentage))
    }

    updateTimer()
    const interval = setInterval(updateTimer, 30000) // تحديث كل 30 ثانية

    return () => clearInterval(interval)
  }, [startTime, limit, isActive, isComplete])

  // لا تعرض شيء إذا المرحلة لم تبدأ
  if (!startTime && !isComplete) return null

  // المرحلة مكتملة
  if (isComplete) {
    if (compact) {
      return (
        <div className="flex items-center gap-1 text-green-600">
          <CheckCircle className="w-4 h-4" />
          <span className="text-xs"></span>
        </div>
      )
    }
    return (
      <div className="flex items-center gap-2 text-green-600 bg-green-50 px-3 py-1.5 rounded-lg">
        <CheckCircle className="w-4 h-4" />
        <span className="text-sm font-medium">{getStageLabel(type)} </span>
      </div>
    )
  }

  // المرحلة غير نشطة
  if (!isActive) return null

  // ألوان حسب الحالة
  const colors = {
    normal: {
      bg: 'bg-sky-50',
      border: 'border-sky-200',
      text: 'text-sky-700',
      bar: 'bg-sky-500',
      icon: 'text-sky-500'
    },
    warning: {
      bg: 'bg-amber-50',
      border: 'border-amber-300',
      text: 'text-amber-700',
      bar: 'bg-amber-500',
      icon: 'text-amber-500'
    },
    exceeded: {
      bg: 'bg-red-50',
      border: 'border-red-300',
      text: 'text-red-700',
      bar: 'bg-red-500',
      icon: 'text-red-500'
    }
  }

  const c = colors[status]

  if (compact) {
    return (
      <div className={`flex items-center gap-1 ${c.text}`}>
        {status === 'exceeded' ? (
          <AlertTriangle className="w-4 h-4 animate-pulse" />
        ) : (
          <Clock className={`w-4 h-4 ${c.icon}`} />
        )}
        <span className="text-xs font-bold">
          {timeInfo.remaining > 0 ? formatTime(timeInfo.remaining) : `+${formatTime(Math.abs(timeInfo.remaining))}`}
        </span>
      </div>
    )
  }

  return (
    <div className={`${c.bg} ${c.border} border rounded-xl p-3 space-y-2`}>
      {/* Header */}
      <div className="flex items-center justify-between">
        <div className="flex items-center gap-2">
          {status === 'exceeded' ? (
            <AlertTriangle className={`w-5 h-5 ${c.icon} animate-pulse`} />
          ) : (
            <Clock className={`w-5 h-5 ${c.icon}`} />
          )}
          {showLabel && (
            <span className={`text-sm font-bold ${c.text}`}>
              {getStageLabel(type)}
            </span>
          )}
        </div>
        <div className={`text-lg font-bold ${c.text}`}>
          {timeInfo.remaining > 0 ? (
            <span>{formatTime(timeInfo.remaining)}</span>
          ) : (
            <span className="flex items-center gap-1">
              <span>+{formatTime(Math.abs(timeInfo.remaining))}</span>
              <span className="text-xs"></span>
            </span>
          )}
        </div>
      </div>

      {/* Progress Bar */}
      <div className="h-2 bg-gray-200 rounded-full overflow-hidden">
        <div 
          className={`h-full ${c.bar} transition-all duration-500`}
          style={{ width: `${Math.min(timeInfo.percentage, 100)}%` }}
        />
      </div>

      {/* تنبيه التجاوز */}
      {status === 'exceeded' && (
        <div className="text-xs text-red-600 font-medium animate-pulse">
           تجاوز الوقت المحدد! يرجى الإسراع.
        </div>
      )}

      {/* تحذير قبل الانتهاء */}
      {status === 'warning' && (
        <div className="text-xs text-amber-600 font-medium">
           الوقت ينفد! باقي {formatTime(timeInfo.remaining)} فقط.
        </div>
      )}
    </div>
  )
}

/**
 * مكون ملخص الأوقات - يعرض جميع المراحل
 */
export const OrderTimerSummary: React.FC<{ order: Order }> = ({ order }) => {
  return (
    <div className="space-y-2">
      <h4 className="text-sm font-bold text-gray-700 flex items-center gap-2">
        <Clock className="w-4 h-4" />
        عداد الوقت
      </h4>
      <div className="grid grid-cols-3 gap-2">
        <OrderTimer order={order} type="preparation" compact showLabel />
        <OrderTimer order={order} type="pickup" compact showLabel />
        <OrderTimer order={order} type="delivery" compact showLabel />
      </div>
    </div>
  )
}

export default OrderTimer

==========================================================================================
FILE: src/components/RatingModal.tsx
==========================================================================================
// src/components/RatingModal.tsx
import React, { useState } from 'react'
import { Star, X, Send, Loader2, Store, Truck, User } from 'lucide-react'

type RatingType = 'restaurant' | 'courier' | 'customer'

interface RatingModalProps {
  isOpen: boolean
  onClose: () => void
  onSubmit: (rating: { stars: number; comment: string }) => Promise<void>
  type: RatingType
  targetName?: string
  orderId?: string
}

const TYPE_CONFIG: Record<RatingType, { title: string; icon: React.ElementType; color: string; placeholder: string }> = {
  restaurant: {
    title: 'قيّم الأسرة المنتجة',
    icon: Store,
    color: 'amber',
    placeholder: 'كيف كانت جودة الطعام والخدمة؟'
  },
  courier: {
    title: 'قيّم المندوب',
    icon: Truck,
    color: 'emerald',
    placeholder: 'كيف كان أداء المندوب؟'
  },
  customer: {
    title: 'قيّم العميل',
    icon: User,
    color: 'sky',
    placeholder: 'كيف كان تعامل العميل؟'
  }
}

export const RatingModal: React.FC<RatingModalProps> = ({
  isOpen,
  onClose,
  onSubmit,
  type,
  targetName,
  orderId
}) => {
  const [stars, setStars] = useState(0)
  const [hoverStars, setHoverStars] = useState(0)
  const [comment, setComment] = useState('')
  const [submitting, setSubmitting] = useState(false)
  const [error, setError] = useState('')

  const config = TYPE_CONFIG[type]
  const Icon = config.icon

  const handleSubmit = async () => {
    if (stars === 0) {
      setError('الرجاء اختيار عدد النجوم')
      return
    }

    setSubmitting(true)
    setError('')

    try {
      await onSubmit({ stars, comment: comment.trim() })
      // إعادة تعيين الحالة
      setStars(0)
      setComment('')
      onClose()
    } catch (err) {
      setError('حدث خطأ، حاول مرة أخرى')
    } finally {
      setSubmitting(false)
    }
  }

  if (!isOpen) return null

  return (
    <div className="fixed inset-0 bg-black/60 backdrop-blur-sm z-50 flex items-center justify-center p-4">
      <div className="bg-white rounded-3xl w-full max-w-md overflow-hidden shadow-2xl animate-in fade-in zoom-in duration-200">
        {/* الهيدر */}
        <div className={`bg-gradient-to-r from-${config.color}-500 to-${config.color}-600 p-6 text-white`}>
          <div className="flex items-center justify-between">
            <div className="flex items-center gap-3">
              <div className="w-12 h-12 bg-white/20 rounded-2xl flex items-center justify-center">
                <Icon className="w-6 h-6" />
              </div>
              <div>
                <h2 className="text-xl font-bold">{config.title}</h2>
                {targetName && <p className="text-white/80 text-sm">{targetName}</p>}
              </div>
            </div>
            <button
              onClick={onClose}
              className="p-2 hover:bg-white/20 rounded-xl transition"
            >
              <X className="w-6 h-6" />
            </button>
          </div>
        </div>

        {/* المحتوى */}
        <div className="p-6">
          {/* النجوم */}
          <div className="text-center mb-6">
            <p className="text-gray-600 mb-4">كم تقييمك؟</p>
            <div className="flex justify-center gap-2">
              {[1, 2, 3, 4, 5].map((n) => (
                <button
                  key={n}
                  type="button"
                  onClick={() => setStars(n)}
                  onMouseEnter={() => setHoverStars(n)}
                  onMouseLeave={() => setHoverStars(0)}
                  className="p-1 transition-transform hover:scale-110"
                >
                  <Star
                    className={`w-10 h-10 transition-colors ${
                      n <= (hoverStars || stars)
                        ? 'text-yellow-400 fill-yellow-400'
                        : 'text-gray-300'
                    }`}
                  />
                </button>
              ))}
            </div>
            {stars > 0 && (
              <p className="mt-2 text-lg font-bold text-gray-800">
                {stars === 1 && 'سيء '}
                {stars === 2 && 'مقبول '}
                {stars === 3 && 'جيد '}
                {stars === 4 && 'جيد جداً '}
                {stars === 5 && 'ممتاز! '}
              </p>
            )}
          </div>

          {/* التعليق */}
          <div className="mb-6">
            <label className="block text-sm font-medium text-gray-700 mb-2">
              تعليق (اختياري)
            </label>
            <textarea
              value={comment}
              onChange={(e) => setComment(e.target.value)}
              placeholder={config.placeholder}
              rows={3}
              className="w-full p-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-sky-500 resize-none"
            />
          </div>

          {/* رسالة الخطأ */}
          {error && (
            <div className="mb-4 p-3 bg-red-50 border border-red-200 rounded-xl text-red-700 text-sm text-center">
              {error}
            </div>
          )}

          {/* أزرار */}
          <div className="flex gap-3">
            <button
              onClick={handleSubmit}
              disabled={submitting || stars === 0}
              className={`flex-1 flex items-center justify-center gap-2 py-3 px-6 
                         bg-gradient-to-r from-${config.color}-500 to-${config.color}-600 
                         hover:from-${config.color}-600 hover:to-${config.color}-700
                         text-white rounded-xl font-bold transition-all disabled:opacity-50`}
            >
              {submitting ? (
                <Loader2 className="w-5 h-5 animate-spin" />
              ) : (
                <>
                  <Send className="w-5 h-5" />
                  <span>إرسال التقييم</span>
                </>
              )}
            </button>
          </div>
        </div>
      </div>
    </div>
  )
}

/**
 * مكون النجوم للعرض فقط
 */
export const StarRating: React.FC<{ rating: number; size?: 'sm' | 'md' | 'lg' }> = ({ 
  rating, 
  size = 'md' 
}) => {
  const sizeClass = size === 'sm' ? 'w-4 h-4' : size === 'lg' ? 'w-6 h-6' : 'w-5 h-5'
  
  return (
    <div className="flex items-center gap-0.5">
      {[1, 2, 3, 4, 5].map((n) => (
        <Star
          key={n}
          className={`${sizeClass} ${
            n <= rating
              ? 'text-yellow-400 fill-yellow-400'
              : 'text-gray-300'
          }`}
        />
      ))}
    </div>
  )
}

export default RatingModal

==========================================================================================
FILE: src/components/TopBar.tsx
==========================================================================================
// src/components/TopBar.tsx
import React from 'react'
import { Sparkles } from 'lucide-react'

export const TopBar: React.FC = () => {
  return (
    <div 
      className="w-full bg-gradient-to-r from-sky-500 via-sky-400 to-sky-500 text-white py-2 sm:py-3 overflow-hidden shadow-lg"
    >
      <div className="flex items-center justify-center gap-1 sm:gap-2 px-2">
        <Sparkles className="w-4 h-4 sm:w-5 sm:h-5 text-white animate-pulse flex-shrink-0" />
        <div className="marquee whitespace-nowrap font-bold text-xs sm:text-sm tracking-wide">
           مرحباً بك في سفرة البيت — أشهى الأكلات توصلك لين باب بيتك! 
        </div>
        <Sparkles className="w-4 h-4 sm:w-5 sm:h-5 text-white animate-pulse flex-shrink-0" />
      </div>
    </div>
  )
}

==========================================================================================
FILE: src/components/ui/ConfirmDialog.tsx
==========================================================================================
import React, { createContext, useContext, useState, useCallback, useMemo } from 'react'
import { AlertTriangle, CheckCircle, Info, XCircle, X } from 'lucide-react'

// أنواع الحوارات
type DialogType = 'confirm' | 'alert' | 'info' | 'success' | 'error' | 'warning'

type DialogOptions = {
  title?: string
  message: string
  type?: DialogType
  confirmText?: string
  cancelText?: string
  onConfirm?: () => void | Promise<void>
  onCancel?: () => void
  dangerous?: boolean // للإجراءات الخطيرة مثل الحذف
}

type DialogState = DialogOptions & {
  isOpen: boolean
  resolve?: (value: boolean) => void
}

type DialogContextType = {
  confirm: (message: string, options?: Partial<DialogOptions>) => Promise<boolean>
  alert: (message: string, options?: Partial<DialogOptions>) => Promise<void>
  success: (message: string, options?: Partial<DialogOptions>) => Promise<void>
  error: (message: string, options?: Partial<DialogOptions>) => Promise<void>
  warning: (message: string, options?: Partial<DialogOptions>) => Promise<void>
  info: (message: string, options?: Partial<DialogOptions>) => Promise<void>
}

const DialogContext = createContext<DialogContextType | null>(null)

export const useDialog = () => {
  const ctx = useContext(DialogContext)
  if (!ctx) throw new Error('useDialog must be used within DialogProvider')
  return ctx
}

export const DialogProvider: React.FC<{ children: React.ReactNode }> = ({ children }) => {
  const [dialog, setDialog] = useState<DialogState>({
    isOpen: false,
    message: '',
    type: 'confirm',
  })

  const openDialog = useCallback((options: DialogOptions): Promise<boolean> => {
    return new Promise((resolve) => {
      setDialog({
        ...options,
        isOpen: true,
        resolve,
      })
    })
  }, [])

  const closeDialog = useCallback((result: boolean) => {
    if (dialog.resolve) {
      dialog.resolve(result)
    }
    setDialog(prev => ({ ...prev, isOpen: false }))
  }, [dialog.resolve])

  const handleConfirm = useCallback(async () => {
    if (dialog.onConfirm) {
      await dialog.onConfirm()
    }
    closeDialog(true)
  }, [dialog.onConfirm, closeDialog])

  const handleCancel = useCallback(() => {
    if (dialog.onCancel) {
      dialog.onCancel()
    }
    closeDialog(false)
  }, [dialog.onCancel, closeDialog])

  const api: DialogContextType = useMemo(() => ({
    confirm: (message, options = {}) => openDialog({
      message,
      type: 'confirm',
      title: options.title || 'تأكيد',
      confirmText: options.confirmText || 'تأكيد',
      cancelText: options.cancelText || 'إلغاء',
      ...options,
    }),
    alert: (message, options = {}) => openDialog({
      message,
      type: 'alert',
      title: options.title || 'تنبيه',
      confirmText: options.confirmText || 'حسناً',
      ...options,
    }).then(() => {}),
    success: (message, options = {}) => openDialog({
      message,
      type: 'success',
      title: options.title || 'تم بنجاح',
      confirmText: options.confirmText || 'حسناً',
      ...options,
    }).then(() => {}),
    error: (message, options = {}) => openDialog({
      message,
      type: 'error',
      title: options.title || 'خطأ',
      confirmText: options.confirmText || 'حسناً',
      ...options,
    }).then(() => {}),
    warning: (message, options = {}) => openDialog({
      message,
      type: 'warning',
      title: options.title || 'تحذير',
      confirmText: options.confirmText || 'حسناً',
      ...options,
    }).then(() => {}),
    info: (message, options = {}) => openDialog({
      message,
      type: 'info',
      title: options.title || 'معلومة',
      confirmText: options.confirmText || 'حسناً',
      ...options,
    }).then(() => {}),
  }), [openDialog])

  return (
    <DialogContext.Provider value={api}>
      {children}
      <DialogModal 
        {...dialog} 
        onConfirm={handleConfirm} 
        onCancel={handleCancel}
      />
    </DialogContext.Provider>
  )
}

// ===== مكون الحوار =====
type DialogModalProps = DialogState & {
  onConfirm: () => void
  onCancel: () => void
}

const DialogModal: React.FC<DialogModalProps> = ({
  isOpen,
  title,
  message,
  type = 'confirm',
  confirmText = 'تأكيد',
  cancelText = 'إلغاء',
  dangerous,
  onConfirm,
  onCancel,
}) => {
  if (!isOpen) return null

  // ألوان وأيقونات حسب النوع
  const config = {
    confirm: {
      icon: <Info className="w-8 h-8" />,
      iconBg: 'bg-sky-100',
      iconColor: 'text-sky-600',
      buttonColor: dangerous ? 'bg-red-600 hover:bg-red-700' : 'bg-sky-600 hover:bg-sky-700',
    },
    alert: {
      icon: <AlertTriangle className="w-8 h-8" />,
      iconBg: 'bg-amber-100',
      iconColor: 'text-amber-600',
      buttonColor: 'bg-amber-600 hover:bg-amber-700',
    },
    success: {
      icon: <CheckCircle className="w-8 h-8" />,
      iconBg: 'bg-green-100',
      iconColor: 'text-green-600',
      buttonColor: 'bg-green-600 hover:bg-green-700',
    },
    error: {
      icon: <XCircle className="w-8 h-8" />,
      iconBg: 'bg-red-100',
      iconColor: 'text-red-600',
      buttonColor: 'bg-red-600 hover:bg-red-700',
    },
    warning: {
      icon: <AlertTriangle className="w-8 h-8" />,
      iconBg: 'bg-orange-100',
      iconColor: 'text-orange-600',
      buttonColor: 'bg-orange-600 hover:bg-orange-700',
    },
    info: {
      icon: <Info className="w-8 h-8" />,
      iconBg: 'bg-blue-100',
      iconColor: 'text-blue-600',
      buttonColor: 'bg-blue-600 hover:bg-blue-700',
    },
  }

  const c = config[type]
  const showCancel = type === 'confirm'

  return (
    <>
      {/* Backdrop */}
      <div 
        className="fixed inset-0 bg-black/50 backdrop-blur-sm z-[9998] animate-fadeIn"
        onClick={onCancel}
      />
      
      {/* Dialog */}
      <div className="fixed inset-0 z-[9999] flex items-center justify-center p-4 pointer-events-none">
        <div 
          className="bg-white rounded-2xl shadow-2xl w-full max-w-sm pointer-events-auto animate-scaleIn overflow-hidden"
          onClick={(e) => e.stopPropagation()}
        >
          {/* Header */}
          <div className="relative p-6 pb-0">
            {/* زر الإغلاق */}
            <button
              onClick={onCancel}
              className="absolute top-4 left-4 p-1.5 rounded-lg hover:bg-gray-100 transition text-gray-400 hover:text-gray-600"
            >
              <X className="w-5 h-5" />
            </button>
            
            {/* الأيقونة */}
            <div className="flex justify-center mb-4">
              <div className={`w-16 h-16 rounded-full ${c.iconBg} ${c.iconColor} flex items-center justify-center`}>
                {c.icon}
              </div>
            </div>
            
            {/* العنوان */}
            <h3 className="text-xl font-bold text-center text-gray-900">
              {title}
            </h3>
          </div>
          
          {/* المحتوى */}
          <div className="p-6 pt-3">
            <p className="text-center text-gray-600 leading-relaxed">
              {message}
            </p>
          </div>
          
          {/* الأزرار */}
          <div className={`p-4 pt-0 flex gap-3 ${showCancel ? 'flex-row-reverse' : 'justify-center'}`}>
            <button
              onClick={onConfirm}
              className={`flex-1 py-3 px-6 rounded-xl font-bold text-white transition-all duration-200 hover:scale-[1.02] active:scale-[0.98] ${c.buttonColor}`}
            >
              {confirmText}
            </button>
            
            {showCancel && (
              <button
                onClick={onCancel}
                className="flex-1 py-3 px-6 rounded-xl font-bold text-gray-700 bg-gray-100 hover:bg-gray-200 transition-all duration-200 hover:scale-[1.02] active:scale-[0.98]"
              >
                {cancelText}
              </button>
            )}
          </div>
        </div>
      </div>
      
      {/* أنيميشن */}
      <style>{`
        @keyframes fadeIn {
          from { opacity: 0; }
          to { opacity: 1; }
        }
        @keyframes scaleIn {
          from { opacity: 0; transform: scale(0.9); }
          to { opacity: 1; transform: scale(1); }
        }
        .animate-fadeIn {
          animation: fadeIn 0.2s ease-out;
        }
        .animate-scaleIn {
          animation: scaleIn 0.2s ease-out;
        }
      `}</style>
    </>
  )
}

export default DialogProvider

==========================================================================================
FILE: src/components/ui/Toast.tsx
==========================================================================================
import React, { createContext, useCallback, useContext, useEffect, useMemo, useState } from "react"

type ToastType = "success" | "error" | "info" | "warning"

export type ToastItem = {
  id: string
  type: ToastType
  title?: string
  message: string
  duration?: number // ms
}

type ToastCtx = {
  show: (msg: string, opts?: Partial<Omit<ToastItem, "id" | "message">>) => void
  success: (msg: string, opts?: Partial<Omit<ToastItem, "id" | "message">>) => void
  error: (msg: string, opts?: Partial<Omit<ToastItem, "id" | "message">>) => void
  info: (msg: string, opts?: Partial<Omit<ToastItem, "id" | "message">>) => void
  warning: (msg: string, opts?: Partial<Omit<ToastItem, "id" | "message">>) => void
}

const ToastContext = createContext<ToastCtx | null>(null)

export const useToast = () => {
  const ctx = useContext(ToastContext)
  if (!ctx) throw new Error("useToast must be used within ToastProvider")
  return ctx
}

export const ToastProvider: React.FC<{ children: React.ReactNode }> = ({ children }) => {
  const [items, setItems] = useState<ToastItem[]>([])

  const remove = useCallback((id: string) => {
    setItems(prev => prev.filter(t => t.id !== id))
  }, [])

  const push = useCallback((message: string, type: ToastType, opts?: Partial<Omit<ToastItem, "id" | "message">>) => {
    const id = Math.random().toString(36).slice(2)
    const item: ToastItem = {
      id,
      message,
      type,
      title: opts?.title,
      duration: opts?.duration ?? 3000,
    }
    setItems(prev => [...prev, item])
    if (item.duration && item.duration > 0) {
      setTimeout(() => remove(id), item.duration)
    }
  }, [remove])

  const api: ToastCtx = useMemo(() => ({
    show: (m, o) => push(m, o?.type ?? "info", o),
    success: (m, o) => push(m, "success", o),
    error: (m, o) => push(m, "error", o),
    info: (m, o) => push(m, "info", o),
    warning: (m, o) => push(m, "warning", o),
  }), [push])

  return (
    <ToastContext.Provider value={api}>
      {children}
      <ToastContainer items={items} onClose={remove} />
    </ToastContext.Provider>
  )
}

const typeStyles: Record<ToastType, string> = {
  success: "bg-green-600 text-white",
  error: "bg-red-600 text-white",
  info: "bg-slate-800 text-white",
  warning: "bg-yellow-500 text-black",
}

const typeIcon: Record<ToastType, string> = {
  success: "",
  error: "",
  info: "ℹ",
  warning: "",
}

const ToastContainer: React.FC<{ items: ToastItem[]; onClose: (id: string) => void }> = ({ items, onClose }) => {
  // يمنع تداخل لوحة الجوال مع أزرار أسفل الشاشة
  useEffect(() => {
    // اختياري
  }, [])
  return (
    <div className="fixed z-[9999] inset-0 pointer-events-none flex flex-col items-center sm:items-end gap-2 p-4 sm:p-6">
      <div className="mt-auto w-full sm:w-auto flex flex-col gap-2">
        {items.map(t => (
          <div
            key={t.id}
            className={`pointer-events-auto ${typeStyles[t.type]} rounded-2xl shadow-lg px-4 py-3 sm:min-w-[320px] animate-[toastIn_.2s_ease]`}
          >
            <div className="flex items-start gap-3">
              <div className="text-xl leading-none">{typeIcon[t.type]}</div>
              <div className="flex-1">
                {t.title && <div className="font-bold">{t.title}</div>}
                <div className="text-sm">{t.message}</div>
              </div>
              <button
                onClick={() => onClose(t.id)}
                className="opacity-80 hover:opacity-100 transition"
                aria-label="Close"
              >×</button>
            </div>
          </div>
        ))}
      </div>

      {/* حركات بسيطة */}
      <style>
        {`@keyframes toastIn{from{transform:translateY(8px);opacity:0}to{transform:translateY(0);opacity:1}}`}
      </style>
    </div>
  )
}

==========================================================================================
FILE: src/context/CartContext.tsx
==========================================================================================
/**
 *  DEPRECATED: This file is kept only for backwards compatibility during migration.
 * Please use hooks/useCart.ts instead.
 * 
 * This context was replaced with useCart hook that uses localStorage,
 * providing better persistence and simpler state management.
 */

import React, { createContext } from "react";

const CartContext = createContext<any>(undefined);

// This provider is now a no-op since CartProvider is not needed
export const CartProvider: React.FC<{ children: React.ReactNode }> = ({ children }) => {
  return <>{children}</>;
};

==========================================================================================
FILE: src/firebase.ts
==========================================================================================
// src/firebase.ts
import { initializeApp, getApps, getApp } from "firebase/app"
import { getAuth, indexedDBLocalPersistence, browserLocalPersistence, initializeAuth } from "firebase/auth"
import { getFirestore } from "firebase/firestore"
import { getStorage } from "firebase/storage"

const firebaseConfig = {
  apiKey: "AIzaSyC1iM3g3gGfu23GKLpDRQplBuHidPniFIk",
  authDomain: "albayt-sofra.firebaseapp.com",
  projectId: "albayt-sofra",
  storageBucket: "albayt-sofra.firebasestorage.app",
  messagingSenderId: "895117143740",
  appId: "1:895117143740:web:239cfccc93d101c1f36ab9",
  measurementId: "G-FK3746ERH8",
}

export const app = getApps().length ? getApp() : initializeApp(firebaseConfig)

//  تهيئة Auth مع persistence محلي (IndexedDB أولاً ثم localStorage)
// هذا يضمن حفظ الجلسة حتى بعد إغلاق التطبيق على الجوال
export const auth = getApps().length > 0 
  ? getAuth(app)
  : initializeAuth(app, {
      persistence: [indexedDBLocalPersistence, browserLocalPersistence]
    })

export const db = getFirestore(app)
export const storage = getStorage(app)

==========================================================================================
FILE: src/hooks/useCart.ts
==========================================================================================
import { useCallback, useEffect, useMemo, useState } from 'react'

export type CartItem = {
  id: string
  name: string
  price: number
  qty: number
  ownerId?: string   //  أضفنا خاصية المطعم
}

const KEY = 'broast_cart'

export function useCart() {
  const [items, setItems] = useState<CartItem[]>(() => {
    try {
      const raw = localStorage.getItem(KEY)
      return raw ? JSON.parse(raw) : []
    } catch { 
      return [] 
    }
  })

  useEffect(() => {
    localStorage.setItem(KEY, JSON.stringify(items))
  }, [items])

  //  استخدام useCallback لمنع إعادة إنشاء الدوال في كل render
  const add = useCallback((it: Omit<CartItem, 'qty'>, qty = 1) => {
    setItems(prev => {
      const idx = prev.findIndex(p => p.id === it.id)
      if (idx >= 0) {
        const copy = [...prev]
        copy[idx] = { 
          ...copy[idx], 
          qty: copy[idx].qty + qty,
          ownerId: it.ownerId ?? copy[idx].ownerId  //  نحافظ على ownerId
        }
        return copy
      }
      return [...prev, { ...it, qty }]
    })
  }, [])

  const remove = useCallback((id: string) => 
    setItems(prev => prev.filter(p => p.id !== id)), [])

  const changeQty = useCallback((id: string, qty: number) => 
    setItems(prev => prev.map(p => p.id === id ? { ...p, qty } : p)), [])

  const clear = useCallback(() => setItems([]), [])

  //  استخدام useMemo لحساب المجموع فقط عند تغيير items
  const subtotal = useMemo(() => 
    items.reduce((s, it) => s + it.price * it.qty, 0), [items])

  return { items, add, remove, changeQty, clear, subtotal }
}

==========================================================================================
FILE: src/main.tsx
==========================================================================================
// src/main.tsx أو src/index.tsx
import React from 'react'
import ReactDOM from 'react-dom/client'
import { BrowserRouter } from 'react-router-dom'
import App from './App'
import './index.css'
import { AuthProvider } from './auth'
import { CartProvider } from './context/CartContext'   //  استيراد مزود السلة
import { ToastProvider } from './components/ui/Toast'
import { DialogProvider } from './components/ui/ConfirmDialog' //  نظام الحوارات

ReactDOM.createRoot(document.getElementById('root')!).render(
  <React.StrictMode>
    <BrowserRouter>
      <ToastProvider>
        <DialogProvider>
          <AuthProvider>
            <CartProvider>   {/*  لف التطبيق بالسلة */}
              <App />
            </CartProvider>
          </AuthProvider>
        </DialogProvider>
      </ToastProvider>
    </BrowserRouter>
  </React.StrictMode>,
)

==========================================================================================
FILE: src/pages/AccountDeleted.tsx
==========================================================================================
// src/pages/AccountDeleted.tsx
import React from "react";
import { Link } from "react-router-dom";

export default function AccountDeleted() {
  return (
    <div className="flex flex-col items-center justify-center min-h-screen bg-gray-100 text-center">
      <h1 className="text-2xl font-bold text-red-600 mb-4">
        تم حذف حسابك بنجاح
      </h1>
      <p className="text-gray-600 mb-6">
        نأسف لمغادرتك  يمكنك العودة في أي وقت وإنشاء حساب جديد.
      </p>
      <Link
        to="/"
        className="text-white bg-red-500 px-6 py-2 rounded-lg hover:bg-red-600"
      >
        الرجوع إلى الصفحة الرئيسية
      </Link>
    </div>
  );
}

==========================================================================================
FILE: src/pages/AdminDashboard.tsx
==========================================================================================
import React, { useEffect, useState } from 'react'
import { Link } from 'react-router-dom'
import { Building2, ShoppingCart, Wallet, BarChart3, User as UserIcon, ClipboardList, CheckCircle, Store, ChevronDown, ChevronUp } from 'lucide-react'
import { useAuth } from '@/auth'
import { RoleGate } from '@/routes/RoleGate'
import { collection, getDocs, doc, getDoc, query, where, updateDoc, serverTimestamp, limit, getCountFromServer } from 'firebase/firestore'
import { db } from '@/firebase'
import { Order, Restaurant, User } from '@/types'
import { useToast } from '@/components/ui/Toast'

type Task = {
  id: string
  title: string
  description?: string
  assignedTo: string
  assignedToName?: string
  status: 'pending' | 'in_progress' | 'completed' | 'cancelled'
  priority: 'low' | 'medium' | 'high'
  dueDate?: string
  createdBy: string
  createdAt: any
  updatedAt: any
  completedAt?: any
  notes?: string
}

type AdminStats = {
  totalRestaurants: number
  totalOrders: number
  totalEarnings: number
  pendingOrders: number
}

type TabType = 'dashboard' | 'profile' | 'tasks' | 'myRestaurants'

export const AdminDashboard: React.FC = () => {
  const { user, role } = useAuth()
  const toast = useToast()
  const [activeTab, setActiveTab] = useState<TabType>('dashboard')
  const [stats, setStats] = useState<AdminStats>({
    totalRestaurants: 0,
    totalOrders: 0,
    totalEarnings: 0,
    pendingOrders: 0,
  })
  const [walletBalance, setWalletBalance] = useState(0)
  const [loading, setLoading] = useState(true)
  const [adminData, setAdminData] = useState<User | null>(null)
  const [myTasks, setMyTasks] = useState<Task[]>([])
  const [taskFilter, setTaskFilter] = useState<'all' | 'pending' | 'in_progress' | 'completed'>('all')
  // قائمة المطاعم التابعة للمشرف
  const [myRestaurants, setMyRestaurants] = useState<Restaurant[]>([])
  const [expandedRestaurant, setExpandedRestaurant] = useState<string | null>(null)

  // تحميل الإحصائيات
  useEffect(() => {
    if (!user) return

    (async () => {
      try {
        //  جلب المطاعم التابعة للمشرف فقط (referredBy = user.uid)
        const myRestaurantsQuery = query(
          collection(db, 'restaurants'),
          where('referredBy', '==', user.uid)
        )
        const myRestaurantsSnap = await getDocs(myRestaurantsQuery)
        const myRestaurantsData = myRestaurantsSnap.docs.map(d => ({
          id: d.id,
          ...d.data()
        } as Restaurant))
        setMyRestaurants(myRestaurantsData)
        const totalRestaurants = myRestaurantsData.length

        //  جلب الطلبات للمطاعم التابعة للمشرف فقط
        const restaurantIds = myRestaurantsData.map(r => r.id)
        let pendingOrders = 0
        let totalOrders = 0
        let totalEarnings = 0

        if (restaurantIds.length > 0) {
          // جلب الطلبات المعلقة للمطاعم التابعة
          const pendingQuery = query(
            collection(db, 'orders'),
            where('status', '==', 'pending'),
            limit(100)
          )
          const pendingSnap = await getDocs(pendingQuery)
          pendingOrders = pendingSnap.docs.filter(d => restaurantIds.includes(d.data().restaurantId)).length

          // جلب كل الطلبات للمطاعم التابعة
          const ordersSnap = await getDocs(collection(db, 'orders'))
          const myOrders = ordersSnap.docs.filter(d => restaurantIds.includes(d.data().restaurantId))
          totalOrders = myOrders.length
          totalEarnings = myOrders.reduce((sum, d) => sum + (d.data().deliveryFee || 0), 0)
        }

        // جلب محفظة الإدمن
        try {
          const walletSnap = await getDoc(doc(db, 'wallets', user.uid))
          const walletData = walletSnap.data()
          setWalletBalance(walletData?.balance || 0)
        } catch {
          setWalletBalance(0)
        }

        // جلب المهام المسندة للمشرف
        try {
          const tasksQuery = query(collection(db, 'tasks'), where('assignedTo', '==', user.uid))
          const tasksSnap = await getDocs(tasksQuery)
          const tasksData = tasksSnap.docs.map(d => ({ id: d.id, ...d.data() } as Task))
          setMyTasks(tasksData.sort((a, b) => (b.createdAt?.seconds || 0) - (a.createdAt?.seconds || 0)))
        } catch (err) {
          console.error('خطأ في تحميل المهام:', err)
        }

        setStats({
          totalRestaurants,
          totalOrders,
          totalEarnings,
          pendingOrders,
        })
      } catch (err) {
        console.error('خطأ في تحميل الإحصائيات:', err)
      } finally {
        setLoading(false)
      }
    })()
  }, [user])

  // تحديث حالة المهمة
  const updateTaskStatus = async (taskId: string, newStatus: Task['status']) => {
    try {
      const updateData: any = {
        status: newStatus,
        updatedAt: serverTimestamp()
      }
      if (newStatus === 'completed') {
        updateData.completedAt = serverTimestamp()
      }
      await updateDoc(doc(db, 'tasks', taskId), updateData)
      setMyTasks(prev => prev.map(t => 
        t.id === taskId ? { ...t, status: newStatus } : t
      ))
      toast.success(
        newStatus === 'in_progress' ? 'تم بدء المهمة' :
        newStatus === 'completed' ? 'تم إكمال المهمة بنجاح! ' :
        'تم تحديث المهمة'
      )
    } catch (err) {
      toast.error('فشل في تحديث المهمة')
    }
  }

  // تحميل بيانات المشرف الحالي
  useEffect(() => {
    if (!user) return

    (async () => {
      try {
        const userSnap = await getDoc(doc(db, 'users', user.uid))
        if (userSnap.exists()) {
          setAdminData({ uid: userSnap.id, ...userSnap.data() } as User)
        }
      } catch (err) {
        console.error('خطأ في تحميل بيانات المشرف:', err)
      }
    })()
  }, [user])

  if (loading) {
    return (
      <RoleGate allow={['admin']}>
        <div className="flex items-center justify-center h-96 text-lg">
          جارِ التحميل...
        </div>
      </RoleGate>
    )
  }

  return (
    <RoleGate allow={['admin']}>
      <div className="space-y-8">
        {/* رأس الصفحة */}
        <div className="text-center mb-8">
          <h1 className="text-4xl font-extrabold text-primary">لوحة تحكم الإدارة</h1>
          <p className="text-gray-600 mt-2">أهلاً بك يا مشرف! </p>
        </div>

        {/* التبويبات */}
        <div className="flex justify-center gap-4 mb-6 flex-wrap">
          <button
            onClick={() => setActiveTab('dashboard')}
            className={`px-6 py-3 rounded-xl font-bold transition flex items-center gap-2 ${
              activeTab === 'dashboard'
                ? 'bg-primary text-white shadow-lg'
                : 'bg-gray-100 text-gray-700 hover:bg-gray-200'
            }`}
          >
            <BarChart3 className="w-5 h-5" />
            لوحة التحكم
          </button>
          <button
            onClick={() => setActiveTab('myRestaurants')}
            className={`px-6 py-3 rounded-xl font-bold transition flex items-center gap-2 relative ${
              activeTab === 'myRestaurants'
                ? 'bg-primary text-white shadow-lg'
                : 'bg-gray-100 text-gray-700 hover:bg-gray-200'
            }`}
          >
            <Store className="w-5 h-5" />
            مطاعمي
            <span className="bg-white/20 text-xs px-2 py-0.5 rounded-full">
              {myRestaurants.length}
            </span>
          </button>
          <button
            onClick={() => setActiveTab('profile')}
            className={`px-6 py-3 rounded-xl font-bold transition flex items-center gap-2 ${
              activeTab === 'profile'
                ? 'bg-primary text-white shadow-lg'
                : 'bg-gray-100 text-gray-700 hover:bg-gray-200'
            }`}
          >
            <UserIcon className="w-5 h-5" />
            بياناتي
          </button>
          <button
            onClick={() => setActiveTab('tasks')}
            className={`px-6 py-3 rounded-xl font-bold transition flex items-center gap-2 relative ${
              activeTab === 'tasks'
                ? 'bg-primary text-white shadow-lg'
                : 'bg-gray-100 text-gray-700 hover:bg-gray-200'
            }`}
          >
            <ClipboardList className="w-5 h-5" />
            مهامي
            {myTasks.filter(t => t.status === 'pending' || t.status === 'in_progress').length > 0 && (
              <span className="absolute -top-1 -right-1 bg-red-500 text-white text-xs w-5 h-5 rounded-full flex items-center justify-center">
                {myTasks.filter(t => t.status === 'pending' || t.status === 'in_progress').length}
              </span>
            )}
          </button>
        </div>

        {/* محتوى التبويب: مطاعمي */}
        {activeTab === 'myRestaurants' && (
          <div className="space-y-6">
            {/* إحصائيات سريعة */}
            <div className="bg-gradient-to-r from-primary to-sky-700 rounded-2xl shadow-lg p-6 text-white">
              <div className="flex items-center justify-between flex-wrap gap-4">
                <div>
                  <p className="text-sm opacity-90">إجمالي مطاعمي المسجلة</p>
                  <h2 className="text-4xl font-bold">{myRestaurants.length}</h2>
                  <p className="text-sm opacity-75 mt-2"> ستحصلين على عمولة من كل طلب لهذه المطاعم</p>
                </div>
                <Store className="w-16 h-16 opacity-80" />
              </div>
            </div>

            {/* قائمة المطاعم */}
            <div className="bg-white rounded-2xl shadow-lg p-6">
              <h2 className="text-2xl font-bold text-primary mb-6 flex items-center gap-2">
                <Store className="w-6 h-6" />
                المطاعم المسجلة بواسطتي
              </h2>

              {myRestaurants.length === 0 ? (
                <div className="text-center py-12 text-gray-500">
                  <p className="text-5xl mb-4"></p>
                  <p className="text-lg font-semibold">لم تقومي بتسجيل أي مطعم بعد</p>
                  <p className="text-sm mt-2">اضغطي على "إضافة مطعم جديد" لبدء تسجيل المطاعم</p>
                  <Link
                    to="/admin/add-restaurant"
                    className="inline-block mt-4 bg-primary hover:bg-red-900 text-white px-6 py-3 rounded-xl font-semibold transition"
                  >
                     إضافة مطعم جديد
                  </Link>
                </div>
              ) : (
                <div className="space-y-4">
                  {myRestaurants.map(restaurant => (
                    <div 
                      key={restaurant.id} 
                      className="border-2 rounded-2xl overflow-hidden hover:border-primary transition"
                    >
                      {/* رأس المطعم */}
                      <div 
                        className="p-4 cursor-pointer hover:bg-gray-50 flex items-center justify-between"
                        onClick={() => setExpandedRestaurant(expandedRestaurant === restaurant.id ? null : restaurant.id)}
                      >
                        <div className="flex items-center gap-4">
                          <div className="w-14 h-14 rounded-xl bg-gray-100 overflow-hidden flex-shrink-0">
                            {restaurant.logoUrl ? (
                              <img src={restaurant.logoUrl} alt={restaurant.name} className="w-full h-full object-cover" />
                            ) : (
                              <div className="w-full h-full flex items-center justify-center text-2xl"></div>
                            )}
                          </div>
                          <div>
                            <h3 className="font-bold text-lg text-gray-800">{restaurant.name}</h3>
                            <p className="text-sm text-gray-500">
                              {restaurant.city || 'غير محدد'} • {restaurant.phone || 'بدون رقم'}
                            </p>
                            <div className="flex items-center gap-2 mt-1">
                              {restaurant.isVerified ? (
                                <span className="inline-flex items-center gap-1 px-2 py-0.5 bg-green-100 text-green-700 text-xs font-semibold rounded-full">
                                   موثق
                                </span>
                              ) : (
                                <span className="inline-flex items-center gap-1 px-2 py-0.5 bg-gray-100 text-gray-600 text-xs font-semibold rounded-full">
                                   غير موثق
                                </span>
                              )}
                              {restaurant.packageType === 'premium' && (
                                <span className="inline-flex items-center gap-1 px-2 py-0.5 bg-amber-100 text-amber-700 text-xs font-semibold rounded-full">
                                   مميز
                                </span>
                              )}
                            </div>
                          </div>
                        </div>
                        
                        <div className="flex items-center gap-2">
                          {expandedRestaurant === restaurant.id ? (
                            <ChevronUp className="w-5 h-5 text-gray-400" />
                          ) : (
                            <ChevronDown className="w-5 h-5 text-gray-400" />
                          )}
                        </div>
                      </div>

                      {/* تفاصيل المطعم */}
                      {expandedRestaurant === restaurant.id && (
                        <div className="border-t bg-gray-50 p-4">
                          <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
                            <div className="bg-white rounded-xl p-3 text-center">
                              <p className="text-xs text-gray-500">المعرّف</p>
                              <p className="font-mono text-xs text-gray-700 truncate">{restaurant.id}</p>
                            </div>
                            <div className="bg-white rounded-xl p-3 text-center">
                              <p className="text-xs text-gray-500">البريد</p>
                              <p className="text-sm text-gray-700 truncate">{restaurant.email || '-'}</p>
                            </div>
                            <div className="bg-white rounded-xl p-3 text-center">
                              <p className="text-xs text-gray-500">الموقع</p>
                              <p className="text-sm text-gray-700 truncate">{restaurant.location || '-'}</p>
                            </div>
                            <div className="bg-white rounded-xl p-3 text-center">
                              <p className="text-xs text-gray-500">تاريخ التسجيل</p>
                              <p className="text-sm text-gray-700">
                                {(restaurant.createdAt as any)?.toDate?.()?.toLocaleDateString('ar-SA') || 
                                 (restaurant.createdAt instanceof Date ? restaurant.createdAt.toLocaleDateString('ar-SA') : '-')}
                              </p>
                            </div>
                          </div>
                        </div>
                      )}
                    </div>
                  ))}
                </div>
              )}

              {myRestaurants.length > 0 && (
                <Link
                  to="/admin/add-restaurant"
                  className="block mt-6 w-full bg-primary hover:bg-red-900 text-white rounded-xl p-3 text-center font-semibold transition"
                >
                   إضافة مطعم جديد
                </Link>
              )}
            </div>
          </div>
        )}

        {/* محتوى التبويب: بياناتي */}
        {activeTab === 'profile' && (
          <div className="bg-white rounded-2xl shadow-lg p-6">
            <h2 className="text-2xl font-bold text-primary mb-6 flex items-center gap-2">
              <UserIcon className="w-6 h-6" />
              بياناتي
            </h2>
            
            {!adminData ? (
              <div className="text-center py-8 text-gray-600">جارِ التحميل...</div>
            ) : (
              <div className="space-y-6">
                {/* بطاقة البيانات */}
                <div className="bg-gradient-to-r from-sky-50 to-blue-50 rounded-2xl p-6">
                  <div className="flex items-center gap-4 mb-6">
                    <div className="w-20 h-20 bg-primary rounded-full flex items-center justify-center text-white text-3xl font-bold">
                      {adminData.name?.charAt(0) || adminData.email?.charAt(0) || '؟'}
                    </div>
                    <div>
                      <h3 className="text-2xl font-bold text-gray-900">
                        {adminData.name || 'بدون اسم'}
                      </h3>
                      <span className="inline-flex items-center px-3 py-1 rounded-full text-sm font-bold bg-sky-100 text-sky-800 mt-2">
                         مشرف
                      </span>
                    </div>
                  </div>
                  
                  <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div className="bg-white rounded-xl p-4 shadow-sm">
                      <p className="text-sm text-gray-500 mb-1">البريد الإلكتروني</p>
                      <p className="font-semibold text-gray-900 font-mono">{adminData.email}</p>
                    </div>
                    <div className="bg-white rounded-xl p-4 shadow-sm">
                      <p className="text-sm text-gray-500 mb-1">الدور</p>
                      <p className="font-semibold text-gray-900">{role === 'admin' ? 'مشرف' : role}</p>
                    </div>
                    <div className="bg-white rounded-xl p-4 shadow-sm">
                      <p className="text-sm text-gray-500 mb-1">معرّف المستخدم</p>
                      <p className="font-semibold text-gray-600 text-xs font-mono break-all">{adminData.uid}</p>
                    </div>
                    <div className="bg-white rounded-xl p-4 shadow-sm">
                      <p className="text-sm text-gray-500 mb-1">رصيد المحفظة</p>
                      <p className="font-bold text-green-600 text-xl">{walletBalance.toFixed(2)} ر.س</p>
                    </div>
                  </div>
                </div>

                {/* رابط تعديل الملف الشخصي */}
                <Link
                  to="/profile"
                  className="block w-full bg-gray-100 hover:bg-gray-200 text-gray-800 rounded-xl p-4 text-center font-semibold transition"
                >
                   تعديل الملف الشخصي
                </Link>
              </div>
            )}
          </div>
        )}

        {/* محتوى التبويب: مهامي */}
        {activeTab === 'tasks' && (
          <div className="space-y-6">
            <div className="bg-white rounded-2xl shadow-lg p-6">
              <h2 className="text-2xl font-bold text-primary mb-6 flex items-center gap-2">
                <ClipboardList className="w-6 h-6" />
                مهامي اليومية
              </h2>

              {/* فلترة المهام */}
              <div className="flex flex-wrap gap-2 mb-6">
                {(['all', 'pending', 'in_progress', 'completed'] as const).map(filter => (
                  <button
                    key={filter}
                    onClick={() => setTaskFilter(filter)}
                    className={`px-4 py-2 rounded-xl font-semibold transition ${
                      taskFilter === filter
                        ? 'bg-primary text-white'
                        : 'bg-gray-100 text-gray-700 hover:bg-gray-200'
                    }`}
                  >
                    {filter === 'all' && ' الكل'}
                    {filter === 'pending' && ' قيد الانتظار'}
                    {filter === 'in_progress' && ' جاري التنفيذ'}
                    {filter === 'completed' && ' مكتملة'}
                  </button>
                ))}
              </div>

              {/* إحصائيات سريعة */}
              <div className="grid grid-cols-3 gap-4 mb-6">
                <div className="bg-yellow-50 rounded-xl p-4 text-center">
                  <p className="text-2xl font-bold text-yellow-600">
                    {myTasks.filter(t => t.status === 'pending').length}
                  </p>
                  <p className="text-sm text-yellow-700">قيد الانتظار</p>
                </div>
                <div className="bg-blue-50 rounded-xl p-4 text-center">
                  <p className="text-2xl font-bold text-blue-600">
                    {myTasks.filter(t => t.status === 'in_progress').length}
                  </p>
                  <p className="text-sm text-blue-700">جاري التنفيذ</p>
                </div>
                <div className="bg-green-50 rounded-xl p-4 text-center">
                  <p className="text-2xl font-bold text-green-600">
                    {myTasks.filter(t => t.status === 'completed').length}
                  </p>
                  <p className="text-sm text-green-700">مكتملة</p>
                </div>
              </div>

              {/* قائمة المهام */}
              {myTasks
                .filter(t => taskFilter === 'all' || t.status === taskFilter)
                .length === 0 ? (
                <div className="text-center py-12 text-gray-500">
                  <p className="text-5xl mb-4"></p>
                  <p className="text-lg">لا توجد مهام {taskFilter !== 'all' && 'في هذه الفئة'}</p>
                  <p className="text-sm mt-2">ستظهر هنا المهام التي يسندها لك المطور</p>
                </div>
              ) : (
                <div className="space-y-4">
                  {myTasks
                    .filter(t => taskFilter === 'all' || t.status === taskFilter)
                    .map(task => (
                      <div
                        key={task.id}
                        className={`border-2 rounded-2xl p-4 transition ${
                          task.status === 'completed' ? 'bg-green-50 border-green-200' :
                          task.status === 'in_progress' ? 'bg-blue-50 border-blue-200' :
                          task.priority === 'high' ? 'bg-red-50 border-red-200' :
                          'bg-white border-gray-200'
                        }`}
                      >
                        <div className="flex items-start justify-between gap-4">
                          <div className="flex-1">
                            <div className="flex items-center gap-2 mb-2">
                              <span className={`px-2 py-0.5 rounded text-xs font-semibold ${
                                task.priority === 'high' ? 'bg-red-100 text-red-700' :
                                task.priority === 'medium' ? 'bg-yellow-100 text-yellow-700' :
                                'bg-gray-100 text-gray-700'
                              }`}>
                                {task.priority === 'high' ? ' عالية' : task.priority === 'medium' ? ' متوسطة' : ' منخفضة'}
                              </span>
                              <span className={`px-2 py-0.5 rounded text-xs font-semibold ${
                                task.status === 'pending' ? 'bg-yellow-100 text-yellow-700' :
                                task.status === 'in_progress' ? 'bg-blue-100 text-blue-700' :
                                task.status === 'completed' ? 'bg-green-100 text-green-700' :
                                'bg-red-100 text-red-700'
                              }`}>
                                {task.status === 'pending' && ' قيد الانتظار'}
                                {task.status === 'in_progress' && ' جاري التنفيذ'}
                                {task.status === 'completed' && ' مكتملة'}
                                {task.status === 'cancelled' && ' ملغاة'}
                              </span>
                            </div>
                            <h3 className="font-bold text-lg text-gray-800">{task.title}</h3>
                            {task.description && (
                              <p className="text-gray-600 mt-1">{task.description}</p>
                            )}
                            <div className="flex flex-wrap gap-3 mt-3 text-sm text-gray-500">
                              {task.dueDate && (
                                <span className={new Date(task.dueDate) < new Date() && task.status !== 'completed' ? 'text-red-600 font-semibold' : ''}>
                                   {new Date(task.dueDate).toLocaleDateString('ar-SA')}
                                  {new Date(task.dueDate) < new Date() && task.status !== 'completed' && ' (متأخرة!)'}
                                </span>
                              )}
                              <span> {task.createdAt?.toDate?.()?.toLocaleDateString('ar-SA') || 'غير محدد'}</span>
                            </div>
                            {task.notes && (
                              <p className="text-sm text-gray-500 mt-2 bg-gray-100 p-2 rounded"> {task.notes}</p>
                            )}
                          </div>
                          
                          {/* أزرار التحكم */}
                          <div className="flex flex-col gap-2">
                            {task.status === 'pending' && (
                              <button
                                onClick={() => updateTaskStatus(task.id, 'in_progress')}
                                className="flex items-center gap-2 bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-xl font-semibold transition"
                              >
                                 بدء
                              </button>
                            )}
                            {task.status === 'in_progress' && (
                              <button
                                onClick={() => updateTaskStatus(task.id, 'completed')}
                                className="flex items-center gap-2 bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-xl font-semibold transition"
                              >
                                <CheckCircle className="w-4 h-4" />
                                إكمال
                              </button>
                            )}
                            {task.status === 'completed' && (
                              <span className="text-green-600 font-semibold text-center">
                                 تم الإنجاز
                              </span>
                            )}
                          </div>
                        </div>
                      </div>
                    ))}
                </div>
              )}
            </div>
          </div>
        )}

        {/* محتوى التبويب: لوحة التحكم */}
        {activeTab === 'dashboard' && (
          <>
        {/* المحفظة */}
        <div className="bg-gradient-to-r from-primary to-sky-700 rounded-2xl shadow-lg p-6 text-white">
          <div className="flex items-center justify-between">
            <div>
              <p className="text-sm opacity-90">رصيد المحفظة</p>
              <h2 className="text-3xl font-bold">{walletBalance.toFixed(2)} ر.س</h2>
              <p className="text-sm opacity-75 mt-2"> تحصل على 50 هللة من كل طلب للمطاعم التي أضفتها</p>
            </div>
            <Wallet className="w-16 h-16 opacity-80" />
          </div>
        </div>

        {/* الإحصائيات */}
        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
          {/* المطاعم */}
          <div className="bg-white rounded-2xl shadow p-6 hover:shadow-lg transition">
            <div className="flex items-center justify-between">
              <div>
                <p className="text-gray-600 text-sm">المطاعم المضافة</p>
                <h3 className="text-3xl font-bold text-primary mt-2">{stats.totalRestaurants}</h3>
              </div>
              <Building2 className="w-12 h-12 text-primary opacity-30" />
            </div>
          </div>

          {/* الطلبات الكلية */}
          <div className="bg-white rounded-2xl shadow p-6 hover:shadow-lg transition">
            <div className="flex items-center justify-between">
              <div>
                <p className="text-gray-600 text-sm">إجمالي الطلبات</p>
                <h3 className="text-3xl font-bold text-blue-600 mt-2">{stats.totalOrders}</h3>
              </div>
              <ShoppingCart className="w-12 h-12 text-blue-600 opacity-30" />
            </div>
          </div>

          {/* الطلبات المعلقة */}
          <div className="bg-white rounded-2xl shadow p-6 hover:shadow-lg transition">
            <div className="flex items-center justify-between">
              <div>
                <p className="text-gray-600 text-sm">طلبات معلقة</p>
                <h3 className="text-3xl font-bold text-yellow-600 mt-2">{stats.pendingOrders}</h3>
              </div>
              <BarChart3 className="w-12 h-12 text-yellow-600 opacity-30" />
            </div>
          </div>

          {/* الأرباح */}
          <div className="bg-white rounded-2xl shadow p-6 hover:shadow-lg transition">
            <div className="flex items-center justify-between">
              <div>
                <p className="text-gray-600 text-sm">إجمالي الأرباح</p>
                <h3 className="text-3xl font-bold text-green-600 mt-2">{stats.totalEarnings.toFixed(2)}</h3>
              </div>
              <BarChart3 className="w-12 h-12 text-green-600 opacity-30" />
            </div>
          </div>
        </div>

        {/* القوائم السريعة */}
        <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
          {/* إدارة المطاعم */}
          <div className="bg-white rounded-2xl shadow p-6 hover:shadow-lg transition">
            <h3 className="text-xl font-bold text-primary mb-4">إدارة المطاعم</h3>
            <p className="text-gray-600 text-sm mb-4">
              أضف مطاعم جديدة وأدر بيانات المطاعم المسجلة
            </p>
            <div className="space-y-2">
              <Link
                to="/admin/add-restaurant"
                className="block w-full bg-primary hover:bg-red-900 text-white rounded-xl p-3 text-center font-semibold transition"
              >
                 إضافة مطعم جديد
              </Link>
              <Link
                to="/admin/restaurants"
                className="block w-full bg-gray-100 hover:bg-gray-200 text-gray-800 rounded-xl p-3 text-center font-semibold transition"
              >
                 عرض المطاعم
              </Link>
            </div>
          </div>

          {/* مراقبة الطلبات */}
          <div className="bg-white rounded-2xl shadow p-6 hover:shadow-lg transition">
            <h3 className="text-xl font-bold text-primary mb-4">مراقبة الطلبات</h3>
            <p className="text-gray-600 text-sm mb-4">
              راقب الطلبات للمطاعم المضافة وتابع حالتها
            </p>
            <div className="space-y-2">
              <Link
                to="/admin/orders"
                className="block w-full bg-blue-600 hover:bg-blue-700 text-white rounded-xl p-3 text-center font-semibold transition"
              >
                 جميع الطلبات
              </Link>
              <Link
                to="/admin/orders?status=pending"
                className="block w-full bg-yellow-500 hover:bg-yellow-600 text-white rounded-xl p-3 text-center font-semibold transition"
              >
                 الطلبات المعلقة
              </Link>
            </div>
          </div>

          {/* العميل */}
          <div className="bg-white rounded-2xl shadow p-6 hover:shadow-lg transition">
            <h3 className="text-xl font-bold text-primary mb-4">كعميل</h3>
            <p className="text-gray-600 text-sm mb-4">
              استعرض القائمة وأنشئ طلبات جديدة مثل أي عميل
            </p>
            <div className="space-y-2">
              <Link
                to="/menu"
                className="block w-full bg-green-600 hover:bg-green-700 text-white rounded-xl p-3 text-center font-semibold transition"
              >
                 استعرض القائمة
              </Link>
              <Link
                to="/orders"
                className="block w-full bg-gray-100 hover:bg-gray-200 text-gray-800 rounded-xl p-3 text-center font-semibold transition"
              >
                 طلباتي
              </Link>
            </div>
          </div>

          {/* المحفظة والمكافآت */}
          <div className="bg-white rounded-2xl shadow p-6 hover:shadow-lg transition">
            <h3 className="text-xl font-bold text-primary mb-4">المحفظة والمكافآت</h3>
            <p className="text-gray-600 text-sm mb-4">
              اعرض رصيدك والعمولات المتحصلة من طلبات مطاعمك
            </p>
            <div className="space-y-2">
              <div className="block w-full bg-gradient-to-r from-primary to-sky-700 text-white rounded-xl p-3 text-center font-semibold">
                 رصيدك: {walletBalance.toFixed(2)} ر.س
              </div>
              <Link
                to="/admin/wallet"
                className="block w-full bg-gray-100 hover:bg-gray-200 text-gray-800 rounded-xl p-3 text-center font-semibold transition"
              >
                 سجل المحفظة
              </Link>
            </div>
          </div>
        </div>
          </>
        )}
      </div>
    </RoleGate>
  )
}

==========================================================================================
FILE: src/pages/AdminOrders.tsx
==========================================================================================
import React, { useEffect, useState } from 'react'
import { collection, getDocs, query, where, orderBy } from 'firebase/firestore'
import { db } from '@/firebase'
import { useAuth } from '@/auth'
import { RoleGate } from '@/routes/RoleGate'
import { useToast } from '@/components/ui/Toast'
import { Order, OrderStatus, Restaurant } from '@/types'

const statusLabels: Record<OrderStatus, string> = {
  pending: ' قيد المراجعة',
  accepted: ' مقبول',
  preparing: ' قيد التحضير',
  ready: ' جاهز',
  out_for_delivery: ' في الطريق',
  delivered: ' تم التسليم',
  cancelled: ' ملغي',
}

export const AdminOrders: React.FC = () => {
  const { user, role } = useAuth()
  const toast = useToast()
  const [orders, setOrders] = useState<Order[]>([])
  const [allOrders, setAllOrders] = useState<Order[]>([])
  const [loading, setLoading] = useState(true)
  const [statusFilter, setStatusFilter] = useState<OrderStatus | 'all'>('all')
  const [myRestaurantIds, setMyRestaurantIds] = useState<string[]>([])

  // تحميل المطاعم التابعة للمشرف أولاً
  useEffect(() => {
    if (!user) return
    
    const loadMyRestaurants = async () => {
      if (role === 'developer') {
        // المطور يرى كل الطلبات
        setMyRestaurantIds([])
      } else {
        // المشرف يحصل على معرفات مطاعمه
        const myRestaurantsQuery = query(
          collection(db, 'restaurants'),
          where('referredBy', '==', user.uid)
        )
        const snap = await getDocs(myRestaurantsQuery)
        const ids = snap.docs.map(d => d.id)
        setMyRestaurantIds(ids)
      }
    }
    
    loadMyRestaurants()
  }, [user, role])

  // تحميل الطلبات
  useEffect(() => {
    if (!user) return
    loadOrders()
  }, [statusFilter, user, role, myRestaurantIds])

  const loadOrders = async () => {
    try {
      let q
      if (statusFilter === 'all') {
        q = query(collection(db, 'orders'), orderBy('createdAt', 'desc'))
      } else {
        q = query(
          collection(db, 'orders'),
          where('status', '==', statusFilter),
          orderBy('createdAt', 'desc')
        )
      }

      const snap = await getDocs(q)
      let data = snap.docs.map(d => ({ id: d.id, ...d.data() } as Order))
      
      // فلترة الطلبات للمشرف (فقط طلبات مطاعمه)
      if (role !== 'developer' && myRestaurantIds.length > 0) {
        data = data.filter(order => myRestaurantIds.includes(order.restaurantId || ''))
      } else if (role !== 'developer' && myRestaurantIds.length === 0) {
        // المشرف ليس لديه مطاعم
        data = []
      }
      
      setAllOrders(data)
      setOrders(data)
    } catch (err) {
      toast.error('خطأ في تحميل الطلبات')
      console.error(err)
    } finally {
      setLoading(false)
    }
  }

  if (loading) {
    return (
      <RoleGate allow={['admin', 'developer']}>
        <div className="flex items-center justify-center h-96">جارِ التحميل...</div>
      </RoleGate>
    )
  }

  return (
    <RoleGate allow={['admin', 'developer']}>
      <div className="space-y-6">
        <h1 className="text-3xl font-bold text-primary">مراقبة الطلبات</h1>

        {/* تصفية الحالة */}
        <div className="flex gap-2 overflow-x-auto pb-2">
          <button
            onClick={() => setStatusFilter('all')}
            className={`px-4 py-2 rounded-xl font-semibold transition whitespace-nowrap ${
              statusFilter === 'all'
                ? 'bg-primary text-white'
                : 'bg-gray-200 text-gray-800 hover:bg-gray-300'
            }`}
          >
            الكل ({orders.length})
          </button>
          {(
            ['pending', 'accepted', 'preparing', 'ready', 'out_for_delivery', 'delivered'] as OrderStatus[]
          ).map(status => {
            const count = orders.filter(o => o.status === status).length
            return (
              <button
                key={status}
                onClick={() => setStatusFilter(status)}
                className={`px-4 py-2 rounded-xl font-semibold transition whitespace-nowrap ${
                  statusFilter === status
                    ? 'bg-primary text-white'
                    : 'bg-gray-200 text-gray-800 hover:bg-gray-300'
                }`}
              >
                {statusLabels[status]} ({count})
              </button>
            )
          })}
        </div>

        {/* قائمة الطلبات */}
        <div className="space-y-4">
          {orders.length === 0 ? (
            <div className="text-center text-gray-500 py-12">
              لا توجد طلبات {statusFilter !== 'all' && `بحالة "${statusLabels[statusFilter as OrderStatus]}"`}
            </div>
          ) : (
            orders.map(order => (
              <div
                key={order.id}
                className="bg-white rounded-2xl shadow p-6 hover:shadow-lg transition"
              >
                <div className="flex items-start justify-between mb-4">
                  <div>
                    <h3 className="text-lg font-bold">طلب #{order.id.slice(-8)}</h3>
                    <p className="text-gray-600 text-sm">
                      {order.createdAt ? new Date(order.createdAt as any).toLocaleDateString('ar-SA') : '—'}
                    </p>
                  </div>
                  <span
                    className={`px-4 py-2 rounded-xl font-semibold text-white whitespace-nowrap ${
                      order.status === 'pending'
                        ? 'bg-yellow-500'
                        : order.status === 'delivered'
                        ? 'bg-green-600'
                        : order.status === 'cancelled'
                        ? 'bg-red-600'
                        : 'bg-blue-600'
                    }`}
                  >
                    {statusLabels[order.status]}
                  </span>
                </div>

                {/* التفاصيل */}
                <div className="grid md:grid-cols-2 gap-4 mb-4">
                  <div>
                    <p className="text-gray-600 text-sm">العميل ID</p>
                    <p className="font-mono text-sm text-gray-800">{order.customerId.slice(0, 12)}...</p>
                  </div>
                  <div>
                    <p className="text-gray-600 text-sm">المطعم</p>
                    <p className="font-semibold text-gray-800">{order.restaurantName || '—'}</p>
                  </div>
                  <div>
                    <p className="text-gray-600 text-sm">العنوان</p>
                    <p className="text-sm text-gray-800">{order.address}</p>
                  </div>
                  <div>
                    <p className="text-gray-600 text-sm">المجموع</p>
                    <p className="text-lg font-bold text-primary">{order.total?.toFixed(2) || 0} ر.س</p>
                  </div>
                </div>

                {/* الأصناف */}
                <div className="bg-gray-50 rounded-xl p-3 text-sm">
                  <p className="font-semibold mb-2">الأصناف:</p>
                  <div className="space-y-1">
                    {order.items?.map((item, idx) => (
                      <div key={idx} className="flex justify-between text-gray-700">
                        <span>{item.name} × {item.qty}</span>
                        <span>{(item.price * item.qty).toFixed(2)} ر.س</span>
                      </div>
                    ))}
                  </div>
                </div>
              </div>
            ))
          )}
        </div>
      </div>
    </RoleGate>
  )
}

export default AdminOrders

==========================================================================================
FILE: src/pages/AdminRestaurants.tsx
==========================================================================================
import React, { useEffect, useState, useRef } from 'react'
import { collection, getDocs, addDoc, deleteDoc, doc, updateDoc, serverTimestamp, query, where } from 'firebase/firestore'
import { ref, uploadBytesResumable, getDownloadURL, getStorage } from 'firebase/storage'
import { db, app } from '@/firebase'
import { useAuth } from '@/auth'
import { RoleGate } from '@/routes/RoleGate'
import { useToast } from '@/components/ui/Toast'
import { useDialog } from '@/components/ui/ConfirmDialog'
import { Restaurant } from '@/types'
import { Trash2, Plus, UserCheck, Upload, Image, Shield, Award, Medal, Crown, CheckCircle, XCircle, ChevronDown } from 'lucide-react'

export const AdminRestaurants: React.FC = () => {
  const { user, role } = useAuth()
  const toast = useToast()
  const dialog = useDialog()
  const [restaurants, setRestaurants] = useState<Restaurant[]>([])
  const [loading, setLoading] = useState(true)
  const [showForm, setShowForm] = useState(false)
  const [uploading, setUploading] = useState(false)
  const [uploadProgress, setUploadProgress] = useState(0)
  const fileRef = useRef<HTMLInputElement>(null)
  const storage = getStorage(app)
  
  const [formData, setFormData] = useState({
    name: '',
    phone: '',
    city: '',
    location: '',
    logoFile: null as File | null,
    logoPreview: '',
  })

  // تحميل المطاعم
  useEffect(() => {
    if (user) {
      loadRestaurants()
    }
  }, [user])

  const loadRestaurants = async () => {
    if (!user) return
    
    try {
      // المشرف يرى فقط المطاعم المسجلة بواسطته
      // المطور يرى كل المطاعم
      let data: Restaurant[] = []
      
      if (role === 'developer') {
        // المطور يرى كل المطاعم
        const snap = await getDocs(collection(db, 'restaurants'))
        data = snap.docs.map(d => ({
          id: d.id,
          ...d.data(),
        } as Restaurant))
      } else {
        // المشرف يرى فقط المطاعم التابعة له
        const myRestaurantsQuery = query(
          collection(db, 'restaurants'),
          where('referredBy', '==', user.uid)
        )
        const snap = await getDocs(myRestaurantsQuery)
        data = snap.docs.map(d => ({
          id: d.id,
          ...d.data(),
        } as Restaurant))
      }
      
      setRestaurants(data)
    } catch (err) {
      toast.error('خطأ في تحميل المطاعم')
      console.error(err)
    } finally {
      setLoading(false)
    }
  }

  const handleAddRestaurant = async (e: React.FormEvent) => {
    e.preventDefault()

    if (!formData.name.trim()) {
      toast.warning('أدخل اسم المطعم')
      return
    }

    try {
      setUploading(true)
      
      // رفع الشعار إذا وُجد
      let logoUrl = ''
      if (formData.logoFile) {
        const safeName = formData.logoFile.name.replace(/\s+/g, '_').slice(-60)
        const path = `uploads/restaurant_${Date.now()}_${safeName}`
        const storageRef = ref(storage, path)
        
        const task = uploadBytesResumable(storageRef, formData.logoFile, {
          contentType: formData.logoFile.type || 'image/jpeg',
        })
        
        await new Promise<void>((resolve, reject) => {
          task.on(
            'state_changed',
            (snap) => {
              const progress = Math.round((snap.bytesTransferred / snap.totalBytes) * 100)
              setUploadProgress(progress)
            },
            reject,
            async () => {
              logoUrl = await getDownloadURL(task.snapshot.ref)
              resolve()
            }
          )
        })
      }
      
      //  تحديد نوع المُضيف ومعلومات الإحالة
      const isAdmin = role === 'admin'
      const isDev = role === 'developer'
      
      await addDoc(collection(db, 'restaurants'), {
        name: formData.name,
        phone: formData.phone,
        city: formData.city,
        location: formData.location,
        ownerId: 'admin_' + Date.now(),
        email: user?.email || '',
        logoUrl: logoUrl,
        createdAt: new Date(),
        //  نظام العمولات - حفظ من أضاف المطعم
        referredBy: isAdmin ? user?.uid : null,
        referrerType: isAdmin ? 'admin' : (isDev ? 'developer' : null),
      })

      toast.success('تم إضافة المطعم بنجاح ')
      if (isAdmin) {
        toast.info(' ستحصل على 75 هللة من كل منتج يُطلب من هذا المطعم')
      }
      setFormData({ name: '', phone: '', city: '', location: '', logoFile: null, logoPreview: '' })
      setShowForm(false)
      setUploadProgress(0)
      loadRestaurants()
    } catch (err) {
      toast.error('خطأ في إضافة المطعم')
      console.error(err)
    } finally {
      setUploading(false)
    }
  }

  const handleDelete = async (id: string) => {
    const confirmed = await dialog.confirm('هل أنت متأكد من حذف هذا المطعم؟', { dangerous: true, title: 'حذف المطعم' })
    if (!confirmed) return

    try {
      await deleteDoc(doc(db, 'restaurants', id))
      toast.success('تم حذف المطعم بنجاح')
      loadRestaurants()
    } catch (err) {
      toast.error('خطأ في حذف المطعم')
      console.error(err)
    }
  }

  // تحديث حالة التوثيق
  const handleToggleVerified = async (restaurant: Restaurant) => {
    const newStatus = !restaurant.isVerified
    const confirmed = await dialog.confirm(
      newStatus 
        ? `هل تريد توثيق أسرة "${restaurant.name}"؟` 
        : `هل تريد إلغاء توثيق أسرة "${restaurant.name}"؟`,
      { 
        title: newStatus ? ' توثيق الأسرة' : ' إلغاء التوثيق',
        confirmText: newStatus ? 'نعم، وثّق' : 'نعم، ألغِ التوثيق',
      }
    )
    if (!confirmed) return

    try {
      await updateDoc(doc(db, 'restaurants', restaurant.id), {
        isVerified: newStatus,
        verifiedAt: newStatus ? serverTimestamp() : null,
        updatedAt: serverTimestamp(),
      })
      toast.success(newStatus ? 'تم توثيق الأسرة ' : 'تم إلغاء التوثيق')
      loadRestaurants()
    } catch (err) {
      toast.error('حدث خطأ')
      console.error(err)
    }
  }

  // تحديث تصنيف البائع
  const handleUpdateTier = async (restaurant: Restaurant, tier: 'bronze' | 'silver' | 'gold') => {
    try {
      await updateDoc(doc(db, 'restaurants', restaurant.id), {
        sellerTier: tier,
        tierUpdatedAt: serverTimestamp(),
        updatedAt: serverTimestamp(),
      })
      const tierNames = { bronze: 'برونزي', silver: 'فضي', gold: 'ذهبي' }
      toast.success(`تم تحديث التصنيف إلى ${tierNames[tier]} `)
      loadRestaurants()
    } catch (err) {
      toast.error('حدث خطأ')
      console.error(err)
    }
  }

  // مكون شارة التصنيف
  const TierBadge: React.FC<{ tier?: string }> = ({ tier }) => {
    switch (tier) {
      case 'gold':
        return (
          <span className="inline-flex items-center gap-1 px-2 py-1 bg-gradient-to-r from-amber-400 to-yellow-400 text-white text-xs font-bold rounded-full shadow">
            <Crown className="w-3 h-3" /> Gold
          </span>
        )
      case 'silver':
        return (
          <span className="inline-flex items-center gap-1 px-2 py-1 bg-gradient-to-r from-gray-300 to-gray-400 text-gray-800 text-xs font-bold rounded-full shadow">
            <Medal className="w-3 h-3" /> Silver
          </span>
        )
      default:
        return (
          <span className="inline-flex items-center gap-1 px-2 py-1 bg-gradient-to-r from-amber-600 to-orange-600 text-white text-xs font-bold rounded-full shadow">
            <Award className="w-3 h-3" /> Bronze
          </span>
        )
    }
  }

  if (loading) {
    return (
      <RoleGate allow={['admin', 'developer']}>
        <div className="flex items-center justify-center h-96">جارِ التحميل...</div>
      </RoleGate>
    )
  }

  return (
    <RoleGate allow={['admin', 'developer']}>
      <div className="space-y-6">
        <div className="flex items-center justify-between">
          <h1 className="text-3xl font-bold text-primary">المطاعم المضافة</h1>
          <button
            onClick={() => setShowForm(!showForm)}
            className="flex items-center gap-2 bg-primary hover:bg-red-900 text-white px-6 py-3 rounded-xl font-semibold transition"
          >
            <Plus className="w-5 h-5" /> مطعم جديد
          </button>
        </div>

        {/* نموذج الإضافة */}
        {showForm && (
          <div className="bg-white rounded-2xl shadow p-6">
            <h2 className="text-xl font-bold mb-4">إضافة مطعم جديد</h2>
            <form onSubmit={handleAddRestaurant} className="space-y-4">
              {/* شعار المطعم */}
              <div className="space-y-2">
                <label className="block font-semibold text-gray-700">شعار المطعم</label>
                <div className="flex items-center gap-4">
                  {formData.logoPreview ? (
                    <img 
                      src={formData.logoPreview} 
                      alt="معاينة الشعار" 
                      className="w-20 h-20 rounded-xl object-cover border-2 border-sky-200"
                    />
                  ) : (
                    <div className="w-20 h-20 rounded-xl bg-gray-100 flex items-center justify-center border-2 border-dashed border-gray-300">
                      <Image className="w-8 h-8 text-gray-400" />
                    </div>
                  )}
                  <div className="flex-1">
                    <input
                      ref={fileRef}
                      type="file"
                      accept="image/*"
                      className="hidden"
                      onChange={(e) => {
                        const file = e.target.files?.[0]
                        if (file) {
                          setFormData({
                            ...formData,
                            logoFile: file,
                            logoPreview: URL.createObjectURL(file)
                          })
                        }
                      }}
                    />
                    <button
                      type="button"
                      onClick={() => fileRef.current?.click()}
                      className="flex items-center gap-2 px-4 py-2 bg-sky-100 hover:bg-sky-200 text-sky-700 rounded-xl font-semibold transition"
                    >
                      <Upload className="w-4 h-4" />
                      {formData.logoFile ? 'تغيير الصورة' : 'رفع شعار'}
                    </button>
                    {formData.logoFile && (
                      <p className="text-xs text-gray-500 mt-1">{formData.logoFile.name}</p>
                    )}
                  </div>
                </div>
                {uploading && uploadProgress > 0 && (
                  <div className="w-full bg-gray-200 rounded-full h-2">
                    <div 
                      className="bg-sky-500 h-2 rounded-full transition-all" 
                      style={{ width: `${uploadProgress}%` }}
                    />
                  </div>
                )}
              </div>
              
              <input
                type="text"
                placeholder="اسم المطعم"
                value={formData.name}
                onChange={e => setFormData({ ...formData, name: e.target.value })}
                className="w-full border rounded-xl p-3 text-gray-900"
              />
              <input
                type="text"
                placeholder="رقم الهاتف"
                value={formData.phone}
                onChange={e => setFormData({ ...formData, phone: e.target.value })}
                className="w-full border rounded-xl p-3 text-gray-900"
              />
              <input
                type="text"
                placeholder="المدينة"
                value={formData.city}
                onChange={e => setFormData({ ...formData, city: e.target.value })}
                className="w-full border rounded-xl p-3 text-gray-900"
              />
              <textarea
                placeholder="الموقع / العنوان"
                value={formData.location}
                onChange={e => setFormData({ ...formData, location: e.target.value })}
                className="w-full border rounded-xl p-3 text-gray-900"
              />
              <div className="flex gap-3">
                <button
                  type="submit"
                  disabled={uploading}
                  className="flex-1 bg-primary hover:bg-red-900 text-white rounded-xl p-3 font-semibold transition disabled:opacity-50"
                >
                  {uploading ? `جارٍ الرفع... ${uploadProgress}%` : ' حفظ'}
                </button>
                <button
                  type="button"
                  onClick={() => setShowForm(false)}
                  className="flex-1 bg-gray-200 hover:bg-gray-300 text-gray-800 rounded-xl p-3 font-semibold transition"
                >
                   إلغاء
                </button>
              </div>
            </form>
          </div>
        )}

        {/* قائمة المطاعم */}
        <div className="grid gap-4">
          {restaurants.length === 0 ? (
            <div className="text-center text-gray-500 py-12">
              لا توجد مطاعم مسجلة حالياً
            </div>
          ) : (
            restaurants.map(restaurant => (
              <div
                key={restaurant.id}
                className="bg-white rounded-2xl shadow p-6 hover:shadow-lg transition"
              >
                <div className="flex items-start justify-between">
                  <div className="flex gap-4">
                    {/* شعار المطعم */}
                    {restaurant.logoUrl ? (
                      <img 
                        src={restaurant.logoUrl} 
                        alt={restaurant.name}
                        className="w-16 h-16 rounded-xl object-cover border-2 border-sky-100"
                      />
                    ) : (
                      <div className="w-16 h-16 rounded-xl bg-sky-100 flex items-center justify-center">
                        <span className="text-2xl"></span>
                      </div>
                    )}
                    
                    <div className="flex-1">
                      <div className="flex items-center gap-2 flex-wrap">
                        <h3 className="text-xl font-bold text-primary">{restaurant.name}</h3>
                        {/* شارة التوثيق */}
                        {restaurant.isVerified && (
                          <span className="inline-flex items-center gap-1 px-2 py-0.5 bg-green-100 text-green-700 text-xs font-bold rounded-full">
                            <CheckCircle className="w-3 h-3" /> موثقة
                          </span>
                        )}
                        {/* شارة التصنيف */}
                        <TierBadge tier={restaurant.sellerTier} />
                      </div>
                      {restaurant.city && (
                        <p className="text-gray-600 text-sm"> {restaurant.city}</p>
                      )}
                      {restaurant.phone && (
                        <p className="text-gray-600 text-sm"> {restaurant.phone}</p>
                      )}
                      {restaurant.location && (
                        <p className="text-gray-600 text-sm"> {restaurant.location}</p>
                      )}
                    </div>
                  </div>
                  
                  {/* أزرار الإجراءات */}
                  <div className="flex items-center gap-2">
                    {/* زر التوثيق */}
                    <button
                      onClick={() => handleToggleVerified(restaurant)}
                      className={`p-2.5 rounded-xl transition flex items-center gap-1 text-sm font-semibold ${
                        restaurant.isVerified 
                          ? 'bg-green-100 hover:bg-green-200 text-green-700' 
                          : 'bg-gray-100 hover:bg-gray-200 text-gray-600'
                      }`}
                      title={restaurant.isVerified ? 'إلغاء التوثيق' : 'توثيق الأسرة'}
                    >
                      <Shield className="w-4 h-4" />
                      {restaurant.isVerified ? 'موثقة' : 'توثيق'}
                    </button>
                    
                    {/* قائمة التصنيف */}
                    <div className="relative group">
                      <button
                        className="p-2.5 rounded-xl bg-amber-100 hover:bg-amber-200 text-amber-700 transition flex items-center gap-1 text-sm font-semibold"
                      >
                        <Award className="w-4 h-4" />
                        التصنيف
                        <ChevronDown className="w-3 h-3" />
                      </button>
                      <div className="absolute left-0 top-full mt-1 bg-white rounded-xl shadow-xl border opacity-0 invisible group-hover:opacity-100 group-hover:visible transition-all z-20 min-w-[140px]">
                        <button
                          onClick={() => handleUpdateTier(restaurant, 'bronze')}
                          className={`w-full px-4 py-2.5 text-right hover:bg-amber-50 transition flex items-center gap-2 first:rounded-t-xl ${restaurant.sellerTier === 'bronze' || !restaurant.sellerTier ? 'bg-amber-50' : ''}`}
                        >
                          <Award className="w-4 h-4 text-amber-600" />
                          <span className="font-semibold">Bronze</span>
                        </button>
                        <button
                          onClick={() => handleUpdateTier(restaurant, 'silver')}
                          className={`w-full px-4 py-2.5 text-right hover:bg-gray-50 transition flex items-center gap-2 ${restaurant.sellerTier === 'silver' ? 'bg-gray-100' : ''}`}
                        >
                          <Medal className="w-4 h-4 text-gray-500" />
                          <span className="font-semibold">Silver</span>
                        </button>
                        <button
                          onClick={() => handleUpdateTier(restaurant, 'gold')}
                          className={`w-full px-4 py-2.5 text-right hover:bg-yellow-50 transition flex items-center gap-2 last:rounded-b-xl ${restaurant.sellerTier === 'gold' ? 'bg-yellow-50' : ''}`}
                        >
                          <Crown className="w-4 h-4 text-amber-500" />
                          <span className="font-semibold">Gold</span>
                        </button>
                      </div>
                    </div>
                    
                    {/* زر الحذف */}
                    <button
                      onClick={() => handleDelete(restaurant.id)}
                      className="p-2.5 bg-red-100 hover:bg-red-200 text-red-600 rounded-xl transition"
                      title="حذف المطعم"
                    >
                      <Trash2 className="w-4 h-4" />
                    </button>
                  </div>
                </div>
              </div>
            ))
          )}
        </div>
      </div>
    </RoleGate>
  )
}

export default AdminRestaurants

==========================================================================================
FILE: src/pages/CartPage.tsx
==========================================================================================
// src/pages/CartPage.tsx
import React from "react"
import { useCart } from "@/hooks/useCart"
import { Link } from "react-router-dom"
import { Trash2, ShoppingBag, ArrowLeft, Minus, Plus } from "lucide-react"

export const CartPage: React.FC = () => {
  const { items, subtotal, remove, clear, changeQty } = useCart()

  if (items.length === 0) {
    return (
      <div className="min-h-screen bg-gradient-to-br from-sky-50 via-white to-sky-100 flex flex-col items-center justify-center py-20 px-4">
        <div className="w-24 h-24 bg-white/80 backdrop-blur rounded-full flex items-center justify-center mb-6 shadow-lg">
          <ShoppingBag className="w-12 h-12 text-sky-400" />
        </div>
        <h2 className="text-xl font-bold text-sky-800 mb-2">السلة فارغة</h2>
        <p className="text-sky-600/70 mb-6">أضف بعض الأصناف اللذيذة!</p>
        <Link 
          to="/restaurants" 
          className="flex items-center gap-2 bg-gradient-to-r from-sky-500 to-sky-600 text-white px-6 py-3 rounded-xl font-bold shadow-lg shadow-sky-200/50 hover:shadow-xl transition"
        >
          <ArrowLeft className="w-5 h-5" />
          تصفح المطاعم
        </Link>
      </div>
    )
  }

  return (
    <div className="min-h-screen bg-gradient-to-br from-sky-50 via-white to-sky-100 py-6">
      <div className="max-w-3xl mx-auto space-y-4 px-2 sm:px-4">
      <div className="flex items-center justify-between">
        <h1 className="text-xl sm:text-2xl font-bold flex items-center gap-2">
          <ShoppingBag className="w-6 h-6 text-primary" />
          سلة المشتريات
          <span className="text-sm bg-primary text-white px-2 py-0.5 rounded-full">{items.length}</span>
        </h1>
      </div>

      {/* قائمة الأصناف */}
      <div className="space-y-3">
        {items.map((i) => (
          <div
            key={i.id}
            className="flex items-center gap-3 glass-card p-3 sm:p-4 rounded-xl"
          >
            {/* صورة الصنف (افتراضية) */}
            <div className="w-16 h-16 sm:w-20 sm:h-20 bg-gray-100 rounded-xl flex items-center justify-center flex-shrink-0">
              <span className="text-3xl"></span>
            </div>
            
            {/* تفاصيل الصنف */}
            <div className="flex-1 min-w-0">
              <h3 className="font-bold text-sm sm:text-base truncate">{i.name}</h3>
              <p className="text-primary font-bold text-sm">{i.price.toFixed(2)} ر.س</p>
              
              {/* أزرار الكمية */}
              <div className="flex items-center gap-2 mt-2">
                <button
                  onClick={() => i.qty > 1 ? changeQty(i.id, i.qty - 1) : remove(i.id)}
                  className="w-7 h-7 sm:w-8 sm:h-8 rounded-lg bg-gray-100 hover:bg-gray-200 flex items-center justify-center transition"
                >
                  <Minus className="w-4 h-4" />
                </button>
                <span className="font-bold text-lg w-8 text-center">{i.qty}</span>
                <button
                  onClick={() => changeQty(i.id, i.qty + 1)}
                  className="w-7 h-7 sm:w-8 sm:h-8 rounded-lg bg-primary text-white hover:bg-sky-600 flex items-center justify-center transition"
                >
                  <Plus className="w-4 h-4" />
                </button>
              </div>
            </div>
            
            {/* السعر الإجمالي + حذف */}
            <div className="flex flex-col items-end gap-2">
              <span className="font-bold text-lg text-gray-900">{(i.price * i.qty).toFixed(2)} ر.س</span>
              <button
                onClick={() => remove(i.id)}
                className="p-2 rounded-lg bg-red-50 hover:bg-red-100 text-red-500 transition"
              >
                <Trash2 className="w-4 h-4" />
              </button>
            </div>
          </div>
        ))}
      </div>

      {/* ملخص السلة */}
      <div className="glass-card rounded-xl p-4 space-y-3">
        <div className="flex justify-between text-sky-700">
          <span>المجموع الفرعي</span>
          <span className="font-bold">{subtotal.toFixed(2)} ر.س</span>
        </div>
        <div className="flex justify-between text-amber-600">
          <span>رسوم التوصيل</span>
          <span className="font-semibold text-sm">تُحدد عند قبول الطلب</span>
        </div>
        <div className="h-px bg-sky-200/50"></div>
        <div className="flex justify-between">
          <span className="font-bold text-lg text-sky-900">الإجمالي</span>
          <span className="font-bold text-xl text-sky-600">{subtotal.toFixed(2)} ر.س</span>
        </div>
        <p className="text-xs text-gray-500 text-center">
           رسوم التوصيل يحددها المندوب أو الأسرة حسب موقعك
        </p>
      </div>

      {/* أزرار الإجراءات */}
      <div className="flex flex-col sm:flex-row gap-3 pb-6">
        <button
          onClick={clear}
          className="flex-1 flex items-center justify-center gap-2 px-5 py-3 rounded-xl glass-light text-sky-700 font-semibold hover:bg-white/70 transition"
        >
          <Trash2 className="w-5 h-5" />
          تفريغ السلة
        </button>
        <Link
          to="/checkout"
          className="flex-1 flex items-center justify-center gap-2 px-5 py-3 rounded-xl bg-gradient-to-r from-green-500 to-green-600 text-white font-bold shadow-lg shadow-green-200/50 hover:shadow-xl hover:scale-[1.02] transition"
        >
           إتمام الطلب
        </Link>
      </div>
      </div>
    </div>
  )
}

==========================================================================================
FILE: src/pages/ChatPage.tsx
==========================================================================================
// src/pages/ChatPage.tsx
import React, { useEffect, useState, useRef } from 'react'
import { useSearchParams, useNavigate } from 'react-router-dom'
import { 
  collection, doc, getDoc, addDoc, onSnapshot, 
  query, orderBy, serverTimestamp, Timestamp 
} from 'firebase/firestore'
import { db } from '@/firebase'
import { useAuth } from '@/auth'
import { useToast } from '@/components/ui/Toast'
import { 
  MessageCircle, Send, ArrowRight, Package, 
  MapPin, Clock, CheckCheck, Sparkles, Heart,
  Smile, ThumbsUp, Star, Zap, Coffee, Pizza, Store
} from 'lucide-react'

// رسائل سريعة للعميل
const QUICK_MESSAGES_CUSTOMER = [
  { text: 'أين وصلت؟ ', emoji: '' },
  { text: 'شكراً لك! ', emoji: '' },
  { text: 'خذ راحتك ', emoji: '' },
  { text: 'أنا بالانتظار ', emoji: '' },
  { text: 'تمام ', emoji: '' },
  { text: 'ممتاز! ', emoji: '' },
]

// رسائل سريعة للعميل مع المطعم
const QUICK_MESSAGES_CUSTOMER_TO_RESTAURANT = [
  { text: 'كم المدة المتوقعة؟ ', emoji: '' },
  { text: 'شكراً لكم! ', emoji: '' },
  { text: 'هل الطلب جاهز؟ ', emoji: '' },
  { text: 'أحتاج تعديل على الطلب ', emoji: '' },
  { text: 'ممتاز! ', emoji: '' },
  { text: 'تمام ', emoji: '' },
]

// رسائل سريعة للمندوب
const QUICK_MESSAGES_COURIER = [
  { text: 'في الطريق إليك! ', emoji: '' },
  { text: 'وصلت! ', emoji: '' },
  { text: 'دقائق وأوصل ', emoji: '' },
  { text: 'أحتاج تحديد الموقع ', emoji: '' },
  { text: 'اتصل بي ', emoji: '' },
  { text: 'شكراً لطلبك! ', emoji: '' },
]

// رسائل سريعة للمطعم
const QUICK_MESSAGES_RESTAURANT = [
  { text: 'طلبك قيد التحضير ', emoji: '' },
  { text: 'الطلب جاهز! ', emoji: '' },
  { text: 'المندوب في الطريق ', emoji: '' },
  { text: 'شكراً لطلبك! ', emoji: '' },
  { text: 'نعتذر عن التأخير ', emoji: '' },
  { text: 'تم استلام الطلب ', emoji: '' },
]

// إيموجيات للإرسال السريع
const EMOJI_PICKER = ['', '', '', '', '', '', '', '', '', '', '', '']

type Message = {
  id: string
  text: string
  senderId: string
  senderRole: 'customer' | 'courier' | 'owner'
  createdAt: Timestamp | null
}

type OrderInfo = {
  id: string
  status: string
  address: string
  total: number
  customerId: string
  courierId?: string
  restaurantId?: string
  restaurantName?: string
}

export const ChatPage: React.FC = () => {
  const [params] = useSearchParams()
  const orderId = params.get('orderId')
  const nav = useNavigate()
  const { user, role } = useAuth()
  const toast = useToast()
  
  const [order, setOrder] = useState<OrderInfo | null>(null)
  const [messages, setMessages] = useState<Message[]>([])
  const [newMsg, setNewMsg] = useState('')
  const [sending, setSending] = useState(false)
  const [showEmoji, setShowEmoji] = useState(false)
  const [partnerName, setPartnerName] = useState('')
  const messagesEndRef = useRef<HTMLDivElement>(null)

  const isCourier = role === 'courier'
  const isOwner = role === 'owner'
  const isCustomer = role === 'customer' || role === 'admin'
  
  // تحديد إذا كانت المحادثة مع المطعم (لا يوجد مندوب)
  const isChatWithRestaurant = order && !order.courierId && order.restaurantId
  
  // تحديد الرسائل السريعة حسب الدور ونوع المحادثة
  const getQuickMessages = () => {
    if (isCourier) return QUICK_MESSAGES_COURIER
    if (isOwner) return QUICK_MESSAGES_RESTAURANT
    if (isCustomer && isChatWithRestaurant) return QUICK_MESSAGES_CUSTOMER_TO_RESTAURANT
    return QUICK_MESSAGES_CUSTOMER
  }
  
  const quickMessages = getQuickMessages()

  // تحميل بيانات الطلب
  useEffect(() => {
    if (!orderId) return
    
    const unsub = onSnapshot(doc(db, 'orders', orderId), (snap) => {
      if (snap.exists()) {
        const data = snap.data()
        setOrder({
          id: snap.id,
          status: data.status,
          address: data.address,
          total: data.total,
          customerId: data.customerId,
          courierId: data.courierId,
          restaurantId: data.restaurantId,
          restaurantName: data.restaurantName,
        })
      }
    })
    
    return () => unsub()
  }, [orderId])

  // تحميل اسم الطرف الآخر
  useEffect(() => {
    if (!order) return
    
    // تحديد الشريك في المحادثة
    let partnerId: string | undefined
    let partnerType: 'courier' | 'restaurant' | 'customer' = 'customer'
    
    if (isCourier) {
      // المندوب يتحدث مع العميل
      partnerId = order.customerId
      partnerType = 'customer'
    } else if (isOwner) {
      // المطعم يتحدث مع العميل
      partnerId = order.customerId
      partnerType = 'customer'
    } else if (isCustomer) {
      // العميل يتحدث مع المندوب أو المطعم
      if (order.courierId) {
        partnerId = order.courierId
        partnerType = 'courier'
      } else if (order.restaurantId) {
        partnerId = order.restaurantId
        partnerType = 'restaurant'
      }
    }
    
    if (!partnerId) {
      setPartnerName(isChatWithRestaurant ? (order.restaurantName || 'المطعم') : 'غير محدد')
      return
    }
    
    if (partnerType === 'restaurant') {
      // جلب اسم المطعم
      getDoc(doc(db, 'restaurants', partnerId)).then(snap => {
        if (snap.exists()) {
          setPartnerName(snap.data()?.name || 'المطعم')
        } else {
          setPartnerName(order.restaurantName || 'المطعم')
        }
      })
    } else {
      // جلب اسم المستخدم
      getDoc(doc(db, 'users', partnerId)).then(snap => {
        if (snap.exists()) {
          const defaultName = partnerType === 'courier' ? 'المندوب' : 'العميل'
          setPartnerName(snap.data()?.name || defaultName)
        }
      })
    }
  }, [order, isCourier, isOwner, isCustomer, isChatWithRestaurant])

  // الاستماع للرسائل
  useEffect(() => {
    if (!orderId) return
    
    const q = query(
      collection(db, 'orders', orderId, 'messages'),
      orderBy('createdAt', 'asc')
    )
    
    const unsub = onSnapshot(q, (snap) => {
      setMessages(snap.docs.map(d => ({
        id: d.id,
        ...d.data()
      } as Message)))
    })
    
    return () => unsub()
  }, [orderId])

  // التمرير للأسفل عند وصول رسائل جديدة
  useEffect(() => {
    messagesEndRef.current?.scrollIntoView({ behavior: 'smooth' })
  }, [messages])

  // إرسال رسالة
  const sendMessage = async (text: string) => {
    if (!text.trim() || !user || !orderId) return
    
    setSending(true)
    try {
      // تحديد دور المرسل
      let senderRole: 'customer' | 'courier' | 'owner' = 'customer'
      if (isCourier) senderRole = 'courier'
      else if (isOwner) senderRole = 'owner'
      
      await addDoc(collection(db, 'orders', orderId, 'messages'), {
        text: text.trim(),
        senderId: user.uid,
        senderRole,
        createdAt: serverTimestamp(),
      })
      setNewMsg('')
      setShowEmoji(false)
    } catch (err) {
      toast.error('فشل إرسال الرسالة')
    }
    setSending(false)
  }

  // إضافة إيموجي للرسالة
  const addEmoji = (emoji: string) => {
    setNewMsg(prev => prev + emoji)
  }

  // تنسيق الوقت
  const formatTime = (ts: Timestamp | null) => {
    if (!ts) return ''
    const date = ts.toDate()
    return date.toLocaleTimeString('ar-SA', { hour: '2-digit', minute: '2-digit' })
  }

  // حالة الطلب
  const getStatusInfo = (status: string) => {
    const map: Record<string, { text: string; color: string; emoji: string }> = {
      'pending': { text: 'قيد المراجعة', color: 'bg-yellow-500', emoji: '' },
      'accepted': { text: 'تم القبول', color: 'bg-blue-500', emoji: '' },
      'preparing': { text: 'قيد التحضير', color: 'bg-orange-500', emoji: '' },
      'ready': { text: 'جاهز', color: 'bg-purple-500', emoji: '' },
      'out_for_delivery': { text: 'في الطريق', color: 'bg-sky-500', emoji: '' },
      'delivered': { text: 'تم التسليم', color: 'bg-green-500', emoji: '' },
    }
    return map[status] || { text: status, color: 'bg-gray-500', emoji: '' }
  }
  
  // تحديد أيقونة الشريك
  const getPartnerIcon = () => {
    if (isCourier || isOwner) return '' // العميل
    if (isChatWithRestaurant) return '' // المطعم
    return '' // المندوب
  }

  if (!orderId) {
    return (
      <div className="flex items-center justify-center min-h-[60vh]">
        <div className="text-center">
          <MessageCircle className="w-16 h-16 mx-auto text-gray-300 mb-4" />
          <p className="text-gray-500">لم يتم تحديد الطلب</p>
        </div>
      </div>
    )
  }

  if (!order) {
    return (
      <div className="flex items-center justify-center min-h-[60vh]">
        <div className="text-center">
          <div className="w-12 h-12 border-4 border-primary border-t-transparent rounded-full animate-spin mx-auto mb-4" />
          <p className="text-gray-500">جارِ التحميل...</p>
        </div>
      </div>
    )
  }

  // التحقق من الصلاحية (العميل أو المندوب أو صاحب المطعم)
  const hasAccess = user?.uid === order.customerId || 
                    user?.uid === order.courierId || 
                    user?.uid === order.restaurantId
  
  if (!hasAccess) {
    return (
      <div className="flex items-center justify-center min-h-[60vh]">
        <div className="text-center">
          <div className="text-6xl mb-4"></div>
          <p className="text-gray-500">ليس لديك صلاحية الوصول لهذه المحادثة</p>
        </div>
      </div>
    )
  }

  const statusInfo = getStatusInfo(order.status)

  return (
    <div className="flex flex-col h-[calc(100vh-200px)] max-w-2xl mx-auto">
      {/* رأس المحادثة الفخم */}
      <div className={`bg-gradient-to-r ${isChatWithRestaurant ? 'from-orange-500 via-amber-500 to-yellow-500' : 'from-primary via-sky-500 to-accent'} rounded-t-3xl p-4 shadow-luxury`}>
        <div className="flex items-center gap-3">
          <button 
            onClick={() => nav(-1)}
            className="w-10 h-10 rounded-full bg-white/20 backdrop-blur flex items-center justify-center hover:bg-white/30 transition-all"
          >
            <ArrowRight className="w-5 h-5 text-white" />
          </button>
          
          <div className="flex-1">
            <div className="flex items-center gap-2">
              <div className="w-12 h-12 rounded-full bg-white/20 backdrop-blur flex items-center justify-center">
                <span className="text-2xl">{getPartnerIcon()}</span>
              </div>
              <div>
                <h2 className="font-bold text-white text-lg">
                  {partnerName || (isChatWithRestaurant ? 'المطعم' : (isCourier || isOwner ? 'العميل' : 'المندوب'))}
                </h2>
                <div className="flex items-center gap-1 text-white/80 text-sm">
                  <span className={`w-2 h-2 rounded-full ${order.status === 'delivered' ? 'bg-green-400' : 'bg-yellow-400 animate-pulse'}`} />
                  <span>{statusInfo.emoji} {statusInfo.text}</span>
                </div>
              </div>
            </div>
          </div>
          
          {isChatWithRestaurant ? (
            <Store className="w-6 h-6 text-white animate-pulse" />
          ) : (
            <Sparkles className="w-6 h-6 text-yellow-300 animate-pulse" />
          )}
        </div>
        
        {/* معلومات الطلب المختصرة */}
        <div className="mt-3 flex items-center gap-4 text-white/90 text-sm">
          <div className="flex items-center gap-1">
            <Package className="w-4 h-4" />
            <span>#{order.id.slice(-6)}</span>
          </div>
          {order.restaurantName && (
            <div className="flex items-center gap-1">
              <Store className="w-4 h-4" />
              <span>{order.restaurantName}</span>
            </div>
          )}
          <div className="flex items-center gap-1">
            <MapPin className="w-4 h-4" />
            <span className="truncate max-w-[150px]">{order.address}</span>
          </div>
        </div>
      </div>

      {/* منطقة الرسائل */}
      <div className="flex-1 overflow-y-auto bg-gradient-to-b from-sky-50 to-white p-4 space-y-3">
        {messages.length === 0 && (
          <div className="text-center py-10">
            <div className="text-6xl mb-4"></div>
            <p className="text-gray-500">ابدأ المحادثة الآن!</p>
            <p className="text-gray-400 text-sm mt-1">أرسل رسالة للتواصل</p>
          </div>
        )}
        
        {messages.map((msg, idx) => {
          const isMe = msg.senderId === user?.uid
          return (
            <div
              key={msg.id}
              className={`flex ${isMe ? 'justify-start' : 'justify-end'}`}
            >
              <div
                className={`
                  max-w-[80%] rounded-2xl px-4 py-3 shadow-md
                  ${isMe 
                    ? 'bg-gradient-to-br from-primary to-sky-600 text-white rounded-br-sm' 
                    : 'bg-white text-gray-800 rounded-bl-sm border border-gray-100'
                  }
                  transform transition-all duration-300 hover:scale-[1.02]
                `}
              >
                <p className="text-base leading-relaxed">{msg.text}</p>
                <div className={`flex items-center gap-1 mt-1 text-xs ${isMe ? 'text-white/70' : 'text-gray-400'}`}>
                  <Clock className="w-3 h-3" />
                  <span>{formatTime(msg.createdAt)}</span>
                  {isMe && <CheckCheck className="w-3 h-3 mr-1" />}
                </div>
              </div>
            </div>
          )
        })}
        <div ref={messagesEndRef} />
      </div>

      {/* رسائل سريعة */}
      <div className="bg-white border-t border-gray-100 px-3 py-2">
        <div className="flex gap-2 overflow-x-auto pb-2 scrollbar-hide">
          {quickMessages.map((qm, idx) => (
            <button
              key={idx}
              onClick={() => sendMessage(qm.text)}
              className="flex-shrink-0 px-4 py-2 bg-gradient-to-r from-sky-50 to-blue-50 
                         rounded-full text-sm text-primary font-medium border border-sky-100
                         hover:from-sky-100 hover:to-blue-100 hover:shadow-md 
                         transition-all duration-200 active:scale-95"
            >
              {qm.text}
            </button>
          ))}
        </div>
      </div>

      {/* لوحة الإيموجي */}
      {showEmoji && (
        <div className="bg-white border-t border-gray-100 px-4 py-3">
          <div className="flex flex-wrap gap-2 justify-center">
            {EMOJI_PICKER.map((emoji, idx) => (
              <button
                key={idx}
                onClick={() => addEmoji(emoji)}
                className="w-10 h-10 text-2xl hover:bg-gray-100 rounded-full 
                           transition-all duration-200 hover:scale-125 active:scale-95"
              >
                {emoji}
              </button>
            ))}
          </div>
        </div>
      )}

      {/* حقل الإدخال الفخم */}
      <div className="bg-white border-t border-gray-200 p-3">
        <div className="flex items-center gap-2">
          <button
            onClick={() => setShowEmoji(!showEmoji)}
            className={`w-10 h-10 rounded-full flex items-center justify-center transition-all
                       ${showEmoji ? 'bg-primary text-white' : 'bg-gray-100 text-gray-600 hover:bg-gray-200'}`}
          >
            <Smile className="w-5 h-5" />
          </button>
          
          <div className="flex-1 relative">
            <input
              type="text"
              value={newMsg}
              onChange={(e) => setNewMsg(e.target.value)}
              onKeyPress={(e) => e.key === 'Enter' && sendMessage(newMsg)}
              placeholder="اكتب رسالتك..."
              className="w-full px-5 py-3 bg-gray-100 rounded-full text-gray-800 
                         placeholder-gray-400 focus:outline-none focus:ring-2 
                         focus:ring-primary/50 focus:bg-white transition-all"
            />
          </div>
          
          <button
            onClick={() => sendMessage(newMsg)}
            disabled={!newMsg.trim() || sending}
            className={`w-12 h-12 rounded-full flex items-center justify-center transition-all
                       ${newMsg.trim() 
                         ? 'bg-gradient-to-r from-primary to-accent text-white shadow-lg hover:shadow-xl hover:scale-105' 
                         : 'bg-gray-200 text-gray-400'
                       }
                       disabled:opacity-50 active:scale-95`}
          >
            <Send className="w-5 h-5" />
          </button>
        </div>
      </div>

      {/* تم التسليم */}
      {order.status === 'delivered' && (
        <div className="bg-gradient-to-r from-green-500 to-emerald-500 p-4 text-center">
          <div className="flex items-center justify-center gap-2 text-white">
            <CheckCheck className="w-6 h-6" />
            <span className="font-bold">تم تسليم الطلب بنجاح! </span>
            <Heart className="w-5 h-5 text-red-300 animate-pulse" />
          </div>
          <p className="text-white/80 text-sm mt-1">شكراً لاستخدامك تطبيقنا </p>
        </div>
      )}
    </div>
  )
}

==========================================================================================
FILE: src/pages/CheckoutPage.tsx
==========================================================================================
import React, { useState, useEffect } from 'react'
import { addDoc, collection, doc, getDoc, updateDoc, increment, serverTimestamp } from 'firebase/firestore'
import { db } from '@/firebase'
import { useCart } from '@/hooks/useCart'
import { useAuth } from '@/auth'
import { useNavigate } from 'react-router-dom'
import { RoleGate } from '@/routes/RoleGate'
import { useDialog } from '@/components/ui/ConfirmDialog'
import { useToast } from '@/components/ui/Toast'
import { LocationPicker } from '@/components/LocationPicker'
import { MapPin, Check, ShoppingBag, Truck, CreditCard, ChevronLeft, Store, XCircle, Info } from 'lucide-react'

const PLATFORM_FEE_PER_ITEM = 1.0
const ADMIN_COMMISSION_PER_ITEM = 0.75

// رسوم المنصة على كل طلب توصيل (تُخصم من المندوب)
const COURIER_PLATFORM_FEE = 3.75

//  التوصيل متوفر - رسوم التوصيل يحددها المندوب/الأسرة
const DELIVERY_AVAILABLE = true

export const CheckoutPage: React.FC = () => {
  const { items, subtotal, clear } = useCart()
  const { user } = useAuth()
  const nav = useNavigate()
  const dialog = useDialog()
  const toast = useToast()
  const [address, setAddress] = useState('')
  const [saving, setSaving] = useState(false)
  const [restaurant, setRestaurant] = useState<{ id: string; name: string; referredBy?: string; referrerType?: string } | null>(null)
  const [location, setLocation] = useState<{ lat: number; lng: number } | null>(null)
  const [showLocationPicker, setShowLocationPicker] = useState(false)
  const [deliveryType, setDeliveryType] = useState<'pickup' | 'delivery'>('pickup') // الاستلام افتراضي

  // رسوم التوصيل تبدأ بـ 0 - يحددها المندوب أو الأسرة عند قبول الطلب
  const deliveryFee = 0 // سيتم تحديدها لاحقاً
  const totalItemsCount = items.reduce((sum, item) => sum + item.qty, 0)
  const total = subtotal // بدون رسوم توصيل مبدئياً

  //  تحميل بيانات المطعم
  useEffect(() => {
    const loadRestaurant = async () => {
      if (items.length === 0) return
      let ownerId = items[0]?.ownerId

      if (!ownerId && items[0]?.id) {
        try {
          const menuSnap = await getDoc(doc(db, 'menuItems', items[0].id))
          const menuData = menuSnap.exists() ? (menuSnap.data() as any) : null
          ownerId = menuData?.ownerId || null
        } catch (err) {
          console.error('خطأ في جلب بيانات الصنف:', err)
        }
      }

      if (!ownerId) {
        setRestaurant(null)
        return
      }

      const rSnap = await getDoc(doc(db, 'restaurants', ownerId))
      const rData = rSnap.exists() ? (rSnap.data() as any) : null
      setRestaurant({ 
        id: ownerId, 
        name: rData?.name || 'مطعم',
        referredBy: rData?.referredBy,
        referrerType: rData?.referrerType
      })
    }
    loadRestaurant()
  }, [items])

  //  معالجة تأكيد الموقع من LocationPicker
  const handleLocationConfirm = (loc: { lat: number; lng: number }, addr: string) => {
    setLocation(loc)
    setAddress(addr)
    setShowLocationPicker(false)
    toast.success('تم تحديد موقعك بنجاح! ')
  }

  //  إرسال الطلب
  const placeOrder = async () => {
    if (!user) return
    if (items.length === 0) { dialog.warning('السلة فارغة'); return }
    
    // التحقق من الموقع والعنوان فقط إذا كان التوصيل مفعل ومختار
    if (deliveryType === 'delivery' && DELIVERY_AVAILABLE) {
      if (!address) { dialog.warning('أدخل العنوان'); return }
      if (!location) { dialog.warning('حدّد موقعك على الخريطة'); return }
    }

    let restId = restaurant?.id
    if (!restId && items[0]?.id) {
      const menuSnap = await getDoc(doc(db, 'menuItems', items[0].id))
      const menuData = menuSnap.exists() ? (menuSnap.data() as any) : null
      restId = menuData?.ownerId || null
    }

    if (!restId) {
      dialog.error('تعذر تحديد المطعم للطلب. أعد الإضافة من القائمة.')
      return
    }

    setSaving(true)
    
    //  حساب تقسيم الدخل
    const referredByAdmin = restaurant?.referrerType === 'admin' && restaurant?.referredBy
    const totalItemsCount = items.reduce((sum, item) => sum + item.qty, 0)
    
    // حساب سعر المنتجات الأصلي (بدون رسوم التطبيق)
    const SERVICE_FEE_PER_ITEM = PLATFORM_FEE_PER_ITEM + ADMIN_COMMISSION_PER_ITEM // 1.75
    const originalSubtotal = subtotal - (SERVICE_FEE_PER_ITEM * totalItemsCount) // سعر المنتجات الأصلي للمطعم
    
    // تقسيم الدخل:
    const restaurantEarnings = originalSubtotal // المطعم يحصل على السعر الأصلي
    const platformFee = PLATFORM_FEE_PER_ITEM * totalItemsCount // رسوم التطبيق (1 ر.س × عدد المنتجات)
    const adminCommission = referredByAdmin ? (ADMIN_COMMISSION_PER_ITEM * totalItemsCount) : 0 // عمولة المشرف
    const appEarnings = platformFee + (referredByAdmin ? 0 : (ADMIN_COMMISSION_PER_ITEM * totalItemsCount)) // التطبيق يأخذ عمولة المشرف إذا ما فيه مشرف

    // إنشاء الطلب مع معلومات العمولة
    const orderRef = await addDoc(collection(db, 'orders'), {
      customerId: user.uid,
      restaurantId: restId,
      restaurantName: restaurant?.name || 'مطعم',
      items: items.map(i => ({
        id: i.id,
        name: i.name,
        price: i.price,
        qty: i.qty,
        ownerId: i.ownerId ?? restId,
      })),
      subtotal,
      deliveryFee: 0, // يحددها المندوب أو الأسرة لاحقاً
      deliveryFeeSetBy: null, // من حدد رسوم التوصيل
      deliveryFeeSetAt: null, // متى تم تحديدها
      total: subtotal, // الإجمالي بدون رسوم توصيل مبدئياً
      status: 'pending',
      deliveryType, // نوع التسليم: pickup أو delivery
      address: deliveryType === 'pickup' ? 'استلام من المطعم' : address,
      location: deliveryType === 'pickup' ? null : location,
      createdAt: serverTimestamp(),
      updatedAt: serverTimestamp(),
      paymentMethod: 'cod',
      //  معلومات تقسيم الدخل
      restaurantEarnings: restaurantEarnings,
      platformFee: platformFee,
      platformFeePerItem: PLATFORM_FEE_PER_ITEM,
      adminCommission: adminCommission,
      adminCommissionPerItem: ADMIN_COMMISSION_PER_ITEM,
      appEarnings: appEarnings,
      totalItemsCount: totalItemsCount,
      referredBy: restaurant?.referredBy || null,
      //  رسوم المنصة على المندوب (3.75 ريال)
      courierPlatformFee: deliveryType === 'delivery' ? COURIER_PLATFORM_FEE : 0,
    })

    //  تحديث محفظة المطعم
    try {
      const restaurantWalletRef = doc(db, 'wallets', restId)
      const restaurantWalletSnap = await getDoc(restaurantWalletRef)
      
      if (restaurantWalletSnap.exists()) {
        await updateDoc(restaurantWalletRef, {
          balance: increment(restaurantEarnings),
          totalEarnings: increment(restaurantEarnings),
          updatedAt: serverTimestamp(),
        })
      } else {
        const { setDoc } = await import('firebase/firestore')
        await setDoc(restaurantWalletRef, {
          balance: restaurantEarnings,
          totalEarnings: restaurantEarnings,
          totalWithdrawn: 0,
          transactions: [],
          updatedAt: serverTimestamp(),
        })
      }
    } catch (err) {
      // خطأ في تحديث محفظة المطعم
    }

    //  تحديث محفظة المشرف إذا كان المطعم مسجل عن طريقه
    if (referredByAdmin && restaurant?.referredBy && adminCommission > 0) {
      try {
        const walletRef = doc(db, 'wallets', restaurant.referredBy)
        const walletSnap = await getDoc(walletRef)
        
        if (walletSnap.exists()) {
          // تحديث المحفظة الموجودة
          await updateDoc(walletRef, {
            balance: increment(adminCommission),
            totalEarnings: increment(adminCommission),
            updatedAt: serverTimestamp(),
          })
        } else {
          // إنشاء محفظة جديدة للمشرف
          const { setDoc } = await import('firebase/firestore')
          await setDoc(walletRef, {
            balance: adminCommission,
            totalEarnings: adminCommission,
            totalWithdrawn: 0,
            transactions: [],
            updatedAt: serverTimestamp(),
          })
        }
        
        // إضافة المعاملة للسجل (اختياري - يمكن إضافته لاحقاً)
      } catch (err) {
        // خطأ في تحديث محفظة المشرف
      }
    }

    //  تحديث محفظة التطبيق (المطور الرئيسي)
    try {
      const appWalletRef = doc(db, 'wallets', 'app_earnings')
      const appWalletSnap = await getDoc(appWalletRef)
      
      if (appWalletSnap.exists()) {
        await updateDoc(appWalletRef, {
          balance: increment(appEarnings),
          totalEarnings: increment(appEarnings),
          updatedAt: serverTimestamp(),
        })
      } else {
        const { setDoc } = await import('firebase/firestore')
        await setDoc(appWalletRef, {
          balance: appEarnings,
          totalEarnings: appEarnings,
          totalWithdrawn: 0,
          transactions: [],
          updatedAt: serverTimestamp(),
        })
      }
    } catch (err) {
      // خطأ في تحديث محفظة التطبيق
    }

    clear()
    setSaving(false)
    nav('/orders')
  }

  return (
    <RoleGate allow={['customer', 'admin']}>
      <div className="max-w-xl mx-auto space-y-4">
        
        {/* العنوان الرئيسي */}
        <div className="bg-gradient-to-r from-sky-500 to-sky-600 rounded-2xl p-5 text-white shadow-lg">
          <div className="flex items-center gap-3">
            <div className="w-12 h-12 bg-white/20 rounded-xl flex items-center justify-center">
              <ShoppingBag className="w-6 h-6" />
            </div>
            <div>
              <h1 className="text-xl font-bold">إتمام الطلب</h1>
              <p className="text-sm text-white/80">{restaurant?.name || 'جارِ التحميل...'}</p>
            </div>
          </div>
        </div>

        {/*  تفاصيل الطلب */}
        <div className="bg-white rounded-2xl shadow-lg overflow-hidden">
          <div className="bg-gray-50 px-4 py-3 border-b flex items-center gap-2">
            <ShoppingBag className="w-5 h-5 text-sky-500" />
            <span className="font-bold text-gray-800">تفاصيل الطلب</span>
            <span className="text-xs bg-sky-100 text-sky-600 px-2 py-0.5 rounded-full mr-auto">
              {items.length} صنف
            </span>
          </div>
          <div className="p-4 space-y-2">
            {items.map(i => (
              <div key={i.id} className="flex items-center justify-between py-2 border-b border-gray-100 last:border-0">
                <div className="flex items-center gap-3">
                  <span className="w-8 h-8 bg-sky-100 rounded-lg flex items-center justify-center text-sm">
                    {i.qty}×
                  </span>
                  <span className="text-gray-800 font-medium">{i.name}</span>
                </div>
                <span className="font-bold text-sky-600">{(i.price * i.qty).toFixed(2)} ر.س</span>
              </div>
            ))}
          </div>
        </div>

        {/*  اختيار طريقة الاستلام */}
        <div className="bg-white rounded-2xl shadow-lg overflow-hidden">
          <div className="bg-gray-50 px-4 py-3 border-b flex items-center gap-2">
            <Truck className="w-5 h-5 text-sky-500" />
            <span className="font-bold text-gray-800">طريقة الاستلام</span>
          </div>
          <div className="p-4 space-y-3">
            {/* خيار الاستلام من المطعم */}
            <button
              onClick={() => setDeliveryType('pickup')}
              className={`w-full p-4 rounded-xl border-2 transition flex items-center gap-4 ${
                deliveryType === 'pickup'
                  ? 'border-green-500 bg-green-50'
                  : 'border-gray-200 hover:border-gray-300'
              }`}
            >
              <div className={`w-12 h-12 rounded-xl flex items-center justify-center ${
                deliveryType === 'pickup' ? 'bg-green-500' : 'bg-gray-100'
              }`}>
                <Store className={`w-6 h-6 ${deliveryType === 'pickup' ? 'text-white' : 'text-gray-500'}`} />
              </div>
              <div className="flex-1 text-right">
                <p className={`font-bold ${deliveryType === 'pickup' ? 'text-green-700' : 'text-gray-800'}`}>
                  استلام من المطعم
                </p>
                <p className="text-sm text-gray-500">مجاناً - بدون رسوم توصيل</p>
              </div>
              {deliveryType === 'pickup' && (
                <Check className="w-6 h-6 text-green-500" />
              )}
            </button>

            {/* خيار التوصيل */}
            <button
              onClick={() => setDeliveryType('delivery')}
              className={`w-full p-4 rounded-xl border-2 transition flex items-center gap-4 ${
                deliveryType === 'delivery'
                  ? 'border-sky-500 bg-sky-50'
                  : 'border-gray-200 hover:border-gray-300'
              }`}
            >
              <div className={`w-12 h-12 rounded-xl flex items-center justify-center ${
                deliveryType === 'delivery' ? 'bg-sky-500' : 'bg-gray-100'
              }`}>
                <Truck className={`w-6 h-6 ${deliveryType === 'delivery' ? 'text-white' : 'text-gray-500'}`} />
              </div>
              <div className="flex-1 text-right">
                <p className={`font-bold ${deliveryType === 'delivery' ? 'text-sky-700' : 'text-gray-800'}`}>
                  توصيل للمنزل
                </p>
                <p className="text-sm text-amber-600">رسوم التوصيل يحددها المندوب/الأسرة</p>
              </div>
              {deliveryType === 'delivery' && (
                <Check className="w-6 h-6 text-sky-500" />
              )}
            </button>
          </div>
        </div>

        {/*  تحديد الموقع - يظهر فقط إذا كان التوصيل متوفر ومختار */}
        {DELIVERY_AVAILABLE && deliveryType === 'delivery' && (
        <div className="bg-white rounded-2xl shadow-lg overflow-hidden">
          <div className="bg-gray-50 px-4 py-3 border-b flex items-center gap-2">
            <MapPin className="w-5 h-5 text-green-500" />
            <span className="font-bold text-gray-800">موقع التوصيل</span>
          </div>
          <div className="p-4">
            {location ? (
              <div className="space-y-3">
                {/* الموقع المحدد */}
                <div className="bg-green-50 border-2 border-green-200 rounded-xl p-4">
                  <div className="flex items-start gap-3">
                    <div className="w-10 h-10 bg-green-500 rounded-xl flex items-center justify-center flex-shrink-0">
                      <Check className="w-5 h-5 text-white" />
                    </div>
                    <div className="flex-1 min-w-0">
                      <p className="font-bold text-green-700 mb-1">تم تحديد الموقع </p>
                      <p className="text-sm text-gray-600 break-words">{address}</p>
                      <p className="text-xs text-gray-400 mt-1 font-mono">
                        {location.lat.toFixed(5)}, {location.lng.toFixed(5)}
                      </p>
                    </div>
                  </div>
                </div>
                
                {/* زر تغيير الموقع */}
                <button
                  onClick={() => setShowLocationPicker(true)}
                  className="w-full py-3 px-4 rounded-xl border-2 border-sky-200 text-sky-600 font-semibold hover:bg-sky-50 transition flex items-center justify-center gap-2"
                >
                  <MapPin className="w-5 h-5" />
                  تغيير الموقع
                </button>
              </div>
            ) : (
              <button
                onClick={() => setShowLocationPicker(true)}
                className="w-full py-4 rounded-xl bg-gradient-to-r from-sky-500 to-sky-600 text-white font-bold shadow-lg hover:shadow-xl transition flex items-center justify-center gap-3"
              >
                <MapPin className="w-6 h-6" />
                <span>تحديد موقع التوصيل</span>
                <ChevronLeft className="w-5 h-5" />
              </button>
            )}
          </div>
        </div>
        )}

        {/*  الملخص */}
        <div className="bg-white rounded-2xl shadow-lg overflow-hidden">
          <div className="bg-gray-50 px-4 py-3 border-b flex items-center gap-2">
            <CreditCard className="w-5 h-5 text-amber-500" />
            <span className="font-bold text-gray-800">ملخص الفاتورة</span>
          </div>
          <div className="p-4 space-y-2">
            <div className="flex items-center justify-between text-gray-600">
              <span>المجموع الفرعي</span>
              <span className="font-semibold">{subtotal.toFixed(2)} ر.س</span>
            </div>
            {deliveryType === 'delivery' && (
            <div className="flex items-center justify-between text-amber-600">
              <div className="flex items-center gap-2">
                <Truck className="w-4 h-4" />
                <span>رسوم التوصيل</span>
              </div>
              <span className="font-semibold text-sm">تُحدد لاحقاً</span>
            </div>
            )}
            {deliveryType === 'pickup' && (
            <div className="flex items-center justify-between text-green-600">
              <div className="flex items-center gap-2">
                <Store className="w-4 h-4" />
                <span>استلام من المطعم</span>
              </div>
              <span className="font-semibold">مجاناً</span>
            </div>
            )}
            <div className="h-px bg-gray-200 my-2" />
            <div className="flex items-center justify-between">
              <span className="font-bold text-lg text-gray-800">الإجمالي</span>
              <span className="font-black text-xl text-sky-600">{total.toFixed(2)} ر.س</span>
            </div>
          </div>
        </div>

        {/*  زر تأكيد الطلب */}
        <button
          disabled={saving || (deliveryType === 'delivery' && DELIVERY_AVAILABLE && !location)}
          onClick={placeOrder}
          className="w-full py-4 rounded-2xl bg-gradient-to-r from-green-500 to-green-600 text-white font-bold text-lg shadow-xl hover:shadow-2xl disabled:opacity-50 disabled:cursor-not-allowed transition flex items-center justify-center gap-3"
        >
          {saving ? (
            <>
              <div className="w-5 h-5 border-2 border-white/30 border-t-white rounded-full animate-spin" />
              جارِ إرسال الطلب...
            </>
          ) : (
            <>
              <Check className="w-6 h-6" />
              {deliveryType === 'pickup' ? 'تأكيد الطلب (استلام من المطعم)' : 'تأكيد الطلب (دفع عند الاستلام)'}
            </>
          )}
        </button>

        {/* تحذير للتوصيل */}
        {deliveryType === 'delivery' && DELIVERY_AVAILABLE && !location && (
          <p className="text-center text-sm text-amber-600 bg-amber-50 rounded-xl p-3">
             يجب تحديد موقع التوصيل قبل إرسال الطلب
          </p>
        )}

        {/* LocationPicker Modal */}
        <LocationPicker
          isOpen={showLocationPicker}
          onClose={() => setShowLocationPicker(false)}
          onConfirm={handleLocationConfirm}
          initialLocation={location}
        />
      </div>
    </RoleGate>
  )
}

==========================================================================================
FILE: src/pages/CourierApp.tsx
==========================================================================================
// src/pages/CourierApp.tsx
import React, { useEffect, useState } from 'react'
import { 
  collection, doc, onSnapshot, orderBy, query, updateDoc, where, 
  serverTimestamp, limit, getDoc, setDoc
} from 'firebase/firestore'
import { ref, uploadBytes, getDownloadURL } from 'firebase/storage'
import { db, storage } from '@/firebase'
import { useAuth } from '@/auth'
import { Order, Rating, POINTS_CONFIG, ORDER_TIME_LIMITS } from '@/types'
import { useNavigate } from 'react-router-dom'
import { useToast } from '@/components/ui/Toast'
import { useDialog } from '@/components/ui/ConfirmDialog'
import { RatingModal } from '@/components/RatingModal'
import { OrderTimer } from '@/components/OrderTimer'
import { 
  MessageCircle, Package, MapPin, Truck, CheckCircle, 
  Clock, Navigation, Phone, DollarSign, Sparkles, AlertCircle,
  User, Settings, Wallet, FileText, Camera, Building2, 
  Power, PowerOff, History, TrendingUp, Calendar,
  ChevronLeft, Shield, Car, CreditCard, Info, X, Eye,
  MapPinned, Star, Target, Award, Briefcase, BarChart3, RefreshCw, MinusCircle
} from 'lucide-react'

// رسوم المنصة على كل طلب توصيل (تُخصم من المندوب)
const COURIER_PLATFORM_FEE = 3.75

type CourierProfile = {
  name: string
  phone: string
  city: string
  photoUrl?: string
  // المستندات
  idCardUrl?: string
  driverLicenseUrl?: string
  vehicleRegistrationUrl?: string
  documentsStatus?: 'pending' | 'approved' | 'rejected'
  documentsNotes?: string
  // الحساب البنكي
  bankName?: string
  bankAccountName?: string
  bankAccountNumber?: string
  // حالة التوفر
  isAvailable?: boolean
  // إحصائيات
  totalDeliveries?: number
  rating?: number
  joinedAt?: any
  // نظام النقاط
  points?: {
    currentPoints: number
    isSuspended: boolean
    warningCount: number
  }
}

type TabType = 'dashboard' | 'orders' | 'history' | 'earnings' | 'profile'

export const CourierApp: React.FC = () => {
  const { user } = useAuth()
  const nav = useNavigate()
  const toast = useToast()
  const dialog = useDialog()
  
  // الحالة الرئيسية
  const [activeTab, setActiveTab] = useState<TabType>('dashboard')
  const [ready, setReady] = useState<Order[]>([])
  const [mine, setMine] = useState<Order[]>([])
  const [allOrders, setAllOrders] = useState<Order[]>([])
  const [deliveryFees, setDeliveryFees] = useState<Record<string, string>>({})
  const [savingFee, setSavingFee] = useState<string | null>(null)
  const [refreshing, setRefreshing] = useState(false)
  
  // بيانات المندوب
  const [profile, setProfile] = useState<CourierProfile | null>(null)
  const [loadingProfile, setLoadingProfile] = useState(true)
  const [savingProfile, setSavingProfile] = useState(false)
  
  // إحصائيات
  const [stats, setStats] = useState({
    todayDeliveries: 0,
    todayEarnings: 0,
    weekDeliveries: 0,
    weekEarnings: 0,
    monthDeliveries: 0,
    monthEarnings: 0,
    totalDeliveries: 0,
    totalEarnings: 0,
    totalPlatformFees: 0,
    netEarnings: 0,
    pendingOrders: 0,
    activeOrders: 0,
  })
  
  // رفع الملفات
  const [uploadingDoc, setUploadingDoc] = useState<string | null>(null)
  
  // تعديل الملف الشخصي
  const [editingProfile, setEditingProfile] = useState(false)
  const [tempProfile, setTempProfile] = useState<Partial<CourierProfile>>({})
  
  // نظام تقييم العميل
  const [ratingModal, setRatingModal] = useState<{
    isOpen: boolean
    orderId: string
  }>({ isOpen: false, orderId: '' })

  // تحميل بيانات المندوب
  useEffect(() => {
    if (!user?.uid) return
    
    const loadProfile = async () => {
      const docRef = doc(db, 'couriers', user.uid)
      const snap = await getDoc(docRef)
      
      if (snap.exists()) {
        setProfile(snap.data() as CourierProfile)
      } else {
        // إنشاء ملف شخصي جديد
        const newProfile: CourierProfile = {
          name: user.displayName || '',
          phone: '',
          city: '',
          isAvailable: true,
          totalDeliveries: 0,
          rating: 5.0,
          joinedAt: serverTimestamp()
        }
        await setDoc(docRef, newProfile)
        setProfile(newProfile)
      }
      setLoadingProfile(false)
    }
    
    loadProfile()
  }, [user?.uid])

  // تحميل الطلبات
  useEffect(() => {
    if (!user?.uid) return
    
    // الطلبات الجاهزة للتوصيل
    const q1 = query(
      collection(db, 'orders'), 
      where('status', 'in', ['ready']), 
      orderBy('createdAt', 'desc'),
      limit(20)
    )
    const u1 = onSnapshot(q1, (snap) => setReady(snap.docs.map(d => ({ id: d.id, ...d.data() } as Order))))
    
    // طلباتي الحالية
    const q2 = query(
      collection(db, 'orders'), 
      where('courierId', '==', user.uid), 
      orderBy('createdAt', 'desc'),
      limit(50)
    )
    const u2 = onSnapshot(q2, (snap) => {
      const orders = snap.docs.map(d => ({ id: d.id, ...d.data() } as Order))
      setMine(orders)
      setAllOrders(orders)
      calculateStats(orders)
    })
    
    return () => { u1(); u2() }
  }, [user?.uid])

  // حساب الإحصائيات
  const calculateStats = (orders: Order[]) => {
    const now = new Date()
    const todayStart = new Date(now.getFullYear(), now.getMonth(), now.getDate())
    const weekStart = new Date(todayStart)
    weekStart.setDate(weekStart.getDate() - 7)
    const monthStart = new Date(now.getFullYear(), now.getMonth(), 1)

    let todayDeliveries = 0, todayEarnings = 0
    let weekDeliveries = 0, weekEarnings = 0
    let monthDeliveries = 0, monthEarnings = 0
    let totalDeliveries = 0, totalEarnings = 0
    let totalPlatformFees = 0
    let activeOrders = 0

    orders.forEach(order => {
      const createdAt = (order.createdAt as any)?.toDate?.() || new Date(order.createdAt as any)
      const fee = order.deliveryFee || 0
      const platformFee = order.courierPlatformFee || COURIER_PLATFORM_FEE

      if (order.status === 'out_for_delivery') {
        activeOrders++
      }

      if (order.status === 'delivered') {
        totalDeliveries++
        totalEarnings += fee
        totalPlatformFees += platformFee

        if (createdAt >= todayStart) {
          todayDeliveries++
          todayEarnings += fee
        }
        if (createdAt >= weekStart) {
          weekDeliveries++
          weekEarnings += fee
        }
        if (createdAt >= monthStart) {
          monthDeliveries++
          monthEarnings += fee
        }
      }
    })

    setStats({
      todayDeliveries,
      todayEarnings,
      weekDeliveries,
      weekEarnings,
      monthDeliveries,
      monthEarnings,
      totalDeliveries,
      totalEarnings,
      totalPlatformFees,
      netEarnings: totalEarnings - totalPlatformFees,
      pendingOrders: ready.length,
      activeOrders,
    })
  }

  // تحديث البيانات
  const handleRefresh = async () => {
    setRefreshing(true)
    await new Promise(r => setTimeout(r, 1000))
    setRefreshing(false)
    toast.success('تم التحديث')
  }

  // تبديل حالة التوفر
  const toggleAvailability = async () => {
    if (!user?.uid || !profile) return
    
    const newStatus = !profile.isAvailable
    await updateDoc(doc(db, 'couriers', user.uid), { 
      isAvailable: newStatus,
      updatedAt: serverTimestamp()
    })
    setProfile({ ...profile, isAvailable: newStatus })
    toast.success(newStatus ? ' أنت الآن متاح للطلبات' : ' أنت الآن غير متاح')
  }

  // استلام الطلب
  const takeOrder = async (id: string, order: Order) => {
    if (!user) return
    
    if (!profile?.isAvailable) {
      toast.error('فعّل حالة التوفر أولاً')
      return
    }
    
    if (!order.deliveryFeeSetBy) {
      const feeStr = deliveryFees[id]
      const fee = parseFloat(feeStr)
      
      if (isNaN(fee) || fee < 0) {
        toast.error('حدد رسوم التوصيل أولاً')
        return
      }

      setSavingFee(id)
      const newTotal = order.subtotal + fee

      await updateDoc(doc(db, 'orders', id), { 
        courierId: user.uid, 
        status: 'out_for_delivery',
        deliveryFee: fee,
        deliveryFeeSetBy: 'courier',
        deliveryFeeSetAt: serverTimestamp(),
        total: newTotal,
        courierPlatformFee: COURIER_PLATFORM_FEE,
        'timestamps.pickedUpAt': serverTimestamp(),
        updatedAt: serverTimestamp() 
      })
      
      setSavingFee(null)
      toast.success(`تم استلام الطلب! رسوم التوصيل: ${fee} ر.س`)
    } else {
      await updateDoc(doc(db, 'orders', id), { 
        courierId: user.uid, 
        status: 'out_for_delivery',
        courierPlatformFee: COURIER_PLATFORM_FEE,
        'timestamps.pickedUpAt': serverTimestamp(),
        updatedAt: serverTimestamp() 
      })
      toast.success('تم استلام الطلب!')
    }
  }

  // تأكيد التسليم
  const confirmDelivery = async (id: string) => {
    const confirmed = await dialog.confirm(
      'هل تم تسليم الطلب بنجاح؟',
      { title: 'تأكيد التسليم', confirmText: 'نعم، تم التسليم', cancelText: 'إلغاء' }
    )
    if (!confirmed) return
    
    await updateDoc(doc(db, 'orders', id), { 
      status: 'delivered', 
      deliveredAt: serverTimestamp(),
      'timestamps.deliveredAt': serverTimestamp(),
      updatedAt: serverTimestamp() 
    })
    toast.success('تم تسليم الطلب بنجاح! ')
  }
  
  // هل الطلب يحتاج تقييم من المندوب؟
  const needsCustomerRating = (order: Order): boolean => {
    if (order.status !== 'delivered') return false
    return !order.ratings?.courierToCustomer?.stars
  }
  
  // إرسال تقييم العميل
  const submitCustomerRating = async (orderId: string, rating: Rating) => {
    try {
      const orderRef = doc(db, 'orders', orderId)
      const orderSnap = await getDoc(orderRef)
      if (!orderSnap.exists()) return
      
      const orderData = orderSnap.data()
      const currentRatings = orderData.ratings || {}
      
      // تحديث تقييم المندوب للعميل
      const updatedRatings = {
        ...currentRatings,
        courierToCustomer: rating
      }
      
      // التحقق من اكتمال جميع التقييمات
      const allRatingsComplete = 
        updatedRatings.customerToRestaurant?.stars &&
        updatedRatings.customerToCourier?.stars &&
        updatedRatings.restaurantToCustomer?.stars &&
        updatedRatings.courierToCustomer?.stars
      
      await updateDoc(orderRef, {
        ratings: updatedRatings,
        ratingCompleted: allRatingsComplete,
        updatedAt: serverTimestamp()
      })
      
      toast.success('شكراً على تقييمك! ')
      setRatingModal({ isOpen: false, orderId: '' })
    } catch (error) {
      toast.error('حدث خطأ في إرسال التقييم')
    }
  }

  // حفظ الملف الشخصي
  const saveProfile = async (updates: Partial<CourierProfile>) => {
    if (!user?.uid) return
    setSavingProfile(true)
    
    try {
      await updateDoc(doc(db, 'couriers', user.uid), {
        ...updates,
        updatedAt: serverTimestamp()
      })
      setProfile(prev => prev ? { ...prev, ...updates } : null)
      toast.success('تم حفظ البيانات')
    } catch (error) {
      toast.error('حدث خطأ')
    }
    
    setSavingProfile(false)
  }

  // رفع مستند
  const uploadDocument = async (type: 'idCard' | 'driverLicense' | 'vehicleRegistration', file: File) => {
    if (!user?.uid) return
    setUploadingDoc(type)
    
    try {
      const storageRef = ref(storage, `couriers/${user.uid}/${type}_${Date.now()}`)
      await uploadBytes(storageRef, file)
      const url = await getDownloadURL(storageRef)
      
      const fieldName = `${type}Url` as keyof CourierProfile
      const updates: Partial<CourierProfile> = {
        [fieldName]: url,
        documentsStatus: 'pending'
      }
      
      await saveProfile(updates)
      toast.success('تم رفع المستند بنجاح')
    } catch (error) {
      toast.error('فشل رفع المستند')
    }
    
    setUploadingDoc(null)
  }

  // بدء تعديل الملف الشخصي
  const startEditingProfile = () => {
    setTempProfile({
      name: profile?.name || '',
      phone: profile?.phone || '',
      city: profile?.city || '',
      bankName: profile?.bankName || '',
      bankAccountName: profile?.bankAccountName || '',
      bankAccountNumber: profile?.bankAccountNumber || '',
    })
    setEditingProfile(true)
  }

  // عرض شاشة التحميل
  if (loadingProfile) {
    return (
      <div className="flex items-center justify-center min-h-[400px]">
        <div className="text-center">
          <div className="w-16 h-16 border-4 border-sky-500 border-t-transparent rounded-full animate-spin mx-auto mb-4" />
          <p className="text-gray-500">جارِ التحميل...</p>
        </div>
      </div>
    )
  }

  // ===== التبويبات =====
  const tabs = [
    { id: 'dashboard' as TabType, label: 'الرئيسية', icon: Target },
    { id: 'orders' as TabType, label: 'الطلبات', icon: Package },
    { id: 'history' as TabType, label: 'السجل', icon: History },
    { id: 'earnings' as TabType, label: 'الأرباح', icon: Wallet },
    { id: 'profile' as TabType, label: 'حسابي', icon: User },
  ]

  // ===== عرض طلب جاهز =====
  const renderReadyOrder = (order: Order) => (
    <div key={order.id} className="bg-white rounded-2xl shadow-card overflow-hidden hover:shadow-lg transition-all border border-gray-100">
      <div className="bg-gradient-to-r from-purple-500 to-pink-500 px-4 py-2 flex items-center justify-between">
        <span className="text-white font-bold">#{order.id.slice(-6)}</span>
        <span className="text-white/90 text-sm">{order.restaurantName || 'مطعم'}</span>
      </div>
      <div className="p-4">
        {/* عداد وقت انتظار الاستلام */}
        <div className="mb-3">
          <OrderTimer order={order} type="pickup" compact />
        </div>
        
        <div className="flex items-center gap-2 text-gray-600 text-sm mb-2">
          <MapPin className="w-4 h-4" />
          <span className="truncate">{order.address}</span>
        </div>
        
        <div className="bg-gray-50 rounded-xl p-3 mb-3 space-y-1">
          <div className="flex justify-between text-sm">
            <span className="text-gray-600">سعر المنتجات</span>
            <span className="font-semibold">{order.subtotal?.toFixed(2)} ر.س</span>
          </div>
          {order.deliveryFeeSetBy ? (
            <div className="flex justify-between text-sm">
              <span className="text-gray-600">رسوم التوصيل</span>
              <span className="font-semibold text-green-600">{order.deliveryFee?.toFixed(2)} ر.س</span>
            </div>
          ) : (
            <div className="flex justify-between text-sm">
              <span className="text-gray-600">رسوم التوصيل</span>
              <span className="text-amber-600 text-xs">تحددها أنت</span>
            </div>
          )}
        </div>

        {/* تحديد رسوم التوصيل */}
        {!order.deliveryFeeSetBy && (
          <div className="bg-amber-50 border border-amber-200 rounded-xl p-3 mb-3">
            <div className="flex items-center gap-2 mb-2">
              <AlertCircle className="w-4 h-4 text-amber-600" />
              <span className="font-semibold text-amber-800 text-sm">حدد رسوم التوصيل</span>
            </div>
            <div className="flex gap-2">
              <input
                type="number"
                min="0"
                step="0.5"
                placeholder="مثال: 10"
                value={deliveryFees[order.id] || ''}
                onChange={(e) => setDeliveryFees(prev => ({ ...prev, [order.id]: e.target.value }))}
                className="flex-1 px-3 py-2 rounded-lg border border-amber-200 focus:border-amber-400 focus:outline-none text-sm"
              />
              <span className="flex items-center text-gray-500 text-sm">ر.س</span>
            </div>
            <p className="text-xs text-amber-700 mt-2">
               رسوم المنصة: {COURIER_PLATFORM_FEE} ر.س لكل طلب
            </p>
          </div>
        )}

        <button 
          onClick={() => takeOrder(order.id, order)}
          disabled={savingFee === order.id || !profile?.isAvailable}
          className="w-full py-3 rounded-xl bg-gradient-to-r from-gray-800 to-gray-900 
                     text-white font-bold flex items-center justify-center gap-2
                     hover:from-gray-900 hover:to-black transition-all shadow-lg disabled:opacity-50"
        >
          {savingFee === order.id ? (
            <span>جارِ الحفظ...</span>
          ) : (
            <>
              <Truck className="w-5 h-5" />
              <span>استلام الطلب </span>
            </>
          )}
        </button>
      </div>
    </div>
  )

  // ===== عرض طلب نشط =====
  const renderActiveOrder = (order: Order) => (
    <div key={order.id} className="bg-white rounded-2xl shadow-card overflow-hidden border-2 border-sky-200">
      <div className="bg-gradient-to-r from-sky-500 to-blue-500 px-4 py-2 flex items-center justify-between">
        <span className="text-white font-bold">#{order.id.slice(-6)}</span>
        <div className="flex items-center gap-1 text-white/90 text-sm">
          <Clock className="w-3 h-3" />
          <span>في الطريق</span>
        </div>
      </div>
      <div className="p-4">
        {/* عداد وقت التوصيل */}
        <div className="mb-3">
          <OrderTimer order={order} type="delivery" />
        </div>
        
        <div className="flex items-center gap-2 text-gray-600 text-sm mb-2">
          <MapPin className="w-4 h-4" />
          <span className="truncate">{order.address}</span>
        </div>
        <div className="flex items-center gap-2 text-green-600 font-bold text-lg mb-3">
          <DollarSign className="w-5 h-5" />
          <span>{order.total?.toFixed?.(2)} ر.س</span>
        </div>
        
        <div className="flex gap-2">
          <button 
            onClick={() => nav(`/chat?orderId=${order.id}`)}
            className="flex-1 py-3 rounded-xl bg-gradient-to-r from-primary to-accent 
                       text-white font-bold flex items-center justify-center gap-2"
          >
            <MessageCircle className="w-5 h-5" />
            <span>محادثة </span>
          </button>
          <button 
            onClick={() => confirmDelivery(order.id)} 
            className="flex-1 py-3 rounded-xl bg-gradient-to-r from-green-500 to-emerald-500 
                       text-white font-bold flex items-center justify-center gap-2"
          >
            <CheckCircle className="w-5 h-5" />
            <span>تم التسليم </span>
          </button>
        </div>
      </div>
    </div>
  )

  // ===== الصفحة الرئيسية =====
  const renderDashboard = () => (
    <div className="space-y-6">
      {/*  تنبيه الإيقاف */}
      {profile?.points?.isSuspended && (
        <div className="bg-red-50 border-2 border-red-300 rounded-2xl p-4">
          <div className="flex items-center gap-3">
            <div className="w-12 h-12 bg-red-500 rounded-xl flex items-center justify-center">
              <MinusCircle className="w-6 h-6 text-white" />
            </div>
            <div className="flex-1">
              <h3 className="font-bold text-red-700"> حسابك موقوف!</h3>
              <p className="text-sm text-red-600">لن تستطيع استلام طلبات جديدة. تواصل مع الدعم الفني.</p>
            </div>
          </div>
          <button
            onClick={() => nav('/support')}
            className="w-full mt-3 py-2 bg-red-500 text-white rounded-xl font-bold"
          >
            تواصل مع الدعم ←
          </button>
        </div>
      )}

      {/* نظام النقاط */}
      {profile?.points && !profile.points.isSuspended && (
        <div className={`rounded-2xl p-4 border-2 ${
          profile.points.currentPoints < POINTS_CONFIG.WARNING_THRESHOLD
            ? 'bg-amber-50 border-amber-300'
            : 'bg-sky-50 border-sky-200'
        }`}>
          <div className="flex items-center justify-between">
            <div className="flex items-center gap-3">
              <Shield className={`w-6 h-6 ${
                profile.points.currentPoints < POINTS_CONFIG.WARNING_THRESHOLD
                  ? 'text-amber-500' : 'text-sky-500'
              }`} />
              <span className="font-bold text-gray-700">رصيد النقاط</span>
            </div>
            <div className="flex items-center gap-2">
              <span className={`text-2xl font-bold ${
                profile.points.currentPoints < POINTS_CONFIG.WARNING_THRESHOLD
                  ? 'text-amber-600' : 'text-sky-600'
              }`}>{profile.points.currentPoints}</span>
              <span className="text-gray-400">/ {POINTS_CONFIG.STARTING_POINTS}</span>
            </div>
          </div>
          {profile.points.currentPoints < POINTS_CONFIG.WARNING_THRESHOLD && (
            <p className="text-sm text-amber-600 mt-2">
               نقاطك منخفضة! حافظ على جودة الخدمة.
            </p>
          )}
        </div>
      )}

      {/* بيان العمل المستقل */}
      <div className="bg-gradient-to-r from-blue-50 to-sky-50 border border-blue-200 rounded-2xl p-4">
        <div className="flex items-start gap-3">
          <div className="w-10 h-10 bg-blue-500 rounded-xl flex items-center justify-center flex-shrink-0">
            <Briefcase className="w-5 h-5 text-white" />
          </div>
          <div>
            <h3 className="font-bold text-blue-800"> أنت مندوب مستقل (عمل حر)</h3>
            <p className="text-sm text-blue-600 mt-1">
              تعمل بحرية كاملة بدون دوام أو التزامات وظيفية. استلم الطلبات التي تناسبك واحتفظ بأرباحك.
            </p>
          </div>
        </div>
      </div>

      {/* زر التوفر */}
      <button
        onClick={toggleAvailability}
        className={`w-full py-4 rounded-2xl font-bold text-lg flex items-center justify-center gap-3 transition-all shadow-lg ${
          profile?.isAvailable 
            ? 'bg-gradient-to-r from-green-500 to-emerald-600 text-white hover:from-green-600 hover:to-emerald-700' 
            : 'bg-gradient-to-r from-gray-400 to-gray-500 text-white hover:from-gray-500 hover:to-gray-600'
        }`}
      >
        {profile?.isAvailable ? (
          <>
            <Power className="w-6 h-6" />
            <span> متاح للطلبات</span>
          </>
        ) : (
          <>
            <PowerOff className="w-6 h-6" />
            <span> غير متاح</span>
          </>
        )}
      </button>

      {/* إحصائيات سريعة */}
      <div className="grid grid-cols-2 gap-3">
        <div className="bg-gradient-to-br from-sky-500 to-blue-600 rounded-2xl p-4 text-white shadow-lg">
          <div className="flex items-center gap-2 mb-2">
            <Package className="w-5 h-5 opacity-80" />
            <span className="text-sm opacity-90">طلبات جاهزة</span>
          </div>
          <div className="text-3xl font-bold">{ready.length}</div>
        </div>
        <div className="bg-gradient-to-br from-amber-500 to-orange-600 rounded-2xl p-4 text-white shadow-lg">
          <div className="flex items-center gap-2 mb-2">
            <Truck className="w-5 h-5 opacity-80" />
            <span className="text-sm opacity-90">قيد التوصيل</span>
          </div>
          <div className="text-3xl font-bold">{stats.activeOrders}</div>
        </div>
        <div className="bg-gradient-to-br from-green-500 to-emerald-600 rounded-2xl p-4 text-white shadow-lg">
          <div className="flex items-center gap-2 mb-2">
            <DollarSign className="w-5 h-5 opacity-80" />
            <span className="text-sm opacity-90">أرباح اليوم</span>
          </div>
          <div className="text-3xl font-bold">{stats.todayEarnings.toFixed(0)}<span className="text-lg"> ر.س</span></div>
        </div>
        <div className="bg-gradient-to-br from-purple-500 to-pink-600 rounded-2xl p-4 text-white shadow-lg">
          <div className="flex items-center gap-2 mb-2">
            <CheckCircle className="w-5 h-5 opacity-80" />
            <span className="text-sm opacity-90">تسليمات اليوم</span>
          </div>
          <div className="text-3xl font-bold">{stats.todayDeliveries}</div>
        </div>
      </div>

      {/* تنبيه المستندات */}
      {profile?.documentsStatus !== 'approved' && (
        <div className={`rounded-2xl p-4 ${
          profile?.documentsStatus === 'rejected' 
            ? 'bg-red-50 border border-red-200' 
            : 'bg-amber-50 border border-amber-200'
        }`}>
          <div className="flex items-center gap-3">
            <div className={`w-10 h-10 rounded-xl flex items-center justify-center ${
              profile?.documentsStatus === 'rejected' ? 'bg-red-500' : 'bg-amber-500'
            }`}>
              <FileText className="w-5 h-5 text-white" />
            </div>
            <div className="flex-1">
              {profile?.documentsStatus === 'rejected' ? (
                <>
                  <h4 className="font-bold text-red-700"> تم رفض المستندات</h4>
                  <p className="text-sm text-red-600">{profile.documentsNotes || 'يرجى رفع مستندات صالحة'}</p>
                </>
              ) : profile?.documentsStatus === 'pending' ? (
                <>
                  <h4 className="font-bold text-amber-700"> المستندات قيد المراجعة</h4>
                  <p className="text-sm text-amber-600">سيتم إشعارك بالنتيجة قريباً</p>
                </>
              ) : (
                <>
                  <h4 className="font-bold text-amber-700"> ارفع مستنداتك</h4>
                  <p className="text-sm text-amber-600">لتوثيق حسابك وزيادة الموثوقية</p>
                </>
              )}
            </div>
            <button
              onClick={() => setActiveTab('profile')}
              className="text-sm font-bold text-amber-700 underline"
            >
              رفع
            </button>
          </div>
        </div>
      )}

      {/* الطلبات النشطة */}
      {mine.filter(o => o.status === 'out_for_delivery').length > 0 && (
        <div>
          <h3 className="font-bold text-gray-800 mb-3 flex items-center gap-2">
            <Navigation className="w-5 h-5 text-sky-500" />
            طلباتي النشطة
          </h3>
          <div className="space-y-3">
            {mine.filter(o => o.status === 'out_for_delivery').map(renderActiveOrder)}
          </div>
        </div>
      )}

      {/* طلبات جاهزة للاستلام */}
      {profile?.isAvailable && ready.length > 0 && (
        <div>
          <h3 className="font-bold text-gray-800 mb-3 flex items-center gap-2">
            <Package className="w-5 h-5 text-purple-500" />
            طلبات جاهزة للتوصيل ({ready.length})
          </h3>
          <div className="space-y-3">
            {ready.slice(0, 3).map(renderReadyOrder)}
            {ready.length > 3 && (
              <button
                onClick={() => setActiveTab('orders')}
                className="w-full py-3 bg-gray-100 rounded-xl text-gray-600 font-semibold hover:bg-gray-200 transition"
              >
                عرض الكل ({ready.length}) ←
              </button>
            )}
          </div>
        </div>
      )}
    </div>
  )

  // ===== صفحة الطلبات =====
  const renderOrders = () => (
    <div className="space-y-6">
      {/* الطلبات النشطة */}
      <div>
        <h3 className="font-bold text-gray-800 mb-3 flex items-center gap-2">
          <Navigation className="w-5 h-5 text-sky-500" />
          طلباتي النشطة ({mine.filter(o => o.status === 'out_for_delivery').length})
        </h3>
        {mine.filter(o => o.status === 'out_for_delivery').length > 0 ? (
          <div className="space-y-3">
            {mine.filter(o => o.status === 'out_for_delivery').map(renderActiveOrder)}
          </div>
        ) : (
          <div className="text-center py-8 bg-gray-50 rounded-2xl">
            <Truck className="w-12 h-12 text-gray-300 mx-auto mb-2" />
            <p className="text-gray-500">لا توجد طلبات نشطة</p>
          </div>
        )}
      </div>

      {/* الطلبات الجاهزة */}
      <div>
        <h3 className="font-bold text-gray-800 mb-3 flex items-center gap-2">
          <Package className="w-5 h-5 text-purple-500" />
          طلبات جاهزة للتوصيل ({ready.length})
        </h3>
        {ready.length > 0 ? (
          <div className="space-y-3">
            {ready.map(renderReadyOrder)}
          </div>
        ) : (
          <div className="text-center py-8 bg-gray-50 rounded-2xl">
            <Package className="w-12 h-12 text-gray-300 mx-auto mb-2" />
            <p className="text-gray-500">لا توجد طلبات جاهزة</p>
          </div>
        )}
      </div>
    </div>
  )

  // ===== صفحة السجل =====
  const renderHistory = () => (
    <div className="space-y-4">
      <div className="flex items-center justify-between">
        <h3 className="font-bold text-gray-800 flex items-center gap-2">
          <History className="w-5 h-5 text-gray-500" />
          سجل الطلبات
        </h3>
        <span className="text-sm text-gray-500">{allOrders.filter(o => o.status === 'delivered').length} طلب</span>
      </div>

      {allOrders.filter(o => o.status === 'delivered').length > 0 ? (
        <div className="space-y-3">
          {allOrders.filter(o => o.status === 'delivered').map(order => (
            <div key={order.id} className="bg-white rounded-xl shadow p-4 border border-gray-100">
              <div className="flex items-center justify-between mb-2">
                <span className="font-bold text-gray-800">#{order.id.slice(-6)}</span>
                <span className="bg-green-100 text-green-700 px-2 py-0.5 rounded-full text-xs font-bold">
                   تم التسليم
                </span>
              </div>
              <div className="flex items-center gap-2 text-gray-500 text-sm mb-2">
                <MapPin className="w-4 h-4" />
                <span className="truncate">{order.address}</span>
              </div>
              <div className="flex items-center justify-between pt-2 border-t border-gray-100">
                <div className="text-sm text-gray-500">
                  {(order.createdAt as any)?.toDate?.().toLocaleDateString('ar-SA') || ''}
                </div>
                <div className="flex items-center gap-3">
                  <span className="text-green-600 font-bold">{order.deliveryFee?.toFixed(2)} ر.س</span>
                  <span className="text-red-500 text-sm">-{COURIER_PLATFORM_FEE} رسوم</span>
                </div>
              </div>
              
              {/* نظام تقييم العميل */}
              {needsCustomerRating(order) && (
                <div className="mt-3 pt-3 border-t border-gray-100">
                  <button
                    onClick={() => setRatingModal({ isOpen: true, orderId: order.id })}
                    className="w-full flex items-center justify-between px-4 py-3 bg-gradient-to-r from-sky-50 to-blue-50 
                               border-2 border-sky-200 rounded-xl hover:shadow-md transition-all group"
                  >
                    <div className="flex items-center gap-3">
                      <User className="w-5 h-5 text-sky-600" />
                      <span className="font-medium text-gray-800">قيّم العميل </span>
                    </div>
                    <div className="flex items-center gap-1">
                      {[1,2,3,4,5].map(n => (
                        <Star key={n} className="w-4 h-4 text-gray-300 group-hover:text-sky-400 transition" />
                      ))}
                    </div>
                  </button>
                </div>
              )}
              
              {/* عرض التقييم المكتمل */}
              {order.ratings?.courierToCustomer?.stars && (
                <div className="mt-3 pt-3 border-t border-gray-100 bg-green-50 rounded-xl p-3">
                  <div className="flex items-center justify-between">
                    <span className="text-green-700 font-medium">تقييمك للعميل:</span>
                    <div className="flex items-center gap-1">
                      {[1,2,3,4,5].map(n => (
                        <Star key={n} className={`w-4 h-4 ${n <= (order.ratings?.courierToCustomer?.stars || 0) ? 'text-sky-400 fill-sky-400' : 'text-gray-300'}`} />
                      ))}
                    </div>
                  </div>
                </div>
              )}
            </div>
          ))}
        </div>
      ) : (
        <div className="text-center py-12 bg-gray-50 rounded-2xl">
          <History className="w-16 h-16 text-gray-300 mx-auto mb-3" />
          <p className="text-gray-500">لا توجد طلبات سابقة</p>
        </div>
      )}
    </div>
  )

  // ===== صفحة الأرباح =====
  const renderEarnings = () => (
    <div className="space-y-6">
      {/* ملخص الأرباح */}
      <div className="bg-gradient-to-br from-green-600 to-emerald-700 rounded-2xl p-5 text-white">
        <div className="flex items-center gap-2 mb-4">
          <Wallet className="w-6 h-6" />
          <h3 className="font-bold text-lg"> ملخص الأرباح</h3>
        </div>
        
        <div className="grid grid-cols-2 gap-3">
          <div className="bg-white/10 rounded-xl p-4">
            <p className="text-white/70 text-sm mb-1">اليوم</p>
            <p className="text-2xl font-bold">{stats.todayEarnings.toFixed(0)} <span className="text-sm">ر.س</span></p>
            <p className="text-white/60 text-xs">{stats.todayDeliveries} توصيل</p>
          </div>
          <div className="bg-white/10 rounded-xl p-4">
            <p className="text-white/70 text-sm mb-1">الأسبوع</p>
            <p className="text-2xl font-bold">{stats.weekEarnings.toFixed(0)} <span className="text-sm">ر.س</span></p>
            <p className="text-white/60 text-xs">{stats.weekDeliveries} توصيل</p>
          </div>
          <div className="bg-white/10 rounded-xl p-4">
            <p className="text-white/70 text-sm mb-1">الشهر</p>
            <p className="text-2xl font-bold">{stats.monthEarnings.toFixed(0)} <span className="text-sm">ر.س</span></p>
            <p className="text-white/60 text-xs">{stats.monthDeliveries} توصيل</p>
          </div>
          <div className="bg-white/20 rounded-xl p-4 ring-2 ring-white/30">
            <p className="text-white/70 text-sm mb-1">الإجمالي</p>
            <p className="text-2xl font-bold">{stats.totalEarnings.toFixed(0)} <span className="text-sm">ر.س</span></p>
            <p className="text-white/60 text-xs">{stats.totalDeliveries} توصيل</p>
          </div>
        </div>
      </div>

      {/* تقرير الأرباح */}
      <div className="bg-white rounded-2xl shadow-lg p-5 border border-gray-100">
        <div className="flex items-center gap-2 mb-4">
          <BarChart3 className="w-5 h-5 text-blue-600" />
          <h3 className="font-bold text-gray-800"> تفاصيل الأرباح</h3>
        </div>

        <div className="space-y-3">
          <div className="flex items-center justify-between py-2 border-b border-gray-100">
            <span className="text-gray-600">إجمالي رسوم التوصيل</span>
            <span className="font-bold text-gray-900">{stats.totalEarnings.toFixed(2)} ر.س</span>
          </div>
          <div className="flex items-center justify-between py-2 border-b border-gray-100">
            <div>
              <span className="text-gray-600">رسوم المنصة</span>
              <p className="text-xs text-gray-400">({stats.totalDeliveries} طلب × {COURIER_PLATFORM_FEE} ر.س)</p>
            </div>
            <span className="font-bold text-red-600">- {stats.totalPlatformFees.toFixed(2)} ر.س</span>
          </div>
          <div className="flex items-center justify-between py-3 bg-green-50 rounded-xl px-3">
            <div className="flex items-center gap-2">
              <div className="w-10 h-10 bg-green-500 rounded-xl flex items-center justify-center">
                <Wallet className="w-5 h-5 text-white" />
              </div>
              <span className="font-bold text-green-800">صافي أرباحك</span>
            </div>
            <span className="text-2xl font-bold text-green-600">{stats.netEarnings.toFixed(2)} ر.س</span>
          </div>
        </div>
      </div>

      {/* الحساب البنكي */}
      <div className="bg-gradient-to-r from-blue-50 to-sky-50 border border-blue-200 rounded-2xl p-4">
        <div className="flex items-center gap-2 mb-3">
          <Building2 className="w-5 h-5 text-blue-600" />
          <h3 className="font-bold text-blue-800"> حسابك البنكي</h3>
        </div>
        {profile?.bankName ? (
          <div className="bg-white rounded-xl p-3 space-y-2">
            <p className="text-sm"><span className="text-gray-500">البنك:</span> <span className="font-semibold">{profile.bankName}</span></p>
            <p className="text-sm"><span className="text-gray-500">الاسم:</span> <span className="font-semibold">{profile.bankAccountName}</span></p>
            <p className="text-sm"><span className="text-gray-500">الآيبان:</span> <span className="font-semibold">{profile.bankAccountNumber}</span></p>
          </div>
        ) : (
          <button
            onClick={() => setActiveTab('profile')}
            className="w-full py-3 bg-blue-500 text-white rounded-xl font-bold hover:bg-blue-600 transition"
          >
            أضف حسابك البنكي
          </button>
        )}
        <p className="text-xs text-blue-600 mt-2">
           يتم تحويل أرباحك أسبوعياً إلى حسابك البنكي
        </p>
      </div>
    </div>
  )

  // ===== صفحة الملف الشخصي =====
  const renderProfile = () => (
    <div className="space-y-6">
      {/* بطاقة الملف الشخصي */}
      <div className="bg-gradient-to-br from-gray-900 to-gray-800 rounded-2xl p-5 text-white relative overflow-hidden">
        <div className="absolute inset-0 opacity-10">
          <div className="absolute top-0 right-0 w-64 h-64 bg-sky-500 rounded-full -translate-y-1/2 translate-x-1/2" />
        </div>
        
        <div className="relative z-10">
          <div className="flex items-center gap-4 mb-4">
            <div className="w-20 h-20 rounded-2xl bg-white/20 flex items-center justify-center overflow-hidden">
              {profile?.photoUrl ? (
                <img src={profile.photoUrl} alt="" className="w-full h-full object-cover" />
              ) : (
                <User className="w-10 h-10 text-white/60" />
              )}
            </div>
            <div>
              <h2 className="text-xl font-bold">{profile?.name || 'مندوب'}</h2>
              <p className="text-white/70 text-sm">{profile?.phone || 'لم يُحدد'}</p>
              <p className="text-white/50 text-sm">{profile?.city || 'المدينة'}</p>
            </div>
          </div>

          <div className="grid grid-cols-3 gap-3 pt-4 border-t border-white/20">
            <div className="text-center">
              <p className="text-2xl font-bold">{stats.totalDeliveries}</p>
              <p className="text-white/60 text-xs">توصيل</p>
            </div>
            <div className="text-center">
              <p className="text-2xl font-bold flex items-center justify-center gap-1">
                <Star className="w-4 h-4 text-yellow-400 fill-yellow-400" />
                {profile?.rating?.toFixed(1) || '5.0'}
              </p>
              <p className="text-white/60 text-xs">تقييم</p>
            </div>
            <div className="text-center">
              <p className="text-2xl font-bold">{stats.netEarnings.toFixed(0)}</p>
              <p className="text-white/60 text-xs">ر.س أرباح</p>
            </div>
          </div>
        </div>
      </div>

      {/* حالة التوثيق */}
      <div className={`rounded-2xl p-4 ${
        profile?.documentsStatus === 'approved' ? 'bg-green-50 border border-green-200' :
        profile?.documentsStatus === 'rejected' ? 'bg-red-50 border border-red-200' :
        'bg-amber-50 border border-amber-200'
      }`}>
        <div className="flex items-center gap-3">
          <div className={`w-12 h-12 rounded-xl flex items-center justify-center ${
            profile?.documentsStatus === 'approved' ? 'bg-green-500' :
            profile?.documentsStatus === 'rejected' ? 'bg-red-500' :
            'bg-amber-500'
          }`}>
            <Shield className="w-6 h-6 text-white" />
          </div>
          <div>
            <h3 className={`font-bold ${
              profile?.documentsStatus === 'approved' ? 'text-green-700' :
              profile?.documentsStatus === 'rejected' ? 'text-red-700' :
              'text-amber-700'
            }`}>
              {profile?.documentsStatus === 'approved' && ' حساب موثق'}
              {profile?.documentsStatus === 'rejected' && ' المستندات مرفوضة'}
              {(!profile?.documentsStatus || profile?.documentsStatus === 'pending') && ' قيد التوثيق'}
            </h3>
            {profile?.documentsStatus === 'rejected' && profile.documentsNotes && (
              <p className="text-sm text-red-600">{profile.documentsNotes}</p>
            )}
          </div>
        </div>
      </div>

      {/* تعديل البيانات */}
      {editingProfile ? (
        <div className="bg-white rounded-2xl shadow-lg p-5 border border-gray-100">
          <h3 className="font-bold text-gray-800 mb-4">تعديل البيانات</h3>
          
          <div className="space-y-4">
            <div>
              <label className="block text-sm font-semibold text-gray-700 mb-1">الاسم</label>
              <input
                type="text"
                value={tempProfile.name || ''}
                onChange={(e) => setTempProfile({ ...tempProfile, name: e.target.value })}
                className="w-full px-4 py-3 rounded-xl border border-gray-200 focus:border-sky-400 focus:ring-2 focus:ring-sky-100"
              />
            </div>
            <div>
              <label className="block text-sm font-semibold text-gray-700 mb-1">رقم الجوال</label>
              <input
                type="tel"
                value={tempProfile.phone || ''}
                onChange={(e) => setTempProfile({ ...tempProfile, phone: e.target.value })}
                className="w-full px-4 py-3 rounded-xl border border-gray-200 focus:border-sky-400 focus:ring-2 focus:ring-sky-100"
                dir="ltr"
              />
            </div>
            <div>
              <label className="block text-sm font-semibold text-gray-700 mb-1">المدينة</label>
              <input
                type="text"
                value={tempProfile.city || ''}
                onChange={(e) => setTempProfile({ ...tempProfile, city: e.target.value })}
                className="w-full px-4 py-3 rounded-xl border border-gray-200 focus:border-sky-400 focus:ring-2 focus:ring-sky-100"
              />
            </div>
            
            <div className="border-t pt-4">
              <h4 className="font-bold text-gray-700 mb-3 flex items-center gap-2">
                <Building2 className="w-4 h-4 text-green-500" />
                الحساب البنكي
              </h4>
              <div className="space-y-3">
                <select
                  value={tempProfile.bankName || ''}
                  onChange={(e) => setTempProfile({ ...tempProfile, bankName: e.target.value })}
                  className="w-full px-4 py-3 rounded-xl border border-gray-200 focus:border-sky-400"
                >
                  <option value="">اختر البنك</option>
                  <option value="الراجحي">بنك الراجحي</option>
                  <option value="الأهلي">البنك الأهلي</option>
                  <option value="الإنماء">مصرف الإنماء</option>
                  <option value="الرياض">بنك الرياض</option>
                  <option value="البلاد">بنك البلاد</option>
                </select>
                <input
                  type="text"
                  placeholder="اسم صاحب الحساب"
                  value={tempProfile.bankAccountName || ''}
                  onChange={(e) => setTempProfile({ ...tempProfile, bankAccountName: e.target.value })}
                  className="w-full px-4 py-3 rounded-xl border border-gray-200"
                />
                <input
                  type="text"
                  placeholder="رقم الآيبان (IBAN)"
                  value={tempProfile.bankAccountNumber || ''}
                  onChange={(e) => setTempProfile({ ...tempProfile, bankAccountNumber: e.target.value })}
                  className="w-full px-4 py-3 rounded-xl border border-gray-200"
                  dir="ltr"
                />
              </div>
            </div>

            <div className="flex gap-2 pt-2">
              <button
                onClick={() => {
                  saveProfile(tempProfile)
                  setEditingProfile(false)
                }}
                disabled={savingProfile}
                className="flex-1 py-3 bg-sky-500 text-white rounded-xl font-bold hover:bg-sky-600 transition disabled:opacity-50"
              >
                {savingProfile ? 'جارِ الحفظ...' : 'حفظ'}
              </button>
              <button
                onClick={() => setEditingProfile(false)}
                className="px-6 py-3 bg-gray-200 text-gray-700 rounded-xl font-bold hover:bg-gray-300 transition"
              >
                إلغاء
              </button>
            </div>
          </div>
        </div>
      ) : (
        <button
          onClick={startEditingProfile}
          className="w-full py-3 bg-sky-500 text-white rounded-xl font-bold hover:bg-sky-600 transition flex items-center justify-center gap-2"
        >
          <Settings className="w-5 h-5" />
          تعديل البيانات
        </button>
      )}

      {/* رفع المستندات */}
      <div className="bg-white rounded-2xl shadow-lg p-5 border border-gray-100">
        <h3 className="font-bold text-gray-800 mb-4 flex items-center gap-2">
          <FileText className="w-5 h-5 text-gray-500" />
          المستندات المطلوبة
        </h3>
        
        <div className="space-y-4">
          {/* الهوية */}
          <div className="flex items-center justify-between p-3 bg-gray-50 rounded-xl">
            <div className="flex items-center gap-3">
              <CreditCard className="w-5 h-5 text-gray-500" />
              <span className="font-medium">صورة الهوية</span>
            </div>
            {profile?.idCardUrl ? (
              <div className="flex items-center gap-2">
                <a href={profile.idCardUrl} target="_blank" rel="noopener noreferrer" className="text-sky-600 text-sm">عرض</a>
                <CheckCircle className="w-5 h-5 text-green-500" />
              </div>
            ) : (
              <label className="cursor-pointer">
                <input
                  type="file"
                  accept="image/*"
                  className="hidden"
                  onChange={(e) => e.target.files?.[0] && uploadDocument('idCard', e.target.files[0])}
                />
                <span className="text-sky-600 text-sm font-bold">
                  {uploadingDoc === 'idCard' ? 'جارِ الرفع...' : 'رفع'}
                </span>
              </label>
            )}
          </div>

          {/* رخصة القيادة */}
          <div className="flex items-center justify-between p-3 bg-gray-50 rounded-xl">
            <div className="flex items-center gap-3">
              <Car className="w-5 h-5 text-gray-500" />
              <span className="font-medium">رخصة القيادة</span>
            </div>
            {profile?.driverLicenseUrl ? (
              <div className="flex items-center gap-2">
                <a href={profile.driverLicenseUrl} target="_blank" rel="noopener noreferrer" className="text-sky-600 text-sm">عرض</a>
                <CheckCircle className="w-5 h-5 text-green-500" />
              </div>
            ) : (
              <label className="cursor-pointer">
                <input
                  type="file"
                  accept="image/*"
                  className="hidden"
                  onChange={(e) => e.target.files?.[0] && uploadDocument('driverLicense', e.target.files[0])}
                />
                <span className="text-sky-600 text-sm font-bold">
                  {uploadingDoc === 'driverLicense' ? 'جارِ الرفع...' : 'رفع'}
                </span>
              </label>
            )}
          </div>

          {/* استمارة السيارة */}
          <div className="flex items-center justify-between p-3 bg-gray-50 rounded-xl">
            <div className="flex items-center gap-3">
              <FileText className="w-5 h-5 text-gray-500" />
              <span className="font-medium">استمارة السيارة</span>
            </div>
            {profile?.vehicleRegistrationUrl ? (
              <div className="flex items-center gap-2">
                <a href={profile.vehicleRegistrationUrl} target="_blank" rel="noopener noreferrer" className="text-sky-600 text-sm">عرض</a>
                <CheckCircle className="w-5 h-5 text-green-500" />
              </div>
            ) : (
              <label className="cursor-pointer">
                <input
                  type="file"
                  accept="image/*"
                  className="hidden"
                  onChange={(e) => e.target.files?.[0] && uploadDocument('vehicleRegistration', e.target.files[0])}
                />
                <span className="text-sky-600 text-sm font-bold">
                  {uploadingDoc === 'vehicleRegistration' ? 'جارِ الرفع...' : 'رفع'}
                </span>
              </label>
            )}
          </div>
        </div>
      </div>

      {/* بيان العمل المستقل */}
      <div className="bg-gradient-to-r from-gray-100 to-gray-50 border border-gray-200 rounded-2xl p-4">
        <div className="flex items-start gap-3">
          <Info className="w-5 h-5 text-gray-500 flex-shrink-0 mt-0.5" />
          <div className="text-sm text-gray-600 space-y-2">
            <p><strong> بيان العمل المستقل:</strong></p>
            <ul className="list-disc list-inside space-y-1 text-gray-500">
              <li>أنت تعمل كمندوب مستقل (Freelancer) وليس موظفاً</li>
              <li>لا يوجد دوام ثابت أو ساعات عمل محددة</li>
              <li>حرية كاملة في قبول أو رفض الطلبات</li>
              <li>رسوم المنصة: {COURIER_PLATFORM_FEE} ر.س لكل طلب</li>
              <li>التواصل مع العملاء يتم عبر التطبيق فقط</li>
            </ul>
          </div>
        </div>
      </div>
    </div>
  )

  // ===== العرض الرئيسي =====
  return (
    <div className="space-y-4 pb-24">
      {/* الهيدر */}
      <div className="flex items-center justify-between">
        <h1 className="text-xl font-bold text-gray-900 flex items-center gap-2">
          <Truck className="w-6 h-6 text-sky-500" />
          لوحة المندوب
        </h1>
        <button
          onClick={handleRefresh}
          disabled={refreshing}
          className="p-2 bg-gray-100 rounded-xl hover:bg-gray-200 transition"
        >
          <RefreshCw className={`w-5 h-5 text-gray-600 ${refreshing ? 'animate-spin' : ''}`} />
        </button>
      </div>

      {/* التبويبات */}
      <div className="flex gap-2 overflow-x-auto pb-2 -mx-4 px-4">
        {tabs.map(tab => {
          const Icon = tab.icon
          return (
            <button
              key={tab.id}
              onClick={() => setActiveTab(tab.id)}
              className={`flex items-center gap-2 px-4 py-2 rounded-xl font-semibold whitespace-nowrap transition ${
                activeTab === tab.id
                  ? 'bg-sky-500 text-white'
                  : 'bg-gray-100 text-gray-600 hover:bg-gray-200'
              }`}
            >
              <Icon className="w-4 h-4" />
              {tab.label}
            </button>
          )
        })}
      </div>

      {/* المحتوى */}
      {activeTab === 'dashboard' && renderDashboard()}
      {activeTab === 'orders' && renderOrders()}
      {activeTab === 'history' && renderHistory()}
      {activeTab === 'earnings' && renderEarnings()}
      {activeTab === 'profile' && renderProfile()}
      
      {/* نافذة التقييم */}
      <RatingModal
        isOpen={ratingModal.isOpen}
        onClose={() => setRatingModal({ isOpen: false, orderId: '' })}
        onSubmit={(rating) => submitCustomerRating(ratingModal.orderId, rating)}
        type="customer"
        orderId={ratingModal.orderId}
      />
    </div>
  )
}

export default CourierApp

==========================================================================================
FILE: src/pages/CourierHiring.tsx
==========================================================================================
// src/pages/CourierHiring.tsx
import React, { useEffect, useState } from 'react'
import { db } from '@/firebase'
import { collection, getDocs, addDoc, query, where, getDocs as getDocsQ, serverTimestamp } from 'firebase/firestore'
import { useAuth } from '@/auth'
import { Briefcase, CheckCircle2, XCircle, Clock } from 'lucide-react'
import { useDialog } from '@/components/ui/ConfirmDialog'

type Restaurant = {
  id: string
  name: string
  logoUrl?: string
}

type HiringRequest = {
  restaurantId: string
  status: string
}

export const CourierHiring: React.FC = () => {
  const { user } = useAuth()
  const dialog = useDialog()
  const [restaurants, setRestaurants] = useState<Restaurant[]>([])
  const [requests, setRequests] = useState<Record<string, HiringRequest>>({})
  const [loading, setLoading] = useState(true)
  const [sending, setSending] = useState<string | null>(null)

  useEffect(() => {
    if (!user) return

    const load = async () => {
      //  تحميل المطاعم
      const snap = await getDocs(collection(db, 'restaurants'))
      const data = snap.docs.map(d => ({ id: d.id, ...(d.data() as any) }))
      setRestaurants(data)

      //  تحميل طلبات التوظيف الخاصة بالمندوب
      const qy = query(collection(db, 'hiringRequests'), where('courierId', '==', user.uid))
      const reqSnap = await getDocsQ(qy)
      const reqs: Record<string, HiringRequest> = {}
      reqSnap.docs.forEach(d => {
        const rd = d.data() as any
        reqs[rd.restaurantId] = { restaurantId: rd.restaurantId, status: rd.status }
      })
      setRequests(reqs)

      setLoading(false)
    }

    load()
  }, [user])

  const sendRequest = async (r: Restaurant) => {
    if (!user) { dialog.warning('سجل دخول أولاً'); return }
    setSending(r.id)

    await addDoc(collection(db, 'hiringRequests'), {
      courierId: user.uid,
      courierName: user.displayName || 'مندوب',
      restaurantId: r.id,
      restaurantName: r.name,
      status: 'pending',
      createdAt: serverTimestamp(),
    })

    setRequests(prev => ({
      ...prev,
      [r.id]: { restaurantId: r.id, status: 'pending' },
    }))

    setSending(null)
  }

  if (loading) return <div className="text-center py-10 text-sky-600"> تحميل المطاعم...</div>

  return (
    <div className="min-h-screen bg-gradient-to-br from-sky-50 via-white to-sky-100 py-8 px-4">
      <h1 className="text-2xl sm:text-3xl font-extrabold text-sky-600 text-center mb-8 flex items-center justify-center gap-2">
        <Briefcase className="w-7 h-7 text-sky-500" />
        طلبات التوظيف
      </h1>

      <div className="grid sm:grid-cols-2 lg:grid-cols-3 gap-6 max-w-5xl mx-auto">
        {restaurants.map(r => {
          const req = requests[r.id]
          return (
            <div
              key={r.id}
              className="glass-card rounded-2xl p-6 hover:shadow-xl transition transform hover:-translate-y-1 flex flex-col items-center"
            >
              {r.logoUrl ? (
                <img
                  src={r.logoUrl}
                  className="w-24 h-24 rounded-full mb-4 object-cover border-4 border-sky-300 shadow"
                />
              ) : (
                <div className="w-24 h-24 rounded-full bg-sky-100 flex items-center justify-center text-3xl mb-4">
                  
                </div>
              )}
              <h3 className="font-bold text-lg mb-2 text-sky-900">{r.name}</h3>

              {req ? (
                <span
                  className={`mt-3 px-4 py-2 rounded-xl text-sm font-semibold flex items-center gap-2 ${
                    req.status === 'pending'
                      ? 'bg-amber-100 text-amber-700 border border-amber-200'
                      : req.status === 'accepted'
                      ? 'bg-green-100 text-green-700 border border-green-200'
                      : 'bg-red-100 text-red-700 border border-red-200'
                  }`}
                >
                  {req.status === 'pending' && <Clock className="w-4 h-4" />}
                  {req.status === 'accepted' && <CheckCircle2 className="w-4 h-4" />}
                  {req.status === 'rejected' && <XCircle className="w-4 h-4" />}
                  {req.status === 'pending'
                    ? 'قيد المراجعة'
                    : req.status === 'accepted'
                    ? ' تم القبول'
                    : ' مرفوض'}
                </span>
              ) : (
                <button
                  disabled={sending === r.id}
                  onClick={() => sendRequest(r)}
                  className="mt-4 w-full px-4 py-2 rounded-xl bg-gradient-to-r from-sky-500 to-sky-600 text-white font-bold shadow-lg shadow-sky-200/50 hover:shadow-xl hover:scale-105 transition disabled:opacity-50"
                >
                  {sending === r.id ? ' جاري الإرسال...' : ' طلب توظيف'}
                </button>
              )}
            </div>
          )
        })}
      </div>
    </div>
  )
}

==========================================================================================
FILE: src/pages/CourierRequests.tsx
==========================================================================================
// src/pages/CourierRequests.tsx
import React, { useEffect, useState } from 'react'
import { db } from '@/firebase'
import { collection, query, where, getDocs, updateDoc, doc, deleteDoc } from 'firebase/firestore'
import { useAuth } from '@/auth'
import { useDialog } from '@/components/ui/ConfirmDialog'
import { useToast } from '@/components/ui/Toast'
import { UserX, UserCheck, UserMinus, Clock, CheckCircle, XCircle, Trash2 } from 'lucide-react'

export const CourierRequests: React.FC = () => {
  const { user } = useAuth()
  const dialog = useDialog()
  const toast = useToast()
  const [requests, setRequests] = useState<any[]>([])
  const [loading, setLoading] = useState(true)

  useEffect(() => {
    if (!user) return
    (async () => {
      const q = query(collection(db, 'hiringRequests'), where('restaurantId', '==', user.uid))
      const snap = await getDocs(q)
      setRequests(snap.docs.map(d => ({ id: d.id, ...(d.data() as any) })))
      setLoading(false)
    })()
  }, [user])

  const handleAction = async (id: string, status: 'accepted' | 'rejected') => {
    await updateDoc(doc(db, 'hiringRequests', id), { status })
    setRequests(reqs => reqs.map(r => r.id === id ? { ...r, status } : r))
    toast.success(status === 'accepted' ? 'تم قبول المندوب ' : 'تم رفض الطلب')
  }

  // فصل المندوب (تغيير حالته إلى terminated)
  const handleTerminate = async (request: any) => {
    const confirmed = await dialog.confirm(
      `هل تريد فصل المندوب "${request.courierName}"؟`,
      {
        title: 'فصل المندوب',
        confirmText: 'نعم، فصل',
        cancelText: 'إلغاء',
        dangerous: true
      }
    )
    
    if (!confirmed) return
    
    await updateDoc(doc(db, 'hiringRequests', request.id), { status: 'terminated' })
    setRequests(reqs => reqs.map(r => r.id === request.id ? { ...r, status: 'terminated' } : r))
    toast.success('تم فصل المندوب')
  }

  // حذف الطلب نهائياً
  const handleDelete = async (request: any) => {
    const confirmed = await dialog.confirm(
      `هل تريد حذف طلب "${request.courierName}" نهائياً؟`,
      {
        title: 'حذف الطلب',
        confirmText: 'نعم، حذف',
        cancelText: 'إلغاء',
        dangerous: true
      }
    )
    
    if (!confirmed) return
    
    await deleteDoc(doc(db, 'hiringRequests', request.id))
    setRequests(reqs => reqs.filter(r => r.id !== request.id))
    toast.success('تم حذف الطلب')
  }

  // إعادة تفعيل المندوب
  const handleReactivate = async (request: any) => {
    await updateDoc(doc(db, 'hiringRequests', request.id), { status: 'accepted' })
    setRequests(reqs => reqs.map(r => r.id === request.id ? { ...r, status: 'accepted' } : r))
    toast.success('تم إعادة تفعيل المندوب ')
  }

  const getStatusBadge = (status: string) => {
    switch (status) {
      case 'pending':
        return { text: 'بانتظار الرد', color: 'bg-yellow-100 text-yellow-700', icon: Clock }
      case 'accepted':
        return { text: 'مقبول ', color: 'bg-green-100 text-green-700', icon: CheckCircle }
      case 'rejected':
        return { text: 'مرفوض', color: 'bg-red-100 text-red-700', icon: XCircle }
      case 'terminated':
        return { text: 'مفصول', color: 'bg-gray-100 text-gray-700', icon: UserX }
      default:
        return { text: status, color: 'bg-gray-100 text-gray-700', icon: Clock }
    }
  }

  if (loading) return <div className="text-center py-10"> جارِ التحميل...</div>

  // تقسيم الطلبات حسب الحالة
  const activeCouriers = requests.filter(r => r.status === 'accepted')
  const pendingRequests = requests.filter(r => r.status === 'pending')
  const terminatedCouriers = requests.filter(r => r.status === 'terminated')
  const rejectedRequests = requests.filter(r => r.status === 'rejected')

  return (
    <div className="py-6 space-y-8">
      <h1 className="text-2xl font-bold text-primary text-center mb-6"> إدارة المناديب</h1>
      
      {requests.length === 0 ? (
        <div className="text-center py-16">
          <div className="text-6xl mb-4"></div>
          <p className="text-gray-500 text-lg">لا توجد طلبات توظيف</p>
          <p className="text-gray-400 text-sm mt-2">سيظهر هنا طلبات المناديب للانضمام لمطعمك</p>
        </div>
      ) : (
        <>
          {/* المناديب النشطين */}
          {activeCouriers.length > 0 && (
            <div>
              <h2 className="text-lg font-bold text-green-600 mb-3 flex items-center gap-2">
                <UserCheck className="w-5 h-5" />
                المناديب النشطين ({activeCouriers.length})
              </h2>
              <div className="space-y-3">
                {activeCouriers.map(r => {
                  const badge = getStatusBadge(r.status)
                  return (
                    <div key={r.id} className="bg-white rounded-2xl shadow-card p-4 border-r-4 border-green-500">
                      <div className="flex items-center justify-between">
                        <div className="flex items-center gap-3">
                          <div className="w-12 h-12 rounded-full bg-green-100 flex items-center justify-center text-2xl">
                            
                          </div>
                          <div>
                            <div className="font-bold text-gray-800">{r.courierName}</div>
                            <div className={`text-xs px-2 py-1 rounded-full inline-flex items-center gap-1 ${badge.color}`}>
                              <badge.icon className="w-3 h-3" />
                              {badge.text}
                            </div>
                          </div>
                        </div>
                        <button
                          onClick={() => handleTerminate(r)}
                          className="flex items-center gap-2 px-4 py-2 bg-red-50 text-red-600 rounded-xl 
                                     hover:bg-red-100 transition-all font-medium"
                        >
                          <UserMinus className="w-4 h-4" />
                          فصل
                        </button>
                      </div>
                    </div>
                  )
                })}
              </div>
            </div>
          )}

          {/* طلبات بانتظار الرد */}
          {pendingRequests.length > 0 && (
            <div>
              <h2 className="text-lg font-bold text-yellow-600 mb-3 flex items-center gap-2">
                <Clock className="w-5 h-5" />
                طلبات جديدة ({pendingRequests.length})
              </h2>
              <div className="space-y-3">
                {pendingRequests.map(r => (
                  <div key={r.id} className="bg-white rounded-2xl shadow-card p-4 border-r-4 border-yellow-500">
                    <div className="flex items-center justify-between">
                      <div className="flex items-center gap-3">
                        <div className="w-12 h-12 rounded-full bg-yellow-100 flex items-center justify-center text-2xl">
                          
                        </div>
                        <div>
                          <div className="font-bold text-gray-800">{r.courierName}</div>
                          <div className="text-xs text-yellow-600">بانتظار الرد </div>
                        </div>
                      </div>
                      <div className="flex gap-2">
                        <button 
                          onClick={() => handleAction(r.id, 'accepted')} 
                          className="flex items-center gap-1 px-4 py-2 rounded-xl bg-green-500 text-white hover:bg-green-600 transition-all font-medium"
                        >
                          <UserCheck className="w-4 h-4" />
                          قبول
                        </button>
                        <button 
                          onClick={() => handleAction(r.id, 'rejected')} 
                          className="flex items-center gap-1 px-4 py-2 rounded-xl bg-red-500 text-white hover:bg-red-600 transition-all font-medium"
                        >
                          <XCircle className="w-4 h-4" />
                          رفض
                        </button>
                      </div>
                    </div>
                  </div>
                ))}
              </div>
            </div>
          )}

          {/* المناديب المفصولين */}
          {terminatedCouriers.length > 0 && (
            <div>
              <h2 className="text-lg font-bold text-gray-500 mb-3 flex items-center gap-2">
                <UserX className="w-5 h-5" />
                المفصولين ({terminatedCouriers.length})
              </h2>
              <div className="space-y-3">
                {terminatedCouriers.map(r => (
                  <div key={r.id} className="bg-gray-50 rounded-2xl shadow p-4 border-r-4 border-gray-400 opacity-75">
                    <div className="flex items-center justify-between">
                      <div className="flex items-center gap-3">
                        <div className="w-12 h-12 rounded-full bg-gray-200 flex items-center justify-center text-2xl">
                          
                        </div>
                        <div>
                          <div className="font-bold text-gray-600">{r.courierName}</div>
                          <div className="text-xs text-gray-500">مفصول</div>
                        </div>
                      </div>
                      <div className="flex gap-2">
                        <button
                          onClick={() => handleReactivate(r)}
                          className="flex items-center gap-1 px-3 py-2 bg-green-100 text-green-600 rounded-xl 
                                     hover:bg-green-200 transition-all text-sm font-medium"
                        >
                          <UserCheck className="w-4 h-4" />
                          إعادة تفعيل
                        </button>
                        <button
                          onClick={() => handleDelete(r)}
                          className="flex items-center gap-1 px-3 py-2 bg-red-100 text-red-600 rounded-xl 
                                     hover:bg-red-200 transition-all text-sm font-medium"
                        >
                          <Trash2 className="w-4 h-4" />
                          حذف
                        </button>
                      </div>
                    </div>
                  </div>
                ))}
              </div>
            </div>
          )}

          {/* الطلبات المرفوضة */}
          {rejectedRequests.length > 0 && (
            <div>
              <h2 className="text-lg font-bold text-red-500 mb-3 flex items-center gap-2">
                <XCircle className="w-5 h-5" />
                مرفوضين ({rejectedRequests.length})
              </h2>
              <div className="space-y-3">
                {rejectedRequests.map(r => (
                  <div key={r.id} className="bg-red-50 rounded-2xl shadow p-4 border-r-4 border-red-400 opacity-75">
                    <div className="flex items-center justify-between">
                      <div className="flex items-center gap-3">
                        <div className="w-12 h-12 rounded-full bg-red-100 flex items-center justify-center text-2xl">
                          
                        </div>
                        <div>
                          <div className="font-bold text-gray-600">{r.courierName}</div>
                          <div className="text-xs text-red-500">مرفوض</div>
                        </div>
                      </div>
                      <button
                        onClick={() => handleDelete(r)}
                        className="flex items-center gap-1 px-3 py-2 bg-red-100 text-red-600 rounded-xl 
                                   hover:bg-red-200 transition-all text-sm font-medium"
                      >
                        <Trash2 className="w-4 h-4" />
                        حذف
                      </button>
                    </div>
                  </div>
                ))}
              </div>
            </div>
          )}
        </>
      )}
    </div>
  )
}

==========================================================================================
FILE: src/pages/CourierTermsPage.tsx
==========================================================================================
// src/pages/CourierTermsPage.tsx
import React from "react";
import { Link } from "react-router-dom";

export default function CourierTermsPage() {
  return (
    <div className="min-h-screen bg-gray-100 text-gray-800 px-4 py-10 leading-relaxed">
      <div className="max-w-3xl mx-auto bg-white shadow-lg rounded-2xl p-6 sm:p-8">
        <h1 className="text-2xl font-bold text-emerald-600 mb-6 text-center">
          الشروط والأحكام - تسجيل المندوب 
        </h1>
        <p className="text-center text-gray-600 mb-8">منصة سفرة البيت</p>

        {/* 1. التعريف */}
        <section className="mb-6">
          <h2 className="text-xl font-semibold text-gray-900 mb-3 border-r-4 border-emerald-500 pr-3">
            1. التعريف
          </h2>
          <p>
            منصة سفرة البيت هي منصة إلكترونية تعمل كوسيط تقني لربط الأسر المنتجة
            والمطاعم بالعملاء والمندوبين عبر التطبيق.
          </p>
        </section>

        {/* 2. طبيعة العلاقة */}
        <section className="mb-6">
          <h2 className="text-xl font-semibold text-gray-900 mb-3 border-r-4 border-emerald-500 pr-3">
            2. طبيعة العلاقة
          </h2>
          <ul className="list-disc list-inside space-y-2 text-gray-700">
            <li>
              يقر المندوب بأن علاقته مع منصة سفرة البيت هي{" "}
              <strong className="text-emerald-600">
                علاقة استخدام منصة تقنية فقط
              </strong>
              .
            </li>
            <li>
              لا تُعد هذه العلاقة:
              <ul className="list-disc list-inside mr-6 mt-2 space-y-1">
                <li>علاقة عمل</li>
                <li>أو توظيف</li>
                <li>أو كفالة</li>
              </ul>
            </li>
            <li>
              يعمل المندوب بصفته{" "}
              <strong className="text-emerald-600">مستقلاً</strong> ويتحمل كامل
              مسؤوليته النظامية.
            </li>
          </ul>
        </section>

        {/* 3. التسجيل */}
        <section className="mb-6">
          <h2 className="text-xl font-semibold text-gray-900 mb-3 border-r-4 border-emerald-500 pr-3">
            3. التسجيل
          </h2>
          <ul className="list-disc list-inside space-y-2 text-gray-700">
            <li>التسجيل في منصة سفرة البيت مجاني.</li>
            <li>لا تلتزم المنصة بتوفير عدد معين من الطلبات للمندوب.</li>
          </ul>
        </section>

        {/* 4. رسوم استخدام المنصة */}
        <section className="mb-6">
          <h2 className="text-xl font-semibold text-gray-900 mb-3 border-r-4 border-emerald-500 pr-3">
            4. رسوم استخدام المنصة
          </h2>
          <ul className="list-disc list-inside space-y-2 text-gray-700">
            <li>
              يوافق المندوب على دفع رسوم استخدام المنصة مقابل كل طلب يتم تنفيذه
              عبر التطبيق.
            </li>
            <li>
              يتم خصم:{" "}
              <strong className="text-emerald-600">2 إلى 3 ريال</strong> عن كل
              طلب
              <br />
              <span className="text-sm text-gray-500 mr-4">
                (يتم تحديدها من قبل المنصة حسب نوع الخدمة أو المنطقة)
              </span>
            </li>
            <li>يتم الخصم تلقائيًا من مستحقات المندوب داخل التطبيق.</li>
          </ul>
        </section>

        {/* 5. مسؤوليات المندوب */}
        <section className="mb-6">
          <h2 className="text-xl font-semibold text-gray-900 mb-3 border-r-4 border-emerald-500 pr-3">
            5. مسؤوليات المندوب
          </h2>
          <p className="mb-3">يتحمل المندوب كامل المسؤولية عن:</p>
          <ul className="list-disc list-inside space-y-2 text-gray-700 mr-4">
            <li>استلام الطلب وتسليمه للعميل</li>
            <li>الالتزام بالوقت المحدد</li>
            <li>حسن التعامل مع الأسرة والعميل</li>
            <li>سلامة الطلب أثناء التوصيل</li>
            <li>الالتزام بالأنظمة المرورية والنظامية المعمول بها</li>
          </ul>
        </section>

        {/* 6. حدود مسؤولية المنصة */}
        <section className="mb-6">
          <h2 className="text-xl font-semibold text-gray-900 mb-3 border-r-4 border-emerald-500 pr-3">
            6. حدود مسؤولية المنصة
          </h2>
          <ul className="list-disc list-inside space-y-2 text-gray-700">
            <li>تعمل منصة سفرة البيت كوسيط تقني فقط.</li>
            <li>
              لا تتحمل المنصة أي مسؤولية عن:
              <ul className="list-disc list-inside mr-6 mt-2 space-y-1">
                <li>تصرفات المندوب</li>
                <li>الحوادث المرورية</li>
                <li>التأخير في التوصيل</li>
                <li>فقدان أو تلف الطلب أثناء التوصيل</li>
                <li>أي مخالفات نظامية أو مرورية</li>
              </ul>
            </li>
            <li>
              يتحمل المندوب وحده أي مطالبات أو أضرار ناتجة عن تنفيذ الطلب.
            </li>
          </ul>
        </section>

        {/* 7. المستحقات المالية */}
        <section className="mb-6">
          <h2 className="text-xl font-semibold text-gray-900 mb-3 border-r-4 border-emerald-500 pr-3">
            7. المستحقات المالية
          </h2>
          <ul className="list-disc list-inside space-y-2 text-gray-700">
            <li>يتم احتساب مستحقات المندوب بناءً على الطلبات المنفذة.</li>
            <li>يحق للمنصة خصم رسوم الاستخدام قبل تحويل المستحقات.</li>
            <li>
              تحتفظ المنصة بحق تعديل آلية الاحتساب أو الرسوم مستقبلًا مع إشعار
              المندوب بذلك.
            </li>
          </ul>
        </section>

        {/* 8. إيقاف الحساب */}
        <section className="mb-6">
          <h2 className="text-xl font-semibold text-gray-900 mb-3 border-r-4 border-emerald-500 pr-3">
            8. إيقاف الحساب
          </h2>
          <ul className="list-disc list-inside space-y-2 text-gray-700">
            <li>
              يحق للمنصة إيقاف أو تعليق حساب المندوب في حال:
              <ul className="list-disc list-inside mr-6 mt-2 space-y-1">
                <li>تكرار الشكاوى</li>
                <li>سوء التعامل</li>
                <li>مخالفة الشروط</li>
                <li>الإضرار بسمعة المنصة</li>
              </ul>
            </li>
            <li>دون تحمل أي التزامات مالية مستقبلية.</li>
          </ul>
        </section>

        {/* 9. التعديل */}
        <section className="mb-6">
          <h2 className="text-xl font-semibold text-gray-900 mb-3 border-r-4 border-emerald-500 pr-3">
            9. التعديل
          </h2>
          <ul className="list-disc list-inside space-y-2 text-gray-700">
            <li>
              يحق للمنصة تعديل هذه الشروط عند الحاجة بما يتوافق مع الأنظمة.
            </li>
            <li>يتم إشعار المندوب بأي تحديثات.</li>
          </ul>
        </section>

        {/* 10. الموافقة */}
        <section className="mb-6">
          <h2 className="text-xl font-semibold text-gray-900 mb-3 border-r-4 border-emerald-500 pr-3">
            10. الموافقة
          </h2>
          <p className="bg-emerald-50 border border-emerald-200 rounded-lg p-4 text-gray-800">
            بالتسجيل كمندوب في منصة سفرة البيت، فإنك تقر بقراءة وفهم والموافقة
            على جميع الشروط والأحكام أعلاه.
          </p>
        </section>

        {/* الموافقة النهائية */}
        <div className="bg-emerald-50 border border-emerald-300 rounded-lg p-4 mt-8 text-center">
          <p className="text-emerald-800 font-medium">
             أوافق على الشروط والأحكام وأتحمل كامل المسؤولية كمندوب مستقل
          </p>
        </div>

        <p className="mt-6 text-sm text-gray-500 text-center">
          تم آخر تحديث لهذه الشروط بتاريخ{" "}
          {new Date().toLocaleDateString("ar-SA")}
        </p>

        <div className="mt-8 flex flex-col sm:flex-row gap-3 justify-center">
          <Link
            to="/register"
            className="text-white bg-emerald-500 hover:bg-emerald-600 px-6 py-3 rounded-lg inline-block transition-colors text-center font-bold"
          >
             موافق - العودة للتسجيل
          </Link>
          <Link
            to="/"
            className="text-emerald-600 bg-emerald-100 hover:bg-emerald-200 px-6 py-3 rounded-lg inline-block transition-colors text-center"
          >
            الرجوع إلى الصفحة الرئيسية
          </Link>
        </div>
      </div>
    </div>
  );
}

==========================================================================================
FILE: src/pages/CustomerLogin.tsx
==========================================================================================
// src/pages/CustomerLogin.tsx
import React, { useState, useEffect, useRef } from 'react'
import { RecaptchaVerifier, signInWithPhoneNumber, ConfirmationResult } from 'firebase/auth'
import { auth, db } from '@/firebase'
import { doc, getDoc, setDoc, updateDoc, serverTimestamp } from 'firebase/firestore'
import { Link, useNavigate } from 'react-router-dom'
import { Phone, KeyRound, LogIn, ArrowRight, RefreshCw } from 'lucide-react'
import { useDialog } from '@/components/ui/ConfirmDialog'

// تنسيق رقم الجوال السعودي
const formatPhoneNumber = (phone: string): string => {
  // إزالة كل شيء غير الأرقام
  let cleaned = phone.replace(/\D/g, '')
  
  // إذا بدأ بـ 0 نزيله
  if (cleaned.startsWith('0')) {
    cleaned = cleaned.substring(1)
  }
  
  // إذا بدأ بـ 966 نتركه، وإلا نضيفه
  if (!cleaned.startsWith('966')) {
    cleaned = '966' + cleaned
  }
  
  return '+' + cleaned
}

export const CustomerLogin: React.FC = () => {
  const [phone, setPhone] = useState('')
  const [otp, setOtp] = useState('')
  const [step, setStep] = useState<'phone' | 'otp'>('phone')
  const [loading, setLoading] = useState(false)
  const [confirmationResult, setConfirmationResult] = useState<ConfirmationResult | null>(null)
  const [countdown, setCountdown] = useState(0)
  const recaptchaRef = useRef<HTMLDivElement>(null)
  const recaptchaVerifierRef = useRef<RecaptchaVerifier | null>(null)
  const nav = useNavigate()
  const dialog = useDialog()

  // تهيئة reCAPTCHA
  useEffect(() => {
    if (recaptchaRef.current && !recaptchaVerifierRef.current) {
      recaptchaVerifierRef.current = new RecaptchaVerifier(auth, recaptchaRef.current, {
        size: 'invisible',
        callback: () => {
          // reCAPTCHA solved
        },
        'expired-callback': () => {
          // reCAPTCHA expired
          recaptchaVerifierRef.current = null
        }
      })
    }

    return () => {
      if (recaptchaVerifierRef.current) {
        recaptchaVerifierRef.current.clear()
        recaptchaVerifierRef.current = null
      }
    }
  }, [])

  // العد التنازلي لإعادة الإرسال
  useEffect(() => {
    if (countdown > 0) {
      const timer = setTimeout(() => setCountdown(countdown - 1), 1000)
      return () => clearTimeout(timer)
    }
  }, [countdown])

  // إرسال رمز التحقق
  const sendOTP = async () => {
    if (!phone || phone.length < 9) {
      dialog.warning('أدخل رقم جوال صحيح')
      return
    }

    const formattedPhone = formatPhoneNumber(phone)

    setLoading(true)
    try {
      // إعادة تهيئة reCAPTCHA إذا لزم الأمر
      if (!recaptchaVerifierRef.current && recaptchaRef.current) {
        recaptchaVerifierRef.current = new RecaptchaVerifier(auth, recaptchaRef.current, {
          size: 'invisible',
        })
      }

      const confirmation = await signInWithPhoneNumber(auth, formattedPhone, recaptchaVerifierRef.current!)
      setConfirmationResult(confirmation)
      setStep('otp')
      setCountdown(60) // 60 ثانية للإعادة
      dialog.success('تم إرسال رمز التحقق إلى جوالك')
    } catch (err: any) {
      console.error('OTP Error:', err)
      
      // إعادة تعيين reCAPTCHA
      if (recaptchaVerifierRef.current) {
        recaptchaVerifierRef.current.clear()
        recaptchaVerifierRef.current = null
      }
      
      if (err.code === 'auth/invalid-phone-number') {
        dialog.error('رقم الجوال غير صحيح')
      } else if (err.code === 'auth/too-many-requests') {
        dialog.error('محاولات كثيرة، حاول لاحقاً')
      } else if (err.code === 'auth/quota-exceeded') {
        dialog.error('تم تجاوز الحد اليومي، حاول غداً')
      } else {
        dialog.error(err.message || 'فشل إرسال الرمز')
      }
    } finally {
      setLoading(false)
    }
  }

  // التحقق من الرمز
  const verifyOTP = async () => {
    if (!otp || otp.length !== 6) {
      dialog.warning('أدخل رمز التحقق المكون من 6 أرقام')
      return
    }

    if (!confirmationResult) {
      dialog.error('حدث خطأ، أعد إرسال الرمز')
      setStep('phone')
      return
    }

    setLoading(true)
    try {
      const userCred = await confirmationResult.confirm(otp)
      const uid = userCred.user.uid
      const userPhone = userCred.user.phoneNumber

      // التحقق من وجود المستخدم
      const userDoc = await getDoc(doc(db, 'users', uid))
      
      let isNewUser = false
      if (!userDoc.exists()) {
        isNewUser = true
        // إنشاء حساب جديد للعميل
        await setDoc(doc(db, 'users', uid), {
          phone: userPhone,
          role: 'customer',
          name: '',
          createdAt: serverTimestamp(),
        })
        dialog.success('تم إنشاء حسابك بنجاح! ')
      } else {
        dialog.success('أهلاً بعودتك! ')
      }

      //  تحديد الموقع تلقائياً وحفظه
      const userData = userDoc.exists() ? userDoc.data() : { role: 'customer' }
      const hasLocation = userData?.savedLocation || userData?.location
      
      // إذا لم يكن عنده موقع محفوظ، نحاول تحديده تلقائياً
      if (!hasLocation && (userData.role === 'customer' || isNewUser)) {
        try {
          if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(
              async (pos) => {
                const autoLocation = {
                  lat: pos.coords.latitude,
                  lng: pos.coords.longitude,
                  address: 'موقعي الحالي'
                }
                // حفظ الموقع في الحساب
                await updateDoc(doc(db, 'users', uid), {
                  savedLocation: autoLocation,
                  location: { lat: autoLocation.lat, lng: autoLocation.lng }
                })
                // حفظ في sessionStorage
                sessionStorage.setItem('broast_session_location', JSON.stringify({ lat: autoLocation.lat, lng: autoLocation.lng }))
              },
              (err) => {
                console.warn('تعذر تحديد الموقع تلقائياً:', err)
              },
              { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 }
            )
          }
        } catch (locErr) {
          console.warn('خطأ في تحديد الموقع:', locErr)
        }
      }

      // التوجيه حسب الدور
      if (userData.role === 'owner') {
        nav('/owner')
      } else if (userData.role === 'admin') {
        nav('/admin')
      } else if (userData.role === 'developer') {
        nav('/developer')
      } else if (userData.role === 'courier') {
        nav('/courier')
      } else {
        nav('/')
      }
    } catch (err: any) {
      console.error('Verify Error:', err)
      if (err.code === 'auth/invalid-verification-code') {
        dialog.error('رمز التحقق غير صحيح')
      } else if (err.code === 'auth/code-expired') {
        dialog.error('انتهت صلاحية الرمز، أعد الإرسال')
        setStep('phone')
      } else {
        dialog.error(err.message || 'فشل التحقق')
      }
    } finally {
      setLoading(false)
    }
  }

  // إعادة إرسال الرمز
  const resendOTP = () => {
    if (countdown > 0) return
    setStep('phone')
    setOtp('')
    setConfirmationResult(null)
  }

  return (
    <div className="min-h-screen flex items-center justify-center bg-gradient-to-br from-sky-50 via-white to-sky-100 px-4">
      {/* خلفية زخرفية */}
      <div className="absolute top-0 left-0 w-72 h-72 bg-sky-300/20 rounded-full blur-3xl"></div>
      <div className="absolute bottom-0 right-0 w-72 h-72 bg-sky-400/20 rounded-full blur-3xl"></div>
      
      {/* reCAPTCHA Container */}
      <div ref={recaptchaRef} id="recaptcha-container"></div>
      
      <div className="relative bg-white/80 backdrop-blur-xl border border-sky-100 rounded-[2rem] shadow-2xl shadow-sky-200/50 w-full max-w-md p-8">
        
        {/* شعار */}
        <div className="flex flex-col items-center mb-8">
          <div className="w-20 h-20 bg-gradient-to-br from-sky-500 to-sky-600 rounded-2xl flex items-center justify-center shadow-xl shadow-sky-300/50 mb-4">
            <span className="text-4xl"></span>
          </div>
          <h1 className="text-3xl font-black text-sky-600">سفرة البيت</h1>
          <p className="text-sky-500 mt-1">
            {step === 'phone' ? 'تسجيل الدخول' : 'أدخل رمز التحقق'}
          </p>
        </div>

        {/* خطوة إدخال رقم الجوال */}
        {step === 'phone' && (
          <div className="space-y-4">
            <div className="relative">
              <Phone className="absolute right-4 top-1/2 -translate-y-1/2 w-5 h-5 text-sky-400" />
              <input
                type="tel"
                placeholder="05xxxxxxxx"
                dir="ltr"
                className="w-full rounded-2xl p-4 pr-12 bg-sky-50 text-sky-900 border-2 border-sky-100 
                           focus:outline-none focus:border-sky-400 focus:ring-4 focus:ring-sky-100 transition-all text-center text-lg tracking-wider"
                value={phone}
                onChange={(e) => setPhone(e.target.value.replace(/\D/g, ''))}
                maxLength={10}
              />
            </div>

            <p className="text-sm text-gray-500 text-center">
              سنرسل لك رمز تحقق عبر SMS
            </p>

            <button
              onClick={sendOTP}
              disabled={loading || phone.length < 9}
              className="w-full flex items-center justify-center gap-3 bg-gradient-to-r from-sky-500 to-sky-600 hover:from-sky-600 hover:to-sky-700 text-white font-bold p-4 rounded-2xl 
                         shadow-xl shadow-sky-300/50 transition-all hover:scale-[1.02] hover:shadow-sky-400/50 disabled:opacity-50 disabled:hover:scale-100"
            >
              {loading ? (
                <>
                  <RefreshCw className="w-5 h-5 animate-spin" />
                  جاري الإرسال...
                </>
              ) : (
                <>
                  <ArrowRight className="w-5 h-5" />
                  إرسال رمز التحقق
                </>
              )}
            </button>
          </div>
        )}

        {/* خطوة إدخال رمز التحقق */}
        {step === 'otp' && (
          <div className="space-y-4">
            <div className="text-center mb-4">
              <p className="text-gray-600">أرسلنا رمز التحقق إلى</p>
              <p className="font-bold text-sky-600 text-lg" dir="ltr">{formatPhoneNumber(phone)}</p>
            </div>

            <div className="relative">
              <KeyRound className="absolute right-4 top-1/2 -translate-y-1/2 w-5 h-5 text-sky-400" />
              <input
                type="text"
                inputMode="numeric"
                placeholder="000000"
                dir="ltr"
                className="w-full rounded-2xl p-4 pr-12 bg-sky-50 text-sky-900 border-2 border-sky-100 
                           focus:outline-none focus:border-sky-400 focus:ring-4 focus:ring-sky-100 transition-all text-center text-2xl tracking-[0.5em] font-bold"
                value={otp}
                onChange={(e) => setOtp(e.target.value.replace(/\D/g, ''))}
                maxLength={6}
                autoFocus
              />
            </div>

            <button
              onClick={verifyOTP}
              disabled={loading || otp.length !== 6}
              className="w-full flex items-center justify-center gap-3 bg-gradient-to-r from-green-500 to-green-600 hover:from-green-600 hover:to-green-700 text-white font-bold p-4 rounded-2xl 
                         shadow-xl shadow-green-300/50 transition-all hover:scale-[1.02] hover:shadow-green-400/50 disabled:opacity-50 disabled:hover:scale-100"
            >
              {loading ? (
                <>
                  <RefreshCw className="w-5 h-5 animate-spin" />
                  جاري التحقق...
                </>
              ) : (
                <>
                  <LogIn className="w-5 h-5" />
                  تأكيد ودخول
                </>
              )}
            </button>

            {/* إعادة إرسال الرمز */}
            <div className="text-center">
              {countdown > 0 ? (
                <p className="text-gray-500 text-sm">
                  إعادة الإرسال بعد <span className="font-bold text-sky-600">{countdown}</span> ثانية
                </p>
              ) : (
                <button
                  onClick={resendOTP}
                  className="text-sky-600 hover:text-sky-700 font-semibold text-sm"
                >
                  لم يصلك الرمز؟ أعد الإرسال
                </button>
              )}
            </div>

            {/* تغيير الرقم */}
            <button
              onClick={() => { setStep('phone'); setOtp(''); }}
              className="w-full text-gray-500 hover:text-gray-700 text-sm"
            >
              ← تغيير رقم الجوال
            </button>
          </div>
        )}

        {/* رابط للأدوار الأخرى */}
        <div className="mt-8 pt-6 border-t border-sky-100">
          <p className="text-center text-sm text-gray-500 mb-3">
            صاحب مطعم أو مندوب؟
          </p>
          <Link 
            to="/login"
            className="block text-center text-sky-600 hover:text-sky-700 font-semibold"
          >
            تسجيل دخول بالإيميل →
          </Link>
        </div>
      </div>
    </div>
  )
}

==========================================================================================
FILE: src/pages/DebugOrders.tsx
==========================================================================================
// src/pages/DebugOrders.tsx
import React, { useEffect, useState } from "react"
import { collection, getDocs, limit, orderBy, query } from "firebase/firestore"
import { db, app } from "@/firebase"
import { useAuth } from "@/auth"
import { Navigate } from "react-router-dom"

export const DebugOrders: React.FC = () => {
  const { role, loading: authLoading } = useAuth()
  const [rows, setRows] = useState<any[]>([])
  const [loading, setLoading] = useState(true)
  const [error, setError] = useState<string | null>(null)

  useEffect(() => {
    // لا نجلب البيانات إلا إذا كان المستخدم مطور
    if (authLoading || role !== 'developer') return
    
    (async () => {
      try {
        setError(null)
        // نجيب أي 10 طلبات بدون فلترة على الهوية — ما يحتاج فهارس
        const qy = query(
          collection(db, "orders"),
          orderBy("createdAt", "desc"),
          limit(10)
        )
        const snap = await getDocs(qy)
        const list = snap.docs.map(d => {
          const x: any = d.data()
          return {
            id: d.id,
            restaurantId: x.restaurantId ?? null,
            firstItemOwnerId: x?.items?.[0]?.ownerId ?? null,
            customerId: x.customerId ?? null,
            createdAtISO: x.createdAt?.toDate?.()?.toISOString?.() ?? null,
          }
        })
        setRows(list)
      } catch (e: any) {
        // لو ما فيه فهرس، جرّب بدون orderBy
        if (String(e?.message || "").includes("index")) {
          try {
            const snap = await getDocs(collection(db, "orders"))
            const list = snap.docs.map(d => {
              const x: any = d.data()
              return {
                id: d.id,
                restaurantId: x.restaurantId ?? null,
                firstItemOwnerId: x?.items?.[0]?.ownerId ?? null,
                customerId: x.customerId ?? null,
                createdAtISO: x.createdAt?.toDate?.()?.toISOString?.() ?? null,
              }
            })
            setRows(list)
            setError(" ما فيه فهرس لـ createdAt — عرضنا البيانات بدون ترتيب.")
          } catch (e2: any) {
            setError(" فشل الجلب حتى بدون ترتيب: " + (e2?.message || e2))
          }
        } else {
          setError(" خطأ الجلب: " + (e?.message || e))
        }
      } finally {
        setLoading(false)
      }
    })()
  }, [authLoading, role])

  // حماية الصفحة: فقط للمطور
  if (authLoading) {
    return <div className="p-8 text-center">جارِ التحميل...</div>
  }
  
  if (role !== 'developer') {
    return <Navigate to="/" replace />
  }

  const projectId = (app.options as any)?.projectId

  return (
    <div className="p-4 space-y-3">
      <h1 className="text-xl font-bold"> DEBUG: Orders Snapshot (للمطور فقط)</h1>
      <div className="text-sm">
        ProjectId: <b>{String(projectId)}</b>
      </div>
      {error && <div className="text-red-600 text-sm">{error}</div>}
      {loading && <div> Loading…</div>}

      {!loading && rows.length === 0 && (
        <div className="text-gray-600">لا توجد أي مستندات في collection: <code>orders</code> في هذا المشروع.</div>
      )}

      {rows.map(r => (
        <div key={r.id} className="bg-white rounded-xl shadow p-3 text-sm">
          <div className="font-mono text-xs text-gray-500">#{r.id}</div>
          <div>restaurantId: <b>{String(r.restaurantId)}</b></div>
          <div>items[0].ownerId: <b>{String(r.firstItemOwnerId)}</b></div>
          <div>customerId: <b>{String(r.customerId)}</b></div>
          <div>createdAt: <b>{r.createdAtISO || "—"}</b></div>
        </div>
      ))}
    </div>
  )
}

==========================================================================================
FILE: src/pages/Developer.tsx
==========================================================================================
import React, { useEffect, useState } from 'react'
import { useAuth } from '@/auth'
import { RoleGate } from '@/routes/RoleGate'
import { 
  Trash2, Users, Settings, RefreshCw, Database, Shield, Server, 
  Edit3, Save, X, ChevronDown, ChevronUp, Building2, Wallet, Package, Truck, UserPlus, Plus,
  FileCheck, AlertCircle, CheckCircle, Clock, ExternalLink
} from 'lucide-react'
import { useToast } from '@/components/ui/Toast'
import { useDialog } from '@/components/ui/ConfirmDialog'
import { db, app, auth } from '@/firebase'
import { createUserWithEmailAndPassword, signInWithEmailAndPassword } from 'firebase/auth'
import { 
  collection, getDocs, doc, getDoc, setDoc, updateDoc, deleteDoc, 
  serverTimestamp, addDoc, query, where, orderBy, limit 
} from 'firebase/firestore'
import { ref, uploadBytes, getDownloadURL, getStorage } from 'firebase/storage'

// Firebase config للعرض
const firebaseConfig = {
  projectId: app.options.projectId,
  authDomain: app.options.authDomain,
  storageBucket: app.options.storageBucket,
  messagingSenderId: app.options.messagingSenderId,
  appId: app.options.appId,
}

type Stats = {
  users: number
  restaurants: number
  menuItems: number
  orders: number
  pendingOrders: number
  deliveredOrders: number
  admins: number
  couriers: number
  customers: number
  owners: number
  totalAppEarnings: number
}

type AppSettings = {
  deliveryFee?: number
  minOrderAmount?: number
  maxDeliveryDistance?: number
  workingHours?: { open: string; close: string }
  maintenanceMode?: boolean
  appVersion?: string
  platformFee?: number
  adminCommissionRate?: number
}

type User = {
  uid: string
  email: string
  name?: string
  role: string
  phone?: string
  createdAt?: any
}

type Restaurant = {
  id: string
  name: string
  ownerId: string
  email?: string
  phone?: string
  city?: string
  location?: string
  logoUrl?: string
  referredBy?: string
  referrerType?: string
  isVerified?: boolean
  verifiedAt?: any
  createdAt?: any
}

type Order = {
  id: string
  customerId: string
  restaurantId?: string
  restaurantName?: string
  items: any[]
  subtotal: number
  deliveryFee: number
  total: number
  status: string
  address: string
  courierId?: string
  platformFee?: number
  adminCommission?: number
  referredBy?: string
  createdAt?: any
}

type Admin = {
  uid: string
  email: string
  name?: string
  walletBalance: number
  totalEarnings: number
  restaurantsCount: number
  restaurants: Restaurant[]
}

// نوع المهمة
type Task = {
  id: string
  title: string
  description: string
  assignedTo: string // UID المشرف
  assignedToName?: string
  status: 'pending' | 'in_progress' | 'completed' | 'cancelled'
  priority: 'low' | 'medium' | 'high'
  dueDate?: any
  createdBy: string
  createdAt?: any
  updatedAt?: any
  completedAt?: any
  notes?: string
}

// نوع سجل العمليات
type ActivityLog = {
  id: string
  action: 'activate' | 'deactivate' | 'delete' | 'update' | 'create' | 'package_activate' | 'package_cancel' | 'role_change'
  targetType: 'user' | 'restaurant' | 'order' | 'package' | 'settings'
  targetId: string
  targetName?: string
  performedBy: string
  performedByName?: string
  details?: string
  oldValue?: any
  newValue?: any
  createdAt?: any
}

// تبويبات اللوحة
type Tab = 'overview' | 'restaurants' | 'orders' | 'users' | 'couriers' | 'admins' | 'settings' | 'finance' | 'tools' | 'tasks' | 'licenses' | 'packages' | 'storeAnalytics' | 'packageSettings' | 'activityLog'

// نوع طلب الباقة
type PackageRequest = {
  id: string
  restaurantId: string
  restaurantName: string
  ownerName?: string
  ownerPhone?: string
  status: 'pending' | 'bank_sent' | 'payment_sent' | 'approved' | 'rejected' | 'expired'
  bankAccountImageUrl?: string
  paymentProofImageUrl?: string
  subscriptionAmount: number
  subscriptionDuration: number
  developerNotes?: string
  ownerNotes?: string
  requestedAt?: any
  bankSentAt?: any
  paymentSentAt?: any
  approvedAt?: any
  rejectedAt?: any
  expiresAt?: any
  createdAt?: any
  updatedAt?: any
}


export const Developer: React.FC = () => {
  const { user } = useAuth()
  const toast = useToast()
  const dialog = useDialog()
  const storage = getStorage(app)
  
  const [activeTab, setActiveTab] = useState<Tab>('overview')
  const [loading, setLoading] = useState(true)
  const [refreshing, setRefreshing] = useState(false)
  
  // البيانات
  const [stats, setStats] = useState<Stats>({
    users: 0, restaurants: 0, menuItems: 0, orders: 0, 
    pendingOrders: 0, deliveredOrders: 0, admins: 0, couriers: 0, 
    customers: 0, owners: 0, totalAppEarnings: 0
  })
  const [settings, setSettings] = useState<AppSettings>({})
  const [users, setUsers] = useState<User[]>([])
  const [restaurants, setRestaurants] = useState<Restaurant[]>([])
  const [orders, setOrders] = useState<Order[]>([])
  const [admins, setAdmins] = useState<Admin[]>([])
  
  // حالات التحرير
  const [editingSettings, setEditingSettings] = useState(false)
  const [settingsForm, setSettingsForm] = useState<AppSettings>({})
  const [editingRestaurant, setEditingRestaurant] = useState<string | null>(null)
  const [restaurantForm, setRestaurantForm] = useState<Partial<Restaurant>>({})
  const [uploadingLogo, setUploadingLogo] = useState(false)
  const [editingUser, setEditingUser] = useState<string | null>(null)
  const [userForm, setUserForm] = useState<Partial<User>>({})
  
  // فلاتر
  const [orderFilter, setOrderFilter] = useState<string>('all')
  const [userFilter, setUserFilter] = useState<string>('all')
  const [expandedAdmin, setExpandedAdmin] = useState<string | null>(null)
  
  // إضافة مشرف جديد
  const [showAddAdmin, setShowAddAdmin] = useState(false)
  const [newAdminEmail, setNewAdminEmail] = useState('')
  const [newAdminName, setNewAdminName] = useState('')
  const [newAdminPassword, setNewAdminPassword] = useState('')
  const [newAdminPhone, setNewAdminPhone] = useState('')
  const [creatingAdmin, setCreatingAdmin] = useState(false)

  // إضافة مندوب جديد
  const [showAddCourier, setShowAddCourier] = useState(false)
  const [newCourierEmail, setNewCourierEmail] = useState('')
  const [newCourierName, setNewCourierName] = useState('')
  const [newCourierPassword, setNewCourierPassword] = useState('')
  const [newCourierPhone, setNewCourierPhone] = useState('')
  const [creatingCourier, setCreatingCourier] = useState(false)

  // إضافة مطعم جديد
  const [showAddRestaurant, setShowAddRestaurant] = useState(false)
  const [newRestaurantName, setNewRestaurantName] = useState('')
  const [newRestaurantCity, setNewRestaurantCity] = useState('')
  const [newRestaurantPhone, setNewRestaurantPhone] = useState('')
  const [newRestaurantEmail, setNewRestaurantEmail] = useState('')
  const [newRestaurantOwnerEmail, setNewRestaurantOwnerEmail] = useState('')
  const [newRestaurantOwnerPassword, setNewRestaurantOwnerPassword] = useState('')
  const [creatingRestaurant, setCreatingRestaurant] = useState(false)

  // المهام
  const [tasks, setTasks] = useState<Task[]>([])
  const [showAddTask, setShowAddTask] = useState(false)
  const [newTaskTitle, setNewTaskTitle] = useState('')
  const [newTaskDescription, setNewTaskDescription] = useState('')
  const [newTaskAssignedTo, setNewTaskAssignedTo] = useState('')
  const [newTaskPriority, setNewTaskPriority] = useState<'low' | 'medium' | 'high'>('medium')
  const [newTaskDueDate, setNewTaskDueDate] = useState('')
  const [creatingTask, setCreatingTask] = useState(false)
  const [taskFilter, setTaskFilter] = useState<string>('all')

  // طلبات الباقات
  const [packageRequests, setPackageRequests] = useState<PackageRequest[]>([])
  const [packageFilter, setPackageFilter] = useState<string>('all')
  const [uploadingBankImage, setUploadingBankImage] = useState<string | null>(null)
  const [bankImageFile, setBankImageFile] = useState<File | null>(null)
  const [subscriptionAmount, setSubscriptionAmount] = useState<number>(99)
  const [subscriptionDuration, setSubscriptionDuration] = useState<number>(30)
  
  // سجل العمليات
  const [activityLogs, setActivityLogs] = useState<ActivityLog[]>([])
  const [loadingLogs, setLoadingLogs] = useState(false)
  const [logFilter, setLogFilter] = useState<string>('all')
  
  // حفظ بيانات المطور الحالي لإعادة تسجيل الدخول
  const currentDeveloperEmail = user?.email || ''

  // ===== تسجيل عملية في السجل =====
  const logActivity = async (
    action: ActivityLog['action'],
    targetType: ActivityLog['targetType'],
    targetId: string,
    targetName: string,
    details?: string,
    oldValue?: any,
    newValue?: any
  ) => {
    try {
      await addDoc(collection(db, 'activityLogs'), {
        action,
        targetType,
        targetId,
        targetName,
        performedBy: user?.uid || '',
        performedByName: user?.email || 'مطور',
        details,
        oldValue,
        newValue,
        createdAt: serverTimestamp(),
      })
    } catch (err) {
      console.warn('فشل تسجيل العملية:', err)
    }
  }

  // ===== تفعيل/إيقاف حساب =====
  const handleToggleUserStatus = async (targetUser: User, isActive: boolean) => {
    const action = isActive ? 'تعليق' : 'تفعيل'
    const confirmed = await dialog.confirm(
      `هل أنت متأكد من ${action} حساب "${targetUser.name || targetUser.email}"؟`,
      { title: `${action} الحساب`, dangerous: !isActive }
    )
    if (!confirmed) return

    try {
      await updateDoc(doc(db, 'users', targetUser.uid), {
        isActive: !isActive,
        updatedAt: serverTimestamp(),
      })
      
      await logActivity(
        isActive ? 'deactivate' : 'activate',
        'user',
        targetUser.uid,
        targetUser.name || targetUser.email,
        `تم ${action} الحساب`
      )
      
      toast.success(`تم ${action} الحساب بنجاح `)
      loadData()
    } catch (err) {
      console.error('خطأ:', err)
      toast.error(`فشل ${action} الحساب`)
    }
  }

  // ===== تفعيل باقة التميز يدوياً =====
  const handleActivatePremium = async (restaurant: Restaurant, days: number = 30) => {
    const confirmed = await dialog.confirm(
      `سيتم تفعيل باقة التميز لـ "${restaurant.name}" لمدة ${days} يوم`,
      { title: ' تفعيل باقة التميز' }
    )
    if (!confirmed) return

    try {
      const expiresAt = new Date()
      expiresAt.setDate(expiresAt.getDate() + days)

      await updateDoc(doc(db, 'restaurants', restaurant.id), {
        packageType: 'premium',
        packageSubscribedAt: serverTimestamp(),
        packageExpiresAt: expiresAt,
        packageRequest: null,
        updatedAt: serverTimestamp(),
      })

      await logActivity(
        'package_activate',
        'restaurant',
        restaurant.id,
        restaurant.name,
        `تفعيل باقة التميز لمدة ${days} يوم`
      )

      toast.success(`تم تفعيل باقة التميز لـ ${restaurant.name} `)
      loadData()
    } catch (err) {
      console.error('خطأ:', err)
      toast.error('فشل تفعيل الباقة')
    }
  }

  // ===== إلغاء باقة التميز =====
  const handleCancelPremium = async (restaurant: Restaurant) => {
    const confirmed = await dialog.confirm(
      `هل أنت متأكد من إلغاء باقة التميز لـ "${restaurant.name}"؟`,
      { title: ' إلغاء باقة التميز', dangerous: true }
    )
    if (!confirmed) return

    try {
      await updateDoc(doc(db, 'restaurants', restaurant.id), {
        packageType: 'free',
        packageExpiresAt: null,
        updatedAt: serverTimestamp(),
      })

      await logActivity(
        'package_cancel',
        'restaurant',
        restaurant.id,
        restaurant.name,
        'إلغاء باقة التميز'
      )

      toast.success(`تم إلغاء باقة التميز لـ ${restaurant.name}`)
      loadData()
    } catch (err) {
      console.error('خطأ:', err)
      toast.error('فشل إلغاء الباقة')
    }
  }

  // ===== تحميل سجل العمليات =====
  const loadActivityLogs = async () => {
    setLoadingLogs(true)
    try {
      const q = query(
        collection(db, 'activityLogs'),
        orderBy('createdAt', 'desc'),
        limit(100)
      )
      const snap = await getDocs(q)
      const logs = snap.docs.map(d => ({
        id: d.id,
        ...d.data(),
        createdAt: d.data().createdAt?.toDate?.() || null,
      })) as ActivityLog[]
      setActivityLogs(logs)
    } catch (err) {
      console.warn('فشل تحميل سجل العمليات:', err)
    } finally {
      setLoadingLogs(false)
    }
  }

  // ===== إنشاء مشرف جديد =====
  const handleCreateNewAdmin = async () => {
    if (!newAdminEmail.trim() || !newAdminPassword.trim()) {
      toast.warning('أدخل البريد الإلكتروني وكلمة المرور')
      return
    }
    if (newAdminPassword.length < 6) {
      toast.warning('كلمة المرور يجب أن تكون 6 أحرف على الأقل')
      return
    }

    const confirmed = await dialog.confirm(
      `سيتم إنشاء حساب مشرف جديد:\n\n ${newAdminEmail}\n ${newAdminName || 'بدون اسم'}\n\nملاحظة: سيتم تسجيل خروجك مؤقتاً، قم بتسجيل الدخول مرة أخرى.`,
      { title: 'إنشاء مشرف جديد' }
    )
    if (!confirmed) return

    setCreatingAdmin(true)
    try {
      // إنشاء المستخدم الجديد في Firebase Auth
      const userCred = await createUserWithEmailAndPassword(auth, newAdminEmail.trim(), newAdminPassword)
      const newUid = userCred.user.uid

      // إنشاء مستند المستخدم في Firestore
      await setDoc(doc(db, 'users', newUid), {
        email: newAdminEmail.trim(),
        name: newAdminName.trim() || 'مشرف جديد',
        phone: newAdminPhone.trim() || '',
        role: 'admin',
        createdAt: serverTimestamp(),
      })

      // إنشاء محفظة للمشرف الجديد
      await setDoc(doc(db, 'wallets', newUid), {
        balance: 0,
        totalEarnings: 0,
        totalWithdrawn: 0,
        transactions: [],
        updatedAt: serverTimestamp(),
      })

      toast.success('تم إنشاء حساب المشرف بنجاح ')
      toast.info(' تم تسجيل خروجك، يرجى تسجيل الدخول مرة أخرى')
      
      // إعادة تعيين النموذج
      setNewAdminEmail('')
      setNewAdminName('')
      setNewAdminPassword('')
      setNewAdminPhone('')
      setShowAddAdmin(false)
      
    } catch (err: any) {
      console.error('خطأ في إنشاء المشرف:', err)
      if (err.code === 'auth/email-already-in-use') {
        toast.error('البريد الإلكتروني مستخدم مسبقاً')
      } else if (err.code === 'auth/invalid-email') {
        toast.error('البريد الإلكتروني غير صالح')
      } else if (err.code === 'auth/weak-password') {
        toast.error('كلمة المرور ضعيفة جداً')
      } else {
        toast.error('فشل إنشاء المشرف: ' + (err.message || 'خطأ غير معروف'))
      }
    } finally {
      setCreatingAdmin(false)
    }
  }

  // ===== إنشاء مندوب جديد =====
  const handleCreateNewCourier = async () => {
    if (!newCourierEmail.trim() || !newCourierPassword.trim()) {
      toast.warning('أدخل البريد الإلكتروني وكلمة المرور')
      return
    }
    if (newCourierPassword.length < 6) {
      toast.warning('كلمة المرور يجب أن تكون 6 أحرف على الأقل')
      return
    }

    const confirmed = await dialog.confirm(
      `سيتم إنشاء حساب مندوب جديد:\n\n ${newCourierEmail}\n ${newCourierName || 'بدون اسم'}\n ${newCourierPhone || 'بدون رقم'}`,
      { title: 'إنشاء مندوب جديد' }
    )
    if (!confirmed) return

    setCreatingCourier(true)
    try {
      const userCred = await createUserWithEmailAndPassword(auth, newCourierEmail.trim(), newCourierPassword)
      const newUid = userCred.user.uid

      await setDoc(doc(db, 'users', newUid), {
        email: newCourierEmail.trim(),
        name: newCourierName.trim() || 'مندوب جديد',
        phone: newCourierPhone.trim() || '',
        role: 'courier',
        createdAt: serverTimestamp(),
      })

      toast.success('تم إنشاء حساب المندوب بنجاح ')
      toast.info(' تم تسجيل خروجك، يرجى تسجيل الدخول مرة أخرى')
      
      setNewCourierEmail('')
      setNewCourierName('')
      setNewCourierPassword('')
      setNewCourierPhone('')
      setShowAddCourier(false)
      
    } catch (err: any) {
      console.error('خطأ في إنشاء المندوب:', err)
      if (err.code === 'auth/email-already-in-use') {
        toast.error('البريد الإلكتروني مستخدم مسبقاً')
      } else {
        toast.error('فشل إنشاء المندوب: ' + (err.message || 'خطأ غير معروف'))
      }
    } finally {
      setCreatingCourier(false)
    }
  }

  // ===== إنشاء مطعم جديد =====
  const handleCreateNewRestaurant = async () => {
    if (!newRestaurantName.trim()) {
      toast.warning('أدخل اسم المطعم')
      return
    }
    if (!newRestaurantOwnerEmail.trim() || !newRestaurantOwnerPassword.trim()) {
      toast.warning('أدخل بيانات صاحب المطعم')
      return
    }

    const confirmed = await dialog.confirm(
      `سيتم إنشاء مطعم جديد:\n\n ${newRestaurantName}\n ${newRestaurantCity || 'بدون مدينة'}\n صاحب المطعم: ${newRestaurantOwnerEmail}`,
      { title: 'إنشاء مطعم جديد' }
    )
    if (!confirmed) return

    setCreatingRestaurant(true)
    try {
      // إنشاء حساب صاحب المطعم
      const userCred = await createUserWithEmailAndPassword(auth, newRestaurantOwnerEmail.trim(), newRestaurantOwnerPassword)
      const newOwnerId = userCred.user.uid

      // إنشاء مستند صاحب المطعم
      await setDoc(doc(db, 'users', newOwnerId), {
        email: newRestaurantOwnerEmail.trim(),
        name: newRestaurantName.trim() + ' - مالك',
        role: 'owner',
        createdAt: serverTimestamp(),
      })

      // إنشاء مستند المطعم
      await setDoc(doc(db, 'restaurants', newOwnerId), {
        name: newRestaurantName.trim(),
        ownerId: newOwnerId,
        email: newRestaurantEmail.trim() || newRestaurantOwnerEmail.trim(),
        phone: newRestaurantPhone.trim() || '',
        city: newRestaurantCity.trim() || '',
        referredBy: user?.uid, // المطور هو من أضاف المطعم
        referrerType: 'developer',
        createdAt: serverTimestamp(),
      })

      toast.success('تم إنشاء المطعم وحساب المالك بنجاح ')
      toast.info(' تم تسجيل خروجك، يرجى تسجيل الدخول مرة أخرى')
      
      setNewRestaurantName('')
      setNewRestaurantCity('')
      setNewRestaurantPhone('')
      setNewRestaurantEmail('')
      setNewRestaurantOwnerEmail('')
      setNewRestaurantOwnerPassword('')
      setShowAddRestaurant(false)
      
    } catch (err: any) {
      console.error('خطأ في إنشاء المطعم:', err)
      if (err.code === 'auth/email-already-in-use') {
        toast.error('البريد الإلكتروني مستخدم مسبقاً')
      } else {
        toast.error('فشل إنشاء المطعم: ' + (err.message || 'خطأ غير معروف'))
      }
    } finally {
      setCreatingRestaurant(false)
    }
  }

  // ===== حساب الإحصائيات المالية =====
  const getFinanceStats = () => {
    const now = new Date()
    const today = new Date(now.getFullYear(), now.getMonth(), now.getDate())
    const weekAgo = new Date(today.getTime() - 7 * 24 * 60 * 60 * 1000)
    const monthAgo = new Date(today.getTime() - 30 * 24 * 60 * 60 * 1000)

    const todayOrders = orders.filter(o => {
      const orderDate = o.createdAt?.toDate?.() || new Date(0)
      return orderDate >= today && o.status !== 'cancelled'
    })

    const weekOrders = orders.filter(o => {
      const orderDate = o.createdAt?.toDate?.() || new Date(0)
      return orderDate >= weekAgo && o.status !== 'cancelled'
    })

    const monthOrders = orders.filter(o => {
      const orderDate = o.createdAt?.toDate?.() || new Date(0)
      return orderDate >= monthAgo && o.status !== 'cancelled'
    })

    const deliveredOrders = orders.filter(o => o.status === 'delivered')

    return {
      todayRevenue: todayOrders.reduce((sum, o) => sum + (o.total || 0), 0),
      todayOrders: todayOrders.length,
      todayPlatformFee: todayOrders.reduce((sum, o) => sum + (o.platformFee || 0), 0),
      weekRevenue: weekOrders.reduce((sum, o) => sum + (o.total || 0), 0),
      weekOrders: weekOrders.length,
      weekPlatformFee: weekOrders.reduce((sum, o) => sum + (o.platformFee || 0), 0),
      monthRevenue: monthOrders.reduce((sum, o) => sum + (o.total || 0), 0),
      monthOrders: monthOrders.length,
      monthPlatformFee: monthOrders.reduce((sum, o) => sum + (o.platformFee || 0), 0),
      totalRevenue: deliveredOrders.reduce((sum, o) => sum + (o.total || 0), 0),
      totalPlatformFee: deliveredOrders.reduce((sum, o) => sum + (o.platformFee || 0), 0),
      totalAdminCommission: deliveredOrders.reduce((sum, o) => sum + (o.adminCommission || 0), 0),
    }
  }

  // ===== تحميل البيانات =====
  const loadData = async () => {
    try {
      // جلب جميع البيانات بالتوازي
      const [usersSnap, restaurantsSnap, menuSnap, ordersSnap, walletsSnap] = await Promise.all([
        getDocs(collection(db, 'users')),
        getDocs(collection(db, 'restaurants')),
        getDocs(collection(db, 'menuItems')),
        getDocs(collection(db, 'orders')),
        getDocs(collection(db, 'wallets')),
      ])

      // جلب المهام بشكل منفصل (قد لا تكون موجودة)
      let tasksSnap: any = { docs: [] }
      try {
        tasksSnap = await getDocs(collection(db, 'tasks'))
      } catch (err) {
        // لا توجد مهام بعد
      }

      // جلب طلبات الباقات
      let packageRequestsSnap: any = { docs: [] }
      try {
        packageRequestsSnap = await getDocs(collection(db, 'packageRequests'))
      } catch (err) {
        // لا توجد طلبات باقات بعد
      }

      // المستخدمين
      const usersData = usersSnap.docs.map(d => ({ uid: d.id, ...d.data() } as User))
      setUsers(usersData)
      
      // المطاعم
      const restaurantsData = restaurantsSnap.docs.map(d => ({ id: d.id, ...d.data() } as Restaurant))
      setRestaurants(restaurantsData)
      
      // الطلبات
      const ordersData = ordersSnap.docs.map(d => ({ id: d.id, ...d.data() } as Order))
      setOrders(ordersData)

      // المهام
      const tasksData: Task[] = tasksSnap.docs.map((d: any) => ({ id: d.id, ...d.data() } as Task))
      setTasks(tasksData.sort((a: Task, b: Task) => (b.createdAt?.seconds || 0) - (a.createdAt?.seconds || 0)))

      // طلبات الباقات
      const packageRequestsData: PackageRequest[] = packageRequestsSnap.docs.map((d: any) => ({ id: d.id, ...d.data() } as PackageRequest))
      setPackageRequests(packageRequestsData.sort((a: PackageRequest, b: PackageRequest) => (b.createdAt?.seconds || 0) - (a.createdAt?.seconds || 0)))
      
      // المحافظ
      const walletsData: Record<string, any> = {}
      walletsSnap.docs.forEach(d => {
        walletsData[d.id] = d.data()
      })
      
      // أرباح التطبيق
      const appWallet = walletsData['app_earnings'] || { balance: 0, totalEarnings: 0 }
      
      // حساب الإحصائيات
      const adminsData = usersData.filter(u => u.role === 'admin')
      const couriersData = usersData.filter(u => u.role === 'courier')
      const customersData = usersData.filter(u => u.role === 'customer')
      const ownersData = usersData.filter(u => u.role === 'owner')
      
      // بناء بيانات المشرفين مع المطاعم التابعة لهم
      const adminsWithRestaurants: Admin[] = adminsData.map(admin => {
        const adminRestaurants = restaurantsData.filter(r => r.referredBy === admin.uid)
        const wallet = walletsData[admin.uid] || { balance: 0, totalEarnings: 0 }
        return {
          uid: admin.uid,
          email: admin.email,
          name: admin.name,
          walletBalance: wallet.balance || 0,
          totalEarnings: wallet.totalEarnings || 0,
          restaurantsCount: adminRestaurants.length,
          restaurants: adminRestaurants,
        }
      })
      setAdmins(adminsWithRestaurants)
      
      setStats({
        users: usersData.length,
        restaurants: restaurantsData.length,
        menuItems: menuSnap.size,
        orders: ordersData.length,
        pendingOrders: ordersData.filter(o => o.status === 'pending').length,
        deliveredOrders: ordersData.filter(o => o.status === 'delivered').length,
        admins: adminsData.length,
        couriers: couriersData.length,
        customers: customersData.length,
        owners: ownersData.length,
        totalAppEarnings: appWallet.totalEarnings || 0,
      })

      // جلب الإعدادات
      const settingsSnap = await getDoc(doc(db, 'settings', 'general'))
      if (settingsSnap.exists()) {
        const data = settingsSnap.data() as AppSettings
        setSettings(data)
        setSettingsForm(data)
      } else {
        const defaultSettings: AppSettings = {
          deliveryFee: 7,
          minOrderAmount: 20,
          maxDeliveryDistance: 15,
          workingHours: { open: '09:00', close: '23:00' },
          maintenanceMode: false,
          appVersion: '1.0.0',
          platformFee: 1.0, // 1 ريال للتطبيق لكل منتج
          adminCommissionRate: 0.75, // 75 هللة للمشرف لكل منتج
        }
        setSettings(defaultSettings)
        setSettingsForm(defaultSettings)
      }
    } catch (err) {
      console.error('خطأ في تحميل البيانات:', err)
      toast.error('فشل تحميل البيانات')
    } finally {
      setLoading(false)
      setRefreshing(false)
    }
  }

  useEffect(() => {
    loadData()
  }, [])

  const handleRefresh = () => {
    setRefreshing(true)
    loadData()
    toast.info('جاري تحديث البيانات...')
  }

  // ===== حفظ الإعدادات =====
  const handleSaveSettings = async () => {
    try {
      await setDoc(doc(db, 'settings', 'general'), settingsForm, { merge: true })
      setSettings(settingsForm)
      setEditingSettings(false)
      toast.success('تم حفظ الإعدادات بنجاح ')
    } catch (err) {
      console.error('خطأ في حفظ الإعدادات:', err)
      toast.error('فشل حفظ الإعدادات')
    }
  }

  // ===== تحديث المطعم =====
  const handleUpdateRestaurant = async (id: string) => {
    try {
      await updateDoc(doc(db, 'restaurants', id), {
        ...restaurantForm,
        updatedAt: serverTimestamp(),
      })
      setEditingRestaurant(null)
      toast.success('تم تحديث المطعم بنجاح ')
      loadData()
    } catch (err) {
      console.error('خطأ في تحديث المطعم:', err)
      toast.error('فشل تحديث المطعم')
    }
  }

  // ===== رفع شعار المطعم =====
  const handleUploadLogo = async (id: string, file: File) => {
    try {
      // التحقق من نوع الملف
      if (!file.type.startsWith('image/')) {
        toast.warning('يرجى اختيار صورة فقط')
        return
      }
      if (file.size > 5 * 1024 * 1024) {
        toast.warning('حجم الصورة كبير، يرجى اختيار صورة أقل من 5MB')
        return
      }
      setUploadingLogo(true)
      const cleanName = file.name.replace(/\s+/g, '_')
      const path = `restaurants/${id}/logo_${Date.now()}_${cleanName}`
      const storageRef = ref(storage, path)
      const metadata = {
        contentType: file.type || 'image/jpeg',
        cacheControl: 'public,max-age=31536000,immutable',
      }
      await uploadBytes(storageRef, file, metadata)
      const url = await getDownloadURL(storageRef)
      
      await updateDoc(doc(db, 'restaurants', id), {
        logoUrl: url,
        updatedAt: serverTimestamp(),
      })
      
      toast.success('تم رفع الشعار بنجاح ')
      loadData()
    } catch (err) {
      console.error('خطأ في رفع الشعار:', err)
      toast.error('فشل رفع الشعار')
    } finally {
      setUploadingLogo(false)
    }
  }

  // ===== حذف مطعم =====
  const handleDeleteRestaurant = async (id: string) => {
    const confirmed = await dialog.confirm('هل أنت متأكد من حذف هذا المطعم؟ لا يمكن التراجع!', { 
      title: 'حذف المطعم',
      dangerous: true 
    })
    if (!confirmed) return
    try {
      await deleteDoc(doc(db, 'restaurants', id))
      toast.success('تم حذف المطعم بنجاح')
      loadData()
    } catch (err) {
      console.error('خطأ في حذف المطعم:', err)
      toast.error('فشل حذف المطعم')
    }
  }

  // ===== تحديث المستخدم =====
  const handleUpdateUser = async (uid: string) => {
    try {
      await updateDoc(doc(db, 'users', uid), {
        ...userForm,
        updatedAt: serverTimestamp(),
      })
      setEditingUser(null)
      toast.success('تم تحديث المستخدم بنجاح ')
      loadData()
    } catch (err) {
      console.error('خطأ في تحديث المستخدم:', err)
      toast.error('فشل تحديث المستخدم')
    }
  }

  // ===== حذف مستخدم =====
  const handleDeleteUser = async (uid: string) => {
    const confirmed = await dialog.confirm('هل أنت متأكد من حذف هذا المستخدم؟ لا يمكن التراجع!', {
      title: 'حذف المستخدم',
      dangerous: true
    })
    if (!confirmed) return
    try {
      await deleteDoc(doc(db, 'users', uid))
      toast.success('تم حذف المستخدم من قاعدة البيانات')
      toast.warning('ملاحظة: يجب حذف المستخدم يدوياً من Firebase Auth')
      loadData()
    } catch (err) {
      console.error('خطأ في حذف المستخدم:', err)
      toast.error('فشل حذف المستخدم')
    }
  }

  // ===== تحديث حالة الطلب =====
  const handleUpdateOrderStatus = async (orderId: string, newStatus: string) => {
    try {
      await updateDoc(doc(db, 'orders', orderId), {
        status: newStatus,
        updatedAt: serverTimestamp(),
      })
      toast.success('تم تحديث حالة الطلب ')
      loadData()
    } catch (err) {
      console.error('خطأ في تحديث الطلب:', err)
      toast.error('فشل تحديث الطلب')
    }
  }

  // ===== أسماء الأدوار =====
  const roleLabel = (role: string) => {
    switch (role) {
      case 'customer': return ' عميل'
      case 'owner': return ' صاحب مطعم'
      case 'courier': return ' مندوب'
      case 'admin': return ' مشرف'
      case 'developer': return ' مطور'
      default: return role
    }
  }

  // ===== أسماء حالات الطلب =====
  const statusLabel = (status: string) => {
    switch (status) {
      case 'pending': return ' قيد المراجعة'
      case 'accepted': return ' مقبول'
      case 'preparing': return ' قيد التحضير'
      case 'ready': return ' جاهز'
      case 'out_for_delivery': return ' في الطريق'
      case 'delivered': return ' تم التسليم'
      case 'cancelled': return ' ملغي'
      default: return status
    }
  }

  if (loading) {
    return (
      <RoleGate allow={['developer']}>
        <div className="flex items-center justify-center h-96">
          <div className="text-center">
            <RefreshCw className="w-12 h-12 text-primary animate-spin mx-auto mb-4" />
            <p className="text-lg text-gray-600">جاري تحميل لوحة المطور...</p>
          </div>
        </div>
      </RoleGate>
    )
  }

  return (
    <RoleGate allow={['developer']}>
      <div className="space-y-6">
        {/* رأس الصفحة */}
        <div className="flex items-center justify-between flex-wrap gap-4">
          <div>
            <h1 className="text-3xl font-extrabold text-primary"> لوحة المطور الشاملة</h1>
            <p className="text-gray-600 mt-1">إدارة كاملة لجميع بيانات التطبيق</p>
          </div>
          <button
            onClick={handleRefresh}
            disabled={refreshing}
            className="flex items-center gap-2 bg-primary hover:bg-sky-600 text-white px-4 py-2 rounded-xl font-semibold transition disabled:opacity-50"
          >
            <RefreshCw className={`w-5 h-5 ${refreshing ? 'animate-spin' : ''}`} />
            تحديث
          </button>
        </div>

        {/* التبويبات */}
        <div className="flex flex-wrap gap-2 border-b pb-4">
          {[
            { id: 'overview', label: ' نظرة عامة' },
            { id: 'finance', label: ' المالية' },
            { id: 'restaurants', label: ' المطاعم' },
            { id: 'storeAnalytics', label: ' مراقبة المتاجر' },
            { id: 'packages', label: ' طلبات الباقات' },
            { id: 'packageSettings', label: ' أسعار الباقات' },
            { id: 'licenses', label: ' التراخيص' },
            { id: 'orders', label: ' الطلبات' },
            { id: 'users', label: ' المستخدمين' },
            { id: 'couriers', label: ' المناديب' },
            { id: 'admins', label: ' المشرفين' },
            { id: 'tasks', label: ' المهام' },
            { id: 'activityLog', label: ' سجل العمليات' },
            { id: 'settings', label: ' الإعدادات' },
            { id: 'tools', label: ' الأدوات' },
          ].map(tab => (
            <button
              key={tab.id}
              onClick={() => {
                setActiveTab(tab.id as Tab)
                if (tab.id === 'activityLog') loadActivityLogs()
              }}
              className={`flex items-center gap-2 px-4 py-2 rounded-xl font-semibold transition ${
                activeTab === tab.id 
                  ? 'bg-primary text-white' 
                  : 'bg-gray-100 text-gray-700 hover:bg-gray-200'
              }`}
            >
              {tab.label}
            </button>
          ))}
        </div>

        {/* ===== نظرة عامة ===== */}
        {activeTab === 'overview' && (
          <div className="space-y-6">
            {/*  تنبيهات هامة */}
            {packageRequests.filter(r => ['pending', 'payment_sent'].includes(r.status)).length > 0 && (
              <div className="bg-gradient-to-r from-amber-100 to-orange-100 border-2 border-amber-300 rounded-2xl p-5 shadow-lg">
                <div className="flex items-center justify-between flex-wrap gap-4">
                  <div className="flex items-center gap-3">
                    <div className="w-12 h-12 bg-amber-500 rounded-xl flex items-center justify-center animate-pulse">
                      <Package className="w-6 h-6 text-white" />
                    </div>
                    <div>
                      <h3 className="text-lg font-bold text-amber-800"> طلبات باقات تحتاج إجراء</h3>
                      <p className="text-amber-700">
                        {packageRequests.filter(r => r.status === 'pending').length > 0 && (
                          <span> {packageRequests.filter(r => r.status === 'pending').length} طلب جديد</span>
                        )}
                        {packageRequests.filter(r => r.status === 'pending').length > 0 && packageRequests.filter(r => r.status === 'payment_sent').length > 0 && ' • '}
                        {packageRequests.filter(r => r.status === 'payment_sent').length > 0 && (
                          <span> {packageRequests.filter(r => r.status === 'payment_sent').length} بانتظار التأكيد</span>
                        )}
                      </p>
                    </div>
                  </div>
                  <button
                    onClick={() => setActiveTab('packages')}
                    className="bg-amber-500 hover:bg-amber-600 text-white px-6 py-3 rounded-xl font-bold shadow-lg transition transform hover:scale-105"
                  >
                     عرض الطلبات
                  </button>
                </div>
              </div>
            )}

            {/* إحصائيات سريعة */}
            <div className="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 gap-4">
              <div className="bg-gradient-to-br from-blue-500 to-blue-600 rounded-2xl p-4 text-white text-center">
                <p className="text-3xl font-bold">{stats.users}</p>
                <p className="text-sm opacity-90"> المستخدمين</p>
              </div>
              <div className="bg-gradient-to-br from-green-500 to-green-600 rounded-2xl p-4 text-white text-center">
                <p className="text-3xl font-bold">{stats.restaurants}</p>
                <p className="text-sm opacity-90"> المطاعم</p>
              </div>
              <div className="bg-gradient-to-br from-purple-500 to-purple-600 rounded-2xl p-4 text-white text-center">
                <p className="text-3xl font-bold">{stats.orders}</p>
                <p className="text-sm opacity-90"> الطلبات</p>
              </div>
              <div className="bg-gradient-to-br from-amber-500 to-amber-600 rounded-2xl p-4 text-white text-center cursor-pointer hover:scale-105 transition" onClick={() => setActiveTab('packages')}>
                <p className="text-3xl font-bold">{packageRequests.filter(r => r.status === 'pending').length}</p>
                <p className="text-sm opacity-90"> طلبات معلقة</p>
              </div>
              <div className="bg-gradient-to-br from-cyan-500 to-cyan-600 rounded-2xl p-4 text-white text-center">
                <p className="text-3xl font-bold">{stats.couriers}</p>
                <p className="text-sm opacity-90"> المناديب</p>
              </div>
              <div className="bg-gradient-to-br from-emerald-500 to-emerald-600 rounded-2xl p-4 text-white text-center">
                <p className="text-3xl font-bold">{stats.totalAppEarnings.toFixed(2)}</p>
                <p className="text-sm opacity-90"> أرباح التطبيق</p>
              </div>
            </div>

            {/* إحصائيات الباقات والحسابات */}
            <div className="grid md:grid-cols-2 lg:grid-cols-4 gap-4">
              <div className="bg-gradient-to-br from-amber-400 to-orange-500 rounded-2xl p-4 text-white">
                <div className="flex items-center justify-between mb-2">
                  <span className="text-2xl"></span>
                  <span className="text-3xl font-bold">
                    {restaurants.filter((r: any) => r.packageType === 'premium').length}
                  </span>
                </div>
                <p className="text-sm opacity-90">مشتركين باقة التميز</p>
              </div>
              <div className="bg-gradient-to-br from-gray-400 to-gray-500 rounded-2xl p-4 text-white">
                <div className="flex items-center justify-between mb-2">
                  <span className="text-2xl"></span>
                  <span className="text-3xl font-bold">
                    {restaurants.filter((r: any) => !r.packageType || r.packageType === 'free').length}
                  </span>
                </div>
                <p className="text-sm opacity-90">الباقة المجانية</p>
              </div>
              <div className="bg-gradient-to-br from-green-400 to-emerald-500 rounded-2xl p-4 text-white">
                <div className="flex items-center justify-between mb-2">
                  <span className="text-2xl"></span>
                  <span className="text-3xl font-bold">
                    {users.filter((u: any) => u.isActive !== false).length}
                  </span>
                </div>
                <p className="text-sm opacity-90">حسابات نشطة</p>
              </div>
              <div className="bg-gradient-to-br from-red-400 to-red-500 rounded-2xl p-4 text-white">
                <div className="flex items-center justify-between mb-2">
                  <span className="text-2xl"></span>
                  <span className="text-3xl font-bold">
                    {users.filter((u: any) => u.isActive === false).length}
                  </span>
                </div>
                <p className="text-sm opacity-90">حسابات موقوفة</p>
              </div>
            </div>

            {/* إعدادات Firebase */}
            <div className="bg-white rounded-2xl shadow-lg p-6">
              <div className="flex items-center gap-3 mb-4">
                <Server className="w-6 h-6 text-orange-500" />
                <h2 className="text-xl font-bold">إعدادات Firebase</h2>
              </div>
              <div className="grid md:grid-cols-2 gap-4">
                <div className="bg-gray-50 rounded-xl p-3">
                  <p className="text-xs text-gray-500">Project ID</p>
                  <p className="font-mono text-sm">{firebaseConfig.projectId}</p>
                </div>
                <div className="bg-gray-50 rounded-xl p-3">
                  <p className="text-xs text-gray-500">Storage Bucket</p>
                  <p className="font-mono text-sm">{firebaseConfig.storageBucket}</p>
                </div>
              </div>
              <div className="mt-4 flex flex-wrap gap-2">
                <a
                  href={`https://console.firebase.google.com/project/${firebaseConfig.projectId}/overview`}
                  target="_blank"
                  rel="noopener noreferrer"
                  className="text-sm bg-orange-100 hover:bg-orange-200 text-orange-700 px-3 py-1 rounded-lg"
                >
                   Console
                </a>
                <a
                  href={`https://console.firebase.google.com/project/${firebaseConfig.projectId}/firestore`}
                  target="_blank"
                  rel="noopener noreferrer"
                  className="text-sm bg-blue-100 hover:bg-blue-200 text-blue-700 px-3 py-1 rounded-lg"
                >
                   Firestore
                </a>
                <a
                  href={`https://console.firebase.google.com/project/${firebaseConfig.projectId}/authentication`}
                  target="_blank"
                  rel="noopener noreferrer"
                  className="text-sm bg-green-100 hover:bg-green-200 text-green-700 px-3 py-1 rounded-lg"
                >
                   Auth
                </a>
                <a
                  href={`https://console.firebase.google.com/project/${firebaseConfig.projectId}/storage`}
                  target="_blank"
                  rel="noopener noreferrer"
                  className="text-sm bg-purple-100 hover:bg-purple-200 text-purple-700 px-3 py-1 rounded-lg"
                >
                   Storage
                </a>
              </div>
            </div>

            {/* توزيع المستخدمين */}
            <div className="bg-white rounded-2xl shadow-lg p-6">
              <h2 className="text-xl font-bold mb-4"> توزيع المستخدمين</h2>
              <div className="grid grid-cols-2 md:grid-cols-5 gap-4">
                <div className="text-center p-4 bg-blue-50 rounded-xl">
                  <p className="text-2xl font-bold text-blue-600">{stats.customers}</p>
                  <p className="text-sm text-gray-600">عملاء</p>
                </div>
                <div className="text-center p-4 bg-green-50 rounded-xl">
                  <p className="text-2xl font-bold text-green-600">{stats.owners}</p>
                  <p className="text-sm text-gray-600">أصحاب مطاعم</p>
                </div>
                <div className="text-center p-4 bg-yellow-50 rounded-xl">
                  <p className="text-2xl font-bold text-yellow-600">{stats.couriers}</p>
                  <p className="text-sm text-gray-600">مناديب</p>
                </div>
                <div className="text-center p-4 bg-purple-50 rounded-xl">
                  <p className="text-2xl font-bold text-purple-600">{stats.admins}</p>
                  <p className="text-sm text-gray-600">مشرفين</p>
                </div>
                <div className="text-center p-4 bg-red-50 rounded-xl">
                  <p className="text-2xl font-bold text-red-600">1</p>
                  <p className="text-sm text-gray-600">مطور</p>
                </div>
              </div>
            </div>
          </div>
        )}

        {/* ===== المالية ===== */}
        {activeTab === 'finance' && (
          <div className="space-y-6">
            {(() => {
              const financeStats = getFinanceStats()
              return (
                <>
                  {/* ملخص مالي */}
                  <div className="bg-gradient-to-r from-green-600 to-emerald-700 rounded-2xl shadow-lg p-6 text-white">
                    <h2 className="text-2xl font-bold mb-4"> الملخص المالي</h2>
                    <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
                      <div className="bg-white/20 rounded-xl p-4 text-center">
                        <p className="text-3xl font-bold">{financeStats.totalRevenue.toFixed(0)}</p>
                        <p className="text-sm opacity-90">إجمالي المبيعات (ر.س)</p>
                      </div>
                      <div className="bg-white/20 rounded-xl p-4 text-center">
                        <p className="text-3xl font-bold">{financeStats.totalPlatformFee.toFixed(2)}</p>
                        <p className="text-sm opacity-90">رسوم التطبيق (ر.س)</p>
                      </div>
                      <div className="bg-white/20 rounded-xl p-4 text-center">
                        <p className="text-3xl font-bold">{financeStats.totalAdminCommission.toFixed(2)}</p>
                        <p className="text-sm opacity-90">عمولات المشرفين (ر.س)</p>
                      </div>
                      <div className="bg-white/20 rounded-xl p-4 text-center">
                        <p className="text-3xl font-bold">{(financeStats.totalPlatformFee + financeStats.totalAdminCommission).toFixed(2)}</p>
                        <p className="text-sm opacity-90">إجمالي الأرباح (ر.س)</p>
                      </div>
                    </div>
                  </div>

                  {/* إحصائيات زمنية */}
                  <div className="grid md:grid-cols-3 gap-6">
                    {/* اليوم */}
                    <div className="bg-white rounded-2xl shadow-lg p-6">
                      <h3 className="text-lg font-bold text-blue-600 mb-4"> اليوم</h3>
                      <div className="space-y-3">
                        <div className="flex justify-between">
                          <span className="text-gray-600">الطلبات:</span>
                          <span className="font-bold">{financeStats.todayOrders}</span>
                        </div>
                        <div className="flex justify-between">
                          <span className="text-gray-600">المبيعات:</span>
                          <span className="font-bold">{financeStats.todayRevenue.toFixed(2)} ر.س</span>
                        </div>
                        <div className="flex justify-between">
                          <span className="text-gray-600">رسوم التطبيق:</span>
                          <span className="font-bold text-green-600">{financeStats.todayPlatformFee.toFixed(2)} ر.س</span>
                        </div>
                      </div>
                    </div>

                    {/* الأسبوع */}
                    <div className="bg-white rounded-2xl shadow-lg p-6">
                      <h3 className="text-lg font-bold text-purple-600 mb-4"> آخر 7 أيام</h3>
                      <div className="space-y-3">
                        <div className="flex justify-between">
                          <span className="text-gray-600">الطلبات:</span>
                          <span className="font-bold">{financeStats.weekOrders}</span>
                        </div>
                        <div className="flex justify-between">
                          <span className="text-gray-600">المبيعات:</span>
                          <span className="font-bold">{financeStats.weekRevenue.toFixed(2)} ر.س</span>
                        </div>
                        <div className="flex justify-between">
                          <span className="text-gray-600">رسوم التطبيق:</span>
                          <span className="font-bold text-green-600">{financeStats.weekPlatformFee.toFixed(2)} ر.س</span>
                        </div>
                      </div>
                    </div>

                    {/* الشهر */}
                    <div className="bg-white rounded-2xl shadow-lg p-6">
                      <h3 className="text-lg font-bold text-orange-600 mb-4"> آخر 30 يوم</h3>
                      <div className="space-y-3">
                        <div className="flex justify-between">
                          <span className="text-gray-600">الطلبات:</span>
                          <span className="font-bold">{financeStats.monthOrders}</span>
                        </div>
                        <div className="flex justify-between">
                          <span className="text-gray-600">المبيعات:</span>
                          <span className="font-bold">{financeStats.monthRevenue.toFixed(2)} ر.س</span>
                        </div>
                        <div className="flex justify-between">
                          <span className="text-gray-600">رسوم التطبيق:</span>
                          <span className="font-bold text-green-600">{financeStats.monthPlatformFee.toFixed(2)} ر.س</span>
                        </div>
                      </div>
                    </div>
                  </div>

                  {/* أعلى المطاعم أداءً */}
                  <div className="bg-white rounded-2xl shadow-lg p-6">
                    <h3 className="text-lg font-bold mb-4"> أعلى المطاعم أداءً</h3>
                    <div className="space-y-3">
                      {restaurants
                        .map(r => ({
                          ...r,
                          ordersCount: orders.filter(o => o.restaurantId === r.id && o.status === 'delivered').length,
                          revenue: orders.filter(o => o.restaurantId === r.id && o.status === 'delivered').reduce((sum, o) => sum + (o.total || 0), 0),
                        }))
                        .sort((a, b) => b.revenue - a.revenue)
                        .slice(0, 5)
                        .map((r, i) => (
                          <div key={r.id} className="flex items-center justify-between bg-gray-50 rounded-xl p-3">
                            <div className="flex items-center gap-3">
                              <span className="text-2xl">{i === 0 ? '' : i === 1 ? '' : i === 2 ? '' : `#${i + 1}`}</span>
                              <div>
                                <p className="font-bold">{r.name}</p>
                                <p className="text-sm text-gray-500">{r.ordersCount} طلب</p>
                              </div>
                            </div>
                            <p className="font-bold text-green-600">{r.revenue.toFixed(2)} ر.س</p>
                          </div>
                        ))}
                    </div>
                  </div>
                </>
              )
            })()}
          </div>
        )}

        {/* ===== المطاعم ===== */}
        {activeTab === 'restaurants' && (
          <div className="space-y-4">
            <div className="flex items-center justify-between flex-wrap gap-4">
              <h2 className="text-xl font-bold"> جميع المطاعم ({restaurants.length})</h2>
              <button
                onClick={() => setShowAddRestaurant(!showAddRestaurant)}
                className="flex items-center gap-2 bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-xl font-semibold"
              >
                {showAddRestaurant ? ' إلغاء' : ' إضافة مطعم'}
              </button>
            </div>

            {/* نموذج إضافة مطعم */}
            {showAddRestaurant && (
              <div className="bg-green-50 rounded-2xl p-6 border-2 border-green-200">
                <h3 className="text-lg font-bold text-green-800 mb-4"> إضافة مطعم جديد</h3>
                <div className="grid md:grid-cols-2 gap-4">
                  <div>
                    <label className="text-sm text-gray-600 block mb-1">اسم المطعم *</label>
                    <input
                      type="text"
                      placeholder="مثال: مطعم الشام"
                      value={newRestaurantName}
                      onChange={e => setNewRestaurantName(e.target.value)}
                      className="w-full border rounded-xl p-3"
                    />
                  </div>
                  <div>
                    <label className="text-sm text-gray-600 block mb-1">المدينة</label>
                    <input
                      type="text"
                      placeholder="مثال: الرياض"
                      value={newRestaurantCity}
                      onChange={e => setNewRestaurantCity(e.target.value)}
                      className="w-full border rounded-xl p-3"
                    />
                  </div>
                  <div>
                    <label className="text-sm text-gray-600 block mb-1">هاتف المطعم</label>
                    <input
                      type="tel"
                      placeholder="05xxxxxxxx"
                      value={newRestaurantPhone}
                      onChange={e => setNewRestaurantPhone(e.target.value)}
                      className="w-full border rounded-xl p-3"
                    />
                  </div>
                  <div>
                    <label className="text-sm text-gray-600 block mb-1">إيميل المطعم</label>
                    <input
                      type="email"
                      placeholder="restaurant@example.com"
                      value={newRestaurantEmail}
                      onChange={e => setNewRestaurantEmail(e.target.value)}
                      className="w-full border rounded-xl p-3"
                    />
                  </div>
                </div>
                
                <div className="border-t mt-4 pt-4">
                  <h4 className="font-bold text-green-800 mb-3"> بيانات صاحب المطعم (لتسجيل الدخول)</h4>
                  <div className="grid md:grid-cols-2 gap-4">
                    <div>
                      <label className="text-sm text-gray-600 block mb-1">إيميل صاحب المطعم *</label>
                      <input
                        type="email"
                        placeholder="owner@example.com"
                        value={newRestaurantOwnerEmail}
                        onChange={e => setNewRestaurantOwnerEmail(e.target.value)}
                        className="w-full border rounded-xl p-3"
                      />
                    </div>
                    <div>
                      <label className="text-sm text-gray-600 block mb-1">كلمة المرور *</label>
                      <input
                        type="password"
                        placeholder="6 أحرف على الأقل"
                        value={newRestaurantOwnerPassword}
                        onChange={e => setNewRestaurantOwnerPassword(e.target.value)}
                        className="w-full border rounded-xl p-3"
                      />
                    </div>
                  </div>
                </div>

                <button
                  onClick={handleCreateNewRestaurant}
                  disabled={creatingRestaurant || !newRestaurantName.trim() || !newRestaurantOwnerEmail.trim() || !newRestaurantOwnerPassword.trim()}
                  className="mt-4 w-full bg-green-600 hover:bg-green-700 text-white py-3 rounded-xl font-bold disabled:opacity-50 flex items-center justify-center gap-2"
                >
                  {creatingRestaurant ? (
                    <>
                      <RefreshCw className="w-5 h-5 animate-spin" />
                      جاري الإنشاء...
                    </>
                  ) : (
                    ' إنشاء المطعم'
                  )}
                </button>
              </div>
            )}
            
            <div className="space-y-4">
              {restaurants.map(restaurant => (
                <div key={restaurant.id} className="bg-white rounded-2xl shadow p-4">
                  {editingRestaurant === restaurant.id ? (
                    // وضع التحرير
                    <div className="space-y-4">
                      <div className="grid md:grid-cols-2 gap-4">
                        <div>
                          <label className="text-sm text-gray-600">اسم المطعم</label>
                          <input
                            type="text"
                            value={restaurantForm.name || ''}
                            onChange={e => setRestaurantForm({ ...restaurantForm, name: e.target.value })}
                            className="w-full border rounded-xl p-2 mt-1"
                          />
                        </div>
                        <div>
                          <label className="text-sm text-gray-600">رقم الهاتف</label>
                          <input
                            type="text"
                            value={restaurantForm.phone || ''}
                            onChange={e => setRestaurantForm({ ...restaurantForm, phone: e.target.value })}
                            className="w-full border rounded-xl p-2 mt-1"
                          />
                        </div>
                        <div>
                          <label className="text-sm text-gray-600">البريد الإلكتروني</label>
                          <input
                            type="email"
                            value={restaurantForm.email || ''}
                            onChange={e => setRestaurantForm({ ...restaurantForm, email: e.target.value })}
                            className="w-full border rounded-xl p-2 mt-1"
                          />
                        </div>
                        <div>
                          <label className="text-sm text-gray-600">المدينة</label>
                          <input
                            type="text"
                            value={restaurantForm.city || ''}
                            onChange={e => setRestaurantForm({ ...restaurantForm, city: e.target.value })}
                            className="w-full border rounded-xl p-2 mt-1"
                          />
                        </div>
                        <div className="md:col-span-2">
                          <label className="text-sm text-gray-600">العنوان</label>
                          <input
                            type="text"
                            value={restaurantForm.location || ''}
                            onChange={e => setRestaurantForm({ ...restaurantForm, location: e.target.value })}
                            className="w-full border rounded-xl p-2 mt-1"
                          />
                        </div>
                        <div className="md:col-span-2">
                          <label className="text-sm text-gray-600">ربط بمشرف (للعمولة)</label>
                          <select
                            value={restaurantForm.referredBy || ''}
                            onChange={e => setRestaurantForm({ ...restaurantForm, referredBy: e.target.value })}
                            className="w-full border rounded-xl p-2 mt-1"
                          >
                            <option value="">-- بدون مشرف (المطور فقط) --</option>
                            {users
                              .filter(u => u.role === 'admin')
                              .map(admin => (
                                <option key={admin.uid} value={admin.uid}>
                                   {admin.name || admin.email}
                                </option>
                              ))}
                          </select>
                          <p className="text-xs text-gray-500 mt-1">
                            المشرف المرتبط يحصل على عمولة من طلبات هذا المطعم
                          </p>
                        </div>
                      </div>
                      
                      {/* رفع الشعار */}
                      <div>
                        <label className="text-sm text-gray-600">شعار المطعم</label>
                        <input
                          type="file"
                          accept="image/*"
                          onChange={e => {
                            const file = e.target.files?.[0]
                            if (file) handleUploadLogo(restaurant.id, file)
                          }}
                          className="w-full border rounded-xl p-2 mt-1"
                          disabled={uploadingLogo}
                        />
                        {uploadingLogo && <p className="text-sm text-gray-500 mt-1">جاري الرفع...</p>}
                      </div>
                      
                      <div className="flex gap-2">
                        <button
                          onClick={() => handleUpdateRestaurant(restaurant.id)}
                          className="flex items-center gap-2 bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-xl"
                        >
                          <Save className="w-4 h-4" /> حفظ
                        </button>
                        <button
                          onClick={() => setEditingRestaurant(null)}
                          className="flex items-center gap-2 bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded-xl"
                        >
                          <X className="w-4 h-4" /> إلغاء
                        </button>
                      </div>
                    </div>
                  ) : (
                    // وضع العرض
                    <div className="flex items-start gap-4">
                      {/* الشعار */}
                      <div className="w-16 h-16 rounded-xl bg-gray-100 overflow-hidden flex-shrink-0">
                        {restaurant.logoUrl ? (
                          <img src={restaurant.logoUrl} alt={restaurant.name} className="w-full h-full object-cover" />
                        ) : (
                          <div className="w-full h-full flex items-center justify-center text-2xl"></div>
                        )}
                      </div>
                      
                      {/* التفاصيل */}
                      <div className="flex-1">
                        <div className="flex items-center gap-2">
                          <h3 className="font-bold text-lg">{restaurant.name}</h3>
                          {restaurant.isVerified && (
                            <span className="inline-flex items-center gap-1 px-2 py-0.5 bg-green-100 text-green-700 text-xs font-bold rounded-full">
                              <CheckCircle className="w-3 h-3" /> موثقة
                            </span>
                          )}
                        </div>
                        <div className="text-sm text-gray-600 space-y-1 mt-1">
                          {restaurant.phone && <p> {restaurant.phone}</p>}
                          {restaurant.email && <p> {restaurant.email}</p>}
                          {restaurant.city && <p> {restaurant.city}</p>}
                          {restaurant.referredBy && (
                            <p className="text-purple-600">
                               مضاف من: {admins.find(a => a.uid === restaurant.referredBy)?.name || restaurant.referredBy.slice(0, 8)}
                            </p>
                          )}
                        </div>
                      </div>
                      
                      {/* الأزرار */}
                      <div className="flex flex-col gap-2">
                        <div className="flex gap-2">
                          {/* زر التوثيق */}
                          <button
                            onClick={async () => {
                              const newStatus = !restaurant.isVerified
                              const confirmed = await dialog.confirm(
                                newStatus 
                                  ? `هل تريد توثيق أسرة "${restaurant.name}"؟ ستظهر علامة التوثيق للعملاء.`
                                  : `هل تريد إلغاء توثيق أسرة "${restaurant.name}"؟`,
                                { 
                                  title: newStatus ? ' توثيق الأسرة' : ' إلغاء التوثيق',
                                  confirmText: newStatus ? 'نعم، وثّق' : 'نعم، ألغِ التوثيق',
                                }
                              )
                              if (!confirmed) return
                              try {
                                await updateDoc(doc(db, 'restaurants', restaurant.id), {
                                  isVerified: newStatus,
                                  verifiedAt: newStatus ? serverTimestamp() : null,
                                  updatedAt: serverTimestamp(),
                                })
                                toast.success(newStatus ? 'تم توثيق الأسرة ' : 'تم إلغاء التوثيق')
                                loadData()
                              } catch (err) {
                                toast.error('حدث خطأ')
                                console.error(err)
                              }
                            }}
                            className={`p-2 rounded-xl ${restaurant.isVerified ? 'bg-green-100 hover:bg-green-200 text-green-600' : 'bg-gray-100 hover:bg-gray-200 text-gray-600'}`}
                            title={restaurant.isVerified ? 'إلغاء التوثيق' : 'توثيق الأسرة'}
                          >
                            <CheckCircle className="w-5 h-5" />
                          </button>
                          <button
                            onClick={() => {
                              setEditingRestaurant(restaurant.id)
                              setRestaurantForm(restaurant)
                            }}
                            className="p-2 bg-blue-100 hover:bg-blue-200 text-blue-600 rounded-xl"
                            title="تحرير"
                          >
                            <Edit3 className="w-5 h-5" />
                          </button>
                          <button
                            onClick={() => handleDeleteRestaurant(restaurant.id)}
                            className="p-2 bg-red-100 hover:bg-red-200 text-red-600 rounded-xl"
                            title="حذف"
                          >
                            <Trash2 className="w-5 h-5" />
                          </button>
                        </div>
                        {/* أزرار الباقة */}
                        <div className="flex gap-2 items-center">
                          {(restaurant as any).packageType === 'premium' ? (
                            <>
                              <span className="text-xs bg-amber-100 text-amber-700 px-2 py-1 rounded-full flex items-center gap-1">
                                 باقة التميز
                              </span>
                              <button
                                onClick={() => handleCancelPremium(restaurant)}
                                className="text-xs bg-red-50 hover:bg-red-100 text-red-600 px-3 py-1 rounded-lg"
                              >
                                إلغاء الباقة
                              </button>
                            </>
                          ) : (
                            <button
                              onClick={() => handleActivatePremium(restaurant)}
                              className="text-xs bg-amber-50 hover:bg-amber-100 text-amber-700 px-3 py-1 rounded-lg flex items-center gap-1"
                            >
                               تفعيل باقة التميز
                            </button>
                          )}
                        </div>
                        {/* ربط سريع بمشرف */}
                        <select
                          value={restaurant.referredBy || ''}
                          onChange={async (e) => {
                            const newAdminId = e.target.value
                            try {
                              await updateDoc(doc(db, 'restaurants', restaurant.id), {
                                referredBy: newAdminId || null,
                                updatedAt: serverTimestamp()
                              })
                              toast.success(newAdminId ? 'تم ربط المطعم بالمشرف' : 'تم إلغاء ربط المشرف')
                              loadData()
                            } catch (err) {
                              toast.error('فشل في تحديث الربط')
                            }
                          }}
                          className="text-xs border rounded-lg p-1"
                          title="ربط بمشرف"
                        >
                          <option value=""> بدون مشرف</option>
                          {users
                            .filter(u => u.role === 'admin')
                            .map(admin => (
                              <option key={admin.uid} value={admin.uid}>
                                 {admin.name || admin.email}
                              </option>
                            ))}
                        </select>
                      </div>
                    </div>
                  )}
                </div>
              ))}
            </div>
          </div>
        )}

        {/* ===== الطلبات ===== */}
        {activeTab === 'orders' && (
          <div className="space-y-4">
            <div className="flex items-center justify-between flex-wrap gap-4">
              <h2 className="text-xl font-bold"> جميع الطلبات ({orders.length})</h2>
              <select
                value={orderFilter}
                onChange={e => setOrderFilter(e.target.value)}
                className="border rounded-xl p-2"
              >
                <option value="all">جميع الحالات</option>
                <option value="pending">قيد المراجعة</option>
                <option value="accepted">مقبول</option>
                <option value="preparing">قيد التحضير</option>
                <option value="ready">جاهز</option>
                <option value="out_for_delivery">في الطريق</option>
                <option value="delivered">تم التسليم</option>
                <option value="cancelled">ملغي</option>
              </select>
            </div>
            
            <div className="space-y-3">
              {orders
                .filter(o => orderFilter === 'all' || o.status === orderFilter)
                .sort((a, b) => (b.createdAt?.seconds || 0) - (a.createdAt?.seconds || 0))
                .map(order => (
                  <div key={order.id} className="bg-white rounded-2xl shadow p-4">
                    <div className="flex items-start justify-between flex-wrap gap-4">
                      <div>
                        <h3 className="font-bold">طلب #{order.id.slice(-8)}</h3>
                        <p className="text-sm text-gray-600"> {order.restaurantName || 'مطعم'}</p>
                        <p className="text-sm text-gray-600"> {order.address}</p>
                        <p className="text-sm text-gray-600"> {order.total?.toFixed(2)} ر.س</p>
                        {order.platformFee && (
                          <p className="text-xs text-green-600">
                            رسوم التطبيق: {order.platformFee} ر.س 
                            {order.adminCommission ? ` | عمولة المشرف: ${order.adminCommission} ر.س` : ''}
                          </p>
                        )}
                      </div>
                      
                      <div className="text-left">
                        <span className={`inline-block px-3 py-1 rounded-xl text-sm font-semibold ${
                          order.status === 'delivered' ? 'bg-green-100 text-green-700' :
                          order.status === 'cancelled' ? 'bg-red-100 text-red-700' :
                          order.status === 'pending' ? 'bg-yellow-100 text-yellow-700' :
                          'bg-blue-100 text-blue-700'
                        }`}>
                          {statusLabel(order.status)}
                        </span>
                        
                        {/* تغيير الحالة */}
                        <select
                          value={order.status}
                          onChange={e => handleUpdateOrderStatus(order.id, e.target.value)}
                          className="mt-2 w-full border rounded-lg p-1 text-sm"
                        >
                          <option value="pending">قيد المراجعة</option>
                          <option value="accepted">مقبول</option>
                          <option value="preparing">قيد التحضير</option>
                          <option value="ready">جاهز</option>
                          <option value="out_for_delivery">في الطريق</option>
                          <option value="delivered">تم التسليم</option>
                          <option value="cancelled">ملغي</option>
                        </select>
                      </div>
                    </div>
                    
                    {/* الأصناف */}
                    <div className="mt-3 pt-3 border-t">
                      <p className="text-sm text-gray-500 mb-1">الأصناف:</p>
                      <div className="flex flex-wrap gap-2">
                        {order.items?.map((item, i) => (
                          <span key={i} className="text-xs bg-gray-100 px-2 py-1 rounded">
                            {item.name} × {item.qty}
                          </span>
                        ))}
                      </div>
                    </div>
                  </div>
                ))}
            </div>
          </div>
        )}

        {/* ===== المستخدمين ===== */}
        {activeTab === 'users' && (
          <div className="space-y-4">
            <div className="flex items-center justify-between flex-wrap gap-4">
              <h2 className="text-xl font-bold"> جميع المستخدمين ({users.length})</h2>
              <select
                value={userFilter}
                onChange={e => setUserFilter(e.target.value)}
                className="border rounded-xl p-2"
              >
                <option value="all">جميع الأدوار</option>
                <option value="customer">عملاء</option>
                <option value="owner">أصحاب مطاعم</option>
                <option value="courier">مناديب</option>
                <option value="admin">مشرفين</option>
                <option value="developer">مطورين</option>
              </select>
            </div>
            
            <div className="grid md:grid-cols-2 lg:grid-cols-3 gap-4">
              {users
                .filter(u => userFilter === 'all' || u.role === userFilter)
                .map(u => (
                  <div key={u.uid} className="bg-white rounded-2xl shadow p-4">
                    {editingUser === u.uid ? (
                      <div className="space-y-3">
                        <input
                          type="text"
                          placeholder="الاسم"
                          value={userForm.name || ''}
                          onChange={e => setUserForm({ ...userForm, name: e.target.value })}
                          className="w-full border rounded-xl p-2"
                        />
                        <input
                          type="text"
                          placeholder="الهاتف"
                          value={userForm.phone || ''}
                          onChange={e => setUserForm({ ...userForm, phone: e.target.value })}
                          className="w-full border rounded-xl p-2"
                        />
                        <select
                          value={userForm.role || 'customer'}
                          onChange={e => setUserForm({ ...userForm, role: e.target.value })}
                          className="w-full border rounded-xl p-2"
                        >
                          <option value="customer">عميل</option>
                          <option value="owner">صاحب مطعم</option>
                          <option value="courier">مندوب</option>
                          <option value="admin">مشرف</option>
                          <option value="developer">مطور</option>
                        </select>
                        <div className="flex gap-2">
                          <button
                            onClick={() => handleUpdateUser(u.uid)}
                            className="flex-1 bg-green-600 text-white py-2 rounded-xl"
                          >
                            حفظ
                          </button>
                          <button
                            onClick={() => setEditingUser(null)}
                            className="flex-1 bg-gray-500 text-white py-2 rounded-xl"
                          >
                            إلغاء
                          </button>
                        </div>
                      </div>
                    ) : (
                      <>
                        <div className="flex items-start justify-between">
                          <div>
                            <div className="flex items-center gap-2">
                              <h3 className="font-bold">{u.name || 'بدون اسم'}</h3>
                              {(u as any).isActive === false && (
                                <span className="text-xs bg-red-100 text-red-600 px-2 py-0.5 rounded-full">موقوف</span>
                              )}
                            </div>
                            <p className="text-sm text-gray-600">{u.email}</p>
                            <p className="text-xs mt-1">{roleLabel(u.role)}</p>
                          </div>
                          <div className="flex gap-1">
                            {/* زر تفعيل/إيقاف */}
                            <button
                              onClick={() => handleToggleUserStatus(u, (u as any).isActive !== false)}
                              className={`p-1.5 rounded-lg ${
                                (u as any).isActive === false 
                                  ? 'bg-green-100 text-green-600' 
                                  : 'bg-orange-100 text-orange-600'
                              }`}
                              title={(u as any).isActive === false ? 'تفعيل الحساب' : 'تعليق الحساب'}
                            >
                              {(u as any).isActive === false ? (
                                <CheckCircle className="w-4 h-4" />
                              ) : (
                                <AlertCircle className="w-4 h-4" />
                              )}
                            </button>
                            <button
                              onClick={() => {
                                setEditingUser(u.uid)
                                setUserForm(u)
                              }}
                              className="p-1.5 bg-blue-100 text-blue-600 rounded-lg"
                            >
                              <Edit3 className="w-4 h-4" />
                            </button>
                            <button
                              onClick={() => handleDeleteUser(u.uid)}
                              className="p-1.5 bg-red-100 text-red-600 rounded-lg"
                            >
                              <Trash2 className="w-4 h-4" />
                            </button>
                          </div>
                        </div>
                      </>
                    )}
                  </div>
                ))}
            </div>
          </div>
        )}

        {/* ===== المناديب ===== */}
        {activeTab === 'couriers' && (
          <div className="space-y-4">
            <div className="flex items-center justify-between flex-wrap gap-4">
              <h2 className="text-xl font-bold"> المناديب ({stats.couriers})</h2>
              <button
                onClick={() => setShowAddCourier(!showAddCourier)}
                className="flex items-center gap-2 bg-cyan-600 hover:bg-cyan-700 text-white px-4 py-2 rounded-xl font-semibold"
              >
                {showAddCourier ? ' إلغاء' : ' إضافة مندوب'}
              </button>
            </div>

            {/* نموذج إضافة مندوب */}
            {showAddCourier && (
              <div className="bg-cyan-50 rounded-2xl p-6 border-2 border-cyan-200">
                <h3 className="text-lg font-bold text-cyan-800 mb-4"> إضافة مندوب جديد</h3>
                <div className="grid md:grid-cols-2 gap-4">
                  <div>
                    <label className="text-sm text-gray-600 block mb-1">البريد الإلكتروني *</label>
                    <input
                      type="email"
                      placeholder="courier@example.com"
                      value={newCourierEmail}
                      onChange={e => setNewCourierEmail(e.target.value)}
                      className="w-full border rounded-xl p-3"
                    />
                  </div>
                  <div>
                    <label className="text-sm text-gray-600 block mb-1">كلمة المرور *</label>
                    <input
                      type="password"
                      placeholder="6 أحرف على الأقل"
                      value={newCourierPassword}
                      onChange={e => setNewCourierPassword(e.target.value)}
                      className="w-full border rounded-xl p-3"
                    />
                  </div>
                  <div>
                    <label className="text-sm text-gray-600 block mb-1">الاسم</label>
                    <input
                      type="text"
                      placeholder="اسم المندوب"
                      value={newCourierName}
                      onChange={e => setNewCourierName(e.target.value)}
                      className="w-full border rounded-xl p-3"
                    />
                  </div>
                  <div>
                    <label className="text-sm text-gray-600 block mb-1">رقم الهاتف</label>
                    <input
                      type="tel"
                      placeholder="05xxxxxxxx"
                      value={newCourierPhone}
                      onChange={e => setNewCourierPhone(e.target.value)}
                      className="w-full border rounded-xl p-3"
                    />
                  </div>
                </div>
                <button
                  onClick={handleCreateNewCourier}
                  disabled={creatingCourier || !newCourierEmail.trim() || !newCourierPassword.trim()}
                  className="mt-4 w-full bg-cyan-600 hover:bg-cyan-700 text-white py-3 rounded-xl font-bold disabled:opacity-50 flex items-center justify-center gap-2"
                >
                  {creatingCourier ? (
                    <>
                      <RefreshCw className="w-5 h-5 animate-spin" />
                      جاري الإنشاء...
                    </>
                  ) : (
                    ' إنشاء حساب المندوب'
                  )}
                </button>
              </div>
            )}
            
            <div className="grid md:grid-cols-2 lg:grid-cols-3 gap-4">
              {users.filter(u => u.role === 'courier').map(courier => (
                <div key={courier.uid} className="bg-white rounded-2xl shadow p-4">
                  <div className="flex items-center gap-3">
                    <div className="w-12 h-12 bg-cyan-100 rounded-full flex items-center justify-center text-2xl">
                      
                    </div>
                    <div>
                      <h3 className="font-bold">{courier.name || 'بدون اسم'}</h3>
                      <p className="text-sm text-gray-600">{courier.email}</p>
                      {courier.phone && <p className="text-sm text-gray-600"> {courier.phone}</p>}
                    </div>
                  </div>
                  
                  {/* إحصائيات المندوب */}
                  <div className="mt-4 pt-3 border-t">
                    <div className="grid grid-cols-2 gap-2 text-center">
                      <div className="bg-green-50 rounded-lg p-2">
                        <p className="text-lg font-bold text-green-600">
                          {orders.filter(o => o.courierId === courier.uid && o.status === 'delivered').length}
                        </p>
                        <p className="text-xs text-gray-600">طلبات مسلمة</p>
                      </div>
                      <div className="bg-blue-50 rounded-lg p-2">
                        <p className="text-lg font-bold text-blue-600">
                          {orders.filter(o => o.courierId === courier.uid && o.status === 'out_for_delivery').length}
                        </p>
                        <p className="text-xs text-gray-600">في الطريق</p>
                      </div>
                    </div>
                  </div>
                </div>
              ))}
              
              {stats.couriers === 0 && (
                <div className="col-span-full text-center py-12 text-gray-500">
                  لا يوجد مناديب مسجلين
                </div>
              )}
            </div>
          </div>
        )}

        {/* ===== المشرفين ===== */}
        {activeTab === 'admins' && (
          <div className="space-y-4">
            <div className="flex items-center justify-between flex-wrap gap-4">
              <h2 className="text-xl font-bold"> المشرفين وعمولاتهم ({admins.length})</h2>
              <button
                onClick={() => setShowAddAdmin(!showAddAdmin)}
                className="flex items-center gap-2 bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 rounded-xl font-semibold transition"
              >
                <UserPlus className="w-5 h-5" />
                {showAddAdmin ? 'إلغاء' : 'إضافة مشرف'}
              </button>
            </div>
            
            {/* نموذج إضافة مشرف */}
            {showAddAdmin && (
              <div className="bg-purple-50 rounded-2xl p-6 border-2 border-purple-200">
                <h3 className="text-lg font-bold text-purple-800 mb-4"> ترقية مستخدم إلى مشرف</h3>
                <p className="text-sm text-purple-600 mb-4">اختر مستخدم موجود لترقيته إلى دور المشرف، أو أدخل بيانات مستخدم جديد</p>
                
                {/* قائمة المستخدمين الموجودين */}
                <div className="mb-4">
                  <label className="text-sm font-semibold text-gray-700 block mb-2">ترقية مستخدم موجود:</label>
                  <div className="grid gap-2 max-h-48 overflow-y-auto">
                    {users.filter(u => u.role === 'customer').slice(0, 10).map(u => (
                      <div key={u.uid} className="flex items-center justify-between bg-white p-3 rounded-xl">
                        <div>
                          <p className="font-semibold">{u.name || 'بدون اسم'}</p>
                          <p className="text-sm text-gray-500">{u.email}</p>
                        </div>
                        <button
                          onClick={async () => {
                            const confirmed = await dialog.confirm(`هل تريد ترقية ${u.name || u.email} إلى مشرف؟`, {
                              title: 'ترقية إلى مشرف'
                            })
                            if (!confirmed) return
                            try {
                              await updateDoc(doc(db, 'users', u.uid), { role: 'admin' })
                              toast.success('تم ترقية المستخدم إلى مشرف ')
                              setShowAddAdmin(false)
                              loadData()
                            } catch (err) {
                              toast.error('فشل ترقية المستخدم')
                            }
                          }}
                          className="bg-purple-600 hover:bg-purple-700 text-white px-3 py-1 rounded-lg text-sm"
                        >
                          ترقية 
                        </button>
                      </div>
                    ))}
                    {users.filter(u => u.role === 'customer').length === 0 && (
                      <p className="text-gray-500 text-center py-4">لا يوجد عملاء يمكن ترقيتهم</p>
                    )}
                  </div>
                </div>
                
                {/* نموذج إنشاء مشرف جديد */}
                <div className="border-t pt-4 mt-4">
                  <h4 className="text-md font-bold text-purple-800 mb-3"> أو إنشاء حساب مشرف جديد:</h4>
                  <div className="grid md:grid-cols-2 gap-4">
                    <div>
                      <label className="text-sm text-gray-600 block mb-1">البريد الإلكتروني *</label>
                      <input
                        type="email"
                        placeholder="admin@example.com"
                        value={newAdminEmail}
                        onChange={e => setNewAdminEmail(e.target.value)}
                        className="w-full border rounded-xl p-3 text-gray-900"
                      />
                    </div>
                    <div>
                      <label className="text-sm text-gray-600 block mb-1">كلمة المرور *</label>
                      <input
                        type="password"
                        placeholder="كلمة المرور (6 أحرف على الأقل)"
                        value={newAdminPassword}
                        onChange={e => setNewAdminPassword(e.target.value)}
                        className="w-full border rounded-xl p-3 text-gray-900"
                      />
                    </div>
                    <div>
                      <label className="text-sm text-gray-600 block mb-1">الاسم</label>
                      <input
                        type="text"
                        placeholder="اسم المشرف"
                        value={newAdminName}
                        onChange={e => setNewAdminName(e.target.value)}
                        className="w-full border rounded-xl p-3 text-gray-900"
                      />
                    </div>
                    <div>
                      <label className="text-sm text-gray-600 block mb-1">رقم الهاتف</label>
                      <input
                        type="tel"
                        placeholder="05xxxxxxxx"
                        value={newAdminPhone}
                        onChange={e => setNewAdminPhone(e.target.value)}
                        className="w-full border rounded-xl p-3 text-gray-900"
                      />
                    </div>
                  </div>
                  
                  <button
                    onClick={handleCreateNewAdmin}
                    disabled={creatingAdmin || !newAdminEmail.trim() || !newAdminPassword.trim()}
                    className="mt-4 w-full bg-gradient-to-r from-purple-600 to-purple-700 hover:from-purple-700 hover:to-purple-800 text-white py-3 rounded-xl font-bold transition disabled:opacity-50 flex items-center justify-center gap-2"
                  >
                    {creatingAdmin ? (
                      <>
                        <RefreshCw className="w-5 h-5 animate-spin" />
                        جاري الإنشاء...
                      </>
                    ) : (
                      <>
                        <UserPlus className="w-5 h-5" />
                        إنشاء حساب المشرف
                      </>
                    )}
                  </button>
                  
                  <p className="text-xs text-orange-600 mt-2">
                     تنبيه: بعد إنشاء المشرف الجديد، سيتم تسجيل خروجك تلقائياً. يرجى تسجيل الدخول مرة أخرى.
                  </p>
                </div>
                
                <div className="border-t pt-4 mt-4">
                  <p className="text-xs text-gray-500"> يمكنك أيضاً تغيير دور أي مستخدم من تبويب "المستخدمين"</p>
                </div>
              </div>
            )}
            
            <div className="space-y-4">
              {admins.map(admin => (
                <div key={admin.uid} className="bg-white rounded-2xl shadow overflow-hidden">
                  {/* رأس المشرف */}
                  <div 
                    className="p-4 cursor-pointer hover:bg-gray-50"
                    onClick={() => setExpandedAdmin(expandedAdmin === admin.uid ? null : admin.uid)}
                  >
                    <div className="flex items-center justify-between">
                      <div className="flex items-center gap-3">
                        <div className="w-12 h-12 bg-purple-100 rounded-full flex items-center justify-center text-2xl">
                          
                        </div>
                        <div>
                          <h3 className="font-bold">{admin.name || 'بدون اسم'}</h3>
                          <p className="text-sm text-gray-600">{admin.email}</p>
                        </div>
                      </div>
                      
                      <div className="flex items-center gap-4">
                        {/* الإحصائيات */}
                        <div className="text-left">
                          <div className="flex items-center gap-2">
                            <Wallet className="w-4 h-4 text-green-600" />
                            <span className="font-bold text-green-600">{admin.walletBalance.toFixed(2)} ر.س</span>
                          </div>
                          <p className="text-xs text-gray-500">
                            إجمالي: {admin.totalEarnings.toFixed(2)} ر.س | {admin.restaurantsCount} مطعم
                          </p>
                        </div>
                        
                        {expandedAdmin === admin.uid ? (
                          <ChevronUp className="w-5 h-5 text-gray-400" />
                        ) : (
                          <ChevronDown className="w-5 h-5 text-gray-400" />
                        )}
                      </div>
                    </div>
                  </div>
                  
                  {/* المطاعم التابعة */}
                  {expandedAdmin === admin.uid && (
                    <div className="border-t bg-gray-50 p-4">
                      <h4 className="font-semibold text-sm text-gray-700 mb-3">
                         المطاعم المضافة بواسطة هذا المشرف ({admin.restaurants.length}):
                      </h4>
                      
                      {admin.restaurants.length > 0 ? (
                        <div className="grid md:grid-cols-2 gap-3">
                          {admin.restaurants.map(r => (
                            <div key={r.id} className="bg-white rounded-xl p-3 flex items-center gap-3">
                              <div className="w-10 h-10 rounded-lg bg-gray-100 overflow-hidden">
                                {r.logoUrl ? (
                                  <img src={r.logoUrl} alt={r.name} className="w-full h-full object-cover" />
                                ) : (
                                  <div className="w-full h-full flex items-center justify-center"></div>
                                )}
                              </div>
                              <div>
                                <p className="font-semibold text-sm">{r.name}</p>
                                <p className="text-xs text-gray-500">{r.city || 'بدون مدينة'}</p>
                              </div>
                            </div>
                          ))}
                        </div>
                      ) : (
                        <p className="text-gray-500 text-sm">لم يضف أي مطاعم بعد</p>
                      )}
                      
                      {/* ملخص العمولات */}
                      <div className="mt-4 pt-3 border-t">
                        <div className="grid grid-cols-3 gap-3 text-center">
                          <div className="bg-green-100 rounded-lg p-2">
                            <p className="font-bold text-green-700">{admin.walletBalance.toFixed(2)}</p>
                            <p className="text-xs text-gray-600">الرصيد الحالي</p>
                          </div>
                          <div className="bg-blue-100 rounded-lg p-2">
                            <p className="font-bold text-blue-700">{admin.totalEarnings.toFixed(2)}</p>
                            <p className="text-xs text-gray-600">إجمالي الأرباح</p>
                          </div>
                          <div className="bg-purple-100 rounded-lg p-2">
                            <p className="font-bold text-purple-700">
                              {orders.filter(o => o.referredBy === admin.uid).length}
                            </p>
                            <p className="text-xs text-gray-600">طلبات من مطاعمه</p>
                          </div>
                        </div>
                      </div>
                    </div>
                  )}
                </div>
              ))}
              
              {admins.length === 0 && (
                <div className="text-center py-12 text-gray-500 bg-white rounded-2xl">
                  لا يوجد مشرفين مسجلين
                </div>
              )}
            </div>
          </div>
        )}

        {/* ===== الإعدادات ===== */}
        {activeTab === 'settings' && (
          <div className="space-y-6">
            <div className="flex items-center justify-between">
              <h2 className="text-xl font-bold"> إعدادات التطبيق</h2>
              {!editingSettings ? (
                <button
                  onClick={() => setEditingSettings(true)}
                  className="bg-primary hover:bg-sky-600 text-white px-4 py-2 rounded-xl"
                >
                   تعديل
                </button>
              ) : (
                <div className="flex gap-2">
                  <button
                    onClick={() => { setEditingSettings(false); setSettingsForm(settings) }}
                    className="bg-gray-500 text-white px-4 py-2 rounded-xl"
                  >
                    إلغاء
                  </button>
                  <button
                    onClick={handleSaveSettings}
                    className="bg-green-600 text-white px-4 py-2 rounded-xl"
                  >
                     حفظ
                  </button>
                </div>
              )}
            </div>
            
            <div className="bg-white rounded-2xl shadow p-6">
              <div className="grid md:grid-cols-2 lg:grid-cols-3 gap-6">
                {/* رسوم التوصيل */}
                <div>
                  <label className="text-sm text-gray-600 block mb-1"> رسوم التوصيل (ر.س)</label>
                  {editingSettings ? (
                    <input
                      type="number"
                      value={settingsForm.deliveryFee || 0}
                      onChange={e => setSettingsForm({ ...settingsForm, deliveryFee: Number(e.target.value) })}
                      className="w-full border rounded-xl p-3"
                    />
                  ) : (
                    <p className="text-2xl font-bold">{settings.deliveryFee || 7} ر.س</p>
                  )}
                </div>

                {/* رسوم التطبيق */}
                <div>
                  <label className="text-sm text-gray-600 block mb-1"> رسوم التطبيق / منتج (ر.س)</label>
                  {editingSettings ? (
                    <input
                      type="number"
                      step="0.1"
                      value={settingsForm.platformFee || 1.0}
                      onChange={e => setSettingsForm({ ...settingsForm, platformFee: Number(e.target.value) })}
                      className="w-full border rounded-xl p-3"
                    />
                  ) : (
                    <p className="text-2xl font-bold">{settings.platformFee || 1.0} ر.س/منتج</p>
                  )}
                </div>

                {/* عمولة المشرف */}
                <div>
                  <label className="text-sm text-gray-600 block mb-1"> عمولة المشرف / منتج (ر.س)</label>
                  {editingSettings ? (
                    <input
                      type="number"
                      step="0.05"
                      value={settingsForm.adminCommissionRate || 0.75}
                      onChange={e => setSettingsForm({ ...settingsForm, adminCommissionRate: Number(e.target.value) })}
                      className="w-full border rounded-xl p-3"
                    />
                  ) : (
                    <p className="text-2xl font-bold">{settings.adminCommissionRate || 0.75} ر.س/منتج</p>
                  )}
                </div>

                {/* الحد الأدنى للطلب */}
                <div>
                  <label className="text-sm text-gray-600 block mb-1"> الحد الأدنى للطلب</label>
                  {editingSettings ? (
                    <input
                      type="number"
                      value={settingsForm.minOrderAmount || 0}
                      onChange={e => setSettingsForm({ ...settingsForm, minOrderAmount: Number(e.target.value) })}
                      className="w-full border rounded-xl p-3"
                    />
                  ) : (
                    <p className="text-2xl font-bold">{settings.minOrderAmount || 20} ر.س</p>
                  )}
                </div>

                {/* ساعات العمل */}
                <div>
                  <label className="text-sm text-gray-600 block mb-1"> ساعات العمل</label>
                  {editingSettings ? (
                    <div className="flex gap-2">
                      <input
                        type="time"
                        value={settingsForm.workingHours?.open || '09:00'}
                        onChange={e => setSettingsForm({ ...settingsForm, workingHours: { ...settingsForm.workingHours!, open: e.target.value } })}
                        className="flex-1 border rounded-xl p-3"
                      />
                      <input
                        type="time"
                        value={settingsForm.workingHours?.close || '23:00'}
                        onChange={e => setSettingsForm({ ...settingsForm, workingHours: { ...settingsForm.workingHours!, close: e.target.value } })}
                        className="flex-1 border rounded-xl p-3"
                      />
                    </div>
                  ) : (
                    <p className="text-2xl font-bold">
                      {settings.workingHours?.open || '09:00'} - {settings.workingHours?.close || '23:00'}
                    </p>
                  )}
                </div>

                {/* وضع الصيانة */}
                <div>
                  <label className="text-sm text-gray-600 block mb-1"> وضع الصيانة</label>
                  {editingSettings ? (
                    <label className="flex items-center gap-2 cursor-pointer">
                      <input
                        type="checkbox"
                        checked={settingsForm.maintenanceMode || false}
                        onChange={e => setSettingsForm({ ...settingsForm, maintenanceMode: e.target.checked })}
                        className="w-6 h-6"
                      />
                      <span className="text-lg">{settingsForm.maintenanceMode ? 'مفعّل' : 'معطّل'}</span>
                    </label>
                  ) : (
                    <p className={`text-2xl font-bold ${settings.maintenanceMode ? 'text-red-600' : 'text-green-600'}`}>
                      {settings.maintenanceMode ? ' مفعّل' : ' معطّل'}
                    </p>
                  )}
                </div>
              </div>
            </div>

            {/* شرح نظام العمولات */}
            <div className="bg-sky-50 border-l-4 border-sky-500 rounded-lg p-6">
              <h3 className="font-bold text-sky-900 mb-3"> نظام العمولات (لكل منتج = 1.75 ر.س):</h3>
              <div className="text-sky-800 space-y-2">
                <p>• <strong>رسوم التطبيق:</strong> {settings.platformFee || 1.0} ر.س × عدد المنتجات</p>
                <p>• <strong>عمولة المشرف:</strong> {settings.adminCommissionRate || 0.75} ر.س × عدد المنتجات</p>
                <div className="bg-white rounded-xl p-4 mt-3">
                  <p className="font-bold mb-2"> مثال: طلب فيه 5 منتجات</p>
                  <p>• <strong>إذا المطعم مضاف من مشرف:</strong></p>
                  <ul className="mr-6 list-disc text-sm">
                    <li>المشرف يحصل على: 5 × {settings.adminCommissionRate || 0.75} = <strong>{(5 * (settings.adminCommissionRate || 0.75)).toFixed(2)} ر.س</strong></li>
                    <li>التطبيق يحصل على: 5 × {settings.platformFee || 1.0} = <strong>{(5 * (settings.platformFee || 1.0)).toFixed(2)} ر.س</strong></li>
                    <li className="text-green-700">المجموع: <strong>{(5 * 1.75).toFixed(2)} ر.س</strong></li>
                  </ul>
                  <p className="mt-2">• <strong>إذا المطعم مضاف من المطور:</strong></p>
                  <ul className="mr-6 list-disc text-sm">
                    <li>التطبيق يحصل على كل شيء: 5 × 1.75 = <strong>{(5 * 1.75).toFixed(2)} ر.س</strong></li>
                  </ul>
                </div>
              </div>
            </div>
          </div>
        )}

        {/* ===== المهام ===== */}
        {activeTab === 'tasks' && (
          <div className="space-y-6">
            <div className="flex items-center justify-between">
              <h2 className="text-xl font-bold"> إدارة المهام اليومية</h2>
              <button
                onClick={() => setShowAddTask(true)}
                className="flex items-center gap-2 bg-primary hover:bg-sky-600 text-white px-4 py-2 rounded-xl font-semibold transition"
              >
                <Plus className="w-5 h-5" />
                مهمة جديدة
              </button>
            </div>

            {/* فلترة المهام */}
            <div className="flex flex-wrap gap-2">
              {(['all', 'pending', 'in_progress', 'completed', 'cancelled'] as const).map(filter => (
                <button
                  key={filter}
                  onClick={() => setTaskFilter(filter)}
                  className={`px-4 py-2 rounded-xl font-semibold transition ${
                    taskFilter === filter
                      ? 'bg-primary text-white'
                      : 'bg-gray-100 text-gray-700 hover:bg-gray-200'
                  }`}
                >
                  {filter === 'all' && ' الكل'}
                  {filter === 'pending' && ' قيد الانتظار'}
                  {filter === 'in_progress' && ' جاري التنفيذ'}
                  {filter === 'completed' && ' مكتملة'}
                  {filter === 'cancelled' && ' ملغاة'}
                </button>
              ))}
            </div>

            {/* إحصائيات المهام */}
            <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
              <div className="bg-yellow-50 rounded-xl p-4 text-center">
                <p className="text-2xl font-bold text-yellow-600">
                  {tasks.filter(t => t.status === 'pending').length}
                </p>
                <p className="text-sm text-yellow-700">قيد الانتظار</p>
              </div>
              <div className="bg-blue-50 rounded-xl p-4 text-center">
                <p className="text-2xl font-bold text-blue-600">
                  {tasks.filter(t => t.status === 'in_progress').length}
                </p>
                <p className="text-sm text-blue-700">جاري التنفيذ</p>
              </div>
              <div className="bg-green-50 rounded-xl p-4 text-center">
                <p className="text-2xl font-bold text-green-600">
                  {tasks.filter(t => t.status === 'completed').length}
                </p>
                <p className="text-sm text-green-700">مكتملة</p>
              </div>
              <div className="bg-red-50 rounded-xl p-4 text-center">
                <p className="text-2xl font-bold text-red-600">
                  {tasks.filter(t => t.status === 'cancelled').length}
                </p>
                <p className="text-sm text-red-700">ملغاة</p>
              </div>
            </div>

            {/* قائمة المهام */}
            <div className="bg-white rounded-2xl shadow-lg overflow-hidden">
              {tasks
                .filter(t => taskFilter === 'all' || t.status === taskFilter)
                .length === 0 ? (
                <div className="p-8 text-center text-gray-500">
                  <p className="text-4xl mb-2"></p>
                  <p>لا توجد مهام {taskFilter !== 'all' && 'في هذه الفئة'}</p>
                </div>
              ) : (
                <div className="divide-y">
                  {tasks
                    .filter(t => taskFilter === 'all' || t.status === taskFilter)
                    .map(task => {
                      const admin = users.find(u => u.uid === task.assignedTo)
                      return (
                        <div key={task.id} className="p-4 hover:bg-gray-50">
                          <div className="flex items-start justify-between gap-4">
                            <div className="flex-1">
                              <div className="flex items-center gap-2 mb-1">
                                <span className={`px-2 py-0.5 rounded text-xs font-semibold ${
                                  task.priority === 'high' ? 'bg-red-100 text-red-700' :
                                  task.priority === 'medium' ? 'bg-yellow-100 text-yellow-700' :
                                  'bg-gray-100 text-gray-700'
                                }`}>
                                  {task.priority === 'high' ? ' عالية' : task.priority === 'medium' ? ' متوسطة' : ' منخفضة'}
                                </span>
                                <span className={`px-2 py-0.5 rounded text-xs font-semibold ${
                                  task.status === 'pending' ? 'bg-yellow-100 text-yellow-700' :
                                  task.status === 'in_progress' ? 'bg-blue-100 text-blue-700' :
                                  task.status === 'completed' ? 'bg-green-100 text-green-700' :
                                  'bg-red-100 text-red-700'
                                }`}>
                                  {task.status === 'pending' && ' قيد الانتظار'}
                                  {task.status === 'in_progress' && ' جاري التنفيذ'}
                                  {task.status === 'completed' && ' مكتملة'}
                                  {task.status === 'cancelled' && ' ملغاة'}
                                </span>
                              </div>
                              <h3 className="font-bold text-gray-800">{task.title}</h3>
                              {task.description && (
                                <p className="text-sm text-gray-600 mt-1">{task.description}</p>
                              )}
                              <div className="flex flex-wrap gap-3 mt-2 text-xs text-gray-500">
                                <span> {admin?.name || task.assignedToName || 'غير محدد'}</span>
                                {task.dueDate && (
                                  <span> {new Date(task.dueDate).toLocaleDateString('ar-SA')}</span>
                                )}
                                <span> {task.createdAt?.toDate?.()?.toLocaleDateString('ar-SA') || 'غير محدد'}</span>
                              </div>
                              {task.notes && (
                                <p className="text-sm text-gray-500 mt-2 bg-gray-50 p-2 rounded"> {task.notes}</p>
                              )}
                            </div>
                            <div className="flex flex-col gap-2">
                              {task.status === 'pending' && (
                                <button
                                  onClick={async () => {
                                    try {
                                      await updateDoc(doc(db, 'tasks', task.id), {
                                        status: 'in_progress',
                                        updatedAt: serverTimestamp()
                                      })
                                      toast.success('تم بدء المهمة')
                                      loadData()
                                    } catch (err) {
                                      toast.error('فشل في تحديث المهمة')
                                    }
                                  }}
                                  className="text-blue-600 hover:bg-blue-50 p-2 rounded-lg transition"
                                  title="بدء المهمة"
                                >
                                  
                                </button>
                              )}
                              {(task.status === 'pending' || task.status === 'in_progress') && (
                                <>
                                  <button
                                    onClick={async () => {
                                      try {
                                        await updateDoc(doc(db, 'tasks', task.id), {
                                          status: 'completed',
                                          completedAt: serverTimestamp(),
                                          updatedAt: serverTimestamp()
                                        })
                                        toast.success('تم إكمال المهمة')
                                        loadData()
                                      } catch (err) {
                                        toast.error('فشل في تحديث المهمة')
                                      }
                                    }}
                                    className="text-green-600 hover:bg-green-50 p-2 rounded-lg transition"
                                    title="إكمال المهمة"
                                  >
                                    
                                  </button>
                                  <button
                                    onClick={async () => {
                                      const confirmed = await dialog.confirm('هل تريد إلغاء هذه المهمة؟', { dangerous: true })
                                      if (!confirmed) return
                                      try {
                                        await updateDoc(doc(db, 'tasks', task.id), {
                                          status: 'cancelled',
                                          updatedAt: serverTimestamp()
                                        })
                                        toast.success('تم إلغاء المهمة')
                                        loadData()
                                      } catch (err) {
                                        toast.error('فشل في إلغاء المهمة')
                                      }
                                    }}
                                    className="text-red-600 hover:bg-red-50 p-2 rounded-lg transition"
                                    title="إلغاء المهمة"
                                  >
                                    
                                  </button>
                                </>
                              )}
                              <button
                                onClick={async () => {
                                  const confirmed = await dialog.confirm('هل تريد حذف هذه المهمة نهائياً؟', { dangerous: true })
                                  if (!confirmed) return
                                  try {
                                    await deleteDoc(doc(db, 'tasks', task.id))
                                    toast.success('تم حذف المهمة')
                                    loadData()
                                  } catch (err) {
                                    toast.error('فشل في حذف المهمة')
                                  }
                                }}
                                className="text-gray-400 hover:text-red-600 hover:bg-red-50 p-2 rounded-lg transition"
                                title="حذف المهمة"
                              >
                                
                              </button>
                            </div>
                          </div>
                        </div>
                      )
                    })}
                </div>
              )}
            </div>

            {/* نموذج إضافة مهمة */}
            {showAddTask && (
              <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4">
                <div className="bg-white rounded-2xl w-full max-w-lg p-6">
                  <h3 className="text-xl font-bold mb-4"> إضافة مهمة جديدة</h3>
                  <div className="space-y-4">
                    <div>
                      <label className="block text-sm font-semibold mb-1">عنوان المهمة *</label>
                      <input
                        type="text"
                        value={newTaskTitle}
                        onChange={e => setNewTaskTitle(e.target.value)}
                        className="w-full border rounded-xl px-4 py-2"
                        placeholder="مثال: متابعة طلبات المطعم الجديد"
                      />
                    </div>
                    <div>
                      <label className="block text-sm font-semibold mb-1">الوصف</label>
                      <textarea
                        value={newTaskDescription}
                        onChange={e => setNewTaskDescription(e.target.value)}
                        className="w-full border rounded-xl px-4 py-2 h-24"
                        placeholder="تفاصيل المهمة..."
                      />
                    </div>
                    <div>
                      <label className="block text-sm font-semibold mb-1">تعيين إلى *</label>
                      <select
                        value={newTaskAssignedTo}
                        onChange={e => setNewTaskAssignedTo(e.target.value)}
                        className="w-full border rounded-xl px-4 py-2"
                      >
                        <option value="">-- اختر مشرف --</option>
                        {users
                          .filter(u => u.role === 'admin')
                          .map(admin => (
                            <option key={admin.uid} value={admin.uid}>
                              {admin.name || admin.email}
                            </option>
                          ))}
                      </select>
                    </div>
                    <div className="grid grid-cols-2 gap-4">
                      <div>
                        <label className="block text-sm font-semibold mb-1">الأولوية</label>
                        <select
                          value={newTaskPriority}
                          onChange={e => setNewTaskPriority(e.target.value as 'low' | 'medium' | 'high')}
                          className="w-full border rounded-xl px-4 py-2"
                        >
                          <option value="low"> منخفضة</option>
                          <option value="medium"> متوسطة</option>
                          <option value="high"> عالية</option>
                        </select>
                      </div>
                      <div>
                        <label className="block text-sm font-semibold mb-1">تاريخ الاستحقاق</label>
                        <input
                          type="date"
                          value={newTaskDueDate}
                          onChange={e => setNewTaskDueDate(e.target.value)}
                          className="w-full border rounded-xl px-4 py-2"
                        />
                      </div>
                    </div>
                  </div>
                  <div className="flex gap-3 mt-6">
                    <button
                      onClick={() => {
                        setShowAddTask(false)
                        setNewTaskTitle('')
                        setNewTaskDescription('')
                        setNewTaskAssignedTo('')
                        setNewTaskPriority('medium')
                        setNewTaskDueDate('')
                      }}
                      className="flex-1 bg-gray-100 hover:bg-gray-200 text-gray-700 py-2 rounded-xl font-semibold transition"
                    >
                      إلغاء
                    </button>
                    <button
                      onClick={async () => {
                        if (!newTaskTitle.trim() || !newTaskAssignedTo) {
                          toast.error('يرجى ملء الحقول المطلوبة')
                          return
                        }
                        setCreatingTask(true)
                        try {
                          const assignedAdmin = users.find(u => u.uid === newTaskAssignedTo)
                          await addDoc(collection(db, 'tasks'), {
                            title: newTaskTitle.trim(),
                            description: newTaskDescription.trim(),
                            assignedTo: newTaskAssignedTo,
                            assignedToName: assignedAdmin?.name || assignedAdmin?.email || '',
                            status: 'pending',
                            priority: newTaskPriority,
                            dueDate: newTaskDueDate || null,
                            createdBy: user?.uid,
                            createdAt: serverTimestamp(),
                            updatedAt: serverTimestamp(),
                            completedAt: null,
                            notes: ''
                          })
                          toast.success('تم إنشاء المهمة بنجاح')
                          setShowAddTask(false)
                          setNewTaskTitle('')
                          setNewTaskDescription('')
                          setNewTaskAssignedTo('')
                          setNewTaskPriority('medium')
                          setNewTaskDueDate('')
                          loadData()
                        } catch (err) {
                          console.error(err)
                          toast.error('فشل في إنشاء المهمة')
                        } finally {
                          setCreatingTask(false)
                        }
                      }}
                      disabled={creatingTask}
                      className="flex-1 bg-primary hover:bg-sky-600 text-white py-2 rounded-xl font-semibold transition disabled:opacity-50"
                    >
                      {creatingTask ? 'جارِ الإنشاء...' : 'إنشاء المهمة'}
                    </button>
                  </div>
                </div>
              </div>
            )}
          </div>
        )}

        {/* ===== الأدوات ===== */}
        {activeTab === 'tools' && (
          <div className="space-y-6">
            <h2 className="text-xl font-bold"> أدوات النظام</h2>

            {/* أدوات إدارة البيانات */}
            <div className="bg-white rounded-2xl shadow-lg p-6">
              <h3 className="text-lg font-bold mb-4"> إدارة البيانات</h3>
              <div className="grid md:grid-cols-2 lg:grid-cols-3 gap-4">
                {/* تصدير البيانات */}
                <button
                  onClick={() => {
                    const data = {
                      exportDate: new Date().toISOString(),
                      users: users.length,
                      restaurants: restaurants.length,
                      orders: orders.length,
                      admins: admins.length,
                      stats,
                      settings,
                    }
                    const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' })
                    const url = URL.createObjectURL(blob)
                    const a = document.createElement('a')
                    a.href = url
                    a.download = `app-data-${new Date().toISOString().split('T')[0]}.json`
                    a.click()
                    toast.success('تم تصدير البيانات بنجاح')
                  }}
                  className="flex items-center gap-3 bg-blue-100 hover:bg-blue-200 text-blue-800 p-4 rounded-xl transition"
                >
                  <span className="text-2xl"></span>
                  <div className="text-right">
                    <p className="font-bold">تصدير البيانات</p>
                    <p className="text-xs opacity-75">تحميل ملخص JSON</p>
                  </div>
                </button>

                {/* تصدير الطلبات */}
                <button
                  onClick={() => {
                    const csv = [
                      ['رقم الطلب', 'المطعم', 'المبلغ', 'الحالة', 'التاريخ'].join(','),
                      ...orders.map(o => [
                        o.id.slice(-8),
                        o.restaurantName || 'غير محدد',
                        o.total,
                        o.status,
                        o.createdAt?.toDate?.()?.toLocaleDateString('ar-SA') || ''
                      ].join(','))
                    ].join('\n')
                    const blob = new Blob(['\ufeff' + csv], { type: 'text/csv;charset=utf-8' })
                    const url = URL.createObjectURL(blob)
                    const a = document.createElement('a')
                    a.href = url
                    a.download = `orders-${new Date().toISOString().split('T')[0]}.csv`
                    a.click()
                    toast.success('تم تصدير الطلبات بنجاح')
                  }}
                  className="flex items-center gap-3 bg-green-100 hover:bg-green-200 text-green-800 p-4 rounded-xl transition"
                >
                  <span className="text-2xl"></span>
                  <div className="text-right">
                    <p className="font-bold">تصدير الطلبات</p>
                    <p className="text-xs opacity-75">ملف CSV للإكسل</p>
                  </div>
                </button>

                {/* تصدير المستخدمين */}
                <button
                  onClick={() => {
                    const csv = [
                      ['الاسم', 'الإيميل', 'الدور', 'الهاتف'].join(','),
                      ...users.map(u => [
                        u.name || 'بدون اسم',
                        u.email,
                        u.role,
                        u.phone || ''
                      ].join(','))
                    ].join('\n')
                    const blob = new Blob(['\ufeff' + csv], { type: 'text/csv;charset=utf-8' })
                    const url = URL.createObjectURL(blob)
                    const a = document.createElement('a')
                    a.href = url
                    a.download = `users-${new Date().toISOString().split('T')[0]}.csv`
                    a.click()
                    toast.success('تم تصدير المستخدمين بنجاح')
                  }}
                  className="flex items-center gap-3 bg-purple-100 hover:bg-purple-200 text-purple-800 p-4 rounded-xl transition"
                >
                  <span className="text-2xl"></span>
                  <div className="text-right">
                    <p className="font-bold">تصدير المستخدمين</p>
                    <p className="text-xs opacity-75">ملف CSV للإكسل</p>
                  </div>
                </button>
              </div>
            </div>

            {/* أدوات الصيانة */}
            <div className="bg-white rounded-2xl shadow-lg p-6">
              <h3 className="text-lg font-bold mb-4"> أدوات الصيانة</h3>
              <div className="grid md:grid-cols-2 gap-4">
                {/* إلغاء جميع الطلبات المعلقة */}
                <button
                  onClick={async () => {
                    const pendingOrders = orders.filter(o => o.status === 'pending')
                    if (pendingOrders.length === 0) {
                      toast.info('لا توجد طلبات معلقة')
                      return
                    }
                    const confirmed = await dialog.confirm(
                      `سيتم إلغاء ${pendingOrders.length} طلب معلق. هل أنت متأكد؟`,
                      { title: 'إلغاء الطلبات المعلقة', dangerous: true }
                    )
                    if (!confirmed) return
                    try {
                      await Promise.all(pendingOrders.map(o => 
                        updateDoc(doc(db, 'orders', o.id), { status: 'cancelled', updatedAt: serverTimestamp() })
                      ))
                      toast.success(`تم إلغاء ${pendingOrders.length} طلب`)
                      loadData()
                    } catch (err) {
                      toast.error('فشل في إلغاء الطلبات')
                    }
                  }}
                  className="flex items-center gap-3 bg-yellow-100 hover:bg-yellow-200 text-yellow-800 p-4 rounded-xl transition"
                >
                  <span className="text-2xl"></span>
                  <div className="text-right">
                    <p className="font-bold">إلغاء الطلبات المعلقة</p>
                    <p className="text-xs opacity-75">{orders.filter(o => o.status === 'pending').length} طلب معلق</p>
                  </div>
                </button>

                {/* تنظيف الطلبات القديمة */}
                <button
                  onClick={async () => {
                    const oldDate = new Date()
                    oldDate.setMonth(oldDate.getMonth() - 3)
                    const oldOrders = orders.filter(o => {
                      const orderDate = o.createdAt?.toDate?.() || new Date()
                      return orderDate < oldDate && (o.status === 'delivered' || o.status === 'cancelled')
                    })
                    if (oldOrders.length === 0) {
                      toast.info('لا توجد طلبات قديمة')
                      return
                    }
                    const confirmed = await dialog.confirm(
                      `سيتم حذف ${oldOrders.length} طلب قديم (أكثر من 3 أشهر). هل أنت متأكد؟`,
                      { title: 'حذف الطلبات القديمة', dangerous: true }
                    )
                    if (!confirmed) return
                    try {
                      await Promise.all(oldOrders.map(o => deleteDoc(doc(db, 'orders', o.id))))
                      toast.success(`تم حذف ${oldOrders.length} طلب قديم`)
                      loadData()
                    } catch (err) {
                      toast.error('فشل في حذف الطلبات')
                    }
                  }}
                  className="flex items-center gap-3 bg-orange-100 hover:bg-orange-200 text-orange-800 p-4 rounded-xl transition"
                >
                  <span className="text-2xl"></span>
                  <div className="text-right">
                    <p className="font-bold">تنظيف الطلبات القديمة</p>
                    <p className="text-xs opacity-75">حذف أقدم من 3 أشهر</p>
                  </div>
                </button>
              </div>
            </div>

            {/* روابط سريعة */}
            <div className="bg-white rounded-2xl shadow-lg p-6">
              <h3 className="text-lg font-bold mb-4"> روابط سريعة</h3>
              <div className="grid md:grid-cols-2 lg:grid-cols-4 gap-4">
                <a
                  href={`https://console.firebase.google.com/project/${firebaseConfig.projectId}/firestore`}
                  target="_blank"
                  rel="noopener noreferrer"
                  className="flex items-center gap-3 bg-blue-50 hover:bg-blue-100 text-blue-800 p-4 rounded-xl transition"
                >
                  <span className="text-2xl"></span>
                  <span className="font-semibold">Firestore</span>
                </a>
                <a
                  href={`https://console.firebase.google.com/project/${firebaseConfig.projectId}/authentication/users`}
                  target="_blank"
                  rel="noopener noreferrer"
                  className="flex items-center gap-3 bg-green-50 hover:bg-green-100 text-green-800 p-4 rounded-xl transition"
                >
                  <span className="text-2xl"></span>
                  <span className="font-semibold">Authentication</span>
                </a>
                <a
                  href={`https://console.firebase.google.com/project/${firebaseConfig.projectId}/storage`}
                  target="_blank"
                  rel="noopener noreferrer"
                  className="flex items-center gap-3 bg-purple-50 hover:bg-purple-100 text-purple-800 p-4 rounded-xl transition"
                >
                  <span className="text-2xl"></span>
                  <span className="font-semibold">Storage</span>
                </a>
                <a
                  href={`https://console.firebase.google.com/project/${firebaseConfig.projectId}/hosting`}
                  target="_blank"
                  rel="noopener noreferrer"
                  className="flex items-center gap-3 bg-orange-50 hover:bg-orange-100 text-orange-800 p-4 rounded-xl transition"
                >
                  <span className="text-2xl"></span>
                  <span className="font-semibold">Hosting</span>
                </a>
              </div>
            </div>

            {/* معلومات النظام */}
            <div className="bg-gray-50 rounded-2xl p-6">
              <h3 className="text-lg font-bold mb-4">ℹ معلومات النظام</h3>
              <div className="grid md:grid-cols-2 gap-4 text-sm">
                <div>
                  <p className="text-gray-500">Project ID</p>
                  <p className="font-mono">{firebaseConfig.projectId}</p>
                </div>
                <div>
                  <p className="text-gray-500">Storage Bucket</p>
                  <p className="font-mono">{firebaseConfig.storageBucket}</p>
                </div>
                <div>
                  <p className="text-gray-500">إصدار التطبيق</p>
                  <p className="font-bold">{settings.appVersion || '1.0.0'}</p>
                </div>
                <div>
                  <p className="text-gray-500">وضع الصيانة</p>
                  <p className={`font-bold ${settings.maintenanceMode ? 'text-red-600' : 'text-green-600'}`}>
                    {settings.maintenanceMode ? ' مفعّل' : ' معطّل'}
                  </p>
                </div>
              </div>
            </div>
          </div>
        )}

        {/* ===== مراجعة التراخيص ===== */}
        {activeTab === 'licenses' && (
          <LicensesReviewSection 
            restaurants={restaurants} 
            onUpdate={handleRefresh}
            toast={toast}
            dialog={dialog}
          />
        )}

        {/* ===== طلبات الباقات ===== */}
        {activeTab === 'packages' && (
          <PackageRequestsSection
            packageRequests={packageRequests}
            onUpdate={handleRefresh}
            toast={toast}
            dialog={dialog}
            storage={storage}
          />
        )}

        {/* ===== إعدادات أسعار الباقات ===== */}
        {activeTab === 'packageSettings' && (
          <PackageSettingsSection
            toast={toast}
            dialog={dialog}
          />
        )}

        {/* ===== مراقبة المتاجر ===== */}
        {activeTab === 'storeAnalytics' && (
          <StoreAnalyticsSection
            restaurants={restaurants}
            orders={orders}
            toast={toast}
          />
        )}

        {/* ===== سجل العمليات ===== */}
        {activeTab === 'activityLog' && (
          <div className="space-y-6">
            <div className="flex items-center justify-between flex-wrap gap-4">
              <h2 className="text-xl font-bold flex items-center gap-2">
                 سجل العمليات
                <span className="text-sm bg-gray-200 px-3 py-1 rounded-full">
                  {activityLogs.length} عملية
                </span>
              </h2>
              <div className="flex gap-2">
                <select
                  value={logFilter}
                  onChange={e => setLogFilter(e.target.value)}
                  className="border rounded-xl px-4 py-2"
                >
                  <option value="all">جميع العمليات</option>
                  <option value="activate">تفعيل</option>
                  <option value="deactivate">إيقاف</option>
                  <option value="create">إنشاء</option>
                  <option value="update">تحديث</option>
                  <option value="delete">حذف</option>
                  <option value="package_activate">تفعيل باقة</option>
                  <option value="package_cancel">إلغاء باقة</option>
                  <option value="role_change">تغيير دور</option>
                </select>
                <button
                  onClick={loadActivityLogs}
                  disabled={loadingLogs}
                  className="bg-primary hover:bg-sky-600 text-white px-4 py-2 rounded-xl"
                >
                  {loadingLogs ? '' : ''} تحديث
                </button>
              </div>
            </div>

            {loadingLogs ? (
              <div className="text-center py-12">
                <div className="w-10 h-10 border-4 border-sky-200 border-t-sky-500 rounded-full animate-spin mx-auto mb-4" />
                <p className="text-gray-500">جارِ تحميل السجل...</p>
              </div>
            ) : activityLogs.length === 0 ? (
              <div className="text-center py-12 bg-gray-50 rounded-2xl">
                <p className="text-gray-500 text-lg"> لا توجد عمليات مسجلة بعد</p>
                <p className="text-gray-400 text-sm mt-2">سيتم تسجيل جميع عمليات التفعيل والإيقاف والتعديل هنا</p>
              </div>
            ) : (
              <div className="space-y-3">
                {activityLogs
                  .filter(log => logFilter === 'all' || log.action === logFilter)
                  .map(log => (
                    <div key={log.id} className={`bg-white rounded-xl shadow p-4 border-r-4 ${
                      log.action === 'activate' || log.action === 'package_activate' ? 'border-green-500' :
                      log.action === 'deactivate' || log.action === 'package_cancel' || log.action === 'delete' ? 'border-red-500' :
                      log.action === 'create' ? 'border-blue-500' :
                      'border-gray-300'
                    }`}>
                      <div className="flex items-start justify-between gap-4">
                        <div className="flex-1">
                          <div className="flex items-center gap-2 mb-2">
                            <span className={`px-2 py-1 rounded-full text-xs font-bold ${
                              log.action === 'activate' ? 'bg-green-100 text-green-700' :
                              log.action === 'deactivate' ? 'bg-red-100 text-red-700' :
                              log.action === 'create' ? 'bg-blue-100 text-blue-700' :
                              log.action === 'update' ? 'bg-yellow-100 text-yellow-700' :
                              log.action === 'delete' ? 'bg-red-100 text-red-700' :
                              log.action === 'package_activate' ? 'bg-amber-100 text-amber-700' :
                              log.action === 'package_cancel' ? 'bg-orange-100 text-orange-700' :
                              log.action === 'role_change' ? 'bg-purple-100 text-purple-700' :
                              'bg-gray-100 text-gray-700'
                            }`}>
                              {log.action === 'activate' && ' تفعيل'}
                              {log.action === 'deactivate' && ' إيقاف'}
                              {log.action === 'create' && ' إنشاء'}
                              {log.action === 'update' && ' تحديث'}
                              {log.action === 'delete' && ' حذف'}
                              {log.action === 'package_activate' && ' تفعيل باقة'}
                              {log.action === 'package_cancel' && ' إلغاء باقة'}
                              {log.action === 'role_change' && ' تغيير دور'}
                            </span>
                            <span className="text-xs bg-gray-100 text-gray-600 px-2 py-1 rounded-full">
                              {log.targetType === 'user' && ' مستخدم'}
                              {log.targetType === 'restaurant' && ' مطعم'}
                              {log.targetType === 'order' && ' طلب'}
                              {log.targetType === 'package' && ' باقة'}
                              {log.targetType === 'settings' && ' إعدادات'}
                            </span>
                          </div>
                          <p className="font-bold text-gray-800">{log.targetName || log.targetId}</p>
                          {log.details && <p className="text-sm text-gray-600 mt-1">{log.details}</p>}
                          <p className="text-xs text-gray-400 mt-2">
                            بواسطة: {log.performedByName || 'غير معروف'}
                          </p>
                        </div>
                        <div className="text-left text-xs text-gray-400 whitespace-nowrap">
                          {log.createdAt ? new Date(log.createdAt).toLocaleDateString('ar-SA', {
                            year: 'numeric',
                            month: 'short',
                            day: 'numeric',
                            hour: '2-digit',
                            minute: '2-digit',
                          }) : '-'}
                        </div>
                      </div>
                    </div>
                  ))}
              </div>
            )}
          </div>
        )}

        {/* معلومات النظام */}
        <div className="bg-gray-100 rounded-2xl p-4 text-sm">
          <div className="flex flex-wrap gap-4 text-gray-600">
            <span> {user?.email}</span>
            <span> {user?.uid.slice(0, 12)}...</span>
            <span> {new Date().toLocaleDateString('ar-SA')}</span>
          </div>
        </div>
      </div>
    </RoleGate>
  )
}

export default Developer

// ===== مكون مراجعة التراخيص =====
type LicenseRestaurant = {
  id: string
  name: string
  ownerId: string
  email?: string
  phone?: string
  city?: string
  commercialLicenseUrl?: string
  licenseStatus?: 'pending' | 'approved' | 'rejected'
  licenseNotes?: string
}

const LicensesReviewSection: React.FC<{
  restaurants: any[]
  onUpdate: () => void
  toast: any
  dialog: any
}> = ({ restaurants, onUpdate, toast, dialog }) => {
  const [filter, setFilter] = useState<'all' | 'pending' | 'approved' | 'rejected' | 'missing' | 'sent_messages'>('pending')
  const [reviewNotes, setReviewNotes] = useState<Record<string, string>>({})
  const [updating, setUpdating] = useState<string | null>(null)
  const [messageText, setMessageText] = useState('')
  const [sendingTo, setSendingTo] = useState<string | null>(null)
  const [selectedMissing, setSelectedMissing] = useState<Set<string>>(new Set())
  const [bulkMessage, setBulkMessage] = useState('')
  
  // سجل الرسائل المرسلة
  const [sentMessages, setSentMessages] = useState<any[]>([])
  const [loadingMessages, setLoadingMessages] = useState(false)
  const [sendingBulk, setSendingBulk] = useState(false)

  // تحميل الرسائل المرسلة عند اختيار التبويب
  useEffect(() => {
    if (filter === 'sent_messages' && sentMessages.length === 0) {
      loadSentMessages()
    }
  }, [filter])

  const loadSentMessages = async () => {
    setLoadingMessages(true)
    try {
      const q = query(
        collection(db, 'notifications'),
        where('type', '==', 'license_reminder'),
        orderBy('createdAt', 'desc'),
        limit(100)
      )
      const snap = await getDocs(q)
      const messages = snap.docs.map(d => ({
        id: d.id,
        ...d.data(),
        createdAt: d.data().createdAt?.toDate?.() || null,
      }))
      setSentMessages(messages)
    } catch (err: any) {
      console.error('خطأ في تحميل الرسائل:', err)
      // قد يكون الفهرس غير موجود
      toast.warning('تحتاج لإنشاء فهرس مركب لـ notifications (type + createdAt)')
    } finally {
      setLoadingMessages(false)
    }
  }

  // المطاعم التي لديها تراخيص
  const restaurantsWithLicenses = restaurants.filter(
    (r: LicenseRestaurant) => r.commercialLicenseUrl
  ) as LicenseRestaurant[]

  // المطاعم التي لم ترفع التراخيص
  const restaurantsWithoutLicenses = restaurants.filter(
    (r: LicenseRestaurant) => !r.commercialLicenseUrl
  ) as LicenseRestaurant[]

  // فلترة حسب الحالة
  const filteredRestaurants = restaurantsWithLicenses.filter((r: LicenseRestaurant) => {
    if (filter === 'all') return true
    if (filter === 'missing') return false // يتم عرضها في قسم منفصل
    if (filter === 'sent_messages') return false // قسم الرسائل منفصل
    return r.licenseStatus === filter || (!r.licenseStatus && filter === 'pending')
  })

  // عدد كل حالة
  const counts = {
    all: restaurantsWithLicenses.length,
    pending: restaurantsWithLicenses.filter(r => !r.licenseStatus || r.licenseStatus === 'pending').length,
    approved: restaurantsWithLicenses.filter(r => r.licenseStatus === 'approved').length,
    rejected: restaurantsWithLicenses.filter(r => r.licenseStatus === 'rejected').length,
    missing: restaurantsWithoutLicenses.length,
    sent_messages: sentMessages.length,
  }

  // إرسال رسالة لمطعم واحد
  const sendMessageToRestaurant = async (restaurant: LicenseRestaurant, message: string) => {
    if (!message.trim()) {
      toast.warning('يرجى كتابة الرسالة')
      return
    }

    setSendingTo(restaurant.id)
    try {
      await addDoc(collection(db, 'notifications'), {
        type: 'license_reminder',
        recipientId: restaurant.ownerId,
        recipientType: 'owner',
        restaurantId: restaurant.id,
        restaurantName: restaurant.name,
        title: ' تذكير: رفع الترخيص التجاري',
        message: message,
        read: false,
        createdAt: serverTimestamp(),
      })
      toast.success(`تم إرسال الرسالة لـ ${restaurant.name}`)
      setMessageText('')
    } catch (err: any) {
      toast.error('فشل إرسال الرسالة: ' + (err.message || 'خطأ غير معروف'))
    } finally {
      setSendingTo(null)
    }
  }

  // إرسال رسالة جماعية
  const sendBulkMessage = async () => {
    if (!bulkMessage.trim()) {
      toast.warning('يرجى كتابة الرسالة')
      return
    }
    
    const targets = selectedMissing.size > 0 
      ? restaurantsWithoutLicenses.filter(r => selectedMissing.has(r.id))
      : restaurantsWithoutLicenses

    if (targets.length === 0) {
      toast.warning('لا توجد مطاعم لإرسال الرسالة')
      return
    }

    const confirmed = await dialog.confirm(
      `هل أنت متأكد من إرسال الرسالة لـ ${targets.length} مطعم؟`,
      { title: 'إرسال رسالة جماعية' }
    )
    if (!confirmed) return

    setSendingBulk(true)
    try {
      const promises = targets.map(restaurant => 
        addDoc(collection(db, 'notifications'), {
          type: 'license_reminder',
          recipientId: restaurant.ownerId,
          recipientType: 'owner',
          restaurantId: restaurant.id,
          restaurantName: restaurant.name,
          title: ' تذكير: رفع الترخيص التجاري',
          message: bulkMessage,
          read: false,
          createdAt: serverTimestamp(),
        })
      )
      await Promise.all(promises)
      toast.success(`تم إرسال الرسالة لـ ${targets.length} مطعم بنجاح `)
      setBulkMessage('')
      setSelectedMissing(new Set())
    } catch (err: any) {
      toast.error('فشل إرسال بعض الرسائل: ' + (err.message || 'خطأ غير معروف'))
    } finally {
      setSendingBulk(false)
    }
  }

  // تحديد/إلغاء تحديد الكل
  const toggleSelectAll = () => {
    if (selectedMissing.size === restaurantsWithoutLicenses.length) {
      setSelectedMissing(new Set())
    } else {
      setSelectedMissing(new Set(restaurantsWithoutLicenses.map(r => r.id)))
    }
  }

  // تبديل تحديد مطعم
  const toggleSelectRestaurant = (id: string) => {
    const newSet = new Set(selectedMissing)
    if (newSet.has(id)) {
      newSet.delete(id)
    } else {
      newSet.add(id)
    }
    setSelectedMissing(newSet)
  }

  // تحديث حالة الترخيص
  const updateLicenseStatus = async (restaurantId: string, status: 'approved' | 'rejected') => {
    const notes = reviewNotes[restaurantId] || ''
    
    if (status === 'rejected' && !notes.trim()) {
      toast.warning('يرجى كتابة سبب الرفض')
      return
    }

    const actionText = status === 'approved' ? 'الموافقة على' : 'رفض'
    const confirmed = await dialog.confirm(
      `هل أنت متأكد من ${actionText} تراخيص هذا المطعم؟`,
      { title: `${actionText} التراخيص` }
    )
    if (!confirmed) return

    setUpdating(restaurantId)
    try {
      await updateDoc(doc(db, 'restaurants', restaurantId), {
        licenseStatus: status,
        licenseNotes: status === 'rejected' ? notes : '',
        updatedAt: serverTimestamp(),
      })
      toast.success(status === 'approved' ? 'تمت الموافقة على التراخيص ' : 'تم رفض التراخيص')
      setReviewNotes(prev => ({ ...prev, [restaurantId]: '' }))
      onUpdate()
    } catch (err: any) {
      toast.error('فشل التحديث: ' + (err.message || 'خطأ غير معروف'))
    } finally {
      setUpdating(null)
    }
  }

  // حذف الترخيص بالكامل وإرسال رسالة لإعادة الرفع
  const deleteLicenseAndNotify = async (restaurant: LicenseRestaurant, licenseType: 'commercial') => {
    const licenseText = 'السجل التجاري'
    
    const confirmed = await dialog.confirm(
      `هل أنت متأكد من حذف ${licenseText} لـ "${restaurant.name}"؟\nسيتم إرسال إشعار للمطعم لإعادة رفع الترخيص.`,
      { title: ` حذف ${licenseText}` }
    )
    if (!confirmed) return

    setUpdating(restaurant.id)
    try {
      // تحديد الحقول المراد حذفها
      const updateData: any = {
        licenseStatus: null,
        licenseNotes: '',
        updatedAt: serverTimestamp(),
        commercialLicenseUrl: null
      }

      // حذف الترخيص من قاعدة البيانات
      await updateDoc(doc(db, 'restaurants', restaurant.id), updateData)

      // إرسال إشعار للمطعم
      await addDoc(collection(db, 'notifications'), {
        type: 'license_deleted',
        recipientId: restaurant.ownerId,
        recipientType: 'owner',
        restaurantId: restaurant.id,
        restaurantName: restaurant.name,
        title: ` تم حذف ${licenseText}`,
        message: `تم حذف ${licenseText} الخاصة بمطعمك. يرجى إعادة رفع الترخيص الصحيح من صفحة إعدادات المطعم.`,
        read: false,
        createdAt: serverTimestamp(),
      })

      toast.success(`تم حذف ${licenseText} وإرسال إشعار للمطعم `)
      onUpdate()
    } catch (err: any) {
      toast.error('فشل حذف الترخيص: ' + (err.message || 'خطأ غير معروف'))
    } finally {
      setUpdating(null)
    }
  }

  const statusBadge = (status?: string) => {
    switch (status) {
      case 'approved':
        return <span className="inline-flex items-center gap-1 px-2 py-1 rounded-full bg-green-100 text-green-700 text-xs font-semibold"><CheckCircle className="w-3 h-3" /> موافق</span>
      case 'rejected':
        return <span className="inline-flex items-center gap-1 px-2 py-1 rounded-full bg-red-100 text-red-700 text-xs font-semibold"><AlertCircle className="w-3 h-3" /> مرفوض</span>
      default:
        return <span className="inline-flex items-center gap-1 px-2 py-1 rounded-full bg-yellow-100 text-yellow-700 text-xs font-semibold"><Clock className="w-3 h-3" /> قيد المراجعة</span>
    }
  }

  return (
    <div className="space-y-6">
      <div className="flex items-center justify-between flex-wrap gap-4">
        <h2 className="text-xl font-bold flex items-center gap-2">
          <FileCheck className="w-6 h-6 text-sky-500" />
          مراجعة التراخيص
        </h2>
        <div className="flex gap-2 flex-wrap">
          {(['pending', 'approved', 'rejected', 'all', 'missing', 'sent_messages'] as const).map(f => (
            <button
              key={f}
              onClick={() => setFilter(f)}
              className={`px-3 py-1.5 rounded-lg text-sm font-medium transition ${
                filter === f
                  ? f === 'missing' ? 'bg-orange-500 text-white' 
                    : f === 'sent_messages' ? 'bg-purple-500 text-white'
                    : 'bg-sky-500 text-white'
                  : 'bg-gray-100 text-gray-600 hover:bg-gray-200'
              }`}
            >
              {f === 'all' && `الكل (${counts.all})`}
              {f === 'pending' && `قيد المراجعة (${counts.pending})`}
              {f === 'approved' && `موافق (${counts.approved})`}
              {f === 'rejected' && `مرفوض (${counts.rejected})`}
              {f === 'missing' && ` لم يرفع (${counts.missing})`}
              {f === 'sent_messages' && ` الرسائل المرسلة`}
            </button>
          ))}
        </div>
      </div>

      {/* ===== قسم الرسائل المرسلة ===== */}
      {filter === 'sent_messages' && (
        <div className="space-y-4">
          <div className="flex items-center justify-between">
            <h3 className="font-bold text-purple-700 flex items-center gap-2">
               سجل الرسائل المرسلة للمطاعم
            </h3>
            <button
              onClick={loadSentMessages}
              disabled={loadingMessages}
              className="px-4 py-2 bg-purple-100 hover:bg-purple-200 text-purple-700 rounded-xl font-medium transition disabled:opacity-50"
            >
              {loadingMessages ? ' جارِ التحميل...' : ' تحديث'}
            </button>
          </div>

          {loadingMessages ? (
            <div className="text-center py-12">
              <div className="w-10 h-10 border-4 border-purple-200 border-t-purple-500 rounded-full animate-spin mx-auto mb-4" />
              <p className="text-gray-500">جارِ تحميل الرسائل...</p>
            </div>
          ) : sentMessages.length === 0 ? (
            <div className="text-center py-12 bg-gray-50 rounded-2xl">
              <p className="text-gray-500">لا توجد رسائل مرسلة بعد</p>
              <p className="text-gray-400 text-sm mt-2">الرسائل التي ترسلها للمطاعم ستظهر هنا</p>
            </div>
          ) : (
            <div className="space-y-3">
              {sentMessages.map((msg: any) => (
                <div key={msg.id} className="bg-white rounded-xl shadow p-4 border-r-4 border-purple-500">
                  <div className="flex items-start justify-between gap-4">
                    <div className="flex-1">
                      <div className="flex items-center gap-2 mb-2">
                        <span className="font-bold text-gray-800">{msg.restaurantName || 'مطعم'}</span>
                        {msg.read ? (
                          <span className="text-xs bg-green-100 text-green-700 px-2 py-0.5 rounded-full"> مقروءة</span>
                        ) : (
                          <span className="text-xs bg-yellow-100 text-yellow-700 px-2 py-0.5 rounded-full"> لم تُقرأ</span>
                        )}
                      </div>
                      <p className="text-sm text-gray-600 font-semibold mb-1">{msg.title}</p>
                      <p className="text-gray-700 text-sm bg-gray-50 p-3 rounded-lg">{msg.message}</p>
                    </div>
                    <div className="text-left text-xs text-gray-400 whitespace-nowrap">
                      {msg.createdAt ? new Date(msg.createdAt).toLocaleDateString('ar-SA', {
                        year: 'numeric',
                        month: 'short',
                        day: 'numeric',
                        hour: '2-digit',
                        minute: '2-digit',
                      }) : '-'}
                    </div>
                  </div>
                </div>
              ))}
            </div>
          )}
        </div>
      )}

      {/* قسم المطاعم التي لم ترفع التراخيص */}
      {filter === 'missing' && (
        <div className="space-y-4">
          {restaurantsWithoutLicenses.length === 0 ? (
            <div className="text-center py-12 text-gray-400">
              <CheckCircle className="w-16 h-16 mx-auto mb-4 text-green-400" />
              <p className="text-green-600 font-semibold">جميع المطاعم رفعت تراخيصها </p>
            </div>
          ) : (
            <>
              {/* رسالة جماعية */}
              <div className="bg-gradient-to-r from-orange-50 to-amber-50 border border-orange-200 rounded-2xl p-5">
                <h3 className="font-bold text-orange-800 mb-3 flex items-center gap-2">
                   إرسال رسالة جماعية
                </h3>
                <div className="flex items-center gap-3 mb-3">
                  <label className="flex items-center gap-2 cursor-pointer">
                    <input
                      type="checkbox"
                      checked={selectedMissing.size === restaurantsWithoutLicenses.length}
                      onChange={toggleSelectAll}
                      className="w-5 h-5 rounded border-orange-300 text-orange-500 focus:ring-orange-500"
                    />
                    <span className="text-sm text-orange-700">
                      تحديد الكل ({restaurantsWithoutLicenses.length})
                    </span>
                  </label>
                  {selectedMissing.size > 0 && (
                    <span className="text-sm bg-orange-200 text-orange-800 px-2 py-1 rounded-full">
                      محدد: {selectedMissing.size}
                    </span>
                  )}
                </div>
                <textarea
                  placeholder="اكتب الرسالة التي سترسل للمطاعم المحددة (أو جميعها إذا لم تحدد)..."
                  value={bulkMessage}
                  onChange={(e) => setBulkMessage(e.target.value)}
                  className="w-full border border-orange-200 rounded-xl p-3 text-sm resize-none h-24 focus:ring-2 focus:ring-orange-400 focus:border-transparent"
                />
                <button
                  onClick={sendBulkMessage}
                  disabled={sendingBulk || !bulkMessage.trim()}
                  className="mt-3 w-full flex items-center justify-center gap-2 bg-orange-500 hover:bg-orange-600 text-white py-2.5 rounded-xl font-semibold transition disabled:opacity-50 disabled:cursor-not-allowed"
                >
                  {sendingBulk ? (
                    <>
                      <RefreshCw className="w-5 h-5 animate-spin" />
                      جارِ الإرسال...
                    </>
                  ) : (
                    <>
                       إرسال لـ {selectedMissing.size > 0 ? selectedMissing.size : restaurantsWithoutLicenses.length} مطعم
                    </>
                  )}
                </button>
              </div>

              {/* قائمة المطاعم */}
              <div className="grid gap-3">
                {restaurantsWithoutLicenses.map((r: LicenseRestaurant) => (
                  <div key={r.id} className="bg-white border rounded-2xl p-4 shadow-sm hover:shadow-md transition">
                    <div className="flex items-start gap-3">
                      <input
                        type="checkbox"
                        checked={selectedMissing.has(r.id)}
                        onChange={() => toggleSelectRestaurant(r.id)}
                        className="w-5 h-5 mt-1 rounded border-gray-300 text-orange-500 focus:ring-orange-500"
                      />
                      <div className="flex-1">
                        <div className="flex items-start justify-between gap-3 mb-2">
                          <div>
                            <h3 className="font-bold text-gray-800">{r.name}</h3>
                            <p className="text-sm text-gray-500">{r.city || 'بدون مدينة'}</p>
                          </div>
                          <span className="inline-flex items-center gap-1 px-2 py-1 rounded-full bg-orange-100 text-orange-700 text-xs font-semibold">
                            <AlertCircle className="w-3 h-3" />
                            لم يرفع الترخيص
                          </span>
                        </div>
                        
                        {/* معلومات الاتصال */}
                        <div className="flex flex-wrap gap-3 text-sm text-gray-600 mb-3">
                          {r.email && <span> {r.email}</span>}
                          {r.phone && <span> {r.phone}</span>}
                        </div>

                        {/* إرسال رسالة فردية */}
                        <div className="flex gap-2">
                          <input
                            type="text"
                            placeholder="رسالة سريعة..."
                            value={sendingTo === r.id ? messageText : ''}
                            onChange={(e) => {
                              setSendingTo(r.id)
                              setMessageText(e.target.value)
                            }}
                            onFocus={() => setSendingTo(r.id)}
                            className="flex-1 border rounded-lg px-3 py-2 text-sm"
                          />
                          <button
                            onClick={() => sendMessageToRestaurant(r, messageText)}
                            disabled={sendingTo === r.id && !messageText.trim()}
                            className="px-4 py-2 bg-sky-500 hover:bg-sky-600 text-white rounded-lg text-sm font-medium transition disabled:opacity-50"
                          >
                            إرسال
                          </button>
                        </div>
                      </div>
                    </div>
                  </div>
                ))}
              </div>
            </>
          )}
        </div>
      )}

      {filter !== 'missing' && filteredRestaurants.length === 0 ? (
        <div className="text-center py-12 text-gray-400">
          <FileCheck className="w-16 h-16 mx-auto mb-4 opacity-50" />
          <p>لا توجد تراخيص {filter === 'pending' ? 'قيد المراجعة' : filter === 'approved' ? 'موافق عليها' : filter === 'rejected' ? 'مرفوضة' : ''}</p>
        </div>
      ) : filter !== 'missing' && (
        <div className="grid gap-4">
          {filteredRestaurants.map((r: LicenseRestaurant) => (
            <div key={r.id} className="bg-white border rounded-2xl p-5 shadow-sm">
              <div className="flex items-start justify-between gap-4 mb-4">
                <div>
                  <h3 className="font-bold text-lg">{r.name}</h3>
                  <p className="text-sm text-gray-500">{r.city || 'بدون مدينة'} • {r.email || 'بدون بريد'}</p>
                </div>
                {statusBadge(r.licenseStatus)}
              </div>

              {/* عرض التراخيص */}
              <div className="grid grid-cols-1 sm:grid-cols-2 gap-4 mb-4">
                {r.commercialLicenseUrl && (
                  <div className="bg-gray-50 rounded-xl p-3">
                    <div className="flex items-center justify-between mb-2">
                      <p className="text-sm font-semibold text-gray-700"> الرخصة التجارية</p>
                      <button
                        onClick={() => deleteLicenseAndNotify(r, 'commercial')}
                        disabled={updating === r.id}
                        className="p-1.5 text-red-400 hover:text-red-600 hover:bg-red-50 rounded-lg transition"
                        title="حذف الرخصة التجارية"
                      >
                        <Trash2 className="w-4 h-4" />
                      </button>
                    </div>
                    <a
                      href={r.commercialLicenseUrl}
                      target="_blank"
                      rel="noopener noreferrer"
                      className="inline-flex items-center gap-1 text-sky-600 hover:text-sky-800 text-sm"
                    >
                      <ExternalLink className="w-4 h-4" />
                      عرض الملف
                    </a>
                  </div>
                )}
              </div>

              {/* زر حذف السجل التجاري */}
              {r.commercialLicenseUrl && (
                <button
                  onClick={() => deleteLicenseAndNotify(r, 'commercial')}
                  disabled={updating === r.id}
                  className="w-full flex items-center justify-center gap-2 mb-4 py-2 px-4 border-2 border-dashed border-red-200 text-red-500 hover:bg-red-50 hover:border-red-300 rounded-xl text-sm font-medium transition"
                >
                  <Trash2 className="w-4 h-4" />
                  حذف السجل التجاري وإعادة الطلب
                </button>
              )}

              {/* ملاحظات الرفض السابقة */}
              {r.licenseStatus === 'rejected' && r.licenseNotes && (
                <div className="bg-red-50 text-red-700 rounded-xl p-3 mb-4 text-sm">
                  <strong>سبب الرفض:</strong> {r.licenseNotes}
                </div>
              )}

              {/* أزرار المراجعة */}
              {r.licenseStatus !== 'approved' && (
                <div className="space-y-3">
                  <textarea
                    placeholder="ملاحظات (مطلوبة للرفض)..."
                    value={reviewNotes[r.id] || ''}
                    onChange={(e) => setReviewNotes(prev => ({ ...prev, [r.id]: e.target.value }))}
                    className="w-full border rounded-xl p-3 text-sm resize-none h-20"
                  />
                  <div className="flex gap-3">
                    <button
                      onClick={() => updateLicenseStatus(r.id, 'approved')}
                      disabled={updating === r.id}
                      className="flex-1 flex items-center justify-center gap-2 bg-green-500 hover:bg-green-600 text-white py-2.5 rounded-xl font-semibold transition disabled:opacity-50"
                    >
                      <CheckCircle className="w-5 h-5" />
                      موافقة
                    </button>
                    <button
                      onClick={() => updateLicenseStatus(r.id, 'rejected')}
                      disabled={updating === r.id}
                      className="flex-1 flex items-center justify-center gap-2 bg-red-500 hover:bg-red-600 text-white py-2.5 rounded-xl font-semibold transition disabled:opacity-50"
                    >
                      <AlertCircle className="w-5 h-5" />
                      رفض
                    </button>
                  </div>
                </div>
              )}

{/* أزرار التحكم للتراخيص الموافق عليها */}
              {r.licenseStatus === 'approved' && (
                <div className="space-y-3">
                  <textarea
                    placeholder="سبب إلغاء الموافقة..."
                    value={reviewNotes[r.id] || ''}
                    onChange={(e) => setReviewNotes(prev => ({ ...prev, [r.id]: e.target.value }))}
                    className="w-full border border-yellow-200 rounded-xl p-3 text-sm resize-none h-20 focus:ring-2 focus:ring-yellow-400 focus:border-transparent"
                  />
                  <div className="flex gap-3">
                    <button
                      onClick={() => updateLicenseStatus(r.id, 'rejected')}
                      disabled={updating === r.id}
                      className="flex-1 flex items-center justify-center gap-2 bg-yellow-500 hover:bg-yellow-600 text-white py-2.5 rounded-xl font-semibold transition disabled:opacity-50"
                    >
                      <AlertCircle className="w-5 h-5" />
                      إلغاء الموافقة
                    </button>
                    <button
                      onClick={() => deleteLicenseAndNotify(r, 'commercial')}
                      disabled={updating === r.id}
                      className="flex-1 flex items-center justify-center gap-2 bg-red-500 hover:bg-red-600 text-white py-2.5 rounded-xl font-semibold transition disabled:opacity-50"
                    >
                      <Trash2 className="w-5 h-5" />
                      حذف وإعادة الطلب
                    </button>
                  </div>
                </div>
              )}
            </div>
          ))}
        </div>
      )}
    </div>
  )
}

// ===== مكون إدارة طلبات الباقات =====
type PackageRequestItem = {
  id: string
  restaurantId: string
  restaurantName: string
  ownerName?: string
  ownerPhone?: string
  status: 'pending' | 'bank_sent' | 'payment_sent' | 'approved' | 'rejected' | 'expired'
  bankAccountImageUrl?: string
  paymentProofImageUrl?: string
  subscriptionAmount: number
  subscriptionDuration: number
  developerNotes?: string
  ownerNotes?: string
  requestedAt?: any
  bankSentAt?: any
  paymentSentAt?: any
  approvedAt?: any
  rejectedAt?: any
  expiresAt?: any
  createdAt?: any
}

// ===== مكون مراقبة المتاجر =====
const StoreAnalyticsSection: React.FC<{
  restaurants: Restaurant[]
  orders: Order[]
  toast: any
}> = ({ restaurants, orders, toast }) => {
  const [selectedStore, setSelectedStore] = useState<string | null>(null)
  const [storeStats, setStoreStats] = useState<Record<string, any>>({})
  const [loadingStats, setLoadingStats] = useState(false)

  // جلب إحصائيات متجر معين
  const loadStoreStats = async (restaurantId: string) => {
    setLoadingStats(true)
    try {
      // جلب إحصائيات الزيارات
      const statsDoc = await getDoc(doc(db, 'restaurantStats', restaurantId))
      const visitStats = statsDoc.exists() ? statsDoc.data() : null

      // جلب الطلبات الخاصة بهذا المتجر
      const storeOrders = orders.filter(o => o.restaurantId === restaurantId)
      const deliveredOrders = storeOrders.filter(o => o.status === 'delivered')

      // جلب عدد الأصناف
      const menuQuery = query(collection(db, 'menuItems'), where('ownerId', '==', restaurantId))
      const menuSnap = await getDocs(menuQuery)

      // جلب تسجيلات العملاء
      let registrations = 0
      try {
        const regQuery = query(collection(db, 'customerRegistrations'), where('restaurantId', '==', restaurantId))
        const regSnap = await getDocs(regQuery)
        registrations = regSnap.size
      } catch {}

      // حساب الإيرادات
      const totalRevenue = deliveredOrders.reduce((sum, o) => sum + (o.total || 0), 0)
      
      // حساب زيارات اليوم
      const todayKey = new Date().toISOString().split('T')[0]
      const todayViews = visitStats?.dailyViews?.[todayKey] || 0

      setStoreStats(prev => ({
        ...prev,
        [restaurantId]: {
          totalOrders: storeOrders.length,
          deliveredOrders: deliveredOrders.length,
          totalRevenue,
          menuItemsCount: menuSnap.size,
          profileViews: visitStats?.totalProfileViews || 0,
          menuViews: visitStats?.totalMenuViews || 0,
          itemViews: visitStats?.totalItemViews || 0,
          shareClicks: visitStats?.totalShareClicks || 0,
          whatsappShares: visitStats?.whatsappShareCount || 0,
          registeredCustomers: registrations,
          todayViews,
          dailyViews: visitStats?.dailyViews || {}
        }
      }))
    } catch (err) {
      console.error('خطأ في جلب إحصائيات المتجر:', err)
      toast.error('خطأ في جلب البيانات')
    } finally {
      setLoadingStats(false)
    }
  }

  // فتح تفاصيل متجر
  const handleSelectStore = (restaurantId: string) => {
    setSelectedStore(restaurantId)
    if (!storeStats[restaurantId]) {
      loadStoreStats(restaurantId)
    }
  }

  return (
    <div className="space-y-6">
      <div className="flex items-center justify-between">
        <h2 className="text-xl font-bold"> مراقبة إحصائيات المتاجر</h2>
        <span className="text-gray-500">{restaurants.length} متجر</span>
      </div>

      {/* قائمة المتاجر */}
      <div className="grid md:grid-cols-2 lg:grid-cols-3 gap-4">
        {restaurants.map(r => {
          const rStats = storeStats[r.id]
          return (
            <div
              key={r.id}
              onClick={() => handleSelectStore(r.id)}
              className={`bg-white rounded-2xl shadow p-4 cursor-pointer transition hover:shadow-lg ${
                selectedStore === r.id ? 'ring-2 ring-sky-500' : ''
              }`}
            >
              <div className="flex items-center gap-3 mb-3">
                {r.logoUrl ? (
                  <img src={r.logoUrl} alt={r.name} className="w-12 h-12 rounded-xl object-cover" />
                ) : (
                  <div className="w-12 h-12 bg-gray-100 rounded-xl flex items-center justify-center">
                    
                  </div>
                )}
                <div className="flex-1">
                  <h3 className="font-bold text-gray-900">{r.name}</h3>
                  <p className="text-xs text-gray-500">{r.city || 'غير محدد'}</p>
                </div>
              </div>

              {rStats && (
                <div className="grid grid-cols-3 gap-2 text-center text-xs">
                  <div className="bg-blue-50 rounded-lg p-2">
                    <p className="font-bold text-blue-700">{rStats.profileViews}</p>
                    <p className="text-blue-600">زيارة</p>
                  </div>
                  <div className="bg-green-50 rounded-lg p-2">
                    <p className="font-bold text-green-700">{rStats.deliveredOrders}</p>
                    <p className="text-green-600">طلب</p>
                  </div>
                  <div className="bg-purple-50 rounded-lg p-2">
                    <p className="font-bold text-purple-700">{rStats.whatsappShares}</p>
                    <p className="text-purple-600">مشاركة</p>
                  </div>
                </div>
              )}
            </div>
          )
        })}
      </div>

      {/* تفاصيل المتجر المحدد */}
      {selectedStore && (
        <div className="bg-white rounded-2xl shadow-lg p-6">
          {loadingStats ? (
            <div className="text-center py-8">
              <RefreshCw className="w-8 h-8 animate-spin mx-auto text-sky-500" />
              <p className="text-gray-500 mt-2">جاري تحميل البيانات...</p>
            </div>
          ) : storeStats[selectedStore] ? (
            <div className="space-y-6">
              {/* عنوان */}
              <div className="flex items-center justify-between border-b pb-4">
                <div className="flex items-center gap-3">
                  {restaurants.find(r => r.id === selectedStore)?.logoUrl ? (
                    <img 
                      src={restaurants.find(r => r.id === selectedStore)?.logoUrl} 
                      alt="" 
                      className="w-16 h-16 rounded-xl object-cover"
                    />
                  ) : (
                    <div className="w-16 h-16 bg-gray-100 rounded-xl flex items-center justify-center text-2xl"></div>
                  )}
                  <div>
                    <h3 className="text-xl font-bold">
                      {restaurants.find(r => r.id === selectedStore)?.name}
                    </h3>
                    <p className="text-gray-500">
                      {restaurants.find(r => r.id === selectedStore)?.city}
                    </p>
                  </div>
                </div>
                <button
                  onClick={() => loadStoreStats(selectedStore)}
                  className="p-2 bg-gray-100 hover:bg-gray-200 rounded-xl"
                >
                  <RefreshCw className="w-5 h-5" />
                </button>
              </div>

              {/* الإحصائيات */}
              <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
                <div className="bg-gradient-to-br from-blue-50 to-blue-100 rounded-xl p-4">
                  <p className="text-3xl font-bold text-blue-700">{storeStats[selectedStore].profileViews}</p>
                  <p className="text-sm text-blue-600">مشاهدة الصفحة</p>
                </div>
                <div className="bg-gradient-to-br from-green-50 to-green-100 rounded-xl p-4">
                  <p className="text-3xl font-bold text-green-700">{storeStats[selectedStore].todayViews}</p>
                  <p className="text-sm text-green-600">زيارات اليوم</p>
                </div>
                <div className="bg-gradient-to-br from-purple-50 to-purple-100 rounded-xl p-4">
                  <p className="text-3xl font-bold text-purple-700">{storeStats[selectedStore].whatsappShares}</p>
                  <p className="text-sm text-purple-600">مشاركة واتساب</p>
                </div>
                <div className="bg-gradient-to-br from-amber-50 to-amber-100 rounded-xl p-4">
                  <p className="text-3xl font-bold text-amber-700">{storeStats[selectedStore].shareClicks}</p>
                  <p className="text-sm text-amber-600">إجمالي المشاركات</p>
                </div>
              </div>

              {/* إحصائيات الطلبات والإيرادات */}
              <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
                <div className="bg-white border-2 border-gray-200 rounded-xl p-4">
                  <p className="text-2xl font-bold">{storeStats[selectedStore].totalOrders}</p>
                  <p className="text-sm text-gray-600">إجمالي الطلبات</p>
                </div>
                <div className="bg-white border-2 border-gray-200 rounded-xl p-4">
                  <p className="text-2xl font-bold">{storeStats[selectedStore].deliveredOrders}</p>
                  <p className="text-sm text-gray-600">طلبات مكتملة</p>
                </div>
                <div className="bg-white border-2 border-gray-200 rounded-xl p-4">
                  <p className="text-2xl font-bold text-green-600">{storeStats[selectedStore].totalRevenue.toFixed(0)}</p>
                  <p className="text-sm text-gray-600">الإيرادات (ر.س)</p>
                </div>
                <div className="bg-white border-2 border-gray-200 rounded-xl p-4">
                  <p className="text-2xl font-bold">{storeStats[selectedStore].menuItemsCount}</p>
                  <p className="text-sm text-gray-600">عدد الأصناف</p>
                </div>
              </div>

              {/* التسجيلات عبر الرابط */}
              <div className="bg-gradient-to-r from-indigo-50 to-purple-50 rounded-xl p-4">
                <h4 className="font-bold text-indigo-800 mb-2"> التسجيلات عبر رابط الأسرة</h4>
                <div className="grid grid-cols-2 gap-4">
                  <div className="bg-white rounded-lg p-3 text-center">
                    <p className="text-2xl font-bold text-indigo-600">{storeStats[selectedStore].registeredCustomers}</p>
                    <p className="text-xs text-indigo-500">عميل سجل عبر الرابط</p>
                  </div>
                  <div className="bg-white rounded-lg p-3 text-center">
                    <p className="text-2xl font-bold text-purple-600">{storeStats[selectedStore].itemViews}</p>
                    <p className="text-xs text-purple-500">مشاهدات الأصناف</p>
                  </div>
                </div>
              </div>

              {/* رسم بياني للزيارات اليومية */}
              {Object.keys(storeStats[selectedStore].dailyViews || {}).length > 0 && (
                <div className="bg-gray-50 rounded-xl p-4">
                  <h4 className="font-bold text-gray-800 mb-3"> الزيارات اليومية (آخر 7 أيام)</h4>
                  <div className="flex items-end gap-2 h-32">
                    {(() => {
                      const dailyViews = storeStats[selectedStore].dailyViews || {}
                      const last7Days = []
                      for (let i = 6; i >= 0; i--) {
                        const d = new Date()
                        d.setDate(d.getDate() - i)
                        const key = d.toISOString().split('T')[0]
                        last7Days.push({ date: key, views: dailyViews[key] || 0 })
                      }
                      const maxViews = Math.max(...last7Days.map(d => d.views), 1)
                      
                      return last7Days.map((day, i) => (
                        <div key={day.date} className="flex-1 flex flex-col items-center gap-1">
                          <div 
                            className="w-full bg-sky-500 rounded-t"
                            style={{ height: `${(day.views / maxViews) * 100}%`, minHeight: day.views > 0 ? '4px' : '0' }}
                          />
                          <span className="text-xs text-gray-500">
                            {new Date(day.date).toLocaleDateString('ar-SA', { weekday: 'short' })}
                          </span>
                          <span className="text-xs font-bold">{day.views}</span>
                        </div>
                      ))
                    })()}
                  </div>
                </div>
              )}
            </div>
          ) : (
            <p className="text-center text-gray-500 py-8">اضغط على متجر لعرض إحصائياته</p>
          )}
        </div>
      )}
    </div>
  )
}

const PackageRequestsSection: React.FC<{
  packageRequests: PackageRequestItem[]
  onUpdate: () => void
  toast: any
  dialog: any
  storage: any
}> = ({ packageRequests, onUpdate, toast, dialog, storage }) => {
  const [filter, setFilter] = useState<string>('all')
  const [updating, setUpdating] = useState<string | null>(null)
  const [bankImageFile, setBankImageFile] = useState<File | null>(null)
  const [subscriptionAmount, setSubscriptionAmount] = useState<number>(99)
  const [selectedRequestId, setSelectedRequestId] = useState<string | null>(null)
  const [sendingNotification, setSendingNotification] = useState<string | null>(null)
  const [customMessage, setCustomMessage] = useState<string>('')
  const [showMessageInput, setShowMessageInput] = useState<string | null>(null)

  // إرسال رسالة/إشعار للمطعم
  const sendNotificationToRestaurant = async (request: PackageRequestItem, message: string) => {
    if (!message.trim()) {
      toast.warning('يرجى كتابة الرسالة')
      return
    }
    
    setSendingNotification(request.id)
    try {
      await addDoc(collection(db, 'notifications'), {
        recipientId: request.restaurantId,
        title: ' رسالة من الإدارة',
        message: message.trim(),
        type: 'admin_message',
        read: false,
        data: { requestId: request.id },
        createdAt: serverTimestamp(),
      })
      
      toast.success('تم إرسال الرسالة بنجاح! ')
      setShowMessageInput(null)
      setCustomMessage('')
    } catch (err: any) {
      toast.error(`فشل الإرسال: ${err.message}`)
    } finally {
      setSendingNotification(null)
    }
  }

  // فلترة الطلبات
  const filteredRequests = packageRequests.filter(r => {
    if (filter === 'all') return true
    return r.status === filter
  })

  // عدد الطلبات حسب الحالة
  const pendingCount = packageRequests.filter(r => r.status === 'pending').length
  const bankSentCount = packageRequests.filter(r => r.status === 'bank_sent').length
  const paymentSentCount = packageRequests.filter(r => r.status === 'payment_sent').length
  const approvedCount = packageRequests.filter(r => r.status === 'approved').length

  // ترجمة الحالة
  const getStatusLabel = (status: string) => {
    switch (status) {
      case 'pending': return { label: 'طلب جديد', color: 'bg-yellow-100 text-yellow-700', icon: '' }
      case 'bank_sent': return { label: 'بانتظار التحويل', color: 'bg-blue-100 text-blue-700', icon: '' }
      case 'payment_sent': return { label: 'بانتظار التأكيد', color: 'bg-purple-100 text-purple-700', icon: '' }
      case 'approved': return { label: 'مفعّل', color: 'bg-green-100 text-green-700', icon: '' }
      case 'rejected': return { label: 'مرفوض', color: 'bg-red-100 text-red-700', icon: '' }
      case 'expired': return { label: 'منتهي', color: 'bg-gray-100 text-gray-700', icon: '' }
      default: return { label: status, color: 'bg-gray-100', icon: '' }
    }
  }

  // إرسال صورة الحساب البنكي
  const handleSendBankAccount = async (requestId: string) => {
    if (!bankImageFile) {
      toast.warning('يرجى اختيار صورة الحساب البنكي')
      return
    }

    setUpdating(requestId)
    try {
      // رفع الصورة
      const path = `bankAccounts/${Date.now()}_${bankImageFile.name}`
      const storageRef = ref(storage, path)
      await uploadBytes(storageRef, bankImageFile)
      const imageUrl = await getDownloadURL(storageRef)

      // تحديث الطلب
      await updateDoc(doc(db, 'packageRequests', requestId), {
        status: 'bank_sent',
        bankAccountImageUrl: imageUrl,
        subscriptionAmount,
        bankSentAt: serverTimestamp(),
        updatedAt: serverTimestamp(),
      })

      // إرسال إشعار للأسرة
      const request = packageRequests.find(r => r.id === requestId)
      if (request) {
        await addDoc(collection(db, 'notifications'), {
          recipientId: request.restaurantId,
          title: ' تم إرسال بيانات الحساب البنكي',
          message: `يرجى تحويل مبلغ ${subscriptionAmount} ريال ثم رفع صورة إثبات التحويل`,
          type: 'package_bank_sent',
          read: false,
          data: { requestId, amount: subscriptionAmount },
          createdAt: serverTimestamp(),
        })
      }

      toast.success('تم إرسال بيانات الحساب البنكي بنجاح')
      setBankImageFile(null)
      setSelectedRequestId(null)
      onUpdate()
    } catch (err: any) {
      toast.error(`فشل الإرسال: ${err.message}`)
    } finally {
      setUpdating(null)
    }
  }

  // تأكيد الدفع وتفعيل الباقة
  const handleApprovePayment = async (request: PackageRequestItem) => {
    const confirmed = await dialog.confirm(
      `هل تأكد من استلام مبلغ ${request.subscriptionAmount} ريال وتفعيل باقة التميز لـ "${request.restaurantName}"؟`,
      { title: ' تأكيد الدفع وتفعيل الباقة', confirmText: 'نعم، فعّل الباقة' }
    )
    if (!confirmed) return

    setUpdating(request.id)
    try {
      const expiresAt = new Date()
      expiresAt.setDate(expiresAt.getDate() + (request.subscriptionDuration || 30))

      // تحديث طلب الباقة
      await updateDoc(doc(db, 'packageRequests', request.id), {
        status: 'approved',
        approvedAt: serverTimestamp(),
        expiresAt,
        updatedAt: serverTimestamp(),
      })

      // تفعيل الباقة في المطعم
      await updateDoc(doc(db, 'restaurants', request.restaurantId), {
        packageType: 'premium',
        packageSubscribedAt: serverTimestamp(),
        packageExpiresAt: expiresAt,
        packageRequest: null,
        updatedAt: serverTimestamp(),
      })

      // إرسال إشعار للأسرة
      await addDoc(collection(db, 'notifications'), {
        recipientId: request.restaurantId,
        title: ' تم تفعيل باقة التميز!',
        message: `مبروك! تم تفعيل باقة التميز حتى ${expiresAt.toLocaleDateString('ar-SA')}`,
        type: 'package_approved',
        read: false,
        data: { requestId: request.id },
        createdAt: serverTimestamp(),
      })

      toast.success('تم تفعيل الباقة بنجاح! ')
      onUpdate()
    } catch (err: any) {
      toast.error(`فشل التفعيل: ${err.message}`)
    } finally {
      setUpdating(null)
    }
  }

  // رفض الطلب
  const handleRejectRequest = async (request: PackageRequestItem) => {
    const confirmed = await dialog.confirm(
      `هل تريد رفض طلب "${request.restaurantName}"؟`,
      { title: ' رفض الطلب', confirmText: 'نعم، ارفض', dangerous: true }
    )
    if (!confirmed) return

    setUpdating(request.id)
    try {
      await updateDoc(doc(db, 'packageRequests', request.id), {
        status: 'rejected',
        rejectedAt: serverTimestamp(),
        updatedAt: serverTimestamp(),
      })

      // إرسال إشعار
      await addDoc(collection(db, 'notifications'), {
        recipientId: request.restaurantId,
        title: ' تم رفض طلب الاشتراك',
        message: 'للأسف تم رفض طلب اشتراكك في باقة التميز. يمكنك التواصل معنا لمعرفة السبب.',
        type: 'package_rejected',
        read: false,
        createdAt: serverTimestamp(),
      })

      toast.success('تم رفض الطلب')
      onUpdate()
    } catch (err: any) {
      toast.error(`فشل الرفض: ${err.message}`)
    } finally {
      setUpdating(null)
    }
  }

  return (
    <div className="space-y-6">
      <div className="flex items-center justify-between flex-wrap gap-4">
        <div className="flex items-center gap-3">
          <Package className="w-8 h-8 text-amber-500" />
          <div>
            <h2 className="text-2xl font-bold">طلبات الاشتراك في الباقات</h2>
            <p className="text-gray-600">إدارة طلبات الأسر المنتجة للاشتراك في باقة التميز</p>
          </div>
        </div>
      </div>

      {/* إحصائيات سريعة */}
      <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
        <div className="bg-yellow-50 rounded-xl p-4 text-center border border-yellow-200">
          <p className="text-3xl font-bold text-yellow-600">{pendingCount}</p>
          <p className="text-sm text-yellow-700"> طلب جديد</p>
        </div>
        <div className="bg-blue-50 rounded-xl p-4 text-center border border-blue-200">
          <p className="text-3xl font-bold text-blue-600">{bankSentCount}</p>
          <p className="text-sm text-blue-700"> بانتظار التحويل</p>
        </div>
        <div className="bg-purple-50 rounded-xl p-4 text-center border border-purple-200">
          <p className="text-3xl font-bold text-purple-600">{paymentSentCount}</p>
          <p className="text-sm text-purple-700"> بانتظار التأكيد</p>
        </div>
        <div className="bg-green-50 rounded-xl p-4 text-center border border-green-200">
          <p className="text-3xl font-bold text-green-600">{approvedCount}</p>
          <p className="text-sm text-green-700"> مفعّل</p>
        </div>
      </div>

      {/* فلتر الحالة */}
      <div className="flex flex-wrap gap-2">
        {[
          { id: 'all', label: 'الكل' },
          { id: 'pending', label: ' طلبات جديدة' },
          { id: 'bank_sent', label: ' بانتظار التحويل' },
          { id: 'payment_sent', label: ' بانتظار التأكيد' },
          { id: 'approved', label: ' مفعّلة' },
          { id: 'rejected', label: ' مرفوضة' },
        ].map(f => (
          <button
            key={f.id}
            onClick={() => setFilter(f.id)}
            className={`px-4 py-2 rounded-xl font-semibold transition ${
              filter === f.id
                ? 'bg-amber-500 text-white'
                : 'bg-gray-100 text-gray-700 hover:bg-gray-200'
            }`}
          >
            {f.label}
          </button>
        ))}
      </div>

      {/* قائمة الطلبات */}
      {filteredRequests.length === 0 ? (
        <div className="text-center py-16 bg-gray-50 rounded-2xl">
          <Package className="w-16 h-16 text-gray-300 mx-auto mb-4" />
          <p className="text-gray-500 text-lg">لا توجد طلبات {filter !== 'all' && 'بهذه الحالة'}</p>
        </div>
      ) : (
        <div className="space-y-4">
          {filteredRequests.map(request => {
            const statusInfo = getStatusLabel(request.status)
            return (
              <div key={request.id} className="bg-white rounded-2xl shadow-lg overflow-hidden">
                {/* رأس البطاقة */}
                <div className="bg-gradient-to-r from-amber-500 to-orange-500 p-4 text-white">
                  <div className="flex items-center justify-between flex-wrap gap-3">
                    <div className="flex items-center gap-3">
                      <div className="w-12 h-12 bg-white/20 rounded-xl flex items-center justify-center text-2xl">
                        
                      </div>
                      <div>
                        <h3 className="font-bold text-lg">{request.restaurantName}</h3>
                        <p className="text-white/80 text-sm">
                          {request.ownerName || 'صاحب الأسرة'} • {request.ownerPhone || 'بدون رقم'}
                        </p>
                      </div>
                    </div>
                    <div className="flex items-center gap-2">
                      {/* زر التواصل واتساب */}
                      {request.ownerPhone && (
                        <a
                          href={`https://wa.me/${request.ownerPhone.replace(/[^0-9]/g, '').replace(/^0/, '966')}`}
                          target="_blank"
                          rel="noopener noreferrer"
                          className="flex items-center gap-1 bg-green-500 hover:bg-green-600 text-white px-3 py-2 rounded-xl text-sm font-semibold transition"
                        >
                           واتساب
                        </a>
                      )}
                      <div className={`px-4 py-2 rounded-full text-sm font-bold ${statusInfo.color}`}>
                        {statusInfo.icon} {statusInfo.label}
                      </div>
                    </div>
                  </div>
                </div>

                {/* محتوى البطاقة */}
                <div className="p-4 space-y-4">
                  {/* تفاصيل الطلب */}
                  <div className="grid grid-cols-2 md:grid-cols-4 gap-4 text-sm">
                    <div>
                      <p className="text-gray-500">تاريخ الطلب</p>
                      <p className="font-semibold">
                        {request.requestedAt?.toDate?.()?.toLocaleDateString('ar-SA') || 
                         request.createdAt?.toDate?.()?.toLocaleDateString('ar-SA') || '-'}
                      </p>
                    </div>
                    <div>
                      <p className="text-gray-500">المبلغ</p>
                      <p className="font-semibold text-green-600">{request.subscriptionAmount || 99} ر.س</p>
                    </div>
                    <div>
                      <p className="text-gray-500">المدة</p>
                      <p className="font-semibold">{request.subscriptionDuration || 30} يوم</p>
                    </div>
                    <div>
                      <p className="text-gray-500">معرف الأسرة</p>
                      <p className="font-mono text-xs">{request.restaurantId.slice(0, 12)}...</p>
                    </div>
                  </div>

                  {/* === أزرار التواصل === */}
                  <div className="border-t pt-4">
                    {showMessageInput === request.id ? (
                      <div className="space-y-3 bg-sky-50 p-4 rounded-xl">
                        <h4 className="font-bold text-sky-600"> إرسال رسالة للأسرة</h4>
                        <textarea
                          value={customMessage}
                          onChange={(e) => setCustomMessage(e.target.value)}
                          placeholder="اكتب رسالتك هنا..."
                          className="w-full border rounded-lg p-3 resize-none"
                          rows={3}
                        />
                        <div className="flex gap-2">
                          <button
                            onClick={() => sendNotificationToRestaurant(request, customMessage)}
                            disabled={sendingNotification === request.id || !customMessage.trim()}
                            className="flex-1 bg-sky-500 hover:bg-sky-600 text-white py-2 rounded-xl font-semibold disabled:opacity-50"
                          >
                            {sendingNotification === request.id ? 'جارِ الإرسال...' : ' إرسال الرسالة'}
                          </button>
                          <button
                            onClick={() => {
                              setShowMessageInput(null)
                              setCustomMessage('')
                            }}
                            className="px-4 bg-gray-200 hover:bg-gray-300 rounded-xl"
                          >
                            إلغاء
                          </button>
                        </div>
                      </div>
                    ) : (
                      <div className="flex flex-wrap gap-2">
                        <button
                          onClick={() => setShowMessageInput(request.id)}
                          className="flex items-center gap-2 bg-sky-100 hover:bg-sky-200 text-sky-700 px-4 py-2 rounded-xl font-semibold transition"
                        >
                           إرسال رسالة
                        </button>
                        {request.ownerPhone && (
                          <a
                            href={`https://wa.me/${request.ownerPhone.replace(/[^0-9]/g, '').replace(/^0/, '966')}`}
                            target="_blank"
                            rel="noopener noreferrer"
                            className="flex items-center gap-2 bg-green-100 hover:bg-green-200 text-green-700 px-4 py-2 rounded-xl font-semibold transition"
                          >
                             واتساب
                          </a>
                        )}
                        {!request.ownerPhone && (
                          <span className="text-gray-400 text-sm self-center"> لا يوجد رقم هاتف</span>
                        )}
                      </div>
                    )}
                  </div>

                  {/* === حالة: طلب جديد - إرسال صورة البنك === */}
                  {request.status === 'pending' && (
                    <div className="border-t pt-4 space-y-3">
                      <h4 className="font-bold text-amber-600"> إرسال بيانات الحساب البنكي</h4>
                      
                      {selectedRequestId === request.id ? (
                        <div className="space-y-3 bg-amber-50 p-4 rounded-xl">
                          <div>
                            <label className="block text-sm font-semibold mb-1">صورة الحساب البنكي (IBAN)</label>
                            <input
                              type="file"
                              accept="image/*"
                              onChange={(e) => setBankImageFile(e.target.files?.[0] || null)}
                              className="w-full border rounded-lg p-2"
                            />
                          </div>
                          <div>
                            <label className="block text-sm font-semibold mb-1">مبلغ الاشتراك (ريال)</label>
                            <input
                              type="number"
                              value={subscriptionAmount}
                              onChange={(e) => setSubscriptionAmount(Number(e.target.value))}
                              className="w-full border rounded-lg p-2"
                              min={1}
                            />
                          </div>
                          <div className="flex gap-2">
                            <button
                              onClick={() => handleSendBankAccount(request.id)}
                              disabled={updating === request.id || !bankImageFile}
                              className="flex-1 bg-amber-500 hover:bg-amber-600 text-white py-2 rounded-xl font-semibold disabled:opacity-50"
                            >
                              {updating === request.id ? 'جارِ الإرسال...' : ' إرسال للأسرة'}
                            </button>
                            <button
                              onClick={() => {
                                setSelectedRequestId(null)
                                setBankImageFile(null)
                              }}
                              className="px-4 bg-gray-200 hover:bg-gray-300 rounded-xl"
                            >
                              إلغاء
                            </button>
                          </div>
                        </div>
                      ) : (
                        <div className="flex gap-2">
                          <button
                            onClick={() => setSelectedRequestId(request.id)}
                            className="flex-1 bg-amber-500 hover:bg-amber-600 text-white py-3 rounded-xl font-semibold"
                          >
                             إرسال بيانات البنك
                          </button>
                          <button
                            onClick={() => handleRejectRequest(request)}
                            disabled={updating === request.id}
                            className="px-6 bg-red-100 hover:bg-red-200 text-red-700 rounded-xl font-semibold"
                          >
                             رفض
                          </button>
                        </div>
                      )}
                    </div>
                  )}

                  {/* === حالة: بانتظار التحويل === */}
                  {request.status === 'bank_sent' && (
                    <div className="border-t pt-4">
                      <div className="bg-blue-50 p-4 rounded-xl">
                        <p className="text-blue-700 font-semibold mb-2"> تم إرسال بيانات الحساب البنكي</p>
                        <p className="text-blue-600 text-sm">بانتظار تحويل مبلغ {request.subscriptionAmount} ريال من الأسرة</p>
                        {request.bankAccountImageUrl && (
                          <a
                            href={request.bankAccountImageUrl}
                            target="_blank"
                            rel="noopener noreferrer"
                            className="inline-flex items-center gap-1 text-blue-600 hover:underline mt-2 text-sm"
                          >
                            <ExternalLink className="w-4 h-4" />
                            عرض صورة البنك المرسلة
                          </a>
                        )}
                      </div>
                    </div>
                  )}

                  {/* === حالة: بانتظار التأكيد (الأسرة حولت) === */}
                  {request.status === 'payment_sent' && (
                    <div className="border-t pt-4 space-y-3">
                      <div className="bg-purple-50 p-4 rounded-xl">
                        <p className="text-purple-700 font-semibold mb-2"> الأسرة أرسلت إثبات التحويل</p>
                        {request.paymentProofImageUrl && (
                          <a
                            href={request.paymentProofImageUrl}
                            target="_blank"
                            rel="noopener noreferrer"
                            className="inline-flex items-center gap-2 bg-white px-4 py-2 rounded-lg text-purple-600 hover:bg-purple-100 transition"
                          >
                            <ExternalLink className="w-5 h-5" />
                            عرض صورة إثبات التحويل
                          </a>
                        )}
                      </div>
                      <div className="flex gap-2">
                        <button
                          onClick={() => handleApprovePayment(request)}
                          disabled={updating === request.id}
                          className="flex-1 bg-green-500 hover:bg-green-600 text-white py-3 rounded-xl font-bold disabled:opacity-50"
                        >
                          {updating === request.id ? 'جارِ التفعيل...' : ' تأكيد الدفع وتفعيل الباقة'}
                        </button>
                        <button
                          onClick={() => handleRejectRequest(request)}
                          disabled={updating === request.id}
                          className="px-6 bg-red-100 hover:bg-red-200 text-red-700 rounded-xl font-semibold"
                        >
                           رفض
                        </button>
                      </div>
                    </div>
                  )}

                  {/* === حالة: مفعّل === */}
                  {request.status === 'approved' && (
                    <div className="border-t pt-4">
                      <div className="bg-green-50 p-4 rounded-xl flex items-center gap-3">
                        <CheckCircle className="w-8 h-8 text-green-500" />
                        <div>
                          <p className="text-green-700 font-semibold"> الباقة مفعّلة</p>
                          <p className="text-green-600 text-sm">
                            تنتهي في: {request.expiresAt?.toDate?.()?.toLocaleDateString('ar-SA') || '-'}
                          </p>
                        </div>
                      </div>
                    </div>
                  )}

                  {/* === حالة: مرفوض === */}
                  {request.status === 'rejected' && (
                    <div className="border-t pt-4">
                      <div className="bg-red-50 p-4 rounded-xl">
                        <p className="text-red-700 font-semibold"> تم رفض الطلب</p>
                        <p className="text-red-600 text-sm">
                          بتاريخ: {request.rejectedAt?.toDate?.()?.toLocaleDateString('ar-SA') || '-'}
                        </p>
                      </div>
                    </div>
                  )}
                </div>
              </div>
            )
          })}
        </div>
      )}
    </div>
  )
}

// ===== مكون إعدادات أسعار الباقات =====
import { PackageSettings, PackageConfig, PackageDiscount } from '@/types'

const defaultPackageSettings: PackageSettings = {
  premium: {
    displayName: 'باقة التميز',
    description: 'احصل على مزايا حصرية وإحصائيات متقدمة',
    isEnabled: true,
    originalPrice: 99,
    currentPrice: 99,
    durationDays: 30,
    discount: {
      isActive: false,
      type: 'percentage',
      value: 0,
    },
  },
  free: {
    displayName: 'الباقة المجانية',
    description: 'المميزات الأساسية مجاناً',
    isEnabled: true,
    originalPrice: 0,
    currentPrice: 0,
    durationDays: 0,
    discount: {
      isActive: false,
      type: 'percentage',
      value: 0,
    },
  },
  defaultPackage: 'free',
}

const PackageSettingsSection: React.FC<{
  toast: any
  dialog: any
}> = ({ toast, dialog }) => {
  const [loading, setLoading] = useState(true)
  const [saving, setSaving] = useState(false)
  const [packageSettings, setPackageSettings] = useState<PackageSettings>(defaultPackageSettings)
  const [editingPackage, setEditingPackage] = useState<'premium' | 'free' | null>(null)

  // تحميل الإعدادات
  useEffect(() => {
    loadSettings()
  }, [])

  const loadSettings = async () => {
    setLoading(true)
    try {
      const snap = await getDoc(doc(db, 'settings', 'packages'))
      if (snap.exists()) {
        const data = snap.data() as PackageSettings
        setPackageSettings({
          ...defaultPackageSettings,
          ...data,
          premium: { ...defaultPackageSettings.premium, ...data.premium },
          free: { ...defaultPackageSettings.free, ...data.free },
        })
      }
    } catch (err) {
      console.error('خطأ في تحميل إعدادات الباقات:', err)
      toast.error('فشل تحميل إعدادات الباقات')
    } finally {
      setLoading(false)
    }
  }

  // حفظ الإعدادات
  const saveSettings = async () => {
    setSaving(true)
    try {
      // حساب السعر الحالي بناء على الخصم
      const updatedSettings = { ...packageSettings }
      
      // حساب سعر باقة التميز
      if (updatedSettings.premium.discount?.isActive && updatedSettings.premium.discount.value > 0) {
        const discount = updatedSettings.premium.discount
        if (discount.type === 'percentage') {
          updatedSettings.premium.currentPrice = 
            updatedSettings.premium.originalPrice - (updatedSettings.premium.originalPrice * discount.value / 100)
        } else {
          updatedSettings.premium.currentPrice = 
            Math.max(0, updatedSettings.premium.originalPrice - discount.value)
        }
      } else {
        updatedSettings.premium.currentPrice = updatedSettings.premium.originalPrice
      }

      await setDoc(doc(db, 'settings', 'packages'), {
        ...updatedSettings,
        updatedAt: serverTimestamp(),
      })
      
      setPackageSettings(updatedSettings)
      toast.success('تم حفظ إعدادات الباقات بنجاح ')
    } catch (err: any) {
      console.error('خطأ في حفظ الإعدادات:', err)
      toast.error(`فشل الحفظ: ${err.message}`)
    } finally {
      setSaving(false)
    }
  }

  // تحديث إعدادات باقة معينة
  const updatePackageConfig = (pkg: 'premium' | 'free', field: keyof PackageConfig, value: any) => {
    setPackageSettings(prev => ({
      ...prev,
      [pkg]: {
        ...prev[pkg],
        [field]: value,
      },
    }))
  }

  // تحديث إعدادات الخصم
  const updateDiscount = (pkg: 'premium' | 'free', field: keyof PackageDiscount, value: any) => {
    setPackageSettings(prev => ({
      ...prev,
      [pkg]: {
        ...prev[pkg],
        discount: {
          ...prev[pkg].discount,
          [field]: value,
        },
      },
    }))
  }

  // جعل الباقة مجانية
  const makeFree = async () => {
    const confirmed = await dialog.confirm(
      'سيتم جعل باقة التميز مجانية (0 ريال). هل أنت متأكد؟',
      { title: ' جعل الباقة مجانية' }
    )
    if (!confirmed) return

    setPackageSettings(prev => ({
      ...prev,
      premium: {
        ...prev.premium,
        originalPrice: 0,
        currentPrice: 0,
        discount: {
          isActive: false,
          type: 'percentage',
          value: 0,
        },
      },
    }))
    toast.success('تم تعيين السعر على 0 ريال. اضغط حفظ لتطبيق التغييرات.')
  }

  // التحقق من صلاحية الخصم
  const isDiscountValid = (discount?: PackageDiscount): boolean => {
    if (!discount?.isActive) return false
    
    const now = new Date()
    const startDate = discount.startDate?.toDate?.() || (discount.startDate ? new Date(discount.startDate) : null)
    const endDate = discount.endDate?.toDate?.() || (discount.endDate ? new Date(discount.endDate) : null)
    
    if (startDate && now < startDate) return false
    if (endDate && now > endDate) return false
    
    return true
  }

  // حساب السعر بعد الخصم
  const calculateDiscountedPrice = (config: PackageConfig): number => {
    if (!isDiscountValid(config.discount)) {
      return config.originalPrice
    }
    
    const discount = config.discount!
    if (discount.type === 'percentage') {
      return config.originalPrice - (config.originalPrice * discount.value / 100)
    } else {
      return Math.max(0, config.originalPrice - discount.value)
    }
  }

  if (loading) {
    return (
      <div className="flex items-center justify-center min-h-[400px]">
        <div className="text-center">
          <div className="w-12 h-12 border-4 border-amber-200 border-t-amber-500 rounded-full animate-spin mx-auto mb-4" />
          <p className="text-gray-500">جارِ تحميل إعدادات الباقات...</p>
        </div>
      </div>
    )
  }

  return (
    <div className="space-y-6">
      {/* العنوان */}
      <div className="flex items-center justify-between flex-wrap gap-4">
        <div className="flex items-center gap-3">
          <div className="w-12 h-12 bg-gradient-to-br from-amber-500 to-orange-500 rounded-2xl flex items-center justify-center">
            <Settings className="w-6 h-6 text-white" />
          </div>
          <div>
            <h2 className="text-2xl font-bold">إعدادات أسعار الباقات</h2>
            <p className="text-gray-600">تحكم في أسعار الباقات والخصومات من هنا</p>
          </div>
        </div>
        <div className="flex gap-2">
          <button
            onClick={makeFree}
            className="bg-gradient-to-r from-green-500 to-emerald-500 hover:from-green-600 hover:to-emerald-600 text-white px-5 py-3 rounded-xl font-bold shadow-lg transition flex items-center gap-2"
          >
             جعلها مجانية
          </button>
          <button
            onClick={saveSettings}
            disabled={saving}
            className="bg-gradient-to-r from-amber-500 to-orange-500 hover:from-amber-600 hover:to-orange-600 text-white px-6 py-3 rounded-xl font-bold shadow-lg transition disabled:opacity-50 flex items-center gap-2"
          >
            {saving ? ' جارِ الحفظ...' : ' حفظ التغييرات'}
          </button>
        </div>
      </div>

      {/* إعدادات باقة التميز */}
      <div className="bg-white rounded-2xl shadow-xl overflow-hidden">
        <div className="bg-gradient-to-r from-amber-500 via-orange-500 to-amber-500 p-5 text-white">
          <div className="flex items-center justify-between">
            <div className="flex items-center gap-3">
              <Package className="w-8 h-8" />
              <div>
                <h3 className="text-xl font-bold"> باقة التميز (Premium)</h3>
                <p className="text-white/80 text-sm">الباقة المدفوعة مع مزايا حصرية</p>
              </div>
            </div>
            <label className="flex items-center gap-2 bg-white/20 px-4 py-2 rounded-xl cursor-pointer">
              <input
                type="checkbox"
                checked={packageSettings.premium.isEnabled}
                onChange={(e) => updatePackageConfig('premium', 'isEnabled', e.target.checked)}
                className="w-5 h-5 rounded"
              />
              <span className="font-semibold">{packageSettings.premium.isEnabled ? ' مفعّلة' : ' موقوفة'}</span>
            </label>
          </div>
        </div>

        <div className="p-6 space-y-6">
          {/* السعر الأصلي والمدة */}
          <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
            <div>
              <label className="block text-sm font-bold text-gray-700 mb-2"> السعر الأصلي (ريال)</label>
              <input
                type="number"
                min="0"
                step="1"
                value={packageSettings.premium.originalPrice}
                onChange={(e) => updatePackageConfig('premium', 'originalPrice', Number(e.target.value))}
                className="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:border-amber-500 focus:ring-2 focus:ring-amber-200 text-xl font-bold text-center"
              />
            </div>
            <div>
              <label className="block text-sm font-bold text-gray-700 mb-2"> مدة الاشتراك (يوم)</label>
              <input
                type="number"
                min="1"
                value={packageSettings.premium.durationDays}
                onChange={(e) => updatePackageConfig('premium', 'durationDays', Number(e.target.value))}
                className="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:border-amber-500 focus:ring-2 focus:ring-amber-200 text-xl font-bold text-center"
              />
            </div>
            <div>
              <label className="block text-sm font-bold text-gray-700 mb-2"> السعر الحالي</label>
              <div className="w-full px-4 py-3 bg-green-50 border-2 border-green-300 rounded-xl text-xl font-bold text-center text-green-700">
                {calculateDiscountedPrice(packageSettings.premium).toFixed(0)} ريال
                {isDiscountValid(packageSettings.premium.discount) && (
                  <span className="text-sm text-green-600 block">بعد الخصم</span>
                )}
              </div>
            </div>
          </div>

          {/* الوصف */}
          <div>
            <label className="block text-sm font-bold text-gray-700 mb-2"> وصف الباقة</label>
            <textarea
              value={packageSettings.premium.description || ''}
              onChange={(e) => updatePackageConfig('premium', 'description', e.target.value)}
              className="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:border-amber-500 focus:ring-2 focus:ring-amber-200"
              rows={2}
              placeholder="وصف قصير للباقة..."
            />
          </div>

          {/* إعدادات الخصم */}
          <div className="bg-gradient-to-r from-red-50 to-orange-50 border-2 border-red-200 rounded-2xl p-5">
            <div className="flex items-center justify-between mb-4">
              <div className="flex items-center gap-2">
                <span className="text-2xl"></span>
                <h4 className="text-lg font-bold text-red-700">إعدادات الخصم</h4>
              </div>
              <label className="flex items-center gap-2 bg-white px-4 py-2 rounded-xl cursor-pointer shadow">
                <input
                  type="checkbox"
                  checked={packageSettings.premium.discount?.isActive || false}
                  onChange={(e) => updateDiscount('premium', 'isActive', e.target.checked)}
                  className="w-5 h-5 rounded accent-red-500"
                />
                <span className="font-semibold text-red-700">
                  {packageSettings.premium.discount?.isActive ? ' الخصم مفعّل' : ' الخصم موقوف'}
                </span>
              </label>
            </div>

            {packageSettings.premium.discount?.isActive && (
              <div className="space-y-4">
                <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                  <div>
                    <label className="block text-sm font-bold text-gray-700 mb-2">نوع الخصم</label>
                    <select
                      value={packageSettings.premium.discount?.type || 'percentage'}
                      onChange={(e) => updateDiscount('premium', 'type', e.target.value)}
                      className="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:border-red-500"
                    >
                      <option value="percentage">نسبة مئوية (%)</option>
                      <option value="fixed">مبلغ ثابت (ريال)</option>
                    </select>
                  </div>
                  <div>
                    <label className="block text-sm font-bold text-gray-700 mb-2">
                      قيمة الخصم {packageSettings.premium.discount?.type === 'percentage' ? '(%)' : '(ريال)'}
                    </label>
                    <input
                      type="number"
                      min="0"
                      max={packageSettings.premium.discount?.type === 'percentage' ? 100 : packageSettings.premium.originalPrice}
                      value={packageSettings.premium.discount?.value || 0}
                      onChange={(e) => updateDiscount('premium', 'value', Number(e.target.value))}
                      className="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:border-red-500 text-lg font-bold text-center"
                    />
                  </div>
                </div>

                <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                  <div>
                    <label className="block text-sm font-bold text-gray-700 mb-2"> تاريخ بداية الخصم</label>
                    <input
                      type="date"
                      value={
                        packageSettings.premium.discount?.startDate
                          ? (typeof packageSettings.premium.discount.startDate === 'string'
                              ? packageSettings.premium.discount.startDate
                              : packageSettings.premium.discount.startDate.toDate?.()?.toISOString().split('T')[0] || '')
                          : ''
                      }
                      onChange={(e) => updateDiscount('premium', 'startDate', e.target.value)}
                      className="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:border-red-500"
                    />
                  </div>
                  <div>
                    <label className="block text-sm font-bold text-gray-700 mb-2"> تاريخ نهاية الخصم</label>
                    <input
                      type="date"
                      value={
                        packageSettings.premium.discount?.endDate
                          ? (typeof packageSettings.premium.discount.endDate === 'string'
                              ? packageSettings.premium.discount.endDate
                              : packageSettings.premium.discount.endDate.toDate?.()?.toISOString().split('T')[0] || '')
                          : ''
                      }
                      onChange={(e) => updateDiscount('premium', 'endDate', e.target.value)}
                      className="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:border-red-500"
                    />
                  </div>
                </div>

                <div>
                  <label className="block text-sm font-bold text-gray-700 mb-2"> وسم/سبب الخصم (اختياري)</label>
                  <input
                    type="text"
                    value={packageSettings.premium.discount?.label || ''}
                    onChange={(e) => updateDiscount('premium', 'label', e.target.value)}
                    className="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:border-red-500"
                    placeholder="مثال: عرض الإطلاق، خصم رمضان..."
                  />
                </div>

                {/* معاينة الخصم */}
                <div className="bg-white rounded-xl p-4 border-2 border-dashed border-red-300">
                  <p className="text-center text-lg">
                    <span className="text-gray-500 line-through">{packageSettings.premium.originalPrice} ريال</span>
                    <span className="mx-3">→</span>
                    <span className="text-2xl font-bold text-green-600">{calculateDiscountedPrice(packageSettings.premium).toFixed(0)} ريال</span>
                    {packageSettings.premium.discount?.label && (
                      <span className="bg-red-500 text-white text-xs px-2 py-1 rounded-full mr-2">
                        {packageSettings.premium.discount.label}
                      </span>
                    )}
                  </p>
                  <p className="text-center text-sm text-gray-500 mt-2">
                    {isDiscountValid(packageSettings.premium.discount) ? ' الخصم نشط حالياً' : ' الخصم غير نشط (تحقق من التواريخ)'}
                  </p>
                </div>
              </div>
            )}
          </div>
        </div>
      </div>

      {/* إعدادات الباقة المجانية */}
      <div className="bg-white rounded-2xl shadow-xl overflow-hidden">
        <div className="bg-gradient-to-r from-gray-600 to-gray-700 p-5 text-white">
          <div className="flex items-center justify-between">
            <div className="flex items-center gap-3">
              <Package className="w-8 h-8" />
              <div>
                <h3 className="text-xl font-bold"> الباقة المجانية (Free)</h3>
                <p className="text-white/80 text-sm">المميزات الأساسية بدون رسوم</p>
              </div>
            </div>
            <label className="flex items-center gap-2 bg-white/20 px-4 py-2 rounded-xl cursor-pointer">
              <input
                type="checkbox"
                checked={packageSettings.free.isEnabled}
                onChange={(e) => updatePackageConfig('free', 'isEnabled', e.target.checked)}
                className="w-5 h-5 rounded"
              />
              <span className="font-semibold">{packageSettings.free.isEnabled ? ' مفعّلة' : ' موقوفة'}</span>
            </label>
          </div>
        </div>

        <div className="p-6">
          <div className="bg-green-50 border-2 border-green-200 rounded-xl p-4 text-center">
            <p className="text-green-700 font-bold text-lg"> هذه الباقة مجانية دائماً</p>
            <p className="text-green-600 text-sm">لا يتطلب دفع أي رسوم</p>
          </div>
        </div>
      </div>

      {/* ملخص الأسعار */}
      <div className="bg-gradient-to-r from-sky-50 to-blue-50 rounded-2xl p-6 border-2 border-sky-200">
        <h3 className="text-lg font-bold text-sky-800 mb-4 flex items-center gap-2">
          <Shield className="w-5 h-5" />
          ملخص الأسعار الحالية
        </h3>
        <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div className="bg-white rounded-xl p-4 shadow">
            <div className="flex items-center justify-between">
              <span className="font-semibold"> باقة التميز</span>
              <span className={`px-3 py-1 rounded-full text-sm font-bold ${packageSettings.premium.isEnabled ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700'}`}>
                {packageSettings.premium.isEnabled ? 'مفعّلة' : 'موقوفة'}
              </span>
            </div>
            <p className="text-3xl font-bold text-amber-600 mt-2">
              {calculateDiscountedPrice(packageSettings.premium).toFixed(0)} ريال
              {isDiscountValid(packageSettings.premium.discount) && (
                <span className="text-sm text-red-500 mr-2 bg-red-50 px-2 py-1 rounded-full">خصم!</span>
              )}
            </p>
            <p className="text-gray-500 text-sm">لمدة {packageSettings.premium.durationDays} يوم</p>
          </div>
          <div className="bg-white rounded-xl p-4 shadow">
            <div className="flex items-center justify-between">
              <span className="font-semibold"> الباقة المجانية</span>
              <span className={`px-3 py-1 rounded-full text-sm font-bold ${packageSettings.free.isEnabled ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700'}`}>
                {packageSettings.free.isEnabled ? 'مفعّلة' : 'موقوفة'}
              </span>
            </div>
            <p className="text-3xl font-bold text-green-600 mt-2">مجاناً</p>
            <p className="text-gray-500 text-sm">بدون رسوم</p>
          </div>
        </div>
      </div>
    </div>
  )
}

==========================================================================================
FILE: src/pages/EditRestaurant.tsx
==========================================================================================
// src/pages/EditRestaurant.tsx
import React, { useEffect, useMemo, useState } from "react"
import { ref, uploadBytes, getDownloadURL } from "firebase/storage"
import { doc, getDoc, setDoc } from "firebase/firestore"
import { db, storage } from "@/firebase"
import { useAuth } from "@/auth"
import { useToast } from "@/components/ui/Toast"
import { SAUDI_CITIES } from "@/utils/cities"
import { MapPin, FileText, ShieldCheck, AlertCircle, CheckCircle, Clock, Store, Building2, Briefcase, Lock } from "lucide-react"

type RestaurantForm = {
  name: string
  phone: string
  city: string
  location: string
  logoUrl?: string
  isOpen?: boolean // هل المتجر مفتوح للطلبات
  allowDelivery?: boolean // السماح بالتوصيل
  allowPickup?: boolean // السماح بالاستلام من المطعم
  cuisineType?: string // نوع المطبخ
  commercialLicenseUrl?: string
  licenseStatus?: 'pending' | 'approved' | 'rejected'
  licenseNotes?: string
  // بيانات الحساب البنكي
  bankName?: string
  bankAccountName?: string
  bankAccountNumber?: string
  // بيانات التوظيف
  isHiring?: boolean
  hiringDescription?: string
  hiringContact?: string
}

// أنواع المطابخ
const CUISINE_TYPES = [
  { value: '', label: 'اختر نوع المطبخ' },
  { value: 'traditional', label: ' أكلات شعبية' },
  { value: 'sweets', label: ' حلويات' },
  { value: 'pastries', label: ' معجنات' },
  { value: 'grills', label: ' مشويات' },
  { value: 'healthy', label: ' أكل صحي' },
  { value: 'international', label: ' أكلات عالمية' },
]

export const EditRestaurant: React.FC = () => {
  const { user } = useAuth()
  const toast = useToast()

  const [form, setForm] = useState<RestaurantForm>({
    name: "",
    phone: "",
    city: "",
    location: "",
    logoUrl: "",
    isOpen: true, // المتجر مفتوح افتراضياً
    allowDelivery: true, // التوصيل مفعل افتراضياً
    allowPickup: false,
    cuisineType: "",
    commercialLicenseUrl: "",
    licenseStatus: undefined,
    licenseNotes: "",
    bankName: "",
    bankAccountName: "",
    bankAccountNumber: "",
    isHiring: false,
    hiringDescription: "",
    hiringContact: "",
  })

  const [file, setFile] = useState<File | null>(null)
  const [preview, setPreview] = useState<string>("")
  const [commercialFile, setCommercialFile] = useState<File | null>(null)
  const [loading, setLoading] = useState<boolean>(true)
  const [saving, setSaving] = useState<boolean>(false)
  const canSave = useMemo(() => !saving && !!user, [saving, user])

  // ====== Load current data ======
  useEffect(() => {
    if (!user) return
    ;(async () => {
      try {
        // جلب بيانات المطعم الأساسية
        const snap = await getDoc(doc(db, "restaurants", user.uid))
        if (snap.exists()) {
          const data = snap.data() as RestaurantForm
          
          // جلب بيانات البنك من subcollection منفصل (محمي)
          let bankData = { bankName: "", bankAccountName: "", bankAccountNumber: "" }
          try {
            const bankSnap = await getDoc(doc(db, "restaurants", user.uid, "private", "bankInfo"))
            if (bankSnap.exists()) {
              const bd = bankSnap.data()
              bankData = {
                bankName: bd.bankName ?? "",
                bankAccountName: bd.bankAccountName ?? "",
                bankAccountNumber: bd.bankAccountNumber ?? "",
              }
            }
          } catch (e) {
            // بيانات البنك غير موجودة - هذا طبيعي
          }
          
          setForm({
            name: data.name ?? "",
            phone: data.phone ?? "",
            city: data.city ?? "",
            location: data.location ?? "",
            logoUrl: data.logoUrl ?? "",
            isOpen: (data as any).isOpen ?? true,
            allowDelivery: (data as any).allowDelivery ?? true,
            allowPickup: (data as any).allowPickup ?? false,
            cuisineType: (data as any).cuisineType ?? "",
            commercialLicenseUrl: (data as any).commercialLicenseUrl ?? "",
            licenseStatus: (data as any).licenseStatus,
            licenseNotes: (data as any).licenseNotes ?? "",
            bankName: bankData.bankName,
            bankAccountName: bankData.bankAccountName,
            bankAccountNumber: bankData.bankAccountNumber,
            isHiring: (data as any).isHiring ?? false,
            hiringDescription: (data as any).hiringDescription ?? "",
            hiringContact: (data as any).hiringContact ?? "",
          })
        }
      } catch (e: any) {
        toast.error("تعذّرت قراءة بيانات المطعم")
        // console.error(e)
      } finally {
        setLoading(false)
      }
    })()
  }, [user, toast])

  // نظافة معاينة blob
  useEffect(() => {
    return () => {
      if (preview) URL.revokeObjectURL(preview)
    }
  }, [preview])

  // ====== Handlers ======
  const onChange = (e: React.ChangeEvent<HTMLInputElement>) => {
    const { name, value } = e.target
    setForm((p) => ({ ...p, [name]: value }))
  }

  const onPickLogo = (e: React.ChangeEvent<HTMLInputElement>) => {
    const f = e.target.files?.[0] || null
    setFile(f)
    if (f) {
      const url = URL.createObjectURL(f)
      setPreview(url)
    } else {
      setPreview("")
    }
  }

  const uploadLogoIfNeeded = async (): Promise<string | undefined> => {
    if (!user || !file) return undefined

    // فحص خفيف: نوع/حجم
    const isImage = /^image\//.test(file.type)
    if (!isImage) {
      toast.warning("الملف المختار ليس صورة")
      return undefined
    }
    const MAX = 3 * 1024 * 1024 // 3MB
    if (file.size > MAX) {
      toast.warning("حجم الصورة كبير، يرجى اختيار صورة أقل من 3MB")
      return undefined
    }

    // اسم ملف فريد + امتداد صحيح
    const cleanName = file.name.replace(/\s+/g, "_")
    const path = `restaurants/${user.uid}/logo_${Date.now()}_${cleanName}`
    const r = ref(storage, path)
    const metadata = {
      contentType: file.type || "image/jpeg",
      cacheControl: "public,max-age=31536000,immutable",
    }

    // رفع
    await uploadBytes(r, file, metadata)
    const url = await getDownloadURL(r)

    // كسر الكاش على واجهة العميل عند التبديل مباشرة
    const busted = `${url}${url.includes("?") ? "&" : "?"}v=${Date.now()}`
    return busted
  }

  // رفع ملف الترخيص
  const uploadLicenseFile = async (licenseFile: File, type: 'commercial' | 'health'): Promise<string | undefined> => {
    if (!user || !licenseFile) return undefined

    const isValidType = /^(image\/|application\/pdf)/.test(licenseFile.type)
    if (!isValidType) {
      toast.warning("الملف يجب أن يكون صورة أو PDF")
      return undefined
    }
    const MAX = 5 * 1024 * 1024 // 5MB
    if (licenseFile.size > MAX) {
      toast.warning("حجم الملف كبير، يرجى اختيار ملف أقل من 5MB")
      return undefined
    }

    const cleanName = licenseFile.name.replace(/\s+/g, "_")
    const path = `restaurants/${user.uid}/licenses/${type}_${Date.now()}_${cleanName}`
    const r = ref(storage, path)
    const metadata = {
      contentType: licenseFile.type,
      cacheControl: "public,max-age=31536000,immutable",
    }

    await uploadBytes(r, licenseFile, metadata)
    return await getDownloadURL(r)
  }

  const onSubmit = async (e: React.FormEvent) => {
    e.preventDefault()
    if (!user) {
      toast.warning(" يجب تسجيل الدخول أولاً")
      return
    }
    if (!form.name.trim()) {
      toast.warning("اكتب اسم المطعم")
      return
    }

    setSaving(true)
    try {
      let logoUrl = form.logoUrl
      let commercialLicenseUrl = form.commercialLicenseUrl
      let licenseStatus = form.licenseStatus

      if (file) {
        toast.info(" جاري رفع الشعار …")
        const uploaded = await uploadLogoIfNeeded()
        if (uploaded) logoUrl = uploaded
      }

      // رفع الرخصة التجارية
      if (commercialFile) {
        toast.info(" جاري رفع الرخصة التجارية …")
        const uploaded = await uploadLicenseFile(commercialFile, 'commercial')
        if (uploaded) {
          commercialLicenseUrl = uploaded
          licenseStatus = 'pending' // إعادة المراجعة عند تحديث الترخيص
        }
      }

      // حفظ بيانات المطعم الأساسية (اسم البنك فقط للعرض، باقي البيانات الحساسة في subcollection)
      const { bankAccountName, bankAccountNumber, ...publicData } = form
      
      await setDoc(
        doc(db, "restaurants", user.uid),
        { 
          ...publicData, 
          logoUrl,
          commercialLicenseUrl,
          licenseStatus,
        },
        { merge: true }
      )

      // حفظ بيانات البنك في subcollection محمي منفصل
      if (form.bankName || bankAccountName || bankAccountNumber) {
        await setDoc(
          doc(db, "restaurants", user.uid, "private", "bankInfo"),
          {
            bankName: form.bankName || "",
            bankAccountName: bankAccountName || "",
            bankAccountNumber: bankAccountNumber || "",
          },
          { merge: true }
        )
      }

      // تنظيف الملفات
      if (preview) URL.revokeObjectURL(preview)
      setPreview("")
      setFile(null)
      setCommercialFile(null)

      toast.success("تم حفظ التعديلات بنجاح ", { title: "تعديل المطعم" })
    } catch (err: any) {
      // أمور شائعة: App Check، قواعد Storage/Firestore، صلاحيات المستخدم
      toast.error(`فشل الحفظ: ${err?.message || "خطأ غير معروف"}`)
      // console.error("Save error:", err)
    } finally {
      setSaving(false)
    }
  }

  if (loading) return <div className="p-6 text-center">جارِ التحميل…</div>

  return (
    <div className="max-w-md mx-auto p-6 bg-white rounded-2xl shadow-lg mt-8 text-gray-900">
      <h1 className="text-2xl font-bold text-center mb-6">تعديل بيانات المطعم</h1>

      <form onSubmit={onSubmit} className="space-y-4">
        {/* Logo picker + tiny preview */}
        <div className="space-y-2">
          <label className="block font-semibold">شعار المطعم</label>

          <div className="flex items-center gap-3">
            {/* أيقونة معاينة صغيرة */}
            <div className="w-14 h-14 rounded-full overflow-hidden border bg-gray-100 shrink-0">
              {/* الأولوية: المعاينة • بعدها الشعار المحفوظ */}
              {(preview || form.logoUrl) ? (
                <img
                  src={preview || form.logoUrl}
                  className="w-full h-full object-cover"
                  onError={(e: any) => (e.currentTarget.style.display = "none")}
                  alt="logo"
                />
              ) : null}
            </div>

            <input type="file" accept="image/*" onChange={onPickLogo} />
          </div>

          {file && (
            <div className="text-xs text-gray-600">
              سيتم رفع: <span className="font-semibold">{file.name}</span>
            </div>
          )}
        </div>

        <input
          name="name"
          placeholder="اسم المطعم"
          value={form.name}
          onChange={onChange}
          className="w-full border p-3 rounded-xl"
        />
        <input
          name="phone"
          placeholder="رقم الجوال"
          value={form.phone}
          onChange={onChange}
          className="w-full border p-3 rounded-xl"
        />
        <div className="relative">
          <MapPin className="absolute right-3 top-1/2 -translate-y-1/2 w-5 h-5 text-sky-400 pointer-events-none" />
          <select
            name="city"
            value={form.city}
            onChange={(e) => setForm(p => ({ ...p, city: e.target.value }))}
            className="w-full border p-3 pr-10 rounded-xl bg-white appearance-none cursor-pointer focus:border-sky-400 focus:ring-2 focus:ring-sky-100"
          >
            <option value="">اختر المدينة</option>
            {SAUDI_CITIES.map(city => (
              <option key={city} value={city}>{city}</option>
            ))}
          </select>
        </div>
        <input
          name="location"
          placeholder="الموقع"
          value={form.location}
          onChange={onChange}
          className="w-full border p-3 rounded-xl"
        />

        {/* نوع المطبخ */}
        <div className="relative">
          <select
            name="cuisineType"
            value={form.cuisineType || ''}
            onChange={(e) => setForm(p => ({ ...p, cuisineType: e.target.value }))}
            className="w-full border p-3 rounded-xl bg-white appearance-none cursor-pointer focus:border-amber-400 focus:ring-2 focus:ring-amber-100"
          >
            {CUISINE_TYPES.map(cuisine => (
              <option key={cuisine.value} value={cuisine.value}>{cuisine.label}</option>
            ))}
          </select>
          <span className="absolute left-3 top-1/2 -translate-y-1/2 text-gray-400 text-sm pointer-events-none">
            نوع المطبخ
          </span>
        </div>

        {/* قسم خيارات التوصيل والاستلام */}
        <div className="border-t pt-4 mt-4">
          <h2 className="text-lg font-bold mb-4 flex items-center gap-2">
            <Store className="w-5 h-5 text-green-500" />
            خيارات الطلب
          </h2>
          
          {/* زر حالة المتجر: متاح/مغلق */}
          <div className={`flex items-center justify-between p-4 rounded-xl mb-3 ${form.isOpen ? 'bg-green-50 border-2 border-green-200' : 'bg-red-50 border-2 border-red-200'}`}>
            <div className="flex items-center gap-3">
              <div className={`w-10 h-10 rounded-xl flex items-center justify-center ${form.isOpen ? 'bg-green-500' : 'bg-red-500'}`}>
                {form.isOpen ? (
                  <Store className="w-5 h-5 text-white" />
                ) : (
                  <Lock className="w-5 h-5 text-white" />
                )}
              </div>
              <div>
                <p className={`font-semibold ${form.isOpen ? 'text-green-800' : 'text-red-800'}`}>
                  {form.isOpen ? ' المتجر متاح' : ' المتجر مغلق'}
                </p>
                <p className="text-sm text-gray-500">
                  {form.isOpen ? 'العملاء يمكنهم الطلب الآن' : 'الطلبات معطلة مؤقتاً'}
                </p>
              </div>
            </div>
            <button
              type="button"
              onClick={() => setForm(p => ({ ...p, isOpen: !p.isOpen }))}
              className={`relative w-14 h-8 rounded-full transition-colors ${form.isOpen ? 'bg-green-500' : 'bg-red-400'}`}
            >
              <span className={`absolute top-1 w-6 h-6 bg-white rounded-full shadow transition-transform ${form.isOpen ? 'right-1' : 'left-1'}`} />
            </button>
          </div>
          {!form.isOpen && (
            <p className="mb-3 text-sm text-red-600 bg-red-50 p-2 rounded-lg">
               المتجر مغلق - العملاء لن يتمكنوا من إضافة أصناف للسلة
            </p>
          )}

          {/* زر تفعيل التوصيل */}
          <div className="flex items-center justify-between p-4 bg-gray-50 rounded-xl mb-3">
            <div className="flex items-center gap-3">
              <div className={`w-10 h-10 rounded-xl flex items-center justify-center ${form.allowDelivery ? 'bg-sky-500' : 'bg-gray-300'}`}>
                <MapPin className="w-5 h-5 text-white" />
              </div>
              <div>
                <p className="font-semibold text-gray-800">التوصيل للعملاء</p>
                <p className="text-sm text-gray-500">توصيل الطلبات لموقع العميل</p>
              </div>
            </div>
            <button
              type="button"
              onClick={() => setForm(p => ({ ...p, allowDelivery: !p.allowDelivery }))}
              className={`relative w-14 h-8 rounded-full transition-colors ${form.allowDelivery ? 'bg-sky-500' : 'bg-gray-300'}`}
            >
              <span className={`absolute top-1 w-6 h-6 bg-white rounded-full shadow transition-transform ${form.allowDelivery ? 'right-1' : 'left-1'}`} />
            </button>
          </div>
          {form.allowDelivery && (
            <p className="mb-3 text-sm text-sky-600 bg-sky-50 p-2 rounded-lg">
               التوصيل مفعّل - ستظهر علامة "توصيل" بجانب مطعمك للعملاء
            </p>
          )}
          
          {/* زر تفعيل الاستلام من المطعم */}
          <div className="flex items-center justify-between p-4 bg-gray-50 rounded-xl">
            <div className="flex items-center gap-3">
              <div className={`w-10 h-10 rounded-xl flex items-center justify-center ${form.allowPickup ? 'bg-green-500' : 'bg-gray-300'}`}>
                <Store className="w-5 h-5 text-white" />
              </div>
              <div>
                <p className="font-semibold text-gray-800">الاستلام من المطعم</p>
                <p className="text-sm text-gray-500">السماح للعملاء باستلام طلباتهم من موقع المطعم</p>
              </div>
            </div>
            <button
              type="button"
              onClick={() => setForm(p => ({ ...p, allowPickup: !p.allowPickup }))}
              className={`relative w-14 h-8 rounded-full transition-colors ${form.allowPickup ? 'bg-green-500' : 'bg-gray-300'}`}
            >
              <span className={`absolute top-1 w-6 h-6 bg-white rounded-full shadow transition-transform ${form.allowPickup ? 'right-1' : 'left-1'}`} />
            </button>
          </div>
          {form.allowPickup && (
            <p className="mt-2 text-sm text-green-600 bg-green-50 p-2 rounded-lg">
               العملاء يمكنهم اختيار استلام طلباتهم من موقع المطعم (بدون رسوم توصيل)
            </p>
          )}
        </div>

        {/* قسم التراخيص */}
        <div className="border-t pt-4 mt-4">
          <h2 className="text-lg font-bold mb-4 flex items-center gap-2">
            <FileText className="w-5 h-5 text-sky-500" />
            التراخيص والشهادات
          </h2>

          {/* حالة التراخيص */}
          {form.licenseStatus && (
            <div className={`mb-4 p-3 rounded-xl flex items-center gap-2 ${
              form.licenseStatus === 'approved' ? 'bg-green-50 text-green-700' :
              form.licenseStatus === 'rejected' ? 'bg-red-50 text-red-700' :
              'bg-yellow-50 text-yellow-700'
            }`}>
              {form.licenseStatus === 'approved' && <CheckCircle className="w-5 h-5" />}
              {form.licenseStatus === 'rejected' && <AlertCircle className="w-5 h-5" />}
              {form.licenseStatus === 'pending' && <Clock className="w-5 h-5" />}
              <span className="font-semibold">
                {form.licenseStatus === 'approved' && 'التراخيص موافق عليها '}
                {form.licenseStatus === 'rejected' && 'التراخيص مرفوضة'}
                {form.licenseStatus === 'pending' && 'التراخيص قيد المراجعة...'}
              </span>
            </div>
          )}
          {form.licenseNotes && form.licenseStatus === 'rejected' && (
            <div className="mb-4 p-3 bg-red-50 rounded-xl text-red-600 text-sm">
              <strong>ملاحظات:</strong> {form.licenseNotes}
            </div>
          )}

          {/* الرخصة التجارية */}
          <div className="space-y-2 mb-4">
            <label className="block font-semibold text-gray-700 flex items-center gap-2">
              <ShieldCheck className="w-4 h-4 text-orange-500" />
              الرخصة التجارية
            </label>
            <div className="flex items-center gap-3">
              {form.commercialLicenseUrl && (
                <a 
                  href={form.commercialLicenseUrl} 
                  target="_blank" 
                  rel="noopener noreferrer"
                  className="text-sky-500 hover:text-sky-700 text-sm underline"
                >
                  عرض الملف الحالي
                </a>
              )}
              <input 
                type="file" 
                accept="image/*,.pdf" 
                onChange={(e) => setCommercialFile(e.target.files?.[0] || null)}
                className="text-sm"
              />
            </div>
            {commercialFile && (
              <div className="text-xs text-gray-600">
                سيتم رفع: <span className="font-semibold">{commercialFile.name}</span>
              </div>
            )}
          </div>

        </div>

        {/* قسم بيانات الحساب البنكي */}
        <div className="border-t pt-4 mt-4">
          <h2 className="text-lg font-bold mb-4 flex items-center gap-2">
            <Building2 className="w-5 h-5 text-green-500" />
            بيانات الحساب البنكي
          </h2>
          <p className="text-sm text-gray-500 mb-4 bg-green-50 p-3 rounded-xl">
             أدخل بيانات حسابك البنكي ليتمكن العملاء من تحويل مبلغ الطلب مباشرة
          </p>

          <div className="space-y-3">
            <div className="relative">
              <select
                name="bankName"
                value={form.bankName || ""}
                onChange={(e) => setForm(p => ({ ...p, bankName: e.target.value }))}
                className="w-full border p-3 rounded-xl bg-white appearance-none cursor-pointer focus:border-green-400 focus:ring-2 focus:ring-green-100"
              >
                <option value="">اختر البنك</option>
                <option value="الراجحي">بنك الراجحي</option>
                <option value="الأهلي">البنك الأهلي السعودي</option>
                <option value="الإنماء">مصرف الإنماء</option>
                <option value="الرياض">بنك الرياض</option>
                <option value="البلاد">بنك البلاد</option>
                <option value="الجزيرة">بنك الجزيرة</option>
                <option value="العربي">البنك العربي الوطني</option>
                <option value="السعودي الفرنسي">البنك السعودي الفرنسي</option>
                <option value="ساب">بنك ساب</option>
                <option value="stc pay">STC Pay</option>
                <option value="أخرى">أخرى</option>
              </select>
            </div>

            <input
              name="bankAccountName"
              placeholder="اسم صاحب الحساب"
              value={form.bankAccountName || ""}
              onChange={onChange}
              className="w-full border p-3 rounded-xl focus:border-green-400 focus:ring-2 focus:ring-green-100"
            />

            <input
              name="bankAccountNumber"
              placeholder="رقم الآيبان أو الحساب"
              value={form.bankAccountNumber || ""}
              onChange={onChange}
              className="w-full border p-3 rounded-xl focus:border-green-400 focus:ring-2 focus:ring-green-100 font-mono text-left"
              dir="ltr"
            />

            {form.bankName && form.bankAccountName && form.bankAccountNumber && (
              <div className="bg-green-50 border border-green-200 rounded-xl p-3 text-green-700 text-sm">
                 بيانات البنك مكتملة - سيتمكن العملاء من رؤيتها عند الطلب
              </div>
            )}
          </div>
        </div>

        {/* قسم التوظيف */}
        <div className="border-t pt-4 mt-4">
          <h2 className="text-lg font-bold mb-4 flex items-center gap-2">
            <Briefcase className="w-5 h-5 text-purple-500" />
            توظيف عاملات للطبخ
          </h2>
          <p className="text-sm text-gray-500 mb-4 bg-purple-50 p-3 rounded-xl">
             فعّل هذا الخيار إذا كنت تبحث عن عاملات للمساعدة في الطبخ
          </p>

          {/* زر تفعيل التوظيف */}
          <div className="flex items-center justify-between p-4 bg-gray-50 rounded-xl mb-4">
            <div className="flex items-center gap-3">
              <div className={`w-10 h-10 rounded-xl flex items-center justify-center ${form.isHiring ? 'bg-purple-500' : 'bg-gray-300'}`}>
                <Briefcase className="w-5 h-5 text-white" />
              </div>
              <div>
                <p className="font-semibold text-gray-800">البحث عن موظفات</p>
                <p className="text-sm text-gray-500">عرض إعلان توظيف في صفحتك</p>
              </div>
            </div>
            <button
              type="button"
              onClick={() => setForm(p => ({ ...p, isHiring: !p.isHiring }))}
              className={`relative w-14 h-8 rounded-full transition-colors ${form.isHiring ? 'bg-purple-500' : 'bg-gray-300'}`}
            >
              <span className={`absolute top-1 w-6 h-6 bg-white rounded-full shadow transition-transform ${form.isHiring ? 'right-1' : 'left-1'}`} />
            </button>
          </div>

          {form.isHiring && (
            <div className="space-y-3 bg-purple-50 p-4 rounded-xl">
              <textarea
                name="hiringDescription"
                placeholder="وصف الوظيفة المطلوبة (مثال: نبحث عن طباخة ماهرة للعمل بدوام جزئي...)"
                value={form.hiringDescription || ""}
                onChange={(e) => setForm(p => ({ ...p, hiringDescription: e.target.value }))}
                className="w-full border p-3 rounded-xl focus:border-purple-400 focus:ring-2 focus:ring-purple-100 min-h-[100px]"
                rows={3}
              />

              <input
                name="hiringContact"
                placeholder="رقم التواصل للتوظيف (واتساب)"
                value={form.hiringContact || ""}
                onChange={onChange}
                className="w-full border p-3 rounded-xl focus:border-purple-400 focus:ring-2 focus:ring-purple-100"
              />

              {form.hiringDescription && form.hiringContact && (
                <div className="bg-purple-100 border border-purple-200 rounded-xl p-3 text-purple-700 text-sm">
                   إعلان التوظيف جاهز للعرض في صفحتك
                </div>
              )}
            </div>
          )}
        </div>

        <button
          type="submit"
          disabled={!canSave}
          className="w-full bg-gray-900 hover:bg-gray-800 text-white py-3 rounded-xl font-semibold transition disabled:opacity-60"
        >
          {saving ? "جارٍ الحفظ…" : "حفظ"}
        </button>
      </form>
    </div>
  )
}

export default EditRestaurant

==========================================================================================
FILE: src/pages/Landing.tsx
==========================================================================================
// src/pages/Landing.tsx
import React from "react";
import { Link } from "react-router-dom";
import { useAuth } from "@/auth";
import { 
  Store, ShoppingCart, Package, User, Truck, Shield, Code2, 
  ChefHat, ClipboardList, Settings, LogIn, UserPlus, Phone, Loader2
} from "lucide-react";

// مربع القسم - محسن للجوال
const SectionCard: React.FC<{
  to: string;
  icon: React.ReactNode;
  label: string;
  color: string;
  emoji?: string;
}> = ({ to, icon, label, color, emoji }) => (
  <Link
    to={to}
    className={`flex flex-col items-center justify-center gap-2 p-4 sm:p-5 rounded-2xl bg-gradient-to-br ${color} text-white shadow-lg shadow-sky-200/30 active:scale-95 transition-all duration-200 backdrop-blur-sm`}
  >
    <div className="w-12 h-12 sm:w-14 sm:h-14 bg-white/25 backdrop-blur rounded-xl flex items-center justify-center">
      {emoji ? <span className="text-2xl sm:text-3xl">{emoji}</span> : icon}
    </div>
    <span className="font-bold text-sm sm:text-base text-center leading-tight">{label}</span>
  </Link>
);

export const Landing: React.FC = () => {
  const { user, role, loading, logout } = useAuth();

  // حالة التحميل - منع ظهور صفحة الزائر أثناء التحقق من الجلسة
  if (loading) {
    return (
      <div className="min-h-screen flex flex-col items-center justify-center bg-gradient-to-br from-sky-50 via-white to-sky-100">
        <div className="w-20 h-20 mb-6 bg-gradient-to-br from-sky-500 to-sky-600 rounded-3xl flex items-center justify-center shadow-2xl animate-pulse">
          <span className="text-5xl"></span>
        </div>
        <Loader2 className="w-8 h-8 text-sky-500 animate-spin mb-3" />
        <p className="text-sky-600 font-semibold">جارِ التحميل...</p>
      </div>
    );
  }

  return (
    <div className="min-h-screen bg-gradient-to-br from-sky-50 via-white to-sky-100 px-3 py-4 sm:px-4 sm:py-6">
      
      {/* الشعار والترحيب - أصغر للجوال */}
      <div className="text-center mb-6">
        <div className="w-16 h-16 sm:w-20 sm:h-20 mx-auto mb-3 bg-gradient-to-br from-sky-500 to-sky-600 rounded-2xl sm:rounded-3xl flex items-center justify-center shadow-xl">
          <span className="text-4xl sm:text-5xl"></span>
        </div>
        <h1 className="text-2xl sm:text-3xl font-black text-transparent bg-clip-text bg-gradient-to-r from-sky-600 to-sky-500 mb-1">
          سفرة البيت
        </h1>
        {user && (
          <p className="text-sky-600/80 text-sm">
            أهلاً {user.displayName || user.email?.split('@')[0]} 
          </p>
        )}
      </div>

      {/* ===== أقسام الزائر (غير مسجل) ===== */}
      {!user && (
        <div className="max-w-sm mx-auto space-y-4">
          <div className="grid grid-cols-2 gap-3">
            <SectionCard
              to="/restaurants"
              emoji=""
              icon={<Store className="w-6 h-6" />}
              label="تصفح المطاعم"
              color="from-sky-500 to-sky-600"
            />
            <SectionCard
              to="/customer-login"
              emoji=""
              icon={<Phone className="w-6 h-6" />}
              label="دخول بالجوال"
              color="from-green-500 to-green-600"
            />
            <SectionCard
              to="/login"
              emoji=""
              icon={<LogIn className="w-6 h-6" />}
              label="دخول بالإيميل"
              color="from-amber-500 to-orange-500"
            />
            <SectionCard
              to="/register"
              emoji=""
              icon={<UserPlus className="w-6 h-6" />}
              label="حساب جديد"
              color="from-purple-500 to-purple-600"
            />
          </div>
          <p className="text-center text-sky-600/70 text-xs">
            أشهى الأكلات البيتية توصلك لين بابك 
          </p>
        </div>
      )}

      {/* ===== أقسام العميل ===== */}
      {role === "customer" && (
        <div className="max-w-sm mx-auto space-y-4">
          <div className="grid grid-cols-2 gap-3">
            <SectionCard
              to="/restaurants"
              emoji=""
              icon={<Store className="w-6 h-6" />}
              label="اطلب الآن"
              color="from-sky-500 to-sky-600"
            />
            <SectionCard
              to="/cart"
              emoji=""
              icon={<ShoppingCart className="w-6 h-6" />}
              label="السلة"
              color="from-green-500 to-green-600"
            />
            <SectionCard
              to="/orders"
              emoji=""
              icon={<Package className="w-6 h-6" />}
              label="طلباتي"
              color="from-amber-500 to-orange-500"
            />
            <SectionCard
              to="/profile"
              emoji=""
              icon={<User className="w-6 h-6" />}
              label="بياناتي"
              color="from-purple-500 to-purple-600"
            />
          </div>
          <button
            onClick={logout}
            className="w-full py-3 rounded-xl glass-light text-sky-600 font-semibold text-sm active:bg-white/70 transition"
          >
             خروج
          </button>
        </div>
      )}

      {/* ===== أقسام صاحب المطعم ===== */}
      {role === "owner" && (
        <div className="max-w-sm mx-auto space-y-4">
          <div className="grid grid-cols-2 gap-3">
            <SectionCard
              to="/owner"
              emoji=""
              icon={<ChefHat className="w-6 h-6" />}
              label="لوحة التحكم"
              color="from-sky-500 to-sky-600"
            />
            <SectionCard
              to="/owner/orders"
              emoji=""
              icon={<ClipboardList className="w-6 h-6" />}
              label="الطلبات"
              color="from-green-500 to-green-600"
            />
            <SectionCard
              to="/owner/menu"
              emoji=""
              icon={<Store className="w-6 h-6" />}
              label="القائمة"
              color="from-amber-500 to-orange-500"
            />
            <SectionCard
              to="/owner/edit"
              emoji=""
              icon={<Settings className="w-6 h-6" />}
              label="بيانات المطعم"
              color="from-purple-500 to-purple-600"
            />
            <SectionCard
              to="/owner/courier-requests"
              emoji=""
              icon={<Truck className="w-6 h-6" />}
              label="المندوبين"
              color="from-cyan-500 to-cyan-600"
            />
            <SectionCard
              to="/profile"
              emoji=""
              icon={<User className="w-6 h-6" />}
              label="حسابي"
              color="from-gray-500 to-gray-600"
            />
          </div>
          <button
            onClick={logout}
            className="w-full py-3 rounded-xl glass-light text-sky-600 font-semibold text-sm active:bg-white/70 transition"
          >
             خروج
          </button>
        </div>
      )}

      {/* ===== أقسام المندوب ===== */}
      {role === "courier" && (
        <div className="max-w-sm mx-auto space-y-4">
          <div className="grid grid-cols-2 gap-3">
            <SectionCard
              to="/courier"
              emoji=""
              icon={<Truck className="w-6 h-6" />}
              label="طلبات جاهزة"
              color="from-sky-500 to-sky-600"
            />
            <SectionCard
              to="/courier/hiring"
              emoji=""
              icon={<Store className="w-6 h-6" />}
              label="انضم لمطعم"
              color="from-green-500 to-green-600"
            />
            <SectionCard
              to="/profile"
              emoji=""
              icon={<User className="w-6 h-6" />}
              label="حسابي"
              color="from-purple-500 to-purple-600"
            />
          </div>
          <button
            onClick={logout}
            className="w-full py-3 rounded-xl glass-light text-sky-600 font-semibold text-sm active:bg-white/70 transition"
          >
             خروج
          </button>
        </div>
      )}

      {/* ===== أقسام المشرف ===== */}
      {role === "admin" && (
        <div className="max-w-sm mx-auto space-y-4">
          <div className="grid grid-cols-2 gap-3">
            <SectionCard
              to="/admin"
              emoji=""
              icon={<Shield className="w-6 h-6" />}
              label="لوحة التحكم"
              color="from-sky-500 to-sky-600"
            />
            <SectionCard
              to="/admin/restaurants"
              emoji=""
              icon={<Store className="w-6 h-6" />}
              label="المطاعم"
              color="from-green-500 to-green-600"
            />
            <SectionCard
              to="/admin/orders"
              emoji=""
              icon={<Package className="w-6 h-6" />}
              label="الطلبات"
              color="from-amber-500 to-orange-500"
            />
            <SectionCard
              to="/restaurants"
              emoji=""
              icon={<ShoppingCart className="w-6 h-6" />}
              label="اطلب كعميل"
              color="from-purple-500 to-purple-600"
            />
            <SectionCard
              to="/profile"
              emoji=""
              icon={<User className="w-6 h-6" />}
              label="حسابي"
              color="from-gray-500 to-gray-600"
            />
          </div>
          <button
            onClick={logout}
            className="w-full py-3 rounded-xl glass-light text-sky-600 font-semibold text-sm active:bg-white/70 transition"
          >
             خروج
          </button>
        </div>
      )}

      {/* ===== أقسام المطور ===== */}
      {role === "developer" && (
        <div className="max-w-sm mx-auto space-y-4">
          <div className="grid grid-cols-2 gap-3">
            <SectionCard
              to="/developer"
              emoji=""
              icon={<Code2 className="w-6 h-6" />}
              label="لوحة التحكم"
              color="from-sky-500 to-sky-600"
            />
            <SectionCard
              to="/restaurants"
              emoji=""
              icon={<Store className="w-6 h-6" />}
              label="المطاعم"
              color="from-green-500 to-green-600"
            />
            <SectionCard
              to="/admin/orders"
              emoji=""
              icon={<Package className="w-6 h-6" />}
              label="الطلبات"
              color="from-amber-500 to-orange-500"
            />
            <SectionCard
              to="/profile"
              emoji=""
              icon={<User className="w-6 h-6" />}
              label="حسابي"
              color="from-purple-500 to-purple-600"
            />
          </div>
          <button
            onClick={logout}
            className="w-full py-3 rounded-xl glass-light text-sky-600 font-semibold text-sm active:bg-white/70 transition"
          >
             خروج
          </button>
        </div>
      )}

    </div>
  );
};

==========================================================================================
FILE: src/pages/LiveSupportPage.tsx
==========================================================================================
// src/pages/LiveSupportPage.tsx
// نظام الدعم الفني المباشر - محادثة في الوقت الفعلي
import React, { useState, useEffect, useRef } from 'react'
import { useNavigate } from 'react-router-dom'
import { 
  collection, addDoc, query, where, orderBy, 
  onSnapshot, serverTimestamp, doc, updateDoc, limit, getDocs
} from 'firebase/firestore'
import { db } from '@/firebase'
import { useAuth } from '@/auth'
import { useToast } from '@/components/ui/Toast'
import { 
  Headphones, Send, ChevronRight, Loader2, 
  MessageCircle, Clock, CheckCircle, Bot,
  User, Paperclip, Image, AlertTriangle,
  Sparkles, HelpCircle, Phone, X
} from 'lucide-react'

// أنواع الرسائل
type MessageType = 'user' | 'support' | 'system' | 'bot'

interface SupportMessage {
  id?: string
  chatId: string
  senderId: string
  senderName: string
  senderRole: 'user' | 'support' | 'bot'
  message: string
  type: MessageType
  createdAt: any
  read?: boolean
  imageUrl?: string
}

interface SupportChat {
  id?: string
  userId: string
  userName: string
  userRole: string
  userPhone?: string
  status: 'active' | 'waiting' | 'resolved' | 'closed'
  subject?: string
  priority: 'low' | 'medium' | 'high' | 'urgent'
  assignedTo?: string
  lastMessage?: string
  lastMessageAt?: any
  createdAt: any
  updatedAt: any
  unreadByUser?: number
  unreadBySupport?: number
}

// الردود الآلية السريعة
const AUTO_REPLIES = [
  {
    keywords: ['مرحبا', 'السلام', 'هلا', 'اهلا'],
    reply: 'أهلاً وسهلاً!  كيف يمكنني مساعدتك اليوم؟'
  },
  {
    keywords: ['طلب', 'متأخر', 'تأخر', 'وين الطلب'],
    reply: 'نعتذر عن التأخير! هل يمكنك إخباري برقم الطلب لمتابعته؟'
  },
  {
    keywords: ['الغاء', 'الغي', 'ألغي', 'رجع فلوسي'],
    reply: 'سأساعدك في إلغاء الطلب. ما رقم الطلب؟ وما سبب الإلغاء؟'
  },
  {
    keywords: ['شكرا', 'مشكور', 'تسلم'],
    reply: 'العفو! سعيدين بخدمتك  هل تحتاج أي مساعدة أخرى؟'
  }
]

// الأسئلة الشائعة
const FAQ_ITEMS = [
  { q: 'كيف ألغي طلبي؟', icon: '' },
  { q: 'أين طلبي الآن؟', icon: '' },
  { q: 'مشكلة في الدفع', icon: '' },
  { q: 'شكوى على الأسرة', icon: '' },
  { q: 'شكوى على المندوب', icon: '' },
  { q: 'أخرى', icon: '' },
]

export const LiveSupportPage: React.FC = () => {
  const nav = useNavigate()
  const { user, role } = useAuth()
  const toast = useToast()
  const messagesEndRef = useRef<HTMLDivElement>(null)
  const inputRef = useRef<HTMLInputElement>(null)

  // الحالات
  const [chat, setChat] = useState<SupportChat | null>(null)
  const [messages, setMessages] = useState<SupportMessage[]>([])
  const [loading, setLoading] = useState(true)
  const [sending, setSending] = useState(false)
  const [inputText, setInputText] = useState('')
  const [showFAQ, setShowFAQ] = useState(true)
  const [typing, setTyping] = useState(false)

  // جلب أو إنشاء المحادثة
  useEffect(() => {
    if (!user?.uid) return

    const initChat = async () => {
      // البحث عن محادثة نشطة
      const q = query(
        collection(db, 'supportChats'),
        where('userId', '==', user.uid),
        where('status', 'in', ['active', 'waiting']),
        limit(1)
      )

      const snap = await getDocs(q)
      
      if (!snap.empty) {
        // محادثة موجودة
        const chatData = { id: snap.docs[0].id, ...snap.docs[0].data() } as SupportChat
        setChat(chatData)
        setShowFAQ(false)
      }
      
      setLoading(false)
    }

    initChat()
  }, [user?.uid])

  // الاستماع للرسائل
  useEffect(() => {
    if (!chat?.id) return

    const q = query(
      collection(db, 'supportChats', chat.id, 'messages'),
      orderBy('createdAt', 'asc')
    )

    const unsub = onSnapshot(q, (snap) => {
      const msgs = snap.docs.map(d => ({ id: d.id, ...d.data() } as SupportMessage))
      setMessages(msgs)
      
      // تحديث القراءة
      if (msgs.some(m => !m.read && m.senderRole === 'support')) {
        updateDoc(doc(db, 'supportChats', chat.id!), {
          unreadByUser: 0
        })
      }
    })

    return () => unsub()
  }, [chat?.id])

  // التمرير للأسفل عند الرسائل الجديدة
  useEffect(() => {
    messagesEndRef.current?.scrollIntoView({ behavior: 'smooth' })
  }, [messages, typing])

  // إنشاء محادثة جديدة
  const startNewChat = async (subject?: string) => {
    if (!user?.uid) return

    try {
      const chatData: Partial<SupportChat> = {
        userId: user.uid,
        userName: user.displayName || 'مستخدم',
        userRole: role || 'customer',
        status: 'waiting',
        subject: subject || 'استفسار عام',
        priority: 'medium',
        createdAt: serverTimestamp(),
        updatedAt: serverTimestamp(),
        unreadByUser: 0,
        unreadBySupport: 1,
      }

      const docRef = await addDoc(collection(db, 'supportChats'), chatData)
      const newChat = { id: docRef.id, ...chatData } as SupportChat
      setChat(newChat)
      setShowFAQ(false)

      // إرسال رسالة ترحيبية
      await addDoc(collection(db, 'supportChats', docRef.id, 'messages'), {
        chatId: docRef.id,
        senderId: 'bot',
        senderName: 'مساعد سفرة البيت',
        senderRole: 'bot',
        message: `مرحباً ${user.displayName || 'عزيزي العميل'}! \n\nأنا مساعدك الآلي. أخبرني بمشكلتك وسأحاول مساعدتك، أو سيتواصل معك فريق الدعم خلال دقائق.\n\n${subject ? `موضوع الاستفسار: ${subject}` : ''}`,
        type: 'bot',
        createdAt: serverTimestamp(),
        read: false,
      })

      // تركيز حقل الإدخال
      setTimeout(() => inputRef.current?.focus(), 100)

    } catch (err) {
      console.error('Error starting chat:', err)
      toast.error('حدث خطأ، حاول مرة أخرى')
    }
  }

  // إرسال رسالة
  const sendMessage = async (text?: string) => {
    const messageText = text || inputText.trim()
    if (!messageText || !chat?.id || sending) return

    setSending(true)
    setInputText('')

    try {
      // إضافة رسالة المستخدم
      await addDoc(collection(db, 'supportChats', chat.id, 'messages'), {
        chatId: chat.id,
        senderId: user?.uid,
        senderName: user?.displayName || 'مستخدم',
        senderRole: 'user',
        message: messageText,
        type: 'user',
        createdAt: serverTimestamp(),
        read: false,
      })

      // تحديث المحادثة
      await updateDoc(doc(db, 'supportChats', chat.id), {
        lastMessage: messageText,
        lastMessageAt: serverTimestamp(),
        updatedAt: serverTimestamp(),
        unreadBySupport: (chat.unreadBySupport || 0) + 1,
      })

      // رد آلي ذكي
      setTimeout(async () => {
        setTyping(true)
        
        // البحث عن رد مناسب
        const autoReply = AUTO_REPLIES.find(ar => 
          ar.keywords.some(k => messageText.toLowerCase().includes(k))
        )

        await new Promise(r => setTimeout(r, 1500)) // تأخير طبيعي

        if (autoReply) {
          await addDoc(collection(db, 'supportChats', chat.id!, 'messages'), {
            chatId: chat.id,
            senderId: 'bot',
            senderName: 'مساعد سفرة البيت',
            senderRole: 'bot',
            message: autoReply.reply,
            type: 'bot',
            createdAt: serverTimestamp(),
            read: false,
          })
        }

        setTyping(false)
      }, 500)

    } catch (err) {
      console.error('Error sending message:', err)
      toast.error('فشل إرسال الرسالة')
    } finally {
      setSending(false)
    }
  }

  // إغلاق المحادثة
  const closeChat = async () => {
    if (!chat?.id) return
    
    await updateDoc(doc(db, 'supportChats', chat.id), {
      status: 'closed',
      updatedAt: serverTimestamp()
    })

    setChat(null)
    setMessages([])
    setShowFAQ(true)
    toast.success('تم إغلاق المحادثة')
  }

  // التحميل
  if (loading) {
    return (
      <div className="flex items-center justify-center min-h-[60vh]">
        <div className="text-center">
          <Loader2 className="w-10 h-10 animate-spin text-sky-500 mx-auto mb-3" />
          <p className="text-gray-500">جاري التحميل...</p>
        </div>
      </div>
    )
  }

  return (
    <div className="max-w-2xl mx-auto h-[calc(100vh-120px)] flex flex-col">
      {/* الهيدر */}
      <div className="bg-gradient-to-r from-sky-600 via-sky-500 to-blue-500 rounded-t-2xl p-4 text-white flex-shrink-0">
        <div className="flex items-center justify-between">
          <div className="flex items-center gap-3">
            <div className="w-12 h-12 bg-white/20 rounded-full flex items-center justify-center">
              <Headphones className="w-6 h-6" />
            </div>
            <div>
              <h1 className="text-lg font-bold">الدعم الفني</h1>
              <p className="text-sky-100 text-sm flex items-center gap-1">
                {chat?.status === 'active' ? (
                  <>
                    <span className="w-2 h-2 bg-green-400 rounded-full animate-pulse"></span>
                    متصل الآن
                  </>
                ) : chat?.status === 'waiting' ? (
                  <>
                    <span className="w-2 h-2 bg-amber-400 rounded-full animate-pulse"></span>
                    بانتظار الدعم
                  </>
                ) : (
                  <>
                    <span className="w-2 h-2 bg-green-400 rounded-full"></span>
                    متاح للمساعدة
                  </>
                )}
              </p>
            </div>
          </div>
          
          {chat && (
            <button
              onClick={closeChat}
              className="p-2 hover:bg-white/20 rounded-full transition"
              title="إغلاق المحادثة"
            >
              <X className="w-5 h-5" />
            </button>
          )}
        </div>
      </div>

      {/* منطقة المحادثة */}
      <div className="flex-1 bg-gradient-to-b from-gray-50 to-white overflow-y-auto p-4 space-y-4">
        
        {/* شاشة البداية - الأسئلة الشائعة */}
        {showFAQ && !chat && (
          <div className="space-y-6 py-4">
            {/* رسالة ترحيبية */}
            <div className="text-center">
              <div className="w-20 h-20 bg-gradient-to-br from-sky-400 to-blue-500 rounded-full mx-auto mb-4 flex items-center justify-center shadow-lg">
                <Sparkles className="w-10 h-10 text-white" />
              </div>
              <h2 className="text-xl font-bold text-gray-800 mb-2">كيف يمكننا مساعدتك؟</h2>
              <p className="text-gray-500 text-sm">اختر موضوعاً أو ابدأ محادثة مباشرة</p>
            </div>

            {/* الأسئلة الشائعة */}
            <div className="grid grid-cols-2 gap-3">
              {FAQ_ITEMS.map((item, i) => (
                <button
                  key={i}
                  onClick={() => startNewChat(item.q)}
                  className="flex items-center gap-3 p-4 bg-white rounded-xl border-2 border-gray-100 
                             hover:border-sky-300 hover:shadow-md transition-all text-right"
                >
                  <span className="text-2xl">{item.icon}</span>
                  <span className="font-medium text-gray-700 text-sm">{item.q}</span>
                </button>
              ))}
            </div>

            {/* زر البدء المباشر */}
            <button
              onClick={() => startNewChat()}
              className="w-full flex items-center justify-center gap-3 py-4 px-6 
                         bg-gradient-to-r from-sky-500 to-blue-600 hover:from-sky-600 hover:to-blue-700
                         text-white rounded-2xl font-bold shadow-lg transition-all"
            >
              <MessageCircle className="w-6 h-6" />
              <span>ابدأ محادثة مع الدعم</span>
            </button>

            {/* معلومات إضافية */}
            <div className="bg-amber-50 border border-amber-200 rounded-xl p-4 text-center">
              <p className="text-amber-800 text-sm">
                 فريق الدعم متاح على مدار الساعة
              </p>
              <p className="text-amber-600 text-xs mt-1">
                متوسط وقت الرد: أقل من 5 دقائق
              </p>
            </div>
          </div>
        )}

        {/* الرسائل */}
        {messages.map((msg) => (
          <div
            key={msg.id}
            className={`flex ${msg.senderRole === 'user' ? 'justify-end' : 'justify-start'}`}
          >
            <div className={`max-w-[85%] ${msg.senderRole === 'user' ? 'order-1' : 'order-2'}`}>
              {/* أفاتار للدعم/البوت */}
              {msg.senderRole !== 'user' && (
                <div className="flex items-center gap-2 mb-1">
                  <div className={`w-6 h-6 rounded-full flex items-center justify-center ${
                    msg.senderRole === 'bot' ? 'bg-purple-100' : 'bg-sky-100'
                  }`}>
                    {msg.senderRole === 'bot' ? (
                      <Bot className="w-4 h-4 text-purple-600" />
                    ) : (
                      <Headphones className="w-4 h-4 text-sky-600" />
                    )}
                  </div>
                  <span className="text-xs text-gray-500">{msg.senderName}</span>
                </div>
              )}
              
              {/* الرسالة */}
              <div
                className={`rounded-2xl px-4 py-3 ${
                  msg.senderRole === 'user'
                    ? 'bg-gradient-to-r from-sky-500 to-blue-500 text-white rounded-br-md'
                    : msg.senderRole === 'bot'
                    ? 'bg-purple-50 text-gray-800 border border-purple-100 rounded-bl-md'
                    : 'bg-white text-gray-800 border border-gray-200 shadow-sm rounded-bl-md'
                }`}
              >
                <p className="whitespace-pre-wrap text-sm leading-relaxed">{msg.message}</p>
              </div>
              
              {/* الوقت */}
              <p className={`text-xs text-gray-400 mt-1 ${msg.senderRole === 'user' ? 'text-left' : 'text-right'}`}>
                {msg.createdAt?.toDate?.().toLocaleTimeString('ar-SA', { hour: '2-digit', minute: '2-digit' }) || ''}
              </p>
            </div>
          </div>
        ))}

        {/* مؤشر الكتابة */}
        {typing && (
          <div className="flex items-center gap-2">
            <div className="w-6 h-6 bg-purple-100 rounded-full flex items-center justify-center">
              <Bot className="w-4 h-4 text-purple-600" />
            </div>
            <div className="bg-gray-100 rounded-2xl px-4 py-3">
              <div className="flex gap-1">
                <span className="w-2 h-2 bg-gray-400 rounded-full animate-bounce" style={{ animationDelay: '0ms' }}></span>
                <span className="w-2 h-2 bg-gray-400 rounded-full animate-bounce" style={{ animationDelay: '150ms' }}></span>
                <span className="w-2 h-2 bg-gray-400 rounded-full animate-bounce" style={{ animationDelay: '300ms' }}></span>
              </div>
            </div>
          </div>
        )}

        <div ref={messagesEndRef} />
      </div>

      {/* حقل الإدخال */}
      {chat && (
        <div className="bg-white border-t border-gray-200 p-4 rounded-b-2xl flex-shrink-0">
          <div className="flex items-center gap-3">
            <input
              ref={inputRef}
              type="text"
              value={inputText}
              onChange={(e) => setInputText(e.target.value)}
              onKeyPress={(e) => e.key === 'Enter' && sendMessage()}
              placeholder="اكتب رسالتك هنا..."
              className="flex-1 px-4 py-3 bg-gray-100 rounded-xl border-2 border-transparent 
                       focus:border-sky-300 focus:bg-white focus:outline-none transition"
              disabled={sending}
            />
            <button
              onClick={() => sendMessage()}
              disabled={!inputText.trim() || sending}
              className="w-12 h-12 bg-gradient-to-r from-sky-500 to-blue-500 hover:from-sky-600 hover:to-blue-700
                       text-white rounded-xl flex items-center justify-center transition-all
                       disabled:opacity-50 disabled:cursor-not-allowed"
            >
              {sending ? (
                <Loader2 className="w-5 h-5 animate-spin" />
              ) : (
                <Send className="w-5 h-5" />
              )}
            </button>
          </div>
          
          {/* رسائل سريعة */}
          <div className="flex gap-2 mt-3 overflow-x-auto pb-1">
            {['أين طلبي؟', 'أريد إلغاء الطلب', 'تحدث مع موظف'].map((quick, i) => (
              <button
                key={i}
                onClick={() => sendMessage(quick)}
                disabled={sending}
                className="flex-shrink-0 px-3 py-1.5 bg-gray-100 hover:bg-sky-100 
                         text-gray-600 hover:text-sky-700 rounded-full text-sm transition"
              >
                {quick}
              </button>
            ))}
          </div>
        </div>
      )}
    </div>
  )
}

export default LiveSupportPage

==========================================================================================
FILE: src/pages/Login.tsx
==========================================================================================
// src/pages/Login.tsx
import React, { useState } from 'react'
import { signInWithEmailAndPassword, sendPasswordResetEmail } from 'firebase/auth'
import { auth, db } from '@/firebase'
import { doc, getDoc } from 'firebase/firestore'
import { Link, useNavigate } from 'react-router-dom'
import { Mail, Lock, LogIn, Sparkles, KeyRound, ArrowRight, Loader2 } from 'lucide-react'
import { useDialog } from '@/components/ui/ConfirmDialog'
import { useToast } from '@/components/ui/Toast'

export const Login: React.FC = () => {
  const [email, setEmail] = useState('')
  const [password, setPassword] = useState('')
  const [loading, setLoading] = useState(false)
  const [showForgotPassword, setShowForgotPassword] = useState(false)
  const [resetEmail, setResetEmail] = useState('')
  const [resetLoading, setResetLoading] = useState(false)
  const nav = useNavigate()
  const dialog = useDialog()
  const toast = useToast()

  const submit = async (e: React.FormEvent) => {
    e.preventDefault()
    setLoading(true)
    try {
      const userCred = await signInWithEmailAndPassword(auth, email, password)
      const uid = userCred.user.uid

      const snap = await getDoc(doc(db, "users", uid))
      if (snap.exists()) {
        const userData = snap.data()

        if (userData.role === "owner") {
          nav("/owner")
        } else if (userData.role === "admin") {
          nav("/admin")
        } else if (userData.role === "developer") {
          nav("/developer")
        } else if (userData.role === "courier") {
          nav("/courier")
        } else {
          nav("/")
        }
      } else {
        dialog.warning('الحساب موجود في Auth لكن لا توجد له بيانات في Firestore')
      }
    } catch (e: any) {
      dialog.error(e.message, { title: 'خطأ في تسجيل الدخول' })
    } finally {
      setLoading(false)
    }
  }

  // دالة إرسال رابط إعادة تعيين كلمة المرور
  const handleForgotPassword = async (e: React.FormEvent) => {
    e.preventDefault()
    if (!resetEmail.trim()) {
      toast.warning('الرجاء إدخال البريد الإلكتروني')
      return
    }
    
    setResetLoading(true)
    try {
      await sendPasswordResetEmail(auth, resetEmail.trim().toLowerCase())
      toast.success('تم إرسال رابط إعادة تعيين كلمة المرور! تحقق من بريدك ')
      // رسالة تنبيه إضافية
      setTimeout(() => {
        dialog.info('إذا لم تجد الرسالة، تحقق من مجلد الرسائل غير المرغوبة (Spam)', {
          title: ' ملاحظة مهمة'
        })
      }, 1000)
      setShowForgotPassword(false)
      setResetEmail('')
    } catch (error: any) {
      console.error('Reset password error:', error)
      if (error.code === 'auth/user-not-found') {
        toast.error('لا يوجد حساب مسجل بهذا البريد الإلكتروني')
      } else if (error.code === 'auth/invalid-email') {
        toast.error('البريد الإلكتروني غير صحيح')
      } else if (error.code === 'auth/too-many-requests') {
        toast.error('تم إرسال طلبات كثيرة، انتظر قليلاً ثم حاول مرة أخرى')
      } else {
        toast.error(`حدث خطأ: ${error.message}`)
      }
    } finally {
      setResetLoading(false)
    }
  }

  return (
    <div className="min-h-screen flex items-center justify-center bg-gradient-to-br from-sky-50 via-white to-sky-100 px-4">
      {/* خلفية زخرفية */}
      <div className="absolute top-0 left-0 w-72 h-72 bg-sky-300/20 rounded-full blur-3xl"></div>
      <div className="absolute bottom-0 right-0 w-72 h-72 bg-sky-400/20 rounded-full blur-3xl"></div>
      
      <div className="relative bg-white/80 backdrop-blur-xl border border-sky-100 rounded-[2rem] shadow-2xl shadow-sky-200/50 w-full max-w-md p-8">
        
        {/* شعار */}
        <div className="flex flex-col items-center mb-8">
          <div className="w-20 h-20 bg-gradient-to-br from-sky-500 to-sky-600 rounded-2xl flex items-center justify-center shadow-xl shadow-sky-300/50 mb-4">
            <span className="text-4xl">  </span>
          </div>
          <h1 className="text-3xl font-black text-sky-600">سفرة البيت</h1>
          <p className="text-sky-500 mt-1">تسجيل الدخول</p>
        </div>

        {/* نموذج تسجيل الدخول */}
        <form onSubmit={submit} className="space-y-4">
          <div className="relative">
            <Mail className="absolute right-4 top-1/2 -translate-y-1/2 w-5 h-5 text-sky-400" />
            <input
              type="email"
              placeholder="الإيميل"
              className="w-full rounded-2xl p-4 pr-12 bg-sky-50 text-sky-900 border-2 border-sky-100 
                         focus:outline-none focus:border-sky-400 focus:ring-4 focus:ring-sky-100 transition-all"
              value={email}
              onChange={(e) => setEmail(e.target.value)}
            />
          </div>
          <div className="relative">
            <Lock className="absolute right-4 top-1/2 -translate-y-1/2 w-5 h-5 text-sky-400" />
            <input
              type="password"
              placeholder="كلمة المرور"
              className="w-full rounded-2xl p-4 pr-12 bg-sky-50 text-sky-900 border-2 border-sky-100 
                         focus:outline-none focus:border-sky-400 focus:ring-4 focus:ring-sky-100 transition-all"
              value={password}
              onChange={(e) => setPassword(e.target.value)}
            />
          </div>

          {/* رابط نسيت كلمة المرور */}
          <div className="text-left">
            <button
              type="button"
              onClick={() => {
                setShowForgotPassword(true)
                setResetEmail(email) // نقل الإيميل المدخل
              }}
              className="text-sm text-sky-500 hover:text-sky-700 font-medium hover:underline"
            >
               نسيت كلمة المرور؟
            </button>
          </div>

          <button
            disabled={loading}
            className="w-full flex items-center justify-center gap-3 bg-gradient-to-r from-sky-500 to-sky-600 hover:from-sky-600 hover:to-sky-700 text-white font-bold p-4 rounded-2xl 
                       shadow-xl shadow-sky-300/50 transition-all hover:scale-[1.02] hover:shadow-sky-400/50"
          >
            {loading ? (
              <>جارٍ الدخول...</>
            ) : (
              <>
                <LogIn className="w-5 h-5" />
                دخول
              </>
            )}
          </button>
        </form>

        {/* رابط التسجيل */}
        <p className="mt-8 text-center text-sky-600">
          ليس لديك حساب؟{' '}
          <Link 
            className="text-sky-500 hover:text-sky-700 font-bold" 
            to="/register"
          >
            سجّل الآن 
          </Link>
        </p>

        {/* رابط تسجيل دخول العملاء برقم الجوال */}
        <div className="mt-6 pt-6 border-t border-sky-100">
          <p className="text-center text-sm text-gray-500 mb-3">
            عميل تريد الدخول برقم الجوال؟
          </p>
          <Link 
            to="/customer-login"
            className="block w-full text-center bg-green-50 hover:bg-green-100 text-green-700 font-semibold py-3 px-4 rounded-2xl transition"
          >
             الدخول برقم الجوال
          </Link>
        </div>
      </div>

      {/* نافذة نسيت كلمة المرور */}
      {showForgotPassword && (
        <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4">
          <div className="bg-white rounded-3xl shadow-2xl w-full max-w-md p-8 relative">
            {/* زر الإغلاق */}
            <button
              onClick={() => setShowForgotPassword(false)}
              className="absolute top-4 left-4 p-2 hover:bg-gray-100 rounded-full transition"
            >
              <ArrowRight className="w-5 h-5 text-gray-500" />
            </button>

            {/* الأيقونة والعنوان */}
            <div className="text-center mb-6">
              <div className="w-16 h-16 bg-gradient-to-br from-amber-400 to-orange-500 rounded-2xl flex items-center justify-center mx-auto mb-4 shadow-lg">
                <KeyRound className="w-8 h-8 text-white" />
              </div>
              <h2 className="text-2xl font-bold text-gray-800">نسيت كلمة المرور؟</h2>
              <p className="text-gray-500 mt-2 text-sm">
                أدخل بريدك الإلكتروني وسنرسل لك رابط لإعادة تعيين كلمة المرور
              </p>
            </div>

            {/* نموذج إعادة التعيين */}
            <form onSubmit={handleForgotPassword} className="space-y-4">
              <div className="relative">
                <Mail className="absolute right-4 top-1/2 -translate-y-1/2 w-5 h-5 text-amber-500" />
                <input
                  type="email"
                  placeholder="البريد الإلكتروني"
                  className="w-full rounded-2xl p-4 pr-12 bg-amber-50 text-gray-900 border-2 border-amber-100 
                             focus:outline-none focus:border-amber-400 focus:ring-4 focus:ring-amber-100 transition-all"
                  value={resetEmail}
                  onChange={(e) => setResetEmail(e.target.value)}
                  autoFocus
                />
              </div>

              <button
                type="submit"
                disabled={resetLoading}
                className="w-full flex items-center justify-center gap-3 bg-gradient-to-r from-amber-500 to-orange-500 hover:from-amber-600 hover:to-orange-600 text-white font-bold p-4 rounded-2xl 
                           shadow-xl shadow-amber-300/50 transition-all hover:scale-[1.02] disabled:opacity-50 disabled:cursor-not-allowed"
              >
                {resetLoading ? (
                  <>
                    <Loader2 className="w-5 h-5 animate-spin" />
                    جارٍ الإرسال...
                  </>
                ) : (
                  <>
                    <Mail className="w-5 h-5" />
                    إرسال رابط إعادة التعيين
                  </>
                )}
              </button>
            </form>

            {/* رابط العودة */}
            <button
              onClick={() => setShowForgotPassword(false)}
              className="w-full mt-4 text-center text-gray-500 hover:text-gray-700 font-medium"
            >
              العودة لتسجيل الدخول
            </button>
          </div>
        </div>
      )}
    </div>
  )
}

==========================================================================================
FILE: src/pages/ManageMenu.tsx
==========================================================================================
// src/pages/ManageMenu.tsx
import React, { useEffect, useMemo, useRef, useState } from 'react'
import { db, app } from '@/firebase'
import {
  addDoc,
  collection,
  deleteDoc,
  doc,
  getDocs,
  query,
  where,
  updateDoc,
} from 'firebase/firestore'
import {
  getDownloadURL,
  getStorage,
  ref,
  uploadBytesResumable,
} from 'firebase/storage'
import { useAuth } from '@/auth'
import { useDialog } from '@/components/ui/ConfirmDialog'

/* =======================
   Toast محلي بسيط داخل الصفحة
   ======================= */
type ToastKind = 'success' | 'error' | 'info' | 'warning'
const Toast: React.FC<{ kind: ToastKind; message: string; onClose: () => void }> = ({ kind, message, onClose }) => {
  const base =
    kind === 'success' ? 'bg-green-600' :
    kind === 'error'   ? 'bg-rose-600'  :
    kind === 'warning' ? 'bg-amber-500' : 'bg-slate-800'
  useEffect(() => {
    const t = setTimeout(onClose, 2500)
    return () => clearTimeout(t)
  }, [onClose])
  return (
    <div className={`fixed bottom-4 right-4 z-50 rounded-xl px-4 py-3 text-white shadow-lg ${base}`}>
      {message}
    </div>
  )
}

/* =======================
   الأنواع والحالة
   ======================= */
type Item = {
  id?: string
  name: string
  desc?: string
  price: number           // السعر المعروض
  imageUrl?: string
  available: boolean
  categoryId?: string
  ownerId?: string
  file?: File | null
  // الخصومات
  discountPercent?: number // نسبة الخصم (0-100)
  discountExpiresAt?: Date | string // تاريخ انتهاء الخصم

  // للواجهة المتفائلة
  _tempId?: string
  _optimistic?: boolean
  _progress?: number // 0..100
}

const emptyItem = (): Item => ({
  name: '',
  desc: '',
  price: 0,
  available: true,
  file: null,
  discountPercent: 0,
  discountExpiresAt: '',
})

/** ضغط خفيف للصورة قبل الرفع (اختياري) */
async function compressImage(file: File, maxW = 900, quality = 0.8): Promise<Blob> {
  try {
    const bitmap = await createImageBitmap(file)
    const scale = Math.min(1, maxW / bitmap.width)
    const w = Math.round(bitmap.width * scale)
    const h = Math.round(bitmap.height * scale)

    const canvas = document.createElement('canvas')
    canvas.width = w
    canvas.height = h
    const ctx = canvas.getContext('2d')!
    ctx.drawImage(bitmap, 0, 0, w, h)

    const type = file.type.includes('png') ? 'image/png' : 'image/jpeg'
    const blob = await new Promise<Blob>((res) => canvas.toBlob((b) => res(b!), type, quality))
    return blob
  } catch {
    return file
  }
}

export const ManageMenu: React.FC = () => {
  const { user } = useAuth()
  const confirmDialog = useDialog()
  const [items, setItems] = useState<Item[]>([])
  const [loading, setLoading] = useState(true)
  const [form, setForm] = useState<Item>(emptyItem())
  const [saving, setSaving] = useState(false)
  
  //  حالة التعديل
  const [editingId, setEditingId] = useState<string | null>(null)
  const [editForm, setEditForm] = useState<Item>(emptyItem())
  const [editSaving, setEditSaving] = useState(false)
  const editFileRef = useRef<HTMLInputElement | null>(null)

  // Toast state
  const [toast, setToast] = useState<{ kind: ToastKind; message: string } | null>(null)
  const notify = (kind: ToastKind, message: string) => setToast({ kind, message })

  //  استخدم البكت الافتراضي للمشروع (بدون URL يدوي)
  const storage = getStorage(app)
  const fileRef = useRef<HTMLInputElement | null>(null)

  //  تحميل أصناف مالك الحساب فقط
  const load = async () => {
    if (!user) return
    setLoading(true)
    const q = query(collection(db, 'menuItems'), where('ownerId', '==', user.uid))
    const snap = await getDocs(q)
    setItems(snap.docs.map(d => ({ id: d.id, ...(d.data() as any) })))
    setLoading(false)
  }

  useEffect(() => { load() }, [user])

  //  إضافة متفائلة + شريط تقدّم + ضغط صورة
  const save = async (e: React.FormEvent) => {
    e.preventDefault()
    if (!user) {
      notify('warning', ' لازم تسجل دخول أول')
      return
    }

    const price = Number(form.price || 0)
    if (!form.name.trim()) {
      notify('warning', ' اكتب اسم الصنف')
      return
    }
    if (!Number.isFinite(price) || price <= 0) {
      notify('warning', ' أدخل سعر صالح')
      return
    }

    setSaving(true)

    // 1) أضف بطاقة محلية فورية (Optimistic)
    const tempId = 'temp_' + Date.now()
    const localPreview = form.file ? URL.createObjectURL(form.file) : undefined

    const optimistic: Item = {
      _tempId: tempId,
      _optimistic: true,
      _progress: form.file ? 1 : 100,
      name: form.name,
      desc: form.desc || '',
      price,
      imageUrl: localPreview,
      available: form.available ?? true,
      ownerId: user.uid,
    }
    setItems(prev => [optimistic, ...prev])

    try {
      // 2) ارفع الصورة إن وُجدت (مع تقدم)
      let imageUrl: string | undefined
      if (form.file) {
        const blob = await compressImage(form.file)
        const safeName = form.file.name.replace(/\s+/g, '_').slice(-60)
        const path = `menuImages/${user.uid}_${Date.now()}_${safeName}`
        const storageRef = ref(storage, path)
        const task = uploadBytesResumable(storageRef, blob, {
          contentType: form.file.type || 'image/jpeg',
        })

        await new Promise<void>((resolve, reject) => {
          task.on(
            'state_changed',
            snap => {
              const p = Math.round((snap.bytesTransferred / snap.totalBytes) * 100)
              setItems(prev => prev.map(i => i._tempId === tempId ? { ...i, _progress: p } : i))
            },
            reject,
            async () => {
              const url = await getDownloadURL(task.snapshot.ref)
              // bust cache فورياً
              imageUrl = `${url}${url.includes('?') ? '&' : '?'}v=${Date.now()}`
              resolve()
            }
          )
        })
      }

      // 3) أنشئ الوثيقة في فايرستور
      const payload: any = {
        name: optimistic.name,
        desc: optimistic.desc,
        price,
        imageUrl: imageUrl || '',
        available: optimistic.available,
        ownerId: user.uid,
        ...(optimistic.categoryId ? { categoryId: optimistic.categoryId } : {}),
        // حقول الخصم
        ...(form.discountPercent && form.discountPercent > 0 ? { discountPercent: form.discountPercent } : {}),
        ...(form.discountExpiresAt ? { discountExpiresAt: new Date(form.discountExpiresAt) } : {}),
      }
      const created = await addDoc(collection(db, 'menuItems'), payload)

      // 4) بدّل البطاقة المؤقتة بالحقيقية
      setItems(prev =>
        prev.map(i =>
          i._tempId === tempId
            ? { ...i, id: created.id, imageUrl: imageUrl || i.imageUrl, _optimistic: false, _progress: 100 }
            : i
        )
      )

      notify('success', ' تم حفظ الصنف بنجاح')
    } catch (err: any) {
      // رجوع عن الإضافة لو فشل
      setItems(prev => prev.filter(i => i._tempId !== tempId))
      notify('error', ` فشل حفظ الصنف: ${err?.message || err}`)
    } finally {
      setSaving(false)
      // تنظيف النموذج
      setForm(emptyItem())
      if (fileRef.current) fileRef.current.value = ''
      // حرر الـ blob لو فيه
      if (localPreview) URL.revokeObjectURL(localPreview)
    }
  }

  //  تفعيل/تعطيل متفائل
  const toggle = async (id?: string, avail?: boolean) => {
    if (!id) return
    setItems(prev => prev.map(i => (i.id === id ? { ...i, available: !avail } : i)))
    try {
      await updateDoc(doc(db, 'menuItems', id), { available: !avail })
      notify('success', 'تم تحديث الحالة')
    } catch {
      setItems(prev => prev.map(i => (i.id === id ? { ...i, available: !!avail } : i)))
      notify('error', 'لم يتم التغيير. أعد المحاولة.')
    }
  }

  //  حذف متفائل
  const remove = async (id?: string) => {
    if (!id) return
    const confirmed = await confirmDialog.confirm('هل أنت متأكد من حذف هذا الصنف نهائيًا؟', { dangerous: true, title: 'حذف الصنف' })
    if (!confirmed) return
    const prev = items
    setItems(p => p.filter(x => x.id !== id))
    try {
      await deleteDoc(doc(db, 'menuItems', id))
      notify('success', 'تم الحذف')
    } catch {
      setItems(prev)
      notify('error', 'لم يتم الحذف. أعد المحاولة.')
    }
  }

  //  بدء التعديل
  const startEdit = (item: Item) => {
    setEditingId(item.id || null)
    setEditForm({ ...item, file: null })
  }

  //  إلغاء التعديل
  const cancelEdit = () => {
    setEditingId(null)
    setEditForm(emptyItem())
    if (editFileRef.current) editFileRef.current.value = ''
  }

  //  حفظ التعديل
  const saveEdit = async (e: React.FormEvent) => {
    e.preventDefault()
    if (!user || !editingId) return

    const price = Number(editForm.price || 0)
    if (!editForm.name.trim()) {
      notify('warning', ' اكتب اسم الصنف')
      return
    }
    if (!Number.isFinite(price) || price <= 0) {
      notify('warning', ' أدخل سعر صالح')
      return
    }

    setEditSaving(true)
    const prevItems = items

    // تحديث متفائل للـ UI
    setItems(prev => prev.map(i => 
      i.id === editingId 
        ? { ...i, name: editForm.name, desc: editForm.desc, price, available: editForm.available }
        : i
    ))

    try {
      let imageUrl = editForm.imageUrl

      // رفع صورة جديدة إن وُجدت
      if (editForm.file) {
        const blob = await compressImage(editForm.file)
        const safeName = editForm.file.name.replace(/\s+/g, '_').slice(-60)
        const path = `menuImages/${user.uid}_${Date.now()}_${safeName}`
        const storageRef = ref(storage, path)
        const task = uploadBytesResumable(storageRef, blob, {
          contentType: editForm.file.type || 'image/jpeg',
        })

        await new Promise<void>((resolve, reject) => {
          task.on('state_changed', null, reject, async () => {
            const url = await getDownloadURL(task.snapshot.ref)
            imageUrl = `${url}${url.includes('?') ? '&' : '?'}v=${Date.now()}`
            resolve()
          })
        })
      }

      // تحديث الوثيقة في Firestore
      await updateDoc(doc(db, 'menuItems', editingId), {
        name: editForm.name,
        desc: editForm.desc || '',
        price,
        available: editForm.available,
        ...(imageUrl ? { imageUrl } : {}),
        // تحديث حقول الخصم
        discountPercent: editForm.discountPercent || 0,
        ...(editForm.discountExpiresAt ? { discountExpiresAt: new Date(editForm.discountExpiresAt) } : { discountExpiresAt: null }),
      })

      // تحديث الـ UI بالصورة الجديدة
      if (imageUrl) {
        setItems(prev => prev.map(i => i.id === editingId ? { ...i, imageUrl } : i))
      }

      notify('success', ' تم تحديث الصنف بنجاح')
      cancelEdit()
    } catch (err: any) {
      // رجوع عن التغييرات لو فشل
      setItems(prevItems)
      notify('error', ` فشل التحديث: ${err?.message || err}`)
    } finally {
      setEditSaving(false)
    }
  }

  if (loading) {
    return (
      <div className="grid lg:grid-cols-2 gap-6">
        <div className="bg-white rounded-2xl shadow p-6 space-y-3">
          <div className="h-6 w-40 bg-gray-200 rounded animate-pulse" />
          <div className="h-10 w-full bg-gray-200 rounded animate-pulse" />
          <div className="h-24 w-full bg-gray-200 rounded animate-pulse" />
          <div className="h-10 w-full bg-gray-200 rounded animate-pulse" />
          <div className="h-10 w-32 bg-gray-200 rounded animate-pulse" />
        </div>
        <div className="space-y-3">
          {[1,2,3].map(i => (
            <div key={i} className="bg-white rounded-2xl shadow p-4 flex items-center gap-4">
              <div className="w-20 h-20 bg-gray-200 rounded-xl animate-pulse" />
              <div className="flex-1 space-y-2">
                <div className="h-4 w-48 bg-gray-200 rounded animate-pulse" />
                <div className="h-3 w-64 bg-gray-200 rounded animate-pulse" />
                <div className="h-4 w-24 bg-gray-200 rounded animate-pulse" />
              </div>
            </div>
          ))}
        </div>
      </div>
    )
  }

  return (
    <>
      {toast && <Toast kind={toast.kind} message={toast.message} onClose={() => setToast(null)} />}

      <div className="grid lg:grid-cols-2 gap-6">
        {/*  فورم الإضافة السريعة */}
        <form onSubmit={save} className="bg-white rounded-2xl shadow p-6 space-y-3">
          <h2 className="text-lg font-bold">إضافة صنف</h2>

          <input
            className="w-full border rounded-xl p-3"
            placeholder="اسم الصنف"
            value={form.name}
            onChange={e => setForm({ ...form, name: e.target.value })}
          />

          <textarea
            className="w-full border rounded-xl p-3"
            placeholder="الوصف (اختياري)"
            value={form.desc}
            onChange={e => setForm({ ...form, desc: e.target.value })}
          />

          <input
            className="w-full border rounded-xl p-3"
            placeholder="السعر"
            type="number"
            min={0}
            step={0.5}
            inputMode="decimal"
            value={Number.isFinite(form.price) ? form.price : 0}
            onChange={e => setForm({ ...form, price: Number(e.target.value) })}
          />

          {/* قسم الخصم */}
          <div className="border border-dashed border-amber-300 rounded-xl p-4 bg-amber-50/50 space-y-3">
            <h3 className="text-sm font-bold text-amber-700 flex items-center gap-2">
               إضافة خصم (اختياري)
            </h3>
            <div className="grid grid-cols-2 gap-3">
              <div>
                <label className="text-xs text-gray-600 mb-1 block">نسبة الخصم %</label>
                <input
                  className="w-full border rounded-xl p-3"
                  placeholder="مثال: 20"
                  type="number"
                  min={0}
                  max={100}
                  value={form.discountPercent || ''}
                  onChange={e => setForm({ ...form, discountPercent: Number(e.target.value) || 0 })}
                />
              </div>
              <div>
                <label className="text-xs text-gray-600 mb-1 block">ينتهي في</label>
                <input
                  className="w-full border rounded-xl p-3"
                  type="date"
                  value={form.discountExpiresAt ? (typeof form.discountExpiresAt === 'string' ? form.discountExpiresAt : new Date(form.discountExpiresAt).toISOString().split('T')[0]) : ''}
                  onChange={e => setForm({ ...form, discountExpiresAt: e.target.value })}
                />
              </div>
            </div>
            {form.discountPercent && form.discountPercent > 0 && (
              <div className="text-sm bg-green-100 text-green-700 p-2 rounded-lg">
                السعر بعد الخصم: <strong>{(form.price - (form.price * (form.discountPercent / 100))).toFixed(2)} ر.س</strong>
                <span className="line-through text-gray-400 mr-2">{form.price.toFixed(2)} ر.س</span>
              </div>
            )}
          </div>

          <input
            ref={fileRef}
            className="w-full border rounded-xl p-3"
            type="file"
            accept="image/*"
            onChange={e => setForm({ ...form, file: e.target.files?.[0] || null })}
          />

          <label className="flex items-center gap-2 text-sm">
            <input
              type="checkbox"
              checked={form.available}
              onChange={e => setForm({ ...form, available: e.target.checked })}
            />
            متاح
          </label>

          <button
            className="px-4 py-2 rounded-xl bg-gray-900 text-white disabled:opacity-60"
            disabled={saving}
          >
            {saving ? 'جارِ الحفظ…' : 'حفظ'}
          </button>
        </form>

        {/*  عرض الأصناف */}
        <div className="space-y-3">
          {items.map(it => (
            <div key={it.id || it._tempId} className="bg-white rounded-2xl shadow p-4">
              {/* وضع التعديل */}
              {editingId === it.id ? (
                <form onSubmit={saveEdit} className="space-y-3">
                  <div className="flex items-center gap-3 mb-3">
                    <img
                      src={editForm.file ? URL.createObjectURL(editForm.file) : (editForm.imageUrl || '')}
                      className="w-20 h-20 object-cover rounded-xl bg-gray-100"
                      onError={(e: any) => { e.currentTarget.style.display = 'none' }}
                    />
                    <div className="flex-1">
                      <label className="text-sm text-gray-600 block mb-1">تغيير الصورة</label>
                      <input
                        ref={editFileRef}
                        type="file"
                        accept="image/*"
                        className="w-full text-sm border rounded-lg p-2"
                        onChange={e => setEditForm({ ...editForm, file: e.target.files?.[0] || null })}
                      />
                    </div>
                  </div>

                  <input
                    className="w-full border rounded-xl p-3"
                    placeholder="اسم الصنف"
                    value={editForm.name}
                    onChange={e => setEditForm({ ...editForm, name: e.target.value })}
                  />

                  <textarea
                    className="w-full border rounded-xl p-3"
                    placeholder="الوصف (اختياري)"
                    value={editForm.desc || ''}
                    onChange={e => setEditForm({ ...editForm, desc: e.target.value })}
                  />

                  <input
                    className="w-full border rounded-xl p-3"
                    placeholder="السعر"
                    type="number"
                    min={0}
                    step={0.5}
                    inputMode="decimal"
                    value={Number.isFinite(editForm.price) ? editForm.price : 0}
                    onChange={e => setEditForm({ ...editForm, price: Number(e.target.value) })}
                  />

                  {/* قسم الخصم في التعديل */}
                  <div className="border border-dashed border-amber-300 rounded-xl p-4 bg-amber-50/50 space-y-3">
                    <h3 className="text-sm font-bold text-amber-700 flex items-center gap-2">
                       الخصم
                    </h3>
                    <div className="grid grid-cols-2 gap-3">
                      <div>
                        <label className="text-xs text-gray-600 mb-1 block">نسبة الخصم %</label>
                        <input
                          className="w-full border rounded-xl p-3"
                          placeholder="مثال: 20"
                          type="number"
                          min={0}
                          max={100}
                          value={editForm.discountPercent || ''}
                          onChange={e => setEditForm({ ...editForm, discountPercent: Number(e.target.value) || 0 })}
                        />
                      </div>
                      <div>
                        <label className="text-xs text-gray-600 mb-1 block">ينتهي في</label>
                        <input
                          className="w-full border rounded-xl p-3"
                          type="date"
                          value={editForm.discountExpiresAt ? (typeof editForm.discountExpiresAt === 'string' ? editForm.discountExpiresAt : new Date(editForm.discountExpiresAt).toISOString().split('T')[0]) : ''}
                          onChange={e => setEditForm({ ...editForm, discountExpiresAt: e.target.value })}
                        />
                      </div>
                    </div>
                    {editForm.discountPercent && editForm.discountPercent > 0 && (
                      <div className="text-sm bg-green-100 text-green-700 p-2 rounded-lg">
                        السعر بعد الخصم: <strong>{(editForm.price - (editForm.price * (editForm.discountPercent / 100))).toFixed(2)} ر.س</strong>
                        <span className="line-through text-gray-400 mr-2">{editForm.price.toFixed(2)} ر.س</span>
                      </div>
                    )}
                    {editForm.discountPercent && editForm.discountPercent > 0 && (
                      <button
                        type="button"
                        onClick={() => setEditForm({ ...editForm, discountPercent: 0, discountExpiresAt: '' })}
                        className="text-xs text-red-500 hover:text-red-700"
                      >
                         إزالة الخصم
                      </button>
                    )}
                  </div>

                  <label className="flex items-center gap-2 text-sm">
                    <input
                      type="checkbox"
                      checked={editForm.available}
                      onChange={e => setEditForm({ ...editForm, available: e.target.checked })}
                    />
                    متاح
                  </label>

                  <div className="flex gap-2">
                    <button
                      type="submit"
                      disabled={editSaving}
                      className="flex-1 px-4 py-2 rounded-xl bg-green-600 text-white disabled:opacity-60"
                    >
                      {editSaving ? 'جارِ الحفظ…' : ' حفظ التعديلات'}
                    </button>
                    <button
                      type="button"
                      onClick={cancelEdit}
                      disabled={editSaving}
                      className="px-4 py-2 rounded-xl bg-gray-400 text-white disabled:opacity-60"
                    >
                      إلغاء
                    </button>
                  </div>
                </form>
              ) : (
                /* وضع العرض العادي */
                <div className="flex items-center gap-4">
                  <div className="relative">
                    <img
                      src={it.imageUrl || ''}
                      className="w-20 h-20 object-cover rounded-xl bg-gray-100"
                      onError={(e: any) => { e.currentTarget.style.display = 'none' }}
                    />
                    {it._optimistic && (
                      <div className="absolute -bottom-2 left-0 right-0">
                        <div className="h-1 w-20 rounded bg-gray-200 overflow-hidden">
                          <div
                            className="h-full bg-yellow-500 transition-[width]"
                            style={{ width: `${it._progress || 1}%` }}
                          />
                        </div>
                      </div>
                    )}
                  </div>

                  <div className="flex-1">
                    <div className="font-bold">{it.name}</div>
                    {it.desc && <div className="text-sm text-gray-600">{it.desc}</div>}
                    {/* عرض السعر مع الخصم */}
                    {(() => {
                      const hasDiscount = it.discountPercent && it.discountPercent > 0
                      const expiryDate = (it.discountExpiresAt as any)?.toDate?.() || (it.discountExpiresAt ? new Date(it.discountExpiresAt as string) : null)
                      const isValid = !expiryDate || expiryDate > new Date()
                      
                      if (hasDiscount && isValid) {
                        return (
                          <div className="mt-1 flex items-center gap-2 flex-wrap">
                            <span className="font-bold text-green-600">{(it.price - (it.price * ((it.discountPercent || 0) / 100))).toFixed(2)} ر.س</span>
                            <span className="text-sm text-gray-400 line-through">{it.price?.toFixed?.(2)} ر.س</span>
                            <span className="bg-red-500 text-white text-xs px-2 py-0.5 rounded-full">خصم {it.discountPercent}%</span>
                          </div>
                        )
                      }
                      return <div className="font-semibold mt-1">{it.price?.toFixed?.(2)} ر.س</div>
                    })()}
                    {it._optimistic && <div className="text-xs text-yellow-600 mt-1">يتم الحفظ…</div>}
                  </div>

                  <div className="flex flex-col sm:flex-row gap-2">
                    <button
                      onClick={() => startEdit(it)}
                      disabled={!!it._optimistic}
                      className="px-3 py-2 rounded-xl text-sm bg-amber-500 text-white disabled:opacity-50"
                    >
                       تعديل
                    </button>
                    <button
                      onClick={() => toggle(it.id, it.available)}
                      disabled={!!it._optimistic}
                      className="px-3 py-2 rounded-xl text-sm bg-blue-600 text-white disabled:opacity-50"
                    >
                      {it.available ? 'تعطيل' : 'تفعيل'}
                    </button>
                    <button
                      onClick={() => remove(it.id)}
                      disabled={!!it._optimistic}
                      className="px-3 py-2 rounded-xl text-sm bg-red-600 text-white disabled:opacity-50"
                    >
                      حذف
                    </button>
                  </div>
                </div>
              )}
            </div>
          ))}
          {items.length === 0 && <div className="text-gray-600">لا توجد أصناف بعد.</div>}
        </div>
      </div>
    </>
  )
}

export default ManageMenu

==========================================================================================
FILE: src/pages/MenuPage.tsx
==========================================================================================
// src/pages/MenuPage.tsx
import React, { useEffect, useState } from 'react'
import { db } from '@/firebase'
import { collection, getDocs, query, where, doc, getDoc, updateDoc, increment, documentId, addDoc, serverTimestamp, deleteDoc } from 'firebase/firestore'
import { useCart } from '@/hooks/useCart'
import { Link, useSearchParams } from 'react-router-dom'
import { useAuth } from '@/auth'
import { useToast } from '@/components/ui/Toast'
import { MenuItem, Restaurant, Promotion } from '@/types'
import { 
  Megaphone, X, MapPin, Phone, Star, ShoppingBag, ArrowRight, 
  CheckCircle, Building2, Copy, Package, Clock,
  Utensils, Share2, Users, Briefcase, MessageCircle, Heart, Lock
} from 'lucide-react'

type MenuItemWithRestaurant = MenuItem & { restaurant?: Restaurant }

const chunkArray = <T,>(arr: T[], size: number): T[][] => {
  const chunks: T[][] = []
  for (let i = 0; i < arr.length; i += size) {
    chunks.push(arr.slice(i, i + size))
  }
  return chunks
}

export const MenuPage: React.FC = () => {
  const [items, setItems] = useState<MenuItemWithRestaurant[]>([])
  const [loading, setLoading] = useState(true)
  const [restaurant, setRestaurant] = useState<Restaurant | null>(null)
  const [activePromotion, setActivePromotion] = useState<Promotion | null>(null)
  const [showPromotion, setShowPromotion] = useState(true)
  const [isFollowing, setIsFollowing] = useState(false)
  const [followDocId, setFollowDocId] = useState<string | null>(null)
  const [followersCount, setFollowersCount] = useState(0)
  const { add, subtotal, items: cartItems } = useCart()
  const { user, role } = useAuth()
  const toast = useToast()
  const [searchParams] = useSearchParams()
  const restaurantId = searchParams.get('restaurant')

  const SERVICE_FEE_PER_ITEM = 1.75

  const copyToClipboard = (text: string) => {
    navigator.clipboard.writeText(text)
    toast.success('تم النسخ! ')
  }

  const shareProfile = () => {
    if (navigator.share) {
      navigator.share({
        title: restaurant?.name || 'أسرة منتجة',
        text: `تفضل بزيارة ${restaurant?.name} على سفرة البيت`,
        url: window.location.href
      })
    } else {
      copyToClipboard(window.location.href)
    }
  }

  // التحقق من حالة المتابعة وجلب عدد المتابعين
  useEffect(() => {
    if (!restaurantId) return
    
    const checkFollowStatus = async () => {
      // جلب عدد المتابعين
      try {
        const followersQuery = query(
          collection(db, 'storeFollowers'),
          where('restaurantId', '==', restaurantId)
        )
        const followersSnap = await getDocs(followersQuery)
        setFollowersCount(followersSnap.size)
        
        // التحقق إذا كان المستخدم متابع
        if (user) {
          const userFollowQuery = query(
            collection(db, 'storeFollowers'),
            where('restaurantId', '==', restaurantId),
            where('followerId', '==', user.uid)
          )
          const userFollowSnap = await getDocs(userFollowQuery)
          if (!userFollowSnap.empty) {
            setIsFollowing(true)
            setFollowDocId(userFollowSnap.docs[0].id)
          }
        }
      } catch (err) {
        console.warn('خطأ في جلب بيانات المتابعة:', err)
      }
    }
    
    checkFollowStatus()
  }, [restaurantId, user])

  // متابعة/إلغاء متابعة المتجر
  const toggleFollow = async () => {
    if (!user) {
      toast.warning('سجّل دخولك أولاً للمتابعة')
      return
    }
    if (!restaurantId) return
    
    try {
      if (isFollowing && followDocId) {
        // إلغاء المتابعة
        await deleteDoc(doc(db, 'storeFollowers', followDocId))
        setIsFollowing(false)
        setFollowDocId(null)
        setFollowersCount(prev => Math.max(0, prev - 1))
        
        // تحديث إحصائيات المتجر
        const statsRef = doc(db, 'restaurantStats', restaurantId)
        await updateDoc(statsRef, {
          followersCount: increment(-1)
        }).catch(() => {})
        
        toast.info('تم إلغاء المتابعة')
      } else {
        // متابعة جديدة
        const newFollow = await addDoc(collection(db, 'storeFollowers'), {
          followerId: user.uid,
          followerName: user.displayName || user.email?.split('@')[0] || 'عميل',
          restaurantId,
          createdAt: serverTimestamp()
        })
        setIsFollowing(true)
        setFollowDocId(newFollow.id)
        setFollowersCount(prev => prev + 1)
        
        // تحديث إحصائيات المتجر
        const statsRef = doc(db, 'restaurantStats', restaurantId)
        const statsSnap = await getDoc(statsRef)
        if (statsSnap.exists()) {
          await updateDoc(statsRef, {
            followersCount: increment(1)
          })
        } else {
          // إنشاء سجل إحصائيات جديد
          await addDoc(collection(db, 'restaurantStats'), {
            restaurantId,
            totalProfileViews: 0,
            totalMenuViews: 0,
            totalItemViews: 0,
            totalShareClicks: 0,
            whatsappShareCount: 0,
            registeredCustomers: 0,
            appDownloads: 0,
            followersCount: 1,
            dailyViews: {},
            updatedAt: serverTimestamp()
          })
        }
        
        toast.success('أنت الآن تتابع هذا المتجر! ')
      }
    } catch (err) {
      console.error('خطأ في المتابعة:', err)
      toast.error('حدث خطأ، حاول مرة أخرى')
    }
  }

  useEffect(() => {
    (async () => {
      let qy
      
      if (restaurantId) {
        qy = query(
          collection(db, 'menuItems'), 
          where('available', '==', true),
          where('ownerId', '==', restaurantId)
        )
        
        const rSnap = await getDoc(doc(db, 'restaurants', restaurantId))
        if (rSnap.exists()) {
          setRestaurant({ id: rSnap.id, ...rSnap.data() } as Restaurant)
        }

        try {
          const promoQuery = query(
            collection(db, 'promotions'),
            where('ownerId', '==', restaurantId),
            where('isActive', '==', true)
          )
          const promoSnap = await getDocs(promoQuery)
          if (!promoSnap.empty) {
            const promos = promoSnap.docs.map(d => ({
              id: d.id,
              ...d.data(),
              expiresAt: d.data().expiresAt?.toDate?.(),
            } as Promotion))
            
            const now = new Date()
            const activePromos = promos.filter(p => !p.expiresAt || new Date(p.expiresAt) > now)
            
            if (activePromos.length > 0) {
              const promo = activePromos[0]
              setActivePromotion(promo)
              await updateDoc(doc(db, 'promotions', promo.id), {
                viewsCount: increment(1)
              })
            }
          }
        } catch (err) {}
      } else {
        qy = query(collection(db, 'menuItems'), where('available', '==', true))
      }
      
      const snap = await getDocs(qy)
      const itemsData: MenuItem[] = snap.docs.map(d => ({ id: d.id, ...d.data() } as MenuItem))

      const uniqueOwnerIds = [...new Set(itemsData.map(it => it.ownerId).filter(Boolean))] as string[]
      const restaurantsMap = new Map<string, Restaurant>()
      
      if (uniqueOwnerIds.length > 0) {
        const chunks = chunkArray(uniqueOwnerIds, 30)
        for (const chunk of chunks) {
          const q = query(collection(db, 'restaurants'), where(documentId(), 'in', chunk))
          const rSnap = await getDocs(q)
          rSnap.docs.forEach(d => restaurantsMap.set(d.id, { id: d.id, ...d.data() } as Restaurant))
        }
      }

      const enriched = itemsData.map(it => ({
        ...it,
        restaurant: it.ownerId ? restaurantsMap.get(it.ownerId) : undefined
      }))

      setItems(enriched)
      setLoading(false)
    })()
  }, [restaurantId])

  const handleAdd = (it: MenuItem) => {
    if (!it.ownerId) {
      toast.warning(' الصنف غير مرتبط بمطعم')
      return
    }

    const currentRestaurantId = cartItems[0]?.ownerId
    if (currentRestaurantId && currentRestaurantId !== it.ownerId) {
      toast.warning(' لا يمكن إضافة منتجات من أكثر من مطعم في نفس الطلب')
      return
    }

    // حساب السعر مع الخصم إن وجد
    const hasDiscount = it.discountPercent && it.discountPercent > 0
    const expiryDate = (it.discountExpiresAt as any)?.toDate?.() || (it.discountExpiresAt ? new Date(it.discountExpiresAt) : null)
    const isDiscountValid = hasDiscount && (!expiryDate || expiryDate > new Date())
    
    const basePrice = it.price + SERVICE_FEE_PER_ITEM
    const finalPrice = isDiscountValid 
      ? basePrice - (basePrice * ((it.discountPercent || 0) / 100))
      : basePrice

    add({ 
      id: it.id, 
      name: it.name, 
      price: finalPrice, 
      ownerId: it.ownerId 
    })
    toast.success('تمت الإضافة ')
  }

  if (loading) {
    return (
      <div className="flex flex-col items-center justify-center h-screen gap-4">
        <div className="w-16 h-16 border-4 border-amber-500 border-t-transparent rounded-full animate-spin" />
        <p className="text-gray-400 text-lg">جارِ التحميل...</p>
      </div>
    )
  }

  const canOrder = user && (role === 'customer' || role === 'admin' || role === 'developer' || !role)
  
  // هل المتجر مفتوح للطلبات؟ (افتراضي: مفتوح إذا لم تُحدد القيمة)
  const isStoreOpen = restaurant?.isOpen !== false
  
  // هل هذا المتجر هو متجر المستخدم الحالي؟
  const isOwnStore = user && restaurantId === user.uid

  const getTierBadge = (tier?: string) => {
    switch (tier) {
      case 'gold': return { label: 'ذهبي', bg: 'bg-gradient-to-r from-yellow-400 to-amber-500', icon: '' }
      case 'silver': return { label: 'فضي', bg: 'bg-gradient-to-r from-gray-300 to-gray-400', icon: '' }
      default: return { label: 'برونزي', bg: 'bg-gradient-to-r from-orange-500 to-orange-600', icon: '' }
    }
  }

  const tier = getTierBadge(restaurant?.sellerTier)

  return (
    <div className="min-h-screen pb-32 -mx-4 -mt-4">
      
      {/* ========== بانر المتجر مغلق ========== */}
      {!isStoreOpen && !isOwnStore && (
        <div className="bg-gradient-to-l from-red-500 to-rose-600 text-white p-4 flex items-center justify-center gap-3">
          <Lock className="w-6 h-6" />
          <span className="font-bold text-lg"> المتجر مغلق حالياً - لا يمكن الطلب</span>
        </div>
      )}
      
      {/* ========== بانر للصاحب ========== */}
      {isOwnStore && (
        <div className="bg-gradient-to-l from-emerald-500 to-teal-600 text-white p-4 flex items-center justify-between">
          <div className="flex items-center gap-3">
            <Building2 className="w-6 h-6" />
            <span className="font-bold">هذا متجرك! لإدارة المتجر:</span>
          </div>
          <Link 
            to="/"
            className="bg-white text-emerald-600 px-4 py-2 rounded-full font-bold hover:bg-gray-100 transition flex items-center gap-2"
          >
            لوحة التحكم
            <ArrowRight className="w-4 h-4" />
          </Link>
        </div>
      )}
      
      {/* ========== الهيدر مع الغلاف ========== */}
      <div className="relative">
        {/* الغلاف */}
        <div className="h-48 sm:h-56 bg-gradient-to-br from-amber-500 via-orange-500 to-red-500 relative overflow-hidden">
          <div className="absolute inset-0 bg-black/20" />
          {/* أشكال ديكورية */}
          <div className="absolute top-0 right-0 w-64 h-64 bg-white/10 rounded-full -translate-y-1/2 translate-x-1/2" />
          <div className="absolute bottom-0 left-0 w-48 h-48 bg-black/10 rounded-full translate-y-1/2 -translate-x-1/2" />
          
          {/* زر الرجوع */}
          <Link 
            to="/restaurants" 
            className="absolute top-4 right-4 flex items-center gap-2 bg-black/30 backdrop-blur-sm text-white px-4 py-2 rounded-full text-sm font-bold hover:bg-black/50 transition"
          >
            <ArrowRight className="w-4 h-4" />
            رجوع
          </Link>
          
          {/* أزرار المشاركة والمتابعة */}
          <div className="absolute top-4 left-4 flex items-center gap-2">
            {/* زر المتابعة */}
            {!isOwnStore && (
              <button 
                onClick={toggleFollow}
                className={`flex items-center gap-2 px-4 py-2 backdrop-blur-sm rounded-full font-bold transition ${
                  isFollowing 
                    ? 'bg-pink-500 text-white hover:bg-pink-600' 
                    : 'bg-black/30 text-white hover:bg-black/50'
                }`}
              >
                <Heart className={`w-5 h-5 ${isFollowing ? 'fill-white' : ''}`} />
                <span className="text-sm">{isFollowing ? 'متابَع' : 'متابعة'}</span>
              </button>
            )}
            
            {/* زر المشاركة */}
            <button 
              onClick={shareProfile}
              className="p-3 bg-black/30 backdrop-blur-sm rounded-full text-white hover:bg-black/50 transition"
            >
              <Share2 className="w-5 h-5" />
            </button>
          </div>
        </div>

        {/* بطاقة المعلومات الرئيسية */}
        {restaurant && (
          <div className="mx-4 -mt-20 relative z-10">
            <div className="bg-gray-900 rounded-3xl shadow-2xl border border-gray-800 overflow-hidden">
              
              {/* الجزء العلوي: الشعار والاسم */}
              <div className="p-6 text-center relative">
                {/* إطار الشعار */}
                <div className="relative inline-block mb-4">
                  <div className="w-28 h-28 rounded-full bg-gradient-to-br from-amber-400 to-orange-500 p-1 shadow-2xl">
                    <div className="w-full h-full rounded-full bg-white overflow-hidden">
                      {restaurant.logoUrl ? (
                        <img src={restaurant.logoUrl} alt={restaurant.name} className="w-full h-full object-cover" />
                      ) : (
                        <div className="w-full h-full bg-gradient-to-br from-amber-50 to-orange-100 flex items-center justify-center">
                          <span className="text-5xl"></span>
                        </div>
                      )}
                    </div>
                  </div>
                  
                  {/* شارة التوثيق */}
                  {(restaurant.isVerified || restaurant.licenseStatus === 'approved') ? (
                    <div className="absolute -bottom-1 -right-1 w-8 h-8 bg-green-500 rounded-full flex items-center justify-center border-4 border-gray-900 shadow-lg" title="أسرة موثقة">
                      <CheckCircle className="w-5 h-5 text-white" />
                    </div>
                  ) : (
                    <div className="absolute -bottom-1 -right-1 w-8 h-8 bg-amber-500 rounded-full flex items-center justify-center border-4 border-gray-900 shadow-lg" title="بانتظار التوثيق">
                      <Clock className="w-5 h-5 text-white" />
                    </div>
                  )}
                </div>

                {/* اسم الأسرة */}
                <h1 className="text-2xl sm:text-3xl font-black text-white mb-2">{restaurant.name}</h1>
                
                {/* الموقع */}
                {restaurant.city && (
                  <div className="flex items-center justify-center gap-2 text-gray-400 mb-3">
                    <MapPin className="w-4 h-4" />
                    <span>{restaurant.city}</span>
                  </div>
                )}

                {/* الشارات */}
                <div className="flex items-center justify-center gap-2 flex-wrap">
                  {/* شارة حالة المتجر */}
                  {isStoreOpen ? (
                    <span className="bg-green-500 text-white text-xs font-bold px-3 py-1.5 rounded-full animate-pulse">
                       متاح الآن
                    </span>
                  ) : (
                    <span className="bg-red-500 text-white text-xs font-bold px-3 py-1.5 rounded-full">
                       مغلق
                    </span>
                  )}
                  <span className={`${tier.bg} text-white text-xs font-bold px-3 py-1.5 rounded-full shadow-lg`}>
                    {tier.icon} {tier.label}
                  </span>
                  {(restaurant.isVerified || restaurant.licenseStatus === 'approved') ? (
                    <span className="bg-green-500 text-white text-xs font-bold px-3 py-1.5 rounded-full">
                       أسرة موثقة
                    </span>
                  ) : (
                    <span className="bg-amber-500 text-white text-xs font-bold px-3 py-1.5 rounded-full">
                      بانتظار التوثيق
                    </span>
                  )}
                </div>
              </div>

              {/* الإحصائيات */}
              <div className="grid grid-cols-5 border-t border-gray-800">
                <div className="p-3 text-center border-l border-gray-800">
                  <Heart className="w-5 h-5 text-pink-400 mx-auto mb-1" />
                  <p className="text-lg font-black text-white">{followersCount}</p>
                  <p className="text-[10px] text-gray-500">متابع</p>
                </div>
                <div className="p-3 text-center border-l border-gray-800">
                  <Utensils className="w-5 h-5 text-amber-400 mx-auto mb-1" />
                  <p className="text-lg font-black text-white">{items.length}</p>
                  <p className="text-[10px] text-gray-500">صنف</p>
                </div>
                <div className="p-3 text-center border-l border-gray-800">
                  <Package className="w-5 h-5 text-green-400 mx-auto mb-1" />
                  <p className="text-lg font-black text-white">{restaurant.totalOrders || 0}</p>
                  <p className="text-[10px] text-gray-500">طلب</p>
                </div>
                <div className="p-3 text-center border-l border-gray-800">
                  <Star className="w-5 h-5 text-yellow-400 mx-auto mb-1" />
                  <p className="text-lg font-black text-white">{restaurant.averageRating?.toFixed(1) || '0'}</p>
                  <p className="text-[10px] text-gray-500">تقييم</p>
                </div>
                <div className="p-3 text-center">
                  <Clock className="w-5 h-5 text-sky-400 mx-auto mb-1" />
                  <p className="text-lg font-black text-white">{restaurant.onTimeDeliveryRate ? `${Math.round(restaurant.onTimeDeliveryRate)}%` : '—'}</p>
                  <p className="text-[10px] text-gray-500">التزام</p>
                </div>
              </div>

              {/* معلومات التواصل */}
              <div className="p-4 border-t border-gray-800 space-y-3">
                {/*  رقم الجوال مخفي عن العملاء - التواصل فقط عبر المحادثة داخل التطبيق أثناء الطلب */}
                {/* الرقم يظهر فقط للإدارة (admin/developer) وصاحبة الحساب */}
                {(role === 'admin' || role === 'developer' || (role === 'owner' && user?.uid === restaurantId)) && restaurant.phone && (
                  <a 
                    href={`tel:${restaurant.phone}`}
                    className="flex items-center justify-between p-3 bg-green-500/10 hover:bg-green-500/20 rounded-xl transition"
                  >
                    <div className="flex items-center gap-3">
                      <div className="w-10 h-10 bg-green-500 rounded-xl flex items-center justify-center">
                        <Phone className="w-5 h-5 text-white" />
                      </div>
                      <div>
                        <p className="text-white font-bold">اتصل الآن</p>
                        <p className="text-green-400 text-sm" dir="ltr">{restaurant.phone}</p>
                      </div>
                    </div>
                    <ArrowRight className="w-5 h-5 text-green-400 rotate-180" />
                  </a>
                )}

                {restaurant.location && (
                  <div className="flex items-center gap-3 p-3 bg-gray-800/50 rounded-xl">
                    <div className="w-10 h-10 bg-sky-500/20 rounded-xl flex items-center justify-center">
                      <MapPin className="w-5 h-5 text-sky-400" />
                    </div>
                    <p className="text-gray-300 text-sm">{restaurant.location}</p>
                  </div>
                )}
              </div>

              {/* قسم التوظيف */}
              {restaurant.isHiring && (
                <div className="p-4 border-t border-gray-800">
                  <div className="bg-gradient-to-br from-purple-900/40 to-pink-900/40 rounded-2xl p-4 border border-purple-700/30">
                    <div className="flex items-center gap-2 mb-3">
                      <div className="w-10 h-10 bg-purple-500 rounded-xl flex items-center justify-center">
                        <Briefcase className="w-5 h-5 text-white" />
                      </div>
                      <div>
                        <span className="text-purple-400 font-bold block"> نوظّف الآن!</span>
                        <span className="text-purple-300/70 text-xs">فرص عمل متاحة</span>
                      </div>
                    </div>
                    
                    {restaurant.hiringDescription && (
                      <p className="text-gray-300 text-sm mb-4 leading-relaxed bg-gray-900/40 p-3 rounded-xl">
                        {restaurant.hiringDescription}
                      </p>
                    )}

                    {/*  رقم التوظيف مخفي عن العملاء - يظهر فقط للإدارة وصاحبة الحساب */}
                    {(role === 'admin' || role === 'developer' || (role === 'owner' && user?.uid === restaurantId)) && restaurant.hiringContact && (
                      <a
                        href={`https://wa.me/${restaurant.hiringContact.replace(/\D/g, '')}`}
                        target="_blank"
                        rel="noopener noreferrer"
                        className="flex items-center justify-center gap-2 w-full py-3 bg-gradient-to-r from-purple-500 to-pink-500 hover:from-purple-600 hover:to-pink-600 text-white rounded-xl font-bold transition"
                      >
                        <MessageCircle className="w-5 h-5" />
                        تواصل للتوظيف
                      </a>
                    )}
                  </div>
                </div>
              )}
            </div>
          </div>
        )}
      </div>

      {/* ========== الإعلان الممول ========== */}
      {activePromotion && showPromotion && (
        <div className="mx-4 mt-6 bg-gradient-to-r from-purple-900 via-purple-800 to-pink-900 rounded-2xl shadow-xl overflow-hidden relative">
          <button
            onClick={() => setShowPromotion(false)}
            className="absolute top-3 left-3 z-10 p-2 bg-black/40 hover:bg-black/60 rounded-full text-white transition"
          >
            <X className="w-4 h-4" />
          </button>

          <div className="absolute top-3 right-3 z-10 inline-flex items-center gap-1 px-3 py-1 bg-gradient-to-r from-purple-500 to-pink-500 text-white text-xs font-bold rounded-full shadow">
            <Megaphone className="w-3 h-3" />
            إعلان
          </div>

          {activePromotion.mediaUrl && (
            <img src={activePromotion.mediaUrl} alt="" className="w-full h-40 object-cover" />
          )}
          <div className="p-4">
            {activePromotion.title && <h3 className="text-lg font-bold text-white mb-1">{activePromotion.title}</h3>}
            {activePromotion.description && <p className="text-purple-100 text-sm">{activePromotion.description}</p>}
          </div>
        </div>
      )}

      {/* ========== قسم الأصناف ========== */}
      <div className="px-4 mt-6">
        <div className="flex items-center gap-3 mb-4">
          <div className="w-10 h-10 bg-amber-500/20 rounded-xl flex items-center justify-center">
            <Utensils className="w-5 h-5 text-amber-400" />
          </div>
          <h2 className="text-xl font-bold text-white">قائمة الأصناف</h2>
          <span className="bg-amber-500/20 text-amber-400 text-sm font-bold px-3 py-1 rounded-full mr-auto">
            {items.length}
          </span>
        </div>

        {items.length === 0 ? (
          <div className="text-center py-16 bg-gray-800/30 rounded-2xl">
            <ShoppingBag className="w-16 h-16 text-gray-600 mx-auto mb-4" />
            <p className="text-gray-400 text-lg">لا توجد أصناف حالياً</p>
          </div>
        ) : (
          <div className="grid grid-cols-2 gap-3">
            {items.map(it => (
              <div 
                key={it.id} 
                className="bg-gray-800 rounded-2xl overflow-hidden border border-gray-700/50 hover:border-amber-500/50 shadow-lg transition-all"
              >
                <div className="relative h-28 sm:h-36 overflow-hidden">
                  {it.imageUrl ? (
                    <img src={it.imageUrl} alt={it.name} className="w-full h-full object-cover" />
                  ) : (
                    <div className="w-full h-full flex items-center justify-center bg-gradient-to-br from-gray-700 to-gray-800">
                      <span className="text-4xl opacity-30"></span>
                    </div>
                  )}
                  
                  {/* شارة الخصم */}
                  {(() => {
                    const hasDiscount = it.discountPercent && it.discountPercent > 0;
                    const expiryDate = it.discountExpiresAt?.toDate?.() || (it.discountExpiresAt ? new Date(it.discountExpiresAt) : null);
                    const isValid = !expiryDate || expiryDate > new Date();
                    if (hasDiscount && isValid) {
                      return (
                        <div className="absolute top-2 right-2 bg-red-500 text-white text-xs font-bold px-2 py-1 rounded-full shadow-lg animate-pulse">
                          خصم {it.discountPercent}%
                        </div>
                      );
                    }
                    return null;
                  })()}
                  
                  {/* السعر */}
                  {(() => {
                    const hasDiscount = it.discountPercent && it.discountPercent > 0;
                    const expiryDate = it.discountExpiresAt?.toDate?.() || (it.discountExpiresAt ? new Date(it.discountExpiresAt) : null);
                    const isValid = !expiryDate || expiryDate > new Date();
                    const originalPrice = it.price + SERVICE_FEE_PER_ITEM;
                    
                    if (hasDiscount && isValid) {
                      const discountedPrice = originalPrice - (originalPrice * ((it.discountPercent || 0) / 100));
                      return (
                        <div className="absolute bottom-2 left-2 flex items-center gap-1.5">
                          <span className="bg-green-500 text-white font-black text-sm px-2 py-1 rounded-full shadow">
                            {discountedPrice.toFixed(0)} ر.س
                          </span>
                          <span className="bg-black/60 text-gray-300 text-xs px-1.5 py-0.5 rounded-full line-through">
                            {originalPrice.toFixed(0)}
                          </span>
                        </div>
                      );
                    }
                    return (
                      <div className="absolute bottom-2 left-2 bg-black/80 px-2 py-1 rounded-full">
                        <span className="font-black text-amber-400 text-sm">
                          {originalPrice.toFixed(0)} ر.س
                        </span>
                      </div>
                    );
                  })()}
                </div>

                <div className="p-3">
                  <h3 className="font-bold text-white text-sm mb-2 line-clamp-1">{it.name}</h3>
                  {canOrder && isStoreOpen && (
                    <button 
                      onClick={() => handleAdd(it)}
                      className="w-full py-2 rounded-xl font-bold text-sm bg-gradient-to-r from-amber-500 to-orange-500 text-black"
                    >
                      + أضف
                    </button>
                  )}
                  {canOrder && !isStoreOpen && (
                    <div className="w-full py-2 rounded-xl font-bold text-sm bg-gray-600 text-gray-300 text-center flex items-center justify-center gap-2">
                      <Lock className="w-4 h-4" />
                      مغلق
                    </div>
                  )}
                </div>
              </div>
            ))}
          </div>
        )}
      </div>

      {/* ========== شريط السلة ========== */}
      {subtotal > 0 && canOrder && (
        <div className="fixed bottom-0 left-0 right-0 z-50 p-4 bg-gradient-to-t from-gray-900 via-gray-900/98 to-transparent">
          <Link 
            to="/checkout" 
            className="flex items-center justify-between w-full max-w-lg mx-auto px-5 py-4 rounded-2xl bg-gradient-to-r from-sky-500 to-blue-600 text-white shadow-2xl font-bold"
          >
            <div className="flex items-center gap-3">
              <div className="relative">
                <ShoppingBag className="w-6 h-6" />
                <span className="absolute -top-2 -right-2 w-5 h-5 bg-amber-400 text-black text-xs font-black rounded-full flex items-center justify-center">
                  {cartItems.reduce((sum, i) => sum + i.qty, 0)}
                </span>
              </div>
              <span>عرض السلة</span>
            </div>
            <span className="text-xl font-black">{subtotal.toFixed(2)} ر.س</span>
          </Link>
        </div>
      )}
    </div>
  )
}

==========================================================================================
FILE: src/pages/NotificationsPage.tsx
==========================================================================================
import React, { useEffect, useState } from 'react'
import { useAuth } from '@/auth'
import { db } from '@/firebase'
import { 
  collection, query, where, orderBy, onSnapshot, 
  updateDoc, deleteDoc, doc, Timestamp 
} from 'firebase/firestore'
import { Bell, Check, Trash2, AlertCircle, RefreshCw, ArrowRight } from 'lucide-react'
import { useToast } from '@/components/ui/Toast'
import { useNavigate } from 'react-router-dom'

type Notification = {
  id: string
  type: string
  recipientId: string
  recipientType: string
  restaurantId?: string
  restaurantName?: string
  title: string
  message: string
  read: boolean
  createdAt: Timestamp
}

export const NotificationsPage: React.FC = () => {
  const { user } = useAuth()
  const toast = useToast()
  const navigate = useNavigate()
  const [notifications, setNotifications] = useState<Notification[]>([])
  const [loading, setLoading] = useState(true)

  useEffect(() => {
    if (!user) return

    const q = query(
      collection(db, 'notifications'),
      where('recipientId', '==', user.uid),
      orderBy('createdAt', 'desc')
    )

    const unsub = onSnapshot(q, (snap) => {
      const notifs = snap.docs.map(d => ({ id: d.id, ...d.data() })) as Notification[]
      setNotifications(notifs)
      setLoading(false)
    }, (err) => {
      console.error('Error fetching notifications:', err)
      setLoading(false)
    })

    return () => unsub()
  }, [user])

  const markAsRead = async (notifId: string) => {
    try {
      await updateDoc(doc(db, 'notifications', notifId), { read: true })
    } catch (err) {
      console.error('Error marking as read:', err)
    }
  }

  const markAllAsRead = async () => {
    const unread = notifications.filter(n => !n.read)
    try {
      await Promise.all(unread.map(n => 
        updateDoc(doc(db, 'notifications', n.id), { read: true })
      ))
      toast.success('تم تحديد الكل كمقروء')
    } catch (err) {
      toast.error('فشل تحديث الإشعارات')
    }
  }

  const deleteNotification = async (notifId: string) => {
    try {
      await deleteDoc(doc(db, 'notifications', notifId))
      toast.success('تم حذف الإشعار')
    } catch (err) {
      toast.error('فشل حذف الإشعار')
    }
  }

  const formatDate = (timestamp: Timestamp) => {
    if (!timestamp) return ''
    const date = timestamp.toDate()
    const now = new Date()
    const diff = now.getTime() - date.getTime()
    const minutes = Math.floor(diff / 60000)
    const hours = Math.floor(diff / 3600000)
    const days = Math.floor(diff / 86400000)

    if (minutes < 1) return 'الآن'
    if (minutes < 60) return `منذ ${minutes} دقيقة`
    if (hours < 24) return `منذ ${hours} ساعة`
    if (days < 7) return `منذ ${days} يوم`
    return date.toLocaleDateString('ar-SA')
  }

  const unreadCount = notifications.filter(n => !n.read).length

  if (loading) {
    return (
      <div className="min-h-screen bg-gray-50 flex items-center justify-center">
        <RefreshCw className="w-8 h-8 animate-spin text-sky-500" />
      </div>
    )
  }

  return (
    <div className="min-h-screen bg-gradient-to-b from-gray-50 to-white">
      {/* Header */}
      <div className="bg-white shadow-sm sticky top-0 z-10">
        <div className="max-w-2xl mx-auto px-4 py-4">
          <div className="flex items-center justify-between">
            <button
              onClick={() => navigate(-1)}
              className="flex items-center gap-2 text-gray-600 hover:text-gray-800"
            >
              <ArrowRight className="w-5 h-5" />
              رجوع
            </button>
            <h1 className="text-xl font-bold flex items-center gap-2">
              <Bell className="w-6 h-6 text-sky-500" />
              الإشعارات
              {unreadCount > 0 && (
                <span className="bg-red-500 text-white text-xs px-2 py-0.5 rounded-full">
                  {unreadCount}
                </span>
              )}
            </h1>
            {unreadCount > 0 && (
              <button
                onClick={markAllAsRead}
                className="text-sm text-sky-600 hover:text-sky-800"
              >
                قراءة الكل
              </button>
            )}
          </div>
        </div>
      </div>

      {/* Content */}
      <div className="max-w-2xl mx-auto px-4 py-6">
        {notifications.length === 0 ? (
          <div className="text-center py-16">
            <Bell className="w-16 h-16 mx-auto mb-4 text-gray-300" />
            <p className="text-gray-500">لا توجد إشعارات</p>
          </div>
        ) : (
          <div className="space-y-3">
            {notifications.map(notif => (
              <div
                key={notif.id}
                className={`bg-white rounded-2xl p-4 shadow-sm border transition hover:shadow-md ${
                  !notif.read ? 'border-sky-200 bg-sky-50/50' : 'border-gray-100'
                }`}
                onClick={() => !notif.read && markAsRead(notif.id)}
              >
                <div className="flex items-start gap-3">
                  <div className={`p-2 rounded-xl ${
                    notif.type === 'license_reminder' 
                      ? 'bg-orange-100 text-orange-600'
                      : 'bg-sky-100 text-sky-600'
                  }`}>
                    <AlertCircle className="w-5 h-5" />
                  </div>
                  <div className="flex-1 min-w-0">
                    <div className="flex items-start justify-between gap-2">
                      <h3 className="font-semibold text-gray-800">{notif.title}</h3>
                      <span className="text-xs text-gray-400 whitespace-nowrap">
                        {formatDate(notif.createdAt)}
                      </span>
                    </div>
                    <p className="text-sm text-gray-600 mt-1">{notif.message}</p>
                    {!notif.read && (
                      <span className="inline-block mt-2 text-xs bg-sky-100 text-sky-700 px-2 py-0.5 rounded-full">
                        جديد
                      </span>
                    )}
                  </div>
                  <div className="flex flex-col gap-1">
                    {!notif.read && (
                      <button
                        onClick={(e) => {
                          e.stopPropagation()
                          markAsRead(notif.id)
                        }}
                        className="p-1.5 text-gray-400 hover:text-green-500 transition"
                        title="تحديد كمقروء"
                      >
                        <Check className="w-4 h-4" />
                      </button>
                    )}
                    <button
                      onClick={(e) => {
                        e.stopPropagation()
                        deleteNotification(notif.id)
                      }}
                      className="p-1.5 text-gray-400 hover:text-red-500 transition"
                      title="حذف"
                    >
                      <Trash2 className="w-4 h-4" />
                    </button>
                  </div>
                </div>
              </div>
            ))}
          </div>
        )}
      </div>
    </div>
  )
}

export default NotificationsPage

==========================================================================================
FILE: src/pages/OrdersAdmin.tsx
==========================================================================================
// src/pages/OrdersAdmin.tsx
import React, { useEffect, useMemo, useState, useRef } from 'react'
import { collection, doc, onSnapshot, updateDoc, serverTimestamp, getDoc } from 'firebase/firestore'
import { ref, uploadBytes, getDownloadURL } from 'firebase/storage'
import { db, storage } from '@/firebase'
import { useAuth } from '@/auth'
import { useNavigate } from 'react-router-dom'
import { MessageCircle, Star, User, Camera, Loader2, CheckCircle, Image } from 'lucide-react'
import { RatingModal } from '@/components/RatingModal'
import { useToast } from '@/components/ui/Toast'
import { Rating } from '@/types'

type Order = any

//  ترجمة الحالات
const badge = (s: string) => {
  const map: Record<string, string> = {
    pending: ' قيد المراجعة',
    accepted: ' تم القبول',
    preparing: ' قيد التحضير',
    ready: ' جاهز',
    out_for_delivery: ' في الطريق',
    delivered: ' تم التسليم',
    cancelled: ' ملغي',
  }
  return map[s] || s
}

//  ألوان الحالات
const statusColor = (s: string) => {
  switch (s) {
    case 'pending': return 'bg-gray-200 text-gray-800'
    case 'accepted': return 'bg-blue-200 text-blue-800'
    case 'preparing': return 'bg-yellow-200 text-yellow-800'
    case 'ready': return 'bg-purple-200 text-purple-800'
    case 'out_for_delivery': return 'bg-indigo-200 text-indigo-800'
    case 'delivered': return 'bg-green-200 text-green-800'
    case 'cancelled': return 'bg-red-200 text-red-800'
    default: return 'bg-gray-100 text-gray-700'
  }
}

export const OrdersAdmin: React.FC = () => {
  const { user } = useAuth()
  const nav = useNavigate()
  const toast = useToast()
  const [orders, setOrders] = useState<Order[]>([])
  const [error, setError] = useState<string | null>(null)
  const [deliveryFees, setDeliveryFees] = useState<Record<string, number>>({})
  
  // حالة التقييم
  const [ratingModal, setRatingModal] = useState<{
    isOpen: boolean;
    orderId: string;
    customerName: string;
  } | null>(null)
  
  // حالة رفع صورة الطلب
  const [uploadingPhoto, setUploadingPhoto] = useState<string | null>(null)
  const fileInputRef = useRef<HTMLInputElement>(null)

  const restaurantUid = useMemo(() => user?.uid ?? null, [user])

  useEffect(() => {
    if (!restaurantUid) return
    setError(null)

    const unsub = onSnapshot(
      collection(db, 'orders'),
      (snap) => {
        const all = snap.docs.map(d => ({ id: d.id, ...(d.data() as any) }))
        const mine = all.filter((o: any) => {
          const r1 = o.restaurantId === restaurantUid
          const r2 = o?.items?.[0]?.ownerId === restaurantUid
          return r1 || r2
        })

        mine.sort((a: any, b: any) => {
          const ta = a.createdAt?.toMillis?.() ?? 0
          const tb = b.createdAt?.toMillis?.() ?? 0
          return tb - ta
        })

        setOrders(mine)
        setError(null)
      },
      (err) => {
        console.error('Firestore error:', err)
        setError('حدثت مشكلة في جلب الطلبات.')
      }
    )

    return () => unsub()
  }, [restaurantUid])

  const updateStatus = async (id: string, status: string, order?: any) => {
    const updates: any = { 
      status, 
      updatedAt: serverTimestamp()
    }
    
    // عند القبول، نضيف رسوم التوصيل ونحدث الإجمالي
    if (status === 'accepted' && order?.deliveryType === 'delivery') {
      const fee = deliveryFees[id] || 0
      updates.deliveryFee = fee
      updates.total = (order.subtotal || 0) + fee
    }
    
    await updateDoc(doc(db, 'orders', id), updates)
  }

  // إرسال تقييم العميل من الأسرة
  const submitCustomerRating = async (orderId: string, rating: { stars: number; comment: string }) => {
    const ratingData: Rating = {
      stars: rating.stars,
      comment: rating.comment || undefined,
      createdAt: new Date()
    }

    await updateDoc(doc(db, 'orders', orderId), {
      'ratings.restaurantToCustomer': ratingData,
      updatedAt: serverTimestamp()
    })

    toast.success('تم تقييم العميل بنجاح! ')
  }

  // التحقق إذا كان الطلب يحتاج تقييم للعميل
  const needsCustomerRating = (order: any) => {
    return order.status === 'delivered' && !order.ratings?.restaurantToCustomer?.stars
  }

  // رفع صورة الطلب الجاهز
  const uploadOrderPhoto = async (orderId: string, file: File) => {
    if (!file) return
    
    setUploadingPhoto(orderId)
    
    try {
      // رفع الصورة إلى Firebase Storage
      const storageRef = ref(storage, `orders/${orderId}/ready_${Date.now()}.[REDACTED_IMAGE_EXT]`)
      await uploadBytes(storageRef, file)
      const photoUrl = await getDownloadURL(storageRef)
      
      // تحديث الطلب بالصورة
      await updateDoc(doc(db, 'orders', orderId), {
        readyPhotoUrl: photoUrl,
        readyPhotoAt: serverTimestamp(),
        updatedAt: serverTimestamp()
      })
      
      toast.success('تم رفع صورة الطلب بنجاح! ')
    } catch (error) {
      console.error('Error uploading photo:', error)
      toast.error('حدث خطأ في رفع الصورة')
    } finally {
      setUploadingPhoto(null)
    }
  }

  // معالجة اختيار الصورة
  const handlePhotoSelect = (orderId: string, event: React.ChangeEvent<HTMLInputElement>) => {
    const file = event.target.files?.[0]
    if (file) {
      uploadOrderPhoto(orderId, file)
    }
  }

  return (
    <div className="space-y-6">
      <h1 className="text-2xl font-extrabold text-yellow-500"> إدارة الطلبات</h1>

      {/* نافذة التقييم */}
      {ratingModal && (
        <RatingModal
          isOpen={ratingModal.isOpen}
          onClose={() => setRatingModal(null)}
          onSubmit={async (rating) => {
            await submitCustomerRating(ratingModal.orderId, rating)
            setRatingModal(null)
          }}
          type="customer"
          targetName={ratingModal.customerName}
          orderId={ratingModal.orderId}
        />
      )}

      {error && <div className="text-red-500 text-sm mb-2">{error}</div>}

      {orders.map((o: any) => (
        <div 
          key={o.id} 
          className="bg-white rounded-2xl shadow-xl p-5 text-gray-900 space-y-4 transition hover:shadow-2xl"
        >
          {/*  رأس الطلب */}
          <div className="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-2">
            <div className="font-bold text-lg">
              طلب #{o.id.slice(-6)} 
              <span className="text-gray-500 text-sm ml-2">
                {o.items?.map((i:any)=>`${i.name}×${i.qty}`).join(' • ')}
              </span>
            </div>
            <div className="font-extrabold text-xl text-green-600">{o.total?.toFixed?.(2)} ر.س</div>
          </div>

          {/*  الحالة الحالية */}
          <div className="flex items-center gap-2">
            <span className="text-sm font-semibold">الحالة:</span>
            <span className={`px-3 py-1 rounded-full text-sm font-bold ${statusColor(o.status)}`}>
              {badge(o.status || 'pending')}
            </span>
          </div>

          {/*  العنوان */}
          <div className="text-sm text-gray-700">
            <span className="font-semibold">العنوان:</span> {o.address}
          </div>

          {/*  موقع العميل على الخريطة */}
          {o.location && (
            <div className="mt-3">
              <h3 className="font-semibold text-sm text-gray-800 mb-2"> موقع العميل:</h3>
              <iframe
                title={`map-${o.id}`}
                width="100%"
                height="250"
                style={{ borderRadius: '12px' }}
                loading="lazy"
                allowFullScreen
                src={`https://www.google.com/maps?q=${o.location.lat},${o.location.lng}&hl=ar&z=15&output=embed`}
              ></iframe>
            </div>
          )}

          {/*  إدخال رسوم التوصيل للطلبات الجديدة */}
          {o.status === 'pending' && o.deliveryType === 'delivery' && (
            <div className="bg-amber-50 border border-amber-200 rounded-xl p-4">
              <label className="block text-sm font-bold text-amber-800 mb-2">
                 حدد رسوم التوصيل قبل القبول:
              </label>
              <div className="flex items-center gap-3">
                <input
                  type="number"
                  min="0"
                  step="0.5"
                  placeholder="مثال: 10"
                  value={deliveryFees[o.id] || ''}
                  onChange={(e) => setDeliveryFees(prev => ({ ...prev, [o.id]: parseFloat(e.target.value) || 0 }))}
                  className="flex-1 px-4 py-3 border-2 border-amber-300 rounded-xl focus:border-amber-500 focus:ring-2 focus:ring-amber-200 text-lg font-bold text-center"
                />
                <span className="text-amber-700 font-bold">ر.س</span>
              </div>
              <p className="text-xs text-amber-600 mt-2">سيتم إضافتها للإجمالي عند قبول الطلب</p>
            </div>
          )}

          {/* عرض رسوم التوصيل المحددة */}
          {o.deliveryFee !== undefined && o.deliveryFee > 0 && (
            <div className="text-sm text-gray-700">
              <span className="font-semibold">رسوم التوصيل:</span> {o.deliveryFee?.toFixed?.(2)} ر.س
            </div>
          )}

          {/*  رفع صورة الطلب الجاهز - للطلبات قيد التحضير أو الجاهزة */}
          {['preparing', 'ready'].includes(o.status) && (
            <div className="bg-gradient-to-r from-purple-50 to-pink-50 border-2 border-purple-200 rounded-2xl p-4">
              <div className="flex items-center gap-2 mb-3">
                <Camera className="w-5 h-5 text-purple-600" />
                <span className="font-bold text-purple-800"> صورة الطلب الجاهز</span>
              </div>
              
              {o.readyPhotoUrl ? (
                <div className="space-y-3">
                  <div className="relative">
                    <img 
                      src={o.readyPhotoUrl} 
                      alt="صورة الطلب" 
                      className="w-full h-48 object-cover rounded-xl border-2 border-purple-300"
                    />
                    <div className="absolute top-2 left-2 bg-green-500 text-white px-2 py-1 rounded-full text-xs font-bold flex items-center gap-1">
                      <CheckCircle className="w-3 h-3" />
                      تم الرفع
                    </div>
                  </div>
                  <p className="text-xs text-purple-600 text-center">
                     تم رفع صورة الطلب - يمكن للمندوب استلامه الآن
                  </p>
                </div>
              ) : (
                <div className="space-y-3">
                  <p className="text-sm text-purple-700">
                     يُرجى رفع صورة الطلب قبل تسليمه للمندوب
                  </p>
                  <input
                    type="file"
                    accept="image/*"
                    capture="environment"
                    onChange={(e) => handlePhotoSelect(o.id, e)}
                    className="hidden"
                    id={`photo-${o.id}`}
                  />
                  <label
                    htmlFor={`photo-${o.id}`}
                    className={`flex items-center justify-center gap-3 w-full py-4 rounded-xl cursor-pointer transition-all ${
                      uploadingPhoto === o.id 
                        ? 'bg-purple-200 cursor-wait' 
                        : 'bg-purple-500 hover:bg-purple-600 text-white'
                    }`}
                  >
                    {uploadingPhoto === o.id ? (
                      <>
                        <Loader2 className="w-5 h-5 animate-spin" />
                        <span>جاري الرفع...</span>
                      </>
                    ) : (
                      <>
                        <Camera className="w-5 h-5" />
                        <span className="font-bold"> التقط صورة الطلب</span>
                      </>
                    )}
                  </label>
                </div>
              )}
            </div>
          )}

          {/* عرض صورة الطلب للطلبات المكتملة */}
          {o.readyPhotoUrl && !['preparing', 'ready'].includes(o.status) && (
            <div className="bg-gray-50 rounded-xl p-3">
              <div className="flex items-center gap-2 mb-2">
                <Image className="w-4 h-4 text-gray-500" />
                <span className="text-sm font-medium text-gray-700">صورة الطلب:</span>
              </div>
              <img 
                src={o.readyPhotoUrl} 
                alt="صورة الطلب" 
                className="w-full h-32 object-cover rounded-lg"
              />
            </div>
          )}

          {/*  أزرار تغيير الحالة */}
          <div className="mt-3 grid grid-cols-2 sm:flex sm:flex-wrap gap-2">
            {/* زر المحادثة مع العميل */}
            {!o.courierId && ['pending', 'accepted', 'preparing', 'ready'].includes(o.status) && (
              <button
                onClick={() => nav(`/chat?orderId=${o.id}`)}
                className="px-4 py-2 rounded-xl text-sm font-semibold bg-gradient-to-r from-orange-500 to-amber-500 text-white hover:shadow-lg transition flex items-center gap-2"
              >
                <MessageCircle className="w-4 h-4" />
                محادثة العميل 
              </button>
            )}
            
            {['accepted','preparing','ready','out_for_delivery','delivered','cancelled'].map(s => {
              // منع القبول بدون تحديد رسوم التوصيل
              const needsFee = s === 'accepted' && o.status === 'pending' && o.deliveryType === 'delivery'
              const hasFee = deliveryFees[o.id] !== undefined && deliveryFees[o.id] >= 0
              const disabled = needsFee && !hasFee
              
              return (
                <button 
                  key={s} 
                  onClick={()=>updateStatus(o.id, s, o)} 
                  disabled={disabled}
                  className={`px-4 py-2 rounded-xl text-sm font-semibold transition ${disabled ? 'bg-gray-200 text-gray-400 cursor-not-allowed' : 'bg-gray-100 hover:bg-gray-200'}`}
                  title={disabled ? 'حدد رسوم التوصيل أولاً' : ''}
                >
                  {badge(s)}
                </button>
              )
            })}
          </div>

          {/* نظام تقييم العميل - للطلبات المكتملة */}
          {needsCustomerRating(o) && (
            <div className="mt-4 bg-gradient-to-r from-sky-50 to-blue-50 border-2 border-sky-200 rounded-2xl p-4">
              <div className="flex items-center gap-2 mb-3">
                <Star className="w-5 h-5 text-sky-500 fill-sky-500" />
                <span className="font-bold text-sky-800">قيّم العميل </span>
              </div>
              <button
                onClick={() => setRatingModal({
                  isOpen: true,
                  orderId: o.id,
                  customerName: 'العميل'
                })}
                className="w-full flex items-center justify-between px-4 py-3 bg-white border-2 border-sky-300 
                           rounded-xl hover:bg-sky-50 transition-all group"
              >
                <div className="flex items-center gap-3">
                  <User className="w-5 h-5 text-sky-600" />
                  <span className="font-medium text-gray-800">قيّم تعامل العميل</span>
                </div>
                <div className="flex items-center gap-1">
                  {[1,2,3,4,5].map(n => (
                    <Star key={n} className="w-4 h-4 text-gray-300 group-hover:text-sky-400 transition" />
                  ))}
                </div>
              </button>
            </div>
          )}

          {/* عرض التقييم المكتمل */}
          {o.ratings?.restaurantToCustomer?.stars && (
            <div className="mt-4 bg-green-50 border border-green-200 rounded-xl p-3">
              <div className="flex items-center justify-between">
                <span className="text-green-700 font-medium">تقييمك للعميل:</span>
                <div className="flex items-center gap-1">
                  {[1,2,3,4,5].map(n => (
                    <Star key={n} className={`w-4 h-4 ${n <= o.ratings.restaurantToCustomer.stars ? 'text-sky-400 fill-sky-400' : 'text-gray-300'}`} />
                  ))}
                </div>
              </div>
            </div>
          )}
        </div>
      ))}

      {orders.length === 0 && !error && (
        <div className="text-gray-400 text-center text-lg"> لا توجد طلبات حالياً.</div>
      )}
    </div>
  )
}

==========================================================================================
FILE: src/pages/OwnerDashboard.tsx
==========================================================================================
// src/pages/OwnerDashboard.tsx
import React, { useEffect, useState } from 'react'
import { Link } from 'react-router-dom'
import { useAuth } from '@/auth'
import { db } from '@/firebase'
import { 
  collection, query, where, getDocs, doc, getDoc, orderBy, updateDoc, increment, setDoc, serverTimestamp
} from 'firebase/firestore'
import { 
  Utensils, ClipboardList, Settings, Crown, Sparkles, Megaphone, Building2,
  TrendingUp, ShoppingBag, Star, Truck, Wallet, Package, 
  ChefHat, Clock, CheckCircle, AlertCircle, RefreshCw, Phone, MapPin,
  Briefcase, Eye, MessageCircle, Plus, Edit3, BarChart3, 
  Users, Gift, Zap, Shield, Camera, Globe, Bell, ArrowRight,
  Store, Layers, PieChart, Target, Award, Flame, Heart, Share2, Copy, Link2,
  UserPlus, Download, ExternalLink, MinusCircle
} from 'lucide-react'
import { useToast } from '@/components/ui/Toast'
import { POINTS_CONFIG } from '@/types'

type Restaurant = {
  name: string
  logoUrl?: string
  phone?: string
  city?: string
  location?: string
  description?: string
  packageType?: 'free' | 'premium'
  packageExpiresAt?: any
  packageSubscribedAt?: any
  isVerified?: boolean
  rating?: number
  deliveryRate?: number
  totalOrders?: number
  bankName?: string
  bankAccountName?: string
  bankAccountNumber?: string
  isHiring?: boolean
  hiringDescription?: string
  hiringContact?: string
  sellerTier?: string
  commercialLicenseUrl?: string
  licenseStatus?: 'pending' | 'approved' | 'rejected'
  licenseNotes?: string
  isOpen?: boolean
  // نظام النقاط
  points?: {
    currentPoints: number
    isSuspended: boolean
    warningCount: number
  }
}

type Order = {
  id: string
  status: string
  total: number
  subtotal: number
  deliveryFee: number
  createdAt?: any
  items: any[]
}

type MenuItem = {
  id: string
  name: string
  price: number
  available: boolean
}

type Promotion = {
  id: string
  isActive: boolean
  viewsCount?: number
  expiresAt?: any
}

type Stats = {
  todayOrders: number
  todayRevenue: number
  weekOrders: number
  weekRevenue: number
  monthOrders: number
  monthRevenue: number
  totalOrders: number
  totalRevenue: number
  pendingOrders: number
  preparingOrders: number
  deliveredOrders: number
  cancelledOrders: number
  menuItems: number
  availableItems: number
  averageRating: number
  deliveryRate: number
  activePromotions: number
  totalViews: number
  uniqueCustomers: number
  // إحصائيات الزيارات الجديدة
  profileViews: number
  menuViews: number
  itemViews: number
  shareClicks: number
  whatsappShares: number
  registeredViaLink: number
  todayViews: number
  followersCount: number
}

type RestaurantStats = {
  totalProfileViews: number
  totalMenuViews: number
  totalItemViews: number
  totalShareClicks: number
  whatsappShareCount: number
  registeredCustomers: number
  appDownloads: number
  followersCount: number
  dailyViews: Record<string, number>
}

export const OwnerDashboard: React.FC = () => {
  const { user } = useAuth()
  const toast = useToast()
  const [loading, setLoading] = useState(true)
  const [refreshing, setRefreshing] = useState(false)
  const [restaurant, setRestaurant] = useState<Restaurant | null>(null)
  const [activeTab, setActiveTab] = useState<'overview' | 'orders' | 'menu' | 'marketing' | 'settings'>('overview')
  const [stats, setStats] = useState<Stats>({
    todayOrders: 0, todayRevenue: 0,
    weekOrders: 0, weekRevenue: 0,
    monthOrders: 0, monthRevenue: 0,
    totalOrders: 0, totalRevenue: 0,
    pendingOrders: 0, preparingOrders: 0,
    deliveredOrders: 0, cancelledOrders: 0,
    menuItems: 0, availableItems: 0,
    averageRating: 0, deliveryRate: 0,
    activePromotions: 0, totalViews: 0,
    uniqueCustomers: 0,
    // إحصائيات الزيارات الجديدة
    profileViews: 0, menuViews: 0, itemViews: 0,
    shareClicks: 0, whatsappShares: 0,
    registeredViaLink: 0, todayViews: 0, followersCount: 0
  })
  const [copied, setCopied] = useState(false)
  const [restaurantStats, setRestaurantStats] = useState<RestaurantStats | null>(null)

  // رابط المتجر مع كود الإحالة
  const getStoreLink = (source?: string) => {
    const baseUrl = `${window.location.origin}/menu?restaurant=${user?.uid}`
    return source ? `${baseUrl}&ref=${source}` : baseUrl
  }

  // تسجيل المشاركة وتحديث الإحصائيات
  const trackShare = async (type: 'copy' | 'whatsapp' | 'social') => {
    if (!user?.uid) return
    try {
      const statsRef = doc(db, 'restaurantStats', user.uid)
      const updates: Record<string, any> = {
        totalShareClicks: increment(1),
        updatedAt: serverTimestamp()
      }
      if (type === 'whatsapp') {
        updates.whatsappShareCount = increment(1)
      }
      await updateDoc(statsRef, updates).catch(async () => {
        // إنشاء المستند إذا لم يكن موجود
        await setDoc(statsRef, {
          totalProfileViews: 0,
          totalMenuViews: 0,
          totalItemViews: 0,
          totalShareClicks: 1,
          whatsappShareCount: type === 'whatsapp' ? 1 : 0,
          registeredCustomers: 0,
          appDownloads: 0,
          dailyViews: {},
          updatedAt: serverTimestamp()
        })
      })
    } catch (err) {
      console.warn('خطأ في تسجيل المشاركة:', err)
    }
  }

  // نسخ رابط المتجر
  const copyStoreLink = async () => {
    const link = getStoreLink('copy')
    await navigator.clipboard.writeText(link)
    setCopied(true)
    setTimeout(() => setCopied(false), 2000)
    toast.success('تم نسخ الرابط! ')
    trackShare('copy')
  }

  // مشاركة عبر الواتساب
  const shareToWhatsapp = () => {
    const link = getStoreLink('whatsapp')
    const text = encodeURIComponent(` تفضل بزيارة متجر ${restaurant?.name || 'متجري'} على سفرة البيت!\n\n${link}`)
    window.open(`https://wa.me/?text=${text}`, '_blank')
    toast.success('جاري فتح الواتساب... ')
    trackShare('whatsapp')
  }

  // مشاركة المتجر (عامة)
  const shareStore = async () => {
    const link = getStoreLink('social')
    if (navigator.share) {
      try {
        await navigator.share({
          title: restaurant?.name || 'متجري',
          text: `تفضل بزيارة ${restaurant?.name} على سفرة البيت`,
          url: link
        })
        trackShare('social')
      } catch (err) {
        copyStoreLink()
      }
    } else {
      copyStoreLink()
    }
  }
  const [recentOrders, setRecentOrders] = useState<Order[]>([])
  const [topItems, setTopItems] = useState<{ name: string; count: number }[]>([])

  // تحميل البيانات
  const loadData = async () => {
    if (!user?.uid) return

    try {
      // جلب بيانات المطعم
      const restaurantDoc = await getDoc(doc(db, 'restaurants', user.uid))
      if (restaurantDoc.exists()) {
        setRestaurant(restaurantDoc.data() as Restaurant)
      }

      // جلب الأصناف
      const menuQuery = query(
        collection(db, 'menuItems'),
        where('ownerId', '==', user.uid)
      )
      const menuSnap = await getDocs(menuQuery)
      const menuItems = menuSnap.docs.map(d => ({ id: d.id, ...d.data() } as MenuItem))

      // جلب الطلبات
      const ordersQuery = query(
        collection(db, 'orders'),
        where('ownerId', '==', user.uid),
        orderBy('createdAt', 'desc')
      )
      const ordersSnap = await getDocs(ordersQuery)
      const orders = ordersSnap.docs.map(d => ({ id: d.id, ...d.data() } as Order))

      // جلب الإعلانات
      let activePromotions = 0
      let totalViews = 0
      try {
        const promoQuery = query(
          collection(db, 'promotions'),
          where('ownerId', '==', user.uid)
        )
        const promoSnap = await getDocs(promoQuery)
        promoSnap.docs.forEach(d => {
          const data = d.data() as Promotion
          if (data.isActive) activePromotions++
          totalViews += data.viewsCount || 0
        })
      } catch (e) {}

      // حساب الإحصائيات الزمنية
      const now = new Date()
      const today = new Date(now.getFullYear(), now.getMonth(), now.getDate())
      const weekAgo = new Date(today.getTime() - 7 * 24 * 60 * 60 * 1000)
      const monthAgo = new Date(today.getTime() - 30 * 24 * 60 * 60 * 1000)

      const todayOrders = orders.filter(o => {
        const orderDate = o.createdAt?.toDate?.() || new Date(0)
        return orderDate >= today && o.status !== 'cancelled'
      })

      const weekOrders = orders.filter(o => {
        const orderDate = o.createdAt?.toDate?.() || new Date(0)
        return orderDate >= weekAgo && o.status !== 'cancelled'
      })

      const monthOrders = orders.filter(o => {
        const orderDate = o.createdAt?.toDate?.() || new Date(0)
        return orderDate >= monthAgo && o.status !== 'cancelled'
      })

      const deliveredOrders = orders.filter(o => o.status === 'delivered')
      const pendingOrders = orders.filter(o => o.status === 'pending')
      const preparingOrders = orders.filter(o => ['accepted', 'preparing'].includes(o.status))
      const cancelledOrders = orders.filter(o => o.status === 'cancelled')

      // حساب عدد العملاء الفريدين
      const uniqueCustomerIds = new Set(orders.map((o: any) => o.customerId).filter(Boolean))

      // حساب أكثر الأصناف مبيعاً
      const itemCounts: Record<string, number> = {}
      deliveredOrders.forEach(order => {
        order.items?.forEach((item: any) => {
          const name = item.name || 'غير معروف'
          itemCounts[name] = (itemCounts[name] || 0) + (item.qty || 1)
        })
      })
      const sortedItems = Object.entries(itemCounts)
        .sort((a, b) => b[1] - a[1])
        .slice(0, 5)
        .map(([name, count]) => ({ name, count }))

      setTopItems(sortedItems)
      setRecentOrders(orders.slice(0, 5))
      
      // جلب إحصائيات الزيارات
      let profileViews = 0, menuViews = 0, itemViews = 0
      let shareClicks = 0, whatsappShares = 0, registeredViaLink = 0, todayViewsCount = 0, followersCount = 0
      try {
        const statsDoc = await getDoc(doc(db, 'restaurantStats', user.uid))
        if (statsDoc.exists()) {
          const statsData = statsDoc.data() as RestaurantStats
          setRestaurantStats(statsData)
          profileViews = statsData.totalProfileViews || 0
          menuViews = statsData.totalMenuViews || 0
          itemViews = statsData.totalItemViews || 0
          shareClicks = statsData.totalShareClicks || 0
          whatsappShares = statsData.whatsappShareCount || 0
          registeredViaLink = statsData.registeredCustomers || 0
          followersCount = statsData.followersCount || 0
          
          // حساب زيارات اليوم
          const todayKey = new Date().toISOString().split('T')[0]
          todayViewsCount = statsData.dailyViews?.[todayKey] || 0
        }
      } catch (e) {
        console.warn('خطأ في جلب إحصائيات الزيارات:', e)
      }

      // جلب عدد العملاء المسجلين عبر رابط الأسرة
      try {
        const registrationsQuery = query(
          collection(db, 'customerRegistrations'),
          where('restaurantId', '==', user.uid)
        )
        const registrationsSnap = await getDocs(registrationsQuery)
        registeredViaLink = registrationsSnap.size
      } catch (e) {}

      // جلب عدد المتابعين
      try {
        const followersQuery = query(
          collection(db, 'storeFollowers'),
          where('restaurantId', '==', user.uid)
        )
        const followersSnap = await getDocs(followersQuery)
        followersCount = followersSnap.size
      } catch (e) {}
      
      setStats({
        todayOrders: todayOrders.length,
        todayRevenue: todayOrders.reduce((sum, o) => sum + (o.subtotal || 0), 0),
        weekOrders: weekOrders.length,
        weekRevenue: weekOrders.reduce((sum, o) => sum + (o.subtotal || 0), 0),
        monthOrders: monthOrders.length,
        monthRevenue: monthOrders.reduce((sum, o) => sum + (o.subtotal || 0), 0),
        totalOrders: orders.filter(o => o.status !== 'cancelled').length,
        totalRevenue: deliveredOrders.reduce((sum, o) => sum + (o.subtotal || 0), 0),
        pendingOrders: pendingOrders.length,
        preparingOrders: preparingOrders.length,
        deliveredOrders: deliveredOrders.length,
        cancelledOrders: cancelledOrders.length,
        menuItems: menuItems.length,
        availableItems: menuItems.filter(m => m.available).length,
        averageRating: restaurantDoc.data()?.rating || 0,
        deliveryRate: restaurantDoc.data()?.deliveryRate || 0,
        activePromotions,
        totalViews,
        uniqueCustomers: uniqueCustomerIds.size,
        // إحصائيات الزيارات الجديدة
        profileViews,
        menuViews,
        itemViews,
        shareClicks,
        whatsappShares,
        registeredViaLink,
        todayViews: todayViewsCount,
        followersCount
      })

    } catch (err) {
      console.error('خطأ في تحميل البيانات:', err)
    } finally {
      setLoading(false)
      setRefreshing(false)
    }
  }

  useEffect(() => {
    loadData()
  }, [user?.uid])

  const handleRefresh = () => {
    setRefreshing(true)
    loadData()
  }

  // حالة الطلب
  const getStatusInfo = (status: string) => {
    const statusMap: Record<string, { label: string; color: string; icon: any }> = {
      pending: { label: 'بانتظار القبول', color: 'bg-yellow-100 text-yellow-700', icon: Clock },
      accepted: { label: 'مقبول', color: 'bg-blue-100 text-blue-700', icon: CheckCircle },
      preparing: { label: 'جاري التحضير', color: 'bg-orange-100 text-orange-700', icon: ChefHat },
      ready: { label: 'جاهز للتوصيل', color: 'bg-purple-100 text-purple-700', icon: Package },
      out_for_delivery: { label: 'في الطريق', color: 'bg-indigo-100 text-indigo-700', icon: Truck },
      delivered: { label: 'تم التوصيل', color: 'bg-green-100 text-green-700', icon: CheckCircle },
      cancelled: { label: 'ملغي', color: 'bg-red-100 text-red-700', icon: AlertCircle },
    }
    return statusMap[status] || { label: status, color: 'bg-gray-100 text-gray-700', icon: Clock }
  }

  const getTierInfo = (tier?: string) => {
    switch (tier) {
      case 'gold': return { label: 'ذهبي', color: 'from-yellow-400 to-amber-500', icon: '' }
      case 'silver': return { label: 'فضي', color: 'from-gray-300 to-gray-400', icon: '' }
      default: return { label: 'برونزي', color: 'from-orange-500 to-orange-600', icon: '' }
    }
  }

  if (loading) {
    return (
      <div className="flex items-center justify-center min-h-[60vh]">
        <div className="text-center">
          <div className="w-16 h-16 border-4 border-amber-500 border-t-transparent rounded-full animate-spin mx-auto mb-4" />
          <p className="text-gray-600">جارِ التحميل...</p>
        </div>
      </div>
    )
  }

  // التحقق من الاشتراك في الباقة المميزة
  const isPremium = restaurant?.packageType === 'premium'
  const tier = getTierInfo(restaurant?.sellerTier)

  // حساب الأيام المتبقية للاشتراك
  const getDaysRemaining = () => {
    if (!restaurant?.packageExpiresAt) return null
    const expiresAt = restaurant.packageExpiresAt?.toDate?.() || new Date(restaurant.packageExpiresAt)
    const now = new Date()
    const diff = expiresAt.getTime() - now.getTime()
    return Math.ceil(diff / (1000 * 60 * 60 * 24))
  }
  const daysRemaining = getDaysRemaining()
  const isExpiringSoon = daysRemaining !== null && daysRemaining <= 7 && daysRemaining > 0
  const isExpired = daysRemaining !== null && daysRemaining <= 0

  // حساب صافي الأرباح
  const calculateNetProfit = () => {
    const grossRevenue = stats.totalRevenue
    const platformFee = stats.deliveredOrders * 3.75 // رسوم المنصة الثابتة
    return grossRevenue - platformFee
  }
  const netProfit = calculateNetProfit()

  // ===== صفحة الباقة المجانية (البسيطة) =====
  if (!isPremium) {
    return (
      <div className="space-y-6 pb-20">
        {/* ========== بطاقة حالة الاشتراك ========== */}
        <div className="bg-gradient-to-br from-gray-100 to-gray-50 rounded-2xl p-4 border-2 border-gray-200">
          <div className="flex items-center justify-between">
            <div className="flex items-center gap-3">
              <div className="w-12 h-12 bg-gray-300 rounded-xl flex items-center justify-center">
                <Package className="w-6 h-6 text-gray-600" />
              </div>
              <div>
                <h3 className="font-bold text-gray-700"> الباقة المجانية</h3>
                <p className="text-sm text-gray-500">المميزات الأساسية</p>
              </div>
            </div>
            <Link
              to="/owner/packages"
              className="bg-gradient-to-r from-amber-500 to-orange-500 text-white px-4 py-2 rounded-xl text-sm font-bold hover:shadow-lg transition"
            >
              ترقية 
            </Link>
          </div>
        </div>

        {/* ========== بطاقة حالة الترخيص ========== */}
        {restaurant?.commercialLicenseUrl ? (
          <div className={`rounded-2xl p-4 border-2 ${
            restaurant.licenseStatus === 'approved' ? 'bg-green-50 border-green-200' :
            restaurant.licenseStatus === 'rejected' ? 'bg-red-50 border-red-200' :
            'bg-yellow-50 border-yellow-200'
          }`}>
            <div className="flex items-center gap-3">
              <div className={`w-12 h-12 rounded-xl flex items-center justify-center ${
                restaurant.licenseStatus === 'approved' ? 'bg-green-500' :
                restaurant.licenseStatus === 'rejected' ? 'bg-red-500' :
                'bg-yellow-500'
              }`}>
                <Shield className="w-6 h-6 text-white" />
              </div>
              <div className="flex-1">
                <h3 className={`font-bold ${
                  restaurant.licenseStatus === 'approved' ? 'text-green-700' :
                  restaurant.licenseStatus === 'rejected' ? 'text-red-700' :
                  'text-yellow-700'
                }`}>
                  {restaurant.licenseStatus === 'approved' && ' الترخيص مُعتمد'}
                  {restaurant.licenseStatus === 'rejected' && ' الترخيص مرفوض'}
                  {(!restaurant.licenseStatus || restaurant.licenseStatus === 'pending') && ' الترخيص قيد المراجعة'}
                </h3>
                {restaurant.licenseStatus === 'rejected' && restaurant.licenseNotes && (
                  <p className="text-sm text-red-600">{restaurant.licenseNotes}</p>
                )}
              </div>
              {restaurant.licenseStatus === 'rejected' && (
                <Link to="/owner/edit" className="text-red-600 text-sm font-bold underline">
                  إعادة الرفع
                </Link>
              )}
            </div>
          </div>
        ) : (
          <Link 
            to="/owner/edit"
            className="block bg-gradient-to-r from-orange-50 to-amber-50 border-2 border-orange-200 rounded-2xl p-4 hover:shadow-lg transition"
          >
            <div className="flex items-center gap-3">
              <div className="w-12 h-12 bg-orange-500 rounded-xl flex items-center justify-center flex-shrink-0">
                <Shield className="w-6 h-6 text-white" />
              </div>
              <div className="flex-1">
                <h3 className="font-bold text-orange-700"> ارفع ترخيصك التجاري</h3>
                <p className="text-sm text-orange-600">لتفعيل متجرك بالكامل</p>
              </div>
            </div>
          </Link>
        )}

        {/* ========== نظام النقاط والتقييم ========== */}
        {restaurant?.points && (
          <div className={`rounded-2xl p-4 border-2 ${
            restaurant.points.isSuspended 
              ? 'bg-red-50 border-red-300' 
              : restaurant.points.currentPoints < POINTS_CONFIG.WARNING_THRESHOLD
              ? 'bg-amber-50 border-amber-300'
              : 'bg-sky-50 border-sky-200'
          }`}>
            <div className="flex items-center gap-3 mb-3">
              <div className={`w-10 h-10 rounded-xl flex items-center justify-center ${
                restaurant.points.isSuspended 
                  ? 'bg-red-500' 
                  : restaurant.points.currentPoints < POINTS_CONFIG.WARNING_THRESHOLD
                  ? 'bg-amber-500'
                  : 'bg-sky-500'
              }`}>
                <Shield className="w-5 h-5 text-white" />
              </div>
              <div className="flex-1">
                <h3 className={`font-bold ${
                  restaurant.points.isSuspended 
                    ? 'text-red-700' 
                    : restaurant.points.currentPoints < POINTS_CONFIG.WARNING_THRESHOLD
                    ? 'text-amber-700'
                    : 'text-sky-700'
                }`}>
                  {restaurant.points.isSuspended ? ' حسابك موقوف!' : ' رصيد النقاط'}
                </h3>
              </div>
            </div>
            
            <div className="flex items-center justify-between">
              <div className="flex items-center gap-4">
                <div className={`text-3xl font-bold ${
                  restaurant.points.isSuspended 
                    ? 'text-red-600' 
                    : restaurant.points.currentPoints < POINTS_CONFIG.WARNING_THRESHOLD
                    ? 'text-amber-600'
                    : 'text-sky-600'
                }`}>
                  {restaurant.points.currentPoints}
                </div>
                <div className="text-sm text-gray-500">
                  / {POINTS_CONFIG.STARTING_POINTS} نقطة
                </div>
              </div>
              
              {/* شريط التقدم */}
              <div className="flex-1 max-w-[150px] mr-4">
                <div className="h-3 bg-gray-200 rounded-full overflow-hidden">
                  <div 
                    className={`h-full rounded-full transition-all ${
                      restaurant.points.isSuspended 
                        ? 'bg-red-500' 
                        : restaurant.points.currentPoints < POINTS_CONFIG.WARNING_THRESHOLD
                        ? 'bg-amber-500'
                        : 'bg-sky-500'
                    }`}
                    style={{ width: `${Math.min(100, restaurant.points.currentPoints)}%` }}
                  />
                </div>
              </div>
            </div>
            
            {restaurant.points.isSuspended && (
              <div className="mt-3 bg-red-100 rounded-xl p-3">
                <p className="text-sm text-red-700">
                   حسابك موقوف بسبب انخفاض النقاط. تواصل مع الدعم الفني لإعادة تفعيله.
                </p>
                <Link 
                  to="/support" 
                  className="inline-block mt-2 text-red-600 font-bold underline text-sm"
                >
                  تواصل مع الدعم ←
                </Link>
              </div>
            )}
            
            {!restaurant.points.isSuspended && restaurant.points.currentPoints < POINTS_CONFIG.WARNING_THRESHOLD && (
              <div className="mt-3 bg-amber-100 rounded-xl p-3">
                <p className="text-sm text-amber-700">
                   تنبيه: نقاطك منخفضة! حافظ على جودة الخدمة لتجنب الإيقاف.
                </p>
              </div>
            )}
          </div>
        )}

        {/* ========== ملخص الأرباح ========== */}
        <div className="bg-gradient-to-br from-green-50 to-emerald-50 rounded-2xl p-4 border-2 border-green-200">
          <div className="flex items-center gap-3 mb-3">
            <div className="w-10 h-10 bg-green-500 rounded-xl flex items-center justify-center">
              <Wallet className="w-5 h-5 text-white" />
            </div>
            <h3 className="font-bold text-green-700"> ملخص الأرباح</h3>
          </div>
          <div className="grid grid-cols-2 gap-3">
            <div className="bg-white rounded-xl p-3 text-center">
              <p className="text-2xl font-bold text-green-600">{stats.totalRevenue.toFixed(0)}</p>
              <p className="text-xs text-gray-500">إجمالي المبيعات (ر.س)</p>
            </div>
            <div className="bg-white rounded-xl p-3 text-center">
              <p className="text-2xl font-bold text-emerald-600">{netProfit.toFixed(0)}</p>
              <p className="text-xs text-gray-500">صافي الأرباح (ر.س)</p>
            </div>
          </div>
          <p className="text-xs text-gray-500 text-center mt-2">
            * بعد خصم رسوم المنصة (3.75 ر.س لكل طلب)
          </p>
        </div>

        {/* دعوة للاشتراك في الباقة */}
        <div className="bg-gradient-to-br from-amber-500 via-orange-500 to-red-500 rounded-3xl shadow-2xl p-6 text-white relative overflow-hidden">
          <div className="absolute inset-0 opacity-10">
            <div className="absolute top-0 right-0 w-64 h-64 bg-white rounded-full -translate-y-1/2 translate-x-1/2" />
          </div>
          
          <div className="relative z-10 text-center py-6">
            <div className="w-20 h-20 bg-white/20 rounded-full flex items-center justify-center mx-auto mb-4">
              <Crown className="w-10 h-10 text-yellow-300" />
            </div>
            <h2 className="text-2xl font-bold mb-2"> اشترك في الباقة المميزة</h2>
            <p className="text-white/80 mb-4">
              احصل على لوحة تحكم احترافية مع إحصائيات مفصّلة ومزايا حصرية!
            </p>
            <Link
              to="/owner/packages"
              className="inline-flex items-center gap-2 bg-white text-amber-600 font-bold px-6 py-3 rounded-xl hover:bg-yellow-50 transition shadow-lg"
            >
              <Sparkles className="w-5 h-5" />
              اكتشف الباقات الآن
            </Link>
          </div>
        </div>

        {/* تنبيه الحساب البنكي */}
        {!restaurant?.bankName && (
          <Link 
            to="/owner/edit#bank"
            className="block bg-gradient-to-r from-red-50 to-orange-50 border-2 border-red-200 rounded-2xl p-4 hover:shadow-lg transition"
          >
            <div className="flex items-center gap-3">
              <div className="w-12 h-12 bg-red-500 rounded-xl flex items-center justify-center flex-shrink-0">
                <Building2 className="w-6 h-6 text-white" />
              </div>
              <div className="flex-1">
                <h3 className="font-bold text-red-700"> أضف حسابك البنكي!</h3>
                <p className="text-sm text-red-600">لتتمكن من استلام التحويلات من العملاء</p>
              </div>
            </div>
          </Link>
        )}

        {/* تنبيه الطلبات الجديدة */}
        {stats.pendingOrders > 0 && (
          <Link 
            to="/owner/orders"
            className="block bg-gradient-to-r from-yellow-50 to-amber-50 border-2 border-yellow-300 rounded-2xl p-4 hover:shadow-lg transition animate-pulse"
          >
            <div className="flex items-center gap-3">
              <div className="w-12 h-12 bg-yellow-500 rounded-xl flex items-center justify-center flex-shrink-0">
                <ShoppingBag className="w-6 h-6 text-white" />
              </div>
              <div className="flex-1">
                <h3 className="font-bold text-yellow-700"> لديك {stats.pendingOrders} طلب بانتظار القبول!</h3>
                <p className="text-sm text-yellow-600">اضغط للذهاب إلى الطلبات</p>
              </div>
            </div>
          </Link>
        )}

        {/* الروابط الأساسية */}
        <div className="grid grid-cols-1 sm:grid-cols-2 gap-4">
          <Link
            to="/owner/packages"
            className="rounded-2xl shadow-lg hover:shadow-2xl transition transform hover:-translate-y-1 bg-gradient-to-br from-amber-50 via-yellow-50 to-orange-50 p-5 ring-2 ring-amber-300 relative overflow-hidden"
          >
            <div className="absolute top-0 left-0 right-0 bg-gradient-to-r from-amber-500 via-yellow-400 to-orange-500 py-1.5 text-center">
              <div className="flex items-center justify-center gap-2 text-white text-sm font-bold">
                <Sparkles className="w-4 h-4" />
                <span>اكتشف الباقات</span>
                <Sparkles className="w-4 h-4" />
              </div>
            </div>
            <div className="h-6" />
            <div className="flex items-center gap-3 mb-3">
              <Crown className="w-8 h-8 text-amber-500" />
              <h3 className="text-lg font-extrabold text-gray-900">باقات سفرة البيت</h3>
            </div>
            <p className="text-sm text-gray-600">اختر الباقة المناسبة واحصل على مزايا حصرية!</p>
          </Link>

          <Link to="/owner/menu" className="rounded-2xl shadow-lg hover:shadow-2xl transition transform hover:-translate-y-1 bg-gradient-to-br from-yellow-50 to-white p-5">
            <div className="flex items-center gap-3 mb-3">
              <Utensils className="w-8 h-8 text-yellow-500" />
              <h3 className="text-lg font-extrabold text-gray-900">إدارة القائمة</h3>
            </div>
            <p className="text-sm text-gray-600">إضافة وتعديل الأصناف والوجبات.</p>
          </Link>

          <Link to="/owner/orders" className="rounded-2xl shadow-lg hover:shadow-2xl transition transform hover:-translate-y-1 bg-gradient-to-br from-green-50 to-white p-5">
            <div className="flex items-center gap-3 mb-3">
              <ClipboardList className="w-8 h-8 text-green-500" />
              <h3 className="text-lg font-extrabold text-gray-900">إدارة الطلبات</h3>
            </div>
            <p className="text-sm text-gray-600">قبول الطلبات وتعيين المندوب.</p>
            {stats.pendingOrders > 0 && (
              <span className="bg-red-500 text-white px-3 py-1 rounded-full text-xs font-bold mt-2 inline-block">
                {stats.pendingOrders} جديد!
              </span>
            )}
          </Link>

          <Link to="/owner/edit" className="rounded-2xl shadow-lg hover:shadow-2xl transition transform hover:-translate-y-1 bg-gradient-to-br from-blue-50 to-white p-5">
            <div className="flex items-center gap-3 mb-3">
              <Settings className="w-8 h-8 text-blue-500" />
              <h3 className="text-lg font-extrabold text-gray-900">الإعدادات</h3>
            </div>
            <p className="text-sm text-gray-600">تعديل بيانات المتجر.</p>
          </Link>
        </div>

        {/* مزايا الباقة المميزة */}
        <div className="bg-gradient-to-br from-gray-900 to-gray-800 rounded-2xl shadow-lg p-6 text-white">
          <div className="flex items-center gap-2 mb-4">
            <Crown className="w-6 h-6 text-amber-400" />
            <h3 className="text-lg font-bold"> مزايا الباقة المميزة</h3>
          </div>
          
          <div className="grid grid-cols-2 gap-3 mb-4">
            <div className="flex items-center gap-2 text-gray-300 text-sm">
              <BarChart3 className="w-4 h-4 text-green-400" />
              <span>إحصائيات مالية مفصّلة</span>
            </div>
            <div className="flex items-center gap-2 text-gray-300 text-sm">
              <Star className="w-4 h-4 text-yellow-400" />
              <span>أكثر الأصناف مبيعاً</span>
            </div>
            <div className="flex items-center gap-2 text-gray-300 text-sm">
              <Megaphone className="w-4 h-4 text-purple-400" />
              <span>إعلانات ممولة مجانية</span>
            </div>
            <div className="flex items-center gap-2 text-gray-300 text-sm">
              <Shield className="w-4 h-4 text-blue-400" />
              <span>شارة التوثيق المميزة</span>
            </div>
          </div>

          <Link
            to="/owner/packages"
            className="block w-full text-center bg-gradient-to-r from-amber-500 to-orange-500 text-white font-bold py-3 rounded-xl hover:from-amber-600 hover:to-orange-600 transition"
          >
             اشترك الآن
          </Link>
        </div>
      </div>
    )
  }

  // ===== صفحة الباقة المميزة (المتجر الاحترافي الكامل) =====
  return (
    <div className="space-y-6 pb-24 -mx-4 -mt-4">
      
      {/* ========== الهيدر الاحترافي ========== */}
      <div className="relative">
        {/* الغلاف */}
        <div className="h-40 sm:h-48 bg-gradient-to-br from-gray-900 via-gray-800 to-black relative overflow-hidden">
          <div className="absolute inset-0">
            <div className="absolute top-0 right-0 w-96 h-96 bg-amber-500/20 rounded-full blur-3xl -translate-y-1/2 translate-x-1/2" />
            <div className="absolute bottom-0 left-0 w-64 h-64 bg-purple-500/20 rounded-full blur-3xl translate-y-1/2 -translate-x-1/2" />
          </div>
          
          {/* زر التحديث */}
          <button
            onClick={handleRefresh}
            disabled={refreshing}
            className="absolute top-4 left-4 p-2 bg-white/10 hover:bg-white/20 rounded-xl transition z-10"
          >
            <RefreshCw className={`w-5 h-5 text-white ${refreshing ? 'animate-spin' : ''}`} />
          </button>

          {/* شارة الباقة */}
          <div className="absolute top-4 right-4 z-10">
            <div className="bg-gradient-to-r from-amber-500 to-orange-500 px-4 py-1.5 rounded-full flex items-center gap-2 shadow-lg">
              <Crown className="w-4 h-4 text-white" />
              <span className="text-white font-bold text-sm">باقة مميزة</span>
            </div>
          </div>
        </div>

        {/* معلومات المتجر */}
        <div className="relative px-4 -mt-16">
          <div className="bg-white rounded-3xl shadow-xl p-5">
            <div className="flex items-start gap-4">
              {/* الشعار */}
              <div className="relative -mt-12">
                <div className="w-24 h-24 rounded-2xl bg-white shadow-xl overflow-hidden border-4 border-white">
                  {restaurant?.logoUrl ? (
                    <img src={restaurant.logoUrl} alt={restaurant.name} className="w-full h-full object-cover" />
                  ) : (
                    <div className="w-full h-full bg-gradient-to-br from-amber-100 to-orange-100 flex items-center justify-center">
                      <Store className="w-10 h-10 text-amber-500" />
                    </div>
                  )}
                </div>
                {restaurant?.isVerified && (
                  <div className="absolute -bottom-1 -right-1 w-7 h-7 bg-blue-500 rounded-full flex items-center justify-center border-2 border-white">
                    <CheckCircle className="w-4 h-4 text-white" />
                  </div>
                )}
              </div>

              {/* المعلومات */}
              <div className="flex-1 pt-2">
                <div className="flex items-center gap-2 flex-wrap">
                  <h1 className="text-xl font-bold text-gray-900">{restaurant?.name || 'متجري'}</h1>
                  <span className={`px-2 py-0.5 rounded-full text-xs font-bold text-white bg-gradient-to-r ${tier.color}`}>
                    {tier.icon} {tier.label}
                  </span>
                </div>
                
                {restaurant?.city && (
                  <p className="text-gray-500 text-sm flex items-center gap-1 mt-1">
                    <MapPin className="w-3 h-3" />
                    {restaurant.city}
                  </p>
                )}

                {/* إحصائيات سريعة */}
                <div className="flex items-center gap-4 mt-3">
                  <div className="flex items-center gap-1 text-sm">
                    <Star className="w-4 h-4 text-amber-500 fill-amber-500" />
                    <span className="font-bold">{stats.averageRating.toFixed(1)}</span>
                  </div>
                  <div className="text-gray-300">|</div>
                  <div className="text-sm text-gray-600">
                    <span className="font-bold text-gray-900">{stats.totalOrders}</span> طلب
                  </div>
                  <div className="text-gray-300">|</div>
                  <div className="text-sm text-gray-600">
                    <span className="font-bold text-gray-900">{stats.menuItems}</span> صنف
                  </div>
                </div>
              </div>
            </div>

            {/* أزرار سريعة */}
            <div className="flex gap-2 mt-4 overflow-x-auto pb-2 -mx-2 px-2">
              <Link to={`/menu?restaurant=${user?.uid}`} className="flex items-center gap-2 bg-gray-100 hover:bg-gray-200 px-4 py-2 rounded-xl text-sm font-semibold whitespace-nowrap">
                <Eye className="w-4 h-4" />
                معاينة المتجر
              </Link>
              <Link to="/owner/edit" className="flex items-center gap-2 bg-gray-100 hover:bg-gray-200 px-4 py-2 rounded-xl text-sm font-semibold whitespace-nowrap">
                <Edit3 className="w-4 h-4" />
                تعديل
              </Link>
              <Link to="/owner/promotion" className="flex items-center gap-2 bg-purple-100 hover:bg-purple-200 text-purple-700 px-4 py-2 rounded-xl text-sm font-semibold whitespace-nowrap">
                <Megaphone className="w-4 h-4" />
                إعلان جديد
              </Link>
            </div>
          </div>
        </div>
      </div>

      {/* ========== التنبيهات ========== */}
      <div className="px-4 space-y-3">
        {/* تنبيه انتهاء الاشتراك */}
        {(isExpired || isExpiringSoon) && (
          <Link 
            to="/owner/packages"
            className={`block rounded-2xl p-4 shadow-lg ${
              isExpired 
                ? 'bg-gradient-to-r from-red-600 to-red-500 text-white' 
                : 'bg-gradient-to-r from-amber-500 to-orange-500 text-white'
            }`}
          >
            <div className="flex items-center gap-3">
              <div className="w-12 h-12 bg-white/20 rounded-xl flex items-center justify-center">
                <Crown className="w-6 h-6" />
              </div>
              <div className="flex-1">
                {isExpired ? (
                  <>
                    <h3 className="font-bold text-lg"> انتهت صلاحية اشتراكك!</h3>
                    <p className="text-white/80 text-sm">جدّد الآن للحفاظ على المزايا</p>
                  </>
                ) : (
                  <>
                    <h3 className="font-bold text-lg"> باقي {daysRemaining} يوم على انتهاء اشتراكك</h3>
                    <p className="text-white/80 text-sm">جدّد مبكراً واستمتع بالمزايا</p>
                  </>
                )}
              </div>
              <ArrowRight className="w-6 h-6" />
            </div>
          </Link>
        )}

        {/* حالة الترخيص */}
        {restaurant?.commercialLicenseUrl && restaurant.licenseStatus !== 'approved' && (
          <div className={`rounded-2xl p-4 ${
            restaurant.licenseStatus === 'rejected' 
              ? 'bg-red-50 border border-red-200' 
              : 'bg-yellow-50 border border-yellow-200'
          }`}>
            <div className="flex items-center gap-3">
              <div className={`w-10 h-10 rounded-xl flex items-center justify-center ${
                restaurant.licenseStatus === 'rejected' ? 'bg-red-500' : 'bg-yellow-500'
              }`}>
                <Shield className="w-5 h-5 text-white" />
              </div>
              <div className="flex-1">
                {restaurant.licenseStatus === 'rejected' ? (
                  <>
                    <h3 className="font-bold text-red-700"> تم رفض الترخيص</h3>
                    <p className="text-sm text-red-600">{restaurant.licenseNotes || 'يرجى رفع ترخيص صالح'}</p>
                  </>
                ) : (
                  <>
                    <h3 className="font-bold text-yellow-700"> الترخيص قيد المراجعة</h3>
                    <p className="text-sm text-yellow-600">سيتم إشعارك بالنتيجة قريباً</p>
                  </>
                )}
              </div>
              {restaurant.licenseStatus === 'rejected' && (
                <Link to="/owner/edit" className="text-red-600 text-sm font-bold underline">
                  إعادة الرفع
                </Link>
              )}
            </div>
          </div>
        )}

        {/* تنبيه الطلبات الجديدة */}
        {stats.pendingOrders > 0 && (
          <Link 
            to="/owner/orders"
            className="block bg-gradient-to-r from-red-500 to-orange-500 rounded-2xl p-4 text-white shadow-lg animate-pulse"
          >
            <div className="flex items-center gap-3">
              <div className="w-12 h-12 bg-white/20 rounded-xl flex items-center justify-center">
                <Bell className="w-6 h-6" />
              </div>
              <div className="flex-1">
                <h3 className="font-bold text-lg"> {stats.pendingOrders} طلب جديد!</h3>
                <p className="text-white/80 text-sm">اضغط للقبول الآن</p>
              </div>
              <ArrowRight className="w-6 h-6" />
            </div>
          </Link>
        )}

        {/* تنبيه الحساب البنكي */}
        {!restaurant?.bankName && (
          <Link 
            to="/owner/edit#bank"
            className="block bg-gradient-to-r from-amber-50 to-orange-50 border border-amber-200 rounded-2xl p-4"
          >
            <div className="flex items-center gap-3">
              <div className="w-10 h-10 bg-amber-500 rounded-xl flex items-center justify-center">
                <Building2 className="w-5 h-5 text-white" />
              </div>
              <div className="flex-1">
                <h3 className="font-bold text-amber-700">أضف حسابك البنكي</h3>
                <p className="text-sm text-amber-600">لاستلام التحويلات من العملاء</p>
              </div>
            </div>
          </Link>
        )}
      </div>

      {/* ========== انشري متجرك ========== */}
      <div className="px-4">
        <div className="bg-gradient-to-br from-purple-600 via-pink-600 to-rose-500 rounded-2xl p-5 text-white shadow-xl relative overflow-hidden">
          {/* خلفية زخرفية */}
          <div className="absolute inset-0 opacity-20">
            <div className="absolute top-0 right-0 w-32 h-32 bg-white rounded-full -translate-y-1/2 translate-x-1/2" />
            <div className="absolute bottom-0 left-0 w-24 h-24 bg-white rounded-full translate-y-1/2 -translate-x-1/2" />
          </div>

          <div className="relative z-10">
            <div className="flex items-center gap-2 mb-3">
              <Share2 className="w-6 h-6" />
              <h2 className="text-lg font-bold"> انشري متجرك!</h2>
            </div>
            
            <p className="text-white/80 text-sm mb-4">
              شاركي رابط متجرك مع العملاء عبر واتساب، تويتر، انستقرام أو أي منصة!
            </p>

            {/* رابط المتجر */}
            <div className="bg-white/10 backdrop-blur rounded-xl p-3 mb-4">
              <p className="text-white/60 text-xs mb-1">رابط متجرك الخاص:</p>
              <div className="flex items-center gap-2">
                <div className="flex-1 bg-white/10 rounded-lg p-2 text-sm font-mono truncate" dir="ltr">
                  {window.location.origin}/menu?restaurant={user?.uid}
                </div>
                <button
                  onClick={copyStoreLink}
                  className={`p-2 rounded-lg transition ${copied ? 'bg-green-500' : 'bg-white/20 hover:bg-white/30'}`}
                >
                  {copied ? <CheckCircle className="w-5 h-5" /> : <Copy className="w-5 h-5" />}
                </button>
              </div>
            </div>

            {/* أزرار المشاركة */}
            <div className="flex gap-2">
              {/* زر واتساب */}
              <button
                onClick={shareToWhatsapp}
                className="flex-1 flex items-center justify-center gap-2 bg-green-500 hover:bg-green-600 text-white font-bold py-3 rounded-xl transition"
              >
                [REDACTED_SVG_BLOCK]
                واتساب
              </button>
              <button
                onClick={shareStore}
                className="flex-1 flex items-center justify-center gap-2 bg-white text-purple-600 font-bold py-3 rounded-xl hover:bg-purple-50 transition"
              >
                <Share2 className="w-5 h-5" />
                مشاركة
              </button>
              <Link
                to={`/menu?restaurant=${user?.uid}`}
                className="flex items-center justify-center gap-2 bg-white/20 hover:bg-white/30 px-4 py-3 rounded-xl transition"
              >
                <Eye className="w-5 h-5" />
                معاينة
              </Link>
            </div>

            {/* إحصائيات المشاركة والزيارات */}
            <div className="grid grid-cols-5 gap-2 mt-4 pt-4 border-t border-white/20">
              <div className="text-center">
                <p className="text-xl font-bold">{stats.followersCount}</p>
                <p className="text-white/70 text-[10px]">متابع </p>
              </div>
              <div className="text-center">
                <p className="text-xl font-bold">{stats.todayViews}</p>
                <p className="text-white/70 text-[10px]">زيارات اليوم</p>
              </div>
              <div className="text-center">
                <p className="text-xl font-bold">{stats.profileViews}</p>
                <p className="text-white/70 text-[10px]">مشاهدة صفحة</p>
              </div>
              <div className="text-center">
                <p className="text-xl font-bold">{stats.whatsappShares}</p>
                <p className="text-white/70 text-[10px]">مشاركة واتس</p>
              </div>
              <div className="text-center">
                <p className="text-xl font-bold">{stats.registeredViaLink}</p>
                <p className="text-white/70 text-[10px]">تسجيل عبرك</p>
              </div>
            </div>

            {/* إحصائيات إضافية */}
            <div className="grid grid-cols-3 gap-2 mt-2 pt-2 border-t border-white/20">
              <div className="text-center">
                <p className="text-2xl font-bold">{stats.uniqueCustomers}</p>
                <p className="text-white/70 text-xs">عميل</p>
              </div>
              <div className="text-center">
                <p className="text-2xl font-bold">{stats.totalViews}</p>
                <p className="text-white/70 text-xs">مشاهدة</p>
              </div>
              <div className="text-center">
                <p className="text-2xl font-bold">{stats.totalOrders}</p>
                <p className="text-white/70 text-xs">طلب</p>
              </div>
            </div>
          </div>
        </div>
      </div>

      {/* ========== الإحصائيات المالية ========== */}
      <div className="px-4">
        <div className="bg-gradient-to-br from-green-600 to-emerald-700 rounded-2xl p-5 text-white shadow-xl">
          <div className="flex items-center justify-between mb-4">
            <div className="flex items-center gap-2">
              <Wallet className="w-6 h-6" />
              <h2 className="text-lg font-bold"> الإيرادات</h2>
            </div>
            <Link to="/owner/orders" className="text-white/80 text-sm hover:text-white">
              عرض التفاصيل ←
            </Link>
          </div>

          <div className="grid grid-cols-2 gap-3">
            <div className="bg-white/10 backdrop-blur rounded-xl p-4">
              <p className="text-white/70 text-sm mb-1">اليوم</p>
              <p className="text-2xl font-bold">{stats.todayRevenue.toFixed(0)} <span className="text-sm">ر.س</span></p>
              <p className="text-white/60 text-xs mt-1">{stats.todayOrders} طلب</p>
            </div>
            <div className="bg-white/10 backdrop-blur rounded-xl p-4">
              <p className="text-white/70 text-sm mb-1">الأسبوع</p>
              <p className="text-2xl font-bold">{stats.weekRevenue.toFixed(0)} <span className="text-sm">ر.س</span></p>
              <p className="text-white/60 text-xs mt-1">{stats.weekOrders} طلب</p>
            </div>
            <div className="bg-white/10 backdrop-blur rounded-xl p-4">
              <p className="text-white/70 text-sm mb-1">الشهر</p>
              <p className="text-2xl font-bold">{stats.monthRevenue.toFixed(0)} <span className="text-sm">ر.س</span></p>
              <p className="text-white/60 text-xs mt-1">{stats.monthOrders} طلب</p>
            </div>
            <div className="bg-white/20 backdrop-blur rounded-xl p-4 ring-2 ring-white/30">
              <p className="text-white/70 text-sm mb-1">الإجمالي</p>
              <p className="text-2xl font-bold">{stats.totalRevenue.toFixed(0)} <span className="text-sm">ر.س</span></p>
              <p className="text-white/60 text-xs mt-1">{stats.deliveredOrders} مكتمل</p>
            </div>
          </div>
        </div>
      </div>

      {/* ========== تقرير صافي الأرباح ========== */}
      <div className="px-4">
        <div className="bg-white rounded-2xl shadow-xl p-5 border border-gray-100">
          <div className="flex items-center gap-2 mb-4">
            <TrendingUp className="w-6 h-6 text-green-600" />
            <h2 className="text-lg font-bold text-gray-900"> تقرير صافي الأرباح</h2>
          </div>

          <div className="space-y-3">
            {/* إجمالي المبيعات */}
            <div className="flex items-center justify-between py-2 border-b border-gray-100">
              <span className="text-gray-600">إجمالي المبيعات</span>
              <span className="font-bold text-gray-900">{stats.totalRevenue.toFixed(2)} ر.س</span>
            </div>

            {/* رسوم المنصة */}
            <div className="flex items-center justify-between py-2 border-b border-gray-100">
              <div>
                <span className="text-gray-600">رسوم المنصة</span>
                <p className="text-xs text-gray-400">({stats.deliveredOrders} طلب × 3.75 ر.س)</p>
              </div>
              <span className="font-bold text-red-600">- {(stats.deliveredOrders * 3.75).toFixed(2)} ر.س</span>
            </div>

            {/* صافي الأرباح */}
            <div className="flex items-center justify-between py-3 bg-gradient-to-r from-green-50 to-emerald-50 rounded-xl px-3">
              <div className="flex items-center gap-2">
                <div className="w-10 h-10 bg-green-500 rounded-xl flex items-center justify-center">
                  <Wallet className="w-5 h-5 text-white" />
                </div>
                <span className="font-bold text-green-800">صافي الأرباح</span>
              </div>
              <span className="text-2xl font-bold text-green-600">{netProfit.toFixed(2)} ر.س</span>
            </div>
          </div>

          {/* نسبة الربح */}
          <div className="mt-4 pt-4 border-t border-gray-100">
            <div className="flex items-center justify-between text-sm">
              <span className="text-gray-500">نسبة صافي الربح</span>
              <span className={`font-bold ${netProfit >= 0 ? 'text-green-600' : 'text-red-600'}`}>
                {stats.totalRevenue > 0 ? ((netProfit / stats.totalRevenue) * 100).toFixed(1) : 0}%
              </span>
            </div>
            <div className="mt-2 h-2 bg-gray-200 rounded-full overflow-hidden">
              <div 
                className="h-full bg-gradient-to-r from-green-500 to-emerald-500 rounded-full transition-all duration-500"
                style={{ width: `${stats.totalRevenue > 0 ? Math.max(0, (netProfit / stats.totalRevenue) * 100) : 0}%` }}
              />
            </div>
          </div>
        </div>
      </div>

      {/* ========== لوحة التحكم السريعة ========== */}
      <div className="px-4">
        <h2 className="text-lg font-bold text-gray-900 mb-3"> تحكم سريع</h2>
        <div className="grid grid-cols-2 gap-3">
          {/* إدارة الطلبات */}
          <Link 
            to="/owner/orders"
            className="bg-white rounded-2xl shadow-lg p-4 hover:shadow-xl transition border border-gray-100"
          >
            <div className="w-12 h-12 bg-gradient-to-br from-blue-500 to-blue-600 rounded-xl flex items-center justify-center mb-3">
              <ClipboardList className="w-6 h-6 text-white" />
            </div>
            <h3 className="font-bold text-gray-900">الطلبات</h3>
            <div className="flex items-center gap-2 mt-2">
              <span className="bg-yellow-100 text-yellow-700 px-2 py-0.5 rounded-full text-xs font-bold">
                {stats.pendingOrders} جديد
              </span>
              <span className="bg-orange-100 text-orange-700 px-2 py-0.5 rounded-full text-xs font-bold">
                {stats.preparingOrders} تحضير
              </span>
            </div>
          </Link>

          {/* إدارة القائمة */}
          <Link 
            to="/owner/menu"
            className="bg-white rounded-2xl shadow-lg p-4 hover:shadow-xl transition border border-gray-100"
          >
            <div className="w-12 h-12 bg-gradient-to-br from-amber-500 to-orange-500 rounded-xl flex items-center justify-center mb-3">
              <Utensils className="w-6 h-6 text-white" />
            </div>
            <h3 className="font-bold text-gray-900">القائمة</h3>
            <div className="flex items-center gap-2 mt-2">
              <span className="bg-green-100 text-green-700 px-2 py-0.5 rounded-full text-xs font-bold">
                {stats.availableItems} متاح
              </span>
              <span className="bg-gray-100 text-gray-700 px-2 py-0.5 rounded-full text-xs font-bold">
                {stats.menuItems} إجمالي
              </span>
            </div>
          </Link>

          {/* الإعلانات */}
          <Link 
            to="/owner/promotion"
            className="bg-white rounded-2xl shadow-lg p-4 hover:shadow-xl transition border border-gray-100"
          >
            <div className="w-12 h-12 bg-gradient-to-br from-purple-500 to-pink-500 rounded-xl flex items-center justify-center mb-3">
              <Megaphone className="w-6 h-6 text-white" />
            </div>
            <h3 className="font-bold text-gray-900">الإعلانات</h3>
            <div className="flex items-center gap-2 mt-2">
              <span className="bg-purple-100 text-purple-700 px-2 py-0.5 rounded-full text-xs font-bold">
                {stats.activePromotions} نشط
              </span>
              <span className="bg-blue-100 text-blue-700 px-2 py-0.5 rounded-full text-xs font-bold flex items-center gap-1">
                <Eye className="w-3 h-3" />
                {stats.totalViews}
              </span>
            </div>
          </Link>

          {/* الإعدادات */}
          <Link 
            to="/owner/edit"
            className="bg-white rounded-2xl shadow-lg p-4 hover:shadow-xl transition border border-gray-100"
          >
            <div className="w-12 h-12 bg-gradient-to-br from-gray-600 to-gray-700 rounded-xl flex items-center justify-center mb-3">
              <Settings className="w-6 h-6 text-white" />
            </div>
            <h3 className="font-bold text-gray-900">الإعدادات</h3>
            <p className="text-gray-500 text-xs mt-2">تعديل بيانات المتجر</p>
          </Link>
        </div>
      </div>

      {/* ========== حالة الطلبات ========== */}
      <div className="px-4">
        <h2 className="text-lg font-bold text-gray-900 mb-3"> حالة الطلبات</h2>
        <div className="bg-white rounded-2xl shadow-lg p-4 border border-gray-100">
          <div className="grid grid-cols-4 gap-2">
            <Link to="/owner/orders?status=pending" className="text-center p-3 bg-yellow-50 rounded-xl hover:bg-yellow-100 transition">
              <Clock className="w-6 h-6 text-yellow-500 mx-auto mb-1" />
              <p className="text-lg font-bold text-yellow-700">{stats.pendingOrders}</p>
              <p className="text-xs text-yellow-600">جديد</p>
            </Link>
            <Link to="/owner/orders?status=preparing" className="text-center p-3 bg-orange-50 rounded-xl hover:bg-orange-100 transition">
              <ChefHat className="w-6 h-6 text-orange-500 mx-auto mb-1" />
              <p className="text-lg font-bold text-orange-700">{stats.preparingOrders}</p>
              <p className="text-xs text-orange-600">تحضير</p>
            </Link>
            <Link to="/owner/orders?status=delivered" className="text-center p-3 bg-green-50 rounded-xl hover:bg-green-100 transition">
              <CheckCircle className="w-6 h-6 text-green-500 mx-auto mb-1" />
              <p className="text-lg font-bold text-green-700">{stats.deliveredOrders}</p>
              <p className="text-xs text-green-600">مكتمل</p>
            </Link>
            <Link to="/owner/orders?status=cancelled" className="text-center p-3 bg-red-50 rounded-xl hover:bg-red-100 transition">
              <AlertCircle className="w-6 h-6 text-red-500 mx-auto mb-1" />
              <p className="text-lg font-bold text-red-700">{stats.cancelledOrders}</p>
              <p className="text-xs text-red-600">ملغي</p>
            </Link>
          </div>
        </div>
      </div>

      {/* ========== أكثر الأصناف مبيعاً ========== */}
      {topItems.length > 0 && (
        <div className="px-4">
          <div className="flex items-center justify-between mb-3">
            <h2 className="text-lg font-bold text-gray-900"> الأكثر مبيعاً</h2>
            <Link to="/owner/menu" className="text-amber-600 text-sm font-semibold">عرض الكل ←</Link>
          </div>
          <div className="bg-white rounded-2xl shadow-lg overflow-hidden border border-gray-100">
            {topItems.map((item, i) => (
              <div key={i} className={`flex items-center gap-3 p-4 ${i !== topItems.length - 1 ? 'border-b' : ''}`}>
                <span className="text-2xl w-8">
                  {i === 0 ? '' : i === 1 ? '' : i === 2 ? '' : `#${i + 1}`}
                </span>
                <div className="flex-1">
                  <p className="font-semibold text-gray-900">{item.name}</p>
                </div>
                <div className="bg-amber-100 text-amber-700 px-3 py-1 rounded-full text-sm font-bold">
                  {item.count} مبيعات
                </div>
              </div>
            ))}
          </div>
        </div>
      )}

      {/* ========== آخر الطلبات ========== */}
      {recentOrders.length > 0 && (
        <div className="px-4">
          <div className="flex items-center justify-between mb-3">
            <h2 className="text-lg font-bold text-gray-900"> آخر الطلبات</h2>
            <Link to="/owner/orders" className="text-blue-600 text-sm font-semibold">عرض الكل ←</Link>
          </div>
          <div className="bg-white rounded-2xl shadow-lg overflow-hidden border border-gray-100">
            {recentOrders.map((order, i) => {
              const statusInfo = getStatusInfo(order.status)
              const StatusIcon = statusInfo.icon
              return (
                <Link
                  key={order.id}
                  to="/owner/orders"
                  className={`flex items-center gap-3 p-4 hover:bg-gray-50 transition ${i !== recentOrders.length - 1 ? 'border-b' : ''}`}
                >
                  <div className={`w-10 h-10 rounded-xl flex items-center justify-center ${statusInfo.color}`}>
                    <StatusIcon className="w-5 h-5" />
                  </div>
                  <div className="flex-1">
                    <p className="font-semibold text-gray-900">{order.items?.length || 0} أصناف</p>
                    <p className="text-xs text-gray-500">
                      {order.createdAt?.toDate?.().toLocaleDateString('ar-SA') || ''}
                    </p>
                  </div>
                  <div className="text-left">
                    <p className="font-bold text-green-600">{order.subtotal?.toFixed(0)} ر.س</p>
                    <span className={`text-xs px-2 py-0.5 rounded-full ${statusInfo.color}`}>
                      {statusInfo.label}
                    </span>
                  </div>
                </Link>
              )
            })}
          </div>
        </div>
      )}

      {/* ========== أدوات إضافية ========== */}
      <div className="px-4">
        <h2 className="text-lg font-bold text-gray-900 mb-3"> أدوات إضافية</h2>
        <div className="grid grid-cols-1 sm:grid-cols-2 gap-3">
          {/* توظيف عاملات */}
          <Link 
            to="/owner/edit#hiring"
            className={`flex items-center gap-3 bg-white rounded-2xl shadow p-4 border ${restaurant?.isHiring ? 'border-purple-300 bg-purple-50' : 'border-gray-100'}`}
          >
            <div className={`w-10 h-10 rounded-xl flex items-center justify-center ${restaurant?.isHiring ? 'bg-purple-500' : 'bg-gray-200'}`}>
              <Briefcase className={`w-5 h-5 ${restaurant?.isHiring ? 'text-white' : 'text-gray-500'}`} />
            </div>
            <div className="flex-1">
              <p className="font-semibold text-gray-900">توظيف عاملات</p>
              <p className="text-xs text-gray-500">
                {restaurant?.isHiring ? ' إعلان التوظيف مفعّل' : 'ابحث عن مساعدة في الطبخ'}
              </p>
            </div>
          </Link>

          {/* الحساب البنكي */}
          <Link 
            to="/owner/edit#bank"
            className={`flex items-center gap-3 bg-white rounded-2xl shadow p-4 border ${restaurant?.bankName ? 'border-green-300 bg-green-50' : 'border-gray-100'}`}
          >
            <div className={`w-10 h-10 rounded-xl flex items-center justify-center ${restaurant?.bankName ? 'bg-green-500' : 'bg-gray-200'}`}>
              <Building2 className={`w-5 h-5 ${restaurant?.bankName ? 'text-white' : 'text-gray-500'}`} />
            </div>
            <div className="flex-1">
              <p className="font-semibold text-gray-900">الحساب البنكي</p>
              <p className="text-xs text-gray-500">
                {restaurant?.bankName ? ` ${restaurant.bankName}` : 'أضف بيانات الحساب'}
              </p>
            </div>
          </Link>

          {/* الباقات */}
          <Link 
            to="/owner/packages"
            className="flex items-center gap-3 bg-gradient-to-r from-amber-50 to-orange-50 rounded-2xl shadow p-4 border border-amber-200"
          >
            <div className="w-10 h-10 bg-gradient-to-br from-amber-500 to-orange-500 rounded-xl flex items-center justify-center">
              <Crown className="w-5 h-5 text-white" />
            </div>
            <div className="flex-1">
              <p className="font-semibold text-amber-700">باقتك الحالية</p>
              <div className="flex items-center gap-2 text-xs">
                <span className="text-amber-600"> الباقة المميزة</span>
                {daysRemaining !== null && (
                  <span className={`px-2 py-0.5 rounded-full ${
                    isExpired ? 'bg-red-100 text-red-600' :
                    isExpiringSoon ? 'bg-yellow-100 text-yellow-600' :
                    'bg-green-100 text-green-600'
                  }`}>
                    {isExpired ? 'منتهية' : `${daysRemaining} يوم`}
                  </span>
                )}
              </div>
            </div>
          </Link>

          {/* معاينة المتجر */}
          <Link 
            to={`/menu?restaurant=${user?.uid}`}
            className="flex items-center gap-3 bg-white rounded-2xl shadow p-4 border border-gray-100"
          >
            <div className="w-10 h-10 bg-sky-500 rounded-xl flex items-center justify-center">
              <Globe className="w-5 h-5 text-white" />
            </div>
            <div className="flex-1">
              <p className="font-semibold text-gray-900">معاينة المتجر</p>
              <p className="text-xs text-gray-500">شاهد متجرك كما يراه العملاء</p>
            </div>
          </Link>
        </div>
      </div>

      {/* ========== حالة الاشتراك التفصيلية ========== */}
      <div className="px-4">
        <div className="bg-gradient-to-br from-amber-50 to-orange-50 border border-amber-200 rounded-2xl p-4">
          <div className="flex items-center gap-2 mb-4">
            <Package className="w-5 h-5 text-amber-600" />
            <h3 className="font-bold text-amber-800"> تفاصيل الاشتراك</h3>
          </div>
          
          <div className="bg-white rounded-xl p-4 space-y-3">
            {/* نوع الباقة */}
            <div className="flex items-center justify-between">
              <span className="text-gray-600">نوع الباقة</span>
              <span className="bg-amber-500 text-white px-3 py-1 rounded-full text-sm font-bold flex items-center gap-1">
                <Crown className="w-4 h-4" />
                مميزة
              </span>
            </div>

            {/* تاريخ الاشتراك */}
            {restaurant?.packageSubscribedAt && (
              <div className="flex items-center justify-between">
                <span className="text-gray-600">تاريخ الاشتراك</span>
                <span className="text-gray-900 font-medium">
                  {restaurant.packageSubscribedAt?.toDate?.()?.toLocaleDateString('ar-SA') || '-'}
                </span>
              </div>
            )}

            {/* تاريخ الانتهاء */}
            {restaurant?.packageExpiresAt && (
              <div className="flex items-center justify-between">
                <span className="text-gray-600">تاريخ الانتهاء</span>
                <span className={`font-medium ${isExpired ? 'text-red-600' : isExpiringSoon ? 'text-yellow-600' : 'text-gray-900'}`}>
                  {restaurant.packageExpiresAt?.toDate?.()?.toLocaleDateString('ar-SA') || '-'}
                </span>
              </div>
            )}

            {/* الأيام المتبقية */}
            {daysRemaining !== null && (
              <div className="flex items-center justify-between pt-2 border-t border-gray-100">
                <span className="text-gray-600">الأيام المتبقية</span>
                <span className={`text-lg font-bold ${
                  isExpired ? 'text-red-600' :
                  isExpiringSoon ? 'text-yellow-600' :
                  'text-green-600'
                }`}>
                  {isExpired ? 'منتهية' : `${daysRemaining} يوم`}
                </span>
              </div>
            )}
          </div>

          {/* زر التجديد */}
          {(isExpired || isExpiringSoon) && (
            <Link 
              to="/owner/packages"
              className="mt-4 block w-full text-center bg-gradient-to-r from-amber-500 to-orange-500 text-white font-bold py-3 rounded-xl hover:from-amber-600 hover:to-orange-600 transition"
            >
               تجديد الاشتراك الآن
            </Link>
          )}
        </div>
      </div>

      {/* ========== معلومات الحساب البنكي (للمميزين فقط) ========== */}
      {restaurant?.bankName && (
        <div className="px-4">
          <div className="bg-gradient-to-br from-green-50 to-emerald-50 border border-green-200 rounded-2xl p-4">
            <div className="flex items-center gap-2 mb-3">
              <Building2 className="w-5 h-5 text-green-600" />
              <h3 className="font-bold text-green-800"> الحساب البنكي مفعّل</h3>
            </div>
            <div className="bg-white rounded-xl p-3 space-y-2">
              <p className="text-sm text-gray-600">
                <span className="font-semibold">البنك:</span> {restaurant.bankName}
              </p>
              <p className="text-sm text-gray-600">
                <span className="font-semibold">اسم الحساب:</span> {restaurant.bankAccountName}
              </p>
              <p className="text-sm text-gray-600">
                <span className="font-semibold">رقم الآيبان:</span> {restaurant.bankAccountNumber}
              </p>
            </div>
            <p className="text-xs text-green-600 mt-2">
               يظهر للعملاء عند اختيار التحويل البنكي
            </p>
          </div>
        </div>
      )}

    </div>
  )
}

export default OwnerDashboard

==========================================================================================
FILE: src/pages/PackagesPage.tsx
==========================================================================================
// src/pages/PackagesPage.tsx
import React, { useState, useEffect, useRef } from 'react'
import { useAuth } from '@/auth'
import { db, storage } from '@/firebase'
import { doc, getDoc, updateDoc, serverTimestamp, addDoc, collection, query, where, getDocs, onSnapshot } from 'firebase/firestore'
import { ref, uploadBytes, getDownloadURL } from 'firebase/storage'
import { useToast } from '@/components/ui/Toast'
import { useDialog } from '@/components/ui/ConfirmDialog'
import { PackageSettings, PackageConfig, PackageDiscount } from '@/types'
import { 
  Crown, 
  Star, 
  Check, 
  Sparkles, 
  TrendingUp, 
  Eye, 
  ShoppingBag,
  FileText,
  Award,
  Megaphone,
  Calendar,
  ChevronLeft,
  Gift,
  Home,
  Upload,
  ExternalLink,
  Clock,
  CreditCard,
  X
} from 'lucide-react'

type PackageType = 'free' | 'premium'
type RequestStatus = 'pending' | 'bank_sent' | 'payment_sent' | 'approved' | 'rejected' | 'expired'

type PackageRequest = {
  id: string
  status: RequestStatus
  bankAccountImageUrl?: string
  paymentProofImageUrl?: string
  subscriptionAmount?: number
  subscriptionDuration?: number
  createdAt?: any
  expiresAt?: any
}

// إعدادات الباقات الافتراضية
const defaultPackageSettings: PackageSettings = {
  premium: {
    displayName: 'باقة التميز',
    description: 'احصل على مزايا حصرية وإحصائيات متقدمة',
    isEnabled: true,
    originalPrice: 99,
    currentPrice: 99,
    durationDays: 30,
  },
  free: {
    displayName: 'الباقة المجانية',
    description: 'المميزات الأساسية مجاناً',
    isEnabled: true,
    originalPrice: 0,
    currentPrice: 0,
    durationDays: 0,
  },
  defaultPackage: 'free',
}

// دالة للتحقق من صلاحية الخصم
const isDiscountValid = (discount?: PackageDiscount): boolean => {
  if (!discount?.isActive) return false
  
  const now = new Date()
  const startDate = discount.startDate?.toDate?.() || (discount.startDate ? new Date(discount.startDate) : null)
  const endDate = discount.endDate?.toDate?.() || (discount.endDate ? new Date(discount.endDate) : null)
  
  if (startDate && now < startDate) return false
  if (endDate && now > endDate) return false
  
  return true
}

// دالة لحساب السعر الفعلي بعد الخصم
const calculateCurrentPrice = (config: PackageConfig): number => {
  if (!isDiscountValid(config.discount)) {
    return config.originalPrice
  }
  
  const discount = config.discount!
  if (discount.type === 'percentage') {
    return config.originalPrice - (config.originalPrice * discount.value / 100)
  } else {
    return Math.max(0, config.originalPrice - discount.value)
  }
}

export const PackagesPage: React.FC = () => {
  const { user } = useAuth()
  const toast = useToast()
  const dialog = useDialog()
  const [currentPackage, setCurrentPackage] = useState<PackageType>('free')
  const [loading, setLoading] = useState(true)
  const [subscribing, setSubscribing] = useState(false)
  const [selectingFree, setSelectingFree] = useState(false)
  
  // إعدادات الباقات الديناميكية
  const [pkgSettings, setPkgSettings] = useState<PackageSettings>(defaultPackageSettings)
  
  // حالة طلب الاشتراك
  const [activeRequest, setActiveRequest] = useState<PackageRequest | null>(null)
  const [uploadingProof, setUploadingProof] = useState(false)
  const [proofFile, setProofFile] = useState<File | null>(null)
  const proofFileRef = useRef<HTMLInputElement>(null)

  // حساب السعر الحالي لباقة التميز
  const premiumPrice = calculateCurrentPrice(pkgSettings.premium)
  const hasDiscount = isDiscountValid(pkgSettings.premium.discount)

  // Debug logging
  useEffect(() => {
    console.log(' حالة الباقة:', {
      pkgSettings: pkgSettings.premium,
      discount: pkgSettings.premium.discount,
      hasDiscount,
      premiumPrice,
      originalPrice: pkgSettings.premium.originalPrice,
    })
  }, [pkgSettings, hasDiscount, premiumPrice])

  useEffect(() => {
    if (!user) return
    
    const loadData = async () => {
      try {
        // تحميل إعدادات الباقات
        const pkgSnap = await getDoc(doc(db, 'settings', 'packages'))
        if (pkgSnap.exists()) {
          const data = pkgSnap.data() as PackageSettings
          console.log(' إعدادات الباقات من Firestore:', data)
          setPkgSettings({
            ...defaultPackageSettings,
            ...data,
            premium: { 
              ...defaultPackageSettings.premium, 
              ...data.premium,
              discount: data.premium?.discount ? {
                ...data.premium.discount,
                isActive: data.premium.discount.isActive ?? false,
              } : undefined,
            },
            free: { ...defaultPackageSettings.free, ...data.free },
          })
        } else {
          console.log(' لا توجد إعدادات باقات في Firestore، يتم استخدام الافتراضي')
        }
        
        // تحميل بيانات المطعم
        const restSnap = await getDoc(doc(db, 'restaurants', user.uid))
        if (restSnap.exists()) {
          const data = restSnap.data()
          setCurrentPackage(data?.packageType || 'free')
        }
        
        // تحميل طلب الاشتراك النشط
        const requestsQuery = query(
          collection(db, 'packageRequests'),
          where('restaurantId', '==', user.uid)
        )
        const requestsSnap = await getDocs(requestsQuery)
        if (!requestsSnap.empty) {
          // جلب آخر طلب
          const requests = requestsSnap.docs.map(d => ({ id: d.id, ...d.data() } as PackageRequest))
          const activeReq = requests.find(r => !['approved', 'rejected', 'expired'].includes(r.status))
          if (activeReq) {
            setActiveRequest(activeReq)
          }
        }
      } catch (err) {
        console.error('خطأ في تحميل البيانات:', err)
      } finally {
        setLoading(false)
      }
    }
    
    loadData()
    
    // الاستماع لتحديثات الطلب في الوقت الفعلي
    const requestsQuery = query(
      collection(db, 'packageRequests'),
      where('restaurantId', '==', user.uid)
    )
    const unsub = onSnapshot(requestsQuery, (snap) => {
      if (!snap.empty) {
        const requests = snap.docs.map(d => ({ id: d.id, ...d.data() } as PackageRequest))
        const activeReq = requests.find(r => !['approved', 'rejected', 'expired'].includes(r.status))
        setActiveRequest(activeReq || null)
        
        // إذا تمت الموافقة، تحديث الباقة
        const approvedReq = requests.find(r => r.status === 'approved')
        if (approvedReq) {
          setCurrentPackage('premium')
        }
      }
    })
    
    return () => unsub()
  }, [user])

  // اختيار الباقة المجانية
  const handleSelectFree = async () => {
    if (!user) return
    if (currentPackage === 'free') {
      toast.info('أنت بالفعل مشترك في الباقة المجانية')
      return
    }
    
    const confirmed = await dialog.confirm(
      'هل تريد التحويل إلى الباقة المجانية؟ ستفقد مميزات باقة التميز.',
      {
        title: ' التحويل للباقة المجانية',
        confirmText: 'نعم، حوّل للمجانية',
        cancelText: 'إلغاء',
      }
    )
    
    if (!confirmed) return

    setSelectingFree(true)
    try {
      await updateDoc(doc(db, 'restaurants', user.uid), {
        packageType: 'free',
        packageRequest: null,
        updatedAt: serverTimestamp(),
      })
      setCurrentPackage('free')
      toast.success('تم التحويل للباقة المجانية')
    } catch (err) {
      console.error('خطأ:', err)
      toast.error('حدث خطأ، حاول مرة أخرى')
    } finally {
      setSelectingFree(false)
    }
  }

  // الاشتراك في باقة التميز
  const handleSubscribePremium = async () => {
    if (!user) return
    
    // التحقق من وجود طلب نشط
    if (activeRequest) {
      toast.info('لديك طلب اشتراك قيد المعالجة')
      return
    }

    //  إذا كانت الباقة مجانية، يتم التفعيل مباشرة بدون طلب
    if (premiumPrice === 0) {
      const confirmed = await dialog.confirm(
        'باقة التميز متاحة مجاناً حالياً! هل تريد تفعيلها الآن؟',
        {
          title: ' عرض خاص - باقة مجانية!',
          confirmText: 'نعم، فعّل الباقة الآن',
          cancelText: 'لاحقاً',
        }
      )
      
      if (!confirmed) return

      setSubscribing(true)
      try {
        const expiresAt = new Date()
        expiresAt.setDate(expiresAt.getDate() + (pkgSettings.premium.durationDays || 30))

        // تفعيل الباقة مباشرة
        await updateDoc(doc(db, 'restaurants', user.uid), {
          packageType: 'premium',
          packageSubscribedAt: serverTimestamp(),
          packageExpiresAt: expiresAt,
          packageRequest: null,
          updatedAt: serverTimestamp(),
        })

        setCurrentPackage('premium')
        toast.success(' مبروك! تم تفعيل باقة التميز مجاناً!')
      } catch (err) {
        console.error('خطأ:', err)
        toast.error('حدث خطأ، حاول مرة أخرى')
      } finally {
        setSubscribing(false)
      }
      return
    }

    // الباقة ليست مجانية - إرسال طلب الاشتراك كالمعتاد
    const confirmed = await dialog.confirm(
      `سيتم إرسال طلبك للاشتراك في باقة التميز بمبلغ ${premiumPrice.toFixed(0)} ريال. هل تريد المتابعة؟`,
      {
        title: ' الاشتراك في باقة التميز',
        confirmText: 'نعم، أريد الاشتراك',
        cancelText: 'لاحقاً',
      }
    )
    
    if (!confirmed) return

    setSubscribing(true)
    try {
      // جلب بيانات المطعم
      const restSnap = await getDoc(doc(db, 'restaurants', user.uid))
      const restData = restSnap.data()
      
      // إنشاء طلب اشتراك جديد مع السعر الديناميكي
      const requestRef = await addDoc(collection(db, 'packageRequests'), {
        restaurantId: user.uid,
        restaurantName: restData?.name || 'أسرة منتجة',
        ownerName: restData?.ownerName || '',
        ownerPhone: restData?.phone || '',
        status: 'pending',
        subscriptionAmount: premiumPrice, // السعر الديناميكي من الإعدادات
        subscriptionDuration: pkgSettings.premium.durationDays, // المدة من الإعدادات
        requestedAt: serverTimestamp(),
        createdAt: serverTimestamp(),
        updatedAt: serverTimestamp(),
      })
      
      // تحديث المطعم
      await updateDoc(doc(db, 'restaurants', user.uid), {
        packageRequest: 'premium',
        packageRequestedAt: serverTimestamp(),
        updatedAt: serverTimestamp(),
      })
      
      // إرسال إشعار للمطور
      try {
        const devQuery = query(collection(db, 'users'), where('role', '==', 'developer'))
        const devSnap = await getDocs(devQuery)
        
        if (!devSnap.empty) {
          // إرسال إشعار لكل المطورين
          for (const devDoc of devSnap.docs) {
            await addDoc(collection(db, 'notifications'), {
              recipientId: devDoc.id,
              title: ' طلب اشتراك جديد في باقة التميز',
              message: `${restData?.name || 'أسرة منتجة'} طلبت الاشتراك في باقة التميز`,
              type: 'package_request',
              read: false,
              data: { requestId: requestRef.id, restaurantId: user.uid },
              createdAt: serverTimestamp(),
            })
          }
        } else {
          // لا يوجد مطور - نرسل للمشرفين بدلاً منه
          const adminQuery = query(collection(db, 'users'), where('role', '==', 'admin'))
          const adminSnap = await getDocs(adminQuery)
          for (const adminDoc of adminSnap.docs) {
            await addDoc(collection(db, 'notifications'), {
              recipientId: adminDoc.id,
              title: ' طلب اشتراك جديد في باقة التميز',
              message: `${restData?.name || 'أسرة منتجة'} طلبت الاشتراك في باقة التميز`,
              type: 'package_request',
              read: false,
              data: { requestId: requestRef.id, restaurantId: user.uid },
              createdAt: serverTimestamp(),
            })
          }
        }
      } catch (notifErr) {
        // لا نوقف العملية إذا فشل إرسال الإشعار
        console.warn('فشل إرسال الإشعار:', notifErr)
      }
      
      toast.success('تم تسجيل طلبك! يرجى رفع إيصال التحويل أدناه ')
    } catch (err) {
      console.error('خطأ في إرسال الطلب:', err)
      toast.error('حدث خطأ، حاول مرة أخرى')
    } finally {
      setSubscribing(false)
    }
  }

  // رفع إثبات التحويل
  const handleUploadPaymentProof = async () => {
    if (!user || !activeRequest || !proofFile) {
      toast.warning('يرجى اختيار صورة إثبات التحويل')
      return
    }

    setUploadingProof(true)
    try {
      // رفع الصورة
      const path = `paymentProofs/${user.uid}_${Date.now()}_${proofFile.name}`
      const storageRef = ref(storage, path)
      await uploadBytes(storageRef, proofFile)
      const imageUrl = await getDownloadURL(storageRef)

      // تحديث الطلب
      await updateDoc(doc(db, 'packageRequests', activeRequest.id), {
        status: 'payment_sent',
        paymentProofImageUrl: imageUrl,
        paymentSentAt: serverTimestamp(),
        updatedAt: serverTimestamp(),
      })

      // إرسال إشعار للمطور
      try {
        const restSnap = await getDoc(doc(db, 'restaurants', user.uid))
        const restName = restSnap.data()?.name || 'أسرة منتجة'
        
        const devQuery = query(collection(db, 'users'), where('role', '==', 'developer'))
        const devSnap = await getDocs(devQuery)
        
        if (!devSnap.empty) {
          for (const devDoc of devSnap.docs) {
            await addDoc(collection(db, 'notifications'), {
              recipientId: devDoc.id,
              title: ' تم إرسال إثبات تحويل',
              message: `${restName} أرسلت إثبات تحويل مبلغ الاشتراك`,
              type: 'payment_proof_sent',
              read: false,
              data: { requestId: activeRequest.id, restaurantId: user.uid },
              createdAt: serverTimestamp(),
            })
          }
        } else {
          // لا يوجد مطور - نرسل للمشرفين
          const adminQuery = query(collection(db, 'users'), where('role', '==', 'admin'))
          const adminSnap = await getDocs(adminQuery)
          for (const adminDoc of adminSnap.docs) {
            await addDoc(collection(db, 'notifications'), {
              recipientId: adminDoc.id,
              title: ' تم إرسال إثبات تحويل',
              message: `${restName} أرسلت إثبات تحويل مبلغ الاشتراك`,
              type: 'payment_proof_sent',
              read: false,
              data: { requestId: activeRequest.id, restaurantId: user.uid },
              createdAt: serverTimestamp(),
            })
          }
        }
      } catch (notifErr) {
        console.warn('فشل إرسال الإشعار:', notifErr)
      }

      toast.success('تم إرسال إثبات التحويل بنجاح! سيتم مراجعته وتفعيل الباقة ')
      setProofFile(null)
      if (proofFileRef.current) proofFileRef.current.value = ''
    } catch (err: any) {
      console.error('خطأ في رفع الإثبات:', err)
      toast.error(`حدث خطأ: ${err.message}`)
    } finally {
      setUploadingProof(false)
    }
  }

  if (loading) {
    return (
      <div className="flex items-center justify-center min-h-[400px]">
        <div className="text-center">
          <div className="w-12 h-12 border-4 border-amber-200 border-t-amber-500 rounded-full animate-spin mx-auto mb-4" />
          <p className="text-gray-500">جارِ التحميل...</p>
        </div>
      </div>
    )
  }

  return (
    <div className="max-w-4xl mx-auto space-y-8">
      {/* العنوان الرئيسي */}
      <div className="text-center">
        <div className="inline-flex items-center gap-2 bg-gradient-to-r from-amber-100 to-yellow-100 px-5 py-2.5 rounded-full mb-4 shadow-sm">
          <span className="text-xl"></span>
          <span className="text-amber-700 font-bold text-lg">باقات سفرة البيت</span>
        </div>
        <h1 className="text-3xl md:text-4xl font-black text-gray-900 mb-3">
          اختر الباقة المناسبة لأسرتك
        </h1>
        <p className="text-gray-600 max-w-lg mx-auto">
          ابدأ مجاناً واستمتع بجميع المميزات الأساسية، أو اشترك في باقة التميز للحصول على مزايا حصرية
        </p>
      </div>

      {/* === قسم حالة طلب الاشتراك النشط === */}
      {activeRequest && (
        <div className="bg-gradient-to-r from-amber-50 to-orange-50 rounded-2xl p-6 border-2 border-amber-200 shadow-lg">
          <div className="flex items-center gap-3 mb-4">
            <div className="w-12 h-12 bg-amber-500 rounded-xl flex items-center justify-center">
              <CreditCard className="w-6 h-6 text-white" />
            </div>
            <div>
              <h3 className="text-xl font-bold text-amber-800">طلب اشتراك قيد المعالجة</h3>
              <p className="text-amber-600 text-sm">
                {activeRequest.status === 'pending' && ' يرجى رفع إيصال التحويل'}
                {activeRequest.status === 'payment_sent' && ' تم إرسال إثبات التحويل - بانتظار التأكيد'}
              </p>
            </div>
          </div>

          {/* === حالة: بانتظار رفع الإيصال === */}
          {activeRequest.status === 'pending' && (
            <div className="space-y-4">
              <div className="bg-white rounded-xl p-4">
                <p className="text-green-600 font-bold text-lg mb-2">
                   المبلغ المطلوب: {activeRequest.subscriptionAmount || premiumPrice} ريال
                </p>
                <p className="text-gray-600 text-sm">
                  يرجى تحويل المبلغ أعلاه ثم رفع صورة إيصال التحويل
                </p>
              </div>

              {/* رفع إيصال التحويل */}
              <div className="bg-white rounded-xl p-4 space-y-3">
                <p className="font-semibold text-gray-700"> ارفع صورة إيصال التحويل:</p>
                <input
                  ref={proofFileRef}
                  type="file"
                  accept="image/*"
                  onChange={(e) => setProofFile(e.target.files?.[0] || null)}
                  className="w-full border-2 border-dashed border-amber-300 rounded-xl p-4 bg-amber-50"
                />
                {proofFile && (
                  <p className="text-sm text-green-600"> تم اختيار: {proofFile.name}</p>
                )}
                <button
                  onClick={handleUploadPaymentProof}
                  disabled={uploadingProof || !proofFile}
                  className="w-full bg-gradient-to-r from-green-500 to-emerald-600 hover:from-green-600 hover:to-emerald-700 text-white py-3 rounded-xl font-bold disabled:opacity-50 transition flex items-center justify-center gap-2"
                >
                  {uploadingProof ? (
                    <>
                      <Clock className="w-5 h-5 animate-spin" />
                      جارِ الرفع...
                    </>
                  ) : (
                    <>
                      <Upload className="w-5 h-5" />
                      إرسال إيصال التحويل
                    </>
                  )}
                </button>
              </div>
            </div>
          )}

          {/* === حالة: بانتظار تأكيد المطور === */}
          {activeRequest.status === 'payment_sent' && (
            <div className="bg-purple-100 rounded-xl p-4 flex items-center gap-3">
              <Clock className="w-8 h-8 text-purple-600 animate-pulse" />
              <div>
                <p className="font-bold text-purple-800">تم إرسال إيصال التحويل بنجاح </p>
                <p className="text-purple-600 text-sm">جارِ مراجعة الإيصال وتفعيل الباقة... سيتم إشعارك قريباً</p>
              </div>
            </div>
          )}
        </div>
      )}

      {/* الباقات */}
      <div className="grid md:grid-cols-2 gap-6">
        
        {/* ======================================================= */}
        {/* الباقة المجانية */}
        {/* ======================================================= */}
        <div className={`relative rounded-3xl overflow-hidden transition-all duration-300 ${
          currentPackage === 'free' 
            ? 'ring-4 ring-green-400 shadow-2xl' 
            : 'shadow-lg hover:shadow-xl'
        }`}>
          {currentPackage === 'free' && (
            <div className="absolute top-4 right-4 bg-green-500 text-white px-3 py-1 rounded-full text-sm font-bold flex items-center gap-1 z-10">
              <Check className="w-4 h-4" />
              باقتك الحالية
            </div>
          )}
          
          <div className="bg-gradient-to-br from-green-50 via-emerald-50 to-teal-50 p-6 md:p-8 h-full flex flex-col">
            {/* رأس الباقة */}
            <div className="flex items-center gap-4 mb-6">
              <div className="w-16 h-16 bg-gradient-to-br from-green-400 to-emerald-500 rounded-2xl flex items-center justify-center shadow-lg">
                <Gift className="w-8 h-8 text-white" />
              </div>
              <div>
                <h2 className="text-2xl font-black text-gray-900">الباقة المجانية</h2>
                <p className="text-green-600 font-semibold">للجميع • مدى الحياة</p>
              </div>
            </div>

            {/* السعر */}
            <div className="bg-white/70 backdrop-blur rounded-2xl p-4 mb-6 text-center">
              <div className="flex items-baseline justify-center gap-1">
                <span className="text-5xl font-black text-gray-900">0</span>
                <span className="text-xl text-gray-600">ر.س</span>
              </div>
              <p className="text-green-600 font-medium mt-1">مجاناً للأبد</p>
            </div>

            {/* المميزات */}
            <div className="space-y-4 flex-1">
              <h3 className="font-bold text-gray-800 flex items-center gap-2">
                <Star className="w-5 h-5 text-amber-500" />
                المميزات المتاحة:
              </h3>
              
              <div className="space-y-3">
                <FeatureItem 
                  icon={<Eye className="w-5 h-5" />}
                  title="الظهور في التطبيق"
                  desc="أسرتك تظهر لجميع العملاء في منطقتك"
                  included
                />
                <FeatureItem 
                  icon={<ShoppingBag className="w-5 h-5" />}
                  title="استقبال الطلبات"
                  desc="استقبل طلبات العملاء بدون حدود"
                  included
                />
                <FeatureItem 
                  icon={<FileText className="w-5 h-5" />}
                  title="صفحة خاصة لأسرتك"
                  desc="صفحة مخصصة تعرض قائمتك ومنتجاتك"
                  included
                />
              </div>
            </div>

            {/* زر الباقة المجانية */}
            <div className="mt-6">
              {currentPackage === 'free' ? (
                <div className="bg-green-100 text-green-700 py-4 px-6 rounded-2xl text-center font-bold flex items-center justify-center gap-2">
                  <Check className="w-5 h-5" />
                  أنت مشترك في هذه الباقة
                </div>
              ) : (
                <button
                  onClick={handleSelectFree}
                  disabled={selectingFree}
                  className="w-full py-4 px-6 rounded-2xl bg-gradient-to-r from-green-500 to-emerald-500 text-white font-bold text-lg shadow-lg hover:shadow-xl transition-all duration-300 hover:scale-[1.02] disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center gap-3"
                >
                  {selectingFree ? (
                    <>
                      <div className="w-5 h-5 border-2 border-white/30 border-t-white rounded-full animate-spin" />
                      جارِ التحويل...
                    </>
                  ) : (
                    <>
                      <Gift className="w-6 h-6" />
                      اختر الباقة المجانية
                      <ChevronLeft className="w-5 h-5" />
                    </>
                  )}
                </button>
              )}
            </div>
          </div>
        </div>

        {/* ======================================================= */}
        {/* باقة التميز */}
        {/* ======================================================= */}
        <div className={`relative rounded-3xl overflow-hidden transition-all duration-300 ${
          currentPackage === 'premium' 
            ? 'ring-4 ring-amber-400 shadow-2xl' 
            : 'shadow-lg hover:shadow-xl hover:scale-[1.01]'
        }`}>
          {/* شريط التميز */}
          <div className="absolute top-0 left-0 right-0 bg-gradient-to-r from-amber-500 via-yellow-400 to-amber-500 py-2 text-center z-10">
            <div className="flex items-center justify-center gap-2 text-white font-bold">
              <Crown className="w-5 h-5" />
              <span>الأكثر شعبية</span>
              <Crown className="w-5 h-5" />
            </div>
          </div>

          {currentPackage === 'premium' && (
            <div className="absolute top-12 right-4 bg-amber-500 text-white px-3 py-1 rounded-full text-sm font-bold flex items-center gap-1 z-10">
              <Crown className="w-4 h-4" />
              باقتك الحالية
            </div>
          )}
          
          <div className="bg-gradient-to-br from-amber-50 via-yellow-50 to-orange-50 p-6 md:p-8 pt-14 h-full flex flex-col">
            {/* رأس الباقة */}
            <div className="flex items-center gap-4 mb-6">
              <div className="w-16 h-16 bg-gradient-to-br from-amber-400 via-yellow-400 to-orange-400 rounded-2xl flex items-center justify-center shadow-lg relative">
                <Crown className="w-8 h-8 text-white" />
                <div className="absolute -top-1 -right-1 w-6 h-6 bg-white rounded-full flex items-center justify-center shadow">
                  <Sparkles className="w-4 h-4 text-amber-500" />
                </div>
              </div>
              <div>
                <h2 className="text-2xl font-black text-gray-900">باقة التميّز</h2>
                <p className="text-amber-600 font-semibold">للأسر المميزة </p>
              </div>
            </div>

            {/* السعر */}
            <div className="bg-white/70 backdrop-blur rounded-2xl p-4 mb-6 text-center relative overflow-hidden">
              <div className="absolute inset-0 bg-gradient-to-r from-amber-400/10 via-yellow-400/10 to-orange-400/10" />
              <div className="relative">
                {/* عرض الخصم إن وجد */}
                {hasDiscount && (
                  <div className="mb-2">
                    <span className="bg-red-500 text-white text-sm px-3 py-1 rounded-full font-bold">
                      {pkgSettings.premium.discount?.label || 'خصم خاص!'}
                    </span>
                    {pkgSettings.premium.originalPrice > premiumPrice && (
                      <p className="text-gray-400 line-through text-lg mt-1">
                        {pkgSettings.premium.originalPrice.toFixed(0)} ر.س
                      </p>
                    )}
                  </div>
                )}
                <div className="flex items-baseline justify-center gap-1">
                  <span className="text-5xl font-black bg-gradient-to-r from-amber-600 to-orange-500 bg-clip-text text-transparent">
                    {premiumPrice === 0 ? 'مجاناً' : premiumPrice.toFixed(0)}
                  </span>
                  {premiumPrice > 0 && <span className="text-xl text-gray-600">ر.س</span>}
                </div>
                <p className="text-amber-600 font-medium mt-1">
                  {premiumPrice === 0 ? 'عرض خاص!' : `لمدة ${pkgSettings.premium.durationDays} يوم`}
                </p>
              </div>
            </div>

            {/* المميزات */}
            <div className="space-y-4 flex-1">
              <h3 className="font-bold text-gray-800 flex items-center gap-2">
                <Crown className="w-5 h-5 text-amber-500" />
                جميع مميزات الباقة المجانية، بالإضافة إلى:
              </h3>
              
              <div className="space-y-3">
                <FeatureItem 
                  icon={<TrendingUp className="w-5 h-5" />}
                  title="الظهور أعلى في النتائج"
                  desc="أسرتك تظهر في أعلى قائمة البحث دائماً"
                  included
                  premium
                />
                <FeatureItem 
                  icon={<Award className="w-5 h-5" />}
                  title="علامة أسرة مميزة"
                  desc="شارة ذهبية تميزك عن الآخرين"
                  included
                  premium
                />
                <FeatureItem 
                  icon={<Home className="w-5 h-5" />}
                  title="اقتراحك في الصفحة الرئيسية"
                  desc="ظهور أسرتك في قسم الأسر المميزة"
                  included
                  premium
                />
                <FeatureItem 
                  icon={<Calendar className="w-5 h-5" />}
                  title="الحملات الموسمية"
                  desc="دخول مجاني في حملات رمضان والأعياد"
                  included
                  premium
                />
              </div>
            </div>

            {/* زر الاشتراك */}
            <div className="mt-6 space-y-3">
              {currentPackage === 'premium' ? (
                <>
                  <div className="bg-amber-100 text-amber-700 py-4 px-6 rounded-2xl text-center font-bold flex items-center justify-center gap-2">
                    <Crown className="w-5 h-5" />
                    أنت مشترك في باقة التميز
                  </div>
                  {/* زر إلغاء الاشتراك */}
                  <button
                    onClick={handleSelectFree}
                    disabled={selectingFree}
                    className="w-full py-3 px-6 rounded-xl bg-red-50 hover:bg-red-100 text-red-600 font-semibold text-sm border border-red-200 transition-all duration-300 flex items-center justify-center gap-2"
                  >
                    {selectingFree ? (
                      <>
                        <div className="w-4 h-4 border-2 border-red-300 border-t-red-600 rounded-full animate-spin" />
                        جارِ الإلغاء...
                      </>
                    ) : (
                      <>
                        <X className="w-4 h-4" />
                        إلغاء الاشتراك
                      </>
                    )}
                  </button>
                </>
              ) : (
                <button
                  onClick={handleSubscribePremium}
                  disabled={subscribing}
                  className="w-full py-4 px-6 rounded-2xl bg-gradient-to-r from-amber-500 via-yellow-400 to-orange-500 text-white font-bold text-lg shadow-xl hover:shadow-2xl transition-all duration-300 hover:scale-[1.02] disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center gap-3 relative overflow-hidden group"
                >
                  <div className="absolute inset-0 bg-gradient-to-r from-white/0 via-white/30 to-white/0 translate-x-[-100%] group-hover:translate-x-[100%] transition-transform duration-700" />
                  {subscribing ? (
                    <>
                      <div className="w-5 h-5 border-2 border-white/30 border-t-white rounded-full animate-spin" />
                      جارِ الإرسال...
                    </>
                  ) : (
                    <>
                      <Crown className="w-6 h-6" />
                      اشترك في باقة التميّز
                      <ChevronLeft className="w-5 h-5" />
                    </>
                  )}
                </button>
              )}
            </div>
          </div>
        </div>
      </div>

      {/* مقارنة سريعة */}
      <div className="bg-white rounded-3xl shadow-xl overflow-hidden">
        <div className="bg-gradient-to-r from-gray-800 to-gray-900 px-6 py-4">
          <h3 className="text-white font-bold text-lg flex items-center gap-2">
            <Sparkles className="w-5 h-5 text-amber-400" />
            مقارنة سريعة بين الباقات
          </h3>
        </div>
        <div className="overflow-x-auto">
          <table className="w-full">
            <thead className="bg-gray-50">
              <tr>
                <th className="px-6 py-4 text-right font-bold text-gray-700">الميزة</th>
                <th className="px-6 py-4 text-center font-bold text-green-600">
                  <div className="flex items-center justify-center gap-2">
                    <Gift className="w-5 h-5" />
                    المجانية
                  </div>
                </th>
                <th className="px-6 py-4 text-center font-bold text-amber-600">
                  <div className="flex items-center justify-center gap-2">
                    <Crown className="w-5 h-5" />
                    التميّز
                  </div>
                </th>
              </tr>
            </thead>
            <tbody className="divide-y divide-gray-100">
              <CompareRow label="الظهور في التطبيق" free premium />
              <CompareRow label="استقبال الطلبات" free premium />
              <CompareRow label="صفحة خاصة لأسرتك" free premium />
              <CompareRow label="الظهور أعلى في النتائج" premium />
              <CompareRow label="علامة أسرة مميزة" premium />
              <CompareRow label="اقتراحك في الصفحة الرئيسية" premium />
              <CompareRow label="الحملات الموسمية" premium />
            </tbody>
          </table>
        </div>
      </div>

      {/* ملاحظة */}
      <div className="bg-gradient-to-r from-sky-50 to-blue-50 rounded-2xl p-6 text-center">
        <p className="text-gray-600">
          <span className="font-bold text-sky-600"> ملاحظة:</span>
          {' '}يمكنك الترقية أو إلغاء الاشتراك في أي وقت. لا توجد التزامات طويلة المدى.
        </p>
      </div>
    </div>
  )
}

// مكون عنصر الميزة
const FeatureItem: React.FC<{
  icon: React.ReactNode
  title: string
  desc: string
  included: boolean
  premium?: boolean
}> = ({ icon, title, desc, included, premium }) => (
  <div className={`flex items-start gap-3 p-3 rounded-xl transition ${
    included 
      ? premium 
        ? 'bg-gradient-to-r from-amber-100/50 to-yellow-100/50' 
        : 'bg-white/50'
      : 'opacity-50'
  }`}>
    <div className={`w-10 h-10 rounded-xl flex items-center justify-center flex-shrink-0 ${
      included
        ? premium
          ? 'bg-gradient-to-br from-amber-400 to-orange-400 text-white'
          : 'bg-green-100 text-green-600'
        : 'bg-gray-100 text-gray-400'
    }`}>
      {icon}
    </div>
    <div className="flex-1">
      <div className="flex items-center gap-2">
        <h4 className={`font-bold ${included ? 'text-gray-800' : 'text-gray-400'}`}>{title}</h4>
        {premium && (
          <span className="bg-gradient-to-r from-amber-400 to-orange-400 text-white text-xs px-2 py-0.5 rounded-full font-bold">
            حصري
          </span>
        )}
      </div>
      <p className={`text-sm ${included ? 'text-gray-500' : 'text-gray-400'}`}>{desc}</p>
    </div>
    {included && (
      <Check className={`w-5 h-5 flex-shrink-0 ${premium ? 'text-amber-500' : 'text-green-500'}`} />
    )}
  </div>
)

// مكون صف المقارنة
const CompareRow: React.FC<{
  label: string
  free?: boolean
  premium?: boolean
}> = ({ label, free, premium }) => (
  <tr className="hover:bg-gray-50 transition">
    <td className="px-6 py-4 text-gray-700 font-medium">{label}</td>
    <td className="px-6 py-4 text-center">
      {free ? (
        <div className="inline-flex items-center justify-center w-8 h-8 bg-green-100 rounded-full">
          <Check className="w-5 h-5 text-green-600" />
        </div>
      ) : (
        <div className="inline-flex items-center justify-center w-8 h-8 bg-gray-100 rounded-full">
          <span className="text-gray-400">—</span>
        </div>
      )}
    </td>
    <td className="px-6 py-4 text-center">
      {premium ? (
        <div className="inline-flex items-center justify-center w-8 h-8 bg-amber-100 rounded-full">
          <Check className="w-5 h-5 text-amber-600" />
        </div>
      ) : (
        <div className="inline-flex items-center justify-center w-8 h-8 bg-gray-100 rounded-full">
          <span className="text-gray-400">—</span>
        </div>
      )}
    </td>
  </tr>
)

export default PackagesPage

==========================================================================================
FILE: src/pages/PrivacyPolicy.tsx
==========================================================================================
// src/pages/PrivacyPolicy.tsx
import React from "react";
import { Link } from "react-router-dom";

export default function PrivacyPolicy() {
  return (
    <div className="min-h-screen bg-gray-100 text-gray-800 px-4 py-10 leading-relaxed">
      <div className="max-w-3xl mx-auto bg-white shadow-lg rounded-2xl p-6 sm:p-8">
        <h1 className="text-2xl font-bold text-sky-600 mb-4 text-center">
          سياسة الخصوصية وإخلاء المسؤولية
        </h1>
        <p className="text-center text-gray-600 mb-8">
           منصة سفرة البيت
        </p>

        {/* مقدمة */}
        <section className="mb-6">
          <p className="bg-sky-50 border border-sky-200 rounded-lg p-4 text-gray-800">
            نحن في تطبيق <strong>سفرة البيت</strong> نحترم خصوصية المستخدمين ونسعى
            لتقديم منصة آمنة وسهلة تربط بين مقدمي الخدمات الغذائية والعملاء.
          </p>
        </section>

        {/* 1. طبيعة دور التطبيق */}
        <section className="mb-6">
          <h2 className="text-xl font-semibold text-gray-900 mb-3 border-r-4 border-sky-500 pr-3">
            1. طبيعة دور التطبيق
          </h2>
          <ul className="list-disc list-inside space-y-2 text-gray-700">
            <li>
              تطبيق سفرة البيت يعمل كـ<strong className="text-sky-600">منصة وسيطة فقط</strong> لربط
              العملاء بالأسر المنتجة والمطاعم ومقدمي خدمات التوصيل.
            </li>
            <li>
              التطبيق <strong className="text-red-600">لا يقوم</strong> بإعداد الطعام، ولا بتغليفه،
              ولا بتخزينه، ولا بتوصيله بشكل مباشر.
            </li>
          </ul>
        </section>

        {/* 2. المسؤولية عن جودة الطعام */}
        <section className="mb-6">
          <h2 className="text-xl font-semibold text-gray-900 mb-3 border-r-4 border-red-500 pr-3">
            2. المسؤولية عن جودة الطعام
          </h2>
          <p className="mb-3 text-gray-700">
            جميع الأطعمة والمشروبات المعروضة داخل التطبيق يتم إعدادها وتجهيزها من
            قبل <strong>مقدمي الخدمة أنفسهم</strong>. وعليه:
          </p>
          <div className="bg-red-50 border border-red-200 rounded-lg p-4">
            <p className="font-bold text-red-700 mb-3">التطبيق غير مسؤول عن:</p>
            <ul className="list-disc list-inside space-y-2 text-red-700 mr-4">
              <li>جودة الطعام</li>
              <li>سلامة المكونات</li>
              <li>سوء التخزين</li>
              <li>التسمم الغذائي</li>
              <li>أي أضرار صحية أو حساسية غذائية</li>
              <li>النظافة أو التغليف</li>
            </ul>
            <p className="mt-4 font-bold text-gray-800 bg-amber-100 p-2 rounded">
               المسؤولية الكاملة تقع على مقدم الخدمة (الأسرة / المطعم)
            </p>
          </div>
        </section>

        {/* 3. الحساسية الغذائية */}
        <section className="mb-6">
          <h2 className="text-xl font-semibold text-gray-900 mb-3 border-r-4 border-amber-500 pr-3">
            3. الحساسية الغذائية والتغذية
          </h2>
          <ul className="list-disc list-inside space-y-2 text-gray-700">
            <li>
              يتحمل <strong>العميل</strong> مسؤولية التحقق من المكونات قبل الطلب،
              خاصة في حالات الحساسية أو الأنظمة الغذائية الخاصة.
            </li>
            <li>
              التطبيق <strong className="text-red-600">لا يضمن</strong> دقة
              المعلومات الغذائية المقدمة من مقدمي الخدمة.
            </li>
          </ul>
        </section>

        {/* 4. مسؤولية التوصيل */}
        <section className="mb-6">
          <h2 className="text-xl font-semibold text-gray-900 mb-3 border-r-4 border-emerald-500 pr-3">
            4. مسؤولية التوصيل
          </h2>
          <p className="mb-3 text-gray-700">
            خدمة التوصيل يتم تنفيذها بواسطة <strong>طرف ثالث مستقل</strong>.
          </p>
          <div className="bg-gray-50 border border-gray-200 rounded-lg p-4">
            <p className="font-bold text-gray-700 mb-2">التطبيق غير مسؤول عن:</p>
            <ul className="list-disc list-inside space-y-1 text-gray-600 mr-4">
              <li>تأخير الطلب</li>
              <li>تلف الطلب أثناء النقل</li>
              <li>سوء التعامل من المندوب</li>
            </ul>
          </div>
        </section>

        {/* 5. استخدام البيانات */}
        <section className="mb-6">
          <h2 className="text-xl font-semibold text-gray-900 mb-3 border-r-4 border-sky-500 pr-3">
            5. استخدام البيانات
          </h2>
          <p className="mb-3 text-gray-700">قد نقوم بجمع بيانات أساسية مثل:</p>
          <ul className="list-disc list-inside space-y-1 text-gray-700 mr-4 mb-3">
            <li>الاسم</li>
            <li>رقم الهاتف</li>
            <li>الموقع الجغرافي</li>
            <li>تفاصيل الطلب</li>
          </ul>
          <div className="bg-sky-50 border border-sky-200 rounded-lg p-4">
            <p className="text-gray-700">
              وذلك <strong>فقط</strong> لغرض تشغيل الخدمة وتحسين تجربة المستخدم.
            </p>
            <p className="text-sky-700 font-bold mt-2">
               لا يتم بيع البيانات لأي طرف خارجي
            </p>
          </div>
        </section>

        {/* 6. النزاعات */}
        <section className="mb-6">
          <h2 className="text-xl font-semibold text-gray-900 mb-3 border-r-4 border-purple-500 pr-3">
            6. النزاعات
          </h2>
          <ul className="list-disc list-inside space-y-2 text-gray-700">
            <li>
              أي نزاع يتعلق بالطعام أو الخدمة يتم حله <strong>مباشرة</strong> بين
              العميل ومقدم الخدمة.
            </li>
            <li>
              دور التطبيق يقتصر على <strong className="text-sky-600">الوساطة التقنية فقط</strong>.
            </li>
          </ul>
        </section>

        {/* 7. الموافقة */}
        <section className="mb-6">
          <h2 className="text-xl font-semibold text-gray-900 mb-3 border-r-4 border-green-500 pr-3">
            7. الموافقة
          </h2>
          <div className="bg-green-50 border border-green-300 rounded-lg p-4">
            <p className="text-green-800">
              باستخدام التطبيق، فإنك <strong>توافق</strong> على هذه الشروط وتقر بأن
              التطبيق <strong>وسيط تقني فقط</strong> ولا يتحمل أي مسؤولية عن
              المنتجات المعروضة.
            </p>
          </div>
        </section>

        {/* التواصل */}
        <section className="mb-6">
          <h2 className="text-xl font-semibold text-gray-900 mb-3 border-r-4 border-sky-500 pr-3">
            8. تواصل معنا
          </h2>
          <div className="bg-sky-50 rounded-lg p-4">
            <p className="mb-2"> البريد الإلكتروني: <strong>afrtalbyt2026@gmail.com</strong></p>
            <p className="mb-2"> الجوال: <strong dir="ltr">0535534208</strong></p>
            <p> التطبيق: قسم الدعم والمساعدة</p>
          </div>
        </section>

        {/* الموافقة النهائية */}
        <div className="bg-amber-50 border-2 border-amber-400 rounded-lg p-4 mt-8 text-center">
          <p className="text-amber-800 font-bold text-lg">
             إقرار مهم
          </p>
          <p className="text-amber-700 mt-2">
            بالضغط على "موافق" أو باستخدام التطبيق، أنت تقر بأنك قرأت وفهمت سياسة
            الخصوصية وإخلاء المسؤولية وتوافق عليها بالكامل.
          </p>
        </div>

        <p className="mt-6 text-sm text-gray-500 text-center">
          تم آخر تحديث لهذه السياسة بتاريخ {new Date().toLocaleDateString("ar-SA")}
        </p>

        <div className="mt-8 flex flex-col sm:flex-row gap-3 justify-center">
          <Link
            to="/terms"
            className="text-white bg-sky-500 hover:bg-sky-600 px-6 py-3 rounded-lg inline-block transition-colors text-center font-bold"
          >
             الشروط والأحكام
          </Link>
          <Link
            to="/"
            className="text-sky-600 bg-sky-100 hover:bg-sky-200 px-6 py-3 rounded-lg inline-block transition-colors text-center"
          >
            الرجوع إلى الصفحة الرئيسية
          </Link>
        </div>
      </div>
    </div>
  );
}

==========================================================================================
FILE: src/pages/ProblemsAdmin.tsx
==========================================================================================
// src/pages/ProblemsAdmin.tsx
// لوحة تحكم لمراقبة المشاكل والشكاوى
import React, { useState, useEffect } from 'react'
import { 
  collection, query, orderBy, onSnapshot, getDocs, where
} from 'firebase/firestore'
import { db } from '@/firebase'
import { 
  AlertTriangle, Store, Truck, User, Star, TrendingDown,
  Loader2, ChevronRight, Filter, RefreshCw, BarChart3
} from 'lucide-react'

interface RestaurantStats {
  id: string
  name: string
  totalOrders: number
  complaintsCount: number
  avgRating: number
  lowRatings: number
}

interface CourierStats {
  id: string
  name: string
  totalDeliveries: number
  complaintsCount: number
  avgRating: number
  lowRatings: number
}

interface CustomerStats {
  id: string
  name: string
  totalOrders: number
  complaintsFiledCount: number
  avgRatingGiven: number
}

export const ProblemsAdmin: React.FC = () => {
  const [loading, setLoading] = useState(true)
  const [restaurants, setRestaurants] = useState<RestaurantStats[]>([])
  const [couriers, setCouriers] = useState<CourierStats[]>([])
  const [customers, setCustomers] = useState<CustomerStats[]>([])
  const [activeTab, setActiveTab] = useState<'restaurants' | 'couriers' | 'customers'>('restaurants')
  const [timeFilter, setTimeFilter] = useState<'week' | 'month' | 'all'>('month')

  useEffect(() => {
    loadStats()
  }, [timeFilter])

  const loadStats = async () => {
    setLoading(true)
    
    try {
      // جلب جميع الطلبات
      const ordersSnap = await getDocs(collection(db, 'orders'))
      const orders = ordersSnap.docs.map(d => ({ id: d.id, ...d.data() }))

      // تصفية حسب الوقت
      const now = new Date()
      const filteredOrders = orders.filter((o: any) => {
        if (timeFilter === 'all') return true
        const orderDate = o.createdAt?.toDate?.() || new Date(0)
        const diffDays = (now.getTime() - orderDate.getTime()) / (1000 * 60 * 60 * 24)
        if (timeFilter === 'week') return diffDays <= 7
        if (timeFilter === 'month') return diffDays <= 30
        return true
      })

      // إحصائيات الأسر
      const restaurantMap = new Map<string, RestaurantStats>()
      filteredOrders.forEach((o: any) => {
        const rId = o.restaurantId
        if (!rId) return
        
        if (!restaurantMap.has(rId)) {
          restaurantMap.set(rId, {
            id: rId,
            name: o.restaurantName || 'غير معروف',
            totalOrders: 0,
            complaintsCount: 0,
            avgRating: 0,
            lowRatings: 0
          })
        }
        
        const stats = restaurantMap.get(rId)!
        stats.totalOrders++
        
        // حساب التقييمات
        const rating = o.ratings?.customerToRestaurant?.stars
        if (rating) {
          if (rating <= 2) stats.lowRatings++
        }
      })

      // جلب الشكاوى
      const complaintsSnap = await getDocs(collection(db, 'supportChats'))
      const complaints = complaintsSnap.docs.map(d => d.data())

      // حساب عدد الشكاوى لكل أسرة
      complaints.forEach((c: any) => {
        // يمكن ربط الشكوى بالأسرة عبر الطلب
      })

      // ترتيب الأسر حسب المشاكل
      const sortedRestaurants = Array.from(restaurantMap.values())
        .sort((a, b) => b.lowRatings - a.lowRatings)

      setRestaurants(sortedRestaurants)

      // إحصائيات المندوبين
      const courierMap = new Map<string, CourierStats>()
      filteredOrders.forEach((o: any) => {
        const cId = o.courierId
        if (!cId) return
        
        if (!courierMap.has(cId)) {
          courierMap.set(cId, {
            id: cId,
            name: o.courierName || 'مندوب',
            totalDeliveries: 0,
            complaintsCount: 0,
            avgRating: 0,
            lowRatings: 0
          })
        }
        
        const stats = courierMap.get(cId)!
        stats.totalDeliveries++
        
        const rating = o.ratings?.customerToCourier?.stars
        if (rating) {
          if (rating <= 2) stats.lowRatings++
        }
      })

      const sortedCouriers = Array.from(courierMap.values())
        .sort((a, b) => b.lowRatings - a.lowRatings)

      setCouriers(sortedCouriers)

      // إحصائيات العملاء
      const customerMap = new Map<string, CustomerStats>()
      filteredOrders.forEach((o: any) => {
        const cId = o.customerId
        if (!cId) return
        
        if (!customerMap.has(cId)) {
          customerMap.set(cId, {
            id: cId,
            name: o.customerName || 'عميل',
            totalOrders: 0,
            complaintsFiledCount: 0,
            avgRatingGiven: 0
          })
        }
        
        const stats = customerMap.get(cId)!
        stats.totalOrders++
      })

      // حساب عدد الشكاوى المرفوعة من كل عميل
      complaints.forEach((c: any) => {
        const cId = c.userId
        if (customerMap.has(cId)) {
          customerMap.get(cId)!.complaintsFiledCount++
        }
      })

      const sortedCustomers = Array.from(customerMap.values())
        .sort((a, b) => b.complaintsFiledCount - a.complaintsFiledCount)

      setCustomers(sortedCustomers)

    } catch (error) {
      console.error('Error loading stats:', error)
    } finally {
      setLoading(false)
    }
  }

  if (loading) {
    return (
      <div className="flex items-center justify-center min-h-[60vh]">
        <Loader2 className="w-8 h-8 animate-spin text-sky-500" />
      </div>
    )
  }

  return (
    <div className="max-w-6xl mx-auto">
      <div className="flex items-center justify-between mb-6">
        <h1 className="text-2xl font-bold text-gray-800 flex items-center gap-3">
          <BarChart3 className="w-8 h-8 text-red-500" />
          مركز مراقبة المشاكل
        </h1>
        <button
          onClick={loadStats}
          className="p-2 bg-gray-100 rounded-xl hover:bg-gray-200 transition"
        >
          <RefreshCw className="w-5 h-5 text-gray-600" />
        </button>
      </div>

      {/* ملخص سريع */}
      <div className="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
        <div className="bg-gradient-to-br from-red-500 to-orange-500 rounded-2xl p-5 text-white">
          <div className="flex items-center gap-3 mb-2">
            <Store className="w-6 h-6" />
            <span className="font-bold">أسر بمشاكل</span>
          </div>
          <p className="text-3xl font-bold">{restaurants.filter(r => r.lowRatings > 0).length}</p>
          <p className="text-white/70 text-sm">من أصل {restaurants.length} أسرة</p>
        </div>
        
        <div className="bg-gradient-to-br from-amber-500 to-yellow-500 rounded-2xl p-5 text-white">
          <div className="flex items-center gap-3 mb-2">
            <Truck className="w-6 h-6" />
            <span className="font-bold">مندوبين بمشاكل</span>
          </div>
          <p className="text-3xl font-bold">{couriers.filter(c => c.lowRatings > 0).length}</p>
          <p className="text-white/70 text-sm">من أصل {couriers.length} مندوب</p>
        </div>
        
        <div className="bg-gradient-to-br from-purple-500 to-pink-500 rounded-2xl p-5 text-white">
          <div className="flex items-center gap-3 mb-2">
            <User className="w-6 h-6" />
            <span className="font-bold">عملاء كثيري الشكاوى</span>
          </div>
          <p className="text-3xl font-bold">{customers.filter(c => c.complaintsFiledCount > 2).length}</p>
          <p className="text-white/70 text-sm">أكثر من شكويتين</p>
        </div>
      </div>

      {/* فلتر الوقت */}
      <div className="flex gap-2 mb-6">
        {(['week', 'month', 'all'] as const).map((t) => (
          <button
            key={t}
            onClick={() => setTimeFilter(t)}
            className={`px-4 py-2 rounded-xl font-medium transition ${
              timeFilter === t 
                ? 'bg-sky-500 text-white' 
                : 'bg-gray-100 text-gray-600 hover:bg-gray-200'
            }`}
          >
            {t === 'week' ? 'آخر أسبوع' : t === 'month' ? 'آخر شهر' : 'الكل'}
          </button>
        ))}
      </div>

      {/* التبويبات */}
      <div className="flex gap-2 mb-6 overflow-x-auto">
        <button
          onClick={() => setActiveTab('restaurants')}
          className={`flex items-center gap-2 px-4 py-2 rounded-xl font-medium transition ${
            activeTab === 'restaurants' ? 'bg-red-500 text-white' : 'bg-gray-100 text-gray-600'
          }`}
        >
          <Store className="w-4 h-4" />
          الأسر المنتجة
        </button>
        <button
          onClick={() => setActiveTab('couriers')}
          className={`flex items-center gap-2 px-4 py-2 rounded-xl font-medium transition ${
            activeTab === 'couriers' ? 'bg-amber-500 text-white' : 'bg-gray-100 text-gray-600'
          }`}
        >
          <Truck className="w-4 h-4" />
          المندوبين
        </button>
        <button
          onClick={() => setActiveTab('customers')}
          className={`flex items-center gap-2 px-4 py-2 rounded-xl font-medium transition ${
            activeTab === 'customers' ? 'bg-purple-500 text-white' : 'bg-gray-100 text-gray-600'
          }`}
        >
          <User className="w-4 h-4" />
          العملاء
        </button>
      </div>

      {/* قائمة الأسر */}
      {activeTab === 'restaurants' && (
        <div className="bg-white rounded-2xl shadow-lg overflow-hidden">
          <div className="p-4 bg-red-50 border-b border-red-100">
            <h2 className="font-bold text-red-800 flex items-center gap-2">
              <AlertTriangle className="w-5 h-5" />
              الأسر الأكثر مشاكل (تقييمات منخفضة)
            </h2>
          </div>
          
          {restaurants.length === 0 ? (
            <div className="p-8 text-center text-gray-500">
              لا توجد بيانات
            </div>
          ) : (
            <div className="divide-y divide-gray-100">
              {restaurants.slice(0, 20).map((r, i) => (
                <div key={r.id} className={`p-4 flex items-center justify-between ${r.lowRatings > 0 ? 'bg-red-50' : ''}`}>
                  <div className="flex items-center gap-4">
                    <div className={`w-8 h-8 rounded-full flex items-center justify-center font-bold text-sm ${
                      r.lowRatings > 2 ? 'bg-red-500 text-white' : 
                      r.lowRatings > 0 ? 'bg-amber-500 text-white' : 
                      'bg-gray-200 text-gray-600'
                    }`}>
                      {i + 1}
                    </div>
                    <div>
                      <p className="font-bold text-gray-800">{r.name}</p>
                      <p className="text-sm text-gray-500">{r.totalOrders} طلب</p>
                    </div>
                  </div>
                  <div className="flex items-center gap-4">
                    {r.lowRatings > 0 && (
                      <div className="flex items-center gap-1 text-red-600">
                        <TrendingDown className="w-4 h-4" />
                        <span className="font-bold">{r.lowRatings}</span>
                        <span className="text-xs">تقييم سيء</span>
                      </div>
                    )}
                  </div>
                </div>
              ))}
            </div>
          )}
        </div>
      )}

      {/* قائمة المندوبين */}
      {activeTab === 'couriers' && (
        <div className="bg-white rounded-2xl shadow-lg overflow-hidden">
          <div className="p-4 bg-amber-50 border-b border-amber-100">
            <h2 className="font-bold text-amber-800 flex items-center gap-2">
              <AlertTriangle className="w-5 h-5" />
              المندوبين الأكثر مشاكل
            </h2>
          </div>
          
          {couriers.length === 0 ? (
            <div className="p-8 text-center text-gray-500">
              لا توجد بيانات
            </div>
          ) : (
            <div className="divide-y divide-gray-100">
              {couriers.slice(0, 20).map((c, i) => (
                <div key={c.id} className={`p-4 flex items-center justify-between ${c.lowRatings > 0 ? 'bg-amber-50' : ''}`}>
                  <div className="flex items-center gap-4">
                    <div className={`w-8 h-8 rounded-full flex items-center justify-center font-bold text-sm ${
                      c.lowRatings > 2 ? 'bg-red-500 text-white' : 
                      c.lowRatings > 0 ? 'bg-amber-500 text-white' : 
                      'bg-gray-200 text-gray-600'
                    }`}>
                      {i + 1}
                    </div>
                    <div>
                      <p className="font-bold text-gray-800">{c.name}</p>
                      <p className="text-sm text-gray-500">{c.totalDeliveries} توصيل</p>
                    </div>
                  </div>
                  <div className="flex items-center gap-4">
                    {c.lowRatings > 0 && (
                      <div className="flex items-center gap-1 text-amber-600">
                        <TrendingDown className="w-4 h-4" />
                        <span className="font-bold">{c.lowRatings}</span>
                        <span className="text-xs">تقييم سيء</span>
                      </div>
                    )}
                  </div>
                </div>
              ))}
            </div>
          )}
        </div>
      )}

      {/* قائمة العملاء */}
      {activeTab === 'customers' && (
        <div className="bg-white rounded-2xl shadow-lg overflow-hidden">
          <div className="p-4 bg-purple-50 border-b border-purple-100">
            <h2 className="font-bold text-purple-800 flex items-center gap-2">
              <AlertTriangle className="w-5 h-5" />
              العملاء كثيري الشكاوى
            </h2>
          </div>
          
          {customers.length === 0 ? (
            <div className="p-8 text-center text-gray-500">
              لا توجد بيانات
            </div>
          ) : (
            <div className="divide-y divide-gray-100">
              {customers.filter(c => c.complaintsFiledCount > 0).slice(0, 20).map((c, i) => (
                <div key={c.id} className={`p-4 flex items-center justify-between ${c.complaintsFiledCount > 2 ? 'bg-purple-50' : ''}`}>
                  <div className="flex items-center gap-4">
                    <div className={`w-8 h-8 rounded-full flex items-center justify-center font-bold text-sm ${
                      c.complaintsFiledCount > 3 ? 'bg-red-500 text-white' : 
                      c.complaintsFiledCount > 1 ? 'bg-amber-500 text-white' : 
                      'bg-gray-200 text-gray-600'
                    }`}>
                      {i + 1}
                    </div>
                    <div>
                      <p className="font-bold text-gray-800">{c.name}</p>
                      <p className="text-sm text-gray-500">{c.totalOrders} طلب</p>
                    </div>
                  </div>
                  <div className="flex items-center gap-4">
                    <div className="flex items-center gap-1 text-purple-600">
                      <AlertTriangle className="w-4 h-4" />
                      <span className="font-bold">{c.complaintsFiledCount}</span>
                      <span className="text-xs">شكوى</span>
                    </div>
                  </div>
                </div>
              ))}
            </div>
          )}
        </div>
      )}

      {/* تنبيه */}
      <div className="mt-6 bg-amber-50 border border-amber-200 rounded-xl p-4 text-center">
        <p className="text-amber-800">
           <strong>نصيحة:</strong> راقب هذه الصفحة بشكل دوري لاكتشاف المشاكل مبكراً
        </p>
      </div>
    </div>
  )
}

export default ProblemsAdmin

==========================================================================================
FILE: src/pages/ProfileEdit.tsx
==========================================================================================
// src/pages/ProfileEdit.tsx
import React, { useEffect, useState, useRef } from "react"
import { db, storage } from "@/firebase"
import { useAuth } from "@/auth"
import { doc, getDoc, updateDoc } from "firebase/firestore"
import { ref, uploadBytes, getDownloadURL } from "firebase/storage"
import { useDialog } from '@/components/ui/ConfirmDialog'
import { useToast } from '@/components/ui/Toast'
import { LocationPicker } from '@/components/LocationPicker'
import { User, MapPin, Phone, Building2, Home, Save, RefreshCw, Navigation, Trash2, Plus, Star, Check, Camera, Upload, X, History, ShoppingBag, Heart, Bell } from 'lucide-react'
import { Link } from 'react-router-dom'

type SavedLocation = { lat: number; lng: number; address: string; label?: string }

export const ProfileEdit: React.FC = () => {
  const { user, role } = useAuth()
  const dialog = useDialog()
  const toast = useToast()
  const fileInputRef = useRef<HTMLInputElement>(null)
  const [form, setForm] = useState({
    name: "",
    phone: "",
    city: "",
    address: "",
    restaurantName: ""
  })
  // صورة البروفايل
  const [photoUrl, setPhotoUrl] = useState<string | null>(null)
  const [uploadingPhoto, setUploadingPhoto] = useState(false)
  // إحصائيات العميل
  const [stats, setStats] = useState({
    totalOrders: 0,
    favoriteRestaurants: 0,
    pendingOrders: 0
  })
  // دعم عناوين متعددة
  const [savedLocations, setSavedLocations] = useState<SavedLocation[]>([])
  const [defaultLocationIndex, setDefaultLocationIndex] = useState<number>(0)
  const [showLocationPicker, setShowLocationPicker] = useState(false)
  const [editingLocationIndex, setEditingLocationIndex] = useState<number | null>(null)
  const [newLocationLabel, setNewLocationLabel] = useState('')
  const [loading, setLoading] = useState(true)
  const [saving, setSaving] = useState(false)

  // تحميل البيانات الحالية
  useEffect(() => {
    if (!user) return
    const load = async () => {
      const snap = await getDoc(doc(db, "users", user.uid))
      if (snap.exists()) {
        const data = snap.data()
        setForm({
          name: data.name || "",
          phone: data.phone || user.phoneNumber || "",
          city: data.city || "",
          address: data.address || "",
          restaurantName: data.restaurantName || ""
        })
        setPhotoUrl(data.photoUrl || null)
        // تحميل العناوين المحفوظة (دعم التنسيق القديم والجديد)
        if (data.savedLocations && Array.isArray(data.savedLocations)) {
          setSavedLocations(data.savedLocations)
          setDefaultLocationIndex(data.defaultLocationIndex || 0)
        } else if (data.savedLocation) {
          // تحويل التنسيق القديم (عنوان واحد) للجديد (قائمة عناوين)
          setSavedLocations([{ ...data.savedLocation, label: 'المنزل' }])
          setDefaultLocationIndex(0)
        }
      }
      
      // جلب إحصائيات العميل
      if (role === 'customer') {
        try {
          const { collection, query, where, getDocs } = await import('firebase/firestore')
          // عدد الطلبات الكلي
          const ordersQuery = query(collection(db, 'orders'), where('customerId', '==', user.uid))
          const ordersSnap = await getDocs(ordersQuery)
          const pendingOrders = ordersSnap.docs.filter(d => ['pending', 'accepted', 'preparing', 'ready', 'out_for_delivery'].includes(d.data().status)).length
          
          // عدد المتاجر المتابَعة
          const followsQuery = query(collection(db, 'storeFollowers'), where('followerId', '==', user.uid))
          const followsSnap = await getDocs(followsQuery)
          
          setStats({
            totalOrders: ordersSnap.size,
            favoriteRestaurants: followsSnap.size,
            pendingOrders
          })
        } catch (err) {
          console.warn('Error loading stats:', err)
        }
      }
      
      setLoading(false)
    }
    load()
  }, [user, role])

  // حفظ التعديلات
  const save = async (e: React.FormEvent) => {
    e.preventDefault()
    if (!user) return
    
    setSaving(true)
    try {
      // حفظ العنوان الافتراضي كـ savedLocation للتوافق مع auth.tsx
      const defaultLoc = savedLocations[defaultLocationIndex] || null
      
      await updateDoc(doc(db, "users", user.uid), {
        name: form.name,
        phone: form.phone,
        city: form.city,
        address: form.address,
        photoUrl: photoUrl,
        savedLocation: defaultLoc, // العنوان الافتراضي للتوافق
        savedLocations: savedLocations, // قائمة كل العناوين
        defaultLocationIndex: defaultLocationIndex,
        ...(role === 'owner' && { restaurantName: form.restaurantName })
      })
      dialog.success('تم تحديث بياناتك بنجاح! ')
    } catch (err) {
      dialog.error('فشل في حفظ البيانات')
    } finally {
      setSaving(false)
    }
  }

  // رفع صورة البروفايل
  const handlePhotoUpload = async (e: React.ChangeEvent<HTMLInputElement>) => {
    const file = e.target.files?.[0]
    if (!file || !user) return
    
    // التحقق من نوع الملف
    if (!file.type.startsWith('image/')) {
      toast.error('الرجاء اختيار صورة صالحة')
      return
    }
    
    // التحقق من حجم الملف (أقصى 5 MB)
    if (file.size > 5 * 1024 * 1024) {
      toast.error('حجم الصورة يجب أن يكون أقل من 5 ميجابايت')
      return
    }
    
    setUploadingPhoto(true)
    try {
      const fileRef = ref(storage, `users/${user.uid}/profile.${file.name.split('.').pop()}`)
      await uploadBytes(fileRef, file)
      const url = await getDownloadURL(fileRef)
      setPhotoUrl(url)
      toast.success('تم رفع الصورة! اضغط حفظ لتأكيد التغييرات')
    } catch (err) {
      console.error('Error uploading photo:', err)
      toast.error('فشل في رفع الصورة')
    } finally {
      setUploadingPhoto(false)
    }
  }

  // حذف صورة البروفايل
  const handleRemovePhoto = () => {
    setPhotoUrl(null)
    toast.info('تم حذف الصورة! اضغط حفظ لتأكيد التغييرات')
  }

  // إضافة عنوان جديد
  const handleAddLocation = (loc: { lat: number; lng: number }, addr: string) => {
    const newLoc: SavedLocation = {
      lat: loc.lat,
      lng: loc.lng,
      address: addr,
      label: newLocationLabel || `عنوان ${savedLocations.length + 1}`
    }
    setSavedLocations([...savedLocations, newLoc])
    setNewLocationLabel('')
    setShowLocationPicker(false)
    toast.success('تم إضافة العنوان! اضغط حفظ لتأكيد التغييرات')
  }

  // تعديل عنوان موجود
  const handleEditLocation = (loc: { lat: number; lng: number }, addr: string) => {
    if (editingLocationIndex === null) return
    const updated = [...savedLocations]
    updated[editingLocationIndex] = {
      ...updated[editingLocationIndex],
      lat: loc.lat,
      lng: loc.lng,
      address: addr
    }
    setSavedLocations(updated)
    setEditingLocationIndex(null)
    setShowLocationPicker(false)
    toast.success('تم تحديث العنوان! اضغط حفظ لتأكيد التغييرات')
  }

  // حذف عنوان
  const handleDeleteLocation = async (index: number) => {
    const confirmed = await dialog.confirm('هل تريد حذف هذا العنوان؟')
    if (!confirmed) return
    
    const updated = savedLocations.filter((_, i) => i !== index)
    setSavedLocations(updated)
    
    // تحديث الفهرس الافتراضي
    if (defaultLocationIndex >= updated.length) {
      setDefaultLocationIndex(Math.max(0, updated.length - 1))
    } else if (defaultLocationIndex > index) {
      setDefaultLocationIndex(defaultLocationIndex - 1)
    }
    
    toast.info('تم حذف العنوان')
  }

  // تعيين عنوان كافتراضي
  const handleSetDefault = (index: number) => {
    setDefaultLocationIndex(index)
    toast.success('تم تعيين العنوان كافتراضي')
  }

  if (loading) {
    return (
      <div className="flex items-center justify-center h-96 text-lg">
        <RefreshCw className="w-6 h-6 animate-spin ml-2" />
        جارِ تحميل البيانات...
      </div>
    )
  }

  // تحديد العنوان حسب الدور
  const getTitle = () => {
    if (role === 'owner') return 'تعديل بيانات المطعم'
    if (role === 'courier') return 'تعديل بيانات المندوب'
    if (role === 'admin') return 'تعديل بيانات المشرف'
    return 'تعديل بياناتي'
  }

  return (
    <div className="max-w-md mx-auto py-8 px-4">
      <div className="bg-white rounded-2xl shadow-xl p-6">
        {/* العنوان مع صورة البروفايل */}
        <div className="flex flex-col items-center gap-4 mb-6">
          {/* صورة البروفايل */}
          <div className="relative group">
            <div className="w-24 h-24 rounded-full overflow-hidden bg-sky-100 border-4 border-sky-200 shadow-lg">
              {photoUrl ? (
                <img src={photoUrl} alt="صورتي" className="w-full h-full object-cover" />
              ) : (
                <div className="w-full h-full flex items-center justify-center">
                  <User className="w-12 h-12 text-sky-400" />
                </div>
              )}
            </div>
            
            {/* زر تغيير الصورة */}
            <button
              type="button"
              onClick={() => fileInputRef.current?.click()}
              disabled={uploadingPhoto}
              className="absolute bottom-0 right-0 w-8 h-8 bg-sky-500 hover:bg-sky-600 text-white rounded-full shadow-lg flex items-center justify-center transition disabled:opacity-50"
            >
              {uploadingPhoto ? (
                <RefreshCw className="w-4 h-4 animate-spin" />
              ) : (
                <Camera className="w-4 h-4" />
              )}
            </button>
            
            {/* زر حذف الصورة */}
            {photoUrl && (
              <button
                type="button"
                onClick={handleRemovePhoto}
                className="absolute top-0 right-0 w-6 h-6 bg-red-500 hover:bg-red-600 text-white rounded-full shadow-lg flex items-center justify-center transition opacity-0 group-hover:opacity-100"
              >
                <X className="w-3 h-3" />
              </button>
            )}
            
            <input
              ref={fileInputRef}
              type="file"
              accept="image/*"
              onChange={handlePhotoUpload}
              className="hidden"
            />
          </div>
          
          <div className="text-center">
            <h1 className="text-xl font-bold text-gray-800">{getTitle()}</h1>
            <p className="text-sm text-gray-500">{user?.email || user?.phoneNumber}</p>
          </div>
        </div>

        {/*  إحصائيات سريعة للعميل */}
        {role === 'customer' && (
          <div className="grid grid-cols-3 gap-3 mb-6">
            <Link 
              to="/orders"
              className="bg-sky-50 rounded-xl p-3 text-center hover:bg-sky-100 transition"
            >
              <ShoppingBag className="w-6 h-6 text-sky-500 mx-auto mb-1" />
              <p className="text-2xl font-black text-sky-600">{stats.totalOrders}</p>
              <p className="text-xs text-gray-500">طلباتي</p>
            </Link>
            
            <div className="bg-pink-50 rounded-xl p-3 text-center">
              <Heart className="w-6 h-6 text-pink-500 mx-auto mb-1" />
              <p className="text-2xl font-black text-pink-600">{stats.favoriteRestaurants}</p>
              <p className="text-xs text-gray-500">متابَع</p>
            </div>
            
            <Link 
              to="/orders"
              className="bg-amber-50 rounded-xl p-3 text-center hover:bg-amber-100 transition"
            >
              <History className="w-6 h-6 text-amber-500 mx-auto mb-1" />
              <p className="text-2xl font-black text-amber-600">{stats.pendingOrders}</p>
              <p className="text-xs text-gray-500">قيد التنفيذ</p>
            </Link>
          </div>
        )}

        {/*  روابط سريعة للعميل */}
        {role === 'customer' && (
          <div className="flex gap-2 mb-6">
            <Link
              to="/notifications"
              className="flex-1 flex items-center justify-center gap-2 py-3 bg-gray-100 hover:bg-gray-200 rounded-xl transition text-gray-700 font-medium"
            >
              <Bell className="w-5 h-5" />
              الإشعارات
            </Link>
            <Link
              to="/orders"
              className="flex-1 flex items-center justify-center gap-2 py-3 bg-gray-100 hover:bg-gray-200 rounded-xl transition text-gray-700 font-medium"
            >
              <ShoppingBag className="w-5 h-5" />
              طلباتي
            </Link>
          </div>
        )}

        <form onSubmit={save} className="space-y-4">
          {/* الاسم */}
          <div>
            <label className="block text-sm font-semibold text-gray-700 mb-1">
              <User className="w-4 h-4 inline ml-1" />
              الاسم الكامل
            </label>
            <input
              className="w-full border-2 border-gray-200 rounded-xl p-3 focus:border-sky-400 focus:outline-none transition"
              placeholder="أدخل اسمك"
              value={form.name}
              onChange={(e) => setForm({ ...form, name: e.target.value })}
            />
          </div>

          {/* رقم الجوال */}
          <div>
            <label className="block text-sm font-semibold text-gray-700 mb-1">
              <Phone className="w-4 h-4 inline ml-1" />
              رقم الجوال
            </label>
            <input
              className="w-full border-2 border-gray-200 rounded-xl p-3 focus:border-sky-400 focus:outline-none transition"
              placeholder="05xxxxxxxx"
              value={form.phone}
              onChange={(e) => setForm({ ...form, phone: e.target.value })}
              dir="ltr"
            />
          </div>

          {/* المدينة */}
          <div>
            <label className="block text-sm font-semibold text-gray-700 mb-1">
              <Building2 className="w-4 h-4 inline ml-1" />
              المدينة
            </label>
            <input
              className="w-full border-2 border-gray-200 rounded-xl p-3 focus:border-sky-400 focus:outline-none transition"
              placeholder="مثال: الرياض"
              value={form.city}
              onChange={(e) => setForm({ ...form, city: e.target.value })}
            />
          </div>

          {/* العنوان / الموقع */}
          <div>
            <label className="block text-sm font-semibold text-gray-700 mb-1">
              <MapPin className="w-4 h-4 inline ml-1" />
              العنوان التفصيلي
            </label>
            <textarea
              className="w-full border-2 border-gray-200 rounded-xl p-3 focus:border-sky-400 focus:outline-none transition h-24"
              placeholder="الحي، الشارع، رقم المبنى، معلومات إضافية..."
              value={form.address}
              onChange={(e) => setForm({ ...form, address: e.target.value })}
            />
          </div>

          {/*  العناوين المحفوظة للتوصيل - للعملاء والمشرفين فقط */}
          {(role === 'customer' || role === 'admin') && (
            <div className="border-t pt-4 mt-4">
              <div className="flex items-center justify-between mb-3">
                <label className="text-sm font-semibold text-gray-700 flex items-center gap-1">
                  <Navigation className="w-4 h-4" />
                  عناوين التوصيل المحفوظة
                </label>
                <span className="text-xs text-gray-400">{savedLocations.length}/5</span>
              </div>
              
              {/* قائمة العناوين */}
              {savedLocations.length > 0 && (
                <div className="space-y-3 mb-4">
                  {savedLocations.map((loc, index) => (
                    <div 
                      key={index}
                      className={`rounded-xl p-3 border-2 transition ${
                        index === defaultLocationIndex 
                          ? 'bg-green-50 border-green-300' 
                          : 'bg-gray-50 border-gray-200'
                      }`}
                    >
                      <div className="flex items-start gap-3">
                        <div className={`w-10 h-10 rounded-xl flex items-center justify-center flex-shrink-0 ${
                          index === defaultLocationIndex ? 'bg-green-500' : 'bg-gray-400'
                        }`}>
                          <MapPin className="w-5 h-5 text-white" />
                        </div>
                        <div className="flex-1 min-w-0">
                          <div className="flex items-center gap-2 mb-1">
                            <p className="font-bold text-gray-800">{loc.label || `عنوان ${index + 1}`}</p>
                            {index === defaultLocationIndex && (
                              <span className="inline-flex items-center gap-1 px-2 py-0.5 bg-green-500 text-white text-xs font-bold rounded-full">
                                <Star className="w-3 h-3" /> افتراضي
                              </span>
                            )}
                          </div>
                          <p className="text-sm text-gray-600 line-clamp-2">{loc.address}</p>
                        </div>
                      </div>
                      
                      {/* أزرار الإجراءات */}
                      <div className="flex gap-2 mt-3">
                        {index !== defaultLocationIndex && (
                          <button
                            type="button"
                            onClick={() => handleSetDefault(index)}
                            className="flex-1 py-2 px-3 rounded-lg border border-green-200 text-green-600 text-xs font-medium hover:bg-green-50 transition flex items-center justify-center gap-1"
                          >
                            <Check className="w-3 h-3" /> تعيين كافتراضي
                          </button>
                        )}
                        <button
                          type="button"
                          onClick={() => {
                            setEditingLocationIndex(index)
                            setShowLocationPicker(true)
                          }}
                          className="flex-1 py-2 px-3 rounded-lg border border-sky-200 text-sky-600 text-xs font-medium hover:bg-sky-50 transition"
                        >
                          تعديل
                        </button>
                        <button
                          type="button"
                          onClick={() => handleDeleteLocation(index)}
                          className="py-2 px-3 rounded-lg border border-red-200 text-red-500 hover:bg-red-50 transition"
                        >
                          <Trash2 className="w-4 h-4" />
                        </button>
                      </div>
                    </div>
                  ))}
                </div>
              )}

              {/* زر إضافة عنوان جديد */}
              {savedLocations.length < 5 && (
                <div className="space-y-2">
                  <input
                    type="text"
                    value={newLocationLabel}
                    onChange={(e) => setNewLocationLabel(e.target.value)}
                    placeholder="اسم العنوان (مثال: المنزل، العمل...)"
                    className="w-full border-2 border-gray-200 rounded-xl p-3 text-sm focus:border-sky-400 focus:outline-none"
                  />
                  <button
                    type="button"
                    onClick={() => {
                      setEditingLocationIndex(null)
                      setShowLocationPicker(true)
                    }}
                    className="w-full py-4 rounded-xl bg-gradient-to-r from-sky-100 to-sky-50 border-2 border-dashed border-sky-300 text-sky-600 font-semibold hover:border-sky-400 transition flex items-center justify-center gap-3"
                  >
                    <Plus className="w-5 h-5" />
                    <span>إضافة عنوان جديد</span>
                  </button>
                </div>
              )}

              {savedLocations.length === 0 && (
                <p className="text-xs text-gray-500 mt-2 text-center">
                   أضف عناوينك المفضلة لتسهيل الطلب
                </p>
              )}
            </div>
          )}

          {/* اسم المطعم - لصاحب المطعم فقط */}
          {role === 'owner' && (
            <div>
              <label className="block text-sm font-semibold text-gray-700 mb-1">
                <Home className="w-4 h-4 inline ml-1" />
                اسم المطعم
              </label>
              <input
                className="w-full border-2 border-gray-200 rounded-xl p-3 focus:border-sky-400 focus:outline-none transition"
                placeholder="اسم المطعم"
                value={form.restaurantName}
                onChange={(e) => setForm({ ...form, restaurantName: e.target.value })}
              />
            </div>
          )}

          {/* زر الحفظ */}
          <button 
            type="submit"
            disabled={saving}
            className="w-full flex items-center justify-center gap-2 bg-gradient-to-r from-sky-500 to-sky-600 hover:from-sky-600 hover:to-sky-700 text-white font-bold p-4 rounded-xl shadow-lg transition disabled:opacity-50"
          >
            {saving ? (
              <>
                <RefreshCw className="w-5 h-5 animate-spin" />
                جارِ الحفظ...
              </>
            ) : (
              <>
                <Save className="w-5 h-5" />
                حفظ التعديلات
              </>
            )}
          </button>
        </form>

        {/* معلومات إضافية */}
        <div className="mt-6 pt-4 border-t text-center text-sm text-gray-500">
          <p> يمكنك تعديل بياناتك في أي وقت</p>
          {(role === 'customer' || role === 'admin') && (
            <p className="mt-1"> يمكنك حفظ حتى 5 عناوين مختلفة</p>
          )}
        </div>
      </div>

      {/* Location Picker Modal */}
      <LocationPicker
        isOpen={showLocationPicker}
        onClose={() => {
          setShowLocationPicker(false)
          setEditingLocationIndex(null)
        }}
        onConfirm={(loc, addr) => {
          if (editingLocationIndex !== null) {
            handleEditLocation(loc, addr)
          } else {
            handleAddLocation(loc, addr)
          }
        }}
        initialLocation={
          editingLocationIndex !== null && savedLocations[editingLocationIndex]
            ? { lat: savedLocations[editingLocationIndex].lat, lng: savedLocations[editingLocationIndex].lng }
            : null
        }
      />
    </div>
  )
}

==========================================================================================
FILE: src/pages/PromotionPage.tsx
==========================================================================================
// src/pages/PromotionPage.tsx
import React, { useEffect, useState, useRef } from 'react'
import { db, storage } from '@/firebase'
import { collection, query, where, getDocs, addDoc, updateDoc, deleteDoc, doc, serverTimestamp, Timestamp } from 'firebase/firestore'
import { ref, uploadBytesResumable, getDownloadURL } from 'firebase/storage'
import { useAuth } from '@/auth'
import { useToast } from '@/components/ui/Toast'
import { useDialog } from '@/components/ui/ConfirmDialog'
import { Promotion } from '@/types'
import { 
  Megaphone, Image, Video, FileText, Plus, Trash2, Eye, 
  Clock, CheckCircle, XCircle, Upload, Sparkles, RefreshCw,
  ArrowRight
} from 'lucide-react'
import { Link } from 'react-router-dom'

// سعر الإعلان الرمزي (5 ريال لـ 24 ساعة)
const PROMOTION_PRICE = 5
const PROMOTION_DURATION_HOURS = 24

export const PromotionPage: React.FC = () => {
  const { user } = useAuth()
  const toast = useToast()
  const dialog = useDialog()
  const [promotions, setPromotions] = useState<Promotion[]>([])
  const [loading, setLoading] = useState(true)
  const [showForm, setShowForm] = useState(false)
  const [uploading, setUploading] = useState(false)
  const [uploadProgress, setUploadProgress] = useState(0)
  const fileRef = useRef<HTMLInputElement>(null)

  const [form, setForm] = useState({
    type: 'text' as 'text' | 'image' | 'video',
    title: '',
    description: '',
    mediaFile: null as File | null,
    mediaPreview: '',
  })

  // تحميل الإعلانات
  useEffect(() => {
    if (!user) return
    loadPromotions()
  }, [user])

  const loadPromotions = async () => {
    if (!user) return
    try {
      const q = query(collection(db, 'promotions'), where('ownerId', '==', user.uid))
      const snap = await getDocs(q)
      const data = snap.docs.map(d => ({
        id: d.id,
        ...d.data(),
        expiresAt: d.data().expiresAt?.toDate?.(),
        createdAt: d.data().createdAt?.toDate?.(),
      } as Promotion))
      // ترتيب حسب الأحدث
      data.sort((a, b) => (b.createdAt?.getTime() || 0) - (a.createdAt?.getTime() || 0))
      setPromotions(data)
    } catch (err) {
      toast.error('خطأ في تحميل الإعلانات')
      console.error(err)
    } finally {
      setLoading(false)
    }
  }

  // التحقق من انتهاء الإعلان
  const isExpired = (promo: Promotion) => {
    if (!promo.expiresAt) return false
    return new Date() > new Date(promo.expiresAt)
  }

  // اختيار ملف الوسائط
  const handleFileSelect = (e: React.ChangeEvent<HTMLInputElement>) => {
    const file = e.target.files?.[0]
    if (!file) return

    // التحقق من نوع الملف
    const isImage = file.type.startsWith('image/')
    const isVideo = file.type.startsWith('video/')

    if (!isImage && !isVideo) {
      toast.warning('يرجى اختيار صورة أو فيديو')
      return
    }

    // التحقق من حجم الملف (10 ميجا للصور، 50 ميجا للفيديو)
    const maxSize = isVideo ? 50 * 1024 * 1024 : 10 * 1024 * 1024
    if (file.size > maxSize) {
      toast.warning(isVideo ? 'حجم الفيديو يجب أن يكون أقل من 50 ميجا' : 'حجم الصورة يجب أن يكون أقل من 10 ميجا')
      return
    }

    setForm({
      ...form,
      type: isVideo ? 'video' : 'image',
      mediaFile: file,
      mediaPreview: URL.createObjectURL(file),
    })
  }

  // إضافة إعلان جديد
  const handleSubmit = async (e: React.FormEvent) => {
    e.preventDefault()
    if (!user) return

    if (form.type !== 'text' && !form.mediaFile) {
      toast.warning('يرجى اختيار صورة أو فيديو')
      return
    }

    if (!form.title.trim() && !form.description.trim() && !form.mediaFile) {
      toast.warning('يرجى إضافة محتوى للإعلان')
      return
    }

    try {
      setUploading(true)
      let mediaUrl = ''

      // رفع الوسائط
      if (form.mediaFile) {
        const safeName = form.mediaFile.name.replace(/\s+/g, '_').slice(-60)
        const path = `promotions/${user.uid}_${Date.now()}_${safeName}`
        const storageRef = ref(storage, path)

        const task = uploadBytesResumable(storageRef, form.mediaFile)

        await new Promise<void>((resolve, reject) => {
          task.on(
            'state_changed',
            (snap) => {
              const progress = Math.round((snap.bytesTransferred / snap.totalBytes) * 100)
              setUploadProgress(progress)
            },
            reject,
            async () => {
              mediaUrl = await getDownloadURL(task.snapshot.ref)
              resolve()
            }
          )
        })
      }

      // حساب تاريخ الانتهاء
      const expiresAt = new Date()
      expiresAt.setHours(expiresAt.getHours() + PROMOTION_DURATION_HOURS)

      await addDoc(collection(db, 'promotions'), {
        ownerId: user.uid,
        restaurantId: user.uid, // نفس الـ UID للأسرة
        type: form.type,
        title: form.title.trim(),
        description: form.description.trim(),
        mediaUrl,
        isActive: true,
        isPaid: true, // مؤقتاً نفترض الدفع تم (يمكن إضافة بوابة دفع لاحقاً)
        price: PROMOTION_PRICE,
        duration: PROMOTION_DURATION_HOURS,
        viewsCount: 0,
        expiresAt: Timestamp.fromDate(expiresAt),
        createdAt: serverTimestamp(),
        updatedAt: serverTimestamp(),
      })

      toast.success(`تم نشر إعلانك!  سيظهر لمدة ${PROMOTION_DURATION_HOURS} ساعة`)
      setForm({ type: 'text', title: '', description: '', mediaFile: null, mediaPreview: '' })
      setShowForm(false)
      setUploadProgress(0)
      loadPromotions()
    } catch (err) {
      toast.error('حدث خطأ في نشر الإعلان')
      console.error(err)
    } finally {
      setUploading(false)
    }
  }

  // حذف إعلان
  const handleDelete = async (id: string) => {
    const confirmed = await dialog.confirm('هل تريد حذف هذا الإعلان؟', { dangerous: true })
    if (!confirmed) return

    try {
      await deleteDoc(doc(db, 'promotions', id))
      toast.success('تم حذف الإعلان')
      loadPromotions()
    } catch (err) {
      toast.error('حدث خطأ')
    }
  }

  if (loading) {
    return (
      <div className="flex items-center justify-center h-96">
        <RefreshCw className="w-6 h-6 animate-spin ml-2" />
        جارِ التحميل...
      </div>
    )
  }

  return (
    <div className="max-w-2xl mx-auto py-8 px-4 space-y-6">
      {/* العنوان */}
      <div className="text-center">
        <div className="w-16 h-16 bg-gradient-to-br from-purple-500 to-pink-500 rounded-2xl flex items-center justify-center mx-auto mb-4 shadow-lg">
          <Megaphone className="w-8 h-8 text-white" />
        </div>
        <h1 className="text-2xl font-bold text-gray-800">الإعلانات الممولة</h1>
        <p className="text-gray-500 mt-2">أنشئ إعلانك وسيظهر للعملاء في صفحة أسرتك</p>
      </div>

      {/* سعر الإعلان */}
      <div className="bg-gradient-to-r from-purple-50 to-pink-50 border border-purple-200 rounded-2xl p-4 text-center">
        <div className="flex items-center justify-center gap-3">
          <Sparkles className="w-5 h-5 text-purple-500" />
          <span className="text-lg font-bold text-purple-700">
            {PROMOTION_PRICE} ر.س فقط لمدة {PROMOTION_DURATION_HOURS} ساعة
          </span>
          <Sparkles className="w-5 h-5 text-purple-500" />
        </div>
        <p className="text-sm text-purple-600 mt-1">أضف صورة أو فيديو أو نص ترويجي لأسرتك</p>
      </div>

      {/* زر إضافة إعلان */}
      {!showForm && (
        <button
          onClick={() => setShowForm(true)}
          className="w-full py-4 rounded-2xl bg-gradient-to-r from-purple-500 to-pink-500 text-white font-bold shadow-lg hover:shadow-xl transition flex items-center justify-center gap-3"
        >
          <Plus className="w-6 h-6" />
          إنشاء إعلان جديد
        </button>
      )}

      {/* نموذج الإعلان */}
      {showForm && (
        <form onSubmit={handleSubmit} className="bg-white rounded-2xl shadow-xl p-6 space-y-4">
          <h2 className="font-bold text-lg text-gray-800 mb-4">إنشاء إعلان جديد</h2>

          {/* نوع الإعلان */}
          <div>
            <label className="block text-sm font-semibold text-gray-700 mb-2">نوع الإعلان</label>
            <div className="grid grid-cols-3 gap-2">
              <button
                type="button"
                onClick={() => setForm({ ...form, type: 'text', mediaFile: null, mediaPreview: '' })}
                className={`p-3 rounded-xl border-2 transition flex flex-col items-center gap-1 ${
                  form.type === 'text' ? 'border-purple-500 bg-purple-50' : 'border-gray-200'
                }`}
              >
                <FileText className="w-5 h-5" />
                <span className="text-sm">نص</span>
              </button>
              <button
                type="button"
                onClick={() => {
                  setForm({ ...form, type: 'image' })
                  fileRef.current?.click()
                }}
                className={`p-3 rounded-xl border-2 transition flex flex-col items-center gap-1 ${
                  form.type === 'image' ? 'border-purple-500 bg-purple-50' : 'border-gray-200'
                }`}
              >
                <Image className="w-5 h-5" />
                <span className="text-sm">صورة</span>
              </button>
              <button
                type="button"
                onClick={() => {
                  setForm({ ...form, type: 'video' })
                  fileRef.current?.click()
                }}
                className={`p-3 rounded-xl border-2 transition flex flex-col items-center gap-1 ${
                  form.type === 'video' ? 'border-purple-500 bg-purple-50' : 'border-gray-200'
                }`}
              >
                <Video className="w-5 h-5" />
                <span className="text-sm">فيديو</span>
              </button>
            </div>
          </div>

          {/* رفع الوسائط */}
          <input
            type="file"
            ref={fileRef}
            accept="image/*,video/*"
            onChange={handleFileSelect}
            className="hidden"
          />

          {/* معاينة الوسائط */}
          {form.mediaPreview && (
            <div className="relative">
              {form.type === 'video' ? (
                <video
                  src={form.mediaPreview}
                  controls
                  className="w-full h-48 object-cover rounded-xl"
                />
              ) : (
                <img
                  src={form.mediaPreview}
                  alt="معاينة"
                  className="w-full h-48 object-cover rounded-xl"
                />
              )}
              <button
                type="button"
                onClick={() => setForm({ ...form, mediaFile: null, mediaPreview: '', type: 'text' })}
                className="absolute top-2 left-2 p-2 bg-red-500 text-white rounded-full"
              >
                <XCircle className="w-4 h-4" />
              </button>
            </div>
          )}

          {/* زر اختيار ملف */}
          {form.type !== 'text' && !form.mediaPreview && (
            <button
              type="button"
              onClick={() => fileRef.current?.click()}
              className="w-full py-4 border-2 border-dashed border-gray-300 rounded-xl text-gray-500 hover:border-purple-400 transition flex items-center justify-center gap-2"
            >
              <Upload className="w-5 h-5" />
              اختر {form.type === 'video' ? 'فيديو' : 'صورة'}
            </button>
          )}

          {/* العنوان */}
          <div>
            <label className="block text-sm font-semibold text-gray-700 mb-1">العنوان (اختياري)</label>
            <input
              type="text"
              value={form.title}
              onChange={(e) => setForm({ ...form, title: e.target.value })}
              placeholder="مثال: عرض خاص اليوم!"
              className="w-full border-2 border-gray-200 rounded-xl p-3 focus:border-purple-400 focus:outline-none"
            />
          </div>

          {/* الوصف */}
          <div>
            <label className="block text-sm font-semibold text-gray-700 mb-1">الشرح أو الوصف</label>
            <textarea
              value={form.description}
              onChange={(e) => setForm({ ...form, description: e.target.value })}
              placeholder="اكتب تفاصيل إعلانك هنا..."
              rows={3}
              className="w-full border-2 border-gray-200 rounded-xl p-3 focus:border-purple-400 focus:outline-none"
            />
          </div>

          {/* شريط التقدم */}
          {uploading && uploadProgress > 0 && (
            <div className="bg-gray-200 rounded-full h-2 overflow-hidden">
              <div
                className="bg-purple-500 h-full transition-all"
                style={{ width: `${uploadProgress}%` }}
              />
            </div>
          )}

          {/* أزرار */}
          <div className="flex gap-3">
            <button
              type="submit"
              disabled={uploading}
              className="flex-1 py-3 rounded-xl bg-gradient-to-r from-purple-500 to-pink-500 text-white font-bold disabled:opacity-50 flex items-center justify-center gap-2"
            >
              {uploading ? (
                <>
                  <RefreshCw className="w-5 h-5 animate-spin" />
                  جارِ النشر...
                </>
              ) : (
                <>
                  <Megaphone className="w-5 h-5" />
                  نشر الإعلان ({PROMOTION_PRICE} ر.س)
                </>
              )}
            </button>
            <button
              type="button"
              onClick={() => {
                setShowForm(false)
                setForm({ type: 'text', title: '', description: '', mediaFile: null, mediaPreview: '' })
              }}
              className="px-4 py-3 rounded-xl border-2 border-gray-200 text-gray-600 font-medium"
            >
              إلغاء
            </button>
          </div>
        </form>
      )}

      {/* قائمة الإعلانات */}
      <div className="space-y-4">
        <h2 className="font-bold text-lg text-gray-800">إعلاناتك</h2>

        {promotions.length === 0 ? (
          <div className="text-center py-10 text-gray-400">
            <Megaphone className="w-12 h-12 mx-auto mb-3 opacity-50" />
            <p>لم تنشئ أي إعلانات بعد</p>
          </div>
        ) : (
          promotions.map(promo => (
            <div
              key={promo.id}
              className={`bg-white rounded-2xl shadow-lg overflow-hidden ${
                isExpired(promo) ? 'opacity-60' : ''
              }`}
            >
              {/* الوسائط */}
              {promo.mediaUrl && (
                promo.type === 'video' ? (
                  <video
                    src={promo.mediaUrl}
                    controls
                    className="w-full h-48 object-cover"
                  />
                ) : (
                  <img
                    src={promo.mediaUrl}
                    alt={promo.title}
                    className="w-full h-48 object-cover"
                  />
                )
              )}

              <div className="p-4">
                {/* الحالة */}
                <div className="flex items-center gap-2 mb-2">
                  {isExpired(promo) ? (
                    <span className="inline-flex items-center gap-1 px-2 py-1 bg-gray-100 text-gray-500 text-xs font-medium rounded-full">
                      <XCircle className="w-3 h-3" /> منتهي
                    </span>
                  ) : promo.isActive ? (
                    <span className="inline-flex items-center gap-1 px-2 py-1 bg-green-100 text-green-600 text-xs font-medium rounded-full">
                      <CheckCircle className="w-3 h-3" /> نشط
                    </span>
                  ) : (
                    <span className="inline-flex items-center gap-1 px-2 py-1 bg-yellow-100 text-yellow-600 text-xs font-medium rounded-full">
                      <Clock className="w-3 h-3" /> في الانتظار
                    </span>
                  )}
                  <span className="inline-flex items-center gap-1 px-2 py-1 bg-purple-100 text-purple-600 text-xs font-medium rounded-full">
                    <Eye className="w-3 h-3" /> {promo.viewsCount} مشاهدة
                  </span>
                </div>

                {/* المحتوى */}
                {promo.title && <h3 className="font-bold text-gray-800">{promo.title}</h3>}
                {promo.description && <p className="text-gray-600 text-sm mt-1">{promo.description}</p>}

                {/* التوقيت */}
                <div className="flex items-center justify-between mt-3 pt-3 border-t">
                  <span className="text-xs text-gray-400">
                    {promo.expiresAt && !isExpired(promo) && (
                      <>ينتهي: {new Date(promo.expiresAt).toLocaleString('ar-SA')}</>
                    )}
                    {isExpired(promo) && 'انتهت صلاحية الإعلان'}
                  </span>
                  <button
                    onClick={() => handleDelete(promo.id)}
                    className="p-2 text-red-500 hover:bg-red-50 rounded-lg transition"
                  >
                    <Trash2 className="w-4 h-4" />
                  </button>
                </div>
              </div>
            </div>
          ))
        )}
      </div>

      {/* رابط العودة */}
      <Link
        to="/owner"
        className="flex items-center justify-center gap-2 text-sky-600 hover:text-sky-700 py-4"
      >
        <ArrowRight className="w-5 h-5" />
        العودة للوحة التحكم
      </Link>
    </div>
  )
}

==========================================================================================
FILE: src/pages/Register.tsx
==========================================================================================
// src/pages/Register.tsx
import React, { useState, useEffect } from 'react'
import { createUserWithEmailAndPassword } from 'firebase/auth'
import { auth, db } from '@/firebase'
import { doc, setDoc, addDoc, collection, serverTimestamp, updateDoc, increment, getDoc } from 'firebase/firestore'
import { useNavigate, Link, useSearchParams } from 'react-router-dom'
import { User, Mail, Lock, Store, UserPlus, Truck, ChefHat, Users, MapPin, CheckSquare, Square } from 'lucide-react'
import { SAUDI_CITIES } from '@/utils/cities'

export const Register: React.FC = () => {
  const [searchParams] = useSearchParams()
  const referralRestaurantId = searchParams.get('ref_restaurant') // رابط الإحالة من الأسرة
  const [email, setEmail] = useState('')
  const [password, setPassword] = useState('')
  const [name, setName] = useState('')
  const [restaurantName, setRestaurantName] = useState('')
  const [city, setCity] = useState('')
  const [role, setRole] = useState<'customer'|'courier'|'owner'|''>('')
  const [acceptedTerms, setAcceptedTerms] = useState(false)
  const [loading, setLoading] = useState(false)
  const nav = useNavigate()

  // إذا جاء العميل من رابط إحالة، نحدد دوره تلقائياً كعميل
  useEffect(() => {
    if (referralRestaurantId) {
      setRole('customer')
    }
  }, [referralRestaurantId])

  // هل يتطلب هذا الدور الموافقة على الشروط؟
  const requiresTerms = role === 'owner' || role === 'courier'

  // عند تغيير الدور، نعيد تعيين الموافقة
  const handleRoleChange = (newRole: 'customer'|'courier'|'owner') => {
    setRole(newRole)
    setAcceptedTerms(false)
  }

  const submit = async (e: React.FormEvent) => {
    e.preventDefault()
    if (!role) return alert('اختر نوع الحساب')
    if (role === 'owner' && !restaurantName) return alert('أدخل اسم المطعم')
    if (requiresTerms && !acceptedTerms) return alert('يجب الموافقة على الشروط والأحكام')

    setLoading(true)
    try {
      const cred = await createUserWithEmailAndPassword(auth, email, password)
      await setDoc(doc(db, 'users', cred.user.uid), {
        name,
        email,
        role,
        restaurantName: role === 'owner' ? restaurantName : null,
        referredBy: referralRestaurantId || null, // حفظ رابط الإحالة
        createdAt: serverTimestamp()
      })

      if (role === 'owner') {
        await setDoc(doc(db, 'restaurants', cred.user.uid), {
          name: restaurantName || name || 'مطعم جديد',
          ownerId: cred.user.uid,
          email,
          phone: '',
          city: city || '',
          location: '',
          logoUrl: '',
        }, { merge: true })
      }

      // إذا كان التسجيل عبر رابط إحالة، نسجل ذلك ونرسل إشعار للأسرة
      if (referralRestaurantId && role === 'customer') {
        try {
          // تسجيل في جدول تسجيلات العملاء
          await addDoc(collection(db, 'customerRegistrations'), {
            customerId: cred.user.uid,
            customerName: name,
            customerEmail: email,
            restaurantId: referralRestaurantId,
            registrationType: 'website',
            createdAt: serverTimestamp()
          })

          // تحديث إحصائيات المطعم
          const statsRef = doc(db, 'restaurantStats', referralRestaurantId)
          const statsSnap = await getDoc(statsRef)
          if (statsSnap.exists()) {
            await updateDoc(statsRef, {
              registeredCustomers: increment(1),
              updatedAt: serverTimestamp()
            })
          } else {
            await setDoc(statsRef, {
              totalProfileViews: 0,
              totalMenuViews: 0,
              totalItemViews: 0,
              totalShareClicks: 0,
              whatsappShareCount: 0,
              registeredCustomers: 1,
              appDownloads: 0,
              dailyViews: {},
              updatedAt: serverTimestamp()
            })
          }

          // إرسال إشعار للأسرة المنتجة
          await addDoc(collection(db, 'notifications'), {
            recipientId: referralRestaurantId,
            title: ' عميل جديد سجل عبر رابطك!',
            message: `العميل "${name}" سجل في التطبيق عبر رابط الإحالة الخاص بك`,
            type: 'new_customer_registration',
            read: false,
            createdAt: serverTimestamp()
          })
        } catch (err) {
          console.warn('خطأ في تسجيل الإحالة:', err)
        }
      }

      nav('/')
    } catch (e: any) {
      alert(e.message)
    } finally { setLoading(false) }
  }

  const roleOptions = [
    { value: 'customer', label: 'عميل', icon: Users, color: 'sky' },
    { value: 'courier', label: 'مندوب', icon: Truck, color: 'emerald' },
    { value: 'owner', label: 'صاحب مطعم', icon: ChefHat, color: 'orange' },
  ]

  return (
    <div className="min-h-screen flex items-center justify-center bg-gradient-to-br from-sky-50 via-white to-sky-100 px-4 py-8">
      {/* خلفية زخرفية */}
      <div className="absolute top-0 left-0 w-72 h-72 bg-sky-300/20 rounded-full blur-3xl"></div>
      <div className="absolute bottom-0 right-0 w-72 h-72 bg-sky-400/20 rounded-full blur-3xl"></div>

      <div className="relative bg-white/80 backdrop-blur-xl border border-sky-100 rounded-[2rem] shadow-2xl shadow-sky-200/50 w-full max-w-md p-8">
        
        {/* شعار */}
        <div className="flex flex-col items-center mb-6">
          <div className="w-16 h-16 bg-gradient-to-br from-sky-500 to-sky-600 rounded-2xl flex items-center justify-center shadow-xl shadow-sky-300/50 mb-3">
            <UserPlus className="w-8 h-8 text-white" />
          </div>
          <h1 className="text-2xl font-black text-sky-600">إنشاء حساب جديد</h1>
        </div>

        <form onSubmit={submit} className="space-y-4">
          {/* الاسم */}
          <div className="relative">
            <User className="absolute right-4 top-1/2 -translate-y-1/2 w-5 h-5 text-sky-400" />
            <input 
              className="w-full rounded-2xl p-4 pr-12 bg-sky-50 text-sky-900 border-2 border-sky-100 focus:outline-none focus:border-sky-400 focus:ring-4 focus:ring-sky-100 transition-all" 
              placeholder="الاسم" 
              value={name} 
              onChange={e=>setName(e.target.value)} 
            />
          </div>

          {/* الإيميل */}
          <div className="relative">
            <Mail className="absolute right-4 top-1/2 -translate-y-1/2 w-5 h-5 text-sky-400" />
            <input 
              className="w-full rounded-2xl p-4 pr-12 bg-sky-50 text-sky-900 border-2 border-sky-100 focus:outline-none focus:border-sky-400 focus:ring-4 focus:ring-sky-100 transition-all" 
              placeholder="الإيميل" 
              type="email"
              value={email} 
              onChange={e=>setEmail(e.target.value)} 
            />
          </div>

          {/* كلمة المرور */}
          <div className="relative">
            <Lock className="absolute right-4 top-1/2 -translate-y-1/2 w-5 h-5 text-sky-400" />
            <input 
              className="w-full rounded-2xl p-4 pr-12 bg-sky-50 text-sky-900 border-2 border-sky-100 focus:outline-none focus:border-sky-400 focus:ring-4 focus:ring-sky-100 transition-all" 
              placeholder="كلمة المرور" 
              type="password" 
              value={password} 
              onChange={e=>setPassword(e.target.value)} 
            />
          </div>

          {/* اختيار نوع الحساب */}
          <div className="grid grid-cols-3 gap-3">
            {roleOptions.map(opt => {
              const Icon = opt.icon
              const isSelected = role === opt.value
              return (
                <label 
                  key={opt.value}
                  className={`relative flex flex-col items-center gap-2 p-4 rounded-2xl cursor-pointer transition-all duration-300 ${
                    isSelected 
                      ? 'bg-gradient-to-br from-sky-500 to-sky-600 text-white shadow-lg shadow-sky-300/50 scale-105' 
                      : 'bg-sky-50 text-sky-600 hover:bg-sky-100 border-2 border-sky-100'
                  }`}
                >
                  <input 
                    type="radio" 
                    name="role" 
                    value={opt.value} 
                    className="hidden" 
                    onChange={()=>handleRoleChange(opt.value as any)} 
                  />
                  <Icon className="w-6 h-6" />
                  <span className="text-sm font-bold">{opt.label}</span>
                </label>
              )
            })}
          </div>

          {/* حقل اسم المطعم والمدينة */}
          {role === 'owner' && (
            <>
              <div className="relative">
                <Store className="absolute right-4 top-1/2 -translate-y-1/2 w-5 h-5 text-orange-400" />
                <input 
                  className="w-full rounded-2xl p-4 pr-12 bg-orange-50 text-orange-900 border-2 border-orange-200 focus:outline-none focus:border-orange-400 focus:ring-4 focus:ring-orange-100 transition-all" 
                  placeholder="اسم المطعم" 
                  value={restaurantName} 
                  onChange={e=>setRestaurantName(e.target.value)} 
                />
              </div>
              <div className="relative">
                <MapPin className="absolute right-4 top-1/2 -translate-y-1/2 w-5 h-5 text-orange-400 pointer-events-none" />
                <select
                  value={city}
                  onChange={e => setCity(e.target.value)}
                  className="w-full rounded-2xl p-4 pr-12 bg-orange-50 text-orange-900 border-2 border-orange-200 focus:outline-none focus:border-orange-400 focus:ring-4 focus:ring-orange-100 transition-all appearance-none cursor-pointer"
                >
                  <option value="">اختر المدينة</option>
                  {SAUDI_CITIES.map(c => (
                    <option key={c} value={c}>{c}</option>
                  ))}
                </select>
              </div>

              {/* الموافقة على الشروط والأحكام */}
              <div 
                onClick={() => setAcceptedTerms(!acceptedTerms)}
                className={`flex items-start gap-3 p-4 rounded-2xl cursor-pointer transition-all border-2 ${
                  acceptedTerms 
                    ? 'bg-green-50 border-green-400' 
                    : 'bg-orange-50 border-orange-200 hover:border-orange-300'
                }`}
              >
                {acceptedTerms ? (
                  <CheckSquare className="w-6 h-6 text-green-500 flex-shrink-0 mt-0.5" />
                ) : (
                  <Square className="w-6 h-6 text-orange-400 flex-shrink-0 mt-0.5" />
                )}
                <div className="text-sm leading-relaxed">
                  <span className={acceptedTerms ? 'text-green-700' : 'text-orange-700'}>
                    أوافق على{' '}
                  </span>
                  <Link 
                    to="/terms" 
                    target="_blank"
                    onClick={(e) => e.stopPropagation()}
                    className="text-sky-600 hover:text-sky-800 font-bold underline"
                  >
                    الشروط والأحكام
                  </Link>
                  <span className={acceptedTerms ? 'text-green-700' : 'text-orange-700'}>
                    {' '}و{' '}
                  </span>
                  <Link 
                    to="/privacy-policy" 
                    target="_blank"
                    onClick={(e) => e.stopPropagation()}
                    className="text-sky-600 hover:text-sky-800 font-bold underline"
                  >
                    سياسة الخصوصية
                  </Link>
                  <span className={acceptedTerms ? 'text-green-700' : 'text-orange-700'}>
                    {' '}الخاصة بمنصة سفرة البيت
                  </span>
                </div>
              </div>
            </>
          )}

          {/* شروط وأحكام المندوب */}
          {role === 'courier' && (
            <div 
              onClick={() => setAcceptedTerms(!acceptedTerms)}
              className={`flex items-start gap-3 p-4 rounded-2xl cursor-pointer transition-all border-2 ${
                acceptedTerms 
                  ? 'bg-green-50 border-green-400' 
                  : 'bg-emerald-50 border-emerald-200 hover:border-emerald-300'
              }`}
            >
              {acceptedTerms ? (
                <CheckSquare className="w-6 h-6 text-green-500 flex-shrink-0 mt-0.5" />
              ) : (
                <Square className="w-6 h-6 text-emerald-400 flex-shrink-0 mt-0.5" />
              )}
              <div className="text-sm leading-relaxed">
                <span className={acceptedTerms ? 'text-green-700' : 'text-emerald-700'}>
                  أوافق على{' '}
                </span>
                <Link 
                  to="/courier-terms" 
                  target="_blank"
                  onClick={(e) => e.stopPropagation()}
                  className="text-emerald-600 hover:text-emerald-800 font-bold underline"
                >
                  شروط وأحكام المندوب
                </Link>
                <span className={acceptedTerms ? 'text-green-700' : 'text-emerald-700'}>
                  {' '}وأتحمل كامل المسؤولية كمندوب مستقل
                </span>
              </div>
            </div>
          )}

          <button 
            disabled={loading || (requiresTerms && !acceptedTerms)} 
            className={`w-full flex items-center justify-center gap-3 text-white font-bold p-4 rounded-2xl shadow-xl transition-all ${
              requiresTerms && !acceptedTerms
                ? 'bg-gray-400 cursor-not-allowed'
                : 'bg-gradient-to-r from-sky-500 to-sky-600 hover:from-sky-600 hover:to-sky-700 shadow-sky-300/50 hover:scale-[1.02]'
            }`}
          >
            {loading ? 'جارٍ التسجيل...' : (
              <>
                <UserPlus className="w-5 h-5" />
                تسجيل
              </>
            )}
          </button>

          {/* تنبيه للموافقة على الشروط */}
          {requiresTerms && !acceptedTerms && (
            <p className={`text-center text-sm p-3 rounded-xl ${
              role === 'courier' 
                ? 'text-emerald-600 bg-emerald-50' 
                : 'text-orange-600 bg-orange-50'
            }`}>
               يجب الموافقة على الشروط والأحكام لإكمال التسجيل
            </p>
          )}
        </form>

        {/* رابط تسجيل الدخول */}
        <p className="mt-6 text-center text-sky-600">
          عندك حساب؟{' '}
          <Link className="text-sky-500 hover:text-sky-700 font-bold" to="/login">
            سجّل دخول 
          </Link>
        </p>
      </div>
    </div>
  )
}

==========================================================================================
FILE: src/pages/RestaurantOrders.tsx
==========================================================================================
// src/pages/RestaurantOrders.tsx
import React, { useEffect, useState } from 'react'
import { collection, onSnapshot, orderBy, query, where, updateDoc, doc, serverTimestamp } from 'firebase/firestore'
import { db } from '@/firebase'
import { useAuth } from '@/auth'
import { Order, ORDER_TIME_LIMITS } from '@/types'
import { useToast } from '@/components/ui/Toast'
import { OrderTimer } from '@/components/OrderTimer'
import { Package, MapPin, Truck, DollarSign, Check, Clock, X, AlertCircle, Store } from 'lucide-react'

// رسوم المنصة على المندوب
const COURIER_PLATFORM_FEE = 3.75

// ترجمة حالات الطلب
const statusLabels: Record<string, { label: string; color: string; icon: React.ReactNode }> = {
  pending: { label: 'بانتظار القبول', color: 'bg-amber-100 text-amber-700', icon: <Clock className="w-4 h-4" /> },
  accepted: { label: 'مقبول', color: 'bg-blue-100 text-blue-700', icon: <Check className="w-4 h-4" /> },
  preparing: { label: 'قيد التحضير', color: 'bg-purple-100 text-purple-700', icon: <Package className="w-4 h-4" /> },
  ready: { label: 'جاهز للتسليم', color: 'bg-green-100 text-green-700', icon: <Store className="w-4 h-4" /> },
  out_for_delivery: { label: 'في الطريق', color: 'bg-sky-100 text-sky-700', icon: <Truck className="w-4 h-4" /> },
  delivered: { label: 'تم التسليم', color: 'bg-green-500 text-white', icon: <Check className="w-4 h-4" /> },
  cancelled: { label: 'ملغي', color: 'bg-red-100 text-red-700', icon: <X className="w-4 h-4" /> },
}

export const RestaurantOrders: React.FC = () => {
  const { user } = useAuth()
  const toast = useToast()
  const [orders, setOrders] = useState<Order[]>([])
  const [loading, setLoading] = useState(true)
  const [deliveryFees, setDeliveryFees] = useState<Record<string, string>>({})
  const [savingFee, setSavingFee] = useState<string | null>(null)

  useEffect(() => {
    if (!user) return
    //  جلب الطلبات الخاصة بالمطعم حسب restaurantId
    const q = query(
      collection(db, 'orders'),
      where('restaurantId', '==', user.uid),
      orderBy('createdAt', 'desc')
    )
    const unsub = onSnapshot(q, (snap) => {
      setOrders(snap.docs.map((d) => ({ id: d.id, ...d.data() } as Order)))
      setLoading(false)
    })
    return () => unsub()
  }, [user])

  const updateStatus = async (id: string, status: string) => {
    // إضافة timestamps حسب الحالة
    const updateData: Record<string, any> = { 
      status, 
      updatedAt: serverTimestamp() 
    }
    
    // تسجيل وقت كل مرحلة
    if (status === 'accepted') {
      updateData['timestamps.acceptedAt'] = serverTimestamp()
    } else if (status === 'ready') {
      updateData['timestamps.readyAt'] = serverTimestamp()
    }
    
    await updateDoc(doc(db, 'orders', id), updateData)
    toast.success('تم تحديث حالة الطلب')
  }

  // تحديد رسوم التوصيل
  const setDeliveryFee = async (orderId: string) => {
    const feeStr = deliveryFees[orderId]
    const fee = parseFloat(feeStr)
    
    if (isNaN(fee) || fee < 0) {
      toast.error('أدخل مبلغ صحيح')
      return
    }

    setSavingFee(orderId)
    
    const order = orders.find(o => o.id === orderId)
    if (!order) return

    const newTotal = order.subtotal + fee

    await updateDoc(doc(db, 'orders', orderId), {
      deliveryFee: fee,
      deliveryFeeSetBy: 'owner',
      deliveryFeeSetAt: serverTimestamp(),
      total: newTotal,
      updatedAt: serverTimestamp(),
    })

    setSavingFee(null)
    toast.success(`تم تحديد رسوم التوصيل: ${fee} ر.س`)
  }

  if (loading) return (
    <div className="flex items-center justify-center py-20">
      <div className="text-center">
        <div className="w-16 h-16 border-4 border-sky-200 border-t-sky-500 rounded-full animate-spin mx-auto mb-4"></div>
        <p className="text-sky-600">جارِ تحميل الطلبات...</p>
      </div>
    </div>
  )

  return (
    <div className="min-h-screen bg-gradient-to-br from-sky-50 via-white to-sky-100 py-6 px-4">
      <div className="max-w-4xl mx-auto">
        <div className="flex items-center gap-3 mb-6">
          <div className="w-12 h-12 bg-gradient-to-br from-sky-500 to-sky-600 rounded-xl flex items-center justify-center">
            <Package className="w-6 h-6 text-white" />
          </div>
          <div>
            <h1 className="text-2xl font-bold text-sky-900">طلبات الأسرة</h1>
            <p className="text-sky-600 text-sm">{orders.length} طلب</p>
          </div>
        </div>

        {orders.length === 0 && (
          <div className="glass-card rounded-2xl p-10 text-center">
            <Package className="w-16 h-16 text-sky-300 mx-auto mb-4" />
            <p className="text-sky-700 font-semibold">لا توجد طلبات حالياً</p>
            <p className="text-sky-500 text-sm mt-1">ستظهر الطلبات الجديدة هنا</p>
          </div>
        )}

        <div className="space-y-4">
          {orders.map((o) => {
            const status = statusLabels[o.status] || statusLabels.pending
            const needsDeliveryFee = o.deliveryType === 'delivery' && !o.deliveryFeeSetBy && o.status === 'pending'
            
            return (
              <div key={o.id} className="glass-card rounded-2xl overflow-hidden">
                {/* Header */}
                <div className="bg-gradient-to-r from-sky-500 to-sky-600 px-4 py-3 flex items-center justify-between">
                  <div className="flex items-center gap-3">
                    <span className="text-white font-bold">#{o.id.slice(-6)}</span>
                    <span className={`px-2 py-1 rounded-lg text-xs font-semibold flex items-center gap-1 ${status.color}`}>
                      {status.icon}
                      {status.label}
                    </span>
                  </div>
                  <div className="flex items-center gap-2 text-white">
                    {o.deliveryType === 'pickup' ? (
                      <span className="flex items-center gap-1 text-sm bg-white/20 px-2 py-1 rounded-lg">
                        <Store className="w-4 h-4" /> استلام
                      </span>
                    ) : (
                      <span className="flex items-center gap-1 text-sm bg-white/20 px-2 py-1 rounded-lg">
                        <Truck className="w-4 h-4" /> توصيل
                      </span>
                    )}
                  </div>
                </div>

                <div className="p-4">
                  {/* الأصناف */}
                  <div className="mb-3">
                    <p className="text-sm text-gray-500 mb-1">الأصناف:</p>
                    <p className="font-semibold text-sky-900">
                      {o.items.map((i) => `${i.name} × ${i.qty}`).join(' • ')}
                    </p>
                  </div>

                  {/* العنوان */}
                  <div className="flex items-start gap-2 mb-3 text-sm">
                    <MapPin className="w-4 h-4 text-sky-500 mt-0.5" />
                    <span className="text-gray-700">{o.address}</span>
                  </div>

                  {/* عداد الوقت - يظهر للطلبات النشطة */}
                  {(o.status === 'accepted' || o.status === 'preparing') && (
                    <div className="mb-3">
                      <OrderTimer order={o} type="preparation" />
                    </div>
                  )}
                  {o.status === 'ready' && o.deliveryType === 'delivery' && (
                    <div className="mb-3">
                      <OrderTimer order={o} type="pickup" />
                    </div>
                  )}

                  {/* الأسعار */}
                  <div className="bg-sky-50 rounded-xl p-3 mb-4 space-y-1">
                    <div className="flex justify-between text-sm">
                      <span className="text-gray-600">سعر المنتجات</span>
                      <span className="font-semibold">{o.subtotal?.toFixed(2)} ر.س</span>
                    </div>
                    <div className="flex justify-between text-sm">
                      <span className="text-gray-600">رسوم التوصيل</span>
                      {o.deliveryFeeSetBy ? (
                        <span className="font-semibold text-green-600">{o.deliveryFee?.toFixed(2)} ر.س</span>
                      ) : o.deliveryType === 'pickup' ? (
                        <span className="font-semibold text-green-600">مجاناً</span>
                      ) : (
                        <span className="text-amber-600 text-xs">لم تُحدد بعد</span>
                      )}
                    </div>
                    <div className="h-px bg-sky-200 my-2"></div>
                    <div className="flex justify-between">
                      <span className="font-bold text-sky-900">الإجمالي</span>
                      <span className="font-bold text-lg text-sky-600">{o.total?.toFixed(2)} ر.س</span>
                    </div>
                  </div>

                  {/* تحديد رسوم التوصيل - يظهر فقط للطلبات الجديدة التي تحتاج توصيل */}
                  {needsDeliveryFee && (
                    <div className="bg-amber-50 border-2 border-amber-200 rounded-xl p-4 mb-4">
                      <div className="flex items-center gap-2 mb-3">
                        <AlertCircle className="w-5 h-5 text-amber-600" />
                        <span className="font-bold text-amber-800">حدد رسوم التوصيل</span>
                      </div>
                      <div className="flex gap-2">
                        <div className="flex-1 relative">
                          <input
                            type="number"
                            min="0"
                            step="0.5"
                            placeholder="مثال: 10"
                            value={deliveryFees[o.id] || ''}
                            onChange={(e) => setDeliveryFees(prev => ({ ...prev, [o.id]: e.target.value }))}
                            className="w-full px-4 py-2 rounded-xl border-2 border-amber-200 focus:border-amber-400 focus:outline-none text-gray-800"
                          />
                          <span className="absolute left-3 top-1/2 -translate-y-1/2 text-gray-500 text-sm">ر.س</span>
                        </div>
                        <button
                          onClick={() => setDeliveryFee(o.id)}
                          disabled={savingFee === o.id}
                          className="px-4 py-2 rounded-xl bg-amber-500 text-white font-bold hover:bg-amber-600 transition disabled:opacity-50"
                        >
                          {savingFee === o.id ? '...' : 'تأكيد'}
                        </button>
                      </div>
                      <p className="text-xs text-amber-700 mt-2">
                         سيتم إضافة {COURIER_PLATFORM_FEE} ر.س رسوم منصة على المندوب تلقائياً
                      </p>
                    </div>
                  )}

                  {/* أزرار تغيير الحالة */}
                  <div className="flex flex-wrap gap-2">
                    {o.status === 'pending' && (
                      <>
                        <button 
                          onClick={() => updateStatus(o.id, 'accepted')}
                          disabled={needsDeliveryFee}
                          className="flex-1 px-4 py-2 rounded-xl bg-green-500 text-white font-bold hover:bg-green-600 transition disabled:opacity-50 disabled:cursor-not-allowed"
                        >
                           قبول
                        </button>
                        <button 
                          onClick={() => updateStatus(o.id, 'cancelled')}
                          className="px-4 py-2 rounded-xl bg-red-100 text-red-600 font-semibold hover:bg-red-200 transition"
                        >
                          رفض
                        </button>
                      </>
                    )}
                    {o.status === 'accepted' && (
                      <button 
                        onClick={() => updateStatus(o.id, 'preparing')}
                        className="flex-1 px-4 py-2 rounded-xl bg-purple-500 text-white font-bold hover:bg-purple-600 transition"
                      >
                         بدء التحضير
                      </button>
                    )}
                    {o.status === 'preparing' && (
                      <button 
                        onClick={() => updateStatus(o.id, 'ready')}
                        className="flex-1 px-4 py-2 rounded-xl bg-green-500 text-white font-bold hover:bg-green-600 transition"
                      >
                         جاهز للتسليم
                      </button>
                    )}
                    {o.status === 'ready' && o.deliveryType === 'pickup' && (
                      <button 
                        onClick={() => updateStatus(o.id, 'delivered')}
                        className="flex-1 px-4 py-2 rounded-xl bg-green-600 text-white font-bold hover:bg-green-700 transition"
                      >
                         تم التسليم
                      </button>
                    )}
                  </div>
                </div>
              </div>
            )
          })}
        </div>
      </div>
    </div>
  )
}

==========================================================================================
FILE: src/pages/RestaurantsPage.tsx
==========================================================================================
// src/pages/RestaurantsPage.tsx
import React, { useEffect, useState, useMemo } from 'react'
import { db } from '@/firebase'
import { collection, getDocs, query, where, updateDoc, doc, increment, setDoc, addDoc, serverTimestamp, getDoc } from 'firebase/firestore'
import { Link, useSearchParams } from 'react-router-dom'
import { SAUDI_CITIES } from '@/utils/cities'
import { MapPin, Filter, X, Navigation, AlertCircle, CheckCircle, Crown, Medal, Award, Megaphone, ChevronLeft, ChevronRight, Play, Eye, Star, ShoppingBag, Utensils, Truck, Store, Clock, Search, SlidersHorizontal, StarHalf } from 'lucide-react'
import { useAuth } from '@/auth'
import { calculateDistance, MAX_DELIVERY_DISTANCE } from '@/utils/distance'
import { Promotion } from '@/types'

// أنواع المطابخ
const CUISINE_TYPES = [
  { value: '', label: 'الكل' },
  { value: 'traditional', label: ' أكلات شعبية' },
  { value: 'sweets', label: ' حلويات' },
  { value: 'pastries', label: ' معجنات' },
  { value: 'grills', label: ' مشويات' },
  { value: 'healthy', label: ' أكل صحي' },
  { value: 'international', label: ' أكلات عالمية' },
]

type GeoLocation = { lat: number; lng: number }

type Restaurant = {
  id: string
  name: string
  logoUrl?: string
  city?: string
  geoLocation?: GeoLocation
  isVerified?: boolean
  licenseStatus?: 'pending' | 'approved' | 'rejected'
  sellerTier?: 'bronze' | 'silver' | 'gold'
  packageType?: 'free' | 'premium'
  allowDelivery?: boolean
  allowPickup?: boolean
  cuisineType?: string // نوع المطبخ
  // إحصائيات للعرض في الباقة المميزة
  totalOrders?: number
  averageRating?: number
  menuItemsCount?: number
}

type RestaurantWithDistance = Restaurant & {
  distance?: number
}

// دالة تسجيل الزيارة
const logVisit = async (restaurantId: string, userId?: string, source?: string) => {
  try {
    // تسجيل الزيارة في سجلات الزيارات
    await addDoc(collection(db, 'visitLogs'), {
      restaurantId,
      visitorId: userId || null,
      visitorType: userId ? 'customer' : 'anonymous',
      source: source || 'direct',
      page: 'menu',
      createdAt: serverTimestamp()
    })

    // تحديث إحصائيات المطعم
    const statsRef = doc(db, 'restaurantStats', restaurantId)
    const statsSnap = await getDoc(statsRef)
    
    const today = new Date().toISOString().split('T')[0]
    
    if (statsSnap.exists()) {
      const data = statsSnap.data()
      const dailyViews = data.dailyViews || {}
      dailyViews[today] = (dailyViews[today] || 0) + 1
      
      await updateDoc(statsRef, {
        totalProfileViews: increment(1),
        dailyViews,
        updatedAt: serverTimestamp()
      })
    } else {
      await setDoc(statsRef, {
        totalProfileViews: 1,
        totalMenuViews: 0,
        totalItemViews: 0,
        totalShareClicks: 0,
        whatsappShareCount: 0,
        registeredCustomers: 0,
        appDownloads: 0,
        dailyViews: { [today]: 1 },
        updatedAt: serverTimestamp()
      })
    }
  } catch (err) {
    console.warn('خطأ في تسجيل الزيارة:', err)
  }
}

export const RestaurantsPage: React.FC = () => {
  const { userLocation, role, user } = useAuth()
  const [searchParams] = useSearchParams()
  const refSource = searchParams.get('ref') // مصدر الإحالة (whatsapp, social, etc)
  const [restaurants, setRestaurants] = useState<RestaurantWithDistance[]>([])
  const [promotions, setPromotions] = useState<(Promotion & { restaurantName?: string })[]>([])
  const [currentPromoIndex, setCurrentPromoIndex] = useState(0)
  const [loading, setLoading] = useState(true)
  const [selectedCity, setSelectedCity] = useState<string>('')
  const [viewMode, setViewMode] = useState<'grid' | 'list'>('grid')
  //  فلاتر البحث المتقدم
  const [searchQuery, setSearchQuery] = useState('')
  const [selectedCuisine, setSelectedCuisine] = useState('')
  const [minRating, setMinRating] = useState<number>(0)
  const [showFilters, setShowFilters] = useState(false)
  const [sortBy, setSortBy] = useState<'distance' | 'rating' | 'orders'>('distance')

  useEffect(() => {
    (async () => {
      // جلب المطاعم
      const snap = await getDocs(collection(db, 'restaurants'))
      const allRestaurants = snap.docs.map(d => ({ id: d.id, ...d.data() } as Restaurant))
      
      // جلب الإعلانات النشطة
      try {
        const promoQuery = query(
          collection(db, 'promotions'),
          where('isActive', '==', true)
        )
        const promoSnap = await getDocs(promoQuery)
        const now = new Date()
        const activePromos = promoSnap.docs
          .map(d => ({
            id: d.id,
            ...d.data(),
            expiresAt: d.data().expiresAt?.toDate?.(),
          } as Promotion))
          .filter(p => !p.expiresAt || new Date(p.expiresAt) > now)
          .map(p => {
            // إضافة اسم المطعم
            const restaurant = allRestaurants.find(r => r.id === p.ownerId)
            return { ...p, restaurantName: restaurant?.name }
          })
        setPromotions(activePromos)
      } catch (err) {
        console.warn('Error loading promotions:', err)
      }
      
      // حساب المسافة وفلترة المطاعم
      let processedRestaurants: RestaurantWithDistance[] = []
      
      if (userLocation) {
        // حساب المسافة لكل مطعم
        processedRestaurants = allRestaurants.map(r => {
          if (r.geoLocation) {
            const distance = calculateDistance(userLocation, r.geoLocation)
            return { ...r, distance }
          }
          return { ...r, distance: undefined }
        })
        
        // فلترة المطاعم ضمن 15 كم فقط (للعملاء والمناديب)
        if (role === 'customer' || role === 'courier') {
          processedRestaurants = processedRestaurants.filter(r => {
            // إذا المطعم ما عنده موقع، نخفيه
            if (!r.geoLocation || r.distance === undefined) return false
            return r.distance <= MAX_DELIVERY_DISTANCE
          })
        }
        
        // ترتيب ذكي: Premium + Gold أولاً، ثم حسب المسافة
        processedRestaurants.sort((a, b) => {
          // Premium يظهر أولاً
          const aPremium = a.packageType === 'premium' ? 1 : 0
          const bPremium = b.packageType === 'premium' ? 1 : 0
          if (bPremium !== aPremium) return bPremium - aPremium
          
          // Gold ثم Silver ثم Bronze
          const tierOrder = { gold: 3, silver: 2, bronze: 1 }
          const aTier = tierOrder[a.sellerTier || 'bronze'] || 0
          const bTier = tierOrder[b.sellerTier || 'bronze'] || 0
          if (bTier !== aTier) return bTier - aTier
          
          // الموثقة تظهر قبل غير الموثقة
          const aVerified = a.isVerified ? 1 : 0
          const bVerified = b.isVerified ? 1 : 0
          if (bVerified !== aVerified) return bVerified - aVerified
          
          // ثم الترتيب حسب المسافة
          return (a.distance || 999) - (b.distance || 999)
        })
      } else {
        // إذا ما عند المستخدم موقع، نعرض كل المطاعم مرتبة
        processedRestaurants = allRestaurants.sort((a, b) => {
          const tierOrder = { gold: 3, silver: 2, bronze: 1 }
          const aTier = tierOrder[a.sellerTier || 'bronze'] || 0
          const bTier = tierOrder[b.sellerTier || 'bronze'] || 0
          if (bTier !== aTier) return bTier - aTier
          const aVerified = a.isVerified ? 1 : 0
          const bVerified = b.isVerified ? 1 : 0
          return bVerified - aVerified
        })
      }
      
      setRestaurants(processedRestaurants)
      setLoading(false)
    })()
  }, [userLocation, role])

  // المدن المتاحة (فقط التي لديها مطاعم)
  const availableCities = useMemo(() => {
    const cities = new Set(restaurants.map(r => r.city).filter(Boolean))
    return SAUDI_CITIES.filter(c => cities.has(c))
  }, [restaurants])

  // المطاعم المفلترة حسب المدينة
  const filteredRestaurants = useMemo(() => {
    let result = restaurants
    
    // فلتر المدينة
    if (selectedCity) {
      result = result.filter(r => r.city === selectedCity)
    }
    
    // فلتر البحث بالاسم
    if (searchQuery.trim()) {
      const query = searchQuery.trim().toLowerCase()
      result = result.filter(r => 
        r.name.toLowerCase().includes(query) ||
        r.city?.toLowerCase().includes(query)
      )
    }
    
    // فلتر نوع المطبخ
    if (selectedCuisine) {
      result = result.filter(r => r.cuisineType === selectedCuisine)
    }
    
    // فلتر التقييم الأدنى
    if (minRating > 0) {
      result = result.filter(r => (r.averageRating || 0) >= minRating)
    }
    
    // الترتيب
    if (sortBy === 'rating') {
      result = [...result].sort((a, b) => (b.averageRating || 0) - (a.averageRating || 0))
    } else if (sortBy === 'orders') {
      result = [...result].sort((a, b) => (b.totalOrders || 0) - (a.totalOrders || 0))
    }
    // sortBy === 'distance' هو الافتراضي (مرتب مسبقاً)
    
    return result
  }, [restaurants, selectedCity, searchQuery, selectedCuisine, minRating, sortBy])

  // عدد الفلاتر النشطة
  const activeFiltersCount = [selectedCity, searchQuery, selectedCuisine, minRating > 0].filter(Boolean).length

  if (loading) {
    return (
      <div className="flex items-center justify-center h-96 text-lg text-gray-300">
         جارِ تحميل المطاعم...
      </div>
    )
  }

  return (
    <div className="py-10">
      <h1 className="text-3xl font-extrabold text-center mb-8 text-sky-600">
         قائمة المطاعم
      </h1>

      {/*  شريط البحث */}
      <div className="mb-6 px-2">
        <div className="relative">
          <Search className="absolute right-4 top-1/2 -translate-y-1/2 w-5 h-5 text-gray-400" />
          <input
            type="text"
            placeholder="ابحث عن مطعم أو منطقة..."
            value={searchQuery}
            onChange={(e) => setSearchQuery(e.target.value)}
            className="w-full bg-gray-800 border-2 border-gray-700 rounded-2xl py-4 pr-12 pl-14 text-white placeholder:text-gray-500 focus:border-sky-500 focus:outline-none transition"
          />
          <button
            onClick={() => setShowFilters(!showFilters)}
            className={`absolute left-3 top-1/2 -translate-y-1/2 p-2 rounded-xl transition ${
              showFilters || activeFiltersCount > 0
                ? 'bg-sky-500 text-white'
                : 'bg-gray-700 text-gray-300 hover:bg-gray-600'
            }`}
          >
            <SlidersHorizontal className="w-5 h-5" />
            {activeFiltersCount > 0 && (
              <span className="absolute -top-1 -right-1 w-5 h-5 bg-red-500 text-white text-xs font-bold rounded-full flex items-center justify-center">
                {activeFiltersCount}
              </span>
            )}
          </button>
        </div>
        
        {/*  الفلاتر المتقدمة */}
        {showFilters && (
          <div className="mt-4 bg-gray-800/50 rounded-2xl p-4 border border-gray-700 space-y-4 animate-fade-in">
            {/* الترتيب */}
            <div>
              <label className="text-sm font-semibold text-gray-400 mb-2 block">ترتيب حسب</label>
              <div className="flex gap-2 flex-wrap">
                <button
                  onClick={() => setSortBy('distance')}
                  className={`px-4 py-2 rounded-xl text-sm font-medium transition ${
                    sortBy === 'distance' ? 'bg-sky-500 text-white' : 'bg-gray-700 text-gray-300'
                  }`}
                >
                  <Navigation className="w-4 h-4 inline ml-1" />
                  الأقرب
                </button>
                <button
                  onClick={() => setSortBy('rating')}
                  className={`px-4 py-2 rounded-xl text-sm font-medium transition ${
                    sortBy === 'rating' ? 'bg-sky-500 text-white' : 'bg-gray-700 text-gray-300'
                  }`}
                >
                  <Star className="w-4 h-4 inline ml-1" />
                  الأعلى تقييماً
                </button>
                <button
                  onClick={() => setSortBy('orders')}
                  className={`px-4 py-2 rounded-xl text-sm font-medium transition ${
                    sortBy === 'orders' ? 'bg-sky-500 text-white' : 'bg-gray-700 text-gray-300'
                  }`}
                >
                  <ShoppingBag className="w-4 h-4 inline ml-1" />
                  الأكثر طلباً
                </button>
              </div>
            </div>

            {/* نوع المطبخ */}
            <div>
              <label className="text-sm font-semibold text-gray-400 mb-2 block">نوع المطبخ</label>
              <div className="flex gap-2 flex-wrap">
                {CUISINE_TYPES.map(cuisine => (
                  <button
                    key={cuisine.value}
                    onClick={() => setSelectedCuisine(cuisine.value)}
                    className={`px-4 py-2 rounded-xl text-sm font-medium transition ${
                      selectedCuisine === cuisine.value ? 'bg-amber-500 text-white' : 'bg-gray-700 text-gray-300'
                    }`}
                  >
                    {cuisine.label}
                  </button>
                ))}
              </div>
            </div>

            {/* التقييم الأدنى */}
            <div>
              <label className="text-sm font-semibold text-gray-400 mb-2 block">
                الحد الأدنى للتقييم: {minRating > 0 ? `${minRating}+ ` : 'الكل'}
              </label>
              <div className="flex gap-2 flex-wrap">
                {[0, 3, 3.5, 4, 4.5].map(rating => (
                  <button
                    key={rating}
                    onClick={() => setMinRating(rating)}
                    className={`px-4 py-2 rounded-xl text-sm font-medium transition flex items-center gap-1 ${
                      minRating === rating ? 'bg-yellow-500 text-white' : 'bg-gray-700 text-gray-300'
                    }`}
                  >
                    {rating === 0 ? 'الكل' : (
                      <>
                        <Star className="w-3 h-3 fill-current" />
                        {rating}+
                      </>
                    )}
                  </button>
                ))}
              </div>
            </div>

            {/* زر إعادة تعيين الفلاتر */}
            {activeFiltersCount > 0 && (
              <button
                onClick={() => {
                  setSearchQuery('')
                  setSelectedCity('')
                  setSelectedCuisine('')
                  setMinRating(0)
                  setSortBy('distance')
                }}
                className="w-full py-3 bg-red-500/20 text-red-400 rounded-xl font-medium hover:bg-red-500/30 transition flex items-center justify-center gap-2"
              >
                <X className="w-4 h-4" />
                إعادة تعيين الفلاتر ({activeFiltersCount})
              </button>
            )}
          </div>
        )}
      </div>

      {/*  شريط الإعلانات الممولة */}
      {promotions.length > 0 && (
        <div className="mb-8">
          <div className="flex items-center justify-center gap-2 mb-3">
            <Megaphone className="w-5 h-5 text-purple-500" />
            <span className="font-bold text-purple-600">إعلانات مميزة</span>
          </div>
          
          <div className="relative">
            {/* الإعلان الحالي */}
            <Link
              to={`/menu?restaurant=${promotions[currentPromoIndex]?.ownerId}`}
              onClick={async () => {
                // زيادة عداد المشاهدات
                try {
                  await updateDoc(doc(db, 'promotions', promotions[currentPromoIndex].id), {
                    viewsCount: increment(1)
                  })
                } catch {}
              }}
              className="block bg-gradient-to-r from-purple-900 via-purple-800 to-pink-900 rounded-2xl shadow-xl overflow-hidden"
            >
              {/* شارة الإعلان */}
              <div className="absolute top-3 right-3 z-10 inline-flex items-center gap-1 px-3 py-1 bg-gradient-to-r from-purple-500 to-pink-500 text-white text-xs font-bold rounded-full shadow">
                <Megaphone className="w-3 h-3" />
                إعلان
              </div>

              {/* الوسائط */}
              {promotions[currentPromoIndex]?.mediaUrl && (
                <div className="relative h-48">
                  {promotions[currentPromoIndex].type === 'video' ? (
                    <>
                      <video
                        src={promotions[currentPromoIndex].mediaUrl}
                        className="w-full h-full object-cover"
                        muted
                        loop
                        autoPlay
                        playsInline
                      />
                      <div className="absolute inset-0 flex items-center justify-center pointer-events-none">
                        <div className="w-12 h-12 bg-white/20 rounded-full flex items-center justify-center backdrop-blur-sm">
                          <Play className="w-6 h-6 text-white fill-white" />
                        </div>
                      </div>
                    </>
                  ) : (
                    <img
                      src={promotions[currentPromoIndex].mediaUrl}
                      alt={promotions[currentPromoIndex].title}
                      className="w-full h-full object-cover"
                    />
                  )}
                </div>
              )}

              {/* المحتوى */}
              <div className="p-4">
                <div className="flex items-center gap-2 mb-2">
                  {promotions[currentPromoIndex]?.restaurantName && (
                    <span className="text-xs bg-white/20 text-white px-2 py-1 rounded-full">
                      {promotions[currentPromoIndex].restaurantName}
                    </span>
                  )}
                </div>
                {promotions[currentPromoIndex]?.title && (
                  <h3 className="text-lg font-bold text-white">{promotions[currentPromoIndex].title}</h3>
                )}
                {promotions[currentPromoIndex]?.description && (
                  <p className="text-purple-100 text-sm mt-1 line-clamp-2">{promotions[currentPromoIndex].description}</p>
                )}
              </div>
            </Link>

            {/* أزرار التنقل */}
            {promotions.length > 1 && (
              <>
                <button
                  onClick={(e) => {
                    e.preventDefault()
                    setCurrentPromoIndex((prev) => (prev === 0 ? promotions.length - 1 : prev - 1))
                  }}
                  className="absolute left-2 top-1/2 -translate-y-1/2 p-2 bg-white/80 hover:bg-white rounded-full shadow-lg transition z-10"
                >
                  <ChevronLeft className="w-5 h-5 text-gray-800" />
                </button>
                <button
                  onClick={(e) => {
                    e.preventDefault()
                    setCurrentPromoIndex((prev) => (prev === promotions.length - 1 ? 0 : prev + 1))
                  }}
                  className="absolute right-2 top-1/2 -translate-y-1/2 p-2 bg-white/80 hover:bg-white rounded-full shadow-lg transition z-10"
                >
                  <ChevronRight className="w-5 h-5 text-gray-800" />
                </button>
              </>
            )}

            {/* مؤشرات الصفحات */}
            {promotions.length > 1 && (
              <div className="flex justify-center gap-2 mt-3">
                {promotions.map((_, idx) => (
                  <button
                    key={idx}
                    onClick={() => setCurrentPromoIndex(idx)}
                    className={`w-2 h-2 rounded-full transition ${
                      idx === currentPromoIndex ? 'bg-purple-500 w-4' : 'bg-gray-300'
                    }`}
                  />
                ))}
              </div>
            )}
          </div>
        </div>
      )}

      {/* فلتر المدن */}
      {availableCities.length > 0 && (
        <div className="mb-6 flex flex-wrap items-center justify-center gap-2">
          <div className="flex items-center gap-2 text-sky-600">
            <Filter className="w-5 h-5" />
            <span className="font-semibold">المدينة:</span>
          </div>
          <button
            onClick={() => setSelectedCity('')}
            className={`px-4 py-2 rounded-full text-sm font-medium transition-all ${
              !selectedCity
                ? 'bg-sky-500 text-white shadow-lg'
                : 'bg-sky-100 text-sky-700 hover:bg-sky-200'
            }`}
          >
            الكل
          </button>
          {availableCities.map(city => (
            <button
              key={city}
              onClick={() => setSelectedCity(city)}
              className={`px-4 py-2 rounded-full text-sm font-medium transition-all flex items-center gap-1 ${
                selectedCity === city
                  ? 'bg-sky-500 text-white shadow-lg'
                  : 'bg-sky-100 text-sky-700 hover:bg-sky-200'
              }`}
            >
              <MapPin className="w-4 h-4" />
              {city}
            </button>
          ))}
          {selectedCity && (
            <button
              onClick={() => setSelectedCity('')}
              className="p-2 text-gray-400 hover:text-red-500 transition-colors"
              title="إزالة الفلتر"
            >
              <X className="w-5 h-5" />
            </button>
          )}
        </div>
      )}

      {filteredRestaurants.length === 0 && (
        <div className="text-center py-10">
          <div className="w-20 h-20 bg-sky-100 rounded-full flex items-center justify-center mx-auto mb-4">
            <AlertCircle className="w-10 h-10 text-sky-500" />
          </div>
          {userLocation ? (
            <>
              <p className="text-gray-600 text-lg font-semibold"> لا توجد مطاعم قريبة منك</p>
              <p className="text-gray-400 text-sm mt-2">نعرض المطاعم ضمن {MAX_DELIVERY_DISTANCE} كم فقط</p>
            </>
          ) : (
            <>
              <p className="text-gray-600 text-lg font-semibold">
                {selectedCity ? ` لا توجد مطاعم في ${selectedCity}` : ' لا توجد مطاعم حالياً'}
              </p>
            </>
          )}
        </div>
      )}

      {/* رسالة توضيحية للمسافة */}
      {userLocation && filteredRestaurants.length > 0 && (role === 'customer' || role === 'courier') && (
        <div className="mb-6 bg-sky-50 border border-sky-200 rounded-xl p-4 flex items-center gap-3">
          <Navigation className="w-6 h-6 text-sky-500 flex-shrink-0" />
          <div>
            <p className="text-sky-700 font-semibold">نعرض لك المطاعم القريبة فقط</p>
            <p className="text-sky-600 text-sm">المسافة القصوى للتوصيل: {MAX_DELIVERY_DISTANCE} كم</p>
          </div>
        </div>
      )}

      {/* === الأسر المميزة (Premium) - عرض مميز بمربعات === */}
      {filteredRestaurants.filter(r => r.packageType === 'premium').length > 0 && (
        <div className="mb-8">
          <div className="flex items-center justify-between mb-4">
            <div className="flex items-center gap-2">
              <Crown className="w-6 h-6 text-amber-500" />
              <h2 className="text-xl font-bold text-amber-400"> الأسر المميزة</h2>
            </div>
            <span className="text-sm text-gray-400">{filteredRestaurants.filter(r => r.packageType === 'premium').length} أسرة</span>
          </div>
          
          <div className="grid grid-cols-2 xs:grid-cols-2 sm:grid-cols-3 lg:grid-cols-4 gap-3 sm:gap-4">
            {filteredRestaurants.filter(r => r.packageType === 'premium').map(r => (
              <Link
                key={r.id}
                to={`/menu?restaurant=${r.id}${refSource ? `&ref=${refSource}` : ''}`}
                onClick={() => logVisit(r.id, user?.uid, refSource || 'direct')}
                className="group bg-[#1E293B] border border-amber-500/30 rounded-[16px] shadow-lg shadow-amber-500/10 hover:shadow-xl hover:shadow-amber-500/20 hover:-translate-y-2 transform transition-all duration-300 p-3 sm:p-4 flex flex-col items-center text-center relative overflow-hidden active:scale-[0.98]"
              >
                {/* خلفية متوهجة */}
                <div className="absolute inset-0 bg-gradient-to-br from-amber-500/5 to-purple-500/5 opacity-0 group-hover:opacity-100 transition-opacity" />
                
                {/* شارة مميزة */}
                <div className="absolute top-2 right-2">
                  <div className="bg-gradient-to-r from-amber-500 to-orange-500 text-white text-[10px] font-bold px-2 py-0.5 rounded-full shadow flex items-center gap-1">
                    <Crown className="w-3 h-3" />
                    مميزة
                  </div>
                </div>

                {/* شارة المسافة */}
                {r.distance !== undefined && (
                  <div className="absolute top-2 left-2 bg-sky-500/90 backdrop-blur text-white text-[10px] font-bold px-2 py-0.5 rounded-full flex items-center gap-0.5">
                    <Navigation className="w-2.5 h-2.5" />
                    {r.distance < 1 ? `${Math.round(r.distance * 1000)}م` : `${r.distance.toFixed(1)}كم`}
                  </div>
                )}
                
                {/* الشعار في دائرة */}
                <div className="relative mt-6 mb-3">
                  {r.logoUrl ? (
                    <img
                      src={r.logoUrl}
                      alt={r.name}
                      className="w-20 h-20 object-cover rounded-full border-4 border-amber-400 shadow-lg group-hover:scale-110 transition-transform duration-300"
                    />
                  ) : (
                    <div className="w-20 h-20 flex items-center justify-center rounded-full bg-slate-700 border-4 border-amber-400 shadow-lg group-hover:scale-110 transition-transform duration-300">
                      <Utensils className="w-8 h-8 text-amber-400" />
                    </div>
                  )}
                </div>
                
                {/* اسم الأسرة */}
                <h3 className="font-bold text-sm text-white line-clamp-1">{r.name}</h3>
                
                {/* المدينة */}
                {r.city && (
                  <p className="text-xs text-gray-400 flex items-center gap-0.5 mt-1 mb-2">
                    <MapPin className="w-3 h-3" />
                    {r.city}
                  </p>
                )}

                {/* شارة التوثيق - كبسولة تحت الاسم */}
                {(r.isVerified || r.licenseStatus === 'approved') ? (
                  <div className="bg-emerald-500/20 border border-emerald-500/50 text-emerald-400 text-[11px] font-bold px-3 py-1 rounded-full flex items-center gap-1 mb-2">
                    <CheckCircle className="w-3 h-3" />
                     أسرة موثقة
                  </div>
                ) : (
                  <div className="bg-amber-500/20 border border-amber-500/50 text-amber-400 text-[11px] font-bold px-3 py-1 rounded-full flex items-center gap-1 mb-2">
                    <Clock className="w-3 h-3" />
                     بانتظار التوثيق
                  </div>
                )}

                {/* إحصائيات سريعة */}
                <div className="flex items-center justify-center gap-3 text-[10px] text-gray-400">
                  {r.averageRating !== undefined && r.averageRating > 0 && (
                    <span className="flex items-center gap-0.5">
                      <Star className="w-3 h-3 text-amber-400 fill-amber-400" />
                      {r.averageRating.toFixed(1)}
                    </span>
                  )}
                  {r.totalOrders !== undefined && r.totalOrders > 0 && (
                    <span className="flex items-center gap-0.5">
                      <ShoppingBag className="w-3 h-3" />
                      {r.totalOrders}
                    </span>
                  )}
                </div>

                {/* شارات التصنيف */}
                <div className="flex gap-1 mt-2">
                  {r.sellerTier === 'gold' && (
                    <span className="bg-gradient-to-r from-amber-400 to-yellow-400 text-white text-[9px] font-bold px-1.5 py-0.5 rounded-full"> Gold</span>
                  )}
                  {r.sellerTier === 'silver' && (
                    <span className="bg-gradient-to-r from-gray-400 to-gray-500 text-white text-[9px] font-bold px-1.5 py-0.5 rounded-full"> Silver</span>
                  )}
                </div>

                {/* شارات التوصيل والاستلام */}
                <div className="flex flex-wrap gap-1 mt-1.5 justify-center">
                  {(r.allowDelivery !== false) && (
                    <span className="inline-flex items-center gap-0.5 bg-sky-500/20 text-sky-400 text-[9px] font-medium px-1.5 py-0.5 rounded-full">
                      <Truck className="w-2.5 h-2.5" />
                      توصيل
                    </span>
                  )}
                  {r.allowPickup && (
                    <span className="inline-flex items-center gap-0.5 bg-green-500/20 text-green-400 text-[9px] font-medium px-1.5 py-0.5 rounded-full">
                      <Store className="w-2.5 h-2.5" />
                      استلام
                    </span>
                  )}
                </div>
              </Link>
            ))}
          </div>
        </div>
      )}

      {/* === باقي الأسر (المجانية) - العرض العادي === */}
      {filteredRestaurants.filter(r => r.packageType !== 'premium').length > 0 && (
        <div>
          {filteredRestaurants.filter(r => r.packageType === 'premium').length > 0 && (
            <div className="flex items-center gap-2 mb-4">
              <Utensils className="w-5 h-5 text-gray-400" />
              <h2 className="text-lg font-bold text-gray-300">جميع الأسر</h2>
            </div>
          )}
          
          <div className="grid grid-cols-1 xs:grid-cols-2 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-3 gap-4 sm:gap-6">
            {filteredRestaurants.filter(r => r.packageType !== 'premium').map(r => (
              <Link
                key={r.id}
                to={`/menu?restaurant=${r.id}${refSource ? `&ref=${refSource}` : ''}`}
                onClick={() => logVisit(r.id, user?.uid, refSource || 'direct')}
                className="group bg-[#1E293B] rounded-[16px] shadow-lg shadow-black/20 hover:shadow-xl hover:shadow-black/30 hover:-translate-y-1 transform transition-all duration-300 p-4 sm:p-6 flex flex-col items-center text-center relative overflow-hidden active:scale-[0.98]"
              >
                {/* شارة المسافة */}
                {r.distance !== undefined && (
                  <div className="absolute top-3 left-3 bg-sky-500/90 backdrop-blur-sm text-white text-xs font-bold px-3 py-1 rounded-full flex items-center gap-1">
                    <Navigation className="w-3 h-3" />
                    {r.distance < 1 ? `${Math.round(r.distance * 1000)} م` : `${r.distance.toFixed(1)} كم`}
                  </div>
                )}

                {/* شارات التصنيف في الأعلى */}
                <div className="absolute top-3 right-3 flex flex-col gap-1.5">
                  {r.sellerTier === 'gold' && (
                    <div className="bg-gradient-to-r from-amber-400 to-yellow-500 text-white text-xs font-bold px-2.5 py-1 rounded-full flex items-center gap-1 shadow-lg">
                      <Crown className="w-3 h-3" />
                      Gold
                    </div>
                  )}
                  {r.sellerTier === 'silver' && (
                    <div className="bg-gradient-to-r from-gray-300 to-gray-400 text-gray-800 text-xs font-bold px-2.5 py-1 rounded-full flex items-center gap-1 shadow-lg">
                      <Medal className="w-3 h-3" />
                      Silver
                    </div>
                  )}
                </div>
                
                {/* الشعار في دائرة */}
                <div className="mt-2 mb-4">
                  {r.logoUrl ? (
                    <img
                      src={r.logoUrl}
                      alt={r.name}
                      className={`w-24 h-24 object-cover rounded-full border-4 shadow-lg group-hover:scale-105 transition-transform duration-300 ${
                        r.sellerTier === 'gold' 
                          ? 'border-amber-400 ring-4 ring-amber-400/30' 
                          : r.sellerTier === 'silver'
                          ? 'border-gray-300 ring-4 ring-gray-300/30'
                          : 'border-slate-500'
                      }`}
                    />
                  ) : (
                    <div className={`w-24 h-24 flex items-center justify-center rounded-full text-4xl border-4 shadow-lg group-hover:scale-105 transition-transform duration-300 ${
                      r.sellerTier === 'gold' 
                        ? 'bg-amber-900/50 border-amber-400' 
                        : r.sellerTier === 'silver'
                        ? 'bg-gray-700 border-gray-300'
                        : 'bg-slate-700 border-slate-500'
                    }`}>
                      
                    </div>
                  )}
                </div>
                
                {/* اسم الأسرة */}
                <h3 className="font-bold text-xl text-white mb-1">{r.name}</h3>
                
                {/* الموقع */}
                {r.city && (
                  <p className="text-sm text-gray-400 flex items-center justify-center gap-1 mb-3">
                    <MapPin className="w-4 h-4" />
                    {r.city}
                  </p>
                )}

                {/* شارة التوثيق - كبسولة تحت الاسم */}
                {(r.isVerified || r.licenseStatus === 'approved') ? (
                  <div className="bg-emerald-500/20 border border-emerald-500/50 text-emerald-400 text-sm font-bold px-4 py-1.5 rounded-full flex items-center gap-2 mb-3">
                    <CheckCircle className="w-4 h-4" />
                     أسرة موثقة
                  </div>
                ) : (
                  <div className="bg-amber-500/20 border border-amber-500/50 text-amber-400 text-sm font-bold px-4 py-1.5 rounded-full flex items-center gap-2 mb-3">
                    <Clock className="w-4 h-4" />
                     بانتظار التوثيق
                  </div>
                )}
                
                {/* شارات التوصيل والاستلام */}
                <div className="flex items-center justify-center gap-2">
                  {(r.allowDelivery === undefined || r.allowDelivery === true) && (
                    <span className="inline-flex items-center gap-1 px-3 py-1 bg-sky-500/20 text-sky-400 text-xs font-semibold rounded-full">
                      <Truck className="w-3 h-3" />
                      توصيل
                    </span>
                  )}
                  {r.allowPickup && (
                    <span className="inline-flex items-center gap-1 px-3 py-1 bg-green-500/20 text-green-400 text-xs font-semibold rounded-full">
                      <Store className="w-3 h-3" />
                      استلام
                    </span>
                  )}
                </div>
              </Link>
            ))}
          </div>
        </div>
      )}
    </div>
  )
}

==========================================================================================
FILE: src/pages/SetupDeveloper.tsx
==========================================================================================
// src/pages/SetupDeveloper.tsx
// صفحة مخفية لإنشاء حساب المطور الرئيسي
import React, { useState } from 'react'
import { createUserWithEmailAndPassword } from 'firebase/auth'
import { doc, setDoc, serverTimestamp } from 'firebase/firestore'
import { auth, db } from '@/firebase'
import { useNavigate } from 'react-router-dom'
import { Shield, Sparkles, Lock, Mail, Key, CheckCircle } from 'lucide-react'

// البريد الإلكتروني المسموح به فقط
const ALLOWED_EMAIL = 'afrtalbyt2026@gmail.com'

export const SetupDeveloper: React.FC = () => {
  const nav = useNavigate()
  const [email, setEmail] = useState('')
  const [password, setPassword] = useState('')
  const [loading, setLoading] = useState(false)
  const [error, setError] = useState('')
  const [success, setSuccess] = useState(false)

  const handleSetup = async (e: React.FormEvent) => {
    e.preventDefault()
    setError('')
    
    // التحقق من البريد المسموح
    if (email.trim().toLowerCase() !== ALLOWED_EMAIL) {
      setError(' هذا البريد غير مسموح له بإنشاء حساب مطور')
      return
    }
    
    if (password.length < 6) {
      setError('كلمة المرور يجب أن تكون 6 أحرف على الأقل')
      return
    }
    
    setLoading(true)
    
    try {
      // إنشاء الحساب في Firebase Auth
      const userCred = await createUserWithEmailAndPassword(auth, email.trim(), password)
      const uid = userCred.user.uid
      
      // إضافة بيانات المطور في Firestore
      await setDoc(doc(db, 'users', uid), {
        email: email.trim(),
        name: 'المطور الرئيسي',
        role: 'developer',
        createdAt: serverTimestamp(),
      })
      
      setSuccess(true)
      
      // الانتقال للوحة المطور بعد 2 ثانية
      setTimeout(() => {
        nav('/developer')
      }, 2000)
      
    } catch (err: any) {
      console.error('Setup error:', err)
      if (err.code === 'auth/email-already-in-use') {
        setError('هذا الحساب موجود مسبقاً، جرب تسجيل الدخول')
      } else if (err.code === 'auth/invalid-email') {
        setError('البريد الإلكتروني غير صالح')
      } else if (err.code === 'auth/weak-password') {
        setError('كلمة المرور ضعيفة جداً')
      } else {
        setError('حدث خطأ: ' + (err.message || 'غير معروف'))
      }
    } finally {
      setLoading(false)
    }
  }

  if (success) {
    return (
      <div className="min-h-[70vh] flex items-center justify-center">
        <div className="text-center bg-gradient-to-br from-green-500 to-emerald-600 text-white p-10 rounded-3xl shadow-2xl">
          <CheckCircle className="w-20 h-20 mx-auto mb-4" />
          <h1 className="text-2xl font-bold mb-2"> تم إنشاء الحساب بنجاح!</h1>
          <p>جاري تحويلك للوحة المطور...</p>
        </div>
      </div>
    )
  }

  return (
    <div className="min-h-[70vh] flex items-center justify-center">
      <div className="w-full max-w-md">
        <div className="bg-gradient-to-br from-gray-900 via-gray-800 to-gray-900 rounded-3xl shadow-2xl overflow-hidden">
          {/* الرأس */}
          <div className="bg-gradient-to-r from-purple-600 via-pink-600 to-red-600 p-6 text-center">
            <div className="w-20 h-20 bg-white/20 backdrop-blur rounded-full flex items-center justify-center mx-auto mb-4">
              <Shield className="w-10 h-10 text-white" />
            </div>
            <h1 className="text-2xl font-bold text-white flex items-center justify-center gap-2">
              <Sparkles className="w-6 h-6" />
              إعداد حساب المطور
              <Sparkles className="w-6 h-6" />
            </h1>
            <p className="text-white/80 text-sm mt-2"> للاستخدام المحدود فقط</p>
          </div>
          
          {/* النموذج */}
          <form onSubmit={handleSetup} className="p-6 space-y-5">
            {error && (
              <div className="bg-red-500/20 border border-red-500/50 text-red-400 rounded-xl p-3 text-sm text-center">
                {error}
              </div>
            )}
            
            <div>
              <label className="block text-gray-400 text-sm mb-2 flex items-center gap-2">
                <Mail className="w-4 h-4" />
                البريد الإلكتروني
              </label>
              <input
                type="email"
                value={email}
                onChange={(e) => setEmail(e.target.value)}
                placeholder="أدخل البريد المخصص"
                className="w-full px-4 py-3 bg-gray-700/50 border border-gray-600 rounded-xl text-white placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-purple-500"
                required
              />
            </div>
            
            <div>
              <label className="block text-gray-400 text-sm mb-2 flex items-center gap-2">
                <Key className="w-4 h-4" />
                كلمة المرور
              </label>
              <input
                type="password"
                value={password}
                onChange={(e) => setPassword(e.target.value)}
                placeholder="أدخل كلمة المرور"
                className="w-full px-4 py-3 bg-gray-700/50 border border-gray-600 rounded-xl text-white placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-purple-500"
                required
              />
            </div>
            
            <button
              type="submit"
              disabled={loading}
              className="w-full py-4 bg-gradient-to-r from-purple-600 via-pink-600 to-red-600 text-white font-bold rounded-xl hover:opacity-90 transition-all disabled:opacity-50 flex items-center justify-center gap-2"
            >
              {loading ? (
                <>
                  <div className="w-5 h-5 border-2 border-white border-t-transparent rounded-full animate-spin" />
                  جاري الإنشاء...
                </>
              ) : (
                <>
                  <Lock className="w-5 h-5" />
                  إنشاء حساب المطور
                </>
              )}
            </button>
            
            <p className="text-gray-500 text-xs text-center">
               هذه الصفحة محدودة للبريد المحدد فقط
            </p>
          </form>
        </div>
      </div>
    </div>
  )
}

==========================================================================================
FILE: src/pages/SupportAdmin.tsx
==========================================================================================
// src/pages/SupportAdmin.tsx
// لوحة تحكم الدعم الفني للمطور/الإدمن
import React, { useState, useEffect, useRef } from 'react'
import { 
  collection, query, orderBy, onSnapshot, 
  doc, updateDoc, serverTimestamp, addDoc, where, getDoc
} from 'firebase/firestore'
import { db } from '@/firebase'
import { useAuth } from '@/auth'
import { useToast } from '@/components/ui/Toast'
import { deductPoints } from '@/utils/pointsService'
import { POINTS_CONFIG } from '@/types'
import { 
  Headphones, Send, Loader2, MessageCircle, Clock, 
  CheckCircle, User, AlertTriangle, ChevronRight,
  Search, Filter, Bot, XCircle, RefreshCw, MinusCircle,
  Store, Truck, Shield
} from 'lucide-react'

interface SupportChat {
  id: string
  userId: string
  userName: string
  userRole: string
  status: 'active' | 'waiting' | 'resolved' | 'closed'
  subject?: string
  priority: 'low' | 'medium' | 'high' | 'urgent'
  lastMessage?: string
  lastMessageAt?: any
  createdAt: any
  unreadBySupport?: number
}

interface SupportMessage {
  id: string
  chatId: string
  senderId: string
  senderName: string
  senderRole: 'user' | 'support' | 'bot'
  message: string
  createdAt: any
}

const STATUS_CONFIG = {
  waiting: { label: 'جديدة', color: 'amber', icon: Clock },
  active: { label: 'نشطة', color: 'green', icon: MessageCircle },
  resolved: { label: 'محلولة', color: 'blue', icon: CheckCircle },
  closed: { label: 'مغلقة', color: 'gray', icon: XCircle },
}

const PRIORITY_CONFIG = {
  urgent: { label: 'عاجل', color: 'red' },
  high: { label: 'مرتفع', color: 'orange' },
  medium: { label: 'متوسط', color: 'amber' },
  low: { label: 'منخفض', color: 'green' },
}

export const SupportAdmin: React.FC = () => {
  const { user } = useAuth()
  const toast = useToast()
  const messagesEndRef = useRef<HTMLDivElement>(null)
  const inputRef = useRef<HTMLInputElement>(null)

  const [chats, setChats] = useState<SupportChat[]>([])
  const [selectedChat, setSelectedChat] = useState<SupportChat | null>(null)
  const [messages, setMessages] = useState<SupportMessage[]>([])
  const [loading, setLoading] = useState(true)
  const [sending, setSending] = useState(false)
  const [inputText, setInputText] = useState('')
  const [filter, setFilter] = useState<'all' | 'waiting' | 'active'>('all')
  const [searchQuery, setSearchQuery] = useState('')

  // جلب جميع المحادثات
  useEffect(() => {
    const q = query(
      collection(db, 'supportChats'),
      orderBy('lastMessageAt', 'desc')
    )

    const unsub = onSnapshot(q, (snap) => {
      const data = snap.docs.map(d => ({ id: d.id, ...d.data() } as SupportChat))
      setChats(data)
      setLoading(false)
    })

    return () => unsub()
  }, [])

  // جلب رسائل المحادثة المحددة
  useEffect(() => {
    if (!selectedChat?.id) return

    const q = query(
      collection(db, 'supportChats', selectedChat.id, 'messages'),
      orderBy('createdAt', 'asc')
    )

    const unsub = onSnapshot(q, (snap) => {
      const msgs = snap.docs.map(d => ({ id: d.id, ...d.data() } as SupportMessage))
      setMessages(msgs)
      
      // تحديث القراءة
      if (selectedChat.unreadBySupport && selectedChat.unreadBySupport > 0) {
        updateDoc(doc(db, 'supportChats', selectedChat.id), {
          unreadBySupport: 0
        })
      }
    })

    setTimeout(() => inputRef.current?.focus(), 100)
    return () => unsub()
  }, [selectedChat?.id])

  // التمرير للأسفل
  useEffect(() => {
    messagesEndRef.current?.scrollIntoView({ behavior: 'smooth' })
  }, [messages])

  // إرسال رد
  const sendReply = async () => {
    if (!inputText.trim() || !selectedChat?.id || sending) return

    setSending(true)

    try {
      await addDoc(collection(db, 'supportChats', selectedChat.id, 'messages'), {
        chatId: selectedChat.id,
        senderId: user?.uid,
        senderName: 'فريق الدعم',
        senderRole: 'support',
        message: inputText.trim(),
        createdAt: serverTimestamp(),
      })

      await updateDoc(doc(db, 'supportChats', selectedChat.id), {
        status: 'active',
        lastMessage: inputText.trim(),
        lastMessageAt: serverTimestamp(),
        updatedAt: serverTimestamp(),
        unreadByUser: (selectedChat as any).unreadByUser || 0 + 1,
      })

      setInputText('')
      toast.success('تم إرسال الرد')
    } catch (err) {
      toast.error('فشل إرسال الرد')
    } finally {
      setSending(false)
    }
  }

  // تغيير حالة المحادثة
  const updateChatStatus = async (status: 'active' | 'resolved' | 'closed') => {
    if (!selectedChat?.id) return

    await updateDoc(doc(db, 'supportChats', selectedChat.id), {
      status,
      updatedAt: serverTimestamp()
    })

    setSelectedChat({ ...selectedChat, status })
    toast.success('تم تحديث الحالة')
  }

  // نافذة خصم النقاط
  const [showPenaltyModal, setShowPenaltyModal] = useState(false)
  const [penaltyTarget, setPenaltyTarget] = useState<'restaurant' | 'courier'>('restaurant')
  const [penaltyTargetId, setPenaltyTargetId] = useState('')
  const [penaltyTargetName, setPenaltyTargetName] = useState('')
  const [penaltyAmount, setPenaltyAmount] = useState(10)
  const [penaltyReason, setPenaltyReason] = useState('')
  const [processingPenalty, setProcessingPenalty] = useState(false)

  // تأكيد الشكوى وخصم النقاط
  const confirmComplaintAndDeduct = async () => {
    if (!penaltyTargetId || !penaltyReason || penaltyAmount <= 0) {
      toast.error('يرجى ملء جميع البيانات')
      return
    }

    setProcessingPenalty(true)

    try {
      const result = await deductPoints(
        penaltyTargetId,
        penaltyTarget,
        penaltyAmount,
        penaltyReason,
        {
          ticketId: selectedChat?.id,
          adminId: user?.uid
        }
      )

      if (result.success) {
        // إرسال رسالة في المحادثة
        if (selectedChat?.id) {
          await addDoc(collection(db, 'supportChats', selectedChat.id, 'messages'), {
            chatId: selectedChat.id,
            senderId: 'system',
            senderName: 'النظام',
            senderRole: 'bot',
            message: ` تم تأكيد الشكوى وخصم ${penaltyAmount} نقطة من ${penaltyTarget === 'restaurant' ? 'الأسرة' : 'المندوب'}.\n\n${result.isSuspended ? ' تم إيقاف الحساب تلقائياً!' : result.isWarning ? ' تنبيه: النقاط منخفضة!' : ''}`,
            createdAt: serverTimestamp(),
          })
        }

        toast.success(result.message)
        
        if (result.isSuspended) {
          toast.error(' تم إيقاف الحساب تلقائياً!')
        }

        setShowPenaltyModal(false)
        setPenaltyReason('')
        setPenaltyAmount(10)
      } else {
        toast.error(result.message)
      }
    } catch (err) {
      toast.error('حدث خطأ في خصم النقاط')
    } finally {
      setProcessingPenalty(false)
    }
  }

  // تصفية المحادثات
  const filteredChats = chats.filter(chat => {
    if (filter === 'waiting' && chat.status !== 'waiting') return false
    if (filter === 'active' && chat.status !== 'active') return false
    if (searchQuery && !chat.userName.includes(searchQuery) && !chat.subject?.includes(searchQuery)) return false
    return true
  })

  if (loading) {
    return (
      <div className="flex items-center justify-center min-h-[60vh]">
        <Loader2 className="w-8 h-8 animate-spin text-sky-500" />
      </div>
    )
  }

  return (
    <div className="max-w-6xl mx-auto">
      <h1 className="text-2xl font-bold text-gray-800 mb-6 flex items-center gap-3">
        <Headphones className="w-8 h-8 text-sky-500" />
        إدارة الدعم الفني
      </h1>

      <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
        {/* قائمة المحادثات */}
        <div className="lg:col-span-1 bg-white rounded-2xl shadow-lg overflow-hidden">
          {/* البحث والفلترة */}
          <div className="p-4 border-b border-gray-100 space-y-3">
            <div className="relative">
              <Search className="w-5 h-5 text-gray-400 absolute right-3 top-1/2 -translate-y-1/2" />
              <input
                type="text"
                value={searchQuery}
                onChange={(e) => setSearchQuery(e.target.value)}
                placeholder="بحث..."
                className="w-full pr-10 pl-4 py-2 bg-gray-100 rounded-xl focus:outline-none focus:ring-2 focus:ring-sky-300"
              />
            </div>
            <div className="flex gap-2">
              {(['all', 'waiting', 'active'] as const).map((f) => (
                <button
                  key={f}
                  onClick={() => setFilter(f)}
                  className={`px-3 py-1 rounded-lg text-sm font-medium transition ${
                    filter === f ? 'bg-sky-100 text-sky-700' : 'text-gray-500 hover:bg-gray-100'
                  }`}
                >
                  {f === 'all' ? 'الكل' : f === 'waiting' ? 'جديدة' : 'نشطة'}
                  {f === 'waiting' && (
                    <span className="mr-1 px-1.5 py-0.5 bg-amber-500 text-white rounded-full text-xs">
                      {chats.filter(c => c.status === 'waiting').length}
                    </span>
                  )}
                </button>
              ))}
            </div>
          </div>

          {/* قائمة المحادثات */}
          <div className="max-h-[500px] overflow-y-auto divide-y divide-gray-100">
            {filteredChats.length === 0 ? (
              <div className="p-8 text-center text-gray-500">
                <MessageCircle className="w-12 h-12 mx-auto mb-2 opacity-30" />
                <p>لا توجد محادثات</p>
              </div>
            ) : (
              filteredChats.map((chat) => {
                const statusConfig = STATUS_CONFIG[chat.status]
                const StatusIcon = statusConfig.icon
                
                return (
                  <button
                    key={chat.id}
                    onClick={() => setSelectedChat(chat)}
                    className={`w-full p-4 text-right hover:bg-gray-50 transition ${
                      selectedChat?.id === chat.id ? 'bg-sky-50' : ''
                    }`}
                  >
                    <div className="flex items-center justify-between mb-2">
                      <div className="flex items-center gap-2">
                        <User className="w-5 h-5 text-gray-400" />
                        <span className="font-bold text-gray-800">{chat.userName}</span>
                      </div>
                      {chat.unreadBySupport ? (
                        <span className="px-2 py-0.5 bg-red-500 text-white text-xs rounded-full">
                          {chat.unreadBySupport}
                        </span>
                      ) : null}
                    </div>
                    
                    <p className="text-sm text-gray-500 truncate mb-2">{chat.lastMessage || chat.subject}</p>
                    
                    <div className="flex items-center justify-between text-xs">
                      <span className={`inline-flex items-center gap-1 px-2 py-0.5 rounded-full
                        ${statusConfig.color === 'amber' ? 'bg-amber-100 text-amber-700' : ''}
                        ${statusConfig.color === 'green' ? 'bg-green-100 text-green-700' : ''}
                        ${statusConfig.color === 'blue' ? 'bg-blue-100 text-blue-700' : ''}
                        ${statusConfig.color === 'gray' ? 'bg-gray-100 text-gray-700' : ''}
                      `}>
                        <StatusIcon className="w-3 h-3" />
                        {statusConfig.label}
                      </span>
                      <span className="text-gray-400">
                        {chat.lastMessageAt?.toDate?.().toLocaleTimeString('ar-SA', { hour: '2-digit', minute: '2-digit' }) || ''}
                      </span>
                    </div>
                  </button>
                )
              })
            )}
          </div>
        </div>

        {/* منطقة المحادثة */}
        <div className="lg:col-span-2 bg-white rounded-2xl shadow-lg overflow-hidden flex flex-col" style={{ minHeight: '600px' }}>
          {!selectedChat ? (
            <div className="flex-1 flex items-center justify-center text-gray-500">
              <div className="text-center">
                <MessageCircle className="w-16 h-16 mx-auto mb-4 opacity-30" />
                <p>اختر محادثة للرد عليها</p>
              </div>
            </div>
          ) : (
            <>
              {/* هيدر المحادثة */}
              <div className="p-4 border-b border-gray-100 bg-gray-50">
                <div className="flex items-center justify-between mb-3">
                  <div>
                    <h3 className="font-bold text-gray-800 flex items-center gap-2">
                      <User className="w-5 h-5" />
                      {selectedChat.userName}
                    </h3>
                    <p className="text-sm text-gray-500">{selectedChat.subject}</p>
                  </div>
                  <div className="flex gap-2">
                    <button
                      onClick={() => updateChatStatus('resolved')}
                      className="px-3 py-1.5 bg-green-100 text-green-700 rounded-lg text-sm font-medium hover:bg-green-200 transition"
                    >
                       تم الحل
                    </button>
                    <button
                      onClick={() => updateChatStatus('closed')}
                      className="px-3 py-1.5 bg-gray-100 text-gray-700 rounded-lg text-sm font-medium hover:bg-gray-200 transition"
                    >
                      إغلاق
                    </button>
                  </div>
                </div>
                
                {/* أزرار خصم النقاط */}
                <div className="flex gap-2 pt-3 border-t border-gray-200">
                  <button
                    onClick={() => {
                      setPenaltyTarget('restaurant')
                      setPenaltyTargetName('الأسرة')
                      setShowPenaltyModal(true)
                    }}
                    className="flex items-center gap-2 px-3 py-2 bg-red-100 text-red-700 rounded-lg text-sm font-medium hover:bg-red-200 transition"
                  >
                    <Store className="w-4 h-4" />
                    خصم من الأسرة 
                  </button>
                  <button
                    onClick={() => {
                      setPenaltyTarget('courier')
                      setPenaltyTargetName('المندوب')
                      setShowPenaltyModal(true)
                    }}
                    className="flex items-center gap-2 px-3 py-2 bg-orange-100 text-orange-700 rounded-lg text-sm font-medium hover:bg-orange-200 transition"
                  >
                    <Truck className="w-4 h-4" />
                    خصم من المندوب 
                  </button>
                </div>
              </div>

              {/* الرسائل */}
              <div className="flex-1 overflow-y-auto p-4 space-y-4 bg-gray-50">
                {messages.map((msg) => (
                  <div
                    key={msg.id}
                    className={`flex ${msg.senderRole === 'support' ? 'justify-end' : 'justify-start'}`}
                  >
                    <div className={`max-w-[80%]`}>
                      {msg.senderRole !== 'support' && (
                        <div className="flex items-center gap-2 mb-1">
                          <div className={`w-6 h-6 rounded-full flex items-center justify-center ${
                            msg.senderRole === 'bot' ? 'bg-purple-100' : 'bg-gray-200'
                          }`}>
                            {msg.senderRole === 'bot' ? (
                              <Bot className="w-4 h-4 text-purple-600" />
                            ) : (
                              <User className="w-4 h-4 text-gray-600" />
                            )}
                          </div>
                          <span className="text-xs text-gray-500">{msg.senderName}</span>
                        </div>
                      )}
                      
                      <div
                        className={`rounded-2xl px-4 py-3 ${
                          msg.senderRole === 'support'
                            ? 'bg-sky-500 text-white rounded-bl-md'
                            : msg.senderRole === 'bot'
                            ? 'bg-purple-50 text-gray-800 border border-purple-100 rounded-br-md'
                            : 'bg-white text-gray-800 border border-gray-200 rounded-br-md'
                        }`}
                      >
                        <p className="whitespace-pre-wrap text-sm">{msg.message}</p>
                      </div>
                      
                      <p className={`text-xs text-gray-400 mt-1 ${msg.senderRole === 'support' ? 'text-left' : 'text-right'}`}>
                        {msg.createdAt?.toDate?.().toLocaleTimeString('ar-SA', { hour: '2-digit', minute: '2-digit' }) || ''}
                      </p>
                    </div>
                  </div>
                ))}
                <div ref={messagesEndRef} />
              </div>

              {/* حقل الإدخال */}
              <div className="p-4 border-t border-gray-100">
                <div className="flex gap-3">
                  <input
                    ref={inputRef}
                    type="text"
                    value={inputText}
                    onChange={(e) => setInputText(e.target.value)}
                    onKeyPress={(e) => e.key === 'Enter' && sendReply()}
                    placeholder="اكتب ردك هنا..."
                    className="flex-1 px-4 py-3 bg-gray-100 rounded-xl focus:outline-none focus:ring-2 focus:ring-sky-300"
                    disabled={sending}
                  />
                  <button
                    onClick={sendReply}
                    disabled={!inputText.trim() || sending}
                    className="px-6 py-3 bg-sky-500 hover:bg-sky-600 text-white rounded-xl font-medium transition disabled:opacity-50"
                  >
                    {sending ? <Loader2 className="w-5 h-5 animate-spin" /> : <Send className="w-5 h-5" />}
                  </button>
                </div>
                
                {/* ردود سريعة */}
                <div className="flex gap-2 mt-3 flex-wrap">
                  {[
                    'شكراً لتواصلك معنا',
                    'سنتحقق من الموضوع',
                    'تم حل المشكلة',
                    'يرجى مشاركة المزيد من التفاصيل',
                  ].map((quick, i) => (
                    <button
                      key={i}
                      onClick={() => setInputText(quick)}
                      className="px-3 py-1.5 bg-gray-100 hover:bg-sky-100 text-gray-600 hover:text-sky-700 rounded-full text-sm transition"
                    >
                      {quick}
                    </button>
                  ))}
                </div>
              </div>
            </>
          )}
        </div>
      </div>

      {/* إحصائيات سريعة */}
      <div className="mt-6 grid grid-cols-2 md:grid-cols-4 gap-4">
        <div className="bg-amber-50 rounded-xl p-4 text-center">
          <p className="text-3xl font-bold text-amber-600">{chats.filter(c => c.status === 'waiting').length}</p>
          <p className="text-sm text-amber-700">بانتظار الرد</p>
        </div>
        <div className="bg-green-50 rounded-xl p-4 text-center">
          <p className="text-3xl font-bold text-green-600">{chats.filter(c => c.status === 'active').length}</p>
          <p className="text-sm text-green-700">نشطة</p>
        </div>
        <div className="bg-blue-50 rounded-xl p-4 text-center">
          <p className="text-3xl font-bold text-blue-600">{chats.filter(c => c.status === 'resolved').length}</p>
          <p className="text-sm text-blue-700">محلولة</p>
        </div>
        <div className="bg-gray-50 rounded-xl p-4 text-center">
          <p className="text-3xl font-bold text-gray-600">{chats.length}</p>
          <p className="text-sm text-gray-700">إجمالي</p>
        </div>
      </div>

      {/* نافذة خصم النقاط */}
      {showPenaltyModal && (
        <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4">
          <div className="bg-white rounded-2xl shadow-2xl max-w-md w-full p-6">
            <div className="flex items-center gap-3 mb-6">
              <div className="w-12 h-12 bg-red-100 rounded-full flex items-center justify-center">
                <MinusCircle className="w-6 h-6 text-red-600" />
              </div>
              <div>
                <h3 className="text-lg font-bold text-gray-800">تأكيد الشكوى وخصم النقاط</h3>
                <p className="text-sm text-gray-500">خصم نقاط من {penaltyTargetName}</p>
              </div>
            </div>

            <div className="space-y-4">
              {/* معرف الهدف */}
              <div>
                <label className="block text-sm font-medium text-gray-700 mb-1">
                  معرف {penaltyTargetName} (UID)
                </label>
                <input
                  type="text"
                  value={penaltyTargetId}
                  onChange={(e) => setPenaltyTargetId(e.target.value)}
                  placeholder="أدخل UID..."
                  className="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:border-red-400 focus:outline-none"
                />
              </div>

              {/* عدد النقاط */}
              <div>
                <label className="block text-sm font-medium text-gray-700 mb-1">
                  عدد النقاط المخصومة
                </label>
                <div className="flex gap-2">
                  {[5, 10, 15, 20].map((n) => (
                    <button
                      key={n}
                      onClick={() => setPenaltyAmount(n)}
                      className={`flex-1 py-2 rounded-lg font-bold transition ${
                        penaltyAmount === n 
                          ? 'bg-red-500 text-white' 
                          : 'bg-gray-100 text-gray-600 hover:bg-gray-200'
                      }`}
                    >
                      -{n}
                    </button>
                  ))}
                </div>
              </div>

              {/* سبب الخصم */}
              <div>
                <label className="block text-sm font-medium text-gray-700 mb-1">
                  سبب الخصم
                </label>
                <select
                  value={penaltyReason}
                  onChange={(e) => setPenaltyReason(e.target.value)}
                  className="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:border-red-400 focus:outline-none"
                >
                  <option value="">اختر السبب...</option>
                  <option value="جودة الطعام سيئة">جودة الطعام سيئة</option>
                  <option value="تأخير في التسليم">تأخير في التسليم</option>
                  <option value="سوء الخدمة">سوء الخدمة</option>
                  <option value="طلب خاطئ">طلب خاطئ</option>
                  <option value="سوء التغليف">سوء التغليف</option>
                  <option value="مشكلة نظافة">مشكلة نظافة</option>
                  <option value="عدم الحضور">عدم الحضور</option>
                  <option value="سوء التعامل">سوء التعامل</option>
                  <option value="شكوى أخرى">شكوى أخرى</option>
                </select>
              </div>

              {/* تحذير */}
              <div className="bg-amber-50 border border-amber-200 rounded-xl p-3">
                <p className="text-sm text-amber-800">
                   <strong>تنبيه:</strong> إذا وصلت النقاط أقل من {POINTS_CONFIG.SUSPENSION_THRESHOLD} سيتم إيقاف الحساب تلقائياً!
                </p>
              </div>

              {/* الأزرار */}
              <div className="flex gap-3 pt-2">
                <button
                  onClick={confirmComplaintAndDeduct}
                  disabled={processingPenalty || !penaltyTargetId || !penaltyReason}
                  className="flex-1 py-3 bg-red-500 hover:bg-red-600 text-white rounded-xl font-bold transition disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center gap-2"
                >
                  {processingPenalty ? (
                    <Loader2 className="w-5 h-5 animate-spin" />
                  ) : (
                    <>
                      <MinusCircle className="w-5 h-5" />
                      تأكيد وخصم النقاط
                    </>
                  )}
                </button>
                <button
                  onClick={() => setShowPenaltyModal(false)}
                  className="px-6 py-3 bg-gray-100 hover:bg-gray-200 text-gray-700 rounded-xl font-medium transition"
                >
                  إلغاء
                </button>
              </div>
            </div>
          </div>
        </div>
      )}
    </div>
  )
}

export default SupportAdmin

==========================================================================================
FILE: src/pages/SupportPage.tsx
==========================================================================================
// src/pages/SupportPage.tsx
import React, { useState, useEffect } from 'react'
import { useNavigate, useSearchParams } from 'react-router-dom'
import { 
  collection, addDoc, query, where, orderBy, 
  onSnapshot, serverTimestamp, doc, getDoc 
} from 'firebase/firestore'
import { db } from '@/firebase'
import { useAuth } from '@/auth'
import { useToast } from '@/components/ui/Toast'
import { SupportTicket, Order } from '@/types'
import { 
  Headphones, Send, AlertTriangle, MessageSquare, 
  Lightbulb, RefreshCw, ChevronLeft, Clock, CheckCircle,
  XCircle, Loader2, Package, Store, Truck, Plus,
  Phone, Mail, FileText, Camera
} from 'lucide-react'

// أنواع التذاكر
const TICKET_TYPES = [
  { value: 'complaint', label: 'شكوى', icon: AlertTriangle, color: 'red' },
  { value: 'support', label: 'دعم فني', icon: Headphones, color: 'blue' },
  { value: 'suggestion', label: 'اقتراح', icon: Lightbulb, color: 'amber' },
  { value: 'refund', label: 'طلب استرداد', icon: RefreshCw, color: 'green' },
]

// حالات التذاكر
const STATUS_LABELS: Record<string, { label: string; color: string; icon: React.ElementType }> = {
  open: { label: 'جديدة', color: 'blue', icon: Clock },
  in_progress: { label: 'قيد المعالجة', color: 'amber', icon: Loader2 },
  waiting_customer: { label: 'بانتظار ردك', color: 'purple', icon: MessageSquare },
  waiting_restaurant: { label: 'بانتظار رد الأسرة', color: 'orange', icon: Store },
  resolved: { label: 'تم الحل', color: 'green', icon: CheckCircle },
  closed: { label: 'مغلقة', color: 'gray', icon: XCircle },
}

export const SupportPage: React.FC = () => {
  const nav = useNavigate()
  const [params] = useSearchParams()
  const orderId = params.get('orderId')
  const { user, role } = useAuth()
  const toast = useToast()

  const [tickets, setTickets] = useState<SupportTicket[]>([])
  const [loading, setLoading] = useState(true)
  const [showForm, setShowForm] = useState(false)
  const [selectedOrder, setSelectedOrder] = useState<Order | null>(null)
  const [orders, setOrders] = useState<Order[]>([])
  const [submitting, setSubmitting] = useState(false)

  // نموذج التذكرة الجديدة
  const [form, setForm] = useState({
    type: 'complaint' as 'complaint' | 'support' | 'suggestion' | 'refund',
    subject: '',
    description: '',
    orderId: orderId || '',
    againstType: '' as '' | 'restaurant' | 'courier',
  })

  // جلب التذاكر السابقة
  useEffect(() => {
    if (!user?.uid) return

    const q = query(
      collection(db, 'supportTickets'),
      where('userId', '==', user.uid),
      orderBy('createdAt', 'desc')
    )

    const unsub = onSnapshot(q, (snap) => {
      const data = snap.docs.map(d => ({ id: d.id, ...d.data() } as SupportTicket))
      setTickets(data)
      setLoading(false)
    }, (err) => {
      console.error('Error fetching tickets:', err)
      setLoading(false)
    })

    return () => unsub()
  }, [user?.uid])

  // جلب الطلبات السابقة للعميل
  useEffect(() => {
    if (!user?.uid || role !== 'customer') return

    const q = query(
      collection(db, 'orders'),
      where('customerId', '==', user.uid),
      orderBy('createdAt', 'desc')
    )

    const unsub = onSnapshot(q, (snap) => {
      const data = snap.docs.map(d => ({ id: d.id, ...d.data() } as Order))
      setOrders(data)
      
      // إذا تم تمرير orderId في الرابط، نجلب تفاصيله
      if (orderId) {
        const order = data.find(o => o.id === orderId)
        if (order) setSelectedOrder(order)
      }
    })

    return () => unsub()
  }, [user?.uid, role, orderId])

  // إنشاء رقم تذكرة فريد
  const generateTicketNumber = () => {
    const year = new Date().getFullYear()
    const random = Math.floor(Math.random() * 10000).toString().padStart(4, '0')
    return `TKT-${year}-${random}`
  }

  // إرسال التذكرة
  const handleSubmit = async (e: React.FormEvent) => {
    e.preventDefault()
    if (!user?.uid) return

    if (!form.subject.trim()) {
      toast.error('الرجاء كتابة عنوان للشكوى')
      return
    }
    if (!form.description.trim()) {
      toast.error('الرجاء كتابة تفاصيل المشكلة')
      return
    }

    setSubmitting(true)

    try {
      // جلب بيانات المستخدم
      const userDoc = await getDoc(doc(db, 'users', user.uid))
      const userData = userDoc.data()

      const ticketData: Partial<SupportTicket> = {
        ticketNumber: generateTicketNumber(),
        type: form.type,
        subject: form.subject.trim(),
        description: form.description.trim(),
        userId: user.uid,
        userName: userData?.name || user.displayName || 'مستخدم',
        userEmail: userData?.email || user.email || '',
        userPhone: userData?.phone || '',
        userRole: (role as any) || 'customer',
        status: 'open',
        priority: form.type === 'complaint' ? 'high' : 'medium',
        createdAt: serverTimestamp() as any,
        updatedAt: serverTimestamp() as any,
      }

      // إضافة بيانات الطلب إن وجد
      if (selectedOrder) {
        ticketData.orderId = selectedOrder.id
        ticketData.orderNumber = selectedOrder.id.slice(-6).toUpperCase()
        ticketData.againstRestaurantId = selectedOrder.restaurantId
        ticketData.againstRestaurantName = selectedOrder.restaurantName
        if (selectedOrder.courierId) {
          ticketData.againstCourierId = selectedOrder.courierId
        }
      }

      await addDoc(collection(db, 'supportTickets'), ticketData)

      toast.success('تم إرسال الشكوى بنجاح! سنتواصل معك قريباً')
      setForm({ type: 'complaint', subject: '', description: '', orderId: '', againstType: '' })
      setSelectedOrder(null)
      setShowForm(false)
    } catch (err) {
      console.error('Error submitting ticket:', err)
      toast.error('حدث خطأ، حاول مرة أخرى')
    } finally {
      setSubmitting(false)
    }
  }

  if (loading) {
    return (
      <div className="flex items-center justify-center min-h-[50vh]">
        <Loader2 className="w-8 h-8 animate-spin text-sky-500" />
      </div>
    )
  }

  return (
    <div className="max-w-2xl mx-auto">
      {/* الهيدر */}
      <div className="bg-gradient-to-r from-sky-600 to-sky-500 rounded-2xl p-6 mb-6 text-white">
        <div className="flex items-center gap-3 mb-4">
          <div className="w-14 h-14 bg-white/20 rounded-2xl flex items-center justify-center">
            <Headphones className="w-7 h-7" />
          </div>
          <div>
            <h1 className="text-2xl font-bold">الدعم الفني</h1>
            <p className="text-sky-100 text-sm">نحن هنا لمساعدتك</p>
          </div>
        </div>

        {/* معلومات التواصل */}
        <div className="bg-white/10 rounded-xl p-4 space-y-2">
          <div className="flex items-center gap-2 text-sm">
            <Mail className="w-4 h-4" />
            <span>afrtalbyt2026@gmail.com</span>
          </div>
          <div className="flex items-center gap-2 text-sm">
            <Phone className="w-4 h-4" />
            <span dir="ltr">0535534208</span>
          </div>
        </div>
      </div>

      {/* زر إنشاء تذكرة جديدة */}
      {!showForm && (
        <button
          onClick={() => setShowForm(true)}
          className="w-full mb-6 flex items-center justify-center gap-3 py-4 px-6 
                     bg-gradient-to-r from-red-500 to-orange-500 hover:from-red-600 hover:to-orange-600
                     text-white rounded-2xl font-bold shadow-lg transition-all"
        >
          <Plus className="w-6 h-6" />
          <span>تقديم شكوى / طلب دعم</span>
        </button>
      )}

      {/* نموذج إنشاء تذكرة */}
      {showForm && (
        <form onSubmit={handleSubmit} className="bg-white rounded-2xl shadow-lg p-6 mb-6">
          <div className="flex items-center justify-between mb-6">
            <h2 className="text-lg font-bold text-gray-800">تذكرة جديدة</h2>
            <button
              type="button"
              onClick={() => setShowForm(false)}
              className="text-gray-400 hover:text-gray-600"
            >
              <XCircle className="w-6 h-6" />
            </button>
          </div>

          {/* نوع التذكرة */}
          <div className="mb-4">
            <label className="block text-sm font-medium text-gray-700 mb-2">نوع الطلب</label>
            <div className="grid grid-cols-2 gap-2">
              {TICKET_TYPES.map((t) => (
                <button
                  key={t.value}
                  type="button"
                  onClick={() => setForm({ ...form, type: t.value as any })}
                  className={`flex items-center gap-2 p-3 rounded-xl border-2 transition-all ${
                    form.type === t.value 
                      ? `border-${t.color}-500 bg-${t.color}-50 text-${t.color}-700`
                      : 'border-gray-200 text-gray-600 hover:border-gray-300'
                  }`}
                >
                  <t.icon className="w-5 h-5" />
                  <span className="font-medium">{t.label}</span>
                </button>
              ))}
            </div>
          </div>

          {/* اختيار الطلب (للعملاء فقط) */}
          {role === 'customer' && orders.length > 0 && (
            <div className="mb-4">
              <label className="block text-sm font-medium text-gray-700 mb-2">
                هل الشكوى متعلقة بطلب معين؟
              </label>
              <select
                value={selectedOrder?.id || ''}
                onChange={(e) => {
                  const order = orders.find(o => o.id === e.target.value)
                  setSelectedOrder(order || null)
                }}
                className="w-full p-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-sky-500"
              >
                <option value="">-- اختر الطلب --</option>
                {orders.slice(0, 10).map((o) => (
                  <option key={o.id} value={o.id}>
                    طلب #{o.id.slice(-6).toUpperCase()} - {o.restaurantName} - {o.total} ر.س
                  </option>
                ))}
              </select>
            </div>
          )}

          {/* تفاصيل الطلب المختار */}
          {selectedOrder && (
            <div className="mb-4 p-4 bg-gray-50 rounded-xl">
              <div className="flex items-center gap-2 mb-2">
                <Package className="w-5 h-5 text-sky-500" />
                <span className="font-bold">تفاصيل الطلب</span>
              </div>
              <div className="text-sm text-gray-600 space-y-1">
                <p> الأسرة: {selectedOrder.restaurantName}</p>
                <p> المبلغ: {selectedOrder.total} ر.س</p>
                <p> الحالة: {selectedOrder.status}</p>
              </div>
            </div>
          )}

          {/* عنوان الشكوى */}
          <div className="mb-4">
            <label className="block text-sm font-medium text-gray-700 mb-2">
              عنوان الشكوى / المشكلة *
            </label>
            <input
              type="text"
              value={form.subject}
              onChange={(e) => setForm({ ...form, subject: e.target.value })}
              placeholder="مثال: تأخر في التوصيل"
              className="w-full p-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-sky-500"
              required
            />
          </div>

          {/* تفاصيل المشكلة */}
          <div className="mb-6">
            <label className="block text-sm font-medium text-gray-700 mb-2">
              تفاصيل المشكلة *
            </label>
            <textarea
              value={form.description}
              onChange={(e) => setForm({ ...form, description: e.target.value })}
              placeholder="اشرح المشكلة بالتفصيل..."
              rows={5}
              className="w-full p-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-sky-500 resize-none"
              required
            />
          </div>

          {/* تنبيه */}
          <div className="mb-6 p-4 bg-amber-50 border border-amber-200 rounded-xl">
            <div className="flex items-start gap-2">
              <AlertTriangle className="w-5 h-5 text-amber-600 mt-0.5" />
              <div className="text-sm text-amber-800">
                <p className="font-bold mb-1">ملاحظة مهمة:</p>
                <p>سيقوم فريق الدعم بمراجعة شكواك والتواصل مع الطرف المعني لحل المشكلة. نحن الوسيط الرسمي بينكم.</p>
              </div>
            </div>
          </div>

          {/* أزرار الإرسال */}
          <div className="flex gap-3">
            <button
              type="submit"
              disabled={submitting}
              className="flex-1 flex items-center justify-center gap-2 py-3 px-6 
                         bg-gradient-to-r from-sky-500 to-sky-600 hover:from-sky-600 hover:to-sky-700
                         text-white rounded-xl font-bold transition-all disabled:opacity-50"
            >
              {submitting ? (
                <Loader2 className="w-5 h-5 animate-spin" />
              ) : (
                <>
                  <Send className="w-5 h-5" />
                  <span>إرسال</span>
                </>
              )}
            </button>
            <button
              type="button"
              onClick={() => setShowForm(false)}
              className="px-6 py-3 bg-gray-100 hover:bg-gray-200 text-gray-700 rounded-xl font-medium transition"
            >
              إلغاء
            </button>
          </div>
        </form>
      )}

      {/* قائمة التذاكر السابقة */}
      <div className="bg-white rounded-2xl shadow-lg overflow-hidden">
        <div className="p-4 border-b border-gray-100">
          <h2 className="font-bold text-gray-800 flex items-center gap-2">
            <FileText className="w-5 h-5 text-sky-500" />
            تذاكري السابقة
          </h2>
        </div>

        {tickets.length === 0 ? (
          <div className="p-8 text-center text-gray-500">
            <Headphones className="w-12 h-12 mx-auto mb-3 opacity-30" />
            <p>لا توجد تذاكر سابقة</p>
          </div>
        ) : (
          <div className="divide-y divide-gray-100">
            {tickets.map((ticket) => {
              const status = STATUS_LABELS[ticket.status] || STATUS_LABELS.open
              const StatusIcon = status.icon
              
              return (
                <div key={ticket.id} className="p-4 hover:bg-gray-50 transition">
                  <div className="flex items-start justify-between mb-2">
                    <div>
                      <span className="text-xs text-gray-400 font-mono">{ticket.ticketNumber}</span>
                      <h3 className="font-bold text-gray-800">{ticket.subject}</h3>
                    </div>
                    <span className={`inline-flex items-center gap-1 px-2 py-1 rounded-full text-xs font-medium
                      ${status.color === 'blue' ? 'bg-blue-100 text-blue-700' : ''}
                      ${status.color === 'amber' ? 'bg-amber-100 text-amber-700' : ''}
                      ${status.color === 'green' ? 'bg-green-100 text-green-700' : ''}
                      ${status.color === 'gray' ? 'bg-gray-100 text-gray-700' : ''}
                      ${status.color === 'purple' ? 'bg-purple-100 text-purple-700' : ''}
                      ${status.color === 'orange' ? 'bg-orange-100 text-orange-700' : ''}
                    `}>
                      <StatusIcon className="w-3 h-3" />
                      {status.label}
                    </span>
                  </div>
                  
                  <p className="text-sm text-gray-600 line-clamp-2 mb-2">{ticket.description}</p>
                  
                  {ticket.adminResponse && (
                    <div className="mt-2 p-3 bg-sky-50 rounded-lg">
                      <p className="text-xs text-sky-600 font-bold mb-1">رد الإدارة:</p>
                      <p className="text-sm text-sky-800">{ticket.adminResponse}</p>
                    </div>
                  )}

                  <div className="flex items-center gap-3 mt-2 text-xs text-gray-400">
                    <span>
                      {ticket.createdAt && new Date((ticket.createdAt as any).toDate?.() || ticket.createdAt).toLocaleDateString('ar-SA')}
                    </span>
                    {ticket.orderId && (
                      <span className="flex items-center gap-1">
                        <Package className="w-3 h-3" />
                        طلب #{ticket.orderId.slice(-6).toUpperCase()}
                      </span>
                    )}
                  </div>
                </div>
              )
            })}
          </div>
        )}
      </div>

      {/* ملاحظة أسفل الصفحة */}
      <div className="mt-6 p-4 bg-gray-50 rounded-xl text-center text-sm text-gray-600">
        <p> جميع الشكاوى تتم مراجعتها من قبل فريق الإدارة</p>
        <p>نحن الوسيط الرسمي بين العملاء والأسر المنتجة</p>
      </div>
    </div>
  )
}

export default SupportPage

==========================================================================================
FILE: src/pages/TermsPage.tsx
==========================================================================================
// src/pages/TermsPage.tsx
import React from "react";
import { Link } from "react-router-dom";

export default function TermsPage() {
  return (
    <div className="min-h-screen bg-gray-100 text-gray-800 px-4 py-10 leading-relaxed">
      <div className="max-w-3xl mx-auto bg-white shadow-lg rounded-2xl p-6 sm:p-8">
        <h1 className="text-2xl font-bold text-sky-600 mb-6 text-center">
          الشروط والأحكام -  سفرة البيت
        </h1>

        {/* 1. التعريف */}
        <section className="mb-6">
          <h2 className="text-xl font-semibold text-gray-900 mb-3 border-r-4 border-sky-500 pr-3">
            1. التعريف
          </h2>
          <p>
            منصة سفرة البيت هي منصة إلكترونية تهدف إلى عرض وتسويق منتجات الأسر
            المنتجة وربطها بالعملاء عبر التطبيق.
          </p>
        </section>

        {/* 2. التسجيل */}
        <section className="mb-6">
          <h2 className="text-xl font-semibold text-gray-900 mb-3 border-r-4 border-sky-500 pr-3">
            2. التسجيل
          </h2>
          <ul className="list-disc list-inside space-y-2 text-gray-700">
            <li>التسجيل في منصة سفرة البيت مجاني بالكامل.</li>
            <li>لا يتم فرض أي رسوم تسجيل على الأسر المنتجة.</li>
          </ul>
        </section>

        {/* 3. تسعير المنتجات ورسوم تشغيل المنصة */}
        <section className="mb-6">
          <h2 className="text-xl font-semibold text-gray-900 mb-3 border-r-4 border-sky-500 pr-3">
            3. تسعير المنتجات ورسوم تشغيل المنصة
          </h2>
          <ul className="list-disc list-inside space-y-2 text-gray-700">
            <li>تقوم الأسرة بإدخال السعر الأساسي للمنتج.</li>
            <li>
              توافق الأسرة على قيام المنصة بإضافة رسوم تشغيل قدرها{" "}
              <strong className="text-sky-600">1.75 ريال</strong> على كل منتج.
            </li>
            <li>
              بالنسبة للمنتجات التي يكون سعرها 1 ريال أو 2 ريال، يتم إضافة{" "}
              <strong className="text-sky-600">0.25 ريال</strong> فقط.
            </li>
            <li>
              يظهر السعر النهائي للمنتج للعميل داخل التطبيق على أنه سعر المنتج.
            </li>
            <li>
              لا يتم خصم أي مبالغ من دخل الأسرة، وجميع رسوم تشغيل المنصة تُحمّل
              على العميل.
            </li>
          </ul>
        </section>

        {/* 4. الطلب والدفع */}
        <section className="mb-6">
          <h2 className="text-xl font-semibold text-gray-900 mb-3 border-r-4 border-sky-500 pr-3">
            4. الطلب والدفع
          </h2>
          <ul className="list-disc list-inside space-y-2 text-gray-700">
            <li>
              يتم عرض السعر النهائي للمنتج داخل التطبيق بعد إضافة رسوم تشغيل
              المنصة.
            </li>
            <li>
              قد يتم احتساب رسوم أخرى مثل:
              <ul className="list-disc list-inside mr-6 mt-2 space-y-1">
                <li>رسوم التوصيل</li>
                <li>ضريبة القيمة المضافة حسب الأنظمة المعمول بها</li>
              </ul>
            </li>
            <li>
              تحتفظ المنصة بحق تحديث أو إضافة خدمات أو رسوم مستقبلية عند الحاجة،
              مع إشعار المستخدمين بذلك.
            </li>
          </ul>
        </section>

        {/* 5. مسؤولية الأسرة المنتجة */}
        <section className="mb-6">
          <h2 className="text-xl font-semibold text-gray-900 mb-3 border-r-4 border-sky-500 pr-3">
            5. مسؤولية الأسرة المنتجة
          </h2>
          <p className="mb-3">تتحمل الأسرة المنتجة كامل المسؤولية عن:</p>
          <ul className="list-disc list-inside space-y-2 text-gray-700 mr-4">
            <li>جودة المنتجات</li>
            <li>سلامة الأصناف</li>
            <li>نظافة وتحضير الطعام</li>
            <li>التغليف والتعبئة</li>
            <li>الالتزام بالاشتراطات الصحية المعمول بها</li>
          </ul>
          <p className="mt-3">
            تلتزم الأسرة بتسليم الطلب بالحالة المناسبة والمتفق عليها مع العميل.
          </p>
        </section>

        {/* 6. التوصيل والمندوبين */}
        <section className="mb-6">
          <h2 className="text-xl font-semibold text-gray-900 mb-3 border-r-4 border-sky-500 pr-3">
            6. التوصيل والمندوبين
          </h2>
          <ul className="list-disc list-inside space-y-2 text-gray-700">
            <li>تعمل منصة سفرة البيت كوسيط تقني لربط الأطراف.</li>
            <li>
              لا تتحمل المنصة أي مسؤولية عن:
              <ul className="list-disc list-inside mr-6 mt-2 space-y-1">
                <li>تصرفات المندوب</li>
                <li>تأخير التوصيل</li>
                <li>سوء التعامل أثناء التسليم</li>
                <li>تلف الطلب بعد خروجه من الأسرة</li>
              </ul>
            </li>
            <li>
              أي ملاحظات متعلقة بالتوصيل يتم التعامل معها حسب سياسة مزود التوصيل
              المعتمد.
            </li>
          </ul>
        </section>

        {/* 7. الخدمات الإعلانية */}
        <section className="mb-6">
          <h2 className="text-xl font-semibold text-gray-900 mb-3 border-r-4 border-sky-500 pr-3">
            7. الخدمات الإعلانية (اختيارية)
          </h2>
          <ul className="list-disc list-inside space-y-2 text-gray-700">
            <li>
              تتيح المنصة خدمات إعلانية أو ترويجية داخل التطبيق مقابل رسوم.
            </li>
            <li>
              هذه الخدمات اختيارية بالكامل ولا تؤثر على استمرار عرض منتجات الأسرة
              في حال عدم الاشتراك.
            </li>
            <li>
              الإعلانات تهدف إلى زيادة الظهور ولا تضمن عددًا معينًا من الطلبات أو
              المبيعات.
            </li>
          </ul>
        </section>

        {/* 8. حدود مسؤولية المنصة */}
        <section className="mb-6">
          <h2 className="text-xl font-semibold text-gray-900 mb-3 border-r-4 border-sky-500 pr-3">
            8. حدود مسؤولية المنصة
          </h2>
          <p className="mb-3">منصة سفرة البيت غير مسؤولة عن:</p>
          <ul className="list-disc list-inside space-y-2 text-gray-700 mr-4">
            <li>محتوى المنتجات أو صورها</li>
            <li>اختلاف التوقعات الشخصية للعميل</li>
            <li>أي أضرار ناتجة عن استخدام المنتج</li>
          </ul>
          <p className="mt-3">يقتصر دور المنصة على:</p>
          <ul className="list-disc list-inside space-y-2 text-gray-700 mr-4 mt-2">
            <li>عرض المنتجات</li>
            <li>تسهيل الطلب</li>
            <li>ربط الأطراف عبر النظام التقني</li>
          </ul>
        </section>

        {/* 9. التعديل */}
        <section className="mb-6">
          <h2 className="text-xl font-semibold text-gray-900 mb-3 border-r-4 border-sky-500 pr-3">
            9. التعديل
          </h2>
          <ul className="list-disc list-inside space-y-2 text-gray-700">
            <li>
              يحق للمنصة تعديل هذه الشروط عند الحاجة بما يتوافق مع الأنظمة.
            </li>
            <li>يتم إشعار المستخدمين بأي تحديثات.</li>
          </ul>
        </section>

        {/* 10. الموافقة */}
        <section className="mb-6">
          <h2 className="text-xl font-semibold text-gray-900 mb-3 border-r-4 border-sky-500 pr-3">
            10. الموافقة
          </h2>
          <p className="bg-sky-50 border border-sky-200 rounded-lg p-4 text-gray-800">
            باستخدامك للتطبيق، فإنك تقر بقراءة وفهم والموافقة على جميع الشروط
            والأحكام أعلاه.
          </p>
        </section>

        {/* سياسة الخصوصية */}
        <div className="border-t-2 border-gray-200 pt-6 mt-8">
          <h1 className="text-2xl font-bold text-sky-600 mb-6 text-center">
            سياسة الخصوصية
          </h1>

          <ul className="list-disc list-inside space-y-3 text-gray-700">
            <li>تحترم منصة سفرة البيت خصوصية جميع المستخدمين.</li>
            <li>
              يتم جمع البيانات فقط لغرض:
              <ul className="list-disc list-inside mr-6 mt-2 space-y-1">
                <li>تشغيل التطبيق</li>
                <li>تنفيذ الطلبات</li>
                <li>التواصل مع المستخدمين</li>
                <li>تحسين جودة الخدمة</li>
              </ul>
            </li>
            <li>
              لا يتم مشاركة بيانات المستخدمين مع أي طرف ثالث إلا عند الضرورة
              لتقديم الخدمة أو وفق الأنظمة المعمول بها.
            </li>
            <li>
              تحتفظ المنصة بحق استخدام بيانات المشاهدات والتفاعل داخل التطبيق
              لأغراض تشغيلية وتحليلية وتحسينية.
            </li>
          </ul>
        </div>

        {/* الموافقة النهائية */}
        <div className="bg-green-50 border border-green-300 rounded-lg p-4 mt-8 text-center">
          <p className="text-green-800 font-medium">
             بالموافقة، أنت تقر بقراءة وفهم الشروط والأحكام وسياسة الخصوصية
          </p>
        </div>

        <p className="mt-6 text-sm text-gray-500 text-center">
          تم آخر تحديث لهذه الشروط بتاريخ {new Date().toLocaleDateString("ar-SA")}
        </p>

        <div className="mt-8 flex flex-col sm:flex-row gap-3 justify-center">
          <Link
            to="/register"
            className="text-white bg-sky-500 hover:bg-sky-600 px-6 py-3 rounded-lg inline-block transition-colors text-center font-bold"
          >
             موافق - العودة للتسجيل
          </Link>
          <Link
            to="/"
            className="text-sky-600 bg-sky-100 hover:bg-sky-200 px-6 py-3 rounded-lg inline-block transition-colors text-center"
          >
            الرجوع إلى الصفحة الرئيسية
          </Link>
        </div>
      </div>
    </div>
  );
}

==========================================================================================
FILE: src/pages/TrackOrders.tsx
==========================================================================================
// src/pages/TrackOrders.tsx
import React, { useEffect, useState } from 'react'
import { collection, getDocs, onSnapshot, orderBy, query, where, limit, doc, getDoc, updateDoc, serverTimestamp } from 'firebase/firestore'
import { db } from '@/firebase'
import { useAuth } from '@/auth'
import { Order, Rating } from '@/types'
import { useNavigate } from 'react-router-dom'
import { MessageCircle, Package, MapPin, Truck, CheckCircle, Clock, ChefHat, XCircle, Store, CreditCard, Building2, Copy, X, Headphones, Star } from 'lucide-react'
import { useToast } from '@/components/ui/Toast'
import { RatingModal } from '@/components/RatingModal'
import { OrderTimer } from '@/components/OrderTimer'

export const TrackOrders: React.FC = () => {
  const { user } = useAuth()
  const nav = useNavigate()
  const toast = useToast()
  const [err, setErr] = useState<string | null>(null)
  const [orders, setOrders] = useState<Order[]>([])
  const [diag, setDiag] = useState<{ uid: string; fallbackCount: number; sample: any[] } | null>(null)
  
  // حالة عرض بيانات البنك
  const [showPaymentModal, setShowPaymentModal] = useState<string | null>(null) // orderId
  const [bankInfo, setBankInfo] = useState<{ bankName?: string; bankAccountName?: string; bankAccountNumber?: string } | null>(null)
  const [loadingBank, setLoadingBank] = useState(false)

  // حالة التقييم
  const [ratingModal, setRatingModal] = useState<{
    isOpen: boolean;
    orderId: string;
    type: 'restaurant' | 'courier';
    targetName: string;
  } | null>(null)

  // جلب بيانات البنك للمطعم من subcollection المحمي
  const fetchBankInfo = async (restaurantId: string, orderId: string) => {
    setLoadingBank(true)
    setShowPaymentModal(orderId)
    try {
      // محاولة جلب من subcollection المحمي أولاً
      const bankSnap = await getDoc(doc(db, 'restaurants', restaurantId, 'private', 'bankInfo'))
      if (bankSnap.exists()) {
        const data = bankSnap.data() as any
        setBankInfo({
          bankName: data.bankName || '',
          bankAccountName: data.bankAccountName || '',
          bankAccountNumber: data.bankAccountNumber || '',
        })
      } else {
        // fallback للبيانات القديمة في document المطعم (للتوافق مع البيانات السابقة)
        const rSnap = await getDoc(doc(db, 'restaurants', restaurantId))
        if (rSnap.exists()) {
          const data = rSnap.data() as any
          setBankInfo({
            bankName: data.bankName || '',
            bankAccountName: data.bankAccountName || '',
            bankAccountNumber: data.bankAccountNumber || '',
          })
        } else {
          setBankInfo(null)
        }
      }
    } catch (e) {
      toast.error('تعذر جلب بيانات الدفع')
      setBankInfo(null)
    } finally {
      setLoadingBank(false)
    }
  }

  // نسخ رقم الحساب
  const copyToClipboard = (text: string) => {
    navigator.clipboard.writeText(text)
    toast.success('تم نسخ رقم الحساب! ')
  }

  useEffect(() => {
    if (!user) return
    setErr(null)
    setDiag(null)

    // الاستعلام الأساسي: customerId + orderBy(createdAt)
    const q1 = query(
      collection(db, 'orders'),
      where('customerId', '==', user.uid),
      orderBy('createdAt', 'desc')
    )

    // نحاول الاشتراك.. لو صار خطأ فهرس، نطيح على فولبّاك
    const unsub = onSnapshot(
      q1,
      snap => {
        setOrders(snap.docs.map(d => ({ id: d.id, ...d.data() } as Order)))
        setErr(null)
      },
      async (e) => {
        console.error('TrackOrders onSnapshot error:', e)
        setErr(' احتمال تحتاج Composite Index لـ customerId + createdAt. بنعرض البيانات بدون ترتيب مؤقتًا.')

        // فولبّاك بدون orderBy (ما يحتاج فهرس مركب)
        const q2 = query(
          collection(db, 'orders'),
          where('customerId', '==', user.uid)
        )
        const s2 = await getDocs(q2)
        const list = s2.docs.map(d => ({ id: d.id, ...d.data() } as Order))

        // تشخيص سريع: نعرض عينة من أحدث 5 طلبات عامة
        const q3 = query(collection(db, 'orders'), orderBy('createdAt', 'desc'), limit(5))
        let sample: any[] = []
        try {
          const s3 = await getDocs(q3)
          sample = s3.docs.map(d => {
            const data = d.data() as any
            return {
              id: d.id,
              customerId: data.customerId,
              restaurantId: data.restaurantId,
              createdAt: data.createdAt?.toDate?.()?.toISOString?.() ?? null,
            }
          })
        } catch {}

        setDiag({
          uid: user.uid,
          fallbackCount: list.length,
          sample,
        })
        setOrders(list)
      }
    )

    return () => unsub()
  }, [user])

  const badge = (s: string) => {
    const map: Record<string, { text: string; emoji: string; color: string; icon: any }> = {
      pending: { text: 'قيد المراجعة', emoji: '', color: 'bg-yellow-500', icon: Clock },
      accepted: { text: 'تم القبول', emoji: '', color: 'bg-blue-500', icon: CheckCircle },
      preparing: { text: 'قيد التحضير', emoji: '', color: 'bg-orange-500', icon: ChefHat },
      ready: { text: 'جاهز للتسليم', emoji: '', color: 'bg-purple-500', icon: Package },
      out_for_delivery: { text: 'في الطريق', emoji: '', color: 'bg-sky-500', icon: Truck },
      delivered: { text: 'تم التسليم', emoji: '', color: 'bg-green-500', icon: CheckCircle },
      cancelled: { text: 'ملغي', emoji: '', color: 'bg-red-500', icon: XCircle },
    }
    return map[s] || { text: s, emoji: '', color: 'bg-gray-500', icon: Package }
  }

  // التحقق إذا كان الطلب يسمح بالمحادثة
  // 1. مع المندوب: إذا كان الطلب في الطريق ويوجد مندوب
  // 2. مع المطعم: إذا كان الطلب قيد التحضير أو جاهز ولا يوجد مندوب
  const canChatWithCourier = (order: Order) => {
    return order.courierId && order.status === 'out_for_delivery'
  }
  
  const canChatWithRestaurant = (order: Order) => {
    const activeStatuses = ['pending', 'accepted', 'preparing', 'ready']
    return !order.courierId && order.restaurantId && activeStatuses.includes(order.status)
  }
  
  const canChat = (order: Order) => {
    return canChatWithCourier(order) || canChatWithRestaurant(order)
  }

  // التحقق إذا كان الطلب يحتاج دفع (pending أو accepted)
  const needsPayment = (order: Order) => {
    return ['pending', 'accepted'].includes(order.status)
  }

  // التحقق إذا كان الطلب يحتاج تقييم
  const needsRating = (order: Order) => {
    if (order.status !== 'delivered') return false
    // التحقق من عدم وجود تقييم مسبق
    const hasRatedRestaurant = order.ratings?.customerToRestaurant?.stars
    const hasRatedCourier = order.ratings?.customerToCourier?.stars
    // إذا يوجد مندوب، يجب تقييم كلاهما
    if (order.courierId) {
      return !hasRatedRestaurant || !hasRatedCourier
    }
    // إذا لا يوجد مندوب، يجب تقييم المطعم فقط
    return !hasRatedRestaurant
  }

  // التحقق من التقييم المطلوب التالي
  const getNextRatingNeeded = (order: Order): 'restaurant' | 'courier' | null => {
    if (order.status !== 'delivered') return null
    if (!order.ratings?.customerToRestaurant?.stars) return 'restaurant'
    if (order.courierId && !order.ratings?.customerToCourier?.stars) return 'courier'
    return null
  }

  // إرسال التقييم
  const submitRating = async (orderId: string, type: 'restaurant' | 'courier', rating: { stars: number; comment: string }) => {
    const order = orders.find(o => o.id === orderId)
    if (!order) return

    const ratingData: Rating = {
      stars: rating.stars,
      comment: rating.comment || undefined,
      createdAt: new Date()
    }

    const fieldPath = type === 'restaurant' ? 'ratings.customerToRestaurant' : 'ratings.customerToCourier'
    
    // تحديث الطلب بالتقييم
    const updateData: any = {
      [fieldPath]: ratingData,
      updatedAt: serverTimestamp()
    }

    // التحقق إذا اكتمل التقييم
    const currentRatings = order.ratings || {}
    if (type === 'restaurant') {
      currentRatings.customerToRestaurant = ratingData
    } else {
      currentRatings.customerToCourier = ratingData
    }

    // التحقق من اكتمال كل التقييمات المطلوبة
    const hasRatedRestaurant = currentRatings.customerToRestaurant?.stars
    const hasRatedCourier = currentRatings.customerToCourier?.stars
    
    if (order.courierId) {
      // يوجد مندوب، يجب تقييم كلاهما
      if (hasRatedRestaurant && hasRatedCourier) {
        updateData.ratingCompleted = true
      }
    } else {
      // لا يوجد مندوب، يكفي تقييم المطعم
      if (hasRatedRestaurant) {
        updateData.ratingCompleted = true
      }
    }

    await updateDoc(doc(db, 'orders', orderId), updateData)

    // تحديث متوسط تقييم المطعم
    if (type === 'restaurant' && order.restaurantId) {
      await updateRestaurantRating(order.restaurantId, rating.stars)
    }

    toast.success('شكراً لتقييمك! ')
  }

  // تحديث متوسط تقييم المطعم
  const updateRestaurantRating = async (restaurantId: string, newRating: number) => {
    try {
      const restDoc = await getDoc(doc(db, 'restaurants', restaurantId))
      if (restDoc.exists()) {
        const data = restDoc.data()
        const currentRating = data.averageRating || 0
        const totalOrders = data.totalOrders || 0
        
        // حساب المتوسط الجديد
        const newAverage = totalOrders > 0
          ? ((currentRating * totalOrders) + newRating) / (totalOrders + 1)
          : newRating

        await updateDoc(doc(db, 'restaurants', restaurantId), {
          averageRating: Math.round(newAverage * 10) / 10,
          totalOrders: totalOrders + 1,
          updatedAt: serverTimestamp()
        })
      }
    } catch (err) {
      console.error('Error updating restaurant rating:', err)
    }
  }

  return (
    <div className="space-y-3">
      <h1 className="text-xl font-bold">طلباتي</h1>

      {/* نافذة التقييم */}
      {ratingModal && (
        <RatingModal
          isOpen={ratingModal.isOpen}
          onClose={() => setRatingModal(null)}
          onSubmit={async (rating) => {
            await submitRating(ratingModal.orderId, ratingModal.type, rating)
            setRatingModal(null)
          }}
          type={ratingModal.type}
          targetName={ratingModal.targetName}
          orderId={ratingModal.orderId}
        />
      )}

      {/* نافذة بيانات الدفع */}
      {showPaymentModal && (
        <div className="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4" onClick={() => setShowPaymentModal(null)}>
          <div className="bg-white rounded-2xl shadow-2xl w-full max-w-md overflow-hidden" onClick={e => e.stopPropagation()}>
            {/* رأس النافذة */}
            <div className="bg-gradient-to-r from-green-500 to-green-600 p-4 text-white">
              <div className="flex items-center justify-between">
                <div className="flex items-center gap-3">
                  <CreditCard className="w-6 h-6" />
                  <h2 className="text-lg font-bold">إتمام الدفع</h2>
                </div>
                <button onClick={() => setShowPaymentModal(null)} className="p-1 hover:bg-white/20 rounded-lg">
                  <X className="w-5 h-5" />
                </button>
              </div>
            </div>

            <div className="p-5">
              {loadingBank ? (
                <div className="text-center py-8">
                  <div className="w-10 h-10 border-3 border-green-500 border-t-transparent rounded-full animate-spin mx-auto mb-3" />
                  <p className="text-gray-500">جارِ التحميل...</p>
                </div>
              ) : bankInfo && bankInfo.bankName && bankInfo.bankAccountNumber ? (
                <div className="space-y-4">
                  <p className="text-sm text-gray-600 bg-amber-50 p-3 rounded-xl">
                     حوّل المبلغ على الحساب البنكي التالي ثم أبلغ صاحب المطعم
                  </p>

                  {/* بيانات البنك */}
                  <div className="bg-gray-50 rounded-xl p-4 space-y-3">
                    <div className="flex items-center gap-3">
                      <Building2 className="w-5 h-5 text-green-600" />
                      <div>
                        <p className="text-xs text-gray-500">البنك</p>
                        <p className="font-bold text-gray-800">{bankInfo.bankName}</p>
                      </div>
                    </div>

                    <div className="border-t pt-3">
                      <p className="text-xs text-gray-500">اسم صاحب الحساب</p>
                      <p className="font-bold text-gray-800">{bankInfo.bankAccountName}</p>
                    </div>

                    <div className="border-t pt-3">
                      <p className="text-xs text-gray-500">رقم الآيبان / الحساب</p>
                      <div className="flex items-center gap-2">
                        <p className="font-mono font-bold text-gray-800 flex-1 text-left" dir="ltr">
                          {bankInfo.bankAccountNumber}
                        </p>
                        <button
                          onClick={() => copyToClipboard(bankInfo.bankAccountNumber || '')}
                          className="p-2 bg-green-100 text-green-600 rounded-lg hover:bg-green-200 transition"
                        >
                          <Copy className="w-4 h-4" />
                        </button>
                      </div>
                    </div>
                  </div>

                  {/* المبلغ المطلوب */}
                  {orders.find(o => o.id === showPaymentModal) && (
                    <div className="bg-green-50 border-2 border-green-200 rounded-xl p-4 text-center">
                      <p className="text-sm text-green-600 mb-1">المبلغ المطلوب تحويله</p>
                      <p className="text-3xl font-black text-green-700">
                        {orders.find(o => o.id === showPaymentModal)?.total?.toFixed(2)} ر.س
                      </p>
                    </div>
                  )}

                  <p className="text-xs text-gray-500 text-center">
                     بعد التحويل، تواصل مع المطعم لتأكيد الدفع
                  </p>
                </div>
              ) : (
                <div className="text-center py-8">
                  <div className="w-16 h-16 bg-gray-100 rounded-full flex items-center justify-center mx-auto mb-4">
                    <Building2 className="w-8 h-8 text-gray-400" />
                  </div>
                  <p className="text-gray-600 font-semibold mb-2">لم يتم إضافة بيانات الحساب البنكي</p>
                  <p className="text-sm text-gray-500">يرجى التواصل مع المطعم مباشرة لمعرفة طريقة الدفع</p>
                </div>
              )}
            </div>
          </div>
        </div>
      )}

      {err && (
        <div className="text-xs bg-yellow-50 text-yellow-800 border border-yellow-200 rounded-xl p-3">
          {err}
          {diag && (
            <div className="mt-1">
              <div>UID: <b>{diag.uid}</b></div>
              <div>عدد نتائج الفولبّاك: <b>{diag.fallbackCount}</b></div>
              {Array.isArray(diag.sample) && diag.sample.length > 0 && (
                <div className="mt-1">
                  <div className="font-semibold">عينة (أحدث 5):</div>
                  {diag.sample.map((x) => (
                    <div key={x.id} className="truncate">
                      #{x.id} • customerId: {String(x.customerId)} • restaurantId: {String(x.restaurantId)} • createdAt: {x.createdAt || '—'}
                    </div>
                  ))}
                </div>
              )}
            </div>
          )}
        </div>
      )}

      {orders.map((o) => (
        <div key={o.id} className="bg-white rounded-2xl shadow-card overflow-hidden hover:shadow-lg transition-shadow">
          {/* رأس الطلب مع الحالة */}
          <div className={`${badge(o.status).color} px-4 py-3 flex items-center justify-between`}>
            <div className="flex items-center gap-2 text-white">
              <span className="text-xl">{badge(o.status).emoji}</span>
              <span className="font-bold">{badge(o.status).text}</span>
            </div>
            <div className="text-white/80 text-sm font-medium">
              #{o.id.slice(-6)}
            </div>
          </div>

          <div className="p-4">
            {o.restaurantName && (
              <div className="flex items-center gap-2 text-primary font-semibold mb-2">
                <span></span>
                <span>{String(o.restaurantName)}</span>
              </div>
            )}

            {/* عداد الوقت - يظهر للطلبات النشطة */}
            {(o.status === 'accepted' || o.status === 'preparing') && (
              <div className="mb-3">
                <OrderTimer order={o} type="preparation" />
              </div>
            )}
            {o.status === 'ready' && o.deliveryType === 'delivery' && (
              <div className="mb-3">
                <OrderTimer order={o} type="pickup" />
              </div>
            )}
            {o.status === 'out_for_delivery' && (
              <div className="mb-3">
                <OrderTimer order={o} type="delivery" />
              </div>
            )}

            <div className="text-sm text-gray-700 bg-gray-50 rounded-xl p-3 mb-3">
              {o.items?.map((i) => `${i.name}×${i.qty}`).join(' • ')}
            </div>

            {/* تفاصيل التوصيل */}
            <div className="text-sm text-gray-600 space-y-2">
              {o.deliveryType === 'pickup' ? (
                <div className="flex items-center gap-2 text-green-600 font-medium bg-green-50 rounded-xl p-3">
                  <MapPin className="w-4 h-4" />
                  <span>استلام من المطعم</span>
                </div>
              ) : (
                <div className="space-y-1 bg-gray-50 rounded-xl p-3">
                  <div className="flex justify-between">
                    <span>المبلغ الأساسي:</span>
                    <span>{o.subtotal?.toFixed?.(2) || '—'} ر.س</span>
                  </div>
                  <div className="flex justify-between">
                    <span>رسوم التوصيل:</span>
                    {o.deliveryFee !== undefined && o.deliveryFee > 0 ? (
                      <span className="font-medium">{o.deliveryFee?.toFixed?.(2)} ر.س</span>
                    ) : (
                      <span className="text-amber-600">بانتظار تحديد المطعم</span>
                    )}
                  </div>
                </div>
              )}
            </div>

            <div className="mt-3 pt-3 border-t space-y-3">
              <div className="flex items-center justify-between">
                <div className="font-bold text-lg text-primary">
                  الإجمالي: {o.total?.toFixed?.(2)} ر.س
                </div>
              </div>

              {/* زر إتمام الدفع - يظهر للطلبات الجديدة */}
              {needsPayment(o) && o.restaurantId && (
                <button
                  onClick={() => fetchBankInfo(o.restaurantId!, o.id)}
                  className="w-full flex items-center justify-center gap-2 px-4 py-3 bg-gradient-to-r from-green-500 to-green-600 
                             text-white rounded-xl font-bold shadow-lg hover:shadow-xl 
                             hover:scale-[1.02] transition-all duration-200"
                >
                  <CreditCard className="w-5 h-5" />
                  <span>إتمام الدفع </span>
                </button>
              )}

              {/* نظام التقييم الإجباري - يظهر للطلبات المكتملة التي تحتاج تقييم */}
              {needsRating(o) && (
                <div className="bg-gradient-to-r from-amber-50 to-yellow-50 border-2 border-amber-200 rounded-2xl p-4">
                  <div className="flex items-center gap-2 mb-3">
                    <Star className="w-5 h-5 text-amber-500 fill-amber-500" />
                    <span className="font-bold text-amber-800">قيّم تجربتك </span>
                  </div>
                  <p className="text-sm text-amber-700 mb-4">
                    ساعدنا في تحسين الخدمة بتقييمك
                  </p>
                  
                  <div className="space-y-2">
                    {/* تقييم الأسرة */}
                    {!o.ratings?.customerToRestaurant?.stars && (
                      <button
                        onClick={() => setRatingModal({
                          isOpen: true,
                          orderId: o.id,
                          type: 'restaurant',
                          targetName: o.restaurantName || 'الأسرة المنتجة'
                        })}
                        className="w-full flex items-center justify-between px-4 py-3 bg-white border-2 border-amber-300 
                                   rounded-xl hover:bg-amber-50 transition-all group"
                      >
                        <div className="flex items-center gap-3">
                          <Store className="w-5 h-5 text-amber-600" />
                          <span className="font-medium text-gray-800">قيّم الأسرة المنتجة</span>
                        </div>
                        <div className="flex items-center gap-1">
                          {[1,2,3,4,5].map(n => (
                            <Star key={n} className="w-4 h-4 text-gray-300 group-hover:text-amber-400 transition" />
                          ))}
                        </div>
                      </button>
                    )}

                    {/* تقييم المندوب (إذا كان موجود) */}
                    {o.courierId && !o.ratings?.customerToCourier?.stars && (
                      <button
                        onClick={() => setRatingModal({
                          isOpen: true,
                          orderId: o.id,
                          type: 'courier',
                          targetName: 'المندوب'
                        })}
                        className="w-full flex items-center justify-between px-4 py-3 bg-white border-2 border-emerald-300 
                                   rounded-xl hover:bg-emerald-50 transition-all group"
                      >
                        <div className="flex items-center gap-3">
                          <Truck className="w-5 h-5 text-emerald-600" />
                          <span className="font-medium text-gray-800">قيّم المندوب</span>
                        </div>
                        <div className="flex items-center gap-1">
                          {[1,2,3,4,5].map(n => (
                            <Star key={n} className="w-4 h-4 text-gray-300 group-hover:text-emerald-400 transition" />
                          ))}
                        </div>
                      </button>
                    )}
                  </div>

                  {/* عرض التقييمات المكتملة */}
                  {(o.ratings?.customerToRestaurant?.stars || o.ratings?.customerToCourier?.stars) && (
                    <div className="mt-3 pt-3 border-t border-amber-200 space-y-2">
                      {o.ratings?.customerToRestaurant?.stars && (
                        <div className="flex items-center justify-between text-sm">
                          <span className="text-gray-600">تقييم الأسرة:</span>
                          <div className="flex items-center gap-1">
                            {[1,2,3,4,5].map(n => (
                              <Star key={n} className={`w-4 h-4 ${n <= o.ratings!.customerToRestaurant!.stars ? 'text-amber-400 fill-amber-400' : 'text-gray-300'}`} />
                            ))}
                          </div>
                        </div>
                      )}
                      {o.ratings?.customerToCourier?.stars && (
                        <div className="flex items-center justify-between text-sm">
                          <span className="text-gray-600">تقييم المندوب:</span>
                          <div className="flex items-center gap-1">
                            {[1,2,3,4,5].map(n => (
                              <Star key={n} className={`w-4 h-4 ${n <= o.ratings!.customerToCourier!.stars ? 'text-emerald-400 fill-emerald-400' : 'text-gray-300'}`} />
                            ))}
                          </div>
                        </div>
                      )}
                    </div>
                  )}
                </div>
              )}

              {/* عرض التقييم المكتمل للطلبات السابقة */}
              {o.status === 'delivered' && o.ratingCompleted && (
                <div className="bg-green-50 border border-green-200 rounded-xl p-3">
                  <div className="flex items-center gap-2 text-green-700">
                    <CheckCircle className="w-5 h-5" />
                    <span className="font-medium">تم تقييم الطلب </span>
                  </div>
                </div>
              )}

              <div className="flex gap-2">
                {/* زر المحادثة مع المندوب */}
                {canChatWithCourier(o) && (
                  <button
                    onClick={() => nav(`/chat?orderId=${o.id}`)}
                    className="flex-1 flex items-center justify-center gap-2 px-4 py-2 bg-gradient-to-r from-primary to-accent 
                               text-white rounded-full font-medium shadow-lg hover:shadow-xl 
                               hover:scale-105 transition-all duration-200 animate-pulse"
                  >
                    <MessageCircle className="w-5 h-5" />
                    <span>تواصل مع المندوب </span>
                  </button>
                )}
                
                {/* زر المحادثة مع المطعم (إذا لم يكن هناك مندوب) */}
                {canChatWithRestaurant(o) && (
                  <button
                    onClick={() => nav(`/chat?orderId=${o.id}`)}
                    className="flex-1 flex items-center justify-center gap-2 px-4 py-2 bg-gradient-to-r from-orange-500 to-amber-500 
                               text-white rounded-full font-medium shadow-lg hover:shadow-xl 
                               hover:scale-105 transition-all duration-200"
                  >
                    <Store className="w-5 h-5" />
                    <span>تواصل مع المطعم </span>
                  </button>
                )}

                {/* زر الشكوى / الدعم الفني */}
                <button
                  onClick={() => nav(`/support?orderId=${o.id}`)}
                  className="flex items-center justify-center gap-2 px-4 py-2 bg-gradient-to-r from-red-500 to-red-600 
                             text-white rounded-full font-medium shadow-lg hover:shadow-xl 
                             hover:scale-105 transition-all duration-200"
                  title="تقديم شكوى أو طلب دعم"
                >
                  <Headphones className="w-5 h-5" />
                  <span>شكوى</span>
                </button>
              </div>
            </div>
          </div>
        </div>
      ))}

      {orders.length === 0 && !err && (
        <div className="text-gray-600">لا توجد طلبات حتى الآن.</div>
      )}
    </div>
  )
}

==========================================================================================
FILE: src/routes/ProtectedRoute.tsx
==========================================================================================
import React from 'react'
import { Navigate } from 'react-router-dom'
import { useAuth } from '@/auth'

export const ProtectedRoute: React.FC<{ children: React.ReactNode }> = ({ children }) => {
  const { user, loading } = useAuth()
  if (loading) return <div className="p-8 text-center">جارِ التحميل...</div>
  if (!user) return <Navigate to="/login" replace />
  return <>{children}</>
}

==========================================================================================
FILE: src/routes/RoleGate.tsx
==========================================================================================
// src/routes/RoleGate.tsx
import React from 'react'
import { Navigate } from 'react-router-dom'
import { useAuth } from '@/auth'

// وحّد نوع الدور مع كل الأدوار المستخدمة في التطبيق
export type Role = 'owner' | 'courier' | 'customer' | 'admin' | 'developer'

type Props = {
  allow: Role[]
  children: React.ReactNode
}

export const RoleGate: React.FC<Props> = ({ allow, children }) => {
  const { role, loading } = useAuth()

  if (loading) {
    return <div className="p-8 text-center">جارِ التحميل...</div>
  }

  if (!role || !allow.includes(role)) {
    return <Navigate to="/" replace />
  }

  return <>{children}</>
}

export default RoleGate

==========================================================================================
FILE: src/types/index.ts
==========================================================================================
/**
 * Type definitions for the Broast Al-Qaryah application
 * Centralized types to avoid redundant definitions and ensure consistency
 */

/**
 * Support Ticket - تذكرة دعم فني أو شكوى
 */
export interface SupportTicket {
  id: string;
  ticketNumber: string; // رقم التذكرة (مثل: TKT-2024-001)
  type: 'complaint' | 'support' | 'suggestion' | 'refund'; // نوع التذكرة
  subject: string; // عنوان الشكوى
  description: string; // وصف المشكلة
  // بيانات صاحب التذكرة
  userId: string;
  userName?: string;
  userEmail?: string;
  userPhone?: string;
  userRole: 'customer' | 'owner' | 'courier' | 'admin';
  // بيانات الطلب المرتبط (إن وجد)
  orderId?: string;
  orderNumber?: string;
  // بيانات الأسرة المشتكى عليها (إن وجد)
  againstRestaurantId?: string;
  againstRestaurantName?: string;
  // بيانات المندوب المشتكى عليه (إن وجد)
  againstCourierId?: string;
  againstCourierName?: string;
  // حالة التذكرة
  status: TicketStatus;
  priority: 'low' | 'medium' | 'high' | 'urgent';
  // المرفقات (صور الإثبات)
  attachments?: string[];
  // الرد والحل
  adminResponse?: string;
  adminId?: string;
  adminName?: string;
  resolution?: string; // كيف تم حل المشكلة
  // التواريخ
  createdAt?: Date;
  updatedAt?: Date;
  resolvedAt?: Date;
  closedAt?: Date;
}

/**
 * حالات تذكرة الدعم
 */
export type TicketStatus = 
  | 'open'              // جديدة
  | 'in_progress'       // قيد المعالجة
  | 'waiting_customer'  // بانتظار رد العميل
  | 'waiting_restaurant'// بانتظار رد الأسرة
  | 'resolved'          // تم الحل
  | 'closed';           // مغلقة

/**
 * نظام النقاط - للأسر والمندوبين
 * كل مستخدم يبدأ بـ 100 نقطة
 * الشكوى المؤكدة = خصم نقاط
 * أقل من 30 نقطة = إيقاف تلقائي
 */
export interface PointsSystem {
  currentPoints: number; // النقاط الحالية (تبدأ من 100)
  totalDeductions: number; // إجمالي النقاط المخصومة
  suspendedAt?: Date; // تاريخ الإيقاف (إن وجد)
  suspendedReason?: string; // سبب الإيقاف
  isSuspended: boolean; // هل الحساب موقوف؟
  warningCount: number; // عدد التنبيهات
  lastWarningAt?: Date; // تاريخ آخر تنبيه
  pointsHistory: PointsHistoryItem[]; // سجل النقاط
}

/**
 * سجل تاريخ النقاط
 */
export interface PointsHistoryItem {
  id: string;
  type: 'deduction' | 'bonus' | 'reset'; // نوع العملية
  amount: number; // عدد النقاط (سالب للخصم، موجب للمكافأة)
  reason: string; // سبب الخصم/المكافأة
  orderId?: string; // رقم الطلب المرتبط
  ticketId?: string; // رقم التذكرة المرتبطة
  adminId?: string; // المسؤول الذي أجرى العملية
  createdAt: Date;
}

/**
 * إعدادات نظام النقاط
 */
export const POINTS_CONFIG = {
  STARTING_POINTS: 100, // نقاط البداية
  SUSPENSION_THRESHOLD: 30, // الحد الأدنى للإيقاف
  WARNING_THRESHOLD: 50, // حد التنبيه
  // خصومات الشكاوى حسب النوع
  DEDUCTIONS: {
    FOOD_QUALITY: 15, // جودة الطعام
    LATE_DELIVERY: 10, // تأخير التسليم
    BAD_SERVICE: 10, // سوء الخدمة
    WRONG_ORDER: 12, // طلب خاطئ
    PACKAGING: 8, // سوء التغليف
    HYGIENE: 20, // نظافة
    NO_SHOW: 15, // عدم الحضور (للمندوب)
    RUDE_BEHAVIOR: 15, // سوء التعامل
    LOW_RATING: 5, // تقييم منخفض متكرر
  },
  // مكافآت
  BONUSES: {
    MONTHLY_EXCELLENT: 10, // أداء ممتاز شهري
    NO_COMPLAINTS_WEEK: 5, // أسبوع بدون شكاوى
  }
};

/**
 * إعدادات عداد الوقت للطلبات (بالدقائق)
 * تجاوز الوقت = تنبيه تلقائي
 */
export const ORDER_TIME_LIMITS = {
  // وقت تجهيز الأسرة (من القبول حتى الجاهزية)
  PREPARATION_TIME: 30, // 30 دقيقة
  // وقت استلام المندوب (من الجاهزية حتى الاستلام)
  COURIER_PICKUP_TIME: 15, // 15 دقيقة
  // وقت التوصيل (من الاستلام حتى التسليم)
  DELIVERY_TIME: 30, // 30 دقيقة
  // ألوان التحذير
  WARNING_THRESHOLD: 0.75, // تحذير عند 75% من الوقت
};

/**
 * حالة عداد الوقت
 */
export type TimerStatus = 'normal' | 'warning' | 'exceeded';

/**
 * أوقات الطلب - timestamps لكل مرحلة
 */
export interface OrderTimestamps {
  acceptedAt?: Date; // وقت قبول الطلب (بداية التجهيز)
  readyAt?: Date; // وقت جهوزية الطلب (بداية انتظار المندوب)
  pickedUpAt?: Date; // وقت استلام المندوب (بداية التوصيل)
  deliveredAt?: Date; // وقت التسليم (النهاية)
}

/**
 * تنبيهات تجاوز الوقت
 */
export interface TimeAlert {
  id: string;
  orderId: string;
  orderNumber?: string;
  type: 'preparation' | 'pickup' | 'delivery';
  exceededBy: number; // كم دقيقة تجاوز
  targetId: string; // UID الأسرة أو المندوب
  targetType: 'restaurant' | 'courier';
  createdAt?: Date;
  acknowledged?: boolean; // هل تم التنبيه؟
}

/**
 * TicketMessage - رسالة في تذكرة الدعم
 */
export interface TicketMessage {
  id: string;
  ticketId: string;
  senderId: string;
  senderName?: string;
  senderRole: 'user' | 'admin' | 'system';
  message: string;
  attachments?: string[];
  createdAt?: Date;
}

/**
 * Menu Item - Product sold by a restaurant
 */
export interface MenuItem {
  id: string;
  name: string;
  desc?: string;
  price: number;
  imageUrl?: string;
  available: boolean;
  categoryId?: string;
  ownerId: string; // Links to restaurants/{ownerId}
  // نظام الخصومات
  discountPercent?: number; // نسبة الخصم (مثال: 20 تعني 20%)
  discountExpiresAt?: Date | any; // تاريخ انتهاء الخصم
  createdAt?: Date;
  updatedAt?: Date;
}

/**
 * Restaurant - Owner's restaurant profile
 */
export interface Restaurant {
  id: string; // doc ID = ownerId
  name: string;
  ownerId: string;
  email?: string;
  phone?: string;
  city?: string;
  location?: string; // Address or description
  logoUrl?: string;
  // حالة المتجر
  isOpen?: boolean; // هل المتجر مفتوح للطلبات؟ (true = متاح، false = مغلق)
  // خيارات التوصيل والاستلام
  allowDelivery?: boolean; // السماح بالتوصيل للعملاء
  allowPickup?: boolean; // السماح بالاستلام من موقع المطعم
  // التراخيص
  commercialLicenseUrl?: string; // صورة الرخصة التجارية / السجل التجاري
  licenseStatus?: 'pending' | 'approved' | 'rejected'; // حالة مراجعة التراخيص
  licenseNotes?: string; // ملاحظات المراجعة
  referredBy?: string; // UID المشرف الذي أضاف المطعم (admin) - إذا كان فارغ = مسجل من المطور
  referrerType?: 'admin' | 'developer'; // نوع من أضاف المطعم
  // باقات سفرة البيت
  packageType?: 'free' | 'premium'; // نوع الباقة الحالية
  packageRequest?: 'premium'; // طلب ترقية للباقة
  packageRequestedAt?: Date; // تاريخ طلب الترقية
  packageSubscribedAt?: Date; // تاريخ الاشتراك في الباقة المدفوعة
  packageExpiresAt?: Date; // تاريخ انتهاء الباقة المدفوعة
  // نظام التوثيق والتصنيف
  isVerified?: boolean; // هل الأسرة موثقة؟
  verifiedAt?: Date; // تاريخ التوثيق
  sellerTier?: 'bronze' | 'silver' | 'gold'; // تصنيف البائع
  tierUpdatedAt?: Date; // تاريخ آخر تحديث للتصنيف
  // إحصائيات للتصنيف
  totalOrders?: number; // إجمالي الطلبات
  averageRating?: number; // متوسط التقييم
  onTimeDeliveryRate?: number; // نسبة الالتزام بالوقت
  complaintsCount?: number; // عدد الشكاوى
  // بيانات الحساب البنكي للتحويل
  bankName?: string; // اسم البنك
  bankAccountName?: string; // اسم صاحب الحساب
  bankAccountNumber?: string; // رقم الآيبان أو الحساب
  // بيانات التوظيف
  isHiring?: boolean; // هل الأسرة تبحث عن موظفات؟
  hiringDescription?: string; // وصف الوظيفة المطلوبة
  hiringContact?: string; // رقم التواصل للتوظيف
  createdAt?: Date;
  updatedAt?: Date;
}

/**
 * Seller Tier Levels
 * Bronze: المستوى الأساسي (افتراضي)
 * Silver: أداء جيد (تقييم 4+، التزام 85%+، شكاوى أقل من 5)
 * Gold: أداء ممتاز (تقييم 4.5+، التزام 95%+، شكاوى أقل من 2)
 */
export type SellerTier = 'bronze' | 'silver' | 'gold';

/**
 * Order - Customer purchase record
 */
export interface Order {
  id: string;
  customerId: string; // Links to users/{customerId}
  items: OrderItem[];
  subtotal: number;
  deliveryFee: number; // رسوم التوصيل (يحددها المندوب أو الأسرة)
  deliveryFeeSetBy?: 'owner' | 'courier'; // من حدد رسوم التوصيل
  deliveryFeeSetAt?: Date; // متى تم تحديد رسوم التوصيل
  total: number;
  status: OrderStatus;
  address: string;
  deliveryType?: 'delivery' | 'pickup'; // نوع التسليم: توصيل أو استلام من المطعم
  courierId?: string; // Links to users/{courierId} if assigned
  notes?: string;
  restaurantName?: string; // Denormalized for display convenience
  restaurantId?: string; // Links to restaurants/{id}
  // نظام العمولات والرسوم
  platformFee?: number; // رسوم المنصة الثابتة (3.75 ريال لكل طلب) - على المندوب
  adminCommission?: number; // عمولة المشرف (0.5 ريال إذا المطعم مسجل عن طريقه)
  courierPlatformFee?: number; // رسوم المنصة المخصومة من المندوب (3.75 ريال)
  referredBy?: string; // UID المشرف الذي أضاف المطعم
  // نظام التقييم الإجباري
  ratings?: OrderRatings; // التقييمات للطلب
  ratingCompleted?: boolean; // هل اكتمل التقييم؟
  // عداد الوقت - timestamps لكل مرحلة
  timestamps?: OrderTimestamps;
  // تنبيهات تجاوز الوقت
  timeAlerts?: {
    preparationExceeded?: boolean;
    pickupExceeded?: boolean;
    deliveryExceeded?: boolean;
  };
  createdAt?: Date;
  updatedAt?: Date;
}

/**
 * OrderRatings - تقييمات الطلب
 */
export interface OrderRatings {
  // تقييم العميل للأسرة
  customerToRestaurant?: Rating;
  // تقييم العميل للمندوب
  customerToCourier?: Rating;
  // تقييم الأسرة للعميل
  restaurantToCustomer?: Rating;
  // تقييم المندوب للعميل
  courierToCustomer?: Rating;
}

/**
 * Rating - تقييم فردي
 */
export interface Rating {
  stars: number; // 1-5 نجوم
  comment?: string; // تعليق اختياري
  createdAt?: Date;
}

/**
 * Order Item - Line item in an order
 */
export interface OrderItem {
  id: string; // menuItems/{id}
  name: string;
  price: number;
  qty: number;
  ownerId?: string; // Restaurant ID for multi-restaurant support
}

/**
 * Order Status - Lifecycle states of an order
 */
export type OrderStatus = 
  | 'pending'           // Just created, awaiting owner acceptance
  | 'accepted'          // Owner accepted the order
  | 'preparing'         // Kitchen is preparing
  | 'ready'             // Ready for pickup/delivery
  | 'out_for_delivery'  // Courier is delivering
  | 'delivered'         // Successfully delivered
  | 'cancelled';        // Order cancelled

/**
 * User - Application user record
 */
export interface User {
  uid: string;
  email: string;
  name?: string;
  phone?: string;
  city?: string;
  address?: string;
  role: UserRole;
  // الموقع المحفوظ للتوصيل
  savedLocation?: {
    lat: number;
    lng: number;
    address: string;
  };
  createdAt?: Date;
  updatedAt?: Date;
}

/**
 * User Role - Authorization levels in the app
 */
export type UserRole = 'customer' | 'courier' | 'owner' | 'admin' | 'developer';

/**
 * Admin Role (المشرف):
 * - إضافة/إدارة المطاعم
 * - مراقبة الطلبات للمطاعم المضافة (بدون تعديل)
 * - إدارة المحفظة والمكافآت
 * - يمكنه الطلب كعميل
 */

/**
 * Developer Role (المطور):
 * - جميع الصلاحيات الكاملة
 * - إدارة المستخدمين (إضافة/حذف)
 * - إدارة المطاعم (إضافة/حذف/تعديل)
 * - إدارة الطلبات
 * - إدارة الإعدادات العامة
 */

/**
 * Settings - Global app configuration
 */
export interface AppSettings {
  deliveryFee?: number;
  minOrderAmount?: number;
  operatingHours?: {
    open: string;
    close: string;
  };
  platformFee?: number; // رسوم التطبيق الثابتة (1.5 ريال)
  adminCommissionRate?: number; // نسبة المشرف (0.5 ريال)
  [key: string]: any;
}

/**
 * Wallet - محفظة المشرف أو المطور
 */
export interface Wallet {
  id: string; // = user UID
  balance: number; // الرصيد الحالي
  totalEarnings: number; // إجمالي الأرباح
  totalWithdrawn: number; // إجمالي المسحوب
  transactions: WalletTransaction[];
  updatedAt?: Date;
}

/**
 * WalletTransaction - معاملة في المحفظة
 */
export interface WalletTransaction {
  id: string;
  type: 'credit' | 'debit'; // إيداع أو سحب
  amount: number;
  description: string;
  orderId?: string; // رقم الطلب المرتبط
  restaurantId?: string;
  createdAt: Date;
}

/**
 * Promotion - الإعلان الممول للأسرة المنتجة (حالة/ستوري)
 */
export interface Promotion {
  id: string;
  ownerId: string; // صاحب الأسرة
  restaurantId: string; // المطعم/الأسرة
  type: 'text' | 'image' | 'video'; // نوع الإعلان
  title?: string; // عنوان الإعلان
  description?: string; // الوصف أو الشرح
  mediaUrl?: string; // رابط الصورة أو الفيديو
  isActive: boolean; // هل الإعلان نشط؟
  isPaid: boolean; // هل تم الدفع؟
  price: number; // سعر الإعلان
  duration: number; // مدة الإعلان بالساعات (24 ساعة افتراضي)
  viewsCount: number; // عدد المشاهدات
  expiresAt?: Date; // تاريخ انتهاء الإعلان
  createdAt?: Date;
  updatedAt?: Date;
}

/**
 * PackageSubscriptionRequest - طلب اشتراك في باقة التميز
 */
export interface PackageSubscriptionRequest {
  id: string;
  restaurantId: string; // معرف المطعم/الأسرة
  restaurantName: string; // اسم الأسرة
  ownerName?: string; // اسم صاحب الأسرة
  ownerPhone?: string; // رقم الجوال
  status: PackageRequestStatus;
  // بيانات الدفع
  bankAccountImageUrl?: string; // صورة الحساب البنكي من المطور
  paymentProofImageUrl?: string; // صورة إثبات التحويل من الأسرة
  subscriptionAmount: number; // مبلغ الاشتراك
  subscriptionDuration: number; // مدة الاشتراك بالأيام (30 يوم مثلاً)
  // ملاحظات
  developerNotes?: string; // ملاحظات المطور
  ownerNotes?: string; // ملاحظات الأسرة
  // تواريخ
  requestedAt?: Date;
  bankSentAt?: Date; // تاريخ إرسال صورة البنك
  paymentSentAt?: Date; // تاريخ إرسال إثبات التحويل
  approvedAt?: Date;
  rejectedAt?: Date;
  expiresAt?: Date; // تاريخ انتهاء الاشتراك
  createdAt?: Date;
  updatedAt?: Date;
}

/**
 * حالات طلب الاشتراك في الباقة
 */
export type PackageRequestStatus = 
  | 'pending'           // طلب جديد بانتظار المطور
  | 'bank_sent'         // المطور أرسل صورة الحساب البنكي
  | 'payment_sent'      // الأسرة أرسلت إثبات التحويل
  | 'approved'          // تم القبول وتفعيل الباقة
  | 'rejected'          // مرفوض
  | 'expired';          // منتهي الصلاحية

/**
 * RestaurantStats - إحصائيات المطعم/الأسرة المنتجة
 */
export interface RestaurantStats {
  id: string; // = restaurant ID
  // إحصائيات الزيارات
  totalProfileViews: number; // عدد مشاهدات الملف التعريفي
  totalMenuViews: number; // عدد مشاهدات صفحة القائمة
  totalItemViews: number; // عدد مشاهدات الأصناف
  // إحصائيات المشاركة
  totalShareClicks: number; // عدد مرات الضغط على زر المشاركة
  whatsappShareCount: number; // عدد مرات المشاركة عبر واتساب
  // إحصائيات التسجيل
  registeredCustomers: number; // عدد العملاء المسجلين عبر رابط الأسرة
  appDownloads: number; // عدد تحميلات التطبيق عبر رابط الأسرة
  followersCount: number; // عدد متابعي المتجر
  // تفاصيل الزيارات
  dailyViews: Record<string, number>; // عدد الزيارات اليومية { "2024-01-22": 50 }
  // آخر تحديث
  updatedAt?: Date;
}

/**
 * VisitLog - سجل زيارة لتتبع زيارات العملاء
 */
export interface VisitLog {
  id: string;
  restaurantId: string; // معرف المطعم
  visitorId?: string; // معرف الزائر (إذا مسجل)
  visitorType: 'anonymous' | 'customer' | 'registered_via_link';
  source: 'direct' | 'whatsapp_share' | 'social_share' | 'referral';
  page: 'menu' | 'profile' | 'item';
  itemId?: string; // معرف الصنف (إذا كانت زيارة صنف)
  referralCode?: string; // كود الإحالة
  createdAt?: Date;
}

/**
 * CustomerRegistration - تسجيل عميل عبر رابط الأسرة
 */
export interface CustomerRegistration {
  id: string;
  customerId: string; // معرف العميل
  restaurantId: string; // معرف الأسرة التي سجل عبرها
  registrationType: 'website' | 'app';
  referralCode?: string;
  createdAt?: Date;
}

/**
 * StoreFollower - متابع للمتجر
 */
export interface StoreFollower {
  id: string;
  followerId: string; // معرف العميل المتابع
  followerName?: string; // اسم المتابع
  restaurantId: string; // معرف المتجر المتابَع
  createdAt?: Date;
}

/**
 * PackageSettings - إعدادات الباقات (تُخزن في settings/packages)
 */
export interface PackageSettings {
  // إعدادات باقة التميز (Premium)
  premium: PackageConfig;
  // إعدادات الباقة المجانية
  free: PackageConfig;
  // الباقة النشطة افتراضياً للمطاعم الجديدة
  defaultPackage: 'free' | 'premium';
  // آخر تحديث
  updatedAt?: Date;
}

/**
 * PackageConfig - إعدادات باقة واحدة
 */
export interface PackageConfig {
  // الاسم المعروض للباقة
  displayName: string;
  // الوصف
  description?: string;
  // هل الباقة مفعّلة (يمكن للأسر الاشتراك فيها)
  isEnabled: boolean;
  // السعر الأصلي بالريال
  originalPrice: number;
  // السعر الحالي بالريال (بعد الخصم إن وجد)
  currentPrice: number;
  // مدة الاشتراك بالأيام
  durationDays: number;
  // إعدادات الخصم
  discount?: PackageDiscount;
}

/**
 * PackageDiscount - خصم على الباقة
 */
export interface PackageDiscount {
  // هل الخصم مفعّل
  isActive: boolean;
  // نوع الخصم: نسبة مئوية أو مبلغ ثابت
  type: 'percentage' | 'fixed';
  // قيمة الخصم (نسبة أو مبلغ)
  value: number;
  // تاريخ بداية الخصم
  startDate?: Date | any;
  // تاريخ نهاية الخصم
  endDate?: Date | any;
  // سبب أو وصف الخصم (للعرض)
  label?: string;
}

==========================================================================================
FILE: src/utils/cities.ts
==========================================================================================
// src/utils/cities.ts
// قائمة المدن السعودية الرئيسية

export const SAUDI_CITIES = [
  'الرياض',
  'جدة',
  'مكة المكرمة',
  'المدينة المنورة',
  'الدمام',
  'الخبر',
  'الظهران',
  'الأحساء',
  'القطيف',
  'الطائف',
  'تبوك',
  'بريدة',
  'عنيزة',
  'حائل',
  'خميس مشيط',
  'أبها',
  'نجران',
  'جازان',
  'ينبع',
  'الجبيل',
  'حفر الباطن',
  'الخرج',
  'أملج',
  'العلا',
  'رابغ',
  'القنفذة',
  'بيشة',
  'صبيا',
  'الباحة',
  'عرعر',
  'سكاكا',
  'الدوادمي',
  'المجمعة',
  'الزلفي',
  'شقراء',
  'وادي الدواسر',
  'رفحاء',
  'طريف',
  'القريات',
  'أخرى',
] as const

export type SaudiCity = typeof SAUDI_CITIES[number]

==========================================================================================
FILE: src/utils/config.ts
==========================================================================================
/**
 * App Configuration & Utilities
 * Centralized place for app-level settings and configuration
 */

import { db } from '@/firebase'
import { doc, getDoc } from 'firebase/firestore'
import { AppSettings } from '@/types'

const DEFAULT_DELIVERY_FEE = 7
const SETTINGS_DOC_ID = 'general'

/**
 * Get delivery fee from app settings, with fallback to default
 * Should be cached or called once during app initialization
 */
export async function getDeliveryFee(): Promise<number> {
  try {
    const snap = await getDoc(doc(db, 'settings', SETTINGS_DOC_ID))
    if (snap.exists()) {
      const data = snap.data() as AppSettings
      return data.deliveryFee ?? DEFAULT_DELIVERY_FEE
    }
  } catch (err) {
    console.warn('Failed to fetch delivery fee from settings:', err)
  }
  return DEFAULT_DELIVERY_FEE
}

/**
 * Get all app settings with fallbacks
 */
export async function getAppSettings(): Promise<AppSettings> {
  try {
    const snap = await getDoc(doc(db, 'settings', SETTINGS_DOC_ID))
    if (snap.exists()) {
      return snap.data() as AppSettings
    }
  } catch (err) {
    console.warn('Failed to fetch app settings:', err)
  }
  return {
    deliveryFee: DEFAULT_DELIVERY_FEE,
  }
}

==========================================================================================
FILE: src/utils/distance.ts
==========================================================================================
// src/utils/distance.ts
// دالة حساب المسافة بين نقطتين باستخدام صيغة Haversine

export type GeoLocation = {
  lat: number
  lng: number
}

/**
 * حساب المسافة بين نقطتين بالكيلومتر
 * @param point1 النقطة الأولى
 * @param point2 النقطة الثانية
 * @returns المسافة بالكيلومتر
 */
export function calculateDistance(point1: GeoLocation, point2: GeoLocation): number {
  const R = 6371 // نصف قطر الأرض بالكيلومتر
  
  const dLat = toRad(point2.lat - point1.lat)
  const dLng = toRad(point2.lng - point1.lng)
  
  const a = 
    Math.sin(dLat / 2) * Math.sin(dLat / 2) +
    Math.cos(toRad(point1.lat)) * Math.cos(toRad(point2.lat)) *
    Math.sin(dLng / 2) * Math.sin(dLng / 2)
  
  const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a))
  
  return R * c
}

function toRad(deg: number): number {
  return deg * (Math.PI / 180)
}

/**
 * التحقق من أن المسافة ضمن النطاق المحدد
 * @param point1 النقطة الأولى
 * @param point2 النقطة الثانية
 * @param maxDistance أقصى مسافة بالكيلومتر
 * @returns true إذا كانت المسافة ضمن النطاق
 */
export function isWithinDistance(point1: GeoLocation, point2: GeoLocation, maxDistance: number): boolean {
  return calculateDistance(point1, point2) <= maxDistance
}

// أقصى مسافة للتوصيل (15 كيلو)
export const MAX_DELIVERY_DISTANCE = 15

==========================================================================================
FILE: src/utils/pointsService.ts
==========================================================================================
// src/utils/pointsService.ts
// خدمة إدارة نظام النقاط للأسر والمندوبين
import { doc, getDoc, updateDoc, serverTimestamp, arrayUnion } from 'firebase/firestore'
import { db } from '@/firebase'
import { POINTS_CONFIG, PointsHistoryItem } from '@/types'

/**
 * الحصول على نقاط مستخدم (أسرة أو مندوب)
 */
export async function getUserPoints(
  userId: string, 
  userType: 'restaurant' | 'courier'
): Promise<number> {
  const collection = userType === 'restaurant' ? 'restaurants' : 'couriers'
  const docRef = doc(db, collection, userId)
  const snap = await getDoc(docRef)
  
  if (!snap.exists()) return POINTS_CONFIG.STARTING_POINTS
  
  const data = snap.data()
  return data.points?.currentPoints ?? POINTS_CONFIG.STARTING_POINTS
}

/**
 * التحقق إذا كان المستخدم موقوفاً
 */
export async function isUserSuspended(
  userId: string, 
  userType: 'restaurant' | 'courier'
): Promise<boolean> {
  const collection = userType === 'restaurant' ? 'restaurants' : 'couriers'
  const docRef = doc(db, collection, userId)
  const snap = await getDoc(docRef)
  
  if (!snap.exists()) return false
  
  const data = snap.data()
  return data.points?.isSuspended === true
}

/**
 * خصم نقاط من مستخدم
 */
export async function deductPoints(
  userId: string,
  userType: 'restaurant' | 'courier',
  amount: number,
  reason: string,
  options?: {
    orderId?: string
    ticketId?: string
    adminId?: string
  }
): Promise<{
  success: boolean
  newPoints: number
  isSuspended: boolean
  isWarning: boolean
  message: string
}> {
  const collection = userType === 'restaurant' ? 'restaurants' : 'couriers'
  const docRef = doc(db, collection, userId)
  const snap = await getDoc(docRef)
  
  if (!snap.exists()) {
    return {
      success: false,
      newPoints: 0,
      isSuspended: false,
      isWarning: false,
      message: 'المستخدم غير موجود'
    }
  }
  
  const data = snap.data()
  const currentPoints = data.points?.currentPoints ?? POINTS_CONFIG.STARTING_POINTS
  const totalDeductions = data.points?.totalDeductions ?? 0
  const warningCount = data.points?.warningCount ?? 0
  const pointsHistory = data.points?.pointsHistory ?? []
  
  // حساب النقاط الجديدة
  const newPoints = Math.max(0, currentPoints - amount)
  
  // إنشاء سجل الخصم
  const historyItem: PointsHistoryItem = {
    id: `deduct_${Date.now()}`,
    type: 'deduction',
    amount: -amount,
    reason,
    orderId: options?.orderId,
    ticketId: options?.ticketId,
    adminId: options?.adminId,
    createdAt: new Date()
  }
  
  // التحقق من الإيقاف
  const shouldSuspend = newPoints < POINTS_CONFIG.SUSPENSION_THRESHOLD
  
  // التحقق من التنبيه
  const shouldWarn = !shouldSuspend && newPoints < POINTS_CONFIG.WARNING_THRESHOLD
  
  // تحديث البيانات
  const updates: any = {
    'points.currentPoints': newPoints,
    'points.totalDeductions': totalDeductions + amount,
    'points.pointsHistory': [...pointsHistory, historyItem],
    updatedAt: serverTimestamp()
  }
  
  if (shouldSuspend) {
    updates['points.isSuspended'] = true
    updates['points.suspendedAt'] = serverTimestamp()
    updates['points.suspendedReason'] = `إيقاف تلقائي - النقاط أقل من ${POINTS_CONFIG.SUSPENSION_THRESHOLD}`
    updates['isOpen'] = false // إغلاق المتجر
    updates['isAvailable'] = false // للمندوب
  }
  
  if (shouldWarn) {
    updates['points.warningCount'] = warningCount + 1
    updates['points.lastWarningAt'] = serverTimestamp()
  }
  
  await updateDoc(docRef, updates)
  
  let message = `تم خصم ${amount} نقطة. النقاط الحالية: ${newPoints}`
  if (shouldSuspend) {
    message = ` تم إيقاف الحساب تلقائياً! النقاط وصلت إلى ${newPoints}`
  } else if (shouldWarn) {
    message = ` تنبيه! النقاط منخفضة: ${newPoints}. قد يتم الإيقاف عند ${POINTS_CONFIG.SUSPENSION_THRESHOLD}`
  }
  
  return {
    success: true,
    newPoints,
    isSuspended: shouldSuspend,
    isWarning: shouldWarn,
    message
  }
}

/**
 * إضافة نقاط مكافأة
 */
export async function addBonusPoints(
  userId: string,
  userType: 'restaurant' | 'courier',
  amount: number,
  reason: string,
  adminId?: string
): Promise<{ success: boolean; newPoints: number; message: string }> {
  const collection = userType === 'restaurant' ? 'restaurants' : 'couriers'
  const docRef = doc(db, collection, userId)
  const snap = await getDoc(docRef)
  
  if (!snap.exists()) {
    return { success: false, newPoints: 0, message: 'المستخدم غير موجود' }
  }
  
  const data = snap.data()
  const currentPoints = data.points?.currentPoints ?? POINTS_CONFIG.STARTING_POINTS
  const pointsHistory = data.points?.pointsHistory ?? []
  
  const newPoints = Math.min(100, currentPoints + amount) // الحد الأقصى 100
  
  const historyItem: PointsHistoryItem = {
    id: `bonus_${Date.now()}`,
    type: 'bonus',
    amount: amount,
    reason,
    adminId,
    createdAt: new Date()
  }
  
  await updateDoc(docRef, {
    'points.currentPoints': newPoints,
    'points.pointsHistory': [...pointsHistory, historyItem],
    updatedAt: serverTimestamp()
  })
  
  return {
    success: true,
    newPoints,
    message: `تم إضافة ${amount} نقطة. النقاط الحالية: ${newPoints}`
  }
}

/**
 * إعادة تعيين النقاط (بعد المراجعة)
 */
export async function resetPoints(
  userId: string,
  userType: 'restaurant' | 'courier',
  reason: string,
  adminId: string
): Promise<{ success: boolean; message: string }> {
  const collection = userType === 'restaurant' ? 'restaurants' : 'couriers'
  const docRef = doc(db, collection, userId)
  const snap = await getDoc(docRef)
  
  if (!snap.exists()) {
    return { success: false, message: 'المستخدم غير موجود' }
  }
  
  const data = snap.data()
  const pointsHistory = data.points?.pointsHistory ?? []
  
  const historyItem: PointsHistoryItem = {
    id: `reset_${Date.now()}`,
    type: 'reset',
    amount: POINTS_CONFIG.STARTING_POINTS,
    reason,
    adminId,
    createdAt: new Date()
  }
  
  await updateDoc(docRef, {
    'points.currentPoints': POINTS_CONFIG.STARTING_POINTS,
    'points.isSuspended': false,
    'points.suspendedAt': null,
    'points.suspendedReason': null,
    'points.warningCount': 0,
    'points.pointsHistory': [...pointsHistory, historyItem],
    'isOpen': true, // إعادة فتح المتجر
    'isAvailable': true, // للمندوب
    updatedAt: serverTimestamp()
  })
  
  return {
    success: true,
    message: `تم إعادة تعيين النقاط إلى ${POINTS_CONFIG.STARTING_POINTS}`
  }
}

/**
 * الحصول على سجل النقاط
 */
export async function getPointsHistory(
  userId: string,
  userType: 'restaurant' | 'courier'
): Promise<PointsHistoryItem[]> {
  const collection = userType === 'restaurant' ? 'restaurants' : 'couriers'
  const docRef = doc(db, collection, userId)
  const snap = await getDoc(docRef)
  
  if (!snap.exists()) return []
  
  const data = snap.data()
  return data.points?.pointsHistory ?? []
}

/**
 * تهيئة نظام النقاط لمستخدم جديد
 */
export async function initializePoints(
  userId: string,
  userType: 'restaurant' | 'courier'
): Promise<void> {
  const collection = userType === 'restaurant' ? 'restaurants' : 'couriers'
  const docRef = doc(db, collection, userId)
  
  await updateDoc(docRef, {
    points: {
      currentPoints: POINTS_CONFIG.STARTING_POINTS,
      totalDeductions: 0,
      isSuspended: false,
      warningCount: 0,
      pointsHistory: []
    }
  })
}

==========================================================================================
FILE: storage.rules
==========================================================================================
rules_version = '2';
service firebase.storage {
  match /b/{bucket}/o {
    // السماح بالقراءة للجميع (الصور عامة)
    match /{allPaths=**} {
      allow read: if true;
    }
    
    // صور القائمة - يمكن لأي مستخدم مسجل رفعها
    match /menuImages/{allImages} {
      allow write: if request.auth != null
                   && request.resource.size < 5 * 1024 * 1024  // 5MB max
                   && request.resource.contentType.matches('image/.*');
    }
    
    // صور المطاعم (الشعارات) - يمكن لأي مستخدم مسجل رفعها
    match /restaurants/{ownerId}/{allImages} {
      allow write: if request.auth != null
                   && request.resource.size < 5 * 1024 * 1024  // 5MB max
                   && request.resource.contentType.matches('image/.*');
    }
    
    // تراخيص المطاعم (صور أو PDF) - مسار فرعي licenses
    match /restaurants/{ownerId}/licenses/{fileName} {
      allow write: if request.auth != null
                   && request.resource.size < 5 * 1024 * 1024  // 5MB max
                   && (request.resource.contentType.matches('image/.*') 
                       || request.resource.contentType == 'application/pdf');
    }
    
    // مجلد عام للصور (للأدمن والمطور)
    match /uploads/{allImages} {
      allow write: if request.auth != null
                   && request.resource.size < 5 * 1024 * 1024
                   && request.resource.contentType.matches('image/.*');
    }
    
    // إعلانات الأسر المنتجة (صور وفيديو)
    match /promotions/{fileName} {
      allow write: if request.auth != null
                   && request.resource.size < 50 * 1024 * 1024  // 50MB max للفيديو
                   && (request.resource.contentType.matches('image/.*') 
                       || request.resource.contentType.matches('video/.*'));
    }
    
    // صور الحسابات البنكية (للمطور فقط)
    match /bankAccounts/{fileName} {
      allow write: if request.auth != null
                   && request.resource.size < 5 * 1024 * 1024  // 5MB max
                   && request.resource.contentType.matches('image/.*');
    }
    
    // إثباتات التحويل (للمطاعم)
    match /paymentProofs/{fileName} {
      allow write: if request.auth != null
                   && request.resource.size < 5 * 1024 * 1024  // 5MB max
                   && request.resource.contentType.matches('image/.*');
    }
    
    // مستندات المناديب (الهوية، رخصة القيادة، استمارة السيارة)
    match /couriers/{courierId}/{fileName} {
      allow write: if request.auth != null
                   && request.auth.uid == courierId
                   && request.resource.size < 5 * 1024 * 1024  // 5MB max
                   && request.resource.contentType.matches('image/.*');
    }
  }
}

==========================================================================================
FILE: vite.config.ts
==========================================================================================
import { defineConfig } from 'vite'
import react from '@vitejs/plugin-react'
import path from 'path'

export default defineConfig({
  plugins: [react()],
  resolve: {
    alias: {
      '@': path.resolve(__dirname, './src'),
    },
  },
})
